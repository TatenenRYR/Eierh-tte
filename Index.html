<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten-Radtour</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Design-Styles wie oben (unver√§ndert) */
    /* ... */
  </style>
</head>
<body>
  <div id="topbar">
    <div class="logo-area">
      <img src="logo.png" class="logo" alt="Logo">
      <div class="title">Eierh√ºtten-Tour</div>
    </div>
    <button id="toggleSidebarBtn">‚ò∞</button>
  </div>  <div id="sidebar" class="hidden">
    <label><input type="checkbox" id="filterStrom"> Nur mit Strom</label>
    <ul id="huettenListe"></ul>
    <div id="routeInfo"></div>
    <div id="errorInfo"></div>
  </div>  <div id="loader">
    <div class="spinner"></div>
    <p>Lade Karte‚Ä¶</p>
  </div>
  <div id="map"></div>
  <div id="debugConsole"></div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const map = L.map('map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let huetten = [];
    let huettenMarkerLayer = L.layerGroup().addTo(map);
    let userBikeMarker = null;
    let followBike = true;

    const animatedBikeIcon = L.divIcon({
      className: 'animated-bike-icon',
      html: `<div style="animation:bounce 1s infinite ease-in-out;">üö≤</div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    function filterHuettenByCheckbox() {
      const nurStrom = document.getElementById("filterStrom").checked;
      return nurStrom ? huetten.filter(h => h.strom) : huetten;
    }

    async function ladeEierhuetten() {
      try {
        const snapshot = await getDocs(collection(db, "eierhuetten"));
        huetten = [];
        huettenMarkerLayer.clearLayers();
        const ul = document.getElementById("huettenListe");
        ul.innerHTML = "";
        let debug = "";

        snapshot.forEach(doc => {
          const d = doc.data();
          if (d.status === "aktiviert" && d.coords) {
            const hut = {
              id: doc.id,
              lat: d.coords.lat,
              lng: d.coords.lng,
              name: d.standort || "Unbekannt",
              desc: d.beschreibung || "",
              strom: d.strom || false
            };
            huetten.push(hut);

            const marker = L.marker([hut.lat, hut.lng]).addTo(huettenMarkerLayer);
            marker.bindPopup(`<b>${hut.name}</b><br>${hut.desc}<br>${hut.strom ? "‚úÖ Strom" : "‚ùå Kein Strom"}`);

            const li = document.createElement("li");
            li.innerHTML = `${hut.name}<button class='small-btn' onclick='addToRoute("${hut.id}")'>‚ûï</button>`;
            ul.appendChild(li);
          } else {
            debug += `‚ö†Ô∏è ${doc.id} √ºbersprungen\n`;
          }
        });

        document.getElementById("debugConsole").textContent = debug;
        document.getElementById("debugConsole").style.display = "block";
      } catch (err) {
        document.getElementById("errorInfo").innerText = "Fehler beim Laden der Daten.";
      }
    }

    function updateUserBike() {
      navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (!userBikeMarker) {
            userBikeMarker = L.marker([lat, lng], { icon: animatedBikeIcon }).addTo(map);
            document.getElementById("loader").style.display = "none";
          } else {
            userBikeMarker.setLatLng([lat, lng]);
          }

          if (followBike) {
            map.setView([lat, lng], 14);
          }
        },
        err => {
          console.warn("Standortfehler", err);
          map.setView([51.1657, 10.4515], 6);
          document.getElementById("loader").style.display = "none";
        }
      );
    }

    window.addToRoute = function (id) {
      alert(`H√ºtte ${id} zur Route hinzugef√ºgt.`); // Platzhalter
    };

    document.getElementById("toggleSidebarBtn").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("hidden");
    });
    document.getElementById("filterStrom").addEventListener("change", () => {
      huetten = filterHuettenByCheckbox();
      ladeEierhuetten();
    });

    ladeEierhuetten();
    updateUserBike();
  </script></body>
</html>
