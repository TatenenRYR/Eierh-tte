<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eierhütten Radtour</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif;
    }
    #map { height: 100%; z-index: 1; }
    #loader {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      background: white; font-size: 1.5rem; z-index: 999;
    }
    #sidebar {
      position: absolute;
      top: 10px; left: 10px;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 500;
      max-height: 90%;
      overflow-y: auto;
      width: 260px;
    }
    #routeInfo, #debugConsole {
      margin-top: 10px;
      white-space: pre-wrap;
      font-size: 0.9rem;
    }
    #debugConsole {
      background: #222; color: #0f0; padding: 10px; max-height: 200px; overflow: auto;
    }
  </style>
</head>
<body>
  <div id="loader">🚲 Karte wird geladen…</div>
  <div id="map"></div>
  <div id="sidebar">
    <label><input type="checkbox" id="filterStrom"> Nur mit Strom</label>
    <ul id="huettenListe"></ul>
    <div id="routeInfo"></div>
    <div id="debugConsole"></div>
  </div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const map = L.map('map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let huetten = [];
    const huettenMarkerLayer = L.layerGroup().addTo(map);

    async function ladeEierhuetten() {
      const querySnapshot = await getDocs(collection(db, "eierhuetten"));
      const huettenListe = [];
      let debug = "🐣 Debug-Info:\n";

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const coords = data.coords;

        if (data.status !== "aktiviert" || !coords) {
          debug += `⚠️ Übersprungen: ${doc.id}\n`;
          return;
        }

        const hut = {
          id: doc.id,
          lat: coords.lat,
          lng: coords.lng,
          name: data.standort || "Unbekannt",
          desc: data.beschreibung || "",
          strom: data.strom || false
        };

        huettenListe.push(hut);
      });

      huetten = huettenListe;
      zeigeHuettenAufKarte();
      document.getElementById("debugConsole").textContent = debug + `\nGeladen: ${huetten.length}`;
    }

    function zeigeHuettenAufKarte() {
      const ul = document.getElementById("huettenListe");
      ul.innerHTML = "";
      huettenMarkerLayer.clearLayers();
      const nurStrom = document.getElementById("filterStrom").checked;
      const gefiltert = nurStrom ? huetten.filter(h => h.strom) : huetten;

      gefiltert.forEach(h => {
        const marker = L.marker([h.lat, h.lng]).addTo(huettenMarkerLayer);
        marker.bindPopup(`<b>${h.name}</b><br>${h.desc}<br>${h.strom ? '✅ Strom' : '❌ Kein Strom'}`);

        const li = document.createElement("li");
        li.textContent = h.name;
        ul.appendChild(li);
      });
    }

    document.getElementById("filterStrom").addEventListener("change", zeigeHuettenAufKarte);

    function starteGPS() {
      navigator.geolocation.watchPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          L.marker([lat, lng], { icon: L.divIcon({ className: '', html: '📍', iconSize: [24,24] }) })
            .addTo(map)
            .bindPopup("Dein Standort").openPopup();
          map.setView([lat, lng], 14);
          document.getElementById("loader").style.display = "none";
        },
        err => {
          console.warn("GPS Fehler", err);
          document.getElementById("loader").style.display = "none";
        }
      );
    }

    ladeEierhuetten();
    starteGPS();
  </script></body>
</html>
