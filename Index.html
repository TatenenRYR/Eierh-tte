<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EierhÃ¼tten Navigation â€“ Gruppen & Sicherheit</title>

  <!-- Leaflet & MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
    }

    #loader {
      position: fixed;
      inset: 0;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 1.2em;
    }

    #toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    #toolbar button, #toolbar input {
      min-width: 48px;
      min-height: 48px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #dashboard {
      position: fixed;
      top: 60px;
      right: 10px;
      width: 240px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1001;
      font-size: 14px;
      border-radius: 8px;
    }

    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      display: none;
      z-index: 1002;
    }

    #debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: black;
      color: lime;
      padding: 6px;
      font-family: monospace;
      font-size: 12px;
      border-radius: 6px;
      z-index: 1002;
      max-height: 120px;
      overflow: auto;
    }

    #routeInfo {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1001;
      display: none;
    }

    #compass {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: #fff;
      border-radius: 50%;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Loader & Kartencontainer -->
  <div id="loader">â³ Lade Karteâ€¦</div>
  <div id="map"></div>
  <div id="compass">ğŸ§­</div>
  <div id="routeInfo">0 km Â· 0 Min Â· -</div>

  <!-- Dashboard mit Benutzer-, Gruppen- und Routendaten -->
  <div id="dashboard">
    <b>ğŸ“‹ AusgewÃ¤hlt:</b>
    <ul id="selectedList" style="list-style:none;padding-left:0;"></ul>
    <button onclick="skipHut()">â­ï¸ NÃ¤chste Ã¼berspringen</button>
    <hr/>
    <button onclick="sendSOS()">â— SOS senden</button>
    <hr/>
    <div id="nameBlock">
       <span id="userNameText" onclick="editName()" style="cursor:pointer;">ğŸ‘¤ Nutzername</span>
       <input id="usernameInput" type="text" style="display:none;" />
       <button onclick="saveUsername()" id="saveNameBtn" style="display:none;">ğŸ’¾</button>
    </div>
    <div id="roomToggle">
        <button onclick="toggleRoom()">ğŸ‘¥ Raum beitreten</button>
        <div id="roomBox" style="display:none;">
       <input id="roomId" placeholder="Raum-ID" />
       <button onclick="joinRoom()">â¡ï¸</button>
   </div>
    
    </div>
  </div>

  <!-- Toast & Debug-Feld -->
  <div id="toast"></div>
  <div id="debug"></div>

  <!-- Toolbar mit Routensteuerung -->
  <div id="toolbar">
    <button onclick="toggleFollow()">ğŸ“</button>
    <button onclick="toggleVoice()">ğŸ”Š</button>
    <button id="startBtn" onclick="startRoute()">â–¶ï¸ Start</button>
    <button id="stopBtn" onclick="stopNavigation()" style="display:none;">ğŸ›‘ Stop</button>
    <button onclick="resetRoute()">ğŸ—‘ï¸ Reset</button>
  </div>

  <!-- Scripte: Leaflet, MarkerCluster, Firebase, Turf -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Beginn des JavaScript-Codes -->
  <script>
    /////////////////////////////////////////
    // NAVIGATION: FunktionsÃ¼bersicht
    /////////////////////////////////////////
    // - ğŸ”¥ Firebase Setup
    // - ğŸŒ Karten & Marker Globals
    // - ğŸ§© Hilfsfunktionen
    // - ğŸ‘¤ Benutzerfunktionen
    // - ğŸ‘¥ Gruppenfunktionen
    // - ğŸš¨ Sicherheitsfunktionen
    // - ğŸ§­ Routingfunktionen
    // - ğŸ“‹ Auswahlliste
    // - ğŸš€ Initialisierung
    /////////////////////////////////////////
    // ğŸ”¥ Firebase Setup
    /////////////////////////////////////////
    const firebaseConfig = {
      apiKey: "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /////////////////////////////////////////
    // ğŸŒ Karten & Marker Globals
    /////////////////////////////////////////
    let map, userMarker;
    let follow = true;
    let voice = true;
    let cluster = L.markerClusterGroup();
    let huts = [], selected = [];
    let routingLine, progressLine, navInterval;
    let groupMarkers = {};
    let roomId = "default";
    let alias = "User" + Math.floor(Math.random() * 1000);
    let tourStartTime, tourDistance = 0, challengeProgress = 0;

    /////////////////////////////////////////
    // ğŸ§© Hilfsfunktionen
    /////////////////////////////////////////

    // Zeigt eine Toast-Nachricht am unteren Bildschirmrand
    function showToast(msg) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.style.display = "block";
      setTimeout(() => t.style.display = "none", 3000);
    }

    // Debug-Ausgabe im unteren linken Fenster
    function logDebug(msg) {
      const d = document.getElementById("debug");
      d.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      d.scrollTop = d.scrollHeight;
    }

    /////////////////////////////////////////
    // ğŸ‘¤ Benutzerfunktionen
    /////////////////////////////////////////

    // Speichert den eingegebenen Namen lokal
   /* function saveUsername() {
      const n = document.getElementById("username").value.trim();
      if (n) {
        localStorage.username = n;
        document.getElementById("userDisplay").innerText = "ğŸ‘¤ " + n;
        showToast("âœ”ï¸ Name gespeichert");
      }
    }*/

    // Zeigt gespeicherten Namen bei Start an
    function initUsername() {
      const n = localStorage.username;
      if (n) {
       // document.getElementById("userDisplay").innerText = "ğŸ‘¤ " + n;
        document.getElementById("userNameText").innerText = "ğŸ‘¤ " + n;
      }
    }


    function editName() {
  const current = localStorage.username || alias;
  document.getElementById("userNameText").style.display = "none";
  document.getElementById("usernameInput").style.display = "inline-block";
  document.getElementById("saveNameBtn").style.display = "inline-block";
  document.getElementById("usernameInput").value = current;
}

function saveUsername() {
  const n = document.getElementById("usernameInput").value.trim();
  if (n) {
    localStorage.username = n;
    document.getElementById("userNameText").innerText = "ğŸ‘¤ " + n;
    showToast("âœ”ï¸ Name gespeichert");
  }
  document.getElementById("userNameText").style.display = "inline-block";
  document.getElementById("usernameInput").style.display = "none";
  document.getElementById("saveNameBtn").style.display = "none";
}


    
    /////////////////////////////////////////
    // ğŸ‘¥ Gruppenfunktionen
    /////////////////////////////////////////

    // Tritt einem Raum bei
    function joinRoom() {
      const id = document.getElementById("roomId").value.trim();
      if (id) {
        roomId = id;
        showToast("ğŸ‘¥ Betrete Raum " + id);
        listenGroup();
      }
    }

    // Aktualisiert die eigene Position in Firebase
    function updateGroup() {
      if (userMarker) {
        const pos = userMarker.getLatLng();
        db.collection("live").doc(alias).set({
          name: localStorage.username || alias,
          lat: pos.lat,
          lng: pos.lng,
          room: roomId,
          ts: Date.now()
        });
      }
    }

    // HÃ¶rt auf andere Gruppenmitglieder
    function listenGroup() {
      db.collection("live").where("room", "==", roomId).onSnapshot(snap => {
        snap.forEach(doc => {
          const d = doc.data();
          if (doc.id === alias) return;

          if (!groupMarkers[doc.id]) {
            groupMarkers[doc.id] = L.marker([d.lat, d.lng], {
              icon: L.divIcon({ className: "group-icon", html: "ğŸ‘¥" })
            }).addTo(map);
          } else {
            groupMarkers[doc.id].setLatLng([d.lat, d.lng]);
          }
        });
      });
    }
    function toggleRoom() {
  const box = document.getElementById("roomBox");
  box.style.display = (box.style.display === "none") ? "block" : "none";
    }

    /////////////////////////////////////////
    // ğŸš¨ Sicherheitsfunktionen
    /////////////////////////////////////////

    // Sendet Notrufposition
    function sendSOS() {
      if (!confirm("âš ï¸ Bist du sicher, dass du ein SOS senden mÃ¶chtest?")) return;

     if (userMarker) {
        const pos = userMarker.getLatLng();
        showToast("âš ï¸ SOS gesendet: " + pos.lat.toFixed(5) + "," + pos.lng.toFixed(5));
        logDebug("SOS at " + pos);
      }
    }

    /////////////////////////////////////////
    // ğŸ§­ Routingfunktionen
    /////////////////////////////////////////

    // Follow-Modus umschalten
    function toggleFollow() {
      follow = !follow;
      showToast("ğŸ“ Follow " + (follow ? "AN" : "AUS"));
    }

    // SprachfÃ¼hrung umschalten
    function toggleVoice() {
      voice = !voice;
      showToast("ğŸ”Š Voice " + (voice ? "AN" : "AUS"));
    }

    // Text sprechen lassen
    function speak(text) {
      if (!voice) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "de-DE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    // Startet die Route
    function startRoute() {
      if (!userMarker || !selected.length) {
        showToast("â— Auswahl fehlt");
        return;
      }
      follow = true;
document.querySelector("#toolbar button[onclick='toggleFollow()']").style.display = "none";
      speak("Navigation gestartet. Viel SpaÃŸ!");
      tourStartTime = Date.now();
      tourDistance = 0;
      challengeProgress = 0;

      const coords = [
        [userMarker.getLatLng().lng, userMarker.getLatLng().lat],
        ...selected.map(h => [h.lng, h.lat])
      ];

      fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
        method: "POST",
        headers: {
          "Authorization": "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      }).then(r => r.json()).then(d => {
        const pts = d.features[0].geometry.coordinates.map(p => [p[1], p[0]]);
        if (routingLine) map.removeLayer(routingLine);
        if (progressLine) map.removeLayer(progressLine);
        // Zuerst die Zielroute ORANGE
        routingLine = L.polyline(pts, { color: "#f80", weight: 5 }).addTo(map);

        // Dann den Fortschrittsweg GRAU darunter
        progressLine = L.polyline([], { color: "#ccc", weight: 4 }).addTo(map);
        //routingLine = L.polyline(pts, { color: "#f80", weight: 5 }).addTo(map);
       // progressLine = L.polyline([], { color: "#aaa", weight: 4 }).addTo(map);
        map.fitBounds(routingLine.getBounds(), { padding: [30, 30] });
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("stopBtn").style.display = "inline-block";
        navInterval = setInterval(() => navLoop(pts), 10000);
      });
      updateSelectedList(); // âœ… Zeigt Statistik-Liste an, siehe unten
    }

    // Ãœberspringt aktuelle HÃ¼tte
    function skipHut() {
      if (navInterval) {
        clearInterval(navInterval);
        selected.shift();
        showToast("â­ï¸ HÃ¼tte Ã¼bersprungen");
        startRoute();
      }
    }

    // Beendet die Navigation
    function stopNavigation() {
      clearInterval(navInterval);
      navInterval = null;
      showToast("ğŸ›‘ Navigation gestoppt");
      speak("Navigation gestoppt");
      document.getElementById("stopBtn").style.display = "none";
      document.getElementById("startBtn").style.display = "inline-block";
      document.querySelector("#toolbar button[onclick='toggleFollow()']").style.display = "inline-block";
      updateSelectedList(); // âœ… Zeigt Statistik-Liste an, siehe unten
    }
    // Navigationsschleife zur Routenverfolgung
    function navLoop(path) {
      const pos = userMarker.getLatLng();
      const next = path[1];
      const dist = map.distance(pos, next);

      if (dist < 50 && path.length > 2) {
        const past = path.shift();
        
        progressLine.addLatLng(past)
        routingLine.setLatLngs(path);
        progressLine.addLatLng(past);

        
        selected.shift();
        updateSelectedList(); // visuelle Liste updaten
        if (selected.length > 0) {
            startRoute();
        } // Route neuberechnen

        speakNextInstruction(selected[0].name, 0);
        updateChallenge();
      } else if (path.length <= 2 && dist < 50) {
        stopNavigation();
        speak("Ziel erreicht");
        logSummary();
        updateChallenge();
      } else {
        tourDistance += map.distance(pos, next);
        speakNextInstruction(selected[0].name, dist);
        const rest = path.reduce((a, p, i, arr) => i > 0 ? a + map.distance(arr[i - 1], p) : 0, 0);
        document.getElementById("routeInfo").innerText =
          `${(rest / 1000).toFixed(1)} km Â· ${Math.round(rest / 250)} Min Â· ${selected[0].name}`;
        document.getElementById("routeInfo").style.display = "block";
      }
      updateGroup();
    }

    // Fortschritt updaten (Challenge)
    function updateChallenge() {
      challengeProgress++;
      showToast(`ğŸ¥š ${challengeProgress} besucht`);
      if (challengeProgress === selected.length) {
        showToast("ğŸ† Challenge geschafft");
      }
    }

    // Zusammenfassung nach Tour
    function logSummary() {
      const dur = Math.round((Date.now() - tourStartTime) / 60000);
      alert(`ğŸ Tour: ${(tourDistance / 1000).toFixed(2)} km in ${dur} Min`);
    }

    /////////////////////////////////////////
    // ğŸ“‹ Auswahlliste
    /////////////////////////////////////////

    // Aktualisiert die Listenanzeige der gewÃ¤hlten HÃ¼tten
let lastListMode = null; // "empty", "list", "stats"

function updateSelectedList() {
  const ul = document.getElementById("selectedList");
  if (!ul || !Array.isArray(selected)) return;

  ul.innerHTML = "";

  const hasHuts = selected.length > 0;
  const next = hasHuts ? selected[0] : null;
  const isNavigating = !!navInterval;
  const pos = userMarker?.getLatLng?.();
  const routePoints = routingLine?.getLatLngs?.() || [];

  if (!hasHuts) {
    if (lastListMode !== "empty") {
      const li = document.createElement("li");
      li.textContent = "âš ï¸ Keine HÃ¼tten ausgewÃ¤hlt.";
      ul.appendChild(li);
      lastListMode = "empty";
    }
    return;
  }

  const canShowStats = isNavigating && pos && next && routePoints.length > 1;

  if (canShowStats) {
    if (lastListMode !== "stats") {
      try {
        const dist = map.distance(pos, L.latLng(next.lat, next.lng));
        const totalDist = routePoints.reduce((sum, p, i, arr) =>
          i > 0 ? sum + map.distance(arr[i - 1], p) : 0, 0);

        const li = document.createElement("li");
        li.innerHTML = `
          ğŸ§­ <b>NÃ¤chste:</b> ${next.name}<br/>
          ğŸ“ <b>${Math.round(dist)} m</b> entfernt<br/>
          â±ï¸ Gesamt: ${(totalDist / 1000).toFixed(1)} km â‰ˆ ${Math.round(totalDist / 250)} min<br/>
          ğŸ¥š Verbleibende HÃ¼tten: ${selected.length}
        `;
        ul.appendChild(li);
        lastListMode = "stats";
      } catch (err) {
        console.warn("Statistikanzeige fehlgeschlagen:", err);
        renderStaticList(ul);
        lastListMode = "list";
      }
    }
  } else {
    if (lastListMode !== "list") {
      renderStaticList(ul);
      lastListMode = "list";
    }
  }
}

function renderStaticList(ul) {
  ul.innerHTML = "";
  selected.forEach((h, i) => {
    const li = document.createElement("li");
    li.setAttribute("draggable", "true");
    li.setAttribute("data-index", i);
    li.ondragstart = drag;
    li.innerHTML = `ğŸ”¢ ${i + 1}. ${h.name} <button onclick="removeHut('${h.id}')">ğŸ—‘ï¸</button>`;
    ul.appendChild(li);
  });
}
// Drag & Drop-Logik
function allowDrop(ev) {
  ev.preventDefault();
}
function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.getAttribute("data-index"));
}
function drop(ev) {
  ev.preventDefault();
  const from = parseInt(ev.dataTransfer.getData("text"));
  const to = parseInt(ev.target.closest("li").getAttribute("data-index"));
  if (from !== to) {
    const moved = selected.splice(from, 1)[0];
    selected.splice(to, 0, moved);
    updateSelectedList();
    showToast("ğŸ”ƒ Reihenfolge geÃ¤ndert");
    if (navInterval) startRoute(); // Route neu starten
  }
}
  function resetRoute() {
     if (routingLine) map.removeLayer(routingLine);
     if (progressLine) map.removeLayer(progressLine);
     clearInterval(navInterval);
     navInterval = null;
     showToast("ğŸ—‘ï¸ Route gelÃ¶scht");
     document.getElementById("routeInfo").style.display = "none";
    updateSelectedList(); // âœ… Zeigt Statistik-Liste an, siehe unten
  }
    // Entfernt eine HÃ¼tte aus der Auswahl
    function removeHut(id) {
  const i = selected.findIndex(h => h.id === id);
  if (i >= 0) {
    selected.splice(i, 1);
    updateSelectedList();
    showToast("âŒ HÃ¼tte entfernt");

    // ğŸ§  Wenn Navigation lÃ¤uft â†’ Route neu starten oder stoppen
    if (navInterval) {
      if (selected.length === 0) {
        stopNavigation();      // Route stoppen
        resetRoute();          // Route vollstÃ¤ndig entfernen
      } else {
        startRoute();          // Route neu berechnen mit verbleibenden HÃ¼tten
      }
    }
  }
    }

    // FÃ¼gt HÃ¼tte zur Auswahlliste hinzu
    function toggleSelection(id) {
      const hut = huts.find(h => h.id === id);
      if (!hut) {
        showToast("â— HÃ¼tte nicht gefunden");
        return;
      }
      if (selected.some(h => h.id === id)) {
        showToast("âš ï¸ Bereits ausgewÃ¤hlt");
        return;
      }
      
      selected.push(hut);
      updateSelectedList();
      showToast("âœ”ï¸ HinzugefÃ¼gt: " + hut.name);
    
    // Wenn die Route gestartet ist und eine neue HÃ¼tte hinzugefÃ¼gt wird :
     if (navInterval) {
        showToast("â• Neue HÃ¼tte hinzugefÃ¼gt, Route wird neu berechnet.");
        speak("Neue HÃ¼tte hinzugefÃ¼gt, Route wird aktualisiert.");
        clearInterval(navInterval);
        startRoute();
     }
    
    }

    /////////////////////////////////////////
    // ğŸš€ Initialisierung
    /////////////////////////////////////////

    function init() {
      initUsername();
      map = L.map("map", { center: [47.3, 11.4], zoom: 13 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.addLayer(cluster);

      navigator.geolocation.watchPosition(
        p => {
          const ll = [p.coords.latitude, p.coords.longitude];
          if (!userMarker) {
            userMarker = L.marker(ll).addTo(map);
            map.setView(ll, 15);
            document.getElementById("loader").style.display = "none";
          } else {
            userMarker.setLatLng(ll);
            if (follow) map.setView(ll);
          }
          updateGroup();
        },
        () => {
          document.getElementById("loader").style.display = "none";
          showToast("âš ï¸ GPS nicht verfÃ¼gbar");
        },
        { enableHighAccuracy: true }
      );

      listenGroup();

      db.collection("eierhuetten").onSnapshot(snap => {
        huts = [];
        cluster.clearLayers();
        snap.forEach(doc => {
          const d = doc.data();
          if (!d.location || d.status != "angenommen") return;
          const h = {
            id: doc.id,
            name: d.name,
            lat: d.location.latitude,
            lng: d.location.longitude
          };
          huts.push(h);
          const m = L.marker([h.lat, h.lng]).bindPopup(
            `<b>${h.name}</b><br><button onclick="toggleSelection('${h.id}')">âœ…</button>`
          );
          cluster.addLayer(m);
        });

        // Kompass
     if (window.DeviceOrientationEvent) {
       window.addEventListener("deviceorientationabsolute", e => {
       if (e.absolute && e.alpha != null) {
         const compass = document.getElementById("compass");
         const heading = 360 - e.alpha; // Drehung im Uhrzeigersinn
         compass.style.transform = `rotate(${heading}deg)`;
        }
      }, true);
     }
      });

      // Falls GPS nicht lÃ¤dt
      setTimeout(() => {
        const l = document.getElementById("loader");
        if (l && l.style.display != "none") {
          l.style.display = "none";
          showToast("â³ Timeout");
        }
      }, 10000);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
