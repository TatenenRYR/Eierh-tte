<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierh√ºtten Navigation ‚Äì Gruppen & Sicherheit</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; left:0; right:0; }
    #loader {
      position:fixed; inset:0;
      background:white;
      display:flex; align-items:center; justify-content:center;
      z-index:9999; font-size:1.2em;
    }
    #selectedHuts {
      position:fixed;
      top:10px; right:10px;
      background:white;
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
      z-index:1000;
    }
  </style>
</head>
<body>
  <div id="loader">‚è≥ Lade Karte‚Ä¶</div>
  <div id="map"></div>
  <div id="selectedHuts">
    <label for="selectedDropdown">üìã Ausgew√§hlte H√ºtte:</label>
    <select id="selectedDropdown" onchange="removeSelectedHut(this.value)">
      <option value="">H√ºtte entfernen...</option>
    </select>
    <button onclick="startRoute()">‚ñ∂Ô∏è Route starten</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map, userMarker, follow = true, voice = true;
    let cluster = L.markerClusterGroup();
    let huts = [], selected = [], routingLine, progressLine, navInterval;
    let groupMarkers = {}, roomId = "default", alias = "User" + Math.floor(Math.random() * 1000);
    let tourStartTime, tourDistance = 0, challengeProgress = 0;

    function speak(text) {
      if (!voice) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "de-DE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    function toggleFollow() { follow = !follow; }
    function toggleVoice() { voice = !voice; }

    function updateGroup() {
      if (userMarker) {
        const pos = userMarker.getLatLng();
        db.collection("live").doc(alias).set({
          name: localStorage.username || alias,
          lat: pos.lat,
          lng: pos.lng,
          room: roomId,
          ts: Date.now()
        });
      }
    }

    function listenGroup() {
      db.collection("live").where("room", "==", roomId).onSnapshot(snap => {
        snap.forEach(doc => {
          const d = doc.data();
          if (doc.id === alias) return;
          if (!groupMarkers[doc.id]) {
            groupMarkers[doc.id] = L.marker([d.lat, d.lng], {
              icon: L.divIcon({ className: "group-icon", html: "üë•" })
            }).addTo(map);
          } else {
            groupMarkers[doc.id].setLatLng([d.lat, d.lng]);
          }
        });
      });
    }
    function startRoute() {
      if (!userMarker || !selected.length) return;
      tourStartTime = Date.now();
      tourDistance = 0;
      challengeProgress = 0;
      const coords = [
        [userMarker.getLatLng().lng, userMarker.getLatLng().lat],
        ...selected.map(h => [h.lng, h.lat])
      ];
      fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
        method: "POST",
        headers: {
          "Authorization": "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      }).then(r => r.json()).then(d => {
        const pts = d.features[0].geometry.coordinates.map(p => [p[1], p[0]]);
        if (routingLine) map.removeLayer(routingLine);
        if (progressLine) map.removeLayer(progressLine);
        routingLine = L.polyline(pts, { color: "#f80", weight: 5 }).addTo(map);
        progressLine = L.polyline([], { color: "#aaa", weight: 4 }).addTo(map);
        map.fitBounds(routingLine.getBounds(), { padding: [30, 30] });
        navInterval = setInterval(() => navLoop(pts), 10000);
      });
    }

    function navLoop(path) {
      const pos = userMarker.getLatLng();
      const next = path[1];
      const dist = map.distance(pos, next);
      if (dist < 50 && path.length > 2) {
        const past = path.shift();
        routingLine.setLatLngs(path);
        progressLine.addLatLng(past);
        speak("Zwischenziel erreicht");
        challengeProgress++;
      } else if (path.length <= 2 && dist < 50) {
        clearInterval(navInterval);
        speak("Ziel erreicht");
        const duration = Math.round((Date.now() - tourStartTime) / 60000);
        alert(`üèÅ ${(tourDistance/1000).toFixed(2)} km in ${duration} Min`);
      } else {
        tourDistance += map.distance(pos, next);
        speak(`In ${Math.round(dist)} Metern`);
      }
      updateGroup();
    }

    function removeSelectedHut(hutId) {
      if (!hutId) return;
      selected = selected.filter(h => h.id !== hutId);
      updateSelectedDropdown();
    }

    function updateSelectedDropdown() {
      const dropdown = document.getElementById("selectedDropdown");
      dropdown.innerHTML = '<option value="">H√ºtte entfernen...</option>';
      selected.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h.id;
        opt.textContent = h.name;
        dropdown.appendChild(opt);
      });
    }

    function selectHut(id) {
      const h = huts.find(x => x.id === id);
      if (!h || selected.some(s => s.id === id)) return;
      selected.push(h);
      updateSelectedDropdown();
    }

    document.addEventListener("DOMContentLoaded", () => {
      map = L.map("map", { center: [47.3, 11.4], zoom: 13 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.addLayer(cluster);
      navigator.geolocation.watchPosition(p => {
        const ll = [p.coords.latitude, p.coords.longitude];
        if (!userMarker) {
          userMarker = L.marker(ll).addTo(map);
          map.setView(ll, 15);
          document.getElementById("loader").style.display = "none";
        } else {
          userMarker.setLatLng(ll);
          if (follow) map.setView(ll);
        }
        updateGroup();
      }, () => {
        document.getElementById("loader").style.display = "none";
      }, { enableHighAccuracy: true });

      listenGroup();

      db.collection("eierhuetten").onSnapshot(snap => {
        huts = [];
        cluster.clearLayers();
        snap.forEach(doc => {
          const d = doc.data();
          if (!d.location || d.status !== "angenommen") return;
          const h = {
            id: doc.id,
            name: d.name,
            lat: d.location.latitude,
            lng: d.location.longitude
          };
          huts.push(h);
          const m = L.marker([h.lat, h.lng])
            .bindPopup(`<b>${h.name}</b><br><button onclick=\"selectHut('${h.id}')\">‚úÖ Hinzuf√ºgen</button>`);
          cluster.addLayer(m);
        });
      });
    });
  </script>
</body>
</html>
