<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten-Radtour</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; }
    #loader {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
      font-size: 1.2em;
      z-index: 2000;
    }
    #debugConsole {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #222;
      color: #0f0;
      padding: 10px;
      font-size: 12px;
      max-height: 200px;
      overflow: auto;
      z-index: 3001;
      display: none;
    }
    #routeInfo, #errorInfo {
      position: absolute;
      top: 10px;
      background: white;
      padding: 6px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 1000;
    }
    #routeInfo { left: 10px; }
    #errorInfo { right: 10px; background: #fdd; color: #900; }
  </style>
</head>
<body><div id="loader">üö≤ Karte wird geladen‚Ä¶</div>
<div id="map"></div>
<div id="debugConsole"></div>
<div id="routeInfo"></div>
<div id="errorInfo"></div><script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const map = L.map('map').setView([51.1657, 10.4515], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let huetten = [];
let huettenMarkerLayer = L.layerGroup().addTo(map);
let userBikeMarker = null;
let followBike = true;

const animatedBikeIcon = L.divIcon({
  className: 'animated-bike-icon',
  html: `<div style="animation:bounce 1s infinite ease-in-out;">üö≤</div>`,
  iconSize: [32, 32],
  iconAnchor: [16, 16]
});

function updateRadiusCircle() {} // Platzhalter
function filterHuettenByRadius() { return huetten; }

async function ladeEierhuetten() {
  console.log("üì¶ Lade Eierh√ºtten...");
  try {
    const querySnapshot = await getDocs(collection(db, "eierhuetten"));
    const geladeneHuetten = [];
    huettenMarkerLayer.clearLayers();
    let gesamt = 0;
    let √ºbersprungen = 0;
    let debugText = "üê£ Debug-Info:\n";

    querySnapshot.forEach((doc) => {
      gesamt++;
      const data = doc.data();
      const coords = data.coords;
      if (data.status !== "aktiviert" || !coords) {
        √ºbersprungen++;
        debugText += `‚ö†Ô∏è ${doc.id} √ºbersprungen (Status: ${data.status}, Koordinaten: ${coords ? "ja" : "nein"})\n`;
        return;
      }
      const hut = {
        id: doc.id,
        lat: coords.lat,
        lng: coords.lng,
        name: data.standort || "Unbekannter Ort",
        desc: data.beschreibung || "Keine Beschreibung",
        strom: data.strom || false
      };
      geladeneHuetten.push(hut);
      L.marker([hut.lat, hut.lng])
        .addTo(huettenMarkerLayer)
        .bindPopup(`<b>${hut.name}</b><br>${hut.desc}<br>${hut.strom ? "‚úÖ Strom" : "‚ùå Kein Strom"}`);
    });

    huetten = geladeneHuetten;
    localStorage.setItem("huetten", JSON.stringify(huetten));
    debugText += `\n‚úÖ Gesamt: ${gesamt}, geladen: ${geladeneHuetten.length}, √ºbersprungen: ${√ºbersprungen}`;
    document.getElementById("routeInfo").innerText = debugText;
    const debugEl = document.getElementById("debugConsole");
    debugEl.textContent = debugText;
    debugEl.style.display = "block";
    console.log("‚úÖ Eierh√ºtten geladen.");
  } catch (error) {
    console.error("‚ùå Fehler beim Laden:", error);
    document.getElementById("errorInfo").innerText = "Fehler beim Laden der Eierh√ºtten.";
  }
}

function updateUserBike() {
  navigator.geolocation.watchPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      if (!userBikeMarker) {
        userBikeMarker = L.marker([lat, lng], { icon: animatedBikeIcon }).addTo(map);
        document.getElementById("loader").style.display = "none";
      } else {
        userBikeMarker.setLatLng([lat, lng]);
      }
      if (followBike) {
        map.setView([lat, lng], 14);
      }
    },
    (err) => {
      console.warn("GPS-Fehler:", err);
      map.setView([51.1657, 10.4515], 6);
      document.getElementById("loader").style.display = "none";
    }
  );
}

// Initialisierung
ladeEierhuetten();
updateUserBike();
</script></body>
</html>
