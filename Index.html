<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EierhÃ¼tten Navigation â€“ Gruppen & Sicherheit</title>
  <!-- Styles & Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; left:0; right:0; }
    #loader { position:fixed; inset:0; background:white; display:flex; align-items:center; justify-content:center; z-index:9999; font-size:1.2em; }
    #toolbar { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:8px; background:#fff; padding:8px 12px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:1000; }
    #toolbar button, #toolbar input { min-width:48px; min-height:48px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
    #toolbar input { padding:0 8px; flex:1; }
    #dashboard { position:fixed; top:60px; right:10px; width:240px; background:#fff; border:1px solid #ccc; padding:10px; z-index:1001; font-size:14px; border-radius:8px; }
    #toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 16px; border-radius:8px; display:none; z-index:1002; }
    #debug { position:fixed; bottom:10px; left:10px; background:black; color:lime; padding:6px; font-family:monospace; font-size:12px; border-radius:6px; z-index:1002; max-height:120px; overflow:auto; }
    #routeInfo { position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:6px 14px; border-radius:8px; font-size:14px; z-index:1001; display:none; }
    #compass { position:fixed;top:20px;left:20px;width:50px;height:50px;background:#fff;border-radius:50%;z-index:1001;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 5px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div id="loader">â³ Lade Karteâ€¦</div>
  <div id="map"></div>
  <div id="compass">ğŸ§­</div>
  <div id="routeInfo">0 km Â· 0 Min Â· -</div>
  <div id="dashboard">
    <b>ğŸ“‹ AusgewÃ¤hlt:</b>
    <ul id="selectedList"></ul>
    <button onclick="skipHut()">â­ï¸ NÃ¤chste Ã¼berspringen</button>
    <hr/>
    <button onclick="sendSOS()">â— SOS senden</button>
    <hr/>
    <input id="username" placeholder="Name" />
    <button onclick="saveUsername()">ğŸ’¾ Speichern</button>
    <p id="userDisplay"></p>
    <input id="roomId" placeholder="Raum-ID" />
    <button onclick="joinRoom()">ğŸ‘¥ Beitreten</button>
  </div>
  <div id="toast"></div>
  <div id="debug"></div>
  <div id="toolbar">
    <button onclick="toggleFollow()">ğŸ“</button>
    <button onclick="toggleVoice()">ğŸ”Š</button>
    <button id="startBtn" onclick="startRoute()">â–¶ï¸ Start</button>
    <button id="stopBtn" onclick="stopNavigation()" style="display:none;">ğŸ›‘ Stop</button>
    <button onclick="resetRoute()">ğŸ—‘ï¸ Reset</button>
  </div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>  <script>
    // Firebase Init
    const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Globals
    let map, userMarker, follow = true, voice = true;
    let cluster = L.markerClusterGroup(), huts = [], selected = [];
    let routingLine, progressLine, navInterval;
    let groupMarkers = {}, roomId = "default", alias = "User" + Math.floor(Math.random() * 1000);
    let tourStartTime, tourDistance = 0, challengeProgress = 0;

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.style.display = "block";
      setTimeout(() => t.style.display = "none", 3000);
    }

    function logDebug(msg) {
      const d = document.getElementById("debug");
      d.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      d.scrollTop = d.scrollHeight;
    }

    function saveUsername() {
      const n = document.getElementById("username").value.trim();
      if (n) {
        localStorage.username = n;
        document.getElementById("userDisplay").innerText = "ğŸ‘¤ " + n;
        showToast("âœ”ï¸ Name gespeichert");
      }
    }

    function initUsername() {
      const n = localStorage.username;
      if (n) document.getElementById("userDisplay").innerText = "ğŸ‘¤ " + n;
    }

    function joinRoom() {
      const id = document.getElementById("roomId").value.trim();
      if (id) {
        roomId = id;
        showToast("ğŸ‘¥ Betrete Raum " + id);
        listenGroup();
      }
    }

    function updateGroup() {
      if (userMarker) {
        const pos = userMarker.getLatLng();
        db.collection("live").doc(alias).set({
          name: localStorage.username || alias,
          lat: pos.lat,
          lng: pos.lng,
          room: roomId,
          ts: Date.now()
        });
      }
    }

    function listenGroup() {
      db.collection("live").where("room", "==", roomId).onSnapshot(snap => {
        snap.forEach(doc => {
          const d = doc.data();
          if (doc.id === alias) return;
          if (!groupMarkers[doc.id]) {
            groupMarkers[doc.id] = L.marker([d.lat, d.lng], {
              icon: L.divIcon({ className: "group-icon", html: "ğŸ‘¥" })
            }).addTo(map);
          } else {
            groupMarkers[doc.id].setLatLng([d.lat, d.lng]);
          }
        });
      });
    }

    function sendSOS() {
      if (userMarker) {
        const pos = userMarker.getLatLng();
        showToast("âš ï¸ SOS gesendet: " + pos.lat.toFixed(5) + "," + pos.lng.toFixed(5));
        logDebug("SOS at " + pos);
      }
    }

    function toggleFollow() {
      follow = !follow;
      showToast("ğŸ“ Follow " + (follow ? "AN" : "AUS"));
    }

    function toggleVoice() {
      voice = !voice;
      showToast("ğŸ”Š Voice " + (voice ? "AN" : "AUS"));
    }

    function speak(text) {
      if (!voice) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "de-DE";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    function skipHut() {
      if (navInterval) {
        clearInterval(navInterval);
        selected.shift();
        showToast("â­ï¸ HÃ¼tte Ã¼bersprungen");
        startRoute();
      }
    }

    function toggleSelection(id) {
      const hut = huts.find(h => h.id === id);
      if (!hut) return showToast("â— HÃ¼tte nicht gefunden");
      if (selected.some(h => h.id === id)) return showToast("âš ï¸ Bereits ausgewÃ¤hlt");
      selected.push(hut);
      updateSelectedList();
      showToast("âœ”ï¸ HinzugefÃ¼gt: " + hut.name);
    }

    function startRoute() {
      if (!userMarker || !selected.length) {
        showToast("â— Auswahl fehlt");
        return;
      }

      speak("Navigation gestartet. Viel SpaÃŸ!");
      tourStartTime = Date.now();
      tourDistance = 0;
      challengeProgress = 0;

      const coords = [
        [userMarker.getLatLng().lng, userMarker.getLatLng().lat],
        ...selected.map(h => [h.lng, h.lat])
      ];

      fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
        method: "POST",
        headers: {
          "Authorization": "...",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      })
      .then(r => r.json())
      .then(d => {
        const pts = d.features[0].geometry.coordinates.map(p => [p[1], p[0]]);
        if (routingLine) map.removeLayer(routingLine);
        if (progressLine) map.removeLayer(progressLine);
        routingLine = L.polyline(pts, { color: "#f80", weight: 5 }).addTo(map);
        progressLine = L.polyline([], { color: "#aaa", weight: 4 }).addTo(map);
        map.fitBounds(routingLine.getBounds(), { padding: [30, 30] });

        document.querySelectorAll("#toolbar button").forEach(btn => {
          if (btn.id !== "stopBtn") btn.style.display = "none";
        });
        document.getElementById("stopBtn").style.display = "inline-block";

        navInterval = setInterval(() => navLoop(pts), 10000);
      });
    }

    function stopNavigation() {
      clearInterval(navInterval);
      navInterval = null;
      speak("Navigation gestoppt");
      showToast("ğŸ›‘ Navigation gestoppt");
      document.querySelectorAll("#toolbar button").forEach(btn => {
        btn.style.display = "inline-block";
      });
      document.getElementById("stopBtn").style.display = "none";
    }

    function resetRoute() {
  selected = [];
  if (routingLine) map.removeLayer(routingLine);
  if (progressLine) map.removeLayer(progressLine);
  clearInterval(navInterval);
  updateSelectedList();
  document.getElementById("routeInfo").style.display = "none";
  showToast("ğŸ—‘ï¸ Route gelÃ¶scht");
}

function updateSelectedList() {
  const ul = document.getElementById("selectedList");
  ul.innerHTML = "";
  selected.forEach((h, i) => {
    const li = document.createElement("li");
    li.innerHTML = `ğŸ”¢ ${i + 1}. ${h.name} <button onclick="removeHut('${h.id}')">ğŸ—‘ï¸</button>`;
    ul.appendChild(li);
  });
}

function removeHut(id) {
  const i = selected.findIndex(h => h.id === id);
  if (i >= 0) {
    selected.splice(i, 1);
    updateSelectedList();
    showToast("âŒ Entfernt");
  }
}

function navLoop(path) {
  const pos = userMarker.getLatLng();
  const next = path[1];
  const dist = map.distance(pos, next);

  if (dist < 50 && path.length > 2) {
    const past = path.shift();
    routingLine.setLatLngs(path);
    progressLine.addLatLng(past);
    speakNextInstruction(selected[0].name, 0);
    updateChallenge();
  } else if (path.length <= 2 && dist < 50) {
    stopNavigation();
    speak("Ziel erreicht");
    logSummary();
    updateChallenge();
  } else {
    tourDistance += map.distance(pos, next);
    speakNextInstruction(selected[0].name, dist);
    const rest = path.reduce((a, p, i, arr) => i > 0 ? a + map.distance(arr[i - 1], p) : 0, 0);
    document.getElementById("routeInfo").innerText = `${(rest / 1000).toFixed(1)} km Â· ${Math.round(rest / 250)} Min Â· ${selected[0].name}`;
    document.getElementById("routeInfo").style.display = "block";
  }

  updateGroup();
}

function speakNextInstruction(name, distance) {
  if (distance === 0) {
    speak(`Ankunft bei ${name}`);
  } else {
    speak(`NÃ¤chste HÃ¼tte: ${name} in ${Math.round(distance)} Metern`);
  }
}

function updateChallenge() {
  challengeProgress++;
  showToast(`ğŸ¥š ${challengeProgress} besucht`);
  if (challengeProgress === selected.length) {
    showToast("ğŸ† Challenge geschafft");
  }
}

function logSummary() {
  const dur = Math.round((Date.now() - tourStartTime) / 60000);
  alert(`ğŸ Tour: ${(tourDistance / 1000).toFixed(2)} km in ${dur} Min`);
}
  </script></body>
</html>
