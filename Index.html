<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>RadlMap Assistent</title>

    <meta property="og:title" content="RadlMap Tourplaner" />
    <meta property="og:description" content="Plane deine optimierte Radtour zu den besten regionalen H√ºtten!" />
    <meta property="og:image" content="https://radlmap.net/img/preview.png" />
    <meta property="og:url" content="https://radlmap.net" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- Base & Theming --- */
        :root {
            --bg-light: #ffffff;
            --text-light: #222222;
            --accent-light: #f9f9f9;
            
            --bg-dark: #121212;
            --text-dark: #f0f0f0;
            --accent-dark: #1f1f1f;

            --color-primary: #22c55e;
            --color-secondary: #3b82f6;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* --- Google Maps Style User Marker --- */
        .user-marker-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .user-marker-dot {
            width: 20px;
            height: 20px;
            background-color: #4285F4;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .user-marker-accuracy {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #4285F4;
            border-radius: 50%;
            opacity: 0.2;
            animation: pulse 2s infinite ease-out;
            transform-origin: center;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.3; }
            70% { transform: scale(1.6); opacity: 0.1; }
            100% { transform: scale(2.2); opacity: 0; }
        }
        .user-marker-heading {
            position: absolute;
            top: -10px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #4285F4;
            transition: transform 0.3s ease-out;
            transform-origin: 50% 22px; /* Dreht um die Mitte des blauen Punktes */
        }

        /* --- UI Components --- */
        .ui-element {
            position: fixed;
            z-index: 1001;
            background: var(--bg-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 12px;
            transition: background-color 0.3s;
        }
        body.dark-mode .ui-element {
             background: var(--accent-dark);
             color: var(--text-dark);
             border: 1px solid #444;
        }
        
        #loader {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-size: 1.5em;
        }

        #toast {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 9000;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 14px;
        }

        /* --- Toolbar --- */
        #toolbar {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            display: flex;
            gap: 8px;
        }
        #toolbar button {
            width: 50px;
            height: 50px;
            font-size: 20px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #333;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        #toolbar button:disabled {
            background-color: #e0e0e0;
            color: #aaa;
            cursor: not-allowed;
        }
        #toolbar button.active {
            background-color: var(--color-secondary);
            color: white;
        }
        #toolbar #stopBtn {
            background-color: var(--color-danger);
            color: white;
        }
        #startBtn {
            background-color: var(--color-primary) !important;
            color: white !important;
            width: auto !important;
            padding: 0 20px;
            border-radius: 25px !important;
        }

        /* --- Dashboard --- */
        #dashboard {
            top: 20px;
            right: 20px;
            width: 320px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 40px);
        }
        #toggleDashboardBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1002;
            background: white;
            color: #333;
            border: 1px solid #ccc;
            font-size: 24px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
        }
        body.dark-mode .dashboard-header { border-color: #444; }
        
        #selectedList li {
            background: var(--accent-light);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        body.dark-mode #selectedList li { background: var(--bg-dark); }
        .action-button {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
        }
        .action-button.optimize { background-color: var(--color-secondary); }
        .action-button.reset { background-color: var(--color-warning); }

        .hidden { display: none !important; }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="loader">‚è≥ Lade Karte‚Ä¶</div>
    <div id="toast"></div>

    <button id="toggleDashboardBtn" class="ui-button">‚ò∞</button>

    <div id="dashboard" class="ui-element hidden">
        <div class="dashboard-header">
            <h3 class="text-lg font-semibold">Tourplaner</h3>
            <button id="dashboardClose" class="text-2xl">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto">
            <section id="tab-route">
                <p class="text-sm text-gray-600 mb-4">Klicke auf eine H√ºtte, um sie zur Route hinzuzuf√ºgen.</p>
                <ul id="selectedList" class="list-none p-0">
                    </ul>
                <div class="flex gap-2 mt-4">
                     <button id="optimizeBtn" class="action-button optimize">üîÑ Optimieren</button>
                     <button id="resetRouteBtn" class="action-button reset">üóëÔ∏è Leeren</button>
                </div>
            </section>
        </div>
    </div>
    
    <div id="toolbar" class="ui-element">
        <button id="startBtn" disabled>‚ñ∂Ô∏è Start</button>
        <button id="stopBtn" class="hidden">üõë Stop</button>
        <button id="followBtn" class="active">üìç</button>
        <button id="themeBtn">üåô</button>
    </div>

<script>
// --- Smart RadlMap Assistant ---

const RadlMap = {
    // --- Configuration ---
    config: {
        orsApiKey: "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e16", // Ersetzen Sie dies sicher
        
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
firebase: {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
},
        map: {
            initialCenter: [49.9, 10.5],
            initialZoom: 6
        }
    },

    // --- Application State ---
    state: {
        map: null,
        userMarker: null,
        userMarkerHeading: 0,
        routeLayer: null,
        markerCluster: L.markerClusterGroup(),
        selectedStops: [],
        isNavigating: false,
        isFollowing: true,
        isDarkMode: false,
    },

    // --- Initialization ---
    init() {
        this.initFirebase();
        this.initMap();
        this.initUI();
        this.loadHuts();
        this.locateUser();
        this.initOrientation();
    },

    initFirebase() {
        firebase.initializeApp(this.config.firebase);
        this.db = firebase.firestore();
    },

    initMap() {
        this.state.map = L.map('map', { zoomControl: false }).setView(this.config.map.initialCenter, this.config.map.initialZoom);
        this.state.map.addLayer(this.state.markerCluster);
        this.updateMapTheme();
        this.state.map.on('dragstart', () => this.toggleFollow(false));
    },

    initUI() {
        this.ui = {
            loader: document.getElementById('loader'),
            toast: document.getElementById('toast'),
            dashboard: document.getElementById('dashboard'),
            toggleDashboardBtn: document.getElementById('toggleDashboardBtn'),
            dashboardClose: document.getElementById('dashboardClose'),
            selectedList: document.getElementById('selectedList'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            optimizeBtn: document.getElementById('optimizeBtn'),
            resetRouteBtn: document.getElementById('resetRouteBtn'),
            followBtn: document.getElementById('followBtn'),
            themeBtn: document.getElementById('themeBtn'),
        };

        this.ui.toggleDashboardBtn.onclick = () => this.toggleDashboard();
        this.ui.dashboardClose.onclick = () => this.toggleDashboard(false);
        this.ui.startBtn.onclick = () => this.startNavigation();
        this.ui.stopBtn.onclick = () => this.stopNavigation();
        this.ui.optimizeBtn.onclick = () => this.optimizeAndDrawRoute();
        this.ui.resetRouteBtn.onclick = () => this.resetRoute();
        this.ui.followBtn.onclick = () => this.toggleFollow();
        this.ui.themeBtn.onclick = () => this.toggleTheme();

        this.state.isDarkMode = localStorage.getItem('radlmap_theme') === 'dark';
        if (this.state.isDarkMode) document.body.classList.add('dark-mode');
        this.ui.themeBtn.textContent = this.state.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        this.updateMapTheme();
    },

    initOrientation() {
        const handleOrientation = (event) => {
            if (event.webkitCompassHeading) { // iOS
                this.state.userMarkerHeading = event.webkitCompassHeading;
            } else if (event.alpha !== null) { // Android
                this.state.userMarkerHeading = 360 - event.alpha;
            }
            if (this.state.userMarker) {
                this.rotateUserMarker();
            }
        };

        if (window.DeviceOrientationEvent) {
             if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    });
            } else {
                // Android
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
    },
    
    // --- Core Functionality ---
    loadHuts() {
        this.db.collection("eierhuetten").where("status", "==", "angenommen").onSnapshot(snapshot => {
            this.state.markerCluster.clearLayers();
            snapshot.forEach(doc => {
                const hut = { id: doc.id, ...doc.data() };
                if (hut.location) {
                    const marker = L.marker([hut.location.latitude, hut.location.longitude]);
                    marker.on('click', () => this.addStop(hut));
                    this.state.markerCluster.addLayer(marker);
                }
            });
            this.ui.loader.classList.add('hidden');
        }, err => {
            console.error("Fehler beim Laden der H√ºtten:", err);
            this.ui.loader.textContent = "Fehler beim Laden.";
        });
    },

    locateUser() {
        navigator.geolocation.watchPosition(
            (pos) => {
                const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if (!this.state.userMarker) { // On first location, center map
                    this.state.map.setView(latlng, 16);
                }
                this.updateUserMarker(latlng);
            },
            () => this.showToast("Standort konnte nicht ermittelt werden.", "error"), 
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    },

    updateUserMarker(latlng) {
        if (!this.state.userMarker) {
            const userIcon = L.divIcon({
                className: 'user-marker-container',
                html: `<div class="user-marker-accuracy"></div><div class="user-marker-dot"></div><div class="user-marker-heading"></div>`,
                iconSize: [60, 60],
                iconAnchor: [30, 30]
            });
            this.state.userMarker = L.marker(latlng, { icon: userIcon, rotationOrigin: 'center center' }).addTo(this.state.map);
        } else {
            this.state.userMarker.setLatLng(latlng);
        }
        if (this.state.isFollowing) {
            this.state.map.panTo(latlng);
        }
    },
    
    rotateUserMarker() {
        const headingElement = this.state.userMarker.getElement().querySelector('.user-marker-heading');
        if (headingElement) {
            headingElement.style.transform = `rotate(${this.state.userMarkerHeading}deg)`;
        }
    },
    
    addStop(hut) {
        if (this.state.selectedStops.find(stop => stop.id === hut.id)) {
            this.showToast("Dieser Stopp ist bereits auf der Route.", "warning");
            return;
        }
        this.state.selectedStops.push(hut);
        this.updateRouteDashboard();
        this.drawPreviewRoute();
    },

    removeStop(hutId) {
        this.state.selectedStops = this.state.selectedStops.filter(stop => stop.id !== hutId);
        this.updateRouteDashboard();
        this.drawPreviewRoute();
    },

    resetRoute() {
        this.stopNavigation();
        this.state.selectedStops = [];
        if (this.state.routeLayer) {
            this.state.map.removeLayer(this.state.routeLayer);
            this.state.routeLayer = null;
        }
        this.updateRouteDashboard();
    },

    /**
     * SMARTER ROUTING: Calculates the most efficient order to visit the selected stops.
     */
    async optimizeAndDrawRoute() {
        if (this.state.selectedStops.length < 2) {
            this.showToast("Bitte mindestens 2 Stopps ausw√§hlen.", "warning");
            return;
        }
        this.showToast("Berechne optimale Route...");
        
        const startPoint = this.state.userMarker.getLatLng();
        const optimizedStops = this.optimizeRouteOrder(startPoint, this.state.selectedStops);
        this.state.selectedStops = optimizedStops;

        this.updateRouteDashboard();
        await this.drawPreviewRoute();
        this.showToast("Optimale Route berechnet!", "success");
    },

    optimizeRouteOrder(start, stops) {
        let remainingStops = [...stops];
        let orderedStops = [];
        let currentLocation = L.latLng(start);

        while (remainingStops.length > 0) {
            let nearestStop = null;
            let minDistance = Infinity;
            let nearestIndex = -1;

            remainingStops.forEach((stop, index) => {
                const stopLocation = L.latLng(stop.location.latitude, stop.location.longitude);
                const distance = currentLocation.distanceTo(stopLocation);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStop = stop;
                    nearestIndex = index;
                }
            });

            if (nearestStop) {
                orderedStops.push(nearestStop);
                currentLocation = L.latLng(nearestStop.location.latitude, nearestStop.location.longitude);
                remainingStops.splice(nearestIndex, 1);
            }
        }
        return orderedStops;
    },

    async drawPreviewRoute() {
        if (this.state.routeLayer) this.state.map.removeLayer(this.state.routeLayer);
        if (this.state.selectedStops.length < 2) return;

        const waypoints = [
            this.state.userMarker.getLatLng(),
            ...this.state.selectedStops.map(s => L.latLng(s.location.latitude, s.location.longitude))
        ];
        
        const coordinates = waypoints.map(wp => [wp.lng, wp.lat]);

        try {
            const route = await this.fetchRoute(coordinates);
            if (route) {
                this.state.routeLayer = L.polyline(route.coords, { color: '#3b82f6', weight: 6, opacity: 0.8 }).addTo(this.state.map);
                this.state.map.fitBounds(this.state.routeLayer.getBounds(), { padding: [50, 50] });
            }
        } catch (error) {
            this.showToast("Routenberechnung fehlgeschlagen.", "error");
        }
    },

    async fetchRoute(coordinates) {
        const url = 'https://api.openrouteservice.org/v2/directions/cycling-regular/geojson';
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': this.config.orsApiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ coordinates, instructions: false })
        });
        if (!response.ok) throw new Error("ORS request failed");
        
        const data = await response.json();
        const coords = data.features[0].geometry.coordinates.map(p => [p[1], p[0]]); // Flip to Lat,Lng
        return { coords };
    },
    
    startNavigation() {
        if (this.state.selectedStops.length === 0) return;
        this.state.isNavigating = true;
        this.toggleDashboard(false);
        this.showToast("Navigation gestartet!", "success");
        this.ui.startBtn.classList.add('hidden');
        this.ui.stopBtn.classList.remove('hidden');
        if (this.state.routeLayer) this.state.routeLayer.setStyle({ color: '#22c55e' });
    },

    stopNavigation() {
        this.state.isNavigating = false;
        this.showToast("Navigation gestoppt.");
        this.ui.startBtn.classList.remove('hidden');
        this.ui.stopBtn.classList.add('hidden');
        if (this.state.routeLayer) this.state.routeLayer.setStyle({ color: '#3b82f6' });
    },
    
    // --- UI Helpers ---
    toggleDashboard(forceState) {
        const shouldBeOpen = forceState !== undefined ? forceState : this.ui.dashboard.classList.contains('hidden');
        this.ui.dashboard.classList.toggle('hidden', !shouldBeOpen);
    },

    updateRouteDashboard() {
        this.ui.selectedList.innerHTML = this.state.selectedStops.length === 0
            ? '<li class="text-gray-400">Keine Stopps ausgew√§hlt.</li>'
            : this.state.selectedStops.map((stop, index) => `
                <li>
                    <span class="font-medium"><b>${index + 1}.</b> ${stop.name}</span>
                    <button onclick="RadlMap.removeStop('${stop.id}')" class="text-red-500 text-xl font-bold">&times;</button>
                </li>`).join('');
        
        this.ui.startBtn.disabled = this.state.selectedStops.length < 1;
    },
    
    toggleFollow(forceState) {
        this.state.isFollowing = forceState !== undefined ? forceState : !this.state.isFollowing;
        this.ui.followBtn.classList.toggle('active', this.state.isFollowing);
        if (this.state.isFollowing && this.state.userMarker) {
            this.state.map.panTo(this.state.userMarker.getLatLng());
        }
    },

    toggleTheme() {
        this.state.isDarkMode = !this.state.isDarkMode;
        document.body.classList.toggle('dark-mode', this.state.isDarkMode);
        this.ui.themeBtn.textContent = this.state.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('radlmap_theme', this.state.isDarkMode ? 'dark' : 'light');
        this.updateMapTheme();
    },

    updateMapTheme() {
        if (this.tileLayer) this.state.map.removeLayer(this.tileLayer);
        const url = this.state.isDarkMode 
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        this.tileLayer = L.tileLayer(url, { maxZoom: 19 }).addTo(this.state.map);
    },

    showToast(msg, type = 'info') {
        const t = this.ui.toast;
        t.textContent = msg;
        t.style.backgroundColor = type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#333';
        t.style.display = "block";
        setTimeout(() => t.style.display = "none", 3000);
    }
};

// --- App Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    RadlMap.init();
});

</script>
</body>
</html>
