<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>RadlMap Tourplaner</title>

  <meta property="og:title" content="üö≤ RadlMap Tourplaner" />
  <meta property="og:description" content="Plane deine perfekte Radtour zu den sch√∂nsten H√ºtten und Orten!" />
  <meta property="og:image" content="https://radlmap.net/img/preview.png" />
  <meta property="og:url" content="https://radlmap.net" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline"></script>
  <script src="https://unpkg.com/leaflet-geometryutil"></script>
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg-light: #f8f9fa; --text-light: #212529; --sheet-light: #ffffff;
      --bg-dark: #121212; --text-dark: #e9ecef; --sheet-dark: #1e1e1e;
      --accent-color: #22c55e; --accent-dark: #16a34a;
      --blue-color: #3b82f6; --red-color: #ef4444;
    }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-light);
    }
    body.dark-mode { background-color: var(--bg-dark); }
    #map { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; background-color: #f0f0f0; }
    body.dark-mode #map { background-color: var(--bg-dark); }
    #loader {
        position: fixed; inset: 0; background: var(--sheet-light); display: flex;
        align-items: center; justify-content: center; z-index: 10000; flex-direction: column; gap: 1rem;
        transition: opacity 0.5s ease;
    }
    body.dark-mode #loader { background: var(--sheet-dark); color: var(--text-dark); }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinner { width: 48px; height: 48px; border: 5px solid rgba(0,0,0,0.1); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
    
    .ui-element {
        position: fixed; z-index: 1000; background: var(--sheet-light);
        border-radius: 999px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        border: 1px solid rgba(0,0,0,0.05);
    }
    body.dark-mode .ui-element { background: var(--sheet-dark); box-shadow: 0 4px 20px rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.1); }
    
    #bottom-nav { bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; padding: 8px; }
    #top-right-nav { top: 16px; right: 16px; display: flex; gap: 8px; padding: 4px; }
    
    .nav-btn {
      display: flex; align-items: center; justify-content: center;
      width: 56px; height: 56px; border-radius: 50%; border: none;
      background: transparent; color: var(--text-light); font-size: 24px; cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    body.dark-mode .nav-btn { color: var(--text-dark); }
    .nav-btn:hover { background-color: rgba(0,0,0,0.05); }
    body.dark-mode .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
    .nav-btn.active { background-color: var(--accent-color); color: white; }

    #sos-btn {
        width: 48px; height: 48px; font-size: 20px;
        background: var(--red-color); color: white; animation: pulse-danger 2s infinite;
    }
    @keyframes pulse-danger { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }

    #route-planner-sheet {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;
      background: var(--sheet-light); color: var(--text-light);
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
      transform: translateY(100%); transition: transform 0.4s ease-out;
      padding-bottom: 90px; max-height: 80vh; display: flex; flex-direction: column;
    }
    body.dark-mode #route-planner-sheet { background: var(--sheet-dark); color: var(--text-dark); box-shadow: 0 -5px 30px rgba(0,0,0,0.3); }
    #route-planner-sheet.visible { transform: translateY(0); }
    #sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 999px; margin: 8px auto; cursor: grab; }
    #selected-list { flex-grow: 1; overflow-y: auto; padding: 0 16px; }
    #selected-list li { display: flex; align-items: center; padding: 12px 8px; border-bottom: 1px solid rgba(0,0,0,0.08); cursor: grab; }
    body.dark-mode #selected-list li { border-bottom-color: rgba(255,255,255,0.1); }
    #selected-list li:last-child { border-bottom: none; }
    
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
    }
    .modal-overlay.visible { opacity: 1; pointer-events: auto; }
    .modal-content {
        background: var(--sheet-light); color: var(--text-light);
        border-radius: 16px; padding: 24px; width: 90%; max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    body.dark-mode .modal-content { background: var(--sheet-dark); color: var(--text-dark); }

    .user-marker-icon { position: relative; display: flex; align-items: center; justify-content: center; }
    .user-dot { width: 18px; height: 18px; background: #1d4ed8; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    @keyframes pulse-gps { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(2.5); opacity: 0; } }
    .user-accuracy-circle { position: absolute; border-radius: 50%; background: rgba(59, 130, 246, 0.2); animation: pulse-gps 2s infinite ease-out; }
    .user-chevron { position: absolute; width: 100%; height: 100%; transition: transform 0.5s linear; }

    #toast {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 999px;
        font-size: 14px; z-index: 10001; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none;
    }
    #toast.show { opacity: 1; top: 30px; }

    .leaflet-popup-content-wrapper { border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .leaflet-popup-content { margin: 0; width: 320px !important; }
    .popup-card { padding: 0; font-size: 14px; line-height: 1.5; max-height: 70vh; overflow-y: auto; }
    .swiper-button-prev, .swiper-button-next { color: white !important; }
  </style>
</head>
<body class="light-mode">

  <div id="loader">
    <div class="spinner"></div>
    <span id="loader-text">RadlMap wird geladen...</span>
  </div>

  <div id="map"></div>

  <nav id="bottom-nav" class="ui-element">
    <button id="recenter-btn" title="Mein Standort" class="nav-btn">üìç</button>
    <button id="planner-btn" title="Tourenplaner" class="nav-btn">üó∫Ô∏è</button>
    <button id="group-btn" title="Gruppenfahrt" class="nav-btn">üë•</button>
    <button id="settings-btn" title="Einstellungen" class="nav-btn">‚öôÔ∏è</button>
  </nav>

  <div id="top-right-nav" class="ui-element">
    <a href="assistent.html" title="H√ºtte eintragen" class="nav-btn" style="width:48px; height:48px; background-color: var(--accent-color); color: white;">‚ûï</a>
    <button id="sos-btn" title="SOS Notruf" class="nav-btn">‚ùó</button>
  </div>
  
  <div id="route-planner-sheet">
    <div id="sheet-handle" title="Schlie√üen"></div>
    <div class="px-4 pb-2">
        <h2 class="text-xl font-bold">Tourenplaner</h2>
        <p class="text-sm text-gray-500">Stelle deine Route per Drag & Drop zusammen.</p>
    </div>
    <ul id="selected-list"></ul>
    <div class="p-4 bg-inherit border-t border-gray-200/50">
      <div class="flex gap-2">
        <button onclick="resetRoute()" class="w-1/3 py-3 text-sm font-semibold bg-gray-200 text-gray-700 rounded-xl">L√∂schen</button>
        <button id="start-route-btn" onclick="startRouteFromPlanner()" class="w-2/3 py-3 text-sm font-semibold bg-green-500 text-white rounded-xl">‚ñ∂Ô∏è Route starten</button>
      </div>
    </div>
  </div>

  <div id="group-modal" class="modal-overlay">
      <div class="modal-content">
          <h2 class="text-xl font-bold mb-4">Gruppenfahrt</h2>
          <p id="room-status-text" class="text-sm mb-4"></p>
          <div id="join-room-section">
              <input id="room-id-input" type="text" placeholder="Raum-ID eingeben..." class="w-full border p-2 rounded mb-2">
              <button id="join-room-btn" class="w-full py-2 bg-blue-500 text-white font-semibold rounded">Beitreten / Erstellen</button>
          </div>
          <button id="leave-room-btn" class="w-full py-2 bg-red-500 text-white font-semibold rounded hidden">Raum verlassen</button>
          <button onclick="closeModal('group-modal')" class="w-full mt-4 py-2 text-sm text-gray-600">Schlie√üen</button>
      </div>
  </div>

  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Einstellungen</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Dein Name</label>
          <div class="flex gap-2">
            <input id="username-input" type="text" class="w-full border p-2 rounded">
            <button id="save-username-btn" class="px-4 bg-blue-500 text-white rounded">üíæ</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Sprachausgabe</label>
          <select id="voice-lang-select" class="w-full border p-2 rounded"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Design</label>
          <button id="theme-btn-modal" class="w-full py-2 border rounded"></button>
        </div>
      </div>
      <button onclick="closeModal('settings-modal')" class="w-full mt-6 py-2 text-sm text-gray-600">Schlie√üen</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ========================================================================
    //  üö≤ RADLMAP TOURPLANER v5.1 - INITIALIZATION & GLOBALS
    // ========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
        authDomain: "eierhuettentour.firebaseapp.com",
        projectId: "eierhuettentour",
    };
    const ORS_API_KEY = "5b3af8b88e1a4f000179979725f05d58d98342468285703f925b4119"; // Bitte durch eigenen Key ersetzen

    // Globale Variablen
    let map, cluster, userMarker, currentTileLayer, routeLine;
    let isDarkTheme = false, followUser = true, navActiveFlag = false;
    let allHuts = new Map(), selectedHuts = [], groupMarkers = {};
    let routeCoords = [], routeSteps = [];
    let deviceHeading = 0, roomId = null, hutListener = null;
    let alias = localStorage.aliasId || `user_${Math.random().toString(36).substr(2, 6)}`;
    localStorage.aliasId = alias;
    
    // DOM Elemente
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const plannerSheet = document.getElementById('route-planner-sheet');
    const selectedList = document.getElementById('selected-list');
    const startRouteBtn = document.getElementById('start-route-btn');

    // ========================================================================
    //  üöÄ APP INITIALIZATION
    // ========================================================================
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        initMap();
        startGpsTracking();
        startCompassTracking();
        await initHuettenListener();
        
        setupEventListeners();
        
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 500);

      } catch (err) {
        console.error("Initialization failed:", err);
        loaderText.textContent = `Fehler: ${err.message}. Bitte Seite neu laden.`;
      }
    });

    function setupEventListeners() {
        document.getElementById('recenter-btn').onclick = () => setFollowUser(true);
        document.getElementById('planner-btn').onclick = togglePlannerSheet;
        document.getElementById('group-btn').onclick = () => openModal('group-modal');
        document.getElementById('settings-btn').onclick = () => openModal('settings-modal');
        document.getElementById('sos-btn').onclick = sendSOS;
        document.getElementById('sheet-handle').onclick = togglePlannerSheet;
        
        document.getElementById('theme-btn-modal').onclick = () => { isDarkTheme = !isDarkTheme; updateMapTheme(); };
        document.getElementById('username-input').value = localStorage.username || '';
        document.getElementById('save-username-btn').onclick = () => {
            localStorage.username = document.getElementById('username-input').value;
            showToast("Name gespeichert!", "success");
        };
        populateVoiceDropdown();

        setupGroupModal();

        map.on('popupopen', (e) => {
            const swiperEl = e.popup.getElement()?.querySelector('.popup-swiper');
            if (swiperEl) new Swiper(swiperEl, { loop: true, navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' } });
        });
        
        let draggedItem = null;
        selectedList.addEventListener('dragstart', e => { draggedItem = e.target.closest('li'); });
        selectedList.addEventListener('dragover', e => {
            e.preventDefault();
            const target = e.target.closest('li');
            if (target && target !== draggedItem) {
                const rect = target.getBoundingClientRect();
                const isAfter = e.clientY > rect.top + rect.height / 2;
                target.parentNode.insertBefore(draggedItem, isAfter ? target.nextSibling : target);
            }
        });
        selectedList.addEventListener('drop', e => {
            e.preventDefault();
            const newOrder = Array.from(selectedList.querySelectorAll('li')).map(li => li.dataset.id);
            selectedHuts.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
            updateSelectedList();
        });
    }

    // ========================================================================
    //  üó∫Ô∏è MAP & MARKER SETUP
    // ========================================================================
    
    function initMap() {
      map = L.map("map", { center: [49.8, 10.5], zoom: 7, zoomControl: false });
      cluster = L.markerClusterGroup({ maxClusterRadius: 40, disableClusteringAtZoom: 15 });
      map.addLayer(cluster);
      isDarkTheme = localStorage.getItem("mapTheme") === "dark";
      updateMapTheme();
      map.on('dragstart zoomstart mousedown', () => { if (followUser) setFollowUser(false); });
    }
    
    function createUserMarker(latlng) {
        const icon = L.divIcon({
            className: 'user-marker-icon',
            html: `
                <div class="user-accuracy-circle"></div>
                <div class="user-chevron">
                    <svg viewBox="0 0 24 24" fill="#1d4ed8" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));">
                        <path d="M12 2L21 21L12 17L3 21L12 2Z"/>
                    </svg>
                </div>
                <div class="user-dot"></div>`,
            iconSize: [48, 48], iconAnchor: [24, 24]
        });
        userMarker = L.marker(latlng, { icon: icon, zIndexOffset: 1000, interactive: false }).addTo(map);
    }
    
    function updateUserPosition(pos) {
        if (!map) return;
        const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);

        if (!userMarker) {
            createUserMarker(latlng);
            map.flyTo(latlng, 16);
        }

        let displayPosition = latlng;
        let displayHeading = deviceHeading;

        if (navActiveFlag && routeCoords.length > 1) {
            displayPosition = snapToRoute(latlng);
            displayHeading = getRouteBearingAt(displayPosition, routeCoords);
        }
        
        userMarker.setLatLng(displayPosition);
        
        const chevron = userMarker.getElement()?.querySelector('.user-chevron');
        if (chevron) {
            chevron.style.transform = `rotate(${displayHeading}deg)`;
        }

        if (followUser) {
            map.panTo(displayPosition, { animate: true, duration: 1, noMoveStart: true });
        }
        if (roomId) updateGroupPosition(displayPosition);
    }

    function updateMapTheme() {
        if (currentTileLayer) map.removeLayer(currentTileLayer);
        const theme = isDarkTheme ? 'dark' : 'light';
        const url = isDarkTheme ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        currentTileLayer = L.tileLayer(url, { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }).addTo(map);
        document.body.className = `${theme}-mode`;
        document.getElementById('theme-btn-modal').textContent = isDarkTheme ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        localStorage.setItem("mapTheme", theme);
    }

    // ========================================================================
    //  üì• DATA & POPUPS
    // ========================================================================

    async function initHuettenListener() {
        if (hutListener) hutListener();
        loaderText.textContent = "Lade H√ºtten...";
        
        hutListener = db.collection("eierhuetten").where("status", "==", "angenommen").onSnapshot(snapshot => {
            const seenIds = new Set();
            snapshot.forEach(doc => {
                const hutData = { id: doc.id, ...doc.data() };
                if (!hutData.location) return;
                seenIds.add(doc.id);

                if (allHuts.has(doc.id)) {
                    const { marker } = allHuts.get(doc.id);
                    marker.setPopupContent(() => createPopupHTML(hutData));
                    allHuts.set(doc.id, { data: hutData, marker });
                } else {
                    const marker = createHutMarker(hutData);
                    allHuts.set(doc.id, { data: hutData, marker });
                    cluster.addLayer(marker);
                }
            });

            allHuts.forEach((value, id) => {
                if (!seenIds.has(id)) {
                    cluster.removeLayer(value.marker);
                    allHuts.delete(id);
                }
            });
        });
    }

    function createHutMarker(hut) {
        const icon = L.icon({ iconUrl: "https://radlmap.net/img/huetten_icon.svg", iconSize: [30, 40], iconAnchor: [15, 40], popupAnchor: [0, -40] });
        const marker = L.marker([hut.location.latitude, hut.location.longitude], { icon });
        marker.bindPopup(() => createPopupHTML(hut), { minWidth: 320, closeButton: false });
        marker.on('click', () => { if (map.getZoom() < 14) map.flyTo([hut.location.latitude, hut.location.longitude], 15); });
        return marker;
    }

    function createPopupHTML(hut) {
      const isSelected = selectedHuts.some(h => h.id === hut.id);
      const images = (hut.fotos || []).map(f => typeof f === 'string' ? f : f.url).filter(Boolean);
      
      const slideshowHTML = images.length > 0
        ? `<div class="swiper popup-swiper relative h-48 bg-gray-200">
             <div class="swiper-wrapper">${images.map(url => `<div class="swiper-slide"><img src="${url}" class="w-full h-full object-cover" loading="lazy"></div>`).join('')}</div>
             <div class="swiper-button-prev"></div><div class="swiper-button-next"></div>
           </div>`
        : `<img src="https://radlmap.net/img/noimg/1.jpg" class="w-full h-48 object-cover">`;

      return `
        <div class="popup-card">
          ${slideshowHTML}
          <div class="p-4">
            <h3 class="text-lg font-bold">${hut.name}</h3>
            <p class="text-sm text-gray-500 mb-2">${hut.typ}</p>
            <p class="text-sm text-gray-700 mb-4 max-h-20 overflow-y-auto">${stripHtml(hut.beschreibung) || 'Keine Beschreibung.'}</p>
            <button id="toggle-btn-${hut.id}" onclick="toggleHutSelection('${hut.id}')"
              class="w-full py-2 font-semibold rounded-lg text-white ${isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}">
              ${isSelected ? '‚ùå Von Route entfernen' : '‚úÖ Zur Route hinzuf√ºgen'}
            </button>
          </div>
        </div>
      `;
    }

    // ========================================================================
    //  üìç GPS & COMPASS
    // ========================================================================

    function startGpsTracking() {
      loaderText.textContent = "Suche GPS-Signal...";
      if (!navigator.geolocation) { return alert("GPS wird von diesem Browser nicht unterst√ºtzt."); }
      navigator.geolocation.watchPosition(updateUserPosition, 
        (err) => { console.error("GPS Error:", err); showToast("GPS-Signal verloren.", "error"); },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function startCompassTracking() {
        const requestPermission = () => {
             DeviceOrientationEvent.requestPermission().then(state => {
                if (state === 'granted') window.addEventListener('deviceorientationabsolute', handleOrientation);
             }).catch(console.error);
        };
        if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.body.addEventListener('click', requestPermission, { once: true });
            showToast("Tippe auf den Bildschirm, um den Kompass zu aktivieren.");
        } else {
            window.addEventListener('deviceorientationabsolute', handleOrientation);
        }
    }

    function handleOrientation(event) {
        if (event.alpha !== null) deviceHeading = 360 - event.alpha;
    }

    // ========================================================================
    //  ‚ÜîÔ∏è ROUTING & NAVIGATION
    // ========================================================================
    
    async function startRouteFromPlanner() {
      if (selectedHuts.length === 0) return showToast("Bitte f√ºge zuerst Stopps hinzu.", "warn");
      startRouteBtn.disabled = true;
      startRouteBtn.innerHTML = ' Lade Route...';
      try {
        const startPos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p => res(p.coords), rej));
        const coords = [[startPos.longitude, startPos.latitude], ...selectedHuts.map(h => [h.location.longitude, h.location.latitude])];
        await fetchAndDrawRoute(coords);
        navActiveFlag = true;
        showToast("Navigation gestartet!", "success");
        setFollowUser(true);
        plannerSheet.classList.remove('visible');
        startRouteBtn.textContent = 'üõë Route stoppen';
        startRouteBtn.onclick = stopNavigation;
      } catch (err) {
        console.error("Route Start Error:", err);
        showToast("Route konnte nicht berechnet werden.", "error");
        stopNavigation();
      } finally {
        startRouteBtn.disabled = false;
      }
    }
    
    async function fetchAndDrawRoute(coordinates) {
        const res = await fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
            method: "POST",
            headers: { "Authorization": ORS_API_KEY, "Content-Type": "application/json" },
            body: JSON.stringify({ coordinates, instructions: true })
        });
        if (!res.ok) throw new Error(`ORS API Error: ${res.statusText}`);
        const data = await res.json();
        const feature = data.features?.[0];
        if (!feature) throw new Error("Keine Route gefunden.");
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.geoJSON(feature, { style: { color: var(--blue-color), weight: 6, opacity: 0.8 } }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        routeCoords = feature.geometry.coordinates.map(p => L.latLng(p[1], p[0]));
        routeSteps = feature.properties.segments[0].steps;
    }

    function stopNavigation() {
      if (routeLine) map.removeLayer(routeLine);
      navActiveFlag = false;
      routeCoords = []; routeSteps = [];
      startRouteBtn.textContent = '‚ñ∂Ô∏è Route starten';
      startRouteBtn.onclick = startRouteFromPlanner;
      showToast("Navigation gestoppt.");
    }

    function snapToRoute(latlng) { return (routeLine) ? L.GeometryUtil.closest(map, routeLine, latlng) : latlng; }
    
    function getRouteBearingAt(latlng, routePoints) {
        let closestSegment = null, minDistance = Infinity;
        for (let i = 0; i < routePoints.length - 1; i++) {
            const distance = L.GeometryUtil.distanceSegment(map, latlng, routePoints[i], routePoints[i + 1]);
            if (distance < minDistance) {
                minDistance = distance;
                closestSegment = [routePoints[i], routePoints[i + 1]];
            }
        }
        return closestSegment ? L.GeometryUtil.bearing(closestSegment[0], closestSegment[1]) : deviceHeading;
    }

    // ========================================================================
    //  ‚öôÔ∏è UI & APP LOGIC
    // ========================================================================
    
    function togglePlannerSheet() { plannerSheet.classList.toggle('visible'); }
    function openModal(modalId) { document.getElementById(modalId).classList.add('visible'); }
    function closeModal(modalId) { document.getElementById(modalId).classList.remove('visible'); }

    function toggleHutSelection(hutId) {
        const hutData = allHuts.get(hutId)?.data;
        if (!hutData) return;
        const index = selectedHuts.findIndex(h => h.id === hutId);
        if (index > -1) { selectedHuts.splice(index, 1); } else { selectedHuts.push(hutData); }
        updateSelectedList();
        const btn = document.getElementById(`toggle-btn-${hutId}`);
        if (btn) {
          const isSelected = index === -1;
          btn.textContent = isSelected ? '‚ùå Von Route entfernen' : '‚úÖ Zur Route hinzuf√ºgen';
          btn.classList.toggle('bg-red-500', isSelected); btn.classList.toggle('hover:bg-red-600', isSelected);
          btn.classList.toggle('bg-green-500', !isSelected); btn.classList.toggle('hover:bg-green-600', !isSelected);
        }
    }

    function updateSelectedList() {
      selectedList.innerHTML = selectedHuts.length === 0 
        ? `<li class="italic text-gray-500 justify-center">F√ºge Stopps von der Karte hinzu.</li>`
        : selectedHuts.map((hut, index) => `
            <li data-id="${hut.id}" draggable="true">
              <span class="drag-handle">‚†ø</span>
              <span class="font-semibold flex-grow">${index + 1}. ${hut.name}</span>
              <button onclick="removeHutFromPlanner('${hut.id}')" class="px-2 text-red-500">üóëÔ∏è</button>
            </li>`).join('');
    }
    
    function removeHutFromPlanner(hutId) { toggleHutSelection(hutId); }

    function setFollowUser(follow) {
      followUser = follow;
      document.getElementById('recenter-btn').classList.toggle('active', follow);
      if (follow && userMarker) map.flyTo(userMarker.getLatLng(), Math.max(map.getZoom(), 16), { animate: true, duration: 1 });
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }
    
    // ========================================================================
    //  üë• GROUP & üö® SOS FUNCTIONS
    // ========================================================================
    function setupGroupModal() {
        document.getElementById('join-room-btn').onclick = joinRoom;
        document.getElementById('leave-room-btn').onclick = leaveRoom;
        updateRoomUI();
    }
    
    function joinRoom() {
        const id = document.getElementById('room-id-input').value.trim();
        if (!id) return;
        roomId = id;
        localStorage.lastRoom = id;
        listenToRoom();
        updateRoomUI();
        showToast(`Raum "${id}" beigetreten.`);
    }
    
    function leaveRoom() {
        roomId = null;
        localStorage.removeItem('lastRoom');
        Object.values(groupMarkers).forEach(m => map.removeLayer(m));
        groupMarkers = {};
        updateRoomUI();
        showToast("Raum verlassen.");
    }
    
    function updateRoomUI() {
        const statusText = document.getElementById('room-status-text');
        const joinSection = document.getElementById('join-room-section');
        const leaveBtn = document.getElementById('leave-room-btn');
        if (roomId) {
            statusText.textContent = `Du bist in Raum: ${roomId}`;
            joinSection.classList.add('hidden');
            leaveBtn.classList.remove('hidden');
        } else {
            statusText.textContent = 'Teile deine Position live mit Freunden in einem Raum.';
            joinSection.classList.remove('hidden');
            leaveBtn.classList.add('hidden');
        }
    }
    
    function updateGroupPosition(latlng) {
        if (!roomId || !latlng) return;
        db.collection("live").doc(alias).set({
            name: localStorage.username || alias,
            lat: latlng.lat, lng: latlng.lng,
            room: roomId, ts: Date.now()
        });
    }

    function listenToRoom() {
        if (!roomId) return;
        db.collection("live").where("room", "==", roomId).onSnapshot(snap => {
            const now = Date.now();
            snap.forEach(doc => {
                if (doc.id === alias) return;
                const data = doc.data();
                if (now - (data.ts || 0) > 30000) {
                    if (groupMarkers[doc.id]) map.removeLayer(groupMarkers[doc.id]);
                    delete groupMarkers[doc.id];
                    return;
                }
                const icon = L.divIcon({ className: '', html: `<div class="text-center">üë•<br><span class="text-xs font-semibold bg-white/70 px-1 rounded">${data.name || ''}</span></div>`});
                if (groupMarkers[doc.id]) {
                    groupMarkers[doc.id].setLatLng([data.lat, data.lng]);
                } else {
                    groupMarkers[doc.id] = L.marker([data.lat, data.lng], { icon }).addTo(map);
                }
            });
        });
    }

    async function sendSOS() {
        if (!confirm("NOTRUF: M√∂chten Sie wirklich Ihren Standort per WhatsApp teilen?")) return;
        try {
            const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));
            const { latitude, longitude } = pos.coords;
            const msg = `üö® HILFE! Ich brauche Unterst√ºtzung. Mein Standort ist: https://www.google.com/maps?q=${latitude},${longitude}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
        } catch (err) {
            alert("Standort konnte nicht ermittelt werden. Bitte manuell teilen.");
        }
    }
    
    // ========================================================================
    //  üó£Ô∏è VOICE & LANGUAGE
    // ========================================================================
    function populateVoiceDropdown() {
      const select = document.getElementById("voice-lang-select");
      const voices = speechSynthesis.getVoices();
      if (!voices.length && 'speechSynthesis' in window) return setTimeout(populateVoiceDropdown, 100);
      const allowedLangs = { "de": "üá©üá™ Deutsch", "en": "üá¨üáß Englisch", "fr": "üá´üá∑ Franz√∂sisch", "it": "üáÆüáπ Italienisch", "es": "üá™üá∏ Spanisch" };
      select.innerHTML = '';
      voices.forEach(v => {
        const shortLang = v.lang.slice(0, 2);
        if (allowedLangs[shortLang] && ![...select.options].some(o => o.value.slice(0,2) === shortLang)) {
          select.add(new Option(allowedLangs[shortLang], v.lang));
        }
      });
      select.value = localStorage.lang || "de-DE";
      select.onchange = () => { localStorage.lang = select.value; showToast("Sprache ge√§ndert."); };
    }
    
    // Make functions globally accessible
    window.toggleHutSelection = toggleHutSelection;
    window.removeHutFromPlanner = removeHutFromPlanner;
    window.resetRoute = () => { stopNavigation(); selectedHuts = []; updateSelectedList(); };
    window.startRouteFromPlanner = startRouteFromPlanner;
    window.stopNavigation = stopNavigation;
    window.closeModal = closeModal;
  </script>
</body>
</html>
