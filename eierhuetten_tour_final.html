<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eierh√ºtten Navigation ‚Äì Vollversion</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#000; color:#fff; }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:0; }
    .toolbar {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      display:flex; gap:10px; background:rgba(0,0,0,0.7);
      padding:10px 15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.4);
      z-index:1001;
    }
    .toolbar button, .toolbar select {
      background:#10b981; color:#fff; border:none; border-radius:8px;
      padding:10px 14px; font-size:1rem; cursor:pointer;
      transition:background .2s;
    }
    .toolbar button:hover, .toolbar select:hover { background:#0e9e6e; }
    .toolbar button.start { background:#ff5722; flex:1.5; font-weight:bold; }
    .toolbar button.start:hover { background:#e64a19; }
    #compass {
      position:fixed; top:10px; right:10px; font-size:28px;
      background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;
      z-index:1001; transform-origin:center;
    }
    #dashboard {
      position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); padding:12px 16px; border-radius:12px;
      font-size:1rem; text-align:center; z-index:1001; display:none;
    }
    body.dark { background:#181a1b; }
    body.dark .toolbar { background:rgba(20,20,20,0.9); }
    body.dark .toolbar button, body.dark .toolbar select { background:#0e7c5b; }
    body.dark .toolbar button:hover, body.dark .toolbar select:hover { background:#0b5f46; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="compass">üß≠</div>
  <div id="dashboard"></div>

  <div class="toolbar">
    <button onclick="toggleDark()">üåô</button>
    <button onclick="centerMap()">üìç</button>
    <select id="routeMode" onchange="recalculateRoute()">
      <option value="auto">Optimiert</option>
      <option value="manual">Manuell</option>
    </select>
    <button class="start" onclick="startRoute()">‚ñ∂Ô∏è Start</button>
    <button onclick="resetRoute()">üóë</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // --- Konfiguration ---
    const darkTiles   = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
    const lightTiles  = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const orsApiKey   = "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87";
    const firebaseConfig = {
      apiKey: orsApiKey,
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    };

    // --- Initialisierung ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let darkMode = false, voiceEnabled = true;
    let map = L.map("map").setView([51.5,10.5],15);
    let baseLayer = L.tileLayer(darkTiles, { maxZoom:19 }).addTo(map);
    let cluster = L.markerClusterGroup().addTo(map);
    let userMarker = null, routingControl = null;
    let allHuts = [], selectedHuts = [], navInterval = null;
    let lastCoords = null, restoreAsked = false;

    // --- DOM-Elemente ---
    const compassEl   = document.getElementById("compass");
    const dashEl      = document.getElementById("dashboard");
    const modeSelect  = document.getElementById("routeMode");
    const startBtn    = document.querySelector(".toolbar .start");

    // --- Standort & Kompass ---
    navigator.geolocation.watchPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      if(!userMarker){
        userMarker = L.marker(latlng).addTo(map);
        map.setView(latlng,15);
        loadHuts();
        tryRestore();
      } else {
        userMarker.setLatLng(latlng);
      }
    }, ()=>{}, { enableHighAccuracy:true });

    window.addEventListener("deviceorientationabsolute" in window?"deviceorientationabsolute":"deviceorientation",
      e => compassEl.style.transform = `rotate(${- (e.alpha||0)}deg)`
    );

    // --- Dark Mode ---
    function toggleDark(){
      darkMode = !darkMode;
      document.body.classList.toggle("dark",darkMode);
      map.removeLayer(baseLayer);
      baseLayer = L.tileLayer(darkMode? darkTiles:lightTiles, { maxZoom:19 }).addTo(map);
      cluster.addTo(map);
      if(routingControl) routingControl.addTo(map);
    }

    // --- Firestore H√ºtten laden ---
    function loadHuts(){
      db.collection("eierhuetten").where("status","==","angenommen")
        .onSnapshot(snap=>{
          allHuts = []; cluster.clearLayers();
          snap.forEach(doc => {
            const d = doc.data();
            if(!d.location) return;
            const h = { id:doc.id, name:d.name, lat:d.location.latitude, lng:d.location.longitude };
            allHuts.push(h);
            const m = L.marker([h.lat,h.lng]).bindPopup(
              `<b>${h.name}</b><br>
               <button onclick="toggleHut('${h.id}')">
                 ${selectedHuts.includes(h.id)? '‚ùå Entfernen':'‚úÖ Hinzuf√ºgen'}
               </button>`
            );
            cluster.addLayer(m);
          });
          tryRestore();
        });
    }

    // --- Ausw√§hlen / Abw√§hlen ---
    function toggleHut(id){
      const idx = selectedHuts.indexOf(id);
      if(idx>=0) selectedHuts.splice(idx,1);
      else selectedHuts.push(id);
      localStorage.setItem("savedRoute",JSON.stringify(selectedHuts));
      recalc();
    }

    // --- Route wiederherstellen ---
    function tryRestore(){
      if(restoreAsked || !userMarker || !allHuts.length) return;
      restoreAsked = true;
      const saved = localStorage.getItem("savedRoute");
      if(saved && confirm("üíæ Route gefunden. Wiederherstellen?")){
        selectedHuts = JSON.parse(saved);
        recalc();
      }
    }

    // --- Route berechnen & zeichnen ---
    function recalc(){
      if(routingControl) map.removeLayer(routingControl);
      if(!selectedHuts.length) return dashEl.style.display="none";
      const start = userMarker.getLatLng();
      const coords = selectedHuts.map(id=>{
        const h = allHuts.find(x=>x.id===id);
        return h?[h.lng,h.lat]:null;
      }).filter(Boolean);
      const arr = [[start.lng,start.lat], ...coords];
      if(modeSelect.value==="manual"){
        draw(arr.map(c=>[c[1],c[0]]));
      } else {
        fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
          method:"POST",
          headers:{ "Authorization": orsApiKey, "Content-Type":"application/json"},
          body: JSON.stringify({ coordinates: arr })
        })
        .then(r=>r.json())
        .then(j=> draw(j.features[0].geometry.coordinates.map(p=>[p[1],p[0]])))
        .catch(()=>alert("Routing fehlgeschlagen"));
      }
    }
    function draw(path){
      if(JSON.stringify(path)===JSON.stringify(lastCoords)) return;
      lastCoords = path;
      routingControl = L.polyline(path, { color:"#10b981", weight:5 }).addTo(map);
    }

    // --- Navigation starten/stoppen ---
    function startRoute(){
      if(navInterval) return stopRoute();
      if(!routingControl) return;
      startBtn.innerText="üü• Beenden";  
      let idx=1;
      dashEl.style.display="block";
      navInterval = setInterval(()=> {
        const pos = userMarker.getLatLng();
        const next = routingControl.getLatLngs()[idx];
        const d = L.latLng(next).distanceTo(pos);
        // Richtung berechnen
        const prev = L.latLng(routingControl.getLatLngs()[idx-1]);
        const dir1 = Math.atan2(next.lat-prev.lat,next.lng-prev.lng);
        const dir2 = Math.atan2(pos.lat-prev.lat,pos.lng-prev.lng);
        const diff = ((dir1-dir2)*180/Math.PI+360)%360;
        let turn="geradeaus";
        if(diff>45&&diff<135) turn="rechts abbiegen";
        else if(diff>225&&diff<315) turn="links abbiegen";
        // Dashboard aktualisieren
        dashEl.innerHTML = `üö¥ ${(d/1000).toFixed(2)} km ¬∑ ‚è± ${Math.round(d/250)} Min ¬∑ üß≠ ${turn}`;
        // Sprachansage
        if(voiceEnabled){
          const msg = new SpeechSynthesisUtterance(`In ${Math.round(d)} Metern ${turn}`);
          msg.lang="de-DE"; speechSynthesis.speak(msg);
        }
        // N√§chster Punkt
        if(d<30) idx++;
        if(idx>=routingControl.getLatLngs().length) stopRoute();
      },5000);
    }
    function stopRoute(){
      clearInterval(navInterval); navInterval=null;
      startBtn.innerText="‚ñ∂Ô∏è Start"; dashEl.style.display="none";
      speak("Navigation beendet");
    }

    // --- Helpers ---
    function recenter(){ map.setView(userMarker.getLatLng(),15); }
    function centerMap(){ recenter(); }
    modeSelect.addEventListener("change", recalc);
    function resetRoute(){ selectedHuts=[]; localStorage.removeItem("savedRoute"); if(routingControl) map.removeLayer(routingControl); dashEl.style.display="none"; }
    function speak(t){ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(t); u.lang="de-DE"; speechSynthesis.speak(u);} }
  </script>
</body>
</html>
