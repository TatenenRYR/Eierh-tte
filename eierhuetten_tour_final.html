<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierh√ºtten Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
    #loader {
      position: fixed; inset: 0;
      background: #fff; display: flex;
      align-items: center; justify-content: center;
      font-size: 1.2rem; z-index: 9999;
    }
    body.dark { background: #1e1e1e; color: #eee; }
    body.dark #loader { background: #1e1e1e; color: #ccc; }
    .bottom-toolbar {
      position: fixed; bottom: 0; left: 0; right: 0;
      display: flex; gap: 6px;
      background: rgba(255,255,255,0.95);
      padding: 10px; z-index: 900;
    }
    .bottom-toolbar button, .bottom-toolbar select {
      flex: 1; font-size: 1rem; padding: 8px;
      background: #10b981; color: #fff;
      border: none; border-radius: 8px; cursor: pointer;
    }
    body.dark .bottom-toolbar {
      background: rgba(30,30,30,0.95);
    }
    body.dark .bottom-toolbar button, body.dark .bottom-toolbar select {
      background: #0e7c5b;
    }
    #followBtn {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%);
      background: orange; color: #fff;
      padding: 10px 20px; border-radius: 8px;
      z-index: 950; display: none;
    }
    #toastMsg {
      position: fixed; top: 70px; left: 50%;
      transform: translateX(-50%);
      background: #333; color: #fff;
      padding: 10px 20px; border-radius: 8px;
      z-index: 9999; display: none;
    }
    #arrowCanvas {
      position: fixed; top: 50%; left: 50%;
      width: 80px; height: 80px;
      transform: translate(-50%, -50%);
      z-index: 1002; pointer-events: none; display: none;
    }
    #compassEl {
      position: fixed; top: 10px; right: 10px;
      font-size: 28px;
      background: rgba(0,0,0,0.6);
      padding: 10px; border-radius: 50%;
      z-index: 1001;
    }
  </style>
</head>
<body>
  <div id="loader">‚è≥ Standort & H√ºtten werden geladen‚Ä¶</div>
  <div id="map"></div>
  <canvas id="arrowCanvas" width="80" height="80"></canvas>
  <div id="compassEl">üß≠</div>
  <div id="followBtn" onclick="followUser()">üìç Standort folgen</div>
  <div class="bottom-toolbar">
    <button onclick="toggleDarkMode()">üåô Dark Mode</button>
    <button onclick="toggleVoice()">üîä Sprache</button>
    <select id="routeMode" onchange="recalculateRoute()">
      <option value="auto">üîÑ Optimiert</option>
      <option value="manual">‚û°Ô∏è Manuell</option>
    </select>
    <button onclick="startRoute()">‚ñ∂Ô∏è Start</button>
    <button onclick="resetRoute()">üóë L√∂schen</button>
  </div>
  <div id="toastMsg"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let map = L.map("map").setView([51.5, 10.5], 15);
let darkMode = localStorage.getItem("darkMode") === "1";
let userMarker = null, lastUserPos = null, following = true;
let selectedHuts = [], allHuts = [];
let clusterGroup = L.markerClusterGroup().addTo(map);

const tileLight = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 });
const tileDark = L.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png", { maxZoom: 19 });
darkMode ? tileDark.addTo(map) : tileLight.addTo(map);
if (darkMode) document.body.classList.add("dark");

navigator.geolocation.watchPosition(pos => {
  const latlng = [pos.coords.latitude, pos.coords.longitude];
  lastUserPos = L.latLng(latlng);
  if (!userMarker) {
    userMarker = L.marker(latlng).addTo(map);
    map.setView(latlng, 16);
    document.getElementById("loader").style.display = "none";
  } else {
    userMarker.setLatLng(latlng);
    if (following) map.setView(latlng);
  }
}, () => {
  document.getElementById("loader").innerText = "‚ö†Ô∏è Standort nicht verf√ºgbar";
}, { enableHighAccuracy: true });

map.on("movestart", () => {
  if (following) {
    following = false;
    document.getElementById("followBtn").style.display = "block";
  }
});
function followUser() {
  if (lastUserPos) map.setView(lastUserPos, 16);
  following = true;
  document.getElementById("followBtn").style.display = "none";
}

// Kompass
window.addEventListener("deviceorientation", e => {
  if (e.alpha != null) {
    document.getElementById("compassEl").style.transform = `rotate(${-e.alpha}deg)`;
  }
});

// H√ºtten laden
db.collection("eierhuetten").onSnapshot(snap => {
  allHuts = [];
  clusterGroup.clearLayers();
  snap.forEach(doc => {
    const d = doc.data();
    if (!d.location || d.status !== "angenommen") return;
    const h = { id: doc.id, name: d.name, lat: d.location.latitude, lng: d.location.longitude };
    allHuts.push(h);
    const m = L.marker([h.lat, h.lng]).bindPopup(() => {
      const added = selectedHuts.includes(h.id);
      return `<b>${h.name}</b><br><button onclick="toggleSelection('${h.id}')">${added ? "‚ùå Entfernen" : "‚úÖ Hinzuf√ºgen"}</button>`;
    });
    clusterGroup.addLayer(m);
  });
});

let voiceEnabled = true;
let routingControl = null;
let navTimer = null;
let currentStep = 1;

function toggleDarkMode() {
  darkMode = !darkMode;
  document.body.classList.toggle("dark", darkMode);
  localStorage.setItem("darkMode", darkMode ? "1" : "0");
  map.eachLayer(l => map.removeLayer(l));
  (darkMode ? tileDark : tileLight).addTo(map);
  clusterGroup.addTo(map);
  showToast(darkMode ? "üåô Dunkelmodus aktiv" : "‚òÄÔ∏è Hellmodus aktiv");
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  showToast(voiceEnabled ? "üîä Sprache aktiviert" : "üîá Sprache deaktiviert");
}

function showToast(msg) {
  const toast = document.getElementById("toastMsg");
  toast.innerText = msg;
  toast.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.style.display = "none", 3000);
}
let toastTimer;

function toggleSelection(id) {
  const i = selectedHuts.indexOf(id);
  if (i >= 0) {
    selectedHuts.splice(i, 1);
    showToast("‚ùå H√ºtte entfernt");
  } else {
    selectedHuts.push(id);
    showToast("‚úÖ H√ºtte hinzugef√ºgt");
  }
  recalculateRoute();
}

function recalculateRoute() {
  if (!userMarker || selectedHuts.length === 0) return;

  const start = userMarker.getLatLng();
  const toCoords = selectedHuts
    .map(id => {
      const h = allHuts.find(x => x.id === id);
      return h ? [h.lng, h.lat] : null;
    })
    .filter(Boolean);

  fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
    method: "POST",
    headers: {
      "Authorization": "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ coordinates: [[start.lng, start.lat], ...toCoords] })
  })
    .then(res => res.json())
    .then(data => {
      const rc = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      if (routingControl) map.removeLayer(routingControl);
      routingControl = L.polyline(rc, {
        color: "orange",
        weight: 5
      }).addTo(map);
    })
    .catch(() => showToast("‚ö†Ô∏è Routing fehlgeschlagen"));
}

function drawArrow(angle) {
  const canvas = document.getElementById("arrowCanvas");
  const ctx = canvas.getContext("2d");
  canvas.style.display = "block";
  ctx.clearRect(0, 0, 80, 80);
  ctx.save();
  ctx.translate(40, 40);
  ctx.rotate(angle * Math.PI / 180);
  ctx.beginPath();
  ctx.moveTo(0, -25);
  ctx.lineTo(12, 15);
  ctx.lineTo(0, 5);
  ctx.lineTo(-12, 15);
  ctx.closePath();
  ctx.fillStyle = "orange";
  ctx.fill();
  ctx.restore();
}

function startRoute() {
  if (!userMarker || selectedHuts.length === 0) {
    showToast("‚ö†Ô∏è Bitte H√ºtte ausw√§hlen");
    return;
  }

  const coords = selectedHuts.map(id => {
    const h = allHuts.find(x => x.id === id);
    return h ? [h.lng, h.lat] : null;
  }).filter(Boolean);
  coords.unshift([userMarker.getLatLng().lng, userMarker.getLatLng().lat]);

  fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
    method: "POST",
    headers: {
      "Authorization": "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ coordinates: coords })
  })
    .then(res => res.json())
    .then(data => {
      const pts = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      if (routingControl) map.removeLayer(routingControl);
      routingControl = L.polyline(pts, { color: "orange", weight: 5 }).addTo(map);
      runNavigation(pts);
    });
}

function runNavigation(path) {
  currentStep = 1;
  if (voiceEnabled) {
    const msg = new SpeechSynthesisUtterance("Navigation wird gestartet. Viel Spa√ü!");
    msg.lang = "de-DE";
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  }

  navTimer = setInterval(() => {
    if (!userMarker || currentStep >= path.length) return;
    const pos = userMarker.getLatLng();
    const next = L.latLng(path[currentStep]);
    const dist = pos.distanceTo(next);
    const angle = Math.atan2(next.lat - pos.lat, next.lng - pos.lng) * 180 / Math.PI;
    drawArrow(angle);

    if (dist < 30 && currentStep < path.length - 1) {
      currentStep++;
      showToast("‚úÖ N√§chster Streckenpunkt");
    }
  }, 4000);
}

function resetRoute() {
  if (navTimer) clearInterval(navTimer);
  if (routingControl) map.removeLayer(routingControl);
  routingControl = null;
  document.getElementById("arrowCanvas").style.display = "none";
  if (lastUserPos) map.setView(lastUserPos, 15);
  showToast("üõë Navigation beendet");
}
</script>
</body>
</html>
