<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EierhÃ¼tten Navigation â€“ Vollversion</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#000; color:#fff; }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:0; }
    .toolbar {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      display:flex; gap:10px; background:rgba(0,0,0,0.7);
      padding:10px 15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.4);
      z-index:1001; max-width:480px; width:calc(100% - 40px);
    }
    .toolbar button, .toolbar select {
      background:#10b981; color:#fff; border:none; border-radius:8px;
      padding:10px 14px; font-size:1rem; cursor:pointer; transition:background .2s;
      flex:1; min-width:0;
    }
    .toolbar button:hover, .toolbar select:hover { background:#0e9e6e; }
    .toolbar button.start { background:#ff5722; flex:1.5; font-weight:bold; }
    .toolbar button.start:hover { background:#e64a19; }
    #compass {
      position:fixed; top:10px; right:10px; font-size:28px;
      background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;
      z-index:1001; transform-origin:center;
    }
    #dashboard {
      position:fixed; bottom:100px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); padding:12px 16px; border-radius:12px;
      font-size:1rem; text-align:center; z-index:1001; display:none;
      max-width:90%; color:#fff;
    }
    #hutList {
      margin-top:8px; font-size:0.9em; overflow-x:auto; white-space:nowrap;
    }
    .hut-chip {
      display:inline-block; background:#0e9e6e; color:#fff;
      padding:4px 8px; border-radius:8px; margin:2px; cursor:pointer;
    }
    body.dark { background:#181a1b; }
    body.dark .toolbar { background:rgba(20,20,20,0.9); }
    body.dark .toolbar button, body.dark .toolbar select { background:#0e7c5b; }
    body.dark .toolbar button:hover, body.dark .toolbar select:hover { background:#0b5f46; }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="compass">ğŸ§­</div>
  <div id="dashboard">
    <div>ğŸš´ <span id="dashDist">0 km</span> Â· â± <span id="dashTime">0 Min</span></div>
    <div>ğŸ§­ <span id="dashDir">â€“</span> Â· ğŸ <span id="dashNext">â€“</span></div>
    <div id="hutList"></div>
    <div style="margin-top:8px;">
      <select id="routeModeDash" onchange="recalculateRoute()">
        <option value="auto">Optimiert</option>
        <option value="manual">Manuell</option>
      </select>
      <button onclick="resetRoute()" style="margin-left:8px;background:#ff4444;">ğŸ—‘ Route lÃ¶schen</button>
    </div>
  </div>

  <div class="toolbar">
    <button onclick="toggleDark()">ğŸŒ™</button>
    <button onclick="centerMap()">ğŸ“</button>
    <select id="routeMode" onchange="recalculateRoute()">
      <option value="auto">Optimiert</option>
      <option value="manual">Manuell</option>
    </select>
    <button class="start" onclick="startRoute()">â–¶ï¸ Start</button>
    <button onclick="resetRoute()">ğŸ—‘</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // **Konfiguration**
    const darkTiles   = "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png";
    const lightTiles  = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const ORS_KEY     = "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87";

    // **Initialisierung**
    firebase.initializeApp({
      apiKey: ORS_KEY,
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    });
    const db = firebase.firestore();

    let darkMode = false;
    let map = L.map("map").setView([51.5,10.5],15);
    let base = L.tileLayer(lightTiles,{maxZoom:19}).addTo(map);
    let cluster = L.markerClusterGroup().addTo(map);

    let userMarker = null, routingControl = null;
    let allHuts = [], selectedHuts = [], navTimer = null;
    let lastCoordsJSON = "", restoreAsked = false;

    const compassEl = document.getElementById("compass");
    const dashEl    = document.getElementById("dashboard");
    const distEl    = document.getElementById("dashDist");
    const timeEl    = document.getElementById("dashTime");
    const dirEl     = document.getElementById("dashDir");
    const nextEl    = document.getElementById("dashNext");
    const hutList   = document.getElementById("hutList");
    const startBtn  = document.querySelector(".start");

    // **Dark Mode Toggle**
    function toggleDark(){
      darkMode = !darkMode;
      document.body.classList.toggle("dark",darkMode);
      map.removeLayer(base);
      base = L.tileLayer(darkMode? darkTiles:lightTiles,{maxZoom:19}).addTo(map);
      cluster.addTo(map);
      if(routingControl) routingControl.addTo(map);
    }

    // **Standort + HÃ¼tten laden**
    navigator.geolocation.watchPosition(pos=>{
      const latlng=[pos.coords.latitude,pos.coords.longitude];
      if(!userMarker){
        userMarker=L.marker(latlng).addTo(map);
        map.setView(latlng,15);
        loadHuts();
        tryRestore();
      } else {
        userMarker.setLatLng(latlng);
      }
    },()=>{}, {enableHighAccuracy:true});

    function loadHuts(){
      db.collection("eierhuetten").where("status","==","angenommen")
        .onSnapshot(snap=>{
          allHuts=[]; cluster.clearLayers();
          snap.forEach(d=>{
            const h=d.data(); if(!h.location) return;
            const hut={id:d.id,name:h.name,lat:h.location.latitude,lng:h.location.longitude};
            allHuts.push(hut);
            L.marker([hut.lat,hut.lng])
             .bindPopup(`<b>${hut.name}</b><br>
               <button onclick="toggleHut('${hut.id}')">${
                 selectedHuts.includes(hut.id)?'âŒ Entfernen':'âœ… HinzufÃ¼gen'
               }</button>`)
             .addTo(cluster);
          });
        });
    }

    // **HÃ¼tte ein/auswÃ¤hlen**
    function toggleHut(id){
      const i=selectedHuts.indexOf(id);
      if(i>=0) selectedHuts.splice(i,1);
      else selectedHuts.push(id);
      localStorage.setItem("savedRoute",JSON.stringify(selectedHuts));
      recalc();
      renderHutList();
    }
    function renderHutList(){
      hutList.innerHTML="";
      selectedHuts.forEach(id=>{
        const h=allHuts.find(x=>x.id===id);
        if(!h) return;
        const chip=document.createElement("div");
        chip.className="hut-chip"; chip.textContent=h.name+" Ã—";
        chip.onclick=()=>toggleHut(id);
        hutList.appendChild(chip);
      });
    }

    // **Route wiederherstellen**
    function tryRestore(){
      if(restoreAsked||!userMarker||!allHuts.length) return;
      restoreAsked=true;
      const saved=localStorage.getItem("savedRoute");
      if(saved && confirm("ğŸ’¾ Route gefunden. Wiederherstellen?")){
        selectedHuts=JSON.parse(saved);
        recalc(); renderHutList();
      }
    }

    // **Route berechnen**
    function recalc(){
      if(routingControl) map.removeLayer(routingControl);
      if(!selectedHuts.length){ dashEl.style.display="none"; return; }
      const start=userMarker.getLatLng();
      const coords=selectedHuts.map(id=>{
        const h=allHuts.find(x=>x.id===id);
        return h?[h.lng,h.lat]:null;
      }).filter(Boolean);
      const arr=[[start.lng,start.lat],...coords];
      if(document.getElementById("routeMode").value==="manual"){
        draw(arr.map(c=>[c[1],c[0]]));
      } else {
        fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson",{
          method:"POST",
          headers:{Authorization:ORS_KEY,"Content-Type":"application/json"},
          body:JSON.stringify({coordinates:arr})
        })
        .then(r=>r.json())
        .then(j=>draw(j.features[0].geometry.coordinates.map(p=>[p[1],p[0]])))
        .catch(()=>alert("Routing fehlgeschlagen"));
      }
    }
    function draw(path){
      const j=JSON.stringify(path);
      if(j===lastCoordsJSON) return;
      lastCoordsJSON=j;
      routingControl=L.polyline(path,{color:"#10b981",weight:5}).addTo(map);
    }

    // **Navigation starten/stoppen**
    function startRoute(){
      if(navTimer) return stopRoute();
      if(!routingControl) return;
      startBtn.innerText="ğŸŸ¥ Beenden";
      let idx=1;
      dashEl.style.display="block";
      navTimer=setInterval(()=>{
        const pos=userMarker.getLatLng();
        const stops=routingControl.getLatLngs();
        if(idx>=stops.length){ stopRoute(); return; }
        const next=stops[idx];
        const d=pos.distanceTo(next);
        // Abbiegerichtung
        const prev=stops[idx-1];
        const a1=Math.atan2(next.lat-prev.lat,next.lng-prev.lng),
              a2=Math.atan2(pos.lat-prev.lat,pos.lng-prev.lng),
              diff=((a1-a2)*180/Math.PI+360)%360;
        let turn="geradeaus";
        if(diff>45&&diff<135) turn="rechts abbiegen";
        else if(diff>225&&diff<315) turn="links abbiegen";
        // Dashboard
        distEl.textContent=(d/1000).toFixed(2)+" km";
        timeEl.textContent=Math.round(d/250)+" Min";
        dirEl.textContent=turn;
        nextEl.textContent=allHuts.find(h=>h.lat===next.lat&&h.lng===next.lng)?.name||"â€“";
        // Sprache
        if(voiceEnabled){
          const m=new SpeechSynthesisUtterance(`In ${Math.round(d)} Metern ${turn}`);
          m.lang="de-DE"; speechSynthesis.speak(m);
        }
        if(d<30) idx++;
      },5000);
    }
    function stopRoute(){
      clearInterval(navTimer); navTimer=null;
      startBtn.innerText="â–¶ï¸ Start"; dashEl.style.display="none";
      speak("Navigation beendet");
    }

    // **Hilfsfunktionen**
    function centerMap(){ if(userMarker) map.setView(userMarker.getLatLng(),15); }
    function resetRoute(){
      selectedHuts=[]; localStorage.removeItem("savedRoute");
      if(routingControl) map.removeLayer(routingControl);
      dashEl.style.display="none"; renderHutList();
    }
    function recalculateRoute(){ recalc(); }
    function speak(t){ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(t);u.lang="de-DE";speechSynthesis.speak(u);} }
  </script>
</body>
</html>
