<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierh√ºtten Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #000;
      color: #fff;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 0;
    }

    #dashboard {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      margin: auto;
      max-width: 420px;
      background: rgba(0, 0, 0, 0.85);
      padding: 12px;
      border-radius: 12px;
      z-index: 1002;
      text-align: center;
    }

    #hutList {
      margin-top: 8px;
      font-size: 0.9em;
      overflow-x: auto;
      white-space: nowrap;
      color: #fff;
    }

    .hut-chip {
      display: inline-block;
      background: #0e9e6e;
      color: #fff;
      padding: 4px 8px;
      border-radius: 8px;
      margin: 2px;
      cursor: pointer;
    }

    .bottom-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 8px;
      background: rgba(0, 0, 0, 0.85);
      padding: 10px;
      z-index: 1001;
    }

    .bottom-toolbar button, .bottom-toolbar select {
      flex: 1;
      font-size: 1rem;
      padding: 10px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .bottom-toolbar button:hover {
      background: #0e9e6e;
    }

    #compassEl {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 28px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 50%;
      z-index: 1001;
      transform-origin: center center;
    }

    #followBtn {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: orange;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      z-index: 1001;
      display: none;
    }

    #arrowCanvas {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      transform: translate(-50%, -50%);
      z-index: 1002;
      pointer-events: none;
      display: none;
    }

    #routeInfo {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 1001;
      display: none;
    }

    body.dark {
      background: #181a1b;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <canvas id="arrowCanvas" width="60" height="60"></canvas>
  <div id="compassEl">üß≠</div>
  <div id="followBtn" onclick="followUser()">üìç Standort folgen</div>

  <div id="routeInfo">
    üö¥ <span id="dashDist">0 km</span> ¬∑ ‚è± <span id="dashTime">0 Min</span><br>
    üß≠ <span id="dashDir">‚Äì</span> ¬∑ üèÅ <span id="dashNext">‚Äì</span><br>
    üìä Fortschritt: <span id="progress">0 / 0</span>
  </div>

  <div id="dashboard">
    <div>Tour-Modus:</div>
    <select id="routeModeDash">
      <option value="auto">Optimiert</option>
      <option value="manual">Manuell</option>
    </select>
    <div id="hutList"></div>
  </div>

  <div class="bottom-toolbar">
    <button onclick="toggleDarkMode()">üåô Dark Mode</button>
    <button onclick="toggleVoice()">üîä Sprache</button>
    <button onclick="startRoute()" id="startBtn">‚ñ∂Ô∏è Start</button>
    <button onclick="resetRoute()">üóë L√∂schen</button>
  </div>

  <!-- Scripts folgen in Teil 2 -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const map = L.map("map").setView([51.5, 10.5], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    const cluster = L.markerClusterGroup().addTo(map);
    const compass = document.getElementById("compassEl");
    const canvas = document.getElementById("arrowCanvas");
    const ctx = canvas.getContext("2d");

    let userMarker = null;
    let allHuts = [];
    let selectedHuts = [];
    let routingControl = null;
    let navTimer = null;
    let currentStep = 0;
    let following = true;
    let voiceEnabled = true;

    navigator.geolocation.watchPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      if (!userMarker) {
        const icon = L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/3448/3448339.png",
          iconSize: [32, 32]
        });
        userMarker = L.marker(latlng, { icon }).addTo(map);
        map.setView(latlng, 15);
        loadHuts();
      } else {
        userMarker.setLatLng(latlng);
        if (following) map.setView(latlng);
      }
    });

    function loadHuts() {
      db.collection("eierhuetten")
        .where("status", "==", "angenommen")
        .onSnapshot(snap => {
          cluster.clearLayers();
          allHuts = [];
          snap.forEach(doc => {
            const d = doc.data();
            if (!d.location) return;
            const h = {
              id: doc.id,
              name: d.name,
              lat: d.location.latitude,
              lng: d.location.longitude
            };
            allHuts.push(h);
            const m = L.marker([h.lat, h.lng]).bindPopup(
              `<b>${h.name}</b><br><button onclick="toggleHut('${h.id}')">${
                selectedHuts.includes(h.id) ? "‚ùå Entfernen" : "‚úÖ Hinzuf√ºgen"
              }</button>`
            );
            cluster.addLayer(m);
          });
          map.addLayer(cluster);
          renderHutList();
        });
    }

    function toggleHut(id) {
      const i = selectedHuts.indexOf(id);
      if (i >= 0) selectedHuts.splice(i, 1);
      else selectedHuts.push(id);
      renderHutList();
    }

    function renderHutList() {
      const c = document.getElementById("hutList");
      c.innerHTML = "";
      selectedHuts.forEach(id => {
        const h = allHuts.find(x => x.id === id);
        if (!h) return;
        const chip = document.createElement("div");
        chip.className = "hut-chip";
        chip.textContent = h.name + " √ó";
        chip.onclick = () => toggleHut(id);
        c.appendChild(chip);
      });
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      alert("Sprachansage " + (voiceEnabled ? "aktiviert" : "deaktiviert"));
    }

    window.addEventListener("deviceorientation", e => {
      if (e.alpha != null) {
        compass.style.transform = `rotate(${-e.alpha}deg)`;
      }
    });

    map.on("movestart", () => {
      if (following) {
        following = false;
        document.getElementById("followBtn").style.display = "block";
      }
    });

    function followUser() {
      if (userMarker) {
        map.setView(userMarker.getLatLng(), 15);
        following = true;
        document.getElementById("followBtn").style.display = "none";
      }
    }

    function drawArrow(angle) {
      canvas.style.display = "block";
      ctx.clearRect(0, 0, 60, 60);
      ctx.save();
      ctx.translate(30, 30);
      ctx.rotate(angle * Math.PI / 180);
      ctx.beginPath();
      ctx.moveTo(0, -20);
      ctx.lineTo(10, 10);
      ctx.lineTo(0, 5);
      ctx.lineTo(-10, 10);
      ctx.closePath();
      ctx.fillStyle = "orange";
      ctx.fill();
      ctx.restore();
    }

    function startRoute() {
      if (!userMarker || !selectedHuts.length) return;
      const coords = selectedHuts.map(id => {
        const h = allHuts.find(x => x.id === id);
        return h ? [h.lng, h.lat] : null;
      }).filter(Boolean);
      coords.unshift([userMarker.getLatLng().lng, userMarker.getLatLng().lat]);

      fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
        method: "POST",
        headers: {
          Authorization: "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      })
        .then(r => r.json())
        .then(j => {
          const points = j.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
          if (routingControl) map.removeLayer(routingControl);
          routingControl = L.polyline(points, { color: "orange", weight: 5 }).addTo(map);
          runNavigation(points);
        });
    }

    function runNavigation(path) {
      document.getElementById("routeInfo").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
      currentStep = 1;
      document.getElementById("progress").textContent = `1 / ${path.length - 1}`;
      if (voiceEnabled && window.speechSynthesis) {
        const next = allHuts[0]?.name || "erste H√ºtte";
        const msg = new SpeechSynthesisUtterance(`Navigation wird gestartet. Viel Spa√ü! N√§chste H√ºtte: ${next}`);
        msg.lang = "de-DE";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
      }

      navTimer = setInterval(() => {
        if (!userMarker || currentStep >= path.length) return;
        const pos = userMarker.getLatLng();
        const next = path[currentStep];
        const angle = Math.atan2(next.lat - pos.lat, next.lng - pos.lng) * 180 / Math.PI;
        drawArrow(angle);
        const dist = pos.distanceTo(next);
        if (dist < 30) {
          currentStep++;
          document.getElementById("progress").textContent = `${currentStep} / ${path.length - 1}`;
        }
      }, 3000);
    }

    function resetRoute() {
      selectedHuts = [];
      renderHutList();
      if (routingControl) map.removeLayer(routingControl);
      if (navTimer) clearInterval(navTimer);
      canvas.style.display = "none";
      document.getElementById("progress").textContent = "0 / 0";
      document.getElementById("routeInfo").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
    }
  </script>
</body>
</html>
