<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>RadlMap (Refactored)</title>
  <!-- Leaflet & Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    /* ... existing CSS unchanged ... */
  </style>
</head>
<body>
  <div id="speedDisplay">ğŸš´â€â™‚ï¸ â€“ km/h</div>
  <div id="loadingOverlay">â³ Karte lÃ¤dt...</div>  <div id="bottomButtons">
    <button id="menuBtn">â˜° MenÃ¼</button>
    <button id="styleToggleBtn">ğŸŒ“ Stil</button>
    <button id="followBtn">ğŸ“ Folgen</button>
    <label><input type="checkbox" id="groupTrackCheckbox" /> Gruppen-Trekking</label>
  </div>  <div id="menuPanel">
    <h3>ğŸš´ MenÃ¼</h3>
    <ul id="selectedList"></ul>
    <label><input type="radio" name="routeMode" value="normal" checked> Normale Reihenfolge</label><br>
    <label><input type="radio" name="routeMode" value="optimized"> Optimiert</label><br>
    <button id="recalcBtn">ğŸ”„ Route neu berechnen</button>
    <button id="resetBtn">ğŸ—‘ Route lÃ¶schen</button>
  </div>  <div id="routeInfo"></div>
  <div id="nextStopInfo"></div>
  <div class="toast" id="toast"></div>
  <div id="map"></div>  <!-- Firebase & Leaflet JS -->  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>  <script src="https://unpkg.com/lrm-openrouteservice/dist/lrm-openrouteservice.min.js"></script>  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>  <script src="https://unpkg.com/leaflet-rainviewer"></script>  <script>
    // Helper for DOM queries
    const $ = selector => document.querySelector(selector);
    const $id = id => document.getElementById(id);

    // Initialize Firebase
    firebase.initializeApp({ /* ... */ });
    const db = firebase.firestore();

    // App state
    let map, userMarker, routingControl;
    let allHuts = [], selectedHuts = [];

    // Initialize map
    function initMap() {
      map = L.map('map').setView([51.5, 10.5], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 });
      L.markerClusterGroup().addTo(map);
    }

    async function loadHuts() {
      const snap = await db.collection('eierhuetten').get();
      allHuts = [];
      snap.forEach(doc => {
        const d = doc.data();
        // ... filter logic ...
        allHuts.push({ id: doc.id, ... });
        // add marker
      });
    }

    async function recalcRoute() {
      if (!userMarker || selectedHuts.length === 0) return;
      const mode = $('input[name="routeMode"]:checked').value;
      const start = userMarker.getLatLng();
      const coords = [start, ...selectedHuts.map(id => {
        const h = allHuts.find(x => x.id === id);
        return h && L.latLng(h.lat, h.lng);
      }).filter(Boolean)];

      try {
        const res = await fetch('https://api.openrouteservice.org/v2/directions/cycling-regular/geojson', {
          method: 'POST',
          headers: { 'Authorization': 'YOUR_KEY', 'Content-Type': 'application/json' },
          body: JSON.stringify({ coordinates: coords.map(c => [c.lng, c.lat]) })
        });
        const data = await res.json();
        const route = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        if (routingControl) map.removeLayer(routingControl);
        routingControl = L.polyline(route, { color: mode === 'optimized' ? 'orange' : '#10b981', weight: 5 }).addTo(map);
        map.fitBounds(routingControl.getBounds(), { padding: [50,50] });

        const dist = (data.features[0].properties.summary.distance / 1000).toFixed(1);
        const dur = Math.round(data.features[0].properties.summary.duration / 60);
        $id('routeInfo').textContent = `ğŸš´ ${dist} km Â· â± ${dur} Min`;
      } catch (e) {
        showToast('âš ï¸ Route konnte nicht berechnet werden');
      }
    }

    // ... other async functions for geolocation, rain monitoring, etc. refactored similarly ...

    function showToast(msg) {
      const t = $id('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }

    // Setup event listeners
    function bindEvents() {
      $id('recalcBtn').addEventListener('click', recalcRoute);
      $id('resetBtn').addEventListener('click', () => { /* ... */ });
      $('input[name="routeMode"]').forEach(r => r.addEventListener('change', recalcRoute));
      // ... other bindings ...
    }

    async function initApp() {
      initMap();
      await loadHuts();
      bindEvents();
      // start geolocation and rain
    }

    initApp();
  </script>  <div id="rainEffect"></div>
</body>
</html>
