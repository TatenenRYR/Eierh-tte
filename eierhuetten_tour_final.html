<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierh√ºtten Navigation ‚Äì Vollversion</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#fff; color:#000; }
    body.dark { background:#1e1e1e; color:#f0f0f0; }
    #map { position:absolute; top:0; bottom:0; left:0; right:0; z-index:0; }
    #loader {
      position:fixed; inset:0;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; z-index:9999; transition:opacity .5s;
    }
    body.dark #loader { background:#1e1e1e; color:#ccc; }
    #dashboard {
      position:fixed; top:60px; left:50%; transform:translateX(-50%);
      max-width:440px; background:rgba(40,40,40,0.95); padding:12px; border-radius:12px;
      z-index:1002; text-align:center; display:none; color:#fff;
    }
    #hutList { margin-top:8px; font-size:.9em; overflow-x:auto; white-space:nowrap; }
    .hut-chip {
      display:inline-block; background:#0e9e6e; color:#fff;
      padding:4px 8px; border-radius:8px; margin:2px; cursor:pointer;
    }
    .bottom-toolbar {
      position:fixed; bottom:0; left:0; right:0;
      display:flex; gap:8px; background:rgba(20,20,20,0.95);
      padding:10px; z-index:1001;
    }
    .bottom-toolbar button, .bottom-toolbar select {
      flex:1; font-size:1rem; padding:10px; background:#10b981;
      color:#fff; border:none; border-radius:8px; cursor:pointer;
    }
    .bottom-toolbar button:hover, .bottom-toolbar select:hover { background:#0e9e6e; }
    #compassEl {
      position:fixed; top:10px; right:10px; font-size:28px;
      background:rgba(0,0,0,0.6); padding:10px; border-radius:50%;
      z-index:1001; transform-origin:center center;
    }
    #followBtn {
      position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
      background:orange; color:#fff; padding:10px 20px; border-radius:8px;
      z-index:1001; display:none;
    }
    #routeInfo {
      position:fixed; top:10px; left:10px;
      background:rgba(0,0,0,0.7); padding:10px; border-radius:8px;
      z-index:1001; display:none; color:#fff;
    }
    #arrowCanvas {
      position:fixed; top:50%; left:50%;
      width:80px; height:80px; transform:translate(-50%,-50%);
      z-index:1002; pointer-events:none; display:none;
    }
  </style>
</head>
<body>
  <div id="loader">‚è≥ Lade Eierh√ºtten & Standort‚Ä¶</div>
  <div id="map"></div>
  <div id="compassEl">üß≠</div>
  <div id="followBtn" onclick="followUser()">üìç Standort folgen</div>
  <div id="routeInfo">
    üö¥ <span id="dashDist">0 km</span> ¬∑ ‚è± <span id="dashTime">0 Min</span><br>
    üß≠ <span id="dashDir">‚Äì</span> ¬∑ üèÅ <span id="dashNext">‚Äì</span><br>
    üìä Fortschritt: <span id="progress">0 / 0</span>
  </div>
  <canvas id="arrowCanvas" width="80" height="80"></canvas>

  <div id="dashboard">
    <div>Tour-Modus:</div>
    <select id="routeModeDash">
      <option value="auto">Optimiert</option>
      <option value="manual">Manuell</option>
    </select>
    <div id="hutList"></div>
  </div>

  <div class="bottom-toolbar">
    <button onclick="toggleDarkMode()">üåô Dark Mode</button>
    <button onclick="toggleVoice()">üîä Sprache</button>
    <select id="routeModeBottom" onchange="syncRouteMode()">
      <option value="auto">Optimiert</option>
      <option value="manual">Manuell</option>
    </select>
    <button onclick="startRoute()" id="startBtn">‚ñ∂Ô∏è Start</button>
    <button onclick="resetRoute()">üóë L√∂schen</button>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    let userReady = false, hutsReady = false, following = true;
    let userMarker = null, allHuts = [], selectedHuts = [], routeActive = false;
    let routingControl = null, navTimer = null, currentStep = 1;
    let lastUserPos = null, returnZoom = 15;
    let voiceEnabled = true;
    let darkMode = localStorage.getItem(\"darkMode\") === \"1\";
    let map = L.map(\"map\").setView([51.5, 10.5], returnZoom);

    const tileLight = L.tileLayer(\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\", { maxZoom: 19 });
    const tileDark = L.tileLayer(\"https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png\", { maxZoom: 19 });

    if (darkMode) {
      document.body.classList.add(\"dark\");
      tileDark.addTo(map);
    } else {
      tileLight.addTo(map);
    }

    const cluster = L.markerClusterGroup().addTo(map);
    const compassEl = document.getElementById(\"compassEl\");

    // Firestore config
    firebase.initializeApp({
      apiKey: \"5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87\",
      authDomain: \"eierhuettentour.firebaseapp.com\",
      projectId: \"eierhuettentour\"
    });
    const db = firebase.firestore();

    db.collection(\"eierhuetten\").where(\"status\", \"==\", \"angenommen\").get().then(snap => {
      snap.forEach(doc => {
        const d = doc.data();
        if (!d.location) return;
        const hut = { id: doc.id, name: d.name, lat: d.location.latitude, lng: d.location.longitude };
        allHuts.push(hut);
        const marker = L.marker([hut.lat, hut.lng]).bindPopup(\`
          <b>\${hut.name}</b><br>
          <button onclick=\"toggleHut('\${hut.id}')\">\${selectedHuts.includes(hut.id) ? '‚ùå Entfernen' : '‚úÖ Hinzuf√ºgen'}</button>
        \`);
        cluster.addLayer(marker);
      });
      hutsReady = true;
      tryHideLoader();
    });

    navigator.geolocation.watchPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      lastUserPos = L.latLng(latlng);
      if (!userMarker) {
        const icon = L.icon({ iconUrl: \"https://cdn-icons-png.flaticon.com/512/3448/3448339.png\", iconSize: [32, 32] });
        userMarker = L.marker(latlng, { icon }).addTo(map);
        map.setView(latlng, returnZoom);
        userReady = true;
        tryHideLoader();
      } else {
        userMarker.setLatLng(latlng);
        if (following) map.setView(latlng);
      }
    }, () => {
      userReady = true;
      tryHideLoader();
    }, { enableHighAccuracy: true });

    map.on(\"movestart\", () => {
      if (following) {
        following = false;
        document.getElementById(\"followBtn\").style.display = \"block\";
      }
    });

    function followUser() {
      if (lastUserPos) map.setView(lastUserPos, returnZoom);
      following = true;
      document.getElementById(\"followBtn\").style.display = \"none\";
    }

    function tryHideLoader() {
      if (userReady && hutsReady) {
        document.getElementById(\"loader\").style.display = \"none\";
        document.getElementById(\"dashboard\").style.display = \"block\";
      }
    }

    window.addEventListener(\"deviceorientation\", e => {
      if (e.alpha != null) compassEl.style.transform = `rotate(${-e.alpha}deg)`;
    });
    function toggleDarkMode() {
      darkMode = !darkMode;
      document.body.classList.toggle("dark", darkMode);
      localStorage.setItem("darkMode", darkMode ? "1" : "0");
      map.eachLayer(l => map.removeLayer(l));
      (darkMode ? tileDark : tileLight).addTo(map);
      cluster.addTo(map);
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      alert("üîä Sprache " + (voiceEnabled ? "aktiviert" : "deaktiviert"));
    }

    function toggleHut(id) {
      const i = selectedHuts.indexOf(id);
      if (i >= 0) selectedHuts.splice(i, 1);
      else selectedHuts.push(id);
      renderHutList();
    }

    function renderHutList() {
      const c = document.getElementById("hutList");
      c.innerHTML = "";
      selectedHuts.forEach(id => {
        const h = allHuts.find(x => x.id === id);
        if (!h) return;
        const chip = document.createElement("div");
        chip.className = "hut-chip";
        chip.textContent = h.name + " √ó";
        chip.onclick = () => toggleHut(id);
        c.appendChild(chip);
      });
    }

    function syncRouteMode() {
      const v = document.getElementById("routeModeBottom").value;
      document.getElementById("routeModeDash").value = v;
    }

    function drawArrow(angle) {
      const canvas = document.getElementById("arrowCanvas");
      const ctx = canvas.getContext("2d");
      canvas.style.display = "block";
      ctx.clearRect(0, 0, 80, 80);
      ctx.save();
      ctx.translate(40, 40);
      ctx.rotate(angle * Math.PI / 180);
      ctx.beginPath();
      ctx.moveTo(0, -25);
      ctx.lineTo(12, 15);
      ctx.lineTo(0, 5);
      ctx.lineTo(-12, 15);
      ctx.closePath();
      ctx.fillStyle = "orange";
      ctx.fill();
      ctx.restore();
    }

    function startRoute() {
      if (!userMarker || selectedHuts.length === 0) return;
      routeActive = true;
      following = true;
      map.setView(userMarker.getLatLng(), 17);

      const coords = selectedHuts.map(id => {
        const h = allHuts.find(x => x.id === id);
        return h ? [h.lng, h.lat] : null;
      }).filter(Boolean);
      coords.unshift([userMarker.getLatLng().lng, userMarker.getLatLng().lat]);

      fetch("https://api.openrouteservice.org/v2/directions/cycling-regular/geojson", {
        method: "POST",
        headers: {
          "Authorization": "5b3ce3597851110001cf624866907189b4974b88e5541b15dfed2e1603067f5b85cd6da44c68ee87",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      })
        .then(res => res.json())
        .then(data => {
          const pts = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
          if (routingControl) map.removeLayer(routingControl);
          routingControl = L.polyline(pts, { color: "orange", weight: 5 }).addTo(map);
          runNavigation(pts);
        });
    }

    function runNavigation(path) {
      currentStep = 1;
      document.getElementById("routeInfo").style.display = "block";
      if (voiceEnabled) {
        const nextName = allHuts[0]?.name || "erste H√ºtte";
        const msg = new SpeechSynthesisUtterance(`Navigation wird gestartet. Viel Spa√ü! N√§chste H√ºtte: ${nextName}`);
        msg.lang = "de-DE";
        speechSynthesis.cancel();
        speechSynthesis.speak(msg);
      }

      navTimer = setInterval(() => {
        if (!userMarker || currentStep >= path.length) return;
        const pos = userMarker.getLatLng(), next = L.latLng(path[currentStep]);
        const dist = pos.distanceTo(next);
        const angle = Math.atan2(next.lat - pos.lat, next.lng - pos.lng) * 180 / Math.PI;
        drawArrow(angle);
        if (dist < 30) {
          currentStep++;
          document.getElementById("progress").textContent = `${currentStep} / ${path.length - 1}`;
        }
      }, 3000);
    }

    function resetRoute() {
      if (navTimer) clearInterval(navTimer);
      if (routingControl) map.removeLayer(routingControl);
      routeActive = false;
      document.getElementById("arrowCanvas").style.display = "none";
      document.getElementById("routeInfo").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("progress").textContent = "0 / 0";
      if (lastUserPos) map.setView(lastUserPos, returnZoom);
    }
  </script>
</body>
</html>
