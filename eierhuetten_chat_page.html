<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EierhÃ¼tten Assistent Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn { margin-top: 0.5rem; background: #fbbf24; color: #92400e; padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer; display: inline-block; margin-right: 0.5rem; }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
  </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">ğŸ¥š EierhÃ¼tten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section><script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

let currentUser = null;
let editingData = {};
let step = 0;
let map, marker;

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo ğŸ‘‹ Ich bin dein Assistent fÃ¼r EierhÃ¼tten. Was mÃ¶chtest du tun?', 'bot');
  addChoiceButtons(['ğŸ¥š Neue HÃ¼tte erstellen','ğŸ“‹ Meine HÃ¼tten anzeigen'], handleIntent);
}

function handleIntent(input) {
  const txt = input.toLowerCase();
  if (txt.includes('meine')) return showMyHuts();
  if (txt.includes('neu')) { step = 1; editingData = {}; addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot'); return; }
}

function processUserInput(txt) {
  if (step === 1) { editingData.name = txt; step = 2; addMessage('Hat deine HÃ¼tte SitzplÃ¤tze?', 'bot'); addChoiceButtons(['Ja','Nein'], handleSitzplaetze); return; }
  if (step === 5) return; // Map handles further
  // Fallback
  startDialog();
}

function handleSitzplaetze(ans) {
  editingData.sitzplaetze = ans;
  step = 3;
  addMessage('Gibt es Strom?', 'bot');
  addChoiceButtons(['Ja','Nein'], handleStrom);
}

function handleStrom(ans) {
  editingData.strom = ans;
  step = 4;
  addMessage('Extras? (oder â€keineâ€œ)', 'bot');
  chatInput.disabled = false;
}

function handleExtras(txt) {
  editingData.extras = txt.toLowerCase()==='keine'?'':txt;
  step = 5;
  addMessage('Ã–ffnungszeiten (z.B. 9-18 Uhr)?', 'bot');
}

function handleOeffnungszeiten(txt) {
  editingData.oeffnungszeiten = txt;
  step = 6;
  addMessage('ğŸ“ Bitte klicke auf die Karte, um den Standort festzulegen:', 'bot');
  showMap();
}

function showMap() {
  const mapDiv = document.createElement('div'); mapDiv.id='map'; chatWindow.appendChild(mapDiv);
  map = L.map('map').setView([51.2,10.5],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.on('click',e=>{
    if(!marker) marker=L.marker(e.latlng,{draggable:true}).addTo(map);
    else marker.setLatLng(e.latlng);
    marker.on('dragend',ev=>{
      const p=ev.target.getLatLng(); editingData.location=new firebase.firestore.GeoPoint(p.lat,p.lng);
      addMessage(`ğŸ“ Neuer Standort: ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`,'bot');
    });
    editingData.location=new firebase.firestore.GeoPoint(e.lat,e.lng);
    addMessage(`ğŸ“ Standort gespeichert: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}`,'bot');
    addChoiceButtons(['Einreichen','Abbrechen'],ans=>ans==='Einreichen'?submitNewHut():startDialog());
  }); setTimeout(()=>map.invalidateSize(),200);
}

function submitNewHut(){
  if(!editingData.name||!editingData.location){addMessage('âŒ Bitte gib alle Daten ein.','bot');return;}
  const hut={...editingData,userId:currentUser.uid,erstelltAm:firebase.firestore.FieldValue.serverTimestamp(),status:'offen',fotos:[]};
  db.collection('eierhuetten').add(hut).then(()=>{
    addMessage('ğŸ‰ Deine HÃ¼tte wurde erfolgreich erstellt und wartet nun auf Freigabe.','bot');
    step=0;editingData={};startDialog();
  }).catch(err=>addMessage('âŒ Fehler: '+err.message,'bot'));
}

function showMyHuts(){
  chatWindow.innerHTML='';
  db.collection('eierhuetten').where('userId','==',currentUser.uid).get().then(snap=>{
    if(snap.empty){addMessage('Du hast noch keine HÃ¼tten.','bot');return;}
    snap.forEach(doc=>{
      const d=doc.data();
      const div=document.createElement('div');div.className='message bot';
      div.innerHTML=`<div class='space-y-1 text-sm'>
        <div><strong>ğŸ“ Name:</strong> <input class='edit-name' data-id='${doc.id}' value='${d.name}'/></div>
        <div><strong>ğŸª‘ SitzplÃ¤tze:</strong> <select class='edit-sitz' data-id='${doc.id}'><option${d.sitzplaetze==='Ja'?' selected':''}>Ja</option><option${d.sitzplaetze==='Nein'?' selected':''}>Nein</option></select></div>
        <div><strong>ğŸ”Œ Strom:</strong> <select class='edit-strom' data-id='${doc.id}'><option${d.strom==='Ja'?' selected':''}>Ja</option><option${d.strom==='Nein'?' selected':''}>Nein</option></select></div>
        <div><strong>âœ¨ Extras:</strong> <input class='edit-extras' data-id='${doc.id}' value='${d.extras}'/></div>
        <div><strong>ğŸ•’ Ã–ffnungszeiten:</strong> <input class='edit-zeiten' data-id='${doc.id}' value='${d.oeffnungszeiten||''}'/></div>
        <button class='edit-btn' onclick='saveEdit("${doc.id}")'>Speichern</button>
        <button class='delete-btn' onclick='deleteHut("${doc.id}")'>LÃ¶schen</button>
        <div id='minimap-${doc.id}' class='minimap'></div>
      </div>`;
      chatWindow.appendChild(div);
      if(d.location?.latitude){
        const m=L.map(`minimap-${doc.id}`,{zoomControl:true}).setView([d.location.latitude,d.location.longitude],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        const mark=L.marker([d.location.latitude,d.location.longitude],{draggable:true}).addTo(m);
        mark.on('dragend',e=>{
          const p=e.target.getLatLng();db.collection('eierhuetten').doc(doc.id).update({location:new firebase.firestore.GeoPoint(p.lat,p.lng)});
        });setTimeout(()=>m.invalidateSize(),200);
      }
    });
  });
}

function saveEdit(id){
  const name=document.querySelector(`.edit-name[data-id='${id}']`).value;
  const sitz=document.querySelector(`.edit-sitz[data-id='${id}']`).value;
  const strom=document.querySelector(`.edit-strom[data-id='${id}']`).value;
  const extras=document.querySelector(`.edit-extras[data-id='${id}']`).value;
  const zeiten=document.querySelector(`.edit-zeiten[data-id='${id}']`).value;
  db.collection('eierhuetten').doc(id).update({name,sitzplaetze:sitz,strom,extras,oeffnungszeiten:zeiten}).then(()=>addMessage('âœ… Ã„nderungen gespeichert.','bot'));
}

function deleteHut(id){
  if(confirm('MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')){db.collection('eierhuetten').doc(id).delete().then(()=>{addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.','bot');showMyHuts();});}
}

function addMessage(txt,sender='bot'){const d=document.createElement('div');d.classList.add('message',sender);d.textContent=txt;chatWindow.appendChild(d);chatWindow.scrollTop=chatWindow.scrollHeight;}

function addChoiceButtons(opts,cb){const c=document.createElement('div');c.classList.add('message','bot');opts.forEach(o=>{const b=document.createElement('button');b.className='choice-btn';b.textContent=o;b.onclick=()=>{addMessage(o,'user');c.remove();cb(o);};c.appendChild(b);});chatWindow.appendChild(c);chatWindow.scrollTop=chatWindow.scrollHeight;}

auth.onAuthStateChanged(u=>{if(u){currentUser=u;document.getElementById('login-section').classList.add('hidden');document.getElementById('main-section').classList.remove('hidden');startDialog();}});

document.getElementById('google-login').onclick=()=>{const p=new firebase.auth.GoogleAuthProvider();auth.signInWithPopup(p);};
sendBtn.addEventListener('click',()=>{const v=chatInput.value.trim();if(!v)return;addMessage(v,'user');chatInput.value='';if(step===4)handleExtras(v);else if(step===3){}else if(step===2){}processUserInput(v);});
chatInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendBtn.click();});
</script></body>
</html>
