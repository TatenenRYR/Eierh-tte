<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Assistent Chat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.paypal.com/sdk/js?client-id=AbnXzFW_R-XwHEQCBVth0OY1zkq3Rl0Op-bqTcbmvAlbQqgh45zAWtkmuWiNp4dF7ijTW4vs90Ec7gyG&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  
 <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn {
      margin-top: 0.5rem; background: #fbbf24; color: #92400e;
      padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer;
      display: inline-block; margin-right: 0.5rem;
    }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .time-picker { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .time-picker input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 0.5rem; width: 45%; }
 
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #d1fae5;
  color: #065f46;
  padding: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: sans-serif;
  border: 1px solid #065f46;
}




    /* Hover-Effekte f√ºr Links */
  #consent-modal a:hover {
    color: #0056b3 !important;
    border-color: #0056b3 !important;
  }

  /* Button Hover-Effekt */
  #consent-accept:hover {
    background: linear-gradient(135deg, #45A049, #3e8e41);
    transform: translateY(-1px);
  }

  /* Button Klick-Effekt */
  #consent-accept:active {
    transform: translateY(0);
  }
 </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>

  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
<!-- Navigation -->
<div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    üë§ <span id="user-name">L√§dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîÑ
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üè†
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîì
    </button>
  </div>
</div>


    
    <div class="text-center font-bold text-2xl text-green-700 mb-4">H√ºtten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
   <input type="file" id="image-upload" accept="image/*" multiple hidden />
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

<script>
// Konfiguration
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(firebaseConfig);
  firebase.functions();
const auth = firebase.auth(), db = firebase.firestore();
const storage = firebase.storage(); // WICHTIG
 const imgbbApiKey = "5df04de9bfd2776f101329be4193e44c"; 
// Zust√§nde
let currentUser = null;
let editingData = {};
let step = 0;
let map, marker;

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
function addMessage(text, sender = 'bot', isHTML = false) {
  const div = document.createElement('div');
  div.classList.add('message', sender);

  if (isHTML) {
    // Nur verwenden, wenn du volle Kontrolle √ºber den Inhalt hast!
    div.innerHTML = text;
  } else {
    div.textContent = text;
  }

  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}


/*function addMessage(text, sender = 'bot') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}*/
/*
function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      container.remove();
      callback(opt);
    };
    container.appendChild(btn);
  });
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
*/
  function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');

  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;

    btn.onclick = () => {
      addMessage(opt, 'user');
      btn.disabled = true; // Verhindere Doppelklick
      callback(opt)
        .then(() => {
          container.remove(); // ‚úÖ Nur bei Erfolg entfernen
        })
        .catch(err => {
          console.error('‚ùå Fehler beim Verarbeiten:', err);
          btn.disabled = false; // Wieder aktivieren bei Fehler
        });
    };

    container.appendChild(btn);
  });

  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  }
function showTimePicker() {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  const label = document.createElement('div');
  label.textContent = 'Bitte w√§hle √ñffnungszeiten:';
  const timeDiv = document.createElement('div');
  timeDiv.className = 'time-picker';
  const von = document.createElement('input');
  von.type = 'time';
  const bis = document.createElement('input');
  bis.type = 'time';
  timeDiv.appendChild(von);
  timeDiv.appendChild(bis);
  const btn = document.createElement('button');
  btn.className = 'choice-btn';
  btn.textContent = '√úbernehmen';
  btn.onclick = () => {
    if (von.value && bis.value) {
      editingData.oeffnungszeiten = `${von.value} ‚Äì ${bis.value}`;
      addMessage(`üïí √ñffnungszeiten: ${editingData.oeffnungszeiten}`, 'bot');
      container.remove();
      step = 6;
      showMap();
    } else {
      alert('Bitte beide Uhrzeiten eingeben.');
    }
  };
  container.appendChild(label);
  container.appendChild(timeDiv);
  container.appendChild(btn);
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Dialogfluss
function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo üëã Ich bin dein Assistent f√ºr Fahrradstops. Was m√∂chtest du tun?', 'bot');
  addChoiceButtons(['ü•ö Neue H√ºtte erstellen','üìã Meine H√ºtten anzeigen','üé´ Support Anfragen'], handleIntent);}
function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('support')) {
    addMessage('Hallo üëã', 'bot');
    ladeMeineSupportTickets();
    return;
  }

  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
    return;
  }

  if (txt.includes('neu')) {
    addMessage(`
      üõ°Ô∏è <b>Bevor du deine H√ºtte eintr√§gst, akzeptiere bitte die Datenschutzerkl√§rung:</b><br>
      <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
        <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
        <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">Datenschutzerkl√§rung</a>.</span>
      </label>
    `, 'bot', true);

    addChoiceButtons(['‚úÖ Zustimmen & Starten'], () => {
      const checkbox = document.getElementById('chat-datenschutz-zustimmung');
      if (!checkbox || !checkbox.checked) {
        alert('Bitte akzeptiere zuerst die Datenschutzerkl√§rung.');
        return;
      }

      step = 1;
      editingData = {
        zustimmungDatenschutz: {
          akzeptiert: true,
          am: new Date().toISOString()
        }
      };

      addMessage('Wie soll deine neue H√ºtte hei√üen?', 'bot');
    });

    return;
  }

  // Falls kein Befehl erkannt wurde
  addMessage('‚ùì Ich habe das leider nicht verstanden. Bitte w√§hle eine Option aus.', 'bot');
  addChoiceButtons(['ü•ö Neue H√ºtte erstellen','üìã Meine H√ºtten anzeigen','üé´ Support Anfragen'], handleIntent);
}
  
  /*function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
  }

  if (txt.includes('neu')) {
  addMessage(`
    üõ°Ô∏è <b>Bevor du deine H√ºtte eintr√§gst, akzeptiere bitte die Datenschutzerkl√§rung:</b><br>
    <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
      <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
      <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">Datenschutzerkl√§rung</a>.</span>
    </label>
  `, 'bot', true);

  addChoiceButtons(['‚úÖ Zustimmen & Starten'], () => {
    const checkbox = document.getElementById('chat-datenschutz-zustimmung');
    if (!checkbox || !checkbox.checked) {
      alert('Bitte akzeptiere zuerst die Datenschutzerkl√§rung.');
      return;
    }

    // Zustimmung speichern
    step = 1;
    editingData = {
      zustimmungDatenschutz: {
        akzeptiert: true,
        am: new Date().toISOString()
      }
    };

    addMessage('Wie soll deine neue H√ºtte hei√üen?', 'bot');
  });
  }
  if (txt.includes('support')) {
    ladeMeineSupportTickets();
  }
}*/
  
/*function handleIntent(input) {
  const txt = input.toLowerCase();
  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
                             
  }
  if (txt.includes('neu')) {
    step = 1;
    editingData = {};
    addMessage('Wie soll deine neue H√ºtte hei√üen?', 'bot');
  }
}
*/
function processUserInput(txt) {
  if (step === 1) {
    editingData.name = txt;
    step = 2;
    addMessage('Hat deine H√ºtte Sitzpl√§tze?', 'bot');
    addChoiceButtons(['Ja', 'Nein'], ans => {
      editingData.sitzplaetze = ans;
      step = 3;
      addMessage('Gibt es Strom?', 'bot');
      addChoiceButtons(['Ja', 'Nein'], strom => {
        editingData.strom = strom;
        step = 4;
        addMessage('Extras? (oder ‚Äûkeine‚Äú)', 'bot');
      });
    });
    return;
  }
  if (step === 4) {
    editingData.extras = txt.toLowerCase() === 'keine' ? '' : txt;
    step = 5;
    addMessage('Wie lauten die √ñffnungszeiten?', 'bot');
    addChoiceButtons(['Immer ge√∂ffnet', 'Von ‚Äì Bis angeben'], ans => {
      if (ans === 'Immer ge√∂ffnet') {
        editingData.oeffnungszeiten = 'Immer ge√∂ffnet';
        step = 6;
        showMap();
      } else {
        showTimePicker();
      }
    });
    return;
  }
}
// Neue Funktion mit Fallback
function updateAboInfoFallback(subId, el) {
  if (!el) return;

  if (!subId) {
    el.innerHTML = '‚ö†Ô∏è Kein Abo vorhanden oder noch nicht abgeschlossen.';
    return;
  }

  getPayPalInfo(subId).then(info => {
    try {
      if (info?.status === 'ACTIVE' && info?.start_time) {
        const startDate = new Date(info.start_time);
        const testEnd = new Date(startDate);
        testEnd.setDate(testEnd.getDate() + 14);
        const now = new Date();
        const diff = Math.max(0, Math.ceil((testEnd - now) / (1000 * 60 * 60 * 24)));

        // Erfolgreich ‚Äì zeige Feuerwerk
        el.innerHTML = `
          <div class="relative">
            üéÜ Testphase aktiv ‚Äì endet in ${diff} Tagen<br>
            <span class="text-xs text-gray-500">üîí K√ºndigung √ºber dein PayPal-Konto.</span>
            <canvas id="firework-${subId}" style="position:absolute;left:0;top:0;width:100%;height:50px;pointer-events:none;"></canvas>
          </div>
        `;

        
      } else {
        el.innerHTML = '‚ùå Abo nicht aktiv oder wurde gek√ºndigt.';
      }
    } catch (err) {
      console.warn('‚ö†Ô∏è PayPal-Parsing-Fehler:', err);
      el.innerHTML = '‚ö†Ô∏è Testphase l√§uft ‚Äì genaues Enddatum nicht verf√ºgbar.';
    }
  }).catch(err => {
    console.error('‚ùå PayPal-Abo konnte nicht abgerufen werden:', err);
    el.innerHTML = '‚ö†Ô∏è PayPal-Abo nicht abrufbar. Bitte sp√§ter erneut versuchen.';
  });
}
  async function checkAboStatus(hutId, hutData) {
  try {
    if (!hutData.paypalSubscriptionId) return;

    const info = await getPayPalInfo(hutData.paypalSubscriptionId);
    const status = info?.status;

    if (status !== 'ACTIVE') {
      // Abo ist nicht aktiv ‚Üí automatisch deaktivieren
      await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Abo √ºber PayPal wurde gek√ºndigt oder ist nicht aktiv',
        zeitpunkt: new Date()
      });
      addMessage(`‚ö†Ô∏è Die H√ºtte "${hutData.name}" wurde deaktiviert, da das Abo nicht mehr aktiv ist.`, 'bot');
    }
  } catch (error) {
    console.warn(`‚ö†Ô∏è Fehler beim Abo-Check f√ºr "${hutData.name}":`, error);

    // Fallback: Pr√ºfe lokale Testzeit (wenn kein Zugriff auf PayPal m√∂glich)
    if (hutData.aboStart && hutData.status === 'angenommen') {
      const start = hutData.aboStart.toDate();
      const now = new Date();
      const testEnd = new Date(start);
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd) {
        await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
        await db.collection('eierhuetten').doc(hutId).collection('log').add({
          admin: 'System',
          feld: 'status',
          wert: 'abgelehnt',
          kommentar: 'Abo konnte nicht gepr√ºft werden ‚Äì Fallback: Testzeitraum √ºberschritten',
          zeitpunkt: new Date()
        });
        addMessage(`‚ö†Ô∏è Die H√ºtte "${hutData.name}" wurde deaktiviert, da keine Abo-Info abrufbar war und die Testzeit √ºberschritten ist.`, 'bot');
      }
    }
  }
  }

  async function analyseUndAktualisiereHuette(hutId, hutData) {
  const updates = {};
  let ablehnen = false;
  let grund = '';
  const now = new Date();

  try {
    // Wenn PayPal vorhanden ‚Üí pr√ºfen
    if (hutData.paypalSubscriptionId) {
      const info = await getPayPalInfo(hutData.paypalSubscriptionId);
      const status = info?.status;

      if (status === 'ACTIVE') {
        // Automatisch erg√§nzen, falls fehlt
        if (!hutData.aboStart) updates.aboStart = new Date();
        if (!hutData.aboMonate) updates.aboMonate = 1;
      } else {
        ablehnen = true;
        grund = 'PayPal-Abo inaktiv oder gek√ºndigt.';
      }

    } else if (hutData.aboStart) {
      // Kein PayPal ‚Üí Testphase pr√ºfen
      const testEnd = new Date(hutData.aboStart.toDate());
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd) {
        ablehnen = true;
        grund = 'Testphase abgelaufen. Kein aktives Abo.';
      }
    } else {
      // Weder Abo noch Testphase ‚Üí nicht anzeigen, aber keine Ablehnung
      return;
    }

    if (ablehnen && hutData.status === 'angenommen') {
      updates.status = 'abgelehnt';
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: grund,
        zeitpunkt: now
      });
      addMessage(`‚ùå Deine H√ºtte ‚Äû${hutData.name}‚Äú wurde deaktiviert: ${grund}`, 'bot');
    }

    if (Object.keys(updates).length > 0) {
      await db.collection('eierhuetten').doc(hutId).update(updates);
    }

  } catch (err) {
    console.error('üõë Fehler bei Analyse der H√ºtte:', hutId, err);

    // Optionaler Fallback
    if (hutData.aboStart) {
      const testEnd = new Date(hutData.aboStart.toDate());
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd && hutData.status === 'angenommen') {
        await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
        addMessage(`‚ö†Ô∏è Deine H√ºtte ‚Äû${hutData.name}‚Äú wurde vorsorglich deaktiviert. Abo konnte nicht gepr√ºft werden.`, 'bot');
      }
    }
  }
  }

  async function korrigiereFehlendeAbos() {
  const snapshot = await db.collection('eierhuetten')
    .where('userId', '==', currentUser.uid)
    .where('status', '==', 'angenommen')
    .get();

  snapshot.forEach(async (doc) => {
    const d = doc.data();
    const id = doc.id;

    const keinAbo = !d.aboStart && !d.paypalSubscriptionId;

    if (keinAbo) {
      await db.collection('eierhuetten').doc(id).update({
        status: 'abgelehnt'
      });

      await db.collection('eierhuetten').doc(id).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Automatisch deaktiviert: Kein Abo oder Testphase',
        zeitpunkt: new Date()
      });

      console.warn(`‚ùå H√ºtte "${d.name}" wurde automatisch deaktiviert wegen fehlendem Abo/Test.`);
    }
  });
}
  /*
async function uploadToImgBB(file, onProgress) {
  const apiKey = '5df04de9bfd2776f101329be4193e44c';

  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      const formData = new FormData();
      formData.append('key', apiKey);
      formData.append('image', base64);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://api.imgbb.com/1/upload');

      xhr.upload.onprogress = (e) => {
        if (onProgress && e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          onProgress(percent);
        }
      };

      xhr.onload = () => {
        try {
          const json = JSON.parse(xhr.responseText);
          if (json.success && json.data?.url && json.data?.delete_url) {
            resolve({
              url: json.data.url,
              delete_url: json.data.delete_url
            });
          } else {
            reject('Fehlerhafte Antwort von imgbb: ' + JSON.stringify(json));
          }
        } catch (err) {
          reject('Antwort konnte nicht geparst werden');
        }
      };

      xhr.onerror = () => reject('Netzwerkfehler beim Upload');
      xhr.send(formData);
    };

    reader.onerror = () => reject('Fehler beim Lesen der Datei');
    reader.readAsDataURL(file);
  });
}*/
  async function uploadToImgBB(file, onProgress) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async () => {
      const base64 = reader.result.split(',')[1];
      const body = new URLSearchParams();
      body.append('key', '5df04de9bfd2776f101329be4193e44c');
      body.append('image', base64);

      try {
        const res = await fetch('https://api.imgbb.com/1/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body
        });

        const json = await res.json();

        if (json.success && json.data?.url && json.data?.delete_url) {
          resolve({
            url: json.data.url,
            delete_url: json.data.delete_url,
            status: 'wartet'
          });
        } else {
          reject('Upload erfolgreich, aber delete_url fehlt: ' + JSON.stringify(json));
        }
      } catch (err) {
        reject('Upload-Fehler: ' + err.message);
      }
    };

    reader.onerror = () => reject('Fehler beim Lesen der Datei');
    reader.readAsDataURL(file);
  });
  }
// Standortwahl

const filterStatus = true; // oder abh√§ngig von UI-Einstellungen
async function showMyHuts() {
  chatWindow.innerHTML = '';

  const snapshot = await db.collection('eierhuetten')
  .where('userId', '==', currentUser.uid)
  .get();

const docs = snapshot.docs.filter(doc => {
  const status = doc.data().status;
  return status !== "archiviert" || typeof status === "undefined";
});
  
  if (snapshot.empty) return addMessage('Du hast noch keine H√ºtten.', 'bot');

  let total = 0, angenommen = 0, offen = 0, abosAktiv = 0;

  docs.forEach(doc => {
    const d = doc.data();
    total++;
    if (d.status === 'angenommen') angenommen++;
    if (d.status === 'offen') offen++;
    if (d.paypalSubscriptionId) abosAktiv++;
  });
//addMessage(`‚óè Deine H√ºtte "${total}"`, 'bot');

  // Statistik-Balken
  const statsBar = document.createElement('div');
  statsBar.className = 'flex justify-around items-center text-sm bg-green-100 text-green-900 py-2 px-4 rounded mb-3 shadow-sm border border-green-300';
  statsBar.innerHTML = `
    <div title="Eingereichte H√ºtten">ü•ö <strong>${total}</strong>/10</div>
    <div title="Angenommen">‚úÖ <strong>${angenommen}</strong></div>
    <div title="Offen">‚è≥ <strong>${offen}</strong></div>
    <div title="Abos aktiv">üí≥ <strong>${abosAktiv}</strong></div>
  `;
  chatWindow.appendChild(statsBar);

  // Jetzt jede H√ºtte rendern
  docs.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const div = document.createElement('div');
    div.className = 'message bot';

    const now = new Date();
    let aboInfo = '';
    let shouldReject = false;

    // Nachtrag fehlender Abo-Werte
    if (d.paypalSubscriptionId && !d.aboMonate) {
      db.collection('eierhuetten').doc(id).update({ aboMonate: 1 });
      d.aboMonate = 1;
    }
    if (d.status === 'angenommen' && !d.aboStart && d.paypalSubscriptionId) {
      const now = new Date();
      db.collection('eierhuetten').doc(id).update({
        aboStart: firebase.firestore.Timestamp.fromDate(now)
      });
      d.aboStart = firebase.firestore.Timestamp.fromDate(now);
    }

    // Abo pr√ºfen
    if (d.aboStart && d.aboMonate) {
      const start = d.aboStart.toDate();
      const end = new Date(start);
      end.setMonth(end.getMonth() + d.aboMonate);
      const diffTage = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
      if (diffTage > 0) {
        aboInfo = `üí≥ Abo aktiv bis: ${end.toLocaleDateString()} (noch ${diffTage} Tage)`;
      } else {
        aboInfo = 'üí≥ Abo abgelaufen';
        if (d.status === 'angenommen') shouldReject = true;
      }
    }

    if (shouldReject) {
      db.collection('eierhuetten').doc(id).update({ status: 'abgelehnt' });
      db.collection('eierhuetten').doc(id).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Abo oder Testphase abgelaufen',
        zeitpunkt: new Date()
      });
      addMessage(`‚ö†Ô∏è Die H√ºtte "${d.name}" wurde deaktiviert.`, 'bot');
    }

    const paypalContainerId = `paypal-button-new-${id}`;
    const minimapId = `minimap-${id}`;

    div.innerHTML = `
      <div class="text-sm space-y-2">
        <div class='font-bold'>${d.name}</div>
        <div class='font-bold'>üìå Status: ${d.status}</div>
        <div>${aboInfo}</div>

        ${d.status === 'angenommen' ? `
          <label>üìç Name:<br>
            <input type='text' data-id='${id}' class='edit-name w-full border px-2 py-1 rounded' value='${d.name}' />
          </label><br>

          <label>ü™ë Sitzpl√§tze:
            <select data-id='${id}' class='edit-sitz border rounded px-2 py-1 ml-2'>
              <option ${d.sitzplaetze === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.sitzplaetze === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>üîå Strom:
            <select data-id='${id}' class='edit-strom border rounded px-2 py-1 ml-2'>
              <option ${d.strom === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.strom === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>‚ú® Extras:<br>
            <input type='text' data-id='${id}' class='edit-extras w-full border px-2 py-1 rounded' value='${d.extras || ''}' />
          </label><br>

          <label>üïí √ñffnungszeiten:<br>
            <input type='text' data-id='${id}' class='edit-zeiten w-full border px-2 py-1 rounded' value='${d.oeffnungszeiten || ''}' />
          </label><br>

          <button class='edit-btn' onclick='saveEdit("${id}")'>üíæ Speichern</button>
          <button class='delete-btn' onclick='deleteHut("${id}")'>üóëÔ∏è L√∂schen</button>
        ` : `
          <div class="text-gray-500 italic">‚õî Nur nach Freigabe bearbeitbar.</div>
          <button class='delete-btn' onclick='deleteHut("${id}")'>üóëÔ∏è L√∂schen</button>
   
        `}

        <!-- Bildergalerie -->
        ${Array.isArray(d.fotos) && d.fotos.length ? `
          <div class='flex flex-col gap-2 mt-2'>
            ${d.fotos.map(img => {
              const isString = typeof img === 'string';
              const url = isString ? img : img.url;
              const del = isString ? '' : (img.delete_url || '');
              const status = isString ? 'freigegeben' : (img.status || 'freigegeben');
              const pending = status === 'wartet';
              return `
                <div class="flex items-center gap-4 bg-gray-50 p-2 rounded border relative">
                  <div class="relative group">
                    <img src="${url}" class="h-20 w-20 object-cover rounded shadow ${pending ? 'opacity-50' : ''}"/>
                    ${!pending ? `
                      <button onclick="deleteImage('${id}', '${url}', '${del}')" 
                        class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-1 opacity-0 group-hover:opacity-100 transition">
                        ‚úï
                      </button>
                    ` : ''}
                  </div>
                  <div class="flex-1 text-xs break-all text-gray-600">
                    <div><strong>Status:</strong> ${pending ? '<span class="text-orange-600">‚è≥ wartet</span>' : '‚úÖ frei'}</div>
                    <div><strong>Delete:</strong><br><code>${del || '-'}</code></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}

        <!-- Upload -->
        <label class="block mt-2 text-sm">üì∑ Neues Bild:
          <input type="file" accept="image/*" data-id="${id}" class="upload-image mt-1" />
        </label>
        <div id="progress-${id}" class="h-2 bg-gray-200 rounded hidden mt-2">
          <div class="h-2 bg-green-500 rounded" style="width: 0%"></div>
        </div>

        <!-- Mini-Map -->
        <div id="${minimapId}" class="minimap h-40 mt-2 rounded border"></div>

        <!-- Abo -->
        ${d.aboStart && d.paypalSubscriptionId ? `
          <details class="bg-blue-50 border border-blue-200 rounded p-2 my-2 text-sm">
            <summary class="cursor-pointer">üí≥ Abo-Informationen</summary>
            <div><strong>Start:</strong> ${d.aboStart?.toDate?.().toLocaleDateString("de-DE") || '-'}</div>
            <div><strong>PayPal-ID:</strong> ${d.paypalSubscriptionId}</div>
            <div><strong>Status:</strong> aktiv</div>
            ${Array.isArray(d.aboHistory) && d.aboHistory.length ? `
              <div class="mt-2"><strong>Zahlungsverlauf:</strong>
                <ul class="list-disc ml-5 text-xs">
                  ${d.aboHistory.map(e => `
                    <li>${new Date(e.zeitpunkt?.seconds * 1000).toLocaleDateString("de-DE")} ‚Äì ${e.betrag}‚ÄØ‚Ç¨ via ${e.methode}</li>
                  `).join('')}
                </ul>
              </div>
            ` : '<div class="text-xs text-gray-500 mt-2 italic">Kein Verlauf vorhanden.</div>'}
          </details>
        ` : `
          <div class="my-2 text-sm">
            <strong>üí≥ Kein aktives Abo</strong><br>
            <div id="${paypalContainerId}" class="my-2"></div>
          </div>
        `}
      </div>
    `;
    chatWindow.appendChild(div);

    // PayPal-Button nur anzeigen wenn kein aktives Abo
    if (!d.aboStart || !d.paypalSubscriptionId) {
      setTimeout(() => {
        paypal.Buttons({
          style: { shape: 'pill', layout: 'horizontal', color: 'blue' },
          createSubscription: (data, actions) => {
            return actions.subscription.create({ plan_id: 'P-144846983Y921400TNCFA3PA' });
          },
          onApprove: (data, actions) => {
            db.collection('eierhuetten').doc(id).update({
              paypalSubscriptionId: data.subscriptionID,
              aboStart: new Date(),
              aboMonate: 1
            }).then(() => showMyHuts());
          }
        }).render(`#${paypalContainerId}`);
      }, 500);
    }

    // Mini-Map aktivieren
    if (d.location?.latitude && d.location?.longitude) {
      setTimeout(() => {
        const m = L.map(minimapId, { zoomControl: true }).setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);

        const marker = L.marker([d.location.latitude, d.location.longitude], {
          draggable: d.status === 'angenommen'
        }).addTo(m);

        if (d.status === 'angenommen') {
          marker.on('dragend', e => {
            const pos = e.target.getLatLng();
            db.collection('eierhuetten').doc(id).update({
              location: new firebase.firestore.GeoPoint(pos.lat, pos.lng)
            }).then(() => {
              addMessage(`üìç Neuer Standort f√ºr "${d.name}" gespeichert.`, 'bot');
            });
          });
        }
      }, 300);
    }
  });
}



function saveEdit(id) {
  const name = document.querySelector(`.edit-name[data-id='${id}']`).value;
  const sitz = document.querySelector(`.edit-sitz[data-id='${id}']`).value;
  const strom = document.querySelector(`.edit-strom[data-id='${id}']`).value;
  const extras = document.querySelector(`.edit-extras[data-id='${id}']`).value;
  const zeiten = document.querySelector(`.edit-zeiten[data-id='${id}']`).value;
  db.collection('eierhuetten').doc(id).update({
    name,
    sitzplaetze: sitz,
    strom,
    extras,
    oeffnungszeiten: zeiten
  }).then(() => addMessage('‚úÖ √Ñnderungen gespeichert.', 'bot'));
}

/*function deleteHut(id) {
  if (confirm('M√∂chtest du diese H√ºtte wirklich l√∂schen?')) {
    db.collection('eierhuetten').doc(id).delete().then(() => {
      addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
      korrigiereFehlendeAbos().then(() => {
 
        showMyHuts();
      });
    });
  }
}*/
  /*function deleteHut(id) {
  if (!confirm('M√∂chtest du diese H√ºtte wirklich l√∂schen?')) return;

  // Schritt 1: Hole die H√ºtte inkl. PayPal-Abo
  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('‚ùå H√ºtte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();

    // Schritt 2: Pr√ºfe, ob ein Abo besteht
    if (hut.paypalSubscriptionId) {
      addMessage('üîÑ K√ºndige PayPal-Abo...', 'bot');

      // Schritt 3: Cloud-Funktion aufrufen
      //const cancelFn = firebase.functions().httpsCallable('cancelPaypalSubscription');
  const functions = firebase.app().functions('europe-west1');
const cancelFn = functions.httpsCallable('cancelPaypalSubscription');
      
      cancelFn({ subscriptionId: hut.paypalSubscriptionId }).then(result => {
        if (result.data.success) {
          addMessage('‚úÖ Abo erfolgreich gek√ºndigt.', 'bot');

          // Schritt 4: H√ºtte l√∂schen
          db.collection('eierhuetten').doc(id).delete().then(() => {
            addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
            korrigiereFehlendeAbos().then(() => showMyHuts());
          });
        } else {
          addMessage('‚ùå Abo konnte nicht gek√ºndigt werden.', 'bot');
        }
      }).catch(err => {
        console.error('‚ùå Fehler bei K√ºndigung:', err.message || err);
        addMessage('‚ùå Fehler beim K√ºndigen des Abos.', 'bot');
      });

    } else {
      // Kein Abo vorhanden ‚Üí einfach l√∂schen
      db.collection('eierhuetten').doc(id).delete().then(() => {
        addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
        korrigiereFehlendeAbos().then(() => showMyHuts());
      });
    }
  });
}*/
/*
 function deleteHut(id) {
  if (!confirm('M√∂chtest du diese H√ºtte wirklich l√∂schen?')) return;

  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('‚ùå H√ºtte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();

    // Pr√ºfen, ob Abo existiert
    if (hut.paypalSubscriptionId) {
      addMessage('üîÑ K√ºndige PayPal-Abo...', 'bot');
      console.log('‚û°Ô∏è Sende Abo-K√ºndigung f√ºr:', hut.paypalSubscriptionId);

      // Anfrage an HTTP-Cloud-Function (onRequest)
      fetch('https://us-central1-eierhuettentour.cloudfunctions.net/cancelPaypalSubscription', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ subscriptionId: hut.paypalSubscriptionId })
})
.then(async response => {
  if (!response.ok) {
    // Versuche Fehlerinhalt zu lesen
    let errorText = await response.text();
    try {
      const errorJson = JSON.parse(errorText);
      throw new Error(errorJson.error || 'Unbekannter Fehler bei K√ºndigung');
    } catch {
      throw new Error(errorText);
    }
  }

  // JSON auslesen, wenn Status OK
  const result = await response.json();
  if (result.success) {
    addMessage('‚úÖ Abo erfolgreich gek√ºndigt.', 'bot');
    console.log('‚úÖ K√ºndigung erfolgreich');

    // Danach H√ºtte l√∂schen
    db.collection('eierhuetten').doc(id).delete().then(() => {
      addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
      korrigiereFehlendeAbos().then(() => showMyHuts());
    });
  } else {
    console.error('‚ùå Fehler bei K√ºndigung:', result.error || result);
    addMessage('‚ùå Fehler bei K√ºndigung: ' + (result.error || 'Unbekannt'), 'bot');
  }
})
.catch(err => {
  console.error('‚ùå Fehler bei K√ºndigung:', err.message || err);
  addMessage('‚ùå Fehler bei K√ºndigung: ' + (err.message || 'Unbekannt'), 'bot');
});


    } else {
      // Kein Abo ‚Üí direkt l√∂schen
      db.collection('eierhuetten').doc(id).delete().then(() => {
        addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
        korrigiereFehlendeAbos().then(() => showMyHuts());
      });
    }
  }).catch(err => {
    console.error('‚ùå Fehler beim Abrufen der H√ºtte:', err.message || err);
    addMessage('‚ùå Fehler beim L√∂schen der H√ºtte.', 'bot');
  });
}*/



function deleteHut(id) {
  if (!confirm('‚ùó M√∂chtest du diese H√ºtte wirklich l√∂schen?')) return;

  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('‚ùå H√ºtte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();
    const user = firebase.auth().currentUser;

    if (!hut.paypalSubscriptionId) {
      addMessage(
        `‚ö†Ô∏è Es wurde keine PayPal-Abo-ID f√ºr diese H√ºtte gefunden.<br><br>
         Wenn du trotzdem ein Abo vermutest, <a href='#' onclick='zeigeSupportFormularMitVorschlag(\`Ich m√∂chte die H√ºtte \\\"${hut.name || 'Unbekannt'}\\\" l√∂schen, aber es ist keine PayPal-Abo-ID gespeichert. Bitte pr√ºft, ob ein aktives Abo besteht.\`)'>kontaktiere den Support</a>.`,
        'bot'
      );

      if (confirm("‚ùì Es wurde keine Abo-ID gefunden. Trotzdem archivieren?")) {
        db.collection('eierhuetten').doc(id).update({
          status: "archiviert",
          archiviertAm: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          addMessage('üóÉÔ∏è H√ºtte wurde archiviert und ist f√ºr dich nicht mehr sichtbar.', 'bot');
          korrigiereFehlendeAbos().then(() => showMyHuts());
        });
      } else {
        addMessage("‚ùå H√ºtte wurde nicht archiviert.", "bot");
      }
      return;
    }

    addMessage('üîÑ Versuche, dein PayPal-Abo zu k√ºndigen...', 'bot');
    const functions = firebase.app().functions('us-central1');
    const cancelFn = functions.httpsCallable('cancelPaypalSubscription');

    cancelFn({ subscriptionId: hut.paypalSubscriptionId }).then(result => {
      if (result.data && result.data.success) {
        addMessage('‚úÖ Abo erfolgreich gek√ºndigt.', 'bot');
        db.collection('eierhuetten').doc(id).update({
          status: "archiviert",
          archiviertAm: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          addMessage('üóÉÔ∏è H√ºtte wurde archiviert und ist f√ºr dich nicht mehr sichtbar.', 'bot');
          korrigiereFehlendeAbos().then(() => showMyHuts());
        });

      } else {
        addMessage('‚ö†Ô∏è Abo konnte nicht gek√ºndigt werden. Die H√ºtte wurde NICHT gel√∂scht.', 'bot');
        frageSupportBeiAboProblem(user, hut);
      }
    }).catch(err => {
      console.error('‚ùå Fehler bei K√ºndigung:', err.message || err);
      addMessage('‚ùå Fehler beim K√ºndigen. Die H√ºtte wurde NICHT gel√∂scht.', 'bot');
      frageSupportBeiAboProblem(user, hut);
    });
  });
}

function frageSupportBeiAboProblem(user, hut) {
  const vorschlag = `Ich m√∂chte die H√ºtte "${hut.name || 'Unbekannt'}" l√∂schen, aber das PayPal-Abo (ID: ${hut.paypalSubscriptionId}) konnte nicht automatisch gek√ºndigt werden.`;

  addMessage(
  `‚ùå Die automatische K√ºndigung deines PayPal-Abos ist fehlgeschlagen.<br><br>
   üëâ <a href="#" id="supportLink">Support kontaktieren</a>`,
  'bot',
  true
);

setTimeout(() => {
  const link = document.getElementById('supportLink');
  if (link) {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      zeigeSupportFormularMitVorschlag(vorschlag);
    });
  }
}, 100);
}

function zeigeSupportFormularMitVorschlag(vorlage) {
  const nutzerZusatzeingabe = prompt(
    `üÜò Support-Anfrage\n\nWir haben folgendes f√ºr dich vorbereitet:\n\n${vorlage}\n\nDu kannst hier noch optional etwas hinzuf√ºgen:`
  );

  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage("üö´ Du musst eingeloggt sein, um den Support zu kontaktieren.", "bot");
    return;
  }

  const gesamttext = nutzerZusatzeingabe && nutzerZusatzeingabe.trim().length > 0
    ? `${vorlage}\n\nZusatz des Nutzers:\n${nutzerZusatzeingabe.trim()}`
    : vorlage;

  db.collection("supportTickets").add({
    userId: user.uid,
    email: user.email,
    message: gesamttext,
    status: "offen",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    addMessage("‚úÖ Deine Support-Anfrage wurde gesendet. Wir k√ºmmern uns darum!", "bot");
  }).catch(err => {
    console.error("‚ùå Fehler beim Senden:", err);
    addMessage("‚ö†Ô∏è Es gab ein Problem beim Senden deiner Anfrage. Bitte versuche es sp√§ter erneut.", "bot");
  });
}




async function deleteImage(hutId, imageUrl, deleteUrl) {
  if (!confirm('‚ùó M√∂chtest du dieses Bild wirklich l√∂schen?')) return;

  try {
    // 1. Firestore-Eintrag laden
    const docRef = db.collection('eierhuetten').doc(hutId);
    const doc = await docRef.get();
    if (!doc.exists) return alert('‚ùå H√ºtte nicht gefunden.');

    const data = doc.data();
    const fotos = (data.fotos || []).filter(img => img.url !== imageUrl);

    // 2. Firestore updaten
    await docRef.update({ fotos });

    // 3. Optional: Bild bei imgbb l√∂schen
    if (deleteUrl) {
      await fetch(deleteUrl, { method: 'GET' });
      console.log('‚úÖ Bild bei imgbb gel√∂scht');
    }

    // 4. UI neu laden
    addMessage('‚úÖ Bild wurde gel√∂scht.', 'bot');
    showMyHuts();

  } catch (err) {
    console.error('‚ùå Fehler beim L√∂schen:', err);
    alert('‚ùå Fehler beim L√∂schen des Bildes.');
  }
}
async function submitNewHut() {
/* const zustimmung = document.getElementById('datenschutz-zustimmung');
  if (!zustimmung.checked) {
    alert('‚ùó Bitte best√§tige die Datenschutzerkl√§rung, um fortzufahren.');
    return;
  }*/
  
  if (!editingData.name || !editingData.location) {
    addMessage('‚ùå Bitte gib alle Daten ein (mindestens Name und Standort).', 'bot');
    return;
  }

  // üîí Sicherheit: Nur g√ºltige Bilder √ºbernehmen (mit url UND delete_url)
  const validFotos = (editingData.fotos || []).filter(f =>
    typeof f === 'object' &&
    f.url &&
    f.delete_url
  );

  const hut = {
    ...editingData,
    userId: currentUser.uid,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'offen',
    fotos: validFotos,
    aboMonate: 1,
    paypalSubscriptionId: null,
    datenschutzZustimmung: {
       best√§tigtAm: firebase.firestore.FieldValue.serverTimestamp(),
       durch: firebase.auth().currentUser?.email || "Gast"
    }
  };

  console.log('üì∏ Fotos werden gespeichert:', JSON.stringify(hut.fotos));

  try {
    const docRef = await db.collection('eierhuetten').add(hut);
    addMessage('üéâ Deine H√ºtte wurde erfolgreich erstellt.', 'bot');
    addMessage('üí≥ Du kannst jetzt dein 14-t√§giges Testabo starten. Erst danach wird deine H√ºtte sichtbar.', 'bot');

    const paypalDiv = document.createElement('div');
    paypalDiv.id = `paypal-button-new-${docRef.id}`;
    paypalDiv.className = 'my-2';
    chatWindow.appendChild(paypalDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    if (typeof paypal !== 'undefined') {
      paypal.Buttons({
        style: {
          shape: 'pill',
          color: 'blue',
          layout: 'horizontal',
          label: 'subscribe'
        },
        createSubscription: function (data, actions) {
          return actions.subscription.create({
            plan_id: 'P-144846983Y921400TNCFA3PA'
          });
        },
        onApprove: function (data, actions) {
          db.collection('eierhuetten').doc(docRef.id).update({
            paypalSubscriptionId: data.subscriptionID,
            aboStart: new Date(),
            aboMonate: 1,
            status: 'angenommen'
          }).then(() => {
            addMessage('‚úÖ Abo erfolgreich gestartet! Deine H√ºtte ist freigeschaltet.', 'bot');
            setTimeout(() => {
              showMyHuts();
              startDialog();
            }, 5000);
          });
        }
      }).render(`#paypal-button-new-${docRef.id}`);
    } else {
      addMessage('‚ö†Ô∏è PayPal SDK nicht geladen. Button konnte nicht angezeigt werden.', 'bot');
      setTimeout(() => startDialog(), 1500);
    }

    // Reset
    step = 0;
    editingData = {};

  } catch (err) {
    addMessage('‚ùå Fehler beim Erstellen der H√ºtte: ' + err.message, 'bot');
    setTimeout(() => startDialog(), 1500);
  }
}
// Authentifizierung
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    if (!localStorage.getItem("tutorialDone")) {
      showTutorial();
  localStorage.setItem("tutorialDone", "true");
  }else{
    
    startDialog();
    }
  }
});
document.getElementById('google-login').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      const user = result.user;
      checkConsent(user);
    })
    .catch(error => {
      console.error('Login fehlgeschlagen:', error);
    });
};
sendBtn.addEventListener('click', () => {
  const val = chatInput.value.trim();
  if (!val) return;
  addMessage(val, 'user');
  chatInput.value = '';
  processUserInput(val);
});
chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendBtn.click();
});
  function checkConsent(user) {
  const consentGiven = localStorage.getItem('consentGiven');

  if (consentGiven === 'true') {
    startApp(user);
    return;
  }

  const modal = document.getElementById('consent-modal');
  modal.style.display = 'flex';

  document.getElementById('consent-accept').onclick = async () => {
    const privacyChecked = document.getElementById('consent-privacy').checked;
    const cookiesChecked = document.getElementById('consent-cookies').checked;

    if (!privacyChecked || !cookiesChecked) {
      alert('Bitte beide K√§stchen ankreuzen, um fortzufahren.');
      return;
    }

    localStorage.setItem('consentGiven', 'true');

    // Optional: In Firestore dokumentieren
    await db.collection('consents').doc(user.uid).set({
      privacy: true,
      cookies: true,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    modal.style.display = 'none';
    startApp(user);
  };
    }

function showMap() {
  const container = document.createElement('div');
  container.className = 'message bot';
  container.innerHTML = `<div class="font-bold mb-1">üìç Bitte w√§hle den Standort deiner H√ºtte:</div><div id="map"></div>`;
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    setTimeout(() => {
      map = L.map('map').setView([latitude, longitude], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

      marker.on('dragend', e => {
        const pos = e.target.getLatLng();
        editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
      });

      // Erste Position speichern
      editingData.location = new firebase.firestore.GeoPoint(latitude, longitude);

      // Weiter-Button
      // Weiter-Button mit Upload-Option
const btn = document.createElement('button');
btn.className = 'choice-btn mt-2';
btn.textContent = '‚úÖ Weiter zu Bilderupload';
btn.onclick = () => {
  container.remove();
  askForImageUpload(); // ‚¨ÖÔ∏è N√§chster Schritt
};
container.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 100);
  }, () => {
    addMessage('‚ùå Standort konnte nicht ermittelt werden.', 'bot');
  });
}
  function initImageUpload() {
  document.querySelectorAll(".upload-image").forEach(input => {
    input.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      const id = e.target.dataset.id;
      if (!file || !id) return;

      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(`eierhuetten/${id}/${Date.now()}_${file.name}`);
      const uploadTask = fileRef.put(file);

      const progressBar = document.querySelector(`#progress-${id}`);
      const progressFill = progressBar?.firstElementChild;

      if (progressBar) progressBar.classList.remove("hidden");

      uploadTask.on("state_changed",
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          if (progressFill) progressFill.style.width = `${progress.toFixed(0)}%`;
        },
        (error) => {
          console.error("‚ùå Upload-Fehler:", error);
          addMessage("‚ùå Fehler beim Hochladen des Bildes.", "bot");
        },
        async () => {
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          // üìé URL in die Datenbank einf√ºgen
          const hutRef = db.collection("eierhuetten").doc(id);
          await hutRef.update({
            fotos: firebase.firestore.FieldValue.arrayUnion(url)
          });
          addMessage("‚úÖ Bild erfolgreich hochgeladen.", "bot");
          showMyHuts(); // Seite aktualisieren
        }
      );
    });
  });
  }
function askForImageUpload() {
  addMessage('üì∑ M√∂chtest du Fotos deiner H√ºtte hochladen?', 'bot');
  addChoiceButtons(['Ja, Bilder ausw√§hlen', 'Nein, direkt speichern'], antwort => {
    if (antwort.includes('Nein')) {
      submitNewHut(); // ohne Bilder
    } else {
      const uploadInput = document.getElementById('image-upload');
      uploadInput.onchange = async () => {
        const files = Array.from(uploadInput.files);
        if (files.length === 0) return submitNewHut();

        addMessage(`‚è≥ Lade ${files.length} Bild(er) hoch...`, 'bot');
        const uploads = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();

          const base64 = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
            reader.readAsDataURL(file);
          });

          try {
            const formData = new FormData();
            formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // dein imgbb Key
            formData.append('image', base64);

            const res = await fetch('https://api.imgbb.com/1/upload', {
              method: 'POST',
              body: formData
            });

            const json = await res.json();

            if (json?.data?.url && json?.data?.delete_url) {
              uploads.push({
                url: json.data.url,
                delete_url: json.data.delete_url,
                status: 'wartet'
                
              });
            } else {
              console.warn('‚ùå Upload war unvollst√§ndig oder fehlerhaft:', json);
              addMessage(`‚ùå Fehler beim Hochladen von Bild ${i + 1}`, 'bot');
            }

          } catch (err) {
            console.error(err);
            addMessage(`‚ùå Upload-Fehler: ${err}`, 'bot');
          }
        }

        editingData.fotos = uploads;  // Wichtig: hier speicherst du die vollst√§ndigen Objekte!
        addMessage('‚úÖ Bilder wurden erfolgreich hochgeladen.', 'bot');
        submitNewHut();
      };
      uploadInput.click();
    }
  });
}
document.body.addEventListener('change', async e => {
  if (e.target.classList.contains('upload-image')) {
    const file = e.target.files[0];
    const hutId = e.target.dataset.id;
    const progressBar = document.querySelector(`#progress-${hutId}`);
    const progressInner = progressBar?.firstElementChild;

    if (!file || !hutId || !progressBar || !progressInner) return;

    try {
      progressBar.classList.remove('hidden');
      progressInner.style.width = "30%";

      const imageData = await uploadToImgBB(file, percent => {
        progressInner.style.width = `${percent}%`;
      });

      progressInner.style.width = "100%";

      await db.collection("eierhuetten").doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(imageData) // ‚úÖ Korrekt: ganzes Objekt
      });

      addMessage("‚úÖ Bild erfolgreich hochgeladen.", "bot");
      showMyHuts();
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      addMessage("‚ùå Upload fehlgeschlagen: " + err, "bot");
    } finally {
      e.target.value = '';
      setTimeout(() => {
        progressBar.classList.add('hidden');
        progressInner.style.width = "0%";
      }, 2000);
    }
  }
});


  // Warten bis DOM geladen ist
  document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    // Nicht eingeloggt
    return;
  }

  const consentGiven = localStorage.getItem('consentGiven');
  if (consentGiven === 'true') {
    startApp(user);
  } else {
    checkConsent(user);
  }
});
    });

function startApp(user) {
  const nameEl = document.getElementById('user-name');
  const topbar = document.getElementById('topbar');

  nameEl.textContent = user.displayName || user.email || 'Unbekannt';
  topbar.style.display = 'flex';
}
  
  
function logout() {
  firebase.auth().signOut().then(() => {
    location.reload(); // Seite neu laden nach Logout
  }).catch(error => {
    alert('Fehler beim Abmelden: ' + error.message);
  });
}
function goToMainPage() {
  window.location.href = '/'; // Passe ggf. die URL an (z.‚ÄØB. '/index.html')
}
function refresh() {
  location.reload(); // ‚¨ÖÔ∏è Das l√§dt die gesamte Seite neu
}
/*async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage('‚ö†Ô∏è Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  const snapshot = await db.collection('supportTickets')
    .where('userId', '==', user.uid)
    .orderBy('createdAt', 'desc')
    .limit(10)
    .get();

  if (snapshot.empty) {
    addMessage('üì≠ Du hast noch keine Support-Anfragen gestellt.', 'bot');
    return;
  }

  addMessage(`üì® Hier sind deine letzten Support-Anfragen:`, 'bot');

  snapshot.forEach(doc => {
    const t = doc.data();
    const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
    const status = t.status || 'offen';
    const message = t.message || '(leer)';

    addMessage(`
      <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
        <div><strong>üìÖ ${datum}</strong></div>
        <div class="mt-1">üí¨ ${message}</div>
        <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
      </div>
    `, 'bot', true);
  });
}*/
async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  console.log('üîê Aktueller Nutzer:', user);

  if (!user) {
    addMessage('‚ö†Ô∏è Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  try {
    const ref = db.collection('supportTickets')
      .where('userId', '==', user.uid)
      //.orderBy('createdAt', 'desc')
      .limit(10);

    console.log('üì§ Firestore-Query:', ref);

    const snapshot = await ref.get();
    console.log('üì• Gefundene Tickets:', snapshot.size);

    if (snapshot.empty) {
      addMessage('üì≠ Du hast noch keine Support-Anfragen gestellt.', 'bot');
      return;
    }

    addMessage(`üì® Hier sind deine letzten Support-Anfragen:`, 'bot');

    snapshot.forEach(doc => {
      const t = doc.data();
      console.log('üìÑ Ticket:', t);

      const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const status = t.status || 'offen';
      const message = t.message || '(leer)';

      addMessage(`
        <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
          <div><strong>üìÖ ${datum}</strong></div>
          <div class="mt-1">üí¨ ${message}</div>
          <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
        </div>
      `, 'bot', true);
    });
  } catch (err) {
    console.error('‚ùå Fehler beim Laden der Tickets:', err);
    addMessage('‚ùå Fehler beim Abrufen deiner Tickets. Bitte sp√§ter erneut versuchen.', 'bot');
  }
}
  function showTutorial() {
  chatWindow.innerHTML = '';
  addMessage('üëã Moin moin! Ich bin dein Assistent f√ºr Fahrradstops.');
  addMessage('üìå Hier kannst du deine Fahrrad-H√ºtte eintragen, verwalten und sichtbar machen.');
  
  setTimeout(() => {
    addMessage('üí¨ Du sprichst mit mir √ºber den Chat. W√§hle einfach eine Option oder antworte manuell.');
  }, 1000);

  setTimeout(() => {
    addMessage('üÜì Jede neue H√ºtte startet mit einer kostenlosen 14-Tage-Testphase.');
  }, 4000);

  setTimeout(() => {
    addMessage('üí≥ Danach kostet das Abo nur **2,99‚ÄØ‚Ç¨ pro Monat**. Die Zahlung l√§uft bequem √ºber dein PayPal-Konto.');
  }, 6000);

  setTimeout(() => {
    addMessage('‚ùå M√∂chtest du das Abo k√ºndigen? Dann l√∂sche einfach die H√ºtte ‚Äì das Abo wird automatisch bei PayPal beendet.');
  }, 8000);

  setTimeout(() => {
    addMessage('‚öôÔ∏è Unter **‚ÄûMeine H√ºtten anzeigen‚Äú** kannst du jederzeit deine Daten anpassen, z.‚ÄØB. den Standort per Karte oder Texte und Bilder.');
  }, 10000);

  setTimeout(() => {
    addMessage('üéâ Bereit? Was m√∂chtest du tun?', 'bot');
    addChoiceButtons(['ü•ö Neue H√ºtte erstellen', 'üìã Meine H√ºtten anzeigen'], handleIntent);
  }, 12000);
  }

  let currentUserForConsent = null;

function loadTrackingScripts(consent) {
  // Statistik
  if (consent.cookieStats) {
    const gaScript = document.createElement('script');
    gaScript.src = "https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-X"; // Deine GA-ID
    gaScript.async = true;
    document.head.appendChild(gaScript);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-XXXXXXX-X'); // Deine GA-ID
  }

  // Marketing
  if (consent.cookieMarketing) {
    const fbScript = document.createElement('script');
    fbScript.innerHTML = `
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'YOUR_PIXEL_ID');
      fbq('track', 'PageView');
    `;
    document.head.appendChild(fbScript);
  }
}

function showConsentModal(user) {
  currentUserForConsent = user;
  document.getElementById('consent-modal').classList.remove('hidden');
}

async function acceptConsent() {
  const privacyAccepted = document.getElementById('consent-privacy').checked;
  const cookiesAccepted = document.getElementById('consent-cookies').checked;

  if (!privacyAccepted) {
    alert('Bitte stimmen Sie der Datenschutzerkl√§rung zu.');
    return;
  }

  if (!cookiesAccepted) {
    alert('Bitte stimmen Sie der Verwendung von Cookies zu.');
    return;
  }

  const consentData = {
    privacyAccepted: privacyAccepted,
    cookiesAccepted: cookiesAccepted,
    consentDate: new Date(),
    privacyVersion: '1.0'
  };

  await db.collection('users').doc(currentUserForConsent.uid).set(consentData, { merge: true });
  localStorage.setItem('userConsent', JSON.stringify(consentData));

  // Falls du Scripts nur bei Cookie-Zustimmung laden willst
  loadTrackingScripts(consentData);

  document.getElementById('consent-modal').classList.add('hidden');
  loadApp(currentUserForConsent);
}
</script>
<!-- Consent Modal -->
<div id="consent-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">  
  <div style="background:white; padding:25px 30px; max-width:520px; width:100%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:sans-serif; line-height:1.6; color:#333;">  
    
    <h2 style="margin-top:0; font-size:1.6rem; font-weight:600; color:#222; margin-bottom:15px;">Datenschutz & Cookies</h2>  
    
    <p style="margin-bottom:15px; font-size:1rem;">  
      Wir verwenden Cookies und √§hnliche Technologien, um unsere Dienste bereitzustellen und zu verbessern.  
      Mehr dazu in unserer   
      <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">  
        Datenschutzerkl√§rung  
      </a>.  
    </p>  
    
    <label style="display:flex; align-items:center; margin-top:15px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-privacy" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Datenschutzerkl√§rung</a> zu</span>  
    </label>  
    
    <label style="display:flex; align-items:center; margin-top:10px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-cookies" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der Verwendung von Cookies gem√§√ü der <a href="/cookies.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Cookie-Richtlinie</a> zu</span>  
    </label>  

    <div style="margin-top:25px; text-align:right;">  
<button id="consent-accept" onclick="acceptConsent()" style="padding:10px 20px; background:linear-gradient(135deg, #4CAF50, #45A049); color:white; border:none; border-radius:6px; font-size:1rem; font-weight:500; cursor:pointer; transition:background 0.3s, transform 0.1s;">
  Zustimmen
</button>
    </div>  
  </div>  
</div>  


</body>
</html>
