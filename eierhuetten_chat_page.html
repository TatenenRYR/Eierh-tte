<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HÃ¼tten Assistent Chat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.paypal.com/sdk/js?client-id=AbnXzFW_R-XwHEQCBVth0OY1zkq3Rl0Op-bqTcbmvAlbQqgh45zAWtkmuWiNp4dF7ijTW4vs90Ec7gyG&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  
 <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn {
      margin-top: 0.5rem; background: #fbbf24; color: #92400e;
      padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer;
      display: inline-block; margin-right: 0.5rem;
    }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .time-picker { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .time-picker input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 0.5rem; width: 45%; }
 
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #d1fae5;
  color: #065f46;
  padding: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: sans-serif;
  border: 1px solid #065f46;
}




    /* Hover-Effekte fÃ¼r Links */
  #consent-modal a:hover {
    color: #0056b3 !important;
    border-color: #0056b3 !important;
  }

  /* Button Hover-Effekt */
  #consent-accept:hover {
    background: linear-gradient(135deg, #45A049, #3e8e41);
    transform: translateY(-1px);
  }

  /* Button Klick-Effekt */
  #consent-accept:active {
    transform: translateY(0);
  }
 </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>

  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
<!-- Navigation -->
<div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    ğŸ‘¤ <span id="user-name">LÃ¤dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ”„
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ 
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ”“
    </button>
  </div>
</div>


    
    <div class="text-center font-bold text-2xl text-green-700 mb-4">HÃ¼tten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
   <input type="file" id="image-upload" accept="image/*" multiple hidden />
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

<script>
// Konfiguration
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(firebaseConfig);
  firebase.functions();
const auth = firebase.auth(), db = firebase.firestore();
const storage = firebase.storage(); // WICHTIG
 const imgbbApiKey = "5df04de9bfd2776f101329be4193e44c"; 
// ZustÃ¤nde
let currentUser = null;
let editingData = {};
let step = 0;
let map, marker;

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
function addMessage(text, sender = 'bot', isHTML = false) {
  const div = document.createElement('div');
  div.classList.add('message', sender);

  if (isHTML) {
    // Nur verwenden, wenn du volle Kontrolle Ã¼ber den Inhalt hast!
    div.innerHTML = text;
  } else {
    div.textContent = text;
  }

  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}


/*function addMessage(text, sender = 'bot') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}*/
/*
function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      container.remove();
      callback(opt);
    };
    container.appendChild(btn);
  });
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
*/
  function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');

  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;

    btn.onclick = () => {
      addMessage(opt, 'user');
      btn.disabled = true; // Verhindere Doppelklick
      callback(opt)
        .then(() => {
          container.remove(); // âœ… Nur bei Erfolg entfernen
        })
        .catch(err => {
          console.error('âŒ Fehler beim Verarbeiten:', err);
          btn.disabled = false; // Wieder aktivieren bei Fehler
        });
    };

    container.appendChild(btn);
  });

  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  }
function showTimePicker() {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  const label = document.createElement('div');
  label.textContent = 'Bitte wÃ¤hle Ã–ffnungszeiten:';
  const timeDiv = document.createElement('div');
  timeDiv.className = 'time-picker';
  const von = document.createElement('input');
  von.type = 'time';
  const bis = document.createElement('input');
  bis.type = 'time';
  timeDiv.appendChild(von);
  timeDiv.appendChild(bis);
  const btn = document.createElement('button');
  btn.className = 'choice-btn';
  btn.textContent = 'Ãœbernehmen';
  btn.onclick = () => {
    if (von.value && bis.value) {
      editingData.oeffnungszeiten = `${von.value} â€“ ${bis.value}`;
      addMessage(`ğŸ•’ Ã–ffnungszeiten: ${editingData.oeffnungszeiten}`, 'bot');
      container.remove();
      step = 6;
      showMap();
    } else {
      alert('Bitte beide Uhrzeiten eingeben.');
    }
  };
  container.appendChild(label);
  container.appendChild(timeDiv);
  container.appendChild(btn);
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Dialogfluss
function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo ğŸ‘‹ Ich bin dein Assistent fÃ¼r Fahrradstops. Was mÃ¶chtest du tun?', 'bot');
  addChoiceButtons(['ğŸ¥š Neue HÃ¼tte erstellen','ğŸ“‹ Meine HÃ¼tten anzeigen','ğŸ« Support Anfragen'], handleIntent);}
function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('support')) {
    addMessage('Hallo ğŸ‘‹', 'bot');
    ladeMeineSupportTickets();
    return;
  }

  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
    return;
  }

  if (txt.includes('neu')) {
    addMessage(`
      ğŸ›¡ï¸ <b>Bevor du deine HÃ¼tte eintrÃ¤gst, akzeptiere bitte die DatenschutzerklÃ¤rung:</b><br>
      <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
        <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
        <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">DatenschutzerklÃ¤rung</a>.</span>
      </label>
    `, 'bot', true);

    addChoiceButtons(['âœ… Zustimmen & Starten'], () => {
      const checkbox = document.getElementById('chat-datenschutz-zustimmung');
      if (!checkbox || !checkbox.checked) {
        alert('Bitte akzeptiere zuerst die DatenschutzerklÃ¤rung.');
        return;
      }

      step = 1;
      editingData = {
        zustimmungDatenschutz: {
          akzeptiert: true,
          am: new Date().toISOString()
        }
      };

      addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot');
    });

    return;
  }

  // Falls kein Befehl erkannt wurde
  addMessage('â“ Ich habe das leider nicht verstanden. Bitte wÃ¤hle eine Option aus.', 'bot');
  addChoiceButtons(['ğŸ¥š Neue HÃ¼tte erstellen','ğŸ“‹ Meine HÃ¼tten anzeigen','ğŸ« Support Anfragen'], handleIntent);
}
  
  /*function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
  }

  if (txt.includes('neu')) {
  addMessage(`
    ğŸ›¡ï¸ <b>Bevor du deine HÃ¼tte eintrÃ¤gst, akzeptiere bitte die DatenschutzerklÃ¤rung:</b><br>
    <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
      <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
      <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">DatenschutzerklÃ¤rung</a>.</span>
    </label>
  `, 'bot', true);

  addChoiceButtons(['âœ… Zustimmen & Starten'], () => {
    const checkbox = document.getElementById('chat-datenschutz-zustimmung');
    if (!checkbox || !checkbox.checked) {
      alert('Bitte akzeptiere zuerst die DatenschutzerklÃ¤rung.');
      return;
    }

    // Zustimmung speichern
    step = 1;
    editingData = {
      zustimmungDatenschutz: {
        akzeptiert: true,
        am: new Date().toISOString()
      }
    };

    addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot');
  });
  }
  if (txt.includes('support')) {
    ladeMeineSupportTickets();
  }
}*/
  
/*function handleIntent(input) {
  const txt = input.toLowerCase();
  if (txt.includes('meine')) {
    korrigiereFehlendeAbos().then(() => {
      showMyHuts();
    });
                             
  }
  if (txt.includes('neu')) {
    step = 1;
    editingData = {};
    addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot');
  }
}
*/
function processUserInput(txt) {
  if (step === 1) {
    editingData.name = txt;
    step = 2;
    addMessage('Hat deine HÃ¼tte SitzplÃ¤tze?', 'bot');
    addChoiceButtons(['Ja', 'Nein'], ans => {
      editingData.sitzplaetze = ans;
      step = 3;
      addMessage('Gibt es Strom?', 'bot');
      addChoiceButtons(['Ja', 'Nein'], strom => {
        editingData.strom = strom;
        step = 4;
        addMessage('Extras? (oder â€keineâ€œ)', 'bot');
      });
    });
    return;
  }
  if (step === 4) {
    editingData.extras = txt.toLowerCase() === 'keine' ? '' : txt;
    step = 5;
    addMessage('Wie lauten die Ã–ffnungszeiten?', 'bot');
    addChoiceButtons(['Immer geÃ¶ffnet', 'Von â€“ Bis angeben'], ans => {
      if (ans === 'Immer geÃ¶ffnet') {
        editingData.oeffnungszeiten = 'Immer geÃ¶ffnet';
        step = 6;
        showMap();
      } else {
        showTimePicker();
      }
    });
    return;
  }
}
// Neue Funktion mit Fallback
function updateAboInfoFallback(subId, el) {
  if (!el) return;

  if (!subId) {
    el.innerHTML = 'âš ï¸ Kein Abo vorhanden oder noch nicht abgeschlossen.';
    return;
  }

  getPayPalInfo(subId).then(info => {
    try {
      if (info?.status === 'ACTIVE' && info?.start_time) {
        const startDate = new Date(info.start_time);
        const testEnd = new Date(startDate);
        testEnd.setDate(testEnd.getDate() + 14);
        const now = new Date();
        const diff = Math.max(0, Math.ceil((testEnd - now) / (1000 * 60 * 60 * 24)));

        // Erfolgreich â€“ zeige Feuerwerk
        el.innerHTML = `
          <div class="relative">
            ğŸ† Testphase aktiv â€“ endet in ${diff} Tagen<br>
            <span class="text-xs text-gray-500">ğŸ”’ KÃ¼ndigung Ã¼ber dein PayPal-Konto.</span>
            <canvas id="firework-${subId}" style="position:absolute;left:0;top:0;width:100%;height:50px;pointer-events:none;"></canvas>
          </div>
        `;

        
      } else {
        el.innerHTML = 'âŒ Abo nicht aktiv oder wurde gekÃ¼ndigt.';
      }
    } catch (err) {
      console.warn('âš ï¸ PayPal-Parsing-Fehler:', err);
      el.innerHTML = 'âš ï¸ Testphase lÃ¤uft â€“ genaues Enddatum nicht verfÃ¼gbar.';
    }
  }).catch(err => {
    console.error('âŒ PayPal-Abo konnte nicht abgerufen werden:', err);
    el.innerHTML = 'âš ï¸ PayPal-Abo nicht abrufbar. Bitte spÃ¤ter erneut versuchen.';
  });
}
  async function checkAboStatus(hutId, hutData) {
  try {
    if (!hutData.paypalSubscriptionId) return;

    const info = await getPayPalInfo(hutData.paypalSubscriptionId);
    const status = info?.status;

    if (status !== 'ACTIVE') {
      // Abo ist nicht aktiv â†’ automatisch deaktivieren
      await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Abo Ã¼ber PayPal wurde gekÃ¼ndigt oder ist nicht aktiv',
        zeitpunkt: new Date()
      });
      addMessage(`âš ï¸ Die HÃ¼tte "${hutData.name}" wurde deaktiviert, da das Abo nicht mehr aktiv ist.`, 'bot');
    }
  } catch (error) {
    console.warn(`âš ï¸ Fehler beim Abo-Check fÃ¼r "${hutData.name}":`, error);

    // Fallback: PrÃ¼fe lokale Testzeit (wenn kein Zugriff auf PayPal mÃ¶glich)
    if (hutData.aboStart && hutData.status === 'angenommen') {
      const start = hutData.aboStart.toDate();
      const now = new Date();
      const testEnd = new Date(start);
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd) {
        await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
        await db.collection('eierhuetten').doc(hutId).collection('log').add({
          admin: 'System',
          feld: 'status',
          wert: 'abgelehnt',
          kommentar: 'Abo konnte nicht geprÃ¼ft werden â€“ Fallback: Testzeitraum Ã¼berschritten',
          zeitpunkt: new Date()
        });
        addMessage(`âš ï¸ Die HÃ¼tte "${hutData.name}" wurde deaktiviert, da keine Abo-Info abrufbar war und die Testzeit Ã¼berschritten ist.`, 'bot');
      }
    }
  }
  }

  async function analyseUndAktualisiereHuette(hutId, hutData) {
  const updates = {};
  let ablehnen = false;
  let grund = '';
  const now = new Date();

  try {
    // Wenn PayPal vorhanden â†’ prÃ¼fen
    if (hutData.paypalSubscriptionId) {
      const info = await getPayPalInfo(hutData.paypalSubscriptionId);
      const status = info?.status;

      if (status === 'ACTIVE') {
        // Automatisch ergÃ¤nzen, falls fehlt
        if (!hutData.aboStart) updates.aboStart = new Date();
        if (!hutData.aboMonate) updates.aboMonate = 1;
      } else {
        ablehnen = true;
        grund = 'PayPal-Abo inaktiv oder gekÃ¼ndigt.';
      }

    } else if (hutData.aboStart) {
      // Kein PayPal â†’ Testphase prÃ¼fen
      const testEnd = new Date(hutData.aboStart.toDate());
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd) {
        ablehnen = true;
        grund = 'Testphase abgelaufen. Kein aktives Abo.';
      }
    } else {
      // Weder Abo noch Testphase â†’ nicht anzeigen, aber keine Ablehnung
      return;
    }

    if (ablehnen && hutData.status === 'angenommen') {
      updates.status = 'abgelehnt';
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: grund,
        zeitpunkt: now
      });
      addMessage(`âŒ Deine HÃ¼tte â€${hutData.name}â€œ wurde deaktiviert: ${grund}`, 'bot');
    }

    if (Object.keys(updates).length > 0) {
      await db.collection('eierhuetten').doc(hutId).update(updates);
    }

  } catch (err) {
    console.error('ğŸ›‘ Fehler bei Analyse der HÃ¼tte:', hutId, err);

    // Optionaler Fallback
    if (hutData.aboStart) {
      const testEnd = new Date(hutData.aboStart.toDate());
      testEnd.setDate(testEnd.getDate() + 14);
      if (now > testEnd && hutData.status === 'angenommen') {
        await db.collection('eierhuetten').doc(hutId).update({ status: 'abgelehnt' });
        addMessage(`âš ï¸ Deine HÃ¼tte â€${hutData.name}â€œ wurde vorsorglich deaktiviert. Abo konnte nicht geprÃ¼ft werden.`, 'bot');
      }
    }
  }
  }

  async function korrigiereFehlendeAbos() {
  const snapshot = await db.collection('eierhuetten')
    .where('userId', '==', currentUser.uid)
    .where('status', '==', 'angenommen')
    .get();

  snapshot.forEach(async (doc) => {
    const d = doc.data();
    const id = doc.id;

    const keinAbo = !d.aboStart && !d.paypalSubscriptionId;

    if (keinAbo) {
      await db.collection('eierhuetten').doc(id).update({
        status: 'abgelehnt'
      });

      await db.collection('eierhuetten').doc(id).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Automatisch deaktiviert: Kein Abo oder Testphase',
        zeitpunkt: new Date()
      });

      console.warn(`âŒ HÃ¼tte "${d.name}" wurde automatisch deaktiviert wegen fehlendem Abo/Test.`);
    }
  });
}
  /*
async function uploadToImgBB(file, onProgress) {
  const apiKey = '5df04de9bfd2776f101329be4193e44c';

  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      const formData = new FormData();
      formData.append('key', apiKey);
      formData.append('image', base64);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://api.imgbb.com/1/upload');

      xhr.upload.onprogress = (e) => {
        if (onProgress && e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          onProgress(percent);
        }
      };

      xhr.onload = () => {
        try {
          const json = JSON.parse(xhr.responseText);
          if (json.success && json.data?.url && json.data?.delete_url) {
            resolve({
              url: json.data.url,
              delete_url: json.data.delete_url
            });
          } else {
            reject('Fehlerhafte Antwort von imgbb: ' + JSON.stringify(json));
          }
        } catch (err) {
          reject('Antwort konnte nicht geparst werden');
        }
      };

      xhr.onerror = () => reject('Netzwerkfehler beim Upload');
      xhr.send(formData);
    };

    reader.onerror = () => reject('Fehler beim Lesen der Datei');
    reader.readAsDataURL(file);
  });
}*/
  async function uploadToImgBB(file, onProgress) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async () => {
      const base64 = reader.result.split(',')[1];
      const body = new URLSearchParams();
      body.append('key', '5df04de9bfd2776f101329be4193e44c');
      body.append('image', base64);

      try {
        const res = await fetch('https://api.imgbb.com/1/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body
        });

        const json = await res.json();

        if (json.success && json.data?.url && json.data?.delete_url) {
          resolve({
            url: json.data.url,
            delete_url: json.data.delete_url,
            status: 'wartet'
          });
        } else {
          reject('Upload erfolgreich, aber delete_url fehlt: ' + JSON.stringify(json));
        }
      } catch (err) {
        reject('Upload-Fehler: ' + err.message);
      }
    };

    reader.onerror = () => reject('Fehler beim Lesen der Datei');
    reader.readAsDataURL(file);
  });
  }
// Standortwahl

const filterStatus = true; // oder abhÃ¤ngig von UI-Einstellungen
async function showMyHuts() {
  chatWindow.innerHTML = '';

  const snapshot = await db.collection('eierhuetten')
  .where('userId', '==', currentUser.uid)
  .get();

const docs = snapshot.docs.filter(doc => {
  const status = doc.data().status;
  return status !== "archiviert" || typeof status === "undefined";
});
  
  if (snapshot.empty) return addMessage('Du hast noch keine HÃ¼tten.', 'bot');

  let total = 0, angenommen = 0, offen = 0, abosAktiv = 0;

  docs.forEach(doc => {
    const d = doc.data();
    total++;
    if (d.status === 'angenommen') angenommen++;
    if (d.status === 'offen') offen++;
    if (d.paypalSubscriptionId) abosAktiv++;
  });
//addMessage(`â— Deine HÃ¼tte "${total}"`, 'bot');

  // Statistik-Balken
  const statsBar = document.createElement('div');
  statsBar.className = 'flex justify-around items-center text-sm bg-green-100 text-green-900 py-2 px-4 rounded mb-3 shadow-sm border border-green-300';
  statsBar.innerHTML = `
    <div title="Eingereichte HÃ¼tten">ğŸ¥š <strong>${total}</strong>/10</div>
    <div title="Angenommen">âœ… <strong>${angenommen}</strong></div>
    <div title="Offen">â³ <strong>${offen}</strong></div>
    <div title="Abos aktiv">ğŸ’³ <strong>${abosAktiv}</strong></div>
  `;
  chatWindow.appendChild(statsBar);

  // Jetzt jede HÃ¼tte rendern
  docs.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const div = document.createElement('div');
    div.className = 'message bot';

    const now = new Date();
    let aboInfo = '';
    let shouldReject = false;

    // Nachtrag fehlender Abo-Werte
    if (d.paypalSubscriptionId && !d.aboMonate) {
      db.collection('eierhuetten').doc(id).update({ aboMonate: 1 });
      d.aboMonate = 1;
    }
    if (d.status === 'angenommen' && !d.aboStart && d.paypalSubscriptionId) {
      const now = new Date();
      db.collection('eierhuetten').doc(id).update({
        aboStart: firebase.firestore.Timestamp.fromDate(now)
      });
      d.aboStart = firebase.firestore.Timestamp.fromDate(now);
    }

    // Abo prÃ¼fen
    if (d.aboStart && d.aboMonate) {
      const start = d.aboStart.toDate();
      const end = new Date(start);
      end.setMonth(end.getMonth() + d.aboMonate);
      const diffTage = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
      if (diffTage > 0) {
        aboInfo = `ğŸ’³ Abo aktiv bis: ${end.toLocaleDateString()} (noch ${diffTage} Tage)`;
      } else {
        aboInfo = 'ğŸ’³ Abo abgelaufen';
        if (d.status === 'angenommen') shouldReject = true;
      }
    }

    if (shouldReject) {
      db.collection('eierhuetten').doc(id).update({ status: 'abgelehnt' });
      db.collection('eierhuetten').doc(id).collection('log').add({
        admin: 'System',
        feld: 'status',
        wert: 'abgelehnt',
        kommentar: 'Abo oder Testphase abgelaufen',
        zeitpunkt: new Date()
      });
      addMessage(`âš ï¸ Die HÃ¼tte "${d.name}" wurde deaktiviert.`, 'bot');
    }

    const paypalContainerId = `paypal-button-new-${id}`;
    const minimapId = `minimap-${id}`;

    div.innerHTML = `
      <div class="text-sm space-y-2">
        <div class='font-bold'>${d.name}</div>
        <div class='font-bold'>ğŸ“Œ Status: ${d.status}</div>
        <div>${aboInfo}</div>

        ${d.status === 'angenommen' ? `
          <label>ğŸ“ Name:<br>
            <input type='text' data-id='${id}' class='edit-name w-full border px-2 py-1 rounded' value='${d.name}' />
          </label><br>

          <label>ğŸª‘ SitzplÃ¤tze:
            <select data-id='${id}' class='edit-sitz border rounded px-2 py-1 ml-2'>
              <option ${d.sitzplaetze === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.sitzplaetze === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>ğŸ”Œ Strom:
            <select data-id='${id}' class='edit-strom border rounded px-2 py-1 ml-2'>
              <option ${d.strom === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.strom === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>âœ¨ Extras:<br>
            <input type='text' data-id='${id}' class='edit-extras w-full border px-2 py-1 rounded' value='${d.extras || ''}' />
          </label><br>

          <label>ğŸ•’ Ã–ffnungszeiten:<br>
            <input type='text' data-id='${id}' class='edit-zeiten w-full border px-2 py-1 rounded' value='${d.oeffnungszeiten || ''}' />
          </label><br>

          <button class='edit-btn' onclick='saveEdit("${id}")'>ğŸ’¾ Speichern</button>
          <button class='delete-btn' onclick='deleteHut("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
        ` : `
          <div class="text-gray-500 italic">â›” Nur nach Freigabe bearbeitbar.</div>
          <button class='delete-btn' onclick='deleteHut("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
   
        `}

        <!-- Bildergalerie -->
        ${Array.isArray(d.fotos) && d.fotos.length ? `
          <div class='flex flex-col gap-2 mt-2'>
            ${d.fotos.map(img => {
              const isString = typeof img === 'string';
              const url = isString ? img : img.url;
              const del = isString ? '' : (img.delete_url || '');
              const status = isString ? 'freigegeben' : (img.status || 'freigegeben');
              const pending = status === 'wartet';
              return `
                <div class="flex items-center gap-4 bg-gray-50 p-2 rounded border relative">
                  <div class="relative group">
                    <img src="${url}" class="h-20 w-20 object-cover rounded shadow ${pending ? 'opacity-50' : ''}"/>
                    ${!pending ? `
                      <button onclick="deleteImage('${id}', '${url}', '${del}')" 
                        class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-1 opacity-0 group-hover:opacity-100 transition">
                        âœ•
                      </button>
                    ` : ''}
                  </div>
                  <div class="flex-1 text-xs break-all text-gray-600">
                    <div><strong>Status:</strong> ${pending ? '<span class="text-orange-600">â³ wartet</span>' : 'âœ… frei'}</div>
                    <div><strong>Delete:</strong><br><code>${del || '-'}</code></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}

        <!-- Upload -->
        <label class="block mt-2 text-sm">ğŸ“· Neues Bild:
          <input type="file" accept="image/*" data-id="${id}" class="upload-image mt-1" />
        </label>
        <div id="progress-${id}" class="h-2 bg-gray-200 rounded hidden mt-2">
          <div class="h-2 bg-green-500 rounded" style="width: 0%"></div>
        </div>

        <!-- Mini-Map -->
        <div id="${minimapId}" class="minimap h-40 mt-2 rounded border"></div>

        <!-- Abo -->
        ${d.aboStart && d.paypalSubscriptionId ? `
          <details class="bg-blue-50 border border-blue-200 rounded p-2 my-2 text-sm">
            <summary class="cursor-pointer">ğŸ’³ Abo-Informationen</summary>
            <div><strong>Start:</strong> ${d.aboStart?.toDate?.().toLocaleDateString("de-DE") || '-'}</div>
            <div><strong>PayPal-ID:</strong> ${d.paypalSubscriptionId}</div>
            <div><strong>Status:</strong> aktiv</div>
            ${Array.isArray(d.aboHistory) && d.aboHistory.length ? `
              <div class="mt-2"><strong>Zahlungsverlauf:</strong>
                <ul class="list-disc ml-5 text-xs">
                  ${d.aboHistory.map(e => `
                    <li>${new Date(e.zeitpunkt?.seconds * 1000).toLocaleDateString("de-DE")} â€“ ${e.betrag}â€¯â‚¬ via ${e.methode}</li>
                  `).join('')}
                </ul>
              </div>
            ` : '<div class="text-xs text-gray-500 mt-2 italic">Kein Verlauf vorhanden.</div>'}
          </details>
        ` : `
          <div class="my-2 text-sm">
            <strong>ğŸ’³ Kein aktives Abo</strong><br>
            <div id="${paypalContainerId}" class="my-2"></div>
          </div>
        `}
      </div>
    `;
    chatWindow.appendChild(div);

    // PayPal-Button nur anzeigen wenn kein aktives Abo
    if (!d.aboStart || !d.paypalSubscriptionId) {
      setTimeout(() => {
        paypal.Buttons({
          style: { shape: 'pill', layout: 'horizontal', color: 'blue' },
          createSubscription: (data, actions) => {
            return actions.subscription.create({ plan_id: 'P-144846983Y921400TNCFA3PA' });
          },
          onApprove: (data, actions) => {
            db.collection('eierhuetten').doc(id).update({
              paypalSubscriptionId: data.subscriptionID,
              aboStart: new Date(),
              aboMonate: 1
            }).then(() => showMyHuts());
          }
        }).render(`#${paypalContainerId}`);
      }, 500);
    }

    // Mini-Map aktivieren
    if (d.location?.latitude && d.location?.longitude) {
      setTimeout(() => {
        const m = L.map(minimapId, { zoomControl: true }).setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);

        const marker = L.marker([d.location.latitude, d.location.longitude], {
          draggable: d.status === 'angenommen'
        }).addTo(m);

        if (d.status === 'angenommen') {
          marker.on('dragend', e => {
            const pos = e.target.getLatLng();
            db.collection('eierhuetten').doc(id).update({
              location: new firebase.firestore.GeoPoint(pos.lat, pos.lng)
            }).then(() => {
              addMessage(`ğŸ“ Neuer Standort fÃ¼r "${d.name}" gespeichert.`, 'bot');
            });
          });
        }
      }, 300);
    }
  });
}



function saveEdit(id) {
  const name = document.querySelector(`.edit-name[data-id='${id}']`).value;
  const sitz = document.querySelector(`.edit-sitz[data-id='${id}']`).value;
  const strom = document.querySelector(`.edit-strom[data-id='${id}']`).value;
  const extras = document.querySelector(`.edit-extras[data-id='${id}']`).value;
  const zeiten = document.querySelector(`.edit-zeiten[data-id='${id}']`).value;
  db.collection('eierhuetten').doc(id).update({
    name,
    sitzplaetze: sitz,
    strom,
    extras,
    oeffnungszeiten: zeiten
  }).then(() => addMessage('âœ… Ã„nderungen gespeichert.', 'bot'));
}

/*function deleteHut(id) {
  if (confirm('MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')) {
    db.collection('eierhuetten').doc(id).delete().then(() => {
      addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.', 'bot');
      korrigiereFehlendeAbos().then(() => {
 
        showMyHuts();
      });
    });
  }
}*/
  /*function deleteHut(id) {
  if (!confirm('MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')) return;

  // Schritt 1: Hole die HÃ¼tte inkl. PayPal-Abo
  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('âŒ HÃ¼tte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();

    // Schritt 2: PrÃ¼fe, ob ein Abo besteht
    if (hut.paypalSubscriptionId) {
      addMessage('ğŸ”„ KÃ¼ndige PayPal-Abo...', 'bot');

      // Schritt 3: Cloud-Funktion aufrufen
      //const cancelFn = firebase.functions().httpsCallable('cancelPaypalSubscription');
  const functions = firebase.app().functions('europe-west1');
const cancelFn = functions.httpsCallable('cancelPaypalSubscription');
      
      cancelFn({ subscriptionId: hut.paypalSubscriptionId }).then(result => {
        if (result.data.success) {
          addMessage('âœ… Abo erfolgreich gekÃ¼ndigt.', 'bot');

          // Schritt 4: HÃ¼tte lÃ¶schen
          db.collection('eierhuetten').doc(id).delete().then(() => {
            addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.', 'bot');
            korrigiereFehlendeAbos().then(() => showMyHuts());
          });
        } else {
          addMessage('âŒ Abo konnte nicht gekÃ¼ndigt werden.', 'bot');
        }
      }).catch(err => {
        console.error('âŒ Fehler bei KÃ¼ndigung:', err.message || err);
        addMessage('âŒ Fehler beim KÃ¼ndigen des Abos.', 'bot');
      });

    } else {
      // Kein Abo vorhanden â†’ einfach lÃ¶schen
      db.collection('eierhuetten').doc(id).delete().then(() => {
        addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.', 'bot');
        korrigiereFehlendeAbos().then(() => showMyHuts());
      });
    }
  });
}*/
/*
 function deleteHut(id) {
  if (!confirm('MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')) return;

  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('âŒ HÃ¼tte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();

    // PrÃ¼fen, ob Abo existiert
    if (hut.paypalSubscriptionId) {
      addMessage('ğŸ”„ KÃ¼ndige PayPal-Abo...', 'bot');
      console.log('â¡ï¸ Sende Abo-KÃ¼ndigung fÃ¼r:', hut.paypalSubscriptionId);

      // Anfrage an HTTP-Cloud-Function (onRequest)
      fetch('https://us-central1-eierhuettentour.cloudfunctions.net/cancelPaypalSubscription', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ subscriptionId: hut.paypalSubscriptionId })
})
.then(async response => {
  if (!response.ok) {
    // Versuche Fehlerinhalt zu lesen
    let errorText = await response.text();
    try {
      const errorJson = JSON.parse(errorText);
      throw new Error(errorJson.error || 'Unbekannter Fehler bei KÃ¼ndigung');
    } catch {
      throw new Error(errorText);
    }
  }

  // JSON auslesen, wenn Status OK
  const result = await response.json();
  if (result.success) {
    addMessage('âœ… Abo erfolgreich gekÃ¼ndigt.', 'bot');
    console.log('âœ… KÃ¼ndigung erfolgreich');

    // Danach HÃ¼tte lÃ¶schen
    db.collection('eierhuetten').doc(id).delete().then(() => {
      addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.', 'bot');
      korrigiereFehlendeAbos().then(() => showMyHuts());
    });
  } else {
    console.error('âŒ Fehler bei KÃ¼ndigung:', result.error || result);
    addMessage('âŒ Fehler bei KÃ¼ndigung: ' + (result.error || 'Unbekannt'), 'bot');
  }
})
.catch(err => {
  console.error('âŒ Fehler bei KÃ¼ndigung:', err.message || err);
  addMessage('âŒ Fehler bei KÃ¼ndigung: ' + (err.message || 'Unbekannt'), 'bot');
});


    } else {
      // Kein Abo â†’ direkt lÃ¶schen
      db.collection('eierhuetten').doc(id).delete().then(() => {
        addMessage('ğŸ—‘ï¸ HÃ¼tte gelÃ¶scht.', 'bot');
        korrigiereFehlendeAbos().then(() => showMyHuts());
      });
    }
  }).catch(err => {
    console.error('âŒ Fehler beim Abrufen der HÃ¼tte:', err.message || err);
    addMessage('âŒ Fehler beim LÃ¶schen der HÃ¼tte.', 'bot');
  });
}*/



function deleteHut(id) {
  if (!confirm('â— MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')) return;

  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      addMessage('âŒ HÃ¼tte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();
    const user = firebase.auth().currentUser;

    if (!hut.paypalSubscriptionId) {
      addMessage(
        `âš ï¸ Es wurde keine PayPal-Abo-ID fÃ¼r diese HÃ¼tte gefunden.<br><br>
         Wenn du trotzdem ein Abo vermutest, <a href='#' onclick='zeigeSupportFormularMitVorschlag(\`Ich mÃ¶chte die HÃ¼tte \\\"${hut.name || 'Unbekannt'}\\\" lÃ¶schen, aber es ist keine PayPal-Abo-ID gespeichert. Bitte prÃ¼ft, ob ein aktives Abo besteht.\`)'>kontaktiere den Support</a>.`,
        'bot'
      );

      if (confirm("â“ Es wurde keine Abo-ID gefunden. Trotzdem archivieren?")) {
        db.collection('eierhuetten').doc(id).update({
          status: "archiviert",
          archiviertAm: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          addMessage('ğŸ—ƒï¸ HÃ¼tte wurde archiviert und ist fÃ¼r dich nicht mehr sichtbar.', 'bot');
          korrigiereFehlendeAbos().then(() => showMyHuts());
        });
      } else {
        addMessage("âŒ HÃ¼tte wurde nicht archiviert.", "bot");
      }
      return;
    }

    addMessage('ğŸ”„ Versuche, dein PayPal-Abo zu kÃ¼ndigen...', 'bot');
    const functions = firebase.app().functions('us-central1');
    const cancelFn = functions.httpsCallable('cancelPaypalSubscription');

    cancelFn({ subscriptionId: hut.paypalSubscriptionId }).then(result => {
      if (result.data && result.data.success) {
        addMessage('âœ… Abo erfolgreich gekÃ¼ndigt.', 'bot');
        db.collection('eierhuetten').doc(id).update({
          status: "archiviert",
          archiviertAm: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          addMessage('ğŸ—ƒï¸ HÃ¼tte wurde archiviert und ist fÃ¼r dich nicht mehr sichtbar.', 'bot');
          korrigiereFehlendeAbos().then(() => showMyHuts());
        });

      } else {
        addMessage('âš ï¸ Abo konnte nicht gekÃ¼ndigt werden. Die HÃ¼tte wurde NICHT gelÃ¶scht.', 'bot');
        frageSupportBeiAboProblem(user, hut);
      }
    }).catch(err => {
      console.error('âŒ Fehler bei KÃ¼ndigung:', err.message || err);
      addMessage('âŒ Fehler beim KÃ¼ndigen. Die HÃ¼tte wurde NICHT gelÃ¶scht.', 'bot');
      frageSupportBeiAboProblem(user, hut);
    });
  });
}

function frageSupportBeiAboProblem(user, hut) {
  const vorschlag = `Ich mÃ¶chte die HÃ¼tte "${hut.name || 'Unbekannt'}" lÃ¶schen, aber das PayPal-Abo (ID: ${hut.paypalSubscriptionId}) konnte nicht automatisch gekÃ¼ndigt werden.`;

  addMessage(
  `âŒ Die automatische KÃ¼ndigung deines PayPal-Abos ist fehlgeschlagen.<br><br>
   ğŸ‘‰ <a href="#" id="supportLink">Support kontaktieren</a>`,
  'bot',
  true
);

setTimeout(() => {
  const link = document.getElementById('supportLink');
  if (link) {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      zeigeSupportFormularMitVorschlag(vorschlag);
    });
  }
}, 100);
}

function zeigeSupportFormularMitVorschlag(vorlage) {
  const nutzerZusatzeingabe = prompt(
    `ğŸ†˜ Support-Anfrage\n\nWir haben folgendes fÃ¼r dich vorbereitet:\n\n${vorlage}\n\nDu kannst hier noch optional etwas hinzufÃ¼gen:`
  );

  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage("ğŸš« Du musst eingeloggt sein, um den Support zu kontaktieren.", "bot");
    return;
  }

  const gesamttext = nutzerZusatzeingabe && nutzerZusatzeingabe.trim().length > 0
    ? `${vorlage}\n\nZusatz des Nutzers:\n${nutzerZusatzeingabe.trim()}`
    : vorlage;

  db.collection("supportTickets").add({
    userId: user.uid,
    email: user.email,
    message: gesamttext,
    status: "offen",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    addMessage("âœ… Deine Support-Anfrage wurde gesendet. Wir kÃ¼mmern uns darum!", "bot");
  }).catch(err => {
    console.error("âŒ Fehler beim Senden:", err);
    addMessage("âš ï¸ Es gab ein Problem beim Senden deiner Anfrage. Bitte versuche es spÃ¤ter erneut.", "bot");
  });
}




async function deleteImage(hutId, imageUrl, deleteUrl) {
  if (!confirm('â— MÃ¶chtest du dieses Bild wirklich lÃ¶schen?')) return;

  try {
    // 1. Firestore-Eintrag laden
    const docRef = db.collection('eierhuetten').doc(hutId);
    const doc = await docRef.get();
    if (!doc.exists) return alert('âŒ HÃ¼tte nicht gefunden.');

    const data = doc.data();
    const fotos = (data.fotos || []).filter(img => img.url !== imageUrl);

    // 2. Firestore updaten
    await docRef.update({ fotos });

    // 3. Optional: Bild bei imgbb lÃ¶schen
    if (deleteUrl) {
      await fetch(deleteUrl, { method: 'GET' });
      console.log('âœ… Bild bei imgbb gelÃ¶scht');
    }

    // 4. UI neu laden
    addMessage('âœ… Bild wurde gelÃ¶scht.', 'bot');
    showMyHuts();

  } catch (err) {
    console.error('âŒ Fehler beim LÃ¶schen:', err);
    alert('âŒ Fehler beim LÃ¶schen des Bildes.');
  }
}
async function submitNewHut() {
/* const zustimmung = document.getElementById('datenschutz-zustimmung');
  if (!zustimmung.checked) {
    alert('â— Bitte bestÃ¤tige die DatenschutzerklÃ¤rung, um fortzufahren.');
    return;
  }*/
  
  if (!editingData.name || !editingData.location) {
    addMessage('âŒ Bitte gib alle Daten ein (mindestens Name und Standort).', 'bot');
    return;
  }

  // ğŸ”’ Sicherheit: Nur gÃ¼ltige Bilder Ã¼bernehmen (mit url UND delete_url)
  const validFotos = (editingData.fotos || []).filter(f =>
    typeof f === 'object' &&
    f.url &&
    f.delete_url
  );

  const hut = {
    ...editingData,
    userId: currentUser.uid,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'offen',
    fotos: validFotos,
    aboMonate: 1,
    paypalSubscriptionId: null,
    datenschutzZustimmung: {
       bestÃ¤tigtAm: firebase.firestore.FieldValue.serverTimestamp(),
       durch: firebase.auth().currentUser?.email || "Gast"
    }
  };

  console.log('ğŸ“¸ Fotos werden gespeichert:', JSON.stringify(hut.fotos));

  try {
    const docRef = await db.collection('eierhuetten').add(hut);
    addMessage('ğŸ‰ Deine HÃ¼tte wurde erfolgreich erstellt.', 'bot');
    addMessage('ğŸ’³ Du kannst jetzt dein 14-tÃ¤giges Testabo starten. Erst danach wird deine HÃ¼tte sichtbar.', 'bot');

    const paypalDiv = document.createElement('div');
    paypalDiv.id = `paypal-button-new-${docRef.id}`;
    paypalDiv.className = 'my-2';
    chatWindow.appendChild(paypalDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    if (typeof paypal !== 'undefined') {
      paypal.Buttons({
        style: {
          shape: 'pill',
          color: 'blue',
          layout: 'horizontal',
          label: 'subscribe'
        },
        createSubscription: function (data, actions) {
          return actions.subscription.create({
            plan_id: 'P-144846983Y921400TNCFA3PA'
          });
        },
        onApprove: function (data, actions) {
          db.collection('eierhuetten').doc(docRef.id).update({
            paypalSubscriptionId: data.subscriptionID,
            aboStart: new Date(),
            aboMonate: 1,
            status: 'angenommen'
          }).then(() => {
            addMessage('âœ… Abo erfolgreich gestartet! Deine HÃ¼tte ist freigeschaltet.', 'bot');
            setTimeout(() => {
              showMyHuts();
              startDialog();
            }, 5000);
          });
        }
      }).render(`#paypal-button-new-${docRef.id}`);
    } else {
      addMessage('âš ï¸ PayPal SDK nicht geladen. Button konnte nicht angezeigt werden.', 'bot');
      setTimeout(() => startDialog(), 1500);
    }

    // Reset
    step = 0;
    editingData = {};

  } catch (err) {
    addMessage('âŒ Fehler beim Erstellen der HÃ¼tte: ' + err.message, 'bot');
    setTimeout(() => startDialog(), 1500);
  }
}
// Authentifizierung
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    if (!localStorage.getItem("tutorialDone")) {
      showTutorial();
  localStorage.setItem("tutorialDone", "true");
  }else{
    
    startDialog();
    }
  }
});
document.getElementById('google-login').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      const user = result.user;
      checkConsent(user);
    })
    .catch(error => {
      console.error('Login fehlgeschlagen:', error);
    });
};
sendBtn.addEventListener('click', () => {
  const val = chatInput.value.trim();
  if (!val) return;
  addMessage(val, 'user');
  chatInput.value = '';
  processUserInput(val);
});
chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendBtn.click();
});
  function checkConsent(user) {
  const consentGiven = localStorage.getItem('consentGiven');

  if (consentGiven === 'true') {
    startApp(user);
    return;
  }

  const modal = document.getElementById('consent-modal');
  modal.style.display = 'flex';

  document.getElementById('consent-accept').onclick = async () => {
    const privacyChecked = document.getElementById('consent-privacy').checked;
    const cookiesChecked = document.getElementById('consent-cookies').checked;

    if (!privacyChecked || !cookiesChecked) {
      alert('Bitte beide KÃ¤stchen ankreuzen, um fortzufahren.');
      return;
    }

    localStorage.setItem('consentGiven', 'true');

    // Optional: In Firestore dokumentieren
    await db.collection('consents').doc(user.uid).set({
      privacy: true,
      cookies: true,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    modal.style.display = 'none';
    startApp(user);
  };
    }

function showMap() {
  const container = document.createElement('div');
  container.className = 'message bot';
  container.innerHTML = `<div class="font-bold mb-1">ğŸ“ Bitte wÃ¤hle den Standort deiner HÃ¼tte:</div><div id="map"></div>`;
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    setTimeout(() => {
      map = L.map('map').setView([latitude, longitude], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

      marker.on('dragend', e => {
        const pos = e.target.getLatLng();
        editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
      });

      // Erste Position speichern
      editingData.location = new firebase.firestore.GeoPoint(latitude, longitude);

      // Weiter-Button
      // Weiter-Button mit Upload-Option
const btn = document.createElement('button');
btn.className = 'choice-btn mt-2';
btn.textContent = 'âœ… Weiter zu Bilderupload';
btn.onclick = () => {
  container.remove();
  askForImageUpload(); // â¬…ï¸ NÃ¤chster Schritt
};
container.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 100);
  }, () => {
    addMessage('âŒ Standort konnte nicht ermittelt werden.', 'bot');
  });
}
  function initImageUpload() {
  document.querySelectorAll(".upload-image").forEach(input => {
    input.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      const id = e.target.dataset.id;
      if (!file || !id) return;

      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(`eierhuetten/${id}/${Date.now()}_${file.name}`);
      const uploadTask = fileRef.put(file);

      const progressBar = document.querySelector(`#progress-${id}`);
      const progressFill = progressBar?.firstElementChild;

      if (progressBar) progressBar.classList.remove("hidden");

      uploadTask.on("state_changed",
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          if (progressFill) progressFill.style.width = `${progress.toFixed(0)}%`;
        },
        (error) => {
          console.error("âŒ Upload-Fehler:", error);
          addMessage("âŒ Fehler beim Hochladen des Bildes.", "bot");
        },
        async () => {
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          // ğŸ“ URL in die Datenbank einfÃ¼gen
          const hutRef = db.collection("eierhuetten").doc(id);
          await hutRef.update({
            fotos: firebase.firestore.FieldValue.arrayUnion(url)
          });
          addMessage("âœ… Bild erfolgreich hochgeladen.", "bot");
          showMyHuts(); // Seite aktualisieren
        }
      );
    });
  });
  }
function askForImageUpload() {
  addMessage('ğŸ“· MÃ¶chtest du Fotos deiner HÃ¼tte hochladen?', 'bot');
  addChoiceButtons(['Ja, Bilder auswÃ¤hlen', 'Nein, direkt speichern'], antwort => {
    if (antwort.includes('Nein')) {
      submitNewHut(); // ohne Bilder
    } else {
      const uploadInput = document.getElementById('image-upload');
      uploadInput.onchange = async () => {
        const files = Array.from(uploadInput.files);
        if (files.length === 0) return submitNewHut();

        addMessage(`â³ Lade ${files.length} Bild(er) hoch...`, 'bot');
        const uploads = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();

          const base64 = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject('âŒ Fehler beim Lesen der Datei.');
            reader.readAsDataURL(file);
          });

          try {
            const formData = new FormData();
            formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // dein imgbb Key
            formData.append('image', base64);

            const res = await fetch('https://api.imgbb.com/1/upload', {
              method: 'POST',
              body: formData
            });

            const json = await res.json();

            if (json?.data?.url && json?.data?.delete_url) {
              uploads.push({
                url: json.data.url,
                delete_url: json.data.delete_url,
                status: 'wartet'
                
              });
            } else {
              console.warn('âŒ Upload war unvollstÃ¤ndig oder fehlerhaft:', json);
              addMessage(`âŒ Fehler beim Hochladen von Bild ${i + 1}`, 'bot');
            }

          } catch (err) {
            console.error(err);
            addMessage(`âŒ Upload-Fehler: ${err}`, 'bot');
          }
        }

        editingData.fotos = uploads;  // Wichtig: hier speicherst du die vollstÃ¤ndigen Objekte!
        addMessage('âœ… Bilder wurden erfolgreich hochgeladen.', 'bot');
        submitNewHut();
      };
      uploadInput.click();
    }
  });
}
document.body.addEventListener('change', async e => {
  if (e.target.classList.contains('upload-image')) {
    const file = e.target.files[0];
    const hutId = e.target.dataset.id;
    const progressBar = document.querySelector(`#progress-${hutId}`);
    const progressInner = progressBar?.firstElementChild;

    if (!file || !hutId || !progressBar || !progressInner) return;

    try {
      progressBar.classList.remove('hidden');
      progressInner.style.width = "30%";

      const imageData = await uploadToImgBB(file, percent => {
        progressInner.style.width = `${percent}%`;
      });

      progressInner.style.width = "100%";

      await db.collection("eierhuetten").doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(imageData) // âœ… Korrekt: ganzes Objekt
      });

      addMessage("âœ… Bild erfolgreich hochgeladen.", "bot");
      showMyHuts();
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      addMessage("âŒ Upload fehlgeschlagen: " + err, "bot");
    } finally {
      e.target.value = '';
      setTimeout(() => {
        progressBar.classList.add('hidden');
        progressInner.style.width = "0%";
      }, 2000);
    }
  }
});


  // Warten bis DOM geladen ist
  document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    // Nicht eingeloggt
    return;
  }

  const consentGiven = localStorage.getItem('consentGiven');
  if (consentGiven === 'true') {
    startApp(user);
  } else {
    checkConsent(user);
  }
});
    });

function startApp(user) {
  const nameEl = document.getElementById('user-name');
  const topbar = document.getElementById('topbar');

  nameEl.textContent = user.displayName || user.email || 'Unbekannt';
  topbar.style.display = 'flex';
}
  
  
function logout() {
  firebase.auth().signOut().then(() => {
    location.reload(); // Seite neu laden nach Logout
  }).catch(error => {
    alert('Fehler beim Abmelden: ' + error.message);
  });
}
function goToMainPage() {
  window.location.href = '/'; // Passe ggf. die URL an (z.â€¯B. '/index.html')
}
function refresh() {
  location.reload(); // â¬…ï¸ Das lÃ¤dt die gesamte Seite neu
}
/*async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage('âš ï¸ Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  const snapshot = await db.collection('supportTickets')
    .where('userId', '==', user.uid)
    .orderBy('createdAt', 'desc')
    .limit(10)
    .get();

  if (snapshot.empty) {
    addMessage('ğŸ“­ Du hast noch keine Support-Anfragen gestellt.', 'bot');
    return;
  }

  addMessage(`ğŸ“¨ Hier sind deine letzten Support-Anfragen:`, 'bot');

  snapshot.forEach(doc => {
    const t = doc.data();
    const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
    const status = t.status || 'offen';
    const message = t.message || '(leer)';

    addMessage(`
      <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
        <div><strong>ğŸ“… ${datum}</strong></div>
        <div class="mt-1">ğŸ’¬ ${message}</div>
        <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
      </div>
    `, 'bot', true);
  });
}*/
async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  console.log('ğŸ” Aktueller Nutzer:', user);

  if (!user) {
    addMessage('âš ï¸ Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  try {
    const ref = db.collection('supportTickets')
      .where('userId', '==', user.uid)
      //.orderBy('createdAt', 'desc')
      .limit(10);

    console.log('ğŸ“¤ Firestore-Query:', ref);

    const snapshot = await ref.get();
    console.log('ğŸ“¥ Gefundene Tickets:', snapshot.size);

    if (snapshot.empty) {
      addMessage('ğŸ“­ Du hast noch keine Support-Anfragen gestellt.', 'bot');
      return;
    }

    addMessage(`ğŸ“¨ Hier sind deine letzten Support-Anfragen:`, 'bot');

    snapshot.forEach(doc => {
      const t = doc.data();
      console.log('ğŸ“„ Ticket:', t);

      const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const status = t.status || 'offen';
      const message = t.message || '(leer)';

      addMessage(`
        <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
          <div><strong>ğŸ“… ${datum}</strong></div>
          <div class="mt-1">ğŸ’¬ ${message}</div>
          <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
        </div>
      `, 'bot', true);
    });
  } catch (err) {
    console.error('âŒ Fehler beim Laden der Tickets:', err);
    addMessage('âŒ Fehler beim Abrufen deiner Tickets. Bitte spÃ¤ter erneut versuchen.', 'bot');
  }
}
  function showTutorial() {
  chatWindow.innerHTML = '';
  addMessage('ğŸ‘‹ Moin moin! Ich bin dein Assistent fÃ¼r Fahrradstops.');
  addMessage('ğŸ“Œ Hier kannst du deine Fahrrad-HÃ¼tte eintragen, verwalten und sichtbar machen.');
  
  setTimeout(() => {
    addMessage('ğŸ’¬ Du sprichst mit mir Ã¼ber den Chat. WÃ¤hle einfach eine Option oder antworte manuell.');
  }, 1000);

  setTimeout(() => {
    addMessage('ğŸ†“ Jede neue HÃ¼tte startet mit einer kostenlosen 14-Tage-Testphase.');
  }, 4000);

  setTimeout(() => {
    addMessage('ğŸ’³ Danach kostet das Abo nur **2,99â€¯â‚¬ pro Monat**. Die Zahlung lÃ¤uft bequem Ã¼ber dein PayPal-Konto.');
  }, 6000);

  setTimeout(() => {
    addMessage('âŒ MÃ¶chtest du das Abo kÃ¼ndigen? Dann lÃ¶sche einfach die HÃ¼tte â€“ das Abo wird automatisch bei PayPal beendet.');
  }, 8000);

  setTimeout(() => {
    addMessage('âš™ï¸ Unter **â€Meine HÃ¼tten anzeigenâ€œ** kannst du jederzeit deine Daten anpassen, z.â€¯B. den Standort per Karte oder Texte und Bilder.');
  }, 10000);

  setTimeout(() => {
    addMessage('ğŸ‰ Bereit? Was mÃ¶chtest du tun?', 'bot');
    addChoiceButtons(['ğŸ¥š Neue HÃ¼tte erstellen', 'ğŸ“‹ Meine HÃ¼tten anzeigen'], handleIntent);
  }, 12000);
  }

  let currentUserForConsent = null;

function loadTrackingScripts(consent) {
  // Statistik
  if (consent.cookieStats) {
    const gaScript = document.createElement('script');
    gaScript.src = "https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-X"; // Deine GA-ID
    gaScript.async = true;
    document.head.appendChild(gaScript);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-XXXXXXX-X'); // Deine GA-ID
  }

  // Marketing
  if (consent.cookieMarketing) {
    const fbScript = document.createElement('script');
    fbScript.innerHTML = `
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'YOUR_PIXEL_ID');
      fbq('track', 'PageView');
    `;
    document.head.appendChild(fbScript);
  }
}

function showConsentModal(user) {
  currentUserForConsent = user;
  document.getElementById('consent-modal').classList.remove('hidden');
}

async function acceptConsent() {
  const privacyAccepted = document.getElementById('consent-privacy').checked;
  const cookiesAccepted = document.getElementById('consent-cookies').checked;

  if (!privacyAccepted) {
    alert('Bitte stimmen Sie der DatenschutzerklÃ¤rung zu.');
    return;
  }

  if (!cookiesAccepted) {
    alert('Bitte stimmen Sie der Verwendung von Cookies zu.');
    return;
  }

  const consentData = {
    privacyAccepted: privacyAccepted,
    cookiesAccepted: cookiesAccepted,
    consentDate: new Date(),
    privacyVersion: '1.0'
  };

  await db.collection('users').doc(currentUserForConsent.uid).set(consentData, { merge: true });
  localStorage.setItem('userConsent', JSON.stringify(consentData));

  // Falls du Scripts nur bei Cookie-Zustimmung laden willst
  loadTrackingScripts(consentData);

  document.getElementById('consent-modal').classList.add('hidden');
  loadApp(currentUserForConsent);
}
</script>
<!-- Consent Modal -->
<div id="consent-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">  
  <div style="background:white; padding:25px 30px; max-width:520px; width:100%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:sans-serif; line-height:1.6; color:#333;">  
    
    <h2 style="margin-top:0; font-size:1.6rem; font-weight:600; color:#222; margin-bottom:15px;">Datenschutz & Cookies</h2>  
    
    <p style="margin-bottom:15px; font-size:1rem;">  
      Wir verwenden Cookies und Ã¤hnliche Technologien, um unsere Dienste bereitzustellen und zu verbessern.  
      Mehr dazu in unserer   
      <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">  
        DatenschutzerklÃ¤rung  
      </a>.  
    </p>  
    
    <label style="display:flex; align-items:center; margin-top:15px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-privacy" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">DatenschutzerklÃ¤rung</a> zu</span>  
    </label>  
    
    <label style="display:flex; align-items:center; margin-top:10px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-cookies" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der Verwendung von Cookies gemÃ¤ÃŸ der <a href="/cookies.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Cookie-Richtlinie</a> zu</span>  
    </label>  

    <div style="margin-top:25px; text-align:right;">  
<button id="consent-accept" onclick="acceptConsent()" style="padding:10px 20px; background:linear-gradient(135deg, #4CAF50, #45A049); color:white; border:none; border-radius:6px; font-size:1rem; font-weight:500; cursor:pointer; transition:background 0.3s, transform 0.1s;">
  Zustimmen
</button>
    </div>  
  </div>  
</div>  


</body>
</html>
