<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierhütten Assistent Chat - Bearbeitung</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .edit-btn { margin-top: 0.5rem; background: #fbbf24; color: #92400e; padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer; display: inline-block; }
  </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">🥚 Eierhütten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section><script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

let currentUser = null;
let editingHutId = null;
let editingData = null;
let step = 0;

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo 👋 Ich bin dein Assistent für Eierhütten. Was möchtest du tun?', 'bot');
  addChoiceButtons(['🥚 Neue Hütte erstellen', '📋 Meine Hütten anzeigen'], handleIntent);
}

function handleIntent(input) {
  const txt = input.toLowerCase();
  if (txt.includes('meine')) return showMyHuts();
  if (txt.includes('neu')) { step = 1; editingData = {}; addMessage('Wie soll deine neue Hütte heißen?', 'bot'); return; }
}

function showMyHuts() {
  chatWindow.innerHTML = '';
  db.collection('eierhuetten').where('userId', '==', currentUser.uid).get().then(snapshot => {
    if (snapshot.empty) return addMessage('Du hast noch keine Hütten.', 'bot');
    snapshot.forEach(doc => {
      const d = doc.data();
      const div = document.createElement('div');
      div.className = 'message bot';
      div.innerHTML = `<div class='space-y-1 text-sm'>
        <div><strong>📍 Name:</strong> ${d.name}</div>
        <div><strong>🪑 Sitzplätze:</strong> ${d.sitzplaetze}</div>
        <div><strong>🔌 Strom:</strong> ${d.strom}</div>
        <div><strong>✨ Extras:</strong> ${d.extras}</div>
        <button class='edit-btn' onclick='startEditHut("${doc.id}", ${JSON.stringify(d).replace(/"/g, "&quot;")})'>Bearbeiten</button>
      </div>`;
      chatWindow.appendChild(div);
    });
  });
}

function startEditHut(id, data) {
  chatWindow.innerHTML = '';
  editingHutId = id;
  editingData = data;
  step = 101;
  addMessage(`Bearbeitung der Hütte: ${data.name}`, 'bot');
  addMessage('Neuer Name?', 'bot');
}

function processUserInput(txt) {
  if (step === 101) { editingData.name = txt; step = 102; addMessage('Neue Sitzplatzangabe?', 'bot'); return; }
  if (step === 102) { editingData.sitzplaetze = txt; step = 103; addMessage('Neuer Strom-Status?', 'bot'); return; }
  if (step === 103) {
    editingData.strom = txt;
    step = 104;
    addMessage('Neue Extras?', 'bot');
    return;
  }
  if (step === 104) {
    editingData.extras = txt;
    db.collection('eierhuetten').doc(editingHutId).update(editingData).then(() => {
      addMessage('✅ Hütte wurde aktualisiert.', 'bot');
      step = 0;
      showMyHuts();
    });
    return;
  }
  handleIntent(txt);
}

function addMessage(text, sender = 'bot') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'edit-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      container.remove();
      callback(opt);
    };
    container.appendChild(btn);
  });
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    startDialog();
  }
});

document.getElementById('google-login').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

sendBtn.addEventListener('click', () => {
  const val = chatInput.value.trim();
  if (!val) return;
  addMessage(val, 'user');
  chatInput.value = '';
  processUserInput(val);
});

chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendBtn.click();
});
</script></body>
</html>
