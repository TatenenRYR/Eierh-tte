
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten Assistent Chat - Erweitert</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    .hidden { display: none; }
    #map, .preview-map { width: 100%; height: 300px; margin-top: 1rem; border-radius: 0.5rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .edit-input, select { display: block; width: 100%; padding: 0.4rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 0.4rem; }
    .log-entry { font-size: 0.8rem; color: #555; margin-top: 0.2rem; padding-left: 1rem; }
    .foto-thumb { position: relative; display: inline-block; margin-right: 8px; margin-bottom: 8px; }
    .foto-thumb img { width: 80px; height: 80px; object-fit: cover; border-radius: 0.25rem; border: 1px solid #ccc; }
    .foto-thumb button { position: absolute; top: 0; right: 0; background: #dc2626; color: white; border: none; border-radius: 0 0.25rem 0.25rem 0; cursor: pointer; padding: 2px 5px; font-size: 12px; }
  </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>

  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">ü•ö Eierh√ºtten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

let currentUser = null;
let isAdmin = false;
let isAdminMode = false;
let step = 0;
let formData = {};
const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

function addMessage(text, sender = 'bot') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      container.remove();
      callback(opt.toLowerCase());
    };
    container.appendChild(btn);
  });
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo üëã Ich bin dein Assistent f√ºr Eierh√ºtten. Wie kann ich dir helfen?', 'bot');
  addChoiceButtons(['ü•ö Neue H√ºtte erstellen', 'üìã Meine H√ºtten anzeigen'], handleIntent);
}

function handleIntent(input) {
  const txt = input.toLowerCase();
  if (isAdminMode) return addMessage('üõ† Admin-Modus aktiv. Zeige alle H√ºtten...', 'bot'), showAllHuts();
  if (txt.includes('erstellen')) {
    db.collection('eierhuetten').where('userId', '==', currentUser.uid).get().then(snap => {
      if (snap.size >= 10) {
        addMessage('‚ö†Ô∏è Du hast bereits 10 Eierh√ºtten. L√∂sche eine, um eine neue zu erstellen.', 'bot');
      } else {
        step = 1;
        formData = {};
        addMessage('Wie soll deine H√ºtte hei√üen?', 'bot');
      }
    });
  } else if (txt.includes('meine')) {
    showMyHuts();
  } else {
    startDialog();
  }
}

function processUserInput(input) {
  const txt = input.trim();
  if (handleAdminCommand(txt)) return;
  if (step === 1) {
    formData.name = txt; step = 2;
    addMessage('Hat deine H√ºtte Sitzpl√§tze?', 'bot');
    addChoiceButtons(['Ja','Nein'], ans => {
      formData.sitzplaetze = ans; step = 3;
      addMessage('Gibt es Strom?', 'bot');
      addChoiceButtons(['Ja','Nein'], strom => {
        formData.strom = strom; step = 4;
        addMessage('Extras? (oder ‚Äûweiter‚Äú)', 'bot');
      });
    });
  } else if (step === 4) {
    formData.extras = txt.toLowerCase() === 'weiter' ? '' : txt;
    step = 5; showMap();
  } else {
    handleIntent(txt);
  }
}

function showMap() {
  const div = document.createElement('div');
  div.id = 'map';
  chatWindow.appendChild(div);
  const map = L.map('map').setView([51.2, 10.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let marker;
  map.on('click', e => {
    if (marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng).addTo(map);
    formData.loc = e.latlng;
    addMessage(`üìç Standort gespeichert: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`, 'bot');
    addChoiceButtons(['Einreichen', 'Abbrechen'], ans => {
      if (ans.includes('einreichen')) submitHut();
      else startDialog();
    });
  });
}

async function submitHut() {
  if (!formData.name || !formData.loc) return addMessage('‚ùå Bitte gib alle Daten ein.', 'bot');
  const hut = {
    name: formData.name,
    sitzplaetze: formData.sitzplaetze,
    strom: formData.strom,
    extras: formData.extras,
    location: new firebase.firestore.GeoPoint(formData.loc.lat, formData.loc.lng),
    userId: currentUser.uid,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'offen',
    fotos: []
  };
  try {
    await db.collection('eierhuetten').add(hut);
    addMessage('üéâ Deine Eierh√ºtte wurde erfolgreich eingereicht!', 'bot');
    step = 0; formData = {}; startDialog();
  } catch(e) {
    addMessage('‚ùå Fehler beim Einreichen: ' + e.message, 'bot');
  }
}

function showMyHuts() {
  chatWindow.innerHTML = '';
  db.collection('eierhuetten').where('userId', '==', currentUser.uid).orderBy('erstelltAm', 'desc').get().then(snapshot => {
    if (snapshot.empty) return addMessage('‚ùå Keine H√ºtten gefunden.', 'bot');
    snapshot.forEach(doc => {
      const d = doc.data();
      const container = document.createElement('div');
      container.className = 'message bot';
      // Fotos anzeigen
      let fotosHtml = '';
      if(d.fotos && Array.isArray(d.fotos)) {
        fotosHtml = d.fotos.map((url, i) => 
          `<div class="foto-thumb"><img src="${url}" alt="Foto ${i+1}" loading="lazy"></div>`
        ).join('');
      }
      container.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded space-y-1 text-sm">
          <div><strong>üìç Name:</strong> ${d.name}</div>
          <div><strong>ü™ë Sitzpl√§tze:</strong> ${d.sitzplaetze}</div>
          <div><strong>üîå Strom:</strong> ${d.strom}</div>
          <div><strong>‚ú® Extras:</strong> ${d.extras}</div>
          <div><strong>Status:</strong> ${d.status}</div>
          <div><strong>Fotos:</strong> <div class="flex flex-wrap">${fotosHtml}</div></div>
          <div class="minimap" id="minimap-${doc.id}"></div>
        </div>
      `;
      chatWindow.appendChild(container);
      if (d.location && d.location.latitude && d.location.longitude) {
        const mapDiv = document.getElementById(`minimap-${doc.id}`);
        const m = L.map(mapDiv, { zoomControl: false, dragging: false }).setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([d.location.latitude, d.location.longitude]).addTo(m);
        setTimeout(() => m.invalidateSize(), 200);
      }
    });
  });
}

function handleAdminCommand(txt) {
  // Admin-Befehl: /admin (nur User mit bestimmter E-Mail erlauben)
  if (txt === '/admin') {
    if (currentUser && currentUser.email && currentUser.email.endsWith('@deinedomain.de')) {
      isAdminMode = !isAdminMode;
      addMessage(`Admin-Modus ${isAdminMode ? 'aktiviert' : 'deaktiviert'}.`, 'bot');
      if (isAdminMode) showAllHuts();
      else startDialog();
      return true;
    } else {
      addMessage('Du bist kein Admin.', 'bot');
      return true;
    }
  }
  return false;
}

function showAllHuts() {
  chatWindow.innerHTML = '';
  db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get().then(snapshot => {
    if (snapshot.empty) return addMessage('Keine H√ºtten vorhanden.', 'bot');
    snapshot.forEach(doc => {
      const d = doc.data();
      const container = document.createElement('div');
      container.className = 'message bot';
      container.innerHTML = `
        <div class="p-3 bg-gray-50 border border-gray-300 rounded space-y-1 text-sm">
          <div><strong>üìç Name:</strong> ${d.name}</div>
          <div><strong>ü™ë Sitzpl√§tze:</strong> ${d.sitzplaetze}</div>
          <div><strong>üîå Strom:</strong> ${d.strom}</div>
          <div><strong>‚ú® Extras:</strong> ${d.extras}</div>
          <div><strong>Status:</strong> ${d.status}</div>
          <div><strong>Erstellt von:</strong> ${d.userId}</div>
        </div>
      `;
      chatWindow.appendChild(container);
    });
  });
}

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    isAdmin = user.email && user.email.endsWith('@deinedomain.de');
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    startDialog();
  } else {
    currentUser = null;
    isAdmin = false;
    isAdminMode = false;
    document.getElementById('login-section').classList.remove('hidden');
    document.getElementById('main-section').classList.add('hidden');
  }
});

document.getElementById('google-login').addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
});

sendBtn.addEventListener('click', () => {
  const val = chatInput.value.trim();
  if (!val) return;
  addMessage(val, 'user');
  chatInput.value = '';
  processUserInput(val);
});

chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendBtn.click();
  }
});
</script>
</body>
</html>
