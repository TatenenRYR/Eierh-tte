<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="google-adsense-account" content="ca-pub-2577915567428766">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HÃ¼tten Assistent Chat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
 <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn {
      margin-top: 0.5rem; background: #fbbf24; color: #92400e;
      padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer;
      display: inline-block; margin-right: 0.5rem;
    }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .time-picker { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .time-picker input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 0.5rem; width: 45%; }
 
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #d1fae5;
  color: #065f46;
  padding: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: sans-serif;
  border: 1px solid #065f46;
}




    /* Hover-Effekte fÃ¼r Links */
  #consent-modal a:hover {
    color: #0056b3 !important;
    border-color: #0056b3 !important;
  }

  /* Button Hover-Effekt */
  #consent-accept:hover {
    background: linear-gradient(135deg, #45A049, #3e8e41);
    transform: translateY(-1px);
  }

  /* Button Klick-Effekt */
  #consent-accept:active {
    transform: translateY(0);
  }
   .hidden {
  display: none !important;
   }
 </style>
</head>
  <body class="bg-gray-50">
  <!-- Login -->
  <div id="login-section" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow max-w-sm w-full text-center space-y-4">
      <h1 class="text-2xl font-bold">Login</h1>
      <p class="text-gray-500">Bitte mit Google anmelden.</p>
      <button id="google-login" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded w-full">
        Mit Google anmelden
      </button>
    </div>
  </div>

<!-- Werbung oberhalb vom Chat -->
<div id="adsense-container" style="margin:20px auto; text-align:center; display:none;">
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-2577915567428766"
       data-ad-slot="3060614235"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
</div>
  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">

    
    
    <!-- Navigation -->
<div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    ğŸ‘¤ <span id="user-name">LÃ¤dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ”„
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ 
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      ğŸ”“
    </button>
  </div>
</div>


    
    <div class="text-center font-bold text-2xl text-green-700 mb-4">HÃ¼tten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
   <input type="file" id="image-upload" accept="image/*" multiple hidden />
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

<script>
// Konfiguration
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
const app = firebase.initializeApp(firebaseConfig);
firebase.functions(app); // Wichtig, sonst falsches Projekt!
const auth = firebase.auth(), db = firebase.firestore();
const storage = firebase.storage(); // WICHTIG
 const imgbbApiKey = "5df04de9bfd2776f101329be4193e44c"; 
// ZustÃ¤nde
let currentUser = null;
let editingData = {};
let step = 0;
let map, marker;

const chatWindow = document.getElementById('chat-window');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
function addMessage(text, sender = 'bot', isHTML = false) {
  const div = document.createElement('div');
  div.classList.add('message', sender);

  if (isHTML) {
    // Nur verwenden, wenn du volle Kontrolle Ã¼ber den Inhalt hast!
    div.innerHTML = text;
  } else {
    div.textContent = text;
  }

  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}


/*function addMessage(text, sender = 'bot') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}*/
/*
function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      container.remove();
      callback(opt);
    };
    container.appendChild(btn);
  });
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
*/
  function addChoiceButtons(options, callback) {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');

  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;

    btn.onclick = () => {
      addMessage(opt, 'user');
      btn.disabled = true; // Verhindere Doppelklick
      callback(opt)
        .then(() => {
          container.remove(); // âœ… Nur bei Erfolg entfernen
        })
        .catch(err => {
          console.error('âŒ Fehler beim Verarbeiten:', err);
          btn.disabled = false; // Wieder aktivieren bei Fehler
        });
    };

    container.appendChild(btn);
  });

  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  }
function showTimePicker() {
  const container = document.createElement('div');
  container.classList.add('message', 'bot');
  const label = document.createElement('div');
  label.textContent = 'Bitte wÃ¤hle Ã–ffnungszeiten:';
  const timeDiv = document.createElement('div');
  timeDiv.className = 'time-picker';
  const von = document.createElement('input');
  von.type = 'time';
  const bis = document.createElement('input');
  bis.type = 'time';
  timeDiv.appendChild(von);
  timeDiv.appendChild(bis);
  const btn = document.createElement('button');
  btn.className = 'choice-btn';
  btn.textContent = 'Ãœbernehmen';
  btn.onclick = () => {
    if (von.value && bis.value) {
      editingData.oeffnungszeiten = `${von.value} â€“ ${bis.value}`;
      addMessage(`ğŸ•’ Ã–ffnungszeiten: ${editingData.oeffnungszeiten}`, 'bot');
      container.remove();
      step = 6;
      showMap();
    } else {
      alert('Bitte beide Uhrzeiten eingeben.');
    }
  };
  container.appendChild(label);
  container.appendChild(timeDiv);
  container.appendChild(btn);
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Dialogfluss
function startDialog() {
  chatWindow.innerHTML = '';
  addMessage('Hallo ğŸ‘‹ Ich bin dein Assistent fÃ¼r Fahrradstops. Was mÃ¶chtest du tun?', 'bot');

  addChoiceButtons(
    [
      'ğŸ¥š Neue HÃ¼tte erstellen',
     /* 'ğŸ› Neuen Spielplatz eintragen',*/
      'ğŸ“‹ Meine HÃ¼tten anzeigen',
     /* 'ğŸ› Meine SpielplÃ¤tze anzeigen',*/
      'ğŸ« Support Anfragen'
    ],
    handleIntent
  );
}
 // ==========================
// Spielplatz anlegen (Dialog)
// ==========================
function startSpielplatzDialog() {
  step = 'spielplatz_name';
  editingData = {
    typ: 'spielplatz',
    fotos: []
  };

  addMessage('ğŸ› Wie soll der Spielplatz heiÃŸen?', 'bot');
} 
function deleteSpielplatz(id) {
  if (!confirm('â— MÃ¶chtest du diesen Spielplatz wirklich lÃ¶schen?')) return;

  db.collection('spielplaetze').doc(id).delete()
    .then(() => {
      addMessage('ğŸ—‘ï¸ Spielplatz wurde gelÃ¶scht.', 'bot');
      showMySpielplaetze();
    })
    .catch(err => {
      console.error('âŒ Fehler beim LÃ¶schen:', err);
      addMessage('âŒ Fehler beim LÃ¶schen des Spielplatzes.', 'bot');
    });
  }
  async function showMySpielplaetze() {
  chatWindow.innerHTML = '';

  const snapshot = await db.collection('spielplaetze')
    .where('userId', '==', currentUser.uid)
    .get();

  if (snapshot.empty) {
    addMessage('ğŸ› Du hast noch keine SpielplÃ¤tze eingetragen.', 'bot');
    return;
  }

  let total = 0, angenommen = 0, offen = 0, abgelehnt = 0;

  snapshot.forEach(doc => {
    total++;
    const d = doc.data();
    if (d.status === 'angenommen') angenommen++;
    if (d.status === 'offen') offen++;
    if (d.status === 'abgelehnt') abgelehnt++;
  });

  // Statistik-Balken
  const statsBar = document.createElement('div');
  statsBar.className = 'flex justify-around items-center text-sm bg-blue-100 text-blue-900 py-2 px-4 rounded mb-3 shadow-sm border border-blue-300';
  statsBar.innerHTML = `
    <div title="Eingereichte SpielplÃ¤tze">ğŸ› <strong>${total}</strong></div>
    <div title="Angenommen">âœ… <strong>${angenommen}</strong></div>
    <div title="Offen">â³ <strong>${offen}</strong></div>
    <div title="Abgelehnt">âŒ <strong>${abgelehnt}</strong></div>
  `;
  chatWindow.appendChild(statsBar);

  // Karten rendern
  snapshot.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const div = document.createElement('div');
    div.className = 'message bot';

    const minimapId = `minimap-spielplatz-${id}`;

    div.innerHTML = `
      <div class="text-sm space-y-2">
        <div class="font-bold">ğŸ› ${d.name}</div>
        <div><strong>ğŸ“Œ Status:</strong> ${d.status}</div>
        <div><strong>ğŸª‘ SitzmÃ¶glichkeiten:</strong> ${d.sitz || '-'}</div>
        <div><strong>ğŸ·ï¸ Tags:</strong> ${(d.tags || []).join(', ')}</div>

        <!-- Bilder -->
        ${Array.isArray(d.fotos) && d.fotos.length ? `
          <div class='flex flex-col gap-2 mt-2'>
            ${d.fotos.map(img => {
              const isString = typeof img === 'string';
              const url = isString ? img : img.url;
              const del = isString ? '' : (img.delete_url || '');
              const status = isString ? 'freigegeben' : (img.status || 'freigegeben');
              const pending = status === 'wartet';
              return `
                <div class="flex items-center gap-4 bg-gray-50 p-2 rounded border relative">
                  <div class="relative group">
                    <img src="${url}" class="h-20 w-20 object-cover rounded shadow ${pending ? 'opacity-50' : ''}"/>
                    ${!pending ? `
                      <button onclick="deleteImage('${id}', '${url}', '${del}')" 
                        class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-1 opacity-0 group-hover:opacity-100 transition">
                        âœ•
                      </button>
                    ` : ''}
                  </div>
                  <div class="flex-1 text-xs break-all text-gray-600">
                    <div><strong>Status:</strong> ${pending ? '<span class="text-orange-600">â³ wartet</span>' : 'âœ… frei'}</div>
                    <div><strong>Delete:</strong><br><code>${del || '-'}</code></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : '<div class="text-gray-500 italic">ğŸ“· Keine Bilder</div>'}

        <!-- Upload -->
        <label class="block mt-2 text-sm">ğŸ“· Neues Bild:
          <input type="file" accept="image/*" data-id="${id}" class="upload-spielplatz mt-1" />
        </label>

        <!-- Mini-Map -->
        <div id="${minimapId}" class="minimap h-40 mt-2 rounded border"></div>

        <!-- Aktionen -->
        <button class="delete-btn" onclick='deleteSpielplatz("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
      </div>
    `;
    chatWindow.appendChild(div);

    // Mini-Map aktivieren
    if (d.location?.latitude && d.location?.longitude) {
      setTimeout(() => {
        const m = L.map(minimapId, { zoomControl: true })
          .setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([d.location.latitude, d.location.longitude]).addTo(m);
      }, 300);
    }
  });

  // Upload-Handler fÃ¼r ImgBB
  document.querySelectorAll('.upload-spielplatz').forEach(input => {
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const spielplatzId = e.target.getAttribute('data-id');
      addMessage("â³ Lade Bild hoch...", "bot");

      try {
        const result = await uploadToImgBB(file, percent => {
          console.log(`Upload: ${percent}%`);
        });

        await db.collection('spielplaetze').doc(spielplatzId).update({
          fotos: firebase.firestore.FieldValue.arrayUnion(result)
        });

        addMessage("âœ… Bild hochgeladen und wartet auf Freigabe.", "bot");
        showMySpielplaetze();
      } catch (err) {
        console.error("âŒ Upload-Fehler:", err);
        addMessage("âŒ Fehler beim Hochladen des Bildes.", "bot");
      }
    });
  });
  }
 /* async function showMySpielplaetze() {
  chatWindow.innerHTML = '';

  const snapshot = await db.collection('spielplaetze')
    .where('userId', '==', currentUser.uid)
    .get();

  if (snapshot.empty) {
    addMessage('ğŸ› Du hast noch keine SpielplÃ¤tze eingetragen.', 'bot');
    return;
  }

  let total = 0, angenommen = 0, offen = 0, abgelehnt = 0;

  snapshot.forEach(doc => {
    total++;
    const d = doc.data();
    if (d.status === 'angenommen') angenommen++;
    if (d.status === 'offen') offen++;
    if (d.status === 'abgelehnt') abgelehnt++;
  });

  // Statistik-Balken
  const statsBar = document.createElement('div');
  statsBar.className = 'flex justify-around items-center text-sm bg-blue-100 text-blue-900 py-2 px-4 rounded mb-3 shadow-sm border border-blue-300';
  statsBar.innerHTML = `
    <div title="Eingereichte SpielplÃ¤tze">ğŸ› <strong>${total}</strong></div>
    <div title="Angenommen">âœ… <strong>${angenommen}</strong></div>
    <div title="Offen">â³ <strong>${offen}</strong></div>
    <div title="Abgelehnt">âŒ <strong>${abgelehnt}</strong></div>
  `;
  chatWindow.appendChild(statsBar);

  // Jetzt jede Karte rendern
  snapshot.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const div = document.createElement('div');
    div.className = 'message bot';

    const minimapId = `minimap-spielplatz-${id}`;

    div.innerHTML = `
      <div class="text-sm space-y-2">
        <div class="font-bold">ğŸ› ${d.name}</div>
        <div><strong>ğŸ“Œ Status:</strong> ${d.status}</div>
        <div><strong>ğŸª‘ SitzmÃ¶glichkeiten:</strong> ${d.sitz || '-'}</div>
        <div><strong>ğŸ·ï¸ Tags:</strong> ${(d.tags || []).join(', ')}</div>

        <!-- Bilder -->
        ${Array.isArray(d.fotos) && d.fotos.length ? `
  <div class='flex flex-col gap-2 mt-2'>
    ${d.fotos.map(img => {
      const isString = typeof img === 'string';
      const url = isString ? img : img.url;
      const del = isString ? '' : (img.delete_url || '');
      const status = isString ? 'freigegeben' : (img.status || 'freigegeben');
      const pending = status === 'wartet';
      return `
        <div class="flex items-center gap-4 bg-gray-50 p-2 rounded border relative">
          <div class="relative group">
            <img src="${url}" class="h-20 w-20 object-cover rounded shadow ${pending ? 'opacity-50' : ''}"/>
            ${!pending ? `
              <button onclick="deleteImage('${id}', '${url}', '${del}')" 
                class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-1 opacity-0 group-hover:opacity-100 transition">
                âœ•
              </button>
            ` : ''}
          </div>
          <div class="flex-1 text-xs break-all text-gray-600">
            <div><strong>Status:</strong> ${pending ? '<span class="text-orange-600">â³ wartet</span>' : 'âœ… frei'}</div>
            <div><strong>Delete:</strong><br><code>${del || '-'}</code></div>
          </div>
        </div>
      `;
    }).join('')}
  </div>
` : '<div class="text-gray-500 italic">ğŸ“· Keine Bilder</div>'}
        <!-- Mini-Map -->
        <div id="${minimapId}" class="minimap h-40 mt-2 rounded border"></div>

        <!-- Aktionen -->
        <button class="delete-btn" onclick='deleteSpielplatz("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
      </div>
    `;
    chatWindow.appendChild(div);

    // Mini-Map aktivieren
    if (d.location?.latitude && d.location?.longitude) {
      setTimeout(() => {
        const m = L.map(minimapId, { zoomControl: true })
          .setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([d.location.latitude, d.location.longitude]).addTo(m);
      }, 300);
    }
  });
  }*/
  function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('support')) {
    addMessage('Hallo ğŸ‘‹', 'bot');
    ladeMeineSupportTickets();
    return;
  }

  if (txt.includes('meine hÃ¼tten')) {
      showMyHuts();
    return;
  }

  if (txt.includes('vorschlag')) {
    addMessage('ğŸ“© Bitte gib die E-Mail-Adresse des Besitzers ein, den du vorschlagen mÃ¶chtest:', 'bot');
    step = 'suggest_email';
    return;
  }
if (txt.includes('meine spielplÃ¤tze') || txt.includes('spielplÃ¤tze anzeigen')) {
  showMySpielplaetze();
  return;
  }
  // =====================
  // HÃ¼tte erstellen
  // =====================
  if (txt.includes('hÃ¼tte')) {
    addMessage(`
      ğŸ›¡ï¸ <b>Bevor du deine HÃ¼tte eintrÃ¤gst, akzeptiere bitte die DatenschutzerklÃ¤rung:</b><br>
      <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
        <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
        <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">DatenschutzerklÃ¤rung</a>.</span>
      </label>
    `, 'bot', true);

    addChoiceButtons(['âœ… Zustimmen & Starten'], () => {
      const checkbox = document.getElementById('chat-datenschutz-zustimmung');
      if (!checkbox || !checkbox.checked) {
        alert('Bitte akzeptiere zuerst die DatenschutzerklÃ¤rung.');
        return;
      }

      step = 1;
      editingData = {
        zustimmungDatenschutz: {
          akzeptiert: true,
          am: new Date().toISOString()
        }
      };

      addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot');
    });

    return;
  }

  // =====================
  // Spielplatz erstellen
  // =====================
  if (txt.includes('spielplatz')) {
    startSpielplatzDialog();
    return;
  }

  // =====================
  // Fallback
  // =====================
  addMessage('â“ Ich habe das leider nicht verstanden. Bitte wÃ¤hle eine Option aus.', 'bot');
  addChoiceButtons(
    [
      'ğŸ¥š Neue HÃ¼tte erstellen',
     /* 'ğŸ› Neuen Spielplatz eintragen',*/
      'ğŸ“‹ Meine HÃ¼tten anzeigen',
      'ğŸ« Support Anfragen'
    ],
    handleIntent
  );
  }
  /*function handleIntent(input) {
  const txt = input.toLowerCase();

  if (txt.includes('meine')) {
      showMyHuts();
  }

  if (txt.includes('neu')) {
  addMessage(`
    ğŸ›¡ï¸ <b>Bevor du deine HÃ¼tte eintrÃ¤gst, akzeptiere bitte die DatenschutzerklÃ¤rung:</b><br>
    <label style="display:flex; gap:8px; align-items:start; margin-top:6px;">
      <input type="checkbox" id="chat-datenschutz-zustimmung" style="margin-top:4px;" />
      <span>Ich akzeptiere die <a href="/datenschutz.html" target="_blank" style="color:blue; text-decoration:underline;">DatenschutzerklÃ¤rung</a>.</span>
    </label>
  `, 'bot', true);

  addChoiceButtons(['âœ… Zustimmen & Starten'], () => {
    const checkbox = document.getElementById('chat-datenschutz-zustimmung');
    if (!checkbox || !checkbox.checked) {
      alert('Bitte akzeptiere zuerst die DatenschutzerklÃ¤rung.');
      return;
    }

    // Zustimmung speichern
    step = 1;
    editingData = {
      zustimmungDatenschutz: {
        akzeptiert: true,
        am: new Date().toISOString()
      }
    };

    addMessage('Wie soll deine neue HÃ¼tte heiÃŸen?', 'bot');
  });
  }
  if (txt.includes('support')) {
    ladeMeineSupportTickets();
  }
  

}*/
  function processUserInput(txt) {
  // ==========================
  // Vorschlags-Flow
  // ==========================
  if (step === 'suggest_email') {
    editingData = { email: txt.trim() };
    addMessage('âœ… Danke! MÃ¶chtest du noch einen Kommentar hinzufÃ¼gen?', 'bot');
    step = 'suggest_comment';
    return;
  }

  if (step === 'suggest_comment') {
    editingData.comment = txt.trim();
    addMessage('ğŸ“ Bitte wÃ¤hle den Standort deiner HÃ¼tte aus.', 'bot');
    showSuggestionMap(); 
    step = 'suggest_location';
    return;
  }

  // ==========================
  // HÃ¼tten-Flow
  // ==========================

  // Step 1: Name
  if (step === 1) {
    editingData.name = txt.trim();
    step = 2;
    addQuestionWithHelp("ğŸª‘ Hat deine HÃ¼tte SitzplÃ¤tze?", "Sind BÃ¤nke oder StÃ¼hle vorhanden?");
    addChoiceButtons(['Ja', 'Nein'], ans => {
      editingData.sitzplaetze = ans;
      step = 3;
      addQuestionWithHelp("ğŸ”Œ Gibt es Strom?", "Kann man z. B. ein Handy laden?");
      addChoiceButtons(['Ja', 'Nein'], strom => {
        editingData.strom = strom;
        step = 4;
        addQuestionWithHelp("âœ¨ Extras? (oder â€keineâ€œ)", "Zum Beispiel: GetrÃ¤nke, KÃ¼hlschrank, Werkzeug.");
      });
    });
    return;
  }

  // Step 4: Extras -> Tiere (Emoji)
  if (step === 4) {
    editingData.extras = txt.toLowerCase() === 'keine' ? '' : txt;
    step = "tiere_input";
    askForAnimals();
    return;
  }

  // Tiere Auswahl abgeschlossen -> Beschreibung
  if (step === "beschreibung_input") {
    editingData.beschreibung = txt.trim();
    step = "tags_input";
    addQuestionWithHelp("ğŸ·ï¸ Bitte fÃ¼ge bis zu 5 SchlagwÃ¶rter hinzu (durch Komma getrennt).", "Beispiel: FrÃ¼hstÃ¼ck, GetrÃ¤nke, schattig");
    return;
  }

  // Tags
  if (step === "tags_input") {
    const tags = txt.split(",").map(t => t.trim()).filter(t => t.length > 0);
    if (tags.length > 5) {
      addMessage("âš ï¸ Bitte max. 5 Tags angeben.", "bot");
      return;
    }
    editingData.tags = tags;
    step = 5;
    addQuestionWithHelp("ğŸ•’ Wie lauten die Ã–ffnungszeiten?", "Wenn die HÃ¼tte immer frei zugÃ¤nglich ist: 'Immer geÃ¶ffnet'");
    addChoiceButtons(['Immer geÃ¶ffnet', 'Von â€“ Bis angeben'], ans => {
      if (ans === 'Immer geÃ¶ffnet') {
        editingData.oeffnungszeiten = 'Immer geÃ¶ffnet';
        askForLocationChoice(); 
      } else {
        showTimePicker();
      }
    });
    return;
  }

  // Step "address_input": Adresse wurde eingegeben
  if (step === "address_input") {
    geocodeAddress(txt.trim());
    step = null;
    return;
  }

  // ==========================
  // Spielplatz-Flow (bleibt)
  // ==========================
  if (step === 'spielplatz_name') {
    editingData.name = txt.trim();
    step = 'spielplatz_location';
    addMessage('ğŸ“ Bitte klicke den Standort des Spielplatzes auf der Karte an.', 'bot');
    zeigeMapFuerSpielplatz();
    return;
  }

  if (step === 'spielplatz_location') {
    step = 'spielplatz_sitz';
    addMessage('ğŸª‘ Gibt es SitzmÃ¶glichkeiten?', 'bot');
    addChoiceButtons(['Ja', 'Nein'], choice => {
      editingData.sitz = choice;
      step = 'spielplatz_tags';
      addMessage('ğŸ·ï¸ Bitte gib SchlagwÃ¶rter an (z. B. Seilrutsche, Schaukel, gepflegt):', 'bot');
    });
    return;
  }

  if (step === 'spielplatz_tags') {
    editingData.tags = txt.split(',').map(t => t.trim());
    step = 'spielplatz_fotos';
    addMessage('ğŸ“· Lade bitte 1â€“3 Fotos hoch.', 'bot');
    zeigeUploadKomponente('spielplatz_fotos');
    return;
  }

  if (step === 'spielplatz_fotos') {
    step = null;
    saveSpielplatz(editingData);
    return;
  }
}
function askForAnimals() {
  addMessage("ğŸ¾ Welche Tiere gibt es an der HÃ¼tte? (Mehrfachauswahl mÃ¶glich)", "bot");

  const tiere = ["ğŸ Ziege", "ğŸ„ Kuh", "ğŸ“ Huhn", "ğŸ• Hund", "ğŸ‡ Hase", "âŒ Keine"];
  editingData.tiere = [];

  const container = document.createElement("div");
  container.classList.add("message", "bot");

  tiere.forEach(tier => {
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.textContent = tier;

    btn.onclick = () => {
      if (tier === "âŒ Keine") {
        editingData.tiere = [];
        addMessage("âŒ Keine Tiere ausgewÃ¤hlt", "bot");
      } else {
        if (!editingData.tiere.includes(tier)) {
          editingData.tiere.push(tier);
        }
        addMessage(`âœ… Aktuell gewÃ¤hlt: ${editingData.tiere.join(", ")}`, "bot");
      }
    };

    container.appendChild(btn);
  });

  // Weiter-Button hinzufÃ¼gen
  const weiterBtn = document.createElement("button");
  weiterBtn.className = "choice-btn mt-2";
  weiterBtn.textContent = "â¡ï¸ Weiter";
  weiterBtn.onclick = () => {
    step = "beschreibung_input";
    addQuestionWithHelp(
      "ğŸ“ Bitte gib eine kurze Beschreibung deiner HÃ¼tte ein:",
      "z. B. kleine FrÃ¼hstÃ¼cksecke, Hof mit Aussicht"
    );
  };
  container.appendChild(weiterBtn);

  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
 function askForLocationChoice() {
  addMessage("ğŸ“ Wie mÃ¶chtest du den Standort deiner HÃ¼tte angeben?", "bot");
  addChoiceButtons(["ğŸ“¡ Automatisch (GPS)", "ğŸ  Adresse eingeben"], choice => {
    if (choice.includes("GPS")) {
      showMap(); // deine bestehende GPS-Auswahl
    } else {
      askForAddressInput(); // mit Autocomplete
    }
  });
 }
function askForAddressInput() {
  addMessage("ğŸ  Bitte gib die Adresse deiner HÃ¼tte ein:", "bot");

  const container = document.createElement("div");
  container.classList.add("message", "bot");

  container.innerHTML = `
    <input id="address-input" 
           type="text" 
           placeholder="Adresse eingeben..." 
           class="w-full border rounded px-2 py-1 mt-1"/>
    <div id="address-suggestions" class="mt-2 space-y-1"></div>
  `;

  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  const input = container.querySelector("#address-input");
  const suggestionsDiv = container.querySelector("#address-suggestions");

  let timeout;
  input.addEventListener("input", () => {
    clearTimeout(timeout);
    const val = input.value.trim();
    if (val.length < 3) {
      suggestionsDiv.innerHTML = "";
      return;
    }
    timeout = setTimeout(() => fetchAddressSuggestions(val, suggestionsDiv), 400);
  });
}
function enableAddressAutocomplete(hutId) {
  const input = document.getElementById(`address-input-${hutId}`);
  const suggestionsDiv = document.getElementById(`address-suggestions-${hutId}`);
  if (!input) return;

  let timeout;
  input.addEventListener("input", () => {
    clearTimeout(timeout);
    const val = input.value.trim();
    if (val.length < 3) {
      suggestionsDiv.innerHTML = "";
      return;
    }
    timeout = setTimeout(() => fetchAddressSuggestions(val, suggestionsDiv, hutId), 400);
  });
}

async function fetchAddressSuggestions(query, container, hutId) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`;
    const res = await fetch(url, { headers: { "User-Agent": "EierhuettenApp/1.0" } });
    const data = await res.json();

    container.innerHTML = "";
    if (!data.length) {
      container.innerHTML = "<div class='text-gray-500'>âŒ Keine Ergebnisse</div>";
      return;
    }

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "p-2 bg-gray-100 hover:bg-green-100 cursor-pointer rounded";
      div.textContent = item.display_name;

      div.onclick = async () => {
        if (!confirm(`ğŸ“ Diese Adresse Ã¼bernehmen?\n\n${item.display_name}`)) return;

        const docRef = db.collection("eierhuetten").doc(hutId);
        const docSnap = await docRef.get();

        if (!docSnap.exists) {
          addMessage("âŒ Fehler: Diese HÃ¼tte existiert nicht mehr.", "bot");
          return;
        }

        try {
          await docRef.update({
            address: item.display_name,
            location: new firebase.firestore.GeoPoint(
              parseFloat(item.lat),
              parseFloat(item.lon)
            ),
            status: "offen"
          });

          addMessage(`âœ… Adresse gespeichert: ${item.display_name}`, "bot");
          addMessage("â³ Ã„nderung gespeichert und muss erneut durch einen Admin freigeschaltet werden.", "bot");

          container.innerHTML = "";
          showMyHuts();
        } catch (err) {
          console.error("âŒ Firestore-Update-Fehler:", err);
          addMessage("âŒ Fehler beim Speichern der Adresse: " + err.message, "bot");
        }
      };

      container.appendChild(div);
    });
  } catch (err) {
    console.error("âŒ Adress-Suche-Fehler:", err);
    container.innerHTML = `<div class='text-red-500'>âŒ Fehler: ${err.message}</div>`;
  }
  }


async function fetchAddressSuggestions(query, container, hutId) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`;
    const res = await fetch(url, { headers: { "User-Agent": "EierhuettenApp/1.0" } });
    const data = await res.json();

    container.innerHTML = "";
    if (!data.length) {
      container.innerHTML = "<div class='text-gray-500'>âŒ Keine Ergebnisse</div>";
      return;
    }

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "p-2 bg-gray-100 hover:bg-green-100 cursor-pointer rounded";
      div.textContent = item.display_name;

      div.onclick = async () => {
        // Nachfrage
        if (!confirm(`ğŸ“ Diese Adresse Ã¼bernehmen?\n\n${item.display_name}`)) return;

        // Debug-Ausgabe in der Konsole
        console.log("DEBUG: Adresse speichern", {
          hutId,
          address: item.display_name,
          lat: item.lat,
          lon: item.lon
        });

        try {
          await db.collection("eierhuetten").doc(hutId).update({
            address: item.display_name,
            location: new firebase.firestore.GeoPoint(
              parseFloat(item.lat),
              parseFloat(item.lon)
            ),
            status: "offen" // zurÃ¼ck zur Freigabe
          });

          addMessage(`âœ… Adresse gespeichert: ${item.display_name}`, "bot");
          addMessage("â³ Ã„nderung gespeichert und muss erneut durch einen Admin freigeschaltet werden.", "bot");

          container.innerHTML = "";
          showMyHuts();
        } catch (err) {
          console.error("âŒ Fehler beim Firestore-Update:", err);
          addMessage("âŒ Fehler beim Speichern der Adresse: " + err.message, "bot");
        }
      };

      container.appendChild(div);
    });
  } catch (err) {
    console.error("âŒ Fehler bei der Adresssuche:", err);
    container.innerHTML = `<div class='text-red-500'>âŒ Fehler: ${err.message}</div>`;
  }
}
  
  async function geocodeAddress(address) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      editingData.location = new firebase.firestore.GeoPoint(lat, lon);
      addMessage(`âœ… Adresse gefunden: ${data[0].display_name}`, "bot");
      askForImageUpload();
    } else {
      addMessage("âŒ Adresse konnte nicht gefunden werden. Bitte versuche es erneut.", "bot");
    }
  } catch (err) {
    addMessage("âŒ Fehler bei der Adresssuche: " + err.message, "bot");
  }
  }

  function addQuestionWithHelp(question, helpText) {
  const div = document.createElement("div");
  div.classList.add("message", "bot");
  div.innerHTML = `
    ${question}
    <button class="ml-2 px-2 py-1 bg-gray-200 rounded" onclick="alert('${helpText}')">â“</button>
  `;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  }
/*
function processUserInput(txt) {
  // ==========================
  // Vorschlags-Flow
  // ==========================
  if (step === 'suggest_email') {
    editingData = { email: txt.trim() };
    addMessage('âœ… Danke! MÃ¶chtest du noch einen Kommentar hinzufÃ¼gen?', 'bot');
    step = 'suggest_comment';
    return;
  }

  if (step === 'suggest_comment') {
    editingData.comment = txt.trim();
    addMessage('ğŸ“ Bitte wÃ¤hle den Standort deiner HÃ¼tte aus.', 'bot');

    showSuggestionMap(); // zeigt Karte + Button zum Senden

    step = 'suggest_location';
    return;
  }


  
// --- Spielplatz: Name ---
  if (step === 'spielplatz_name') {
    editingData.name = txt.trim();
    step = 'spielplatz_location';
    addMessage('ğŸ“ Bitte klicke den Standort des Spielplatzes auf der Karte an.', 'bot');
    zeigeMapFuerSpielplatz(); // Ã¤hnlich wie showMap() bei HÃ¼tten
    return;
  }

  // --- Spielplatz: Standort ---
  if (step === 'spielplatz_location') {
    // Standort wird per Karte gesetzt â†’ editingData.location
    step = 'spielplatz_sitz';
    addMessage('ğŸª‘ Gibt es SitzmÃ¶glichkeiten?', 'bot');
    addChoiceButtons(['Ja', 'Nein'], choice => {
      editingData.sitz = choice;
      step = 'spielplatz_tags';
      addMessage('ğŸ·ï¸ Bitte gib SchlagwÃ¶rter an (z. B. Seilrutsche, Schaukel, gepflegt):', 'bot');
    });
    return;
  }

  // --- Spielplatz: Tags ---
  if (step === 'spielplatz_tags') {
    editingData.tags = txt.split(',').map(t => t.trim());
    step = 'spielplatz_fotos';
    addMessage('ğŸ“· Lade bitte 1â€“3 Fotos hoch.', 'bot');
    zeigeUploadKomponente('spielplatz_fotos');
    return;
  }

  // --- Spielplatz: Fotos abgeschlossen ---
  if (step === 'spielplatz_fotos') {
    // Upload â†’ setzt editingData.fotos
    step = null;
    saveSpielplatz(editingData);
    return;
  }

  // ==========================
  // HÃ¼tten-Flow (nummerierte Steps)
  // ==========================
  if (step === 1) {
    editingData.name = txt;
    step = 2;
    addMessage('Hat deine HÃ¼tte SitzplÃ¤tze?', 'bot');
    addChoiceButtons(['Ja', 'Nein'], ans => {
      editingData.sitzplaetze = ans;
      step = 3;
      addMessage('Gibt es Strom?', 'bot');
      addChoiceButtons(['Ja', 'Nein'], strom => {
        editingData.strom = strom;
        step = 4;
        addMessage('Extras? (oder â€keineâ€œ)', 'bot');
      });
    });
    return;
  }

  if (step === 4) {
    editingData.extras = txt.toLowerCase() === 'keine' ? '' : txt;
    step = 5;
    addMessage('Wie lauten die Ã–ffnungszeiten?', 'bot');
    addChoiceButtons(['Immer geÃ¶ffnet', 'Von â€“ Bis angeben'], ans => {
      if (ans === 'Immer geÃ¶ffnet') {
        editingData.oeffnungszeiten = 'Immer geÃ¶ffnet';
        step = 6;
        showMap(); // Karte fÃ¼r HÃ¼tten-Standort
      } else {
        showTimePicker();
      }
    });
    return;
  }
}*/

function saveSpielplatz(data) {
  db.collection('spielplaetze').add({
    ...data,
    userId: currentUser.uid,
    status: 'offen', // Admin muss erst freigeben
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    addMessage(`âœ… Dein Spielplatz "${data.name}" wurde eingetragen und wartet nun auf Freigabe durch einen Admin.`, 'bot');
    // Optional: Liste neu laden
    showMySpielplaetze();
  }).catch(err => {
    console.error("âŒ Fehler beim Speichern:", err);
    addMessage("âŒ Fehler beim Eintragen des Spielplatzes.", "bot");
  });
}
  function zeigeUploadKomponente(context) {
  const upload = document.createElement('input');
  upload.type = 'file';
  upload.accept = 'image/*';
  upload.multiple = true;

  upload.onchange = async e => {
    const files = e.target.files;
    if (!files.length) return;

    addMessage(`â³ Lade ${files.length} Bild(er) hoch...`, 'bot');
    const uploads = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      try {
        // â†’ nutzt die schon vorhandene Hilfsfunktion
        const result = await uploadToImgBB(file, percent => {
          console.log(`Upload ${i + 1}: ${percent}%`);
        });
        uploads.push(result);
      } catch (err) {
        console.error("âŒ Upload-Fehler:", err);
        addMessage(`âŒ Fehler beim Hochladen von Bild ${i + 1}`, 'bot');
      }
    }

    if (uploads.length > 0) {
      editingData.fotos = uploads;
      addMessage("âœ… Fotos hochgeladen.", "bot");
      processUserInput("spielplatz_fotos"); // setzt den Step weiter
    } else {
      addMessage("âš ï¸ Keine Fotos wurden erfolgreich hochgeladen.", "bot");
    }
  };

  chatWindow.appendChild(upload);
  upload.click(); // sofort Ã¶ffnen
}

 
  async function uploadToImgBB(file, onProgress) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async () => {
      const base64 = reader.result.split(',')[1];
      const body = new URLSearchParams();
      body.append('key', '5df04de9bfd2776f101329be4193e44c');
      body.append('image', base64);

      try {
        const res = await fetch('https://api.imgbb.com/1/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body
        });

        const json = await res.json();

        if (json.success && json.data?.url && json.data?.delete_url) {
          resolve({
            url: json.data.url,
            delete_url: json.data.delete_url,
            status: 'wartet'
          });
        } else {
          reject('Upload erfolgreich, aber delete_url fehlt: ' + JSON.stringify(json));
        }
      } catch (err) {
        reject('Upload-Fehler: ' + err.message);
      }
    };

    reader.onerror = () => reject('Fehler beim Lesen der Datei');
    reader.readAsDataURL(file);
  });
  }

const filterStatus = true; // oder abhÃ¤ngig von UI-Einstellungen
async function showMyHuts() {
  const user = auth.currentUser;
  if (!user) {
    addMessage("âŒ Du musst eingeloggt sein, um deine HÃ¼tten zu sehen.", "bot");
    return;
  }

  try {
    const snapshot = await db.collection("eierhuetten")
      .where("owner", "==", user.uid)
      .get();

    if (snapshot.empty) {
      addMessage("ğŸ“­ Du hast noch keine HÃ¼tten eingetragen.", "bot");
      return;
    }

    chatWindow.innerHTML = "";
    addMessage("ğŸ  Deine HÃ¼tten:", "bot");

    const docs = snapshot.docs.filter(doc => {
      const status = doc.data().status;
      return status !== "archiviert" || typeof status === "undefined";
    });

    docs.forEach(doc => {
      const d = doc.data();
      const id = doc.id;

      const container = document.createElement("div");
      container.className = "p-4 bg-white rounded-xl shadow mb-4 text-sm";

      // HTML fÃ¼r die HÃ¼tte
      container.innerHTML = `
        <label>ğŸ·ï¸ Name:<br>
          <input type='text' data-id='${id}' class='edit-name w-full border px-2 py-1 rounded'
                 value='${d.name || ''}'/>
        </label><br><br>

        <label>ğŸ“ Adresse:<br>
          <input type='text' id='address-input-${id}' 
                 class='edit-address w-full border px-2 py-1 rounded' 
                 value='${d.address || ''}' placeholder="StraÃŸe, Ort"/>
          <div id="address-suggestions-${id}" class="mt-1 space-y-1"></div>
        </label><br><br>

        <label>ğŸ¾ Tiere:<br>
          <div id="tiere-options-${id}" class="flex flex-wrap gap-2"></div>
        </label><br>

        <label>ğŸ“ Beschreibung:<br>
          <div id="editor-${id}" class="quill-editor border rounded"></div>
        </label><br>

        <button class="choice-btn mt-2" onclick="saveEdit('${id}')">ğŸ’¾ Speichern</button>
        <button class="choice-btn mt-2 bg-red-500 text-white" onclick="deleteHut('${id}')">ğŸ—‘ï¸ LÃ¶schen</button>
      `;

      chatWindow.appendChild(container);

      // Tiere rendern
      const tiere = ["ğŸ Ziege", "ğŸ„ Kuh", "ğŸ“ Huhn", "ğŸ• Hund", "ğŸ‡ Hase"];
      const tiereContainer = container.querySelector(`#tiere-options-${id}`);
      const selectedTiere = d.tiere || [];
      tiere.forEach(tier => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-1";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = tier;
        cb.checked = selectedTiere.includes(tier);
        label.appendChild(cb);
        label.appendChild(document.createTextNode(tier));
        tiereContainer.appendChild(label);
      });

      // Quill Editor fÃ¼r Beschreibung
      setTimeout(() => {
        const quill = new Quill(`#editor-${id}`, { theme: 'snow' });
        quill.root.innerHTML = d.beschreibung || "";
        container.querySelector("button.choice-btn").onclick = () => saveEdit(id, quill);
      }, 200);

      // Adresse Autocomplete
      setTimeout(() => enableAddressAutocomplete(id), 300);
    });

    chatWindow.scrollTop = chatWindow.scrollHeight;

  } catch (err) {
    console.error("âŒ Fehler beim Laden der HÃ¼tten:", err);
    addMessage("âŒ Fehler beim Laden deiner HÃ¼tten: " + err.message, "bot");
  }
}
/*async function showMyHuts() {
  chatWindow.innerHTML = '';

  const snapshot = await db.collection('eierhuetten')
    .where('userId', '==', currentUser.uid)
    .get();

  const docs = snapshot.docs.filter(doc => {
    const status = doc.data().status;
    return status !== "archiviert" || typeof status === "undefined";
  });
  
  if (snapshot.empty) return addMessage('Du hast noch keine HÃ¼tten.', 'bot');

  let total = 0, angenommen = 0, offen = 0;
  docs.forEach(doc => {
    const d = doc.data();
    total++;
    if (d.status === 'angenommen') angenommen++;
    if (d.status === 'offen') offen++;
  });

  // Statistik-Balken
  const statsBar = document.createElement('div');
  statsBar.className = 'flex justify-around items-center text-sm bg-green-100 text-green-900 py-2 px-4 rounded mb-3 shadow-sm border border-green-300';
  statsBar.innerHTML = `
    <div title="Eingereichte HÃ¼tten">ğŸ¥š <strong>${total}</strong>/10</div>
    <div title="Angenommen">âœ… <strong>${angenommen}</strong></div>
    <div title="Offen">â³ <strong>${offen}</strong></div>
  `;
  chatWindow.appendChild(statsBar);

  // Jede HÃ¼tte rendern
  docs.forEach(doc => {
    const d = doc.data();
    const id = doc.id;
    const div = document.createElement('div');
    div.className = 'message bot';

    const minimapId = `minimap-${id}`;

    div.innerHTML = `
      <div class="text-sm space-y-2">
        <div class='font-bold text-lg'>ğŸ¡ ${d.name}</div>
        <div class='font-bold'>ğŸ“Œ Status: ${d.status}</div>

        ${d.status === 'angenommen' ? `
          <label>ğŸ“ Name:<br>
            <input type='text' data-id='${id}' class='edit-name w-full border px-2 py-1 rounded' value='${d.name}' />
          </label><br>

          <label>ğŸª‘ SitzplÃ¤tze:
            <select data-id='${id}' class='edit-sitz border rounded px-2 py-1 ml-2'>
              <option ${d.sitzplaetze === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.sitzplaetze === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>ğŸ”Œ Strom:
            <select data-id='${id}' class='edit-strom border rounded px-2 py-1 ml-2'>
              <option ${d.strom === 'Ja' ? 'selected' : ''}>Ja</option>
              <option ${d.strom === 'Nein' ? 'selected' : ''}>Nein</option>
            </select>
          </label><br>

          <label>âœ¨ Extras:<br>
            <input type='text' data-id='${id}' class='edit-extras w-full border px-2 py-1 rounded' value='${d.extras || ''}' />
          </label><br>

          <label>ğŸ¾ Tiere:<br>
          <input type='text' data-id='${id}' class='edit-tiere w-full border px-2 py-1 rounded'
             value='${(d.tiere || []).join(", ")}' placeholder="z. B. ğŸ Ziege, ğŸ“ Huhn" />
          </label>

          <label>ğŸ“ Beschreibung:<br>
  <div id="editor-${id}" class="quill-editor border rounded"></div>
</label><br>

          <label>ğŸ·ï¸ Tags:<br>
            <input type='text' data-id='${id}' class='edit-tags w-full border px-2 py-1 rounded' value='${(d.tags || []).join(", ")}' placeholder="max. 5, Komma getrennt"/>
          </label><br>

          <label>ğŸ•’ Ã–ffnungszeiten:<br>
            <input type='text' data-id='${id}' class='edit-zeiten w-full border px-2 py-1 rounded' value='${d.oeffnungszeiten || ''}' />
          </label><br>

<label>ğŸ“ Adresse:<br>
  <input type='text' id='address-input-${id}' 
         class='edit-address w-full border px-2 py-1 rounded' 
         value='${d.address || ''}' placeholder="StraÃŸe, Ort"/>
  <div id="address-suggestions-${id}" class="mt-1 space-y-1"></div>
</label><br>
          <button class='edit-btn' onclick='saveEdit("${id}")'>ğŸ’¾ Speichern</button>
          <button class='delete-btn' onclick='deleteHut("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
        ` : `
          <div class="text-gray-500 italic">â›” Nur nach Freigabe bearbeitbar.</div>
          <button class='delete-btn' onclick='deleteHut("${id}")'>ğŸ—‘ï¸ LÃ¶schen</button>
        `}

        <!-- Bildergalerie -->
        ${Array.isArray(d.fotos) && d.fotos.length ? `
          <div class='flex flex-col gap-2 mt-2'>
            ${d.fotos.map(img => {
              const isString = typeof img === 'string';
              const url = isString ? img : img.url;
              const del = isString ? '' : (img.delete_url || '');
              const status = isString ? 'freigegeben' : (img.status || 'freigegeben');
              const pending = status === 'wartet';
              return `
                <div class="flex items-center gap-4 bg-gray-50 p-2 rounded border relative">
                  <div class="relative group">
                    <img src="${url}" class="h-20 w-20 object-cover rounded shadow ${pending ? 'opacity-50' : ''}"/>
                    ${!pending ? `
                      <button onclick="deleteImage('${id}', '${url}', '${del}')" 
                        class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-1 opacity-0 group-hover:opacity-100 transition">
                        âœ•
                      </button>
                    ` : ''}
                  </div>
                  <div class="flex-1 text-xs break-all text-gray-600">
                    <div><strong>Status:</strong> ${pending ? '<span class="text-orange-600">â³ wartet</span>' : 'âœ… frei'}</div>
                    <div><strong>Delete:</strong><br><code>${del || '-'}</code></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}

        <!-- Upload -->
        <label class="block mt-2 text-sm">ğŸ“· Neues Bild:
          <input type="file" accept="image/*" data-id="${id}" class="upload-image mt-1" />
        </label>
        <div id="progress-${id}" class="h-2 bg-gray-200 rounded hidden mt-2">
          <div class="h-2 bg-green-500 rounded" style="width: 0%"></div>
        </div>
        <div id="progress-label-${id}" class="text-xs text-gray-600 mt-1">0%</div>

        <!-- Nachrichten-Checkbox -->
        <label class="inline-flex items-center mt-2">
          <input type="checkbox" id="allowMessages-${id}" ${d.allowMessages ? 'checked' : ''} class="mr-2">
          Nachrichten aktivieren
        </label>
        <button onclick="toggleMessages('${id}')" class="ml-2 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Speichern</button>

        <!-- Nachrichtenbereich -->
        ${d.status === 'angenommen' && d.allowMessages === true ? `
          <div id="chat-${id}" class="mt-2 p-2 bg-gray-100 rounded">
            <strong>ğŸ’¬ Nachrichten fÃ¼r ${d.name}</strong>
            <div id="chat-messages-${id}" class="mt-1 space-y-1 max-h-48 overflow-y-auto">Lade Nachrichten...</div>
          </div>
        ` : ''}

        <!-- Mini-Map -->
        <div id="${minimapId}" class="minimap h-40 mt-2 rounded border"></div>
      </div>
    `;
    chatWindow.appendChild(div);
setTimeout(() => {
  const quill = new Quill(`#editor-${id}`, { theme: 'snow' });
  quill.root.innerHTML = d.beschreibung || "";

  // Speichern Ã¼berschreiben
  document.querySelector(`.edit-btn[onclick='saveEdit("${id}")']`).onclick = () => {
    const beschreibungHTML = quill.root.innerHTML;
    saveEdit(id, beschreibungHTML);
  };
}, 300);
    // Mini-Map
    if (d.location?.latitude && d.location?.longitude) {
      setTimeout(() => {
        const m = L.map(minimapId, { zoomControl: true }).setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);

        const marker = L.marker([d.location.latitude, d.location.longitude], {
          draggable: d.status === 'angenommen'
        }).addTo(m);

        if (d.status === 'angenommen') {
          marker.on('dragend', e => {
            const pos = e.target.getLatLng();
            db.collection('eierhuetten').doc(id).update({
              location: new firebase.firestore.GeoPoint(pos.lat, pos.lng)
            }).then(() => {
              addMessage(`ğŸ“ Neuer Standort fÃ¼r "${d.name}" gespeichert.`, 'bot');
            });
          });
        }
      }, 300);
    }

    // Nachrichten laden
    if (d.status === 'angenommen' && d.allowMessages === true) {
      (async () => {
        try {
          await ladeHutNachrichtenListe(id);
        } catch (err) {
          const container = document.getElementById(`chat-messages-${id}`);
          if (container) container.innerHTML = `<em>Fehler beim Laden der Nachrichten: ${err.message}</em>`;
          console.error('Fehler beim Laden der Nachrichten fÃ¼r HÃ¼tte ' + err.message, id, err);
        }
      })();
    }
    setTimeout(() => enableAddressAutocomplete(id), 200);
  });
}*/

async function saveEdit(id, quill = null) {
  try {
    const name = document.querySelector(`.edit-name[data-id='${id}']`)?.value || "";
    const address = document.getElementById(`address-input-${id}`)?.value || "";

    // Tiere sammeln
    const tiereContainer = document.getElementById(`tiere-options-${id}`);
    const tiere = [...tiereContainer.querySelectorAll("input[type=checkbox]:checked")]
      .map(cb => cb.value);

    // Beschreibung aus Quill oder Textfeld
    const beschreibung = quill ? quill.root.innerHTML :
      document.querySelector(`.edit-beschreibung[data-id='${id}']`)?.value || "";

    await db.collection("eierhuetten").doc(id).update({
      name,
      address,
      tiere,
      beschreibung,
      status: "offen"
    });

    addMessage("âœ… Ã„nderungen gespeichert. â³ Muss erneut durch Admin freigeschaltet werden.", "bot");
    showMyHuts();

  } catch (err) {
    console.error("âŒ Fehler beim Speichern:", err);
    addMessage("âŒ Fehler beim Speichern: " + err.message, "bot");
  }
}

async function deleteHut(id) {
  if (!confirm('â— MÃ¶chtest du diese HÃ¼tte wirklich lÃ¶schen?')) return;

  const doc = await db.collection('eierhuetten').doc(id).get();
  if (!doc.exists) {
    addMessage('âŒ HÃ¼tte nicht gefunden.', 'bot');
    return;
  }

  const hut = doc.data();
  const user = firebase.auth().currentUser;



  try {
    const user = firebase.auth().currentUser;
    if (!user) {
      addMessage("âŒ Du musst eingeloggt sein, um die Eintragung zu lÃ¶schen.", "bot");
      return;
    }

 
      await db.collection('eierhuetten').doc(id).update({
        status: "archiviert",
        archiviertAm: firebase.firestore.FieldValue.serverTimestamp()
      });
      addMessage('ğŸ—ƒï¸ HÃ¼tte archiviert.', 'bot');
      showMyHuts();

  } catch (err) {
    console.error('âŒ Fehler bei KÃ¼ndigung:', err);
    addMessage('âŒ Eintragung konnte nicht gelÃ¶scht werden.  kontaktieren.', 'bot');
    frageSupportBeiAboProblem(user, hut);
  }
}

  


async function uploadSuggestionFotos(inputEl) {
  const files = inputEl.files;
  const fotos = [];

  for (let f of files) {
    const ref = firebase.storage().ref("vorschlagFotos/" + Date.now() + "-" + f.name);
    await ref.put(f);
    fotos.push(await ref.getDownloadURL());
  }

  editingData.fotos = fotos;

  // in Firestore speichern
  const docRef = await db.collection("vorschlaege").add({
    emailBesitzer: editingData.email,
    kommentar: editingData.comment || "",
    fotos: fotos,
    erstelltAm: new Date(),
    status: "vorgeschlagen"
  });

  // Firebase Function fÃ¼r Mail triggern
  await fetch("https://us-central1-YOUR_PROJECT.cloudfunctions.net/sendSuggestionMail", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: docRef.id, email: editingData.email })
  });

  addMessage("âœ… Dein Vorschlag wurde gespeichert und eine E-Mail an den Besitzer gesendet!", "bot");
  step = null;
}

function frageSupportBeiAboProblem(user, hut) {
  const vorschlag = `Ich mÃ¶chte die HÃ¼tte "${hut.name || 'Unbekannt'}" lÃ¶schen, aber es konnte nicht automatisch gelÃ¶scht werden.`;

  addMessage(
  `âŒ Die automatische lÃ¶schung deiner Eintragung ist fehlgeschlagen.<br><br>
   ğŸ‘‰ <a href="#" id="supportLink">Support kontaktieren</a>`,
  'bot',
  true
);

setTimeout(() => {
  const link = document.getElementById('supportLink');
  if (link) {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      zeigeSupportFormularMitVorschlag(vorschlag);
    });
  }
}, 100);
}

function zeigeSupportFormularMitVorschlag(vorlage) {
  const nutzerZusatzeingabe = prompt(
    `ğŸ†˜ Support-Anfrage\n\nWir haben folgendes fÃ¼r dich vorbereitet:\n\n${vorlage}\n\nDu kannst hier noch optional etwas hinzufÃ¼gen:`
  );

  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage("ğŸš« Du musst eingeloggt sein, um den Support zu kontaktieren.", "bot");
    return;
  }

  const gesamttext = nutzerZusatzeingabe && nutzerZusatzeingabe.trim().length > 0
    ? `${vorlage}\n\nZusatz des Nutzers:\n${nutzerZusatzeingabe.trim()}`
    : vorlage;

  db.collection("supportTickets").add({
    userId: user.uid,
    email: user.email,
    message: gesamttext,
    status: "offen",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    addMessage("âœ… Deine Support-Anfrage wurde gesendet. Wir kÃ¼mmern uns darum!", "bot");
  }).catch(err => {
    console.error("âŒ Fehler beim Senden:", err);
    addMessage("âš ï¸ Es gab ein Problem beim Senden deiner Anfrage. Bitte versuche es spÃ¤ter erneut.", "bot");
  });
}
// Nachrichten fÃ¼r eine HÃ¼tte laden und als Liste anzeigen
async function ladeHutNachrichtenListe(hutId) {
  const container = document.getElementById(`chat-messages-${hutId}`);
  if (!container) return;

  container.innerHTML = 'Lade Nachrichten...';

  try {
    const snapshot = await db.collection('hutMessages')
      .where('hutId', '==', hutId)
      .orderBy('createdAt', 'desc') // ğŸ”¹ Firestore Index erforderlich!
      .get();

    if (snapshot.empty) {
      container.innerHTML = '<em>Keine Nachrichten vorhanden.</em>';
      return;
    }

    container.innerHTML = '';

    snapshot.forEach(doc => {
      const t = doc.data();

      // Nur anzeigen, wenn archived nicht gesetzt oder nicht true
      if (t.archived === true) return;

      const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const sender = t.senderName || 'Unbekannt';
      const message = t.message || '(leer)';
      const answered = t.answered ? 'âœ… beantwortet' : 'âŒ offen';

      const msgDiv = document.createElement('div');
      msgDiv.style.background = '#fff';
      msgDiv.style.borderLeft = '3px solid #10b981';
      msgDiv.style.padding = '4px 8px';
      msgDiv.style.fontSize = '0.85rem';
      msgDiv.style.marginBottom = '4px';
      msgDiv.innerHTML = `
        <div>
          <strong>ğŸ“… ${datum}</strong> | ğŸ‘¤ ${sender} | Status: ${answered}
          <button onclick="loescheHutNachricht('${doc.id}', '${hutId}')"
                  style="float:right; background:orange; color:white; border:none; border-radius:3px; padding:0 5px; cursor:pointer;">LÃ¶schen?</button>
        </div>
        <div>ğŸ’¬ ${message}</div>
      `;
      container.appendChild(msgDiv);
    });

  } catch (err) {
    console.error('Fehler beim Laden der Nachrichten fÃ¼r HÃ¼tte', hutId, err);
    container.innerHTML = `<em>Fehler beim Laden der Nachrichten: ${err.message}</em>`;
  }
}
async function toggleMessages(hutId) {
  const checkbox = document.getElementById(`allowMessages-${hutId}`);
  const allow = checkbox.checked;
  const chatDiv = document.getElementById(`chat-${hutId}`);

  try {
    await db.collection('eierhuetten').doc(hutId).update({ allowMessages: allow });
    alert(`Nachrichtensystem ${allow ? 'aktiviert' : 'deaktiviert'}!`);
    // Chatbereich ein-/ausblenden
    if (chatDiv) chatDiv.style.display = allow ? 'block' : 'none';
    
    // Nachrichten laden, falls aktiviert
    if (allow) {
      ladeHutNachrichtenListe(hutId);
    }
  } catch (err) {
    console.error('Fehler beim Aktualisieren von allowMessages:', err);
    alert('Fehler beim Speichern der Einstellung.');
    // Checkbox zurÃ¼cksetzen
    checkbox.checked = !allow;
  }
}
// Nachricht lÃ¶schen
async function loescheHutNachricht(msgId, hutId) {
  if (!confirm('Willst du diese Nachricht wirklich lÃ¶schen?')) return;

  try {
    await db.collection('hutMessages').doc(msgId).delete();
    // Nachrichtenliste neu laden
    ladeHutNachrichtenListe(hutId);
  } catch (err) {
    console.error('Fehler beim LÃ¶schen der Nachricht:', err);
    alert('Fehler beim LÃ¶schen der Nachricht.');
  }
}

// Funktion zum Senden einer Nachricht
/*async function sendHutMessage(hutId) {
  const input = document.getElementById(`chat-input-${hutId}`);
  const text = input.value.trim();
  if (!text) return alert('Bitte zuerst eine Nachricht eingeben.');

  const currentUser = firebase.auth().currentUser;
  const senderName = currentUser?.displayName || currentUser?.email || 'Unbekannt';

  try {
    await db.collection('hutMessages').add({
      hutId,
      hutName: document.querySelector(`#chat-${hutId} strong`).innerText.replace('ğŸ’¬ Nachrichten fÃ¼r ', ''),
      senderName,
      message: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      answered: false,
      ownerReply: null
    });

    input.value = '';
    ladeHutNachrichten(hutId); // Chat neu laden
  } catch (err) {
    console.error('Fehler beim Senden der Nachricht:', err);
    alert('Fehler beim Senden der Nachricht.');
  }
}*/




async function deleteImage(hutId, imageUrl, deleteUrl) {
  if (!confirm('â— MÃ¶chtest du dieses Bild wirklich lÃ¶schen?')) return;

  try {
    // 1. Firestore-Eintrag laden
    const docRef = db.collection('eierhuetten').doc(hutId);
    const doc = await docRef.get();
    if (!doc.exists) return alert('âŒ HÃ¼tte nicht gefunden.');

    const data = doc.data();
    const fotos = (data.fotos || []).filter(img => img.url !== imageUrl);

    // 2. Firestore updaten
    await docRef.update({ fotos });

    // 3. Optional: Bild bei imgbb lÃ¶schen
    if (deleteUrl) {
      await fetch(deleteUrl, { method: 'GET' });
      console.log('âœ… Bild bei imgbb gelÃ¶scht');
    }

    // 4. UI neu laden
    addMessage('âœ… Bild wurde gelÃ¶scht.', 'bot');
    showMyHuts();

  } catch (err) {
    console.error('âŒ Fehler beim LÃ¶schen:', err);
    alert('âŒ Fehler beim LÃ¶schen des Bildes.');
  }
}
async function submitNewHut() {
/* const zustimmung = document.getElementById('datenschutz-zustimmung');
  if (!zustimmung.checked) {
    alert('â— Bitte bestÃ¤tige die DatenschutzerklÃ¤rung, um fortzufahren.');
    return;
  }*/
  
  if (!editingData.name || !editingData.location) {
    addMessage('âŒ Bitte gib alle Daten ein (mindestens Name und Standort).', 'bot');
    return;
  }

  // ğŸ”’ Sicherheit: Nur gÃ¼ltige Bilder Ã¼bernehmen (mit url UND delete_url)
  const validFotos = (editingData.fotos || []).filter(f =>
    typeof f === 'object' &&
    f.url &&
    f.delete_url
  );

  const hut = {
    ...editingData,
    userId: currentUser.uid,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'offen',
    fotos: validFotos,
    datenschutzZustimmung: {
       bestÃ¤tigtAm: firebase.firestore.FieldValue.serverTimestamp(),
       durch: firebase.auth().currentUser?.email || "Gast"
    }
  };

  console.log('ğŸ“¸ Fotos werden gespeichert:', JSON.stringify(hut.fotos));

  try {
    const docRef = await db.collection('eierhuetten').add(hut);
    addMessage('ğŸ‰ Deine HÃ¼tte wurde erfolgreich erstellt.', 'bot');
    db.collection('eierhuetten').doc(docRef.id).update({
            status: 'offen'
          }).then(() => {
               addMessage('âœ… Deine HÃ¼tte wurde zur Freigabe weitergeleitet.', 'bot');
              addMessage('Wir prÃ¼fen nun Deine Angaben und schalten alles frei, sobald alles passt.', 'bot');
            setTimeout(() => {
              showMyHuts();
              startDialog();
            }, 5000);
    
          });

    // Reset
    step = 0;
    editingData = {};

  } catch (err) {
    addMessage('âŒ Fehler beim Erstellen der HÃ¼tte: ' + err.message, 'bot');
    setTimeout(() => startDialog(), 1500);
  }
}
// Authentifizierung
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('main-section').classList.remove('hidden');
    if (!localStorage.getItem("tutorialDone")) {
      showTutorial();
  localStorage.setItem("tutorialDone", "true");
  }else{
    
    startDialog();
    }
  }
});
document.getElementById('google-login').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => {
      const user = result.user;
      checkConsent(user);
    })
    .catch(error => {
      console.error('Login fehlgeschlagen:', error);
    });
};
sendBtn.addEventListener('click', () => {
  const val = chatInput.value.trim();
  if (!val) return;
  addMessage(val, 'user');
  chatInput.value = '';
  processUserInput(val);
});
chatInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendBtn.click();
});
  function checkConsent(user) {
  const consentGiven = localStorage.getItem('consentGiven');

  if (consentGiven === 'true') {
    startApp(user);
    return;
  }

  const modal = document.getElementById('consent-modal');
  modal.style.display = 'flex';

  document.getElementById('consent-accept').onclick = async () => {
    const privacyChecked = document.getElementById('consent-privacy').checked;
    const cookiesChecked = document.getElementById('consent-cookies').checked;

    if (!privacyChecked || !cookiesChecked) {
      alert('Bitte beide KÃ¤stchen ankreuzen, um fortzufahren.');
      return;
    }

    localStorage.setItem('consentGiven', 'true');

    // Optional: In Firestore dokumentieren
    await db.collection('consents').doc(user.uid).set({
      privacy: true,
      cookies: true,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    modal.style.display = 'none';
    startApp(user);
  };
    }
function showSuggestionMap() {
  const container = document.createElement('div');
  container.className = 'message bot';
  container.innerHTML = `<div class="font-bold mb-1">ğŸ“ Bitte wÃ¤hle den Standort deiner HÃ¼tte:</div><div id="map"></div>`;
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    setTimeout(() => {
      map = L.map('map').setView([latitude, longitude], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

      marker.on('dragend', e => {
        const pos = e.target.getLatLng();
        editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
      });

      editingData.location = new firebase.firestore.GeoPoint(latitude, longitude);

      const btn = document.createElement('button');
      btn.className = 'choice-btn mt-2';
      btn.textContent = 'âœ… Vorschlag senden';
      btn.onclick = () => {
        container.remove();
       fetch('https://us-central1-eierhuettentour.cloudfunctions.net/sendSuggestionMail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: generateUniqueId(),
          email: editingData.email,
          comment: editingData.comment,
          location: editingData.location, // { latitude, longitude }
        }),
      })
      .then(res => res.json())
      .then(data => addMessage('âœ… Vorschlag erfolgreich gesendet!', 'bot'))
      .catch(err => addMessage('âŒ Fehler beim Senden: ' + err.message, 'bot'));
        step = null;
      };
      container.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 100);
  }, () => {
    addMessage('âŒ Standort konnte nicht ermittelt werden.', 'bot');
  });
}
function zeigeMapFuerSpielplatz() {
  const container = document.createElement('div');
  container.className = 'message bot';
  container.innerHTML = `<div class="font-bold mb-1">ğŸ“ Bitte wÃ¤hle den Standort des Spielplatzes:</div><div id="map"></div>`;
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    setTimeout(() => {
      map = L.map('map').setView([latitude, longitude], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

      marker.on('dragend', e => {
        const pos = e.target.getLatLng();
        editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
      });

      // Erste Position speichern
      editingData.location = new firebase.firestore.GeoPoint(latitude, longitude);

      // Weiter-Button
      // Weiter-Button mit Upload-Option
const btn = document.createElement('button');
btn.className = 'choice-btn mt-2';
btn.textContent = 'âœ… Weiter';
btn.onclick = () => {
  container.remove();
  processUserInput("location_set"); // â¬…ï¸ NÃ¤chster Schritt
};
container.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 100);
  }, () => {
    addMessage('âŒ Standort konnte nicht ermittelt werden.', 'bot');
  });
}

function showMap() {
  const container = document.createElement('div');
  container.className = 'message bot';
  container.innerHTML = `<div class="font-bold mb-1">ğŸ“ Bitte wÃ¤hle den Standort deiner HÃ¼tte:</div><div id="map"></div>`;
  chatWindow.appendChild(container);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    setTimeout(() => {
      map = L.map('map').setView([latitude, longitude], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

      marker.on('dragend', e => {
        const pos = e.target.getLatLng();
        editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
      });

      // Erste Position speichern
      editingData.location = new firebase.firestore.GeoPoint(latitude, longitude);

      // Weiter-Button
      // Weiter-Button mit Upload-Option
const btn = document.createElement('button');
btn.className = 'choice-btn mt-2';
btn.textContent = 'âœ… Weiter zu Bilderupload';
btn.onclick = () => {
  container.remove();
  askForImageUpload(); // â¬…ï¸ NÃ¤chster Schritt
};
container.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }, 100);
  }, () => {
    addMessage('âŒ Standort konnte nicht ermittelt werden.', 'bot');
  });
}
  function initImageUpload() {
  document.querySelectorAll(".upload-image").forEach(input => {
    input.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      const id = e.target.dataset.id;
      if (!file || !id) return;

      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(`eierhuetten/${id}/${Date.now()}_${file.name}`);
      const uploadTask = fileRef.put(file);

      const progressBar = document.querySelector(`#progress-${id}`);
      const progressFill = progressBar?.firstElementChild;

      if (progressBar) progressBar.classList.remove("hidden");

      uploadTask.on("state_changed",
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          if (progressFill) progressFill.style.width = `${progress.toFixed(0)}%`;
        },
        (error) => {
          console.error("âŒ Upload-Fehler:", error);
          addMessage("âŒ Fehler beim Hochladen des Bildes.", "bot");
        },
        async () => {
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          // ğŸ“ URL in die Datenbank einfÃ¼gen
          const hutRef = db.collection("eierhuetten").doc(id);
          await hutRef.update({
            fotos: firebase.firestore.FieldValue.arrayUnion(url)
          });
          addMessage("âœ… Bild erfolgreich hochgeladen.", "bot");
          showMyHuts(); // Seite aktualisieren
        }
      );
    });
  });
  }
function askForImageUpload() {
  addMessage('ğŸ“· MÃ¶chtest du Fotos deiner HÃ¼tte hochladen?', 'bot');
  addChoiceButtons(['Ja, Bilder auswÃ¤hlen', 'Nein, direkt speichern'], antwort => {
    if (antwort.includes('Nein')) {
      submitNewHut(); // ohne Bilder
    } else {
      const uploadInput = document.getElementById('image-upload');
      uploadInput.onchange = async () => {
        const files = Array.from(uploadInput.files);
        if (files.length === 0) return submitNewHut();

        addMessage(`â³ Lade ${files.length} Bild(er) hoch...`, 'bot');
        const uploads = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();

          const base64 = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = () => reject('âŒ Fehler beim Lesen der Datei.');
            reader.readAsDataURL(file);
          });

          try {
            const formData = new FormData();
            formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // dein imgbb Key
            formData.append('image', base64);

            const res = await fetch('https://api.imgbb.com/1/upload', {
              method: 'POST',
              body: formData
            });

            const json = await res.json();

            if (json?.data?.url && json?.data?.delete_url) {
              uploads.push({
                url: json.data.url,
                delete_url: json.data.delete_url,
                status: 'wartet'
                
              });
            } else {
              console.warn('âŒ Upload war unvollstÃ¤ndig oder fehlerhaft:', json);
              addMessage(`âŒ Fehler beim Hochladen von Bild ${i + 1}`, 'bot');
            }

          } catch (err) {
            console.error(err);
            addMessage(`âŒ Upload-Fehler: ${err}`, 'bot');
          }
        }

        editingData.fotos = uploads;  // Wichtig: hier speicherst du die vollstÃ¤ndigen Objekte!
        addMessage('âœ… Bilder wurden erfolgreich hochgeladen.', 'bot');
        submitNewHut();
      };
      uploadInput.click();
    }
  });
}
document.body.addEventListener('change', async e => {
  if (e.target.classList.contains('upload-image')) {
    const file = e.target.files[0];
    const hutId = e.target.dataset.id;
    const progressBar = document.querySelector(`#progress-${hutId}`);
    const progressInner = progressBar?.firstElementChild;

    if (!file || !hutId || !progressBar || !progressInner) return;

    try {
      progressBar.classList.remove('hidden');
      progressInner.style.width = "30%";

      const imageData = await uploadToImgBB(file, percent => {
        progressInner.style.width = `${percent}%`;
      });

      progressInner.style.width = "100%";

      await db.collection("eierhuetten").doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(imageData) // âœ… Korrekt: ganzes Objekt
      });

      addMessage("âœ… Bild erfolgreich hochgeladen.", "bot");
      showMyHuts();
    } catch (err) {
      console.error("Fehler beim Upload:", err);
      addMessage("âŒ Upload fehlgeschlagen: " + err, "bot");
    } finally {
      e.target.value = '';
      setTimeout(() => {
        progressBar.classList.add('hidden');
        progressInner.style.width = "0%";
      }, 2000);
    }
  }
});


  // Warten bis DOM geladen ist
  document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    // Nicht eingeloggt
    return;
  }

  const consentGiven = localStorage.getItem('consentGiven');
  if (consentGiven === 'true') {
    startApp(user);
  } else {
    checkConsent(user);
  }
});
    });
  
  
function logout() {
  firebase.auth().signOut().then(() => {
    location.reload(); // Seite neu laden nach Logout
  }).catch(error => {
    alert('Fehler beim Abmelden: ' + error.message);
  });
}
function goToMainPage() {
  window.location.href = '/'; // Passe ggf. die URL an (z.â€¯B. '/index.html')
}
function refresh() {
  location.reload(); // â¬…ï¸ Das lÃ¤dt die gesamte Seite neu
}
/*async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  if (!user) {
    addMessage('âš ï¸ Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  const snapshot = await db.collection('supportTickets')
    .where('userId', '==', user.uid)
    .orderBy('createdAt', 'desc')
    .limit(10)
    .get();

  if (snapshot.empty) {
    addMessage('ğŸ“­ Du hast noch keine Support-Anfragen gestellt.', 'bot');
    return;
  }

  addMessage(`ğŸ“¨ Hier sind deine letzten Support-Anfragen:`, 'bot');

  snapshot.forEach(doc => {
    const t = doc.data();
    const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
    const status = t.status || 'offen';
    const message = t.message || '(leer)';

    addMessage(`
      <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
        <div><strong>ğŸ“… ${datum}</strong></div>
        <div class="mt-1">ğŸ’¬ ${message}</div>
        <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
      </div>
    `, 'bot', true);
  });
}*/
async function ladeMeineSupportTickets() {
  const user = firebase.auth().currentUser;
  console.log('ğŸ” Aktueller Nutzer:', user);

  if (!user) {
    addMessage('âš ï¸ Du musst angemeldet sein, um deine Support-Tickets zu sehen.', 'bot');
    return;
  }

  try {
    const ref = db.collection('supportTickets')
      .where('userId', '==', user.uid)
      //.orderBy('createdAt', 'desc')
      .limit(10);

    console.log('ğŸ“¤ Firestore-Query:', ref);

    const snapshot = await ref.get();
    console.log('ğŸ“¥ Gefundene Tickets:', snapshot.size);

    if (snapshot.empty) {
      addMessage('ğŸ“­ Du hast noch keine Support-Anfragen gestellt.', 'bot');
      return;
    }

    addMessage(`ğŸ“¨ Hier sind deine letzten Support-Anfragen:`, 'bot');

    snapshot.forEach(doc => {
      const t = doc.data();
      console.log('ğŸ“„ Ticket:', t);

      const datum = t.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const status = t.status || 'offen';
      const message = t.message || '(leer)';

      addMessage(`
        <div style="background:#f9f9f9; padding:10px; border-left:4px solid #3b82f6; margin-bottom:10px; font-size: 0.9rem;">
          <div><strong>ğŸ“… ${datum}</strong></div>
          <div class="mt-1">ğŸ’¬ ${message}</div>
          <div class="mt-1 text-sm text-gray-600">Status: <strong>${status}</strong></div>
        </div>
      `, 'bot', true);
    });
  } catch (err) {
    console.error('âŒ Fehler beim Laden der Tickets:', err);
    addMessage('âŒ Fehler beim Abrufen deiner Tickets. Bitte spÃ¤ter erneut versuchen.', 'bot');
  }
}
  function showTutorial() {
  chatWindow.innerHTML = '';
  addMessage('ğŸ‘‹ Moin moin! Ich bin dein Assistent fÃ¼r Fahrradstops.');
  addMessage('ğŸ“Œ Hier kannst du deine Fahrrad-HÃ¼tte eintragen, verwalten und sichtbar machen.');
  
  setTimeout(() => {
    addMessage('ğŸ’¬ Du sprichst mit mir Ã¼ber den Chat. WÃ¤hle einfach eine Option oder antworte manuell.');
  }, 1000);

  setTimeout(() => {
    addMessage('ğŸ†“ Jede neue HÃ¼tte muss von der Administration freigegeben werden, wundere Dich nicht, wenn sie nicht direkt zu sehen ist.');
  }, 4000);

  setTimeout(() => {
    addMessage('âŒ MÃ¶chtest du das die HÃ¼tte nicht mehr zusehen sind? Dann lÃ¶sche einfach den Eintrag â€“ alle Daten in verbindung mit dem Eintrag werden archiviert.');
  }, 6000);

  setTimeout(() => {
    addMessage('âš™ï¸ Unter **â€Meine HÃ¼tten anzeigenâ€œ** kannst du jederzeit deine Daten anpassen, z.â€¯B. den Standort per Karte oder Texte und Bilder.');
  }, 8000);

  setTimeout(() => {
    addMessage('ğŸ‰ Bereit? Was mÃ¶chtest du tun?', 'bot');
    addChoiceButtons(['ğŸ¥š Neue HÃ¼tte erstellen', 'ğŸ“‹ Meine HÃ¼tten anzeigen'], handleIntent);
  }, 10000);
  }

  let currentUserForConsent = null;

function loadTrackingScripts(consent) {
  // Statistik
  if (consent.cookieStats) {
    const gaScript = document.createElement('script');
    gaScript.src = "https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-X"; // Deine GA-ID
    gaScript.async = true;
    document.head.appendChild(gaScript);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-XXXXXXX-X'); // Deine GA-ID
  }

  // Marketing
  if (consent.cookieMarketing) {
    const fbScript = document.createElement('script');
    fbScript.innerHTML = `
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'YOUR_PIXEL_ID');
      fbq('track', 'PageView');
    `;
    document.head.appendChild(fbScript);
  }
}

function showConsentModal(user) {
  currentUserForConsent = user;
  document.getElementById('consent-modal').classList.remove('hidden');
}
async function acceptConsent() {
  const privacyAccepted = document.getElementById('consent-privacy').checked;
  const cookiesAccepted = document.getElementById('consent-cookies').checked;

  if (!privacyAccepted) {
    alert('Bitte stimmen Sie der DatenschutzerklÃ¤rung zu.');
    return;
  }
  if (!cookiesAccepted) {
    alert('Bitte stimmen Sie der Verwendung von Cookies zu.');
    return;
  }

  const consentData = {
    privacyAccepted: true,
    cookiesAccepted: true,
    consentDate: new Date(),
    privacyVersion: '1.0'
  };

  if (currentUserForConsent && currentUserForConsent.uid) {
    // User eingeloggt: Zustimmung in Firebase speichern
    try {
      await db.collection('users').doc(currentUserForConsent.uid).set(consentData, { merge: true });
    } catch (error) {
      console.error('Fehler beim Speichern in Firebase:', error);
      // Falls gewÃ¼nscht: lokale Speicherung trotzdem machen
    }
  } else {
    console.log('User nicht eingeloggt, speichere Zustimmung nur lokal');
  }

  // Zustimmung immer lokal speichern
  localStorage.setItem('userConsent', JSON.stringify(consentData));

  loadTrackingScripts(consentData);
  document.getElementById('consent-modal').classList.add('hidden');
  loadApp(currentUserForConsent);
}
  function startApp(user) {
  const nameEl = document.getElementById('user-name');
  const topbar = document.getElementById('topbar');

  nameEl.textContent = user.displayName || user.email || 'Unbekannt';
  topbar.style.display = 'flex';

  // Beispiel: hier kannst du deine Daten laden
  loadHuts();
loadAdsense();
  // Tracking-Scripts erst jetzt laden
  loadTrackingScripts();
    
}

function checkConsentOnLoad() {
  const consent = localStorage.getItem('userConsent');
  if (consent) {
    loadApp(currentUserForConsent);
  } else {
    document.getElementById('consent-modal').classList.remove('hidden');
  }
}
  window.onload = () => {
  checkConsentOnLoad();
};


  
  function loadAdsense() {
    // Google-Script nur einmal laden
    if (!window.adsbygoogle) {
      const s = document.createElement('script');
      s.async = true;
      s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2577915567428766";
      s.crossOrigin = "anonymous";
      document.head.appendChild(s);
    }

    // Container sichtbar machen
    document.getElementById("adsense-container").style.display = "block";

    // Anzeige initialisieren
    (adsbygoogle = window.adsbygoogle || []).push({});
  }

  

        // --- In-App Konsole mit Toggle & Scrollbar ---
(function() {
  // ğŸ‘‰ hier kannst du die Konsole global aktivieren/deaktivieren
  const ENABLE_APP_CONSOLE = true;  // auf false setzen = deaktiviert

  if (!ENABLE_APP_CONSOLE) return; // komplett abschalten

  const consoleDiv = document.createElement("div");
  consoleDiv.id = "appConsole";
  consoleDiv.style.cssText = `
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;          /* Scrollbalken aktiv */
    background: rgba(0,0,0,0.85);
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    padding: 5px;
    z-index: 9999;
    display: none;             /* startet versteckt */
    box-sizing: border-box;
    user-select: text;      /* ğŸ‘‰ Markieren/Kopieren erlaubt */
    cursor: text;           /* Cursor als Textanzeige */
  `;
  document.body.appendChild(consoleDiv);

  // Toggle-Button
  const toggleBtn = document.createElement("button");
  toggleBtn.textContent = "ğŸ“ Logs";
  toggleBtn.style.cssText = `
    position: fixed;
    bottom: 210px;
    right: 10px;
    padding: 5px 10px;
    background: #222;
    color: white;
    border: 1px solid #555;
    border-radius: 6px;
    font-size: 14px;
    z-index: 10000;
    cursor: pointer;
  `;
  document.body.appendChild(toggleBtn);

  let consoleVisible = false;
  toggleBtn.onclick = () => {
    consoleVisible = !consoleVisible;
    consoleDiv.style.display = consoleVisible ? "block" : "none";
    toggleBtn.textContent = consoleVisible ? "ğŸ“• Logs schlieÃŸen" : "ğŸ“ Logs";
  };

  function printToConsole(type, args) {
    const msg = document.createElement("div");
    msg.style.whiteSpace = "pre-wrap";
    msg.style.color =
      type === "error" ? "red" :
      type === "warn"  ? "yellow" :
      "#0f0";
    msg.textContent = `[${type.toUpperCase()}] ` + args.map(a =>
      (typeof a === "object" ? JSON.stringify(a) : a)
    ).join(" ");
    consoleDiv.appendChild(msg);

    // automatisch nach unten scrollen
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }

  // Original-Methoden sichern
  const origLog = console.log;
  const origWarn = console.warn;
  const origError = console.error;

  console.log = function(...args) {
    origLog.apply(console, args);
    printToConsole("log", args);
  };
  console.warn = function(...args) {
    origWarn.apply(console, args);
    printToConsole("warn", args);
  };
  console.error = function(...args) {
    origError.apply(console, args);
    printToConsole("error", args);
  };

  console.log("ğŸŸ¢ In-App Konsole gestartet (mit Scrollbalken + Deaktivier-Variable)");
  // ğŸ‘‰ FÃ¤ngt normale JavaScript-Fehler ab
/*window.addEventListener("error", function (event) {
  console.error("Uncaught Error:", event.message, event.filename, ":", event.lineno);
});

// ğŸ‘‰ FÃ¤ngt Promise-Fehler (async/await) ab
window.addEventListener("unhandledrejection", function (event) {
  console.error("Unhandled Promise rejection:", event.reason);
});*/
})();

</script>
<!-- Consent Modal -->

<div id="consent-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">    <div style="background:white; padding:25px 30px; max-width:520px; width:100%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:sans-serif; line-height:1.6; color:#333;">  
    
    <h2 style="margin-top:0; font-size:1.6rem; font-weight:600; color:#222; margin-bottom:15px;">Datenschutz & Cookies</h2>  
    
    <p style="margin-bottom:15px; font-size:1rem;">  
      Wir verwenden Cookies und Ã¤hnliche Technologien, um unsere Dienste bereitzustellen und zu verbessern.  
      Mehr dazu in unserer   
      <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">  
        DatenschutzerklÃ¤rung  
      </a>.  
    </p>  
    
    <label style="display:flex; align-items:center; margin-top:15px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-privacy" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">DatenschutzerklÃ¤rung</a> zu</span>  
    </label>  
    
    <label style="display:flex; align-items:center; margin-top:10px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-cookies" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der Verwendung von Cookies gemÃ¤ÃŸ der <a href="/cookies.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Cookie-Richtlinie</a> zu</span>  
    </label>  

    <div style="margin-top:25px; text-align:right;">  
<button id="consent-accept" onclick="acceptConsent()" style="padding:10px 20px; background:linear-gradient(135deg, #4CAF50, #45A049); color:white; border:none; border-radius:6px; font-size:1rem; font-weight:500; cursor:pointer; transition:background 0.3s, transform 0.1s;">
  Zustimmen
</button>
    </div>  
  </div>  
</div>  


</body>
  </html>
