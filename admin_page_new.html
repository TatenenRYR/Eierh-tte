<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin Bereich</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ‚ö†Ô∏è Firebase Config eintragen
    const firebaseConfig = {
      apiKey: "XXX",
      authDomain: "XXX",
      projectId: "XXX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8fafc; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px 15px; border-radius: 8px; cursor: pointer; }
    .tab.active { background: #2563eb; color: white; }
    .panel { display: none; }
    .panel.active { display: block; }
    .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,.1); margin-bottom: 15px; }
    img { border-radius: 8px; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .foto-x { top: 5px; right: 5px; background:#dc2626; color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; }
  </style>
</head>
<body>

  <h1 class="mb-4">Admin Bereich</h1>
  <div class="tabs">
    <div class="tab active" onclick="switchTab('huetten')">üè° H√ºtten</div>
    <div class="tab" onclick="switchTab('spielplaetze')">üõù Spielpl√§tze</div>
  </div>

  <!-- H√ºtten -->
  <div id="huetten" class="panel active">
    <div class="flex gap-2 mb-4">
      <input id="searchHut" type="text" placeholder="üîç Suche nach Name..." oninput="renderHuts()" />
      <select id="statusHut" onchange="renderHuts()">
        <option value="">Alle</option>
        <option value="offen">Offen</option>
        <option value="angenommen">Angenommen</option>
        <option value="abgelehnt">Abgelehnt</option>
      </select>
    </div>
    <div id="hut-list"></div>
  </div>

  <!-- Spielpl√§tze -->
  <div id="spielplaetze" class="panel">
    <div class="flex gap-2 mb-4">
      <input id="searchSpiel" type="text" placeholder="üîç Suche nach Name..." oninput="renderSpielplaetze()" />
      <select id="statusSpiel" onchange="renderSpielplaetze()">
        <option value="">Alle</option>
        <option value="offen">Offen</option>
        <option value="angenommen">Angenommen</option>
        <option value="abgelehnt">Abgelehnt</option>
      </select>
    </div>
    <div id="spielplatz-list"></div>
  </div>

<script>
let hutsCache = [];
let spielplatzCache = [];

// Tabs
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
  document.getElementById(id).classList.add('active');
}

// H√úTTEN
async function loadHuts() {
  const snap = await db.collection('eierhuetten').orderBy('name').get();
  hutsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  renderHuts();
}
function renderHuts() {
  const list = document.getElementById('hut-list');
  list.innerHTML = '';
  const search = document.getElementById('searchHut').value.toLowerCase();
  const status = document.getElementById('statusHut').value;
  const filtered = hutsCache.filter(d => {
    return (!search || (d.name||'').toLowerCase().includes(search)) &&
           (!status || d.status === status);
  });

  filtered.forEach(d => {
    const el = document.createElement('div');
    el.className = "card";

    el.innerHTML = `
      <input value="${d.name||''}" onchange="db.collection('eierhuetten').doc('${d.id}').update({name:this.value})" class="font-bold text-lg w-full mb-2">

      <label>Status:
        <select onchange="db.collection('eierhuetten').doc('${d.id}').update({status:this.value})">
          ${['offen','angenommen','abgelehnt'].map(s=>`<option ${s===d.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </label><br><br>

      <label>√ñffnungszeiten:
        <input value="${d.oeffnungszeiten||''}" onchange="db.collection('eierhuetten').doc('${d.id}').update({oeffnungszeiten:this.value})">
      </label><br><br>

      <label>Strom:
        <select onchange="db.collection('eierhuetten').doc('${d.id}').update({strom:this.value})">
          ${['Ja','Nein'].map(o=>`<option ${o===d.strom?'selected':''}>${o}</option>`).join('')}
        </select>
      </label><br><br>

      <label>Abo Monate:
        <input type="number" value="${d.aboMonate||0}" onchange="db.collection('eierhuetten').doc('${d.id}').update({aboMonate:parseInt(this.value)})">
      </label><br><br>

      <label>Abo Start:
        <input type="date" value="${d.aboStart ? new Date(d.aboStart.toDate()).toISOString().split('T')[0] : ''}" 
          onchange="db.collection('eierhuetten').doc('${d.id}').update({aboStart:new Date(this.value)})">
      </label><br><br>

      <h4>üí≥ PayPal</h4>
      <label>Subscription ID:
        <input value="${d.paypalSubscriptionId||''}" onchange="db.collection('eierhuetten').doc('${d.id}').update({paypalSubscriptionId:this.value})">
      </label><br><br>

      <p>üìÖ Erstellt am: ${d.erstelltAm?.toDate?.().toLocaleString("de-DE") || '-'}</p>
      <p>üîí Datenschutz: ${d.datenschutzZustimmung?.durch||'-'} (${d.datenschutzZustimmung?.best√§tigtAm?.toDate?.().toLocaleString("de-DE")||'-'})</p>

      <div>
        <p><b>üì∑ Fotos:</b></p>
        ${(Array.isArray(d.fotos) ? d.fotos.map((url,i)=>`
          <div class="relative inline-block mr-2 mb-2">
            <img src="${url}" class="w-32 h-24 object-cover">
            <button class="absolute foto-x" onclick="deleteHutFoto('${d.id}',${i})">‚úñ</button>
          </div>`).join('') : '<p>Keine Fotos</p>')}
      </div>

      <button onclick="db.collection('eierhuetten').doc('${d.id}').delete()" class="bg-red-600 text-white px-3 py-1 rounded mt-3">üóëÔ∏è L√∂schen</button>
    `;
    list.appendChild(el);
  });
}
function deleteHutFoto(docId,index){
  const ref = db.collection('eierhuetten').doc(docId);
  ref.get().then(doc=>{
    if(!doc.exists) return;
    const d = doc.data();
    if(!Array.isArray(d.fotos)) return;
    d.fotos.splice(index,1);
    ref.update({fotos:d.fotos}).then(()=>loadHuts());
  });
}

// SPIELPL√ÑTZE
async function loadSpielplaetze() {
  const snap = await db.collection('spielplaetze').orderBy('name').get();
  spielplatzCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  renderSpielplaetze();
}
function renderSpielplaetze() {
  const list = document.getElementById('spielplatz-list');
  list.innerHTML = '';
  const search = document.getElementById('searchSpiel').value.toLowerCase();
  const status = document.getElementById('statusSpiel').value;
  const filtered = spielplatzCache.filter(d => {
    return (!search || (d.name||'').toLowerCase().includes(search)) &&
           (!status || d.status === status);
  });

  filtered.forEach(d => {
    const el = document.createElement('div');
    el.className = "card";

    el.innerHTML = `
      <input value="${d.name||''}" onchange="db.collection('spielplaetze').doc('${d.id}').update({name:this.value})" class="font-bold text-lg w-full mb-2">

      <label>Status:
        <select onchange="db.collection('spielplaetze').doc('${d.id}').update({status:this.value})">
          ${['offen','angenommen','abgelehnt'].map(s=>`<option ${s===d.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </label><br><br>

      <label>Sitzpl√§tze:
        <select onchange="db.collection('spielplaetze').doc('${d.id}').update({sitz:this.value})">
          ${['Ja','Nein'].map(o=>`<option ${o===d.sitz?'selected':''}>${o}</option>`).join('')}
        </select>
      </label><br><br>

      <label>Typ:
        <input value="${d.typ||''}" onchange="db.collection('spielplaetze').doc('${d.id}').update({typ:this.value})">
      </label><br><br>

      <label>Tags:
        <input value="${(d.tags||[]).join(', ')}" onchange="db.collection('spielplaetze').doc('${d.id}').update({tags:this.value.split(',').map(t=>t.trim())})">
      </label><br><br>

      <div>
        <p><b>üì∑ Fotos:</b></p>
        ${(Array.isArray(d.fotos) ? d.fotos.map((url,i)=>`
          <div class="relative inline-block mr-2 mb-2">
            <img src="${url}" class="w-32 h-24 object-cover">
            <button class="absolute foto-x" onclick="deleteSpielplatzFoto('${d.id}',${i})">‚úñ</button>
          </div>`).join('') : '<p>Keine Fotos</p>')}
      </div>

      <button onclick="db.collection('spielplaetze').doc('${d.id}').delete()" class="bg-red-600 text-white px-3 py-1 rounded mt-3">üóëÔ∏è L√∂schen</button>
    `;
    list.appendChild(el);
  });
}
function deleteSpielplatzFoto(docId,index){
  const ref = db.collection('spielplaetze').doc(docId);
  ref.get().then(doc=>{
    if(!doc.exists) return;
    const d = doc.data();
    if(!Array.isArray(d.fotos)) return;
    d.fotos.splice(index,1);
    ref.update({fotos:d.fotos}).then(()=>loadSpielplaetze());
  });
}

// Start laden
loadHuts();
loadSpielplaetze();
</script>
</body>
</html>
