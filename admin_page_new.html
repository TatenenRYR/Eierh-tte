<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .section { display:none; }
    .active-tab { background:#059669; color:white; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Login -->
  <div id="login-section" class="flex items-center justify-center h-screen">
    <button id="login-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded">
      Admin Login mit Google
    </button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden p-6 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-green-700">Admin Dashboard</h1>
      <div>
        <span id="user-name" class="font-semibold mr-4">...</span>
        <button onclick="logout()" class="bg-red-600 text-white px-3 py-1 rounded">Logout</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-3 mb-6">
      <button onclick="showSection('huts')" id="tab-huts" class="px-4 py-2 rounded bg-green-600 text-white">ğŸ¥š HÃ¼tten</button>
      <button onclick="showSection('spielplaetze')" id="tab-spielplaetze" class="px-4 py-2 rounded bg-blue-600 text-white">ğŸ› SpielplÃ¤tze</button>
      <button onclick="showSection('support')" id="tab-support" class="px-4 py-2 rounded bg-gray-600 text-white">ğŸ“¨ Support</button>
    </div>

    <!-- HÃ¼tten -->
    <div id="section-huts" class="section">
      <h2 class="text-2xl font-bold mb-2 text-green-700">ğŸ¥š EierhÃ¼tten Verwaltung</h2>
      <p class="text-gray-500 mb-4">ğŸ¢ ZustÃ¤ndige Abteilung: Verwaltung HÃ¼tten</p>
      <div id="hut-list" class="space-y-4"></div>
    </div>

    <!-- SpielplÃ¤tze -->
    <div id="section-spielplaetze" class="section">
      <h2 class="text-2xl font-bold mb-2 text-blue-700">ğŸ› SpielplÃ¤tze Verwaltung</h2>
      <p class="text-gray-500 mb-4">ğŸ¢ ZustÃ¤ndige Abteilung: Spielplatzfreigabe</p>
      <div id="spielplatz-list" class="space-y-4"></div>
    </div>

    <!-- Support -->
    <div id="section-support" class="section">
      <h2 class="text-2xl font-bold mb-2 text-gray-700">ğŸ“¨ Support-Tickets</h2>
      <table class="min-w-full text-sm bg-white rounded shadow">
        <thead class="bg-blue-100 text-left">
          <tr>
            <th class="px-4 py-2">Datum</th>
            <th class="px-4 py-2">User</th>
            <th class="px-4 py-2">Nachricht</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Aktionen</th>
          </tr>
        </thead>
        <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

<script>
  // Firebase Setup
const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // Tabs
  function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    document.getElementById('section-' + section).style.display = 'block';
  }

  // Login
  document.getElementById('login-btn').onclick = () => {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  };
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('user-name').textContent = user.displayName || user.email;
      loadHuts();
      loadSpielplaetze();
      loadSupportTickets();
      showSection('huts');
    }
  });

  function logout() {
    auth.signOut().then(() => location.reload());
  }


// =============================
// ğŸ¥š HÃ¼tten laden
// =============================
async function loadHuts() {
  const snap = await db.collection('eierhuetten').orderBy('name').get();
  const list = document.getElementById('hut-list');
  list.innerHTML = '';
  
  snap.forEach(doc => {
    const d = doc.data();
    const el = document.createElement('div');
    el.className = "bg-white p-4 rounded shadow space-y-3";

    // Fotos vorbereiten
    let fotosHtml = "";
    if (Array.isArray(d.fotos) && d.fotos.length > 0) {
      fotosHtml = d.fotos.map((f, i) => {
        const url = typeof f === "string" ? f : f.url;
        const status = typeof f === "string" ? "freigegeben" : (f.status || "offen");

        return `
          <div class="mb-2">
            <img src="${url}" class="w-full h-32 object-cover rounded mb-1">
            <p class="text-xs text-gray-500">Status: ${status}</p>
            ${status !== "freigegeben" ? `
              <div class="flex gap-2">
                <button onclick="updateHutFoto('${doc.id}', ${i}, 'freigegeben')" 
                  class="bg-green-600 text-white px-2 py-1 rounded text-xs">âœ… Freigeben</button>
                <button onclick="deleteHutFoto('${doc.id}', ${i})" 
                  class="bg-red-600 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸ LÃ¶schen</button>
              </div>` : ""
            }
          </div>
        `;
      }).join("");
    } else {
      fotosHtml = `<p class="text-sm text-gray-400">Keine Fotos hochgeladen</p>`;
    }

    // HTML
    el.innerHTML = `
      <input value="${d.name || ''}" 
        onchange="db.collection('eierhuetten').doc('${doc.id}').update({name:this.value})"
        class="font-bold text-lg mb-2 w-full border rounded p-1">

      <label>Status:
        <select onchange="db.collection('eierhuetten').doc('${doc.id}').update({status:this.value})" 
          class="w-full border p-1 rounded mb-2">
          ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===d.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </label>

      <label>Ã–ffnungszeiten:
        <input value="${d.oeffnungszeiten || ''}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({oeffnungszeiten:this.value})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <label>Strom:
        <select onchange="db.collection('eierhuetten').doc('${doc.id}').update({strom:this.value})" 
          class="w-full border p-1 rounded mb-2">
          ${['Ja','Nein'].map(o => `<option ${o===d.strom?'selected':''}>${o}</option>`).join('')}
        </select>
      </label>

      <label>SitzplÃ¤tze:
        <select onchange="db.collection('eierhuetten').doc('${doc.id}').update({sitzplaetze:this.value})" 
          class="w-full border p-1 rounded mb-2">
          ${['Ja','Nein'].map(o => `<option ${o===d.sitzplaetze?'selected':''}>${o}</option>`).join('')}
        </select>
      </label>

      <label>Extras:
        <textarea onchange="db.collection('eierhuetten').doc('${doc.id}').update({extras:this.value})"
          class="w-full border p-1 rounded mb-2">${d.extras || ''}</textarea>
      </label>

      <label>Abo Monate:
        <input type="number" value="${d.aboMonate || 0}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({aboMonate:parseInt(this.value)})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <label>Abo Start:
        <input type="date" value="${d.aboStart ? new Date(d.aboStart.toDate()).toISOString().split('T')[0] : ''}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({aboStart:new Date(this.value)})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <h4 class="font-semibold">ğŸ’³ PayPal Info</h4>
      <label>Client ID:
        <input value="${d.paypalClient || ''}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({paypalClient:this.value})"
          class="w-full border p-1 rounded mb-2">
      </label>
      <label>Secret:
        <input value="${d.paypalSecret || ''}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({paypalSecret:this.value})"
          class="w-full border p-1 rounded mb-2">
      </label>
      <label>Subscription ID:
        <input value="${d.paypalSubId || ''}" 
          onchange="db.collection('eierhuetten').doc('${doc.id}').update({paypalSubId:this.value})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <div>
        <p class="font-semibold mb-1">ğŸ“· Fotos:</p>
        ${fotosHtml}
      </div>

      <button onclick="db.collection('eierhuetten').doc('${doc.id}').delete()" 
        class="bg-red-600 text-white px-3 py-1 rounded mt-3 w-full">ğŸ—‘ï¸ HÃ¼tte lÃ¶schen</button>
    `;

    list.appendChild(el);
  });
}

// =============================
// ğŸ› SpielplÃ¤tze laden
// =============================
async function loadSpielplaetze() {
  const snap = await db.collection('spielplaetze').orderBy('name').get();
  const list = document.getElementById('spielplatz-list');
  list.innerHTML = '';
  
  snap.forEach(doc => {
    const d = doc.data();
    const el = document.createElement('div');
    el.className = "bg-white p-4 rounded shadow space-y-3";

    // Fotos
    let fotosHtml = "";
    if (Array.isArray(d.fotos) && d.fotos.length > 0) {
      fotosHtml = d.fotos.map((f, i) => {
        const url = typeof f === "string" ? f : f.url;
        const status = typeof f === "string" ? "freigegeben" : (f.status || "offen");
        return `
          <div class="mb-2">
            <img src="${url}" class="w-full h-32 object-cover rounded mb-1">
            <p class="text-xs text-gray-500">Status: ${status}</p>
            ${status !== "freigegeben" ? `
              <div class="flex gap-2">
                <button onclick="updateSpielplatzFoto('${doc.id}', ${i}, 'freigegeben')" 
                  class="bg-green-600 text-white px-2 py-1 rounded text-xs">âœ… Freigeben</button>
                <button onclick="deleteSpielplatzFoto('${doc.id}', ${i})" 
                  class="bg-red-600 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸ LÃ¶schen</button>
              </div>` : ""
            }
          </div>
        `;
      }).join("");
    } else {
      fotosHtml = `<p class="text-sm text-gray-400">Keine Fotos hochgeladen</p>`;
    }

    // HTML
    el.innerHTML = `
      <input value="${d.name || ''}" 
        onchange="db.collection('spielplaetze').doc('${doc.id}').update({name:this.value})"
        class="font-bold text-lg mb-2 w-full border rounded p-1">

      <label>Status:
        <select onchange="db.collection('spielplaetze').doc('${doc.id}').update({status:this.value})" 
          class="w-full border p-1 rounded mb-2">
          ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===d.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </label>

      <label>Typ:
        <input value="${d.typ || ''}" 
          onchange="db.collection('spielplaetze').doc('${doc.id}').update({typ:this.value})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <label>SitzplÃ¤tze:
        <select onchange="db.collection('spielplaetze').doc('${doc.id}').update({sitz:this.value})" 
          class="w-full border p-1 rounded mb-3">
          ${['Ja','Nein'].map(o => `<option ${o===d.sitz?'selected':''}>${o}</option>`).join('')}
        </select>
      </label>

      <label>Tags:
        <input value="${(d.tags || []).join(', ')}" 
          onchange="db.collection('spielplaetze').doc('${doc.id}').update({tags:this.value.split(',').map(t=>t.trim())})"
          class="w-full border p-1 rounded mb-2">
      </label>

      <div>
        <p class="font-semibold mb-1">ğŸ“· Fotos:</p>
        ${fotosHtml}
      </div>

      <button onclick="db.collection('spielplaetze').doc('${doc.id}').delete()" 
        class="bg-red-600 text-white px-3 py-1 rounded mt-3 w-full">ğŸ—‘ï¸ Spielplatz lÃ¶schen</button>
    `;

    list.appendChild(el);
  });
}

// =============================
// ğŸ“· Foto-Handling fÃ¼r HÃ¼tten
// =============================
function updateHutFoto(docId, index, newStatus) {
  const ref = db.collection('eierhuetten').doc(docId);
  ref.get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    if (!Array.isArray(d.fotos)) return;
    d.fotos[index].status = newStatus;
    ref.update({ fotos: d.fotos }).then(() => loadHuts());
  });
}
function deleteHutFoto(docId, index) {
  const ref = db.collection('eierhuetten').doc(docId);
  ref.get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    if (!Array.isArray(d.fotos)) return;
    d.fotos.splice(index, 1);
    ref.update({ fotos: d.fotos }).then(() => loadHuts());
  });
}

// =============================
// ğŸ“· Foto-Handling fÃ¼r SpielplÃ¤tze
// =============================
function updateSpielplatzFoto(docId, index, newStatus) {
  const ref = db.collection('spielplaetze').doc(docId);
  ref.get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    if (!Array.isArray(d.fotos)) return;
    d.fotos[index].status = newStatus;
    ref.update({ fotos: d.fotos }).then(() => loadSpielplaetze());
  });
}
function deleteSpielplatzFoto(docId, index) {
  const ref = db.collection('spielplaetze').doc(docId);
  ref.get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    if (!Array.isArray(d.fotos)) return;
    d.fotos.splice(index, 1);
    ref.update({ fotos: d.fotos }).then(() => loadSpielplaetze());
  });
}

  // Support laden
  async function loadSupportTickets() {
    const snap = await db.collection('supportTickets').orderBy('createdAt','desc').get();
    const body = document.getElementById('support-tickets-body');
    body.innerHTML = '';
    snap.forEach(doc => {
      const t = doc.data();
      body.innerHTML += `
        <tr>
          <td class="px-4 py-2 text-xs">${t.createdAt?.toDate().toLocaleString('de-DE') || '-'}</td>
          <td class="px-4 py-2 text-xs">${t.email || '-'}</td>
          <td class="px-4 py-2">${t.message || ''}</td>
          <td class="px-4 py-2">${t.status || 'offen'}</td>
          <td class="px-4 py-2"><button onclick="db.collection('supportTickets').doc('${doc.id}').delete()" class="bg-red-600 text-white px-2 py-1 rounded">ğŸ—‘ï¸</button></td>
        </tr>
      `;
    });
  }
</script>
</body>
</html>
