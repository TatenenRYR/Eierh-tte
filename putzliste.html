<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Putzliste — Dark App</title>
<style>
  :root{
    --bg:#071023; --card:#0e1724; --muted:#9aa8b7; --accent:#22c55e; --accent-2:#16a34a;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#e6f0f2;-webkit-font-smoothing:antialiased;}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,0.2),transparent);border-bottom:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#042012}
  .title{font-size:18px;font-weight:700}
  .tabs{display:flex;gap:6px}
  .tab{padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;border:1px solid transparent}
  .tab.active{background:rgba(34,197,94,0.08);color:var(--accent);border-color:rgba(34,197,94,0.06)}
  main{padding:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .card{background:linear-gradient(180deg,var(--card),#071222);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .row{display:flex;gap:12px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  h2{margin:0;color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  /* task list */
  .task{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
  .task .left{display:flex;gap:10px;align-items:center}
  .task .title{font-weight:600}
  .pill{padding:6px 10px;border-radius:999px;font-size:13px;background:#071822;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
  input[type="text"], input[type="date"], input[type="number"], select, textarea {
    background:transparent;border:1px solid rgba(255,255,255,0.05);padding:8px;border-radius:8px;color:inherit;width:100%;
  }
  button.primary{background:var(--accent);border:none;color:#042012;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
  .small{padding:6px 8px;font-size:13px;border-radius:8px}
  .list-inline{display:flex;gap:8px;flex-wrap:wrap}
  canvas{width:100%;max-width:640px;height:140px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent}
  .note{font-size:13px;color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
  /* responsive */
  @media (min-width:900px){
    .grid.dashboard{grid-template-columns: 1fr 360px}
    .grid.columns-3{grid-template-columns:repeat(3,1fr)}
  }
  @media (max-width:899px){
    header{padding:10px}
    .tabs{gap:4px;overflow:auto}
    .grid.dashboard{grid-template-columns:1fr}
    .grid.columns-3{grid-template-columns:1fr}
  }
  .danger{background:#7f1d1d;color:#ffdede}
  .success{background:#052e0f;color:#c7ffd0}
  .meta{font-size:12px;color:var(--muted)}
  .separator{height:1px;background:rgba(255,255,255,0.02);margin:8px 0;border-radius:1px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">P</div>
    <div>
      <div class="title">Putzliste</div>
      <div class="muted">Dark Dashboard</div>
    </div>
  </div>

  <div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="tasks">Aufgaben</div>
      <div class="tab" data-tab="fryers">Fritteusen</div>
      <div class="tab" data-tab="colds">Kühlstellen</div>
      <div class="tab" data-tab="admin">Admin</div>
    </div>
  </div>
</header>

<main>
  <!-- Dashboard -->
  <section id="dashboard" class="grid dashboard">
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <h2>Übersicht</h2>
            <div class="muted">Schneller Überblick über Aufgaben & Messwerte</div>
          </div>
          <div class="col">
            <div id="todayProgress" class="pill">0%</div>
            <div class="meta" id="todaySummary">0 / 0 erledigt</div>
          </div>
        </div>

        <div class="separator"></div>

        <div style="margin-top:12px">
          <h3 style="margin:0 0 8px 0;color:#cdeacf">Letzte Unterschriften</h3>
          <div id="recentSignatures" class="muted note">— keine —</div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin:0 0 8px 0;color:#cdeacf">Offene Aufgaben</h3>
          <div id="openTasksList" class="muted note">— keine —</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0;color:#cdeacf">Schnellaktionen</h3>
        <div class="list-inline" style="margin-bottom:8px">
          <button class="primary" id="btnNewTask">Neue Aufgabe</button>
          <button class="ghost" id="btnGenerateMonth">Monat generieren</button>
          <button class="ghost" id="btnExport">Export JSON</button>
        </div>
        <div class="note">Alle Daten werden lokal im Browser gespeichert (localStorage).</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;color:#cdeacf">Fritteusen & Kühlstellen</h3>
      <div style="display:flex;gap:8px;flex-direction:column">
        <div>
          <div class="meta">Fritteusen</div>
          <div id="fryerSummary" class="muted note">— keine —</div>
        </div>
        <div>
          <div class="meta">Kühlstellen</div>
          <div id="coldSummary" class="muted note">— keine —</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Aufgaben -->
  <section id="tasks" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2>Aufgaben</h2>
          <div class="muted">Aufgaben anlegen, Datum wählen, abhaken & unterschreiben</div>
        </div>
      </div>

      <div class="separator"></div>

      <div class="row" style="margin-top:8px;gap:12px">
        <input type="text" id="taskTitle" placeholder="Titel">
        <input type="date" id="taskDate" value="">
        <button class="primary" id="addTaskBtn">Aufgabe hinzufügen</button>
      </div>

      <div style="margin-top:12px">
        <h3 class="muted">Geplante Aufgaben</h3>
        <div id="taskList"></div>
      </div>
    </div>
  </section>

  <!-- Fritteusen -->
  <section id="fryers" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2>Fritteusen</h2>
          <div class="muted">Mehrere Fritteusen verwalten, Werte speichern</div>
        </div>
      </div>

      <div class="separator"></div>

      <div class="row" style="gap:8px;margin-top:8px">
        <input type="text" id="fryerName" placeholder="Name (z.B. Fritteuse 1)">
        <button class="primary" id="addFryerBtn">Fritteuse anlegen</button>
      </div>

      <div style="margin-top:12px" id="fryerList"></div>
    </div>
  </section>

  <!-- Kühlstellen -->
  <section id="colds" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2>Kühlstellen</h2>
          <div class="muted">Kühlhäuser und Truhen eintragen und Temperaturen speichern</div>
        </div>
      </div>

      <div class="separator"></div>

      <div class="row" style="gap:8px;margin-top:8px">
        <input type="text" id="coldName" placeholder="Name (z.B. Kühlhaus 1)">
        <button class="primary" id="addColdBtn">Eintragen</button>
      </div>

      <div style="margin-top:12px" id="coldList"></div>
    </div>
  </section>

  <!-- Admin -->
  <section id="admin" style="display:none">
    <div class="card">
      <h2>Admin</h2>
      <div class="muted">Daten exportieren / importieren / zurücksetzen</div>
      <div class="separator"></div>
      <div class="col">
        <label>Export (JSON)</label>
        <div class="row">
          <button class="primary" id="btnExportJson">Exportieren</button>
          <input type="file" id="importFile" accept=".json" />
          <button class="ghost" id="btnImport">Import</button>
          <button class="ghost danger" id="btnReset">Alle Daten löschen</button>
        </div>
        <div class="separator"></div>
        <label>Letzte Rohdaten</label>
        <pre id="rawData" class="muted" style="max-height:200px;overflow:auto;background:transparent;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)"></pre>
      </div>
    </div>
  </section>

</main>

<footer>© Putzliste — lokal gespeichert · Darkmode</footer>

<script>
/* -----------------------
  Data model & persistence
   - tasks: [{id,title,due,done,checklist,history,signed,signer,signatureDataUrl,meta}]
   - fryers: [{id,name,temp,status,fat,lastUpdated}]
   - colds: [{id,name,temp,lastUpdated}]
-------------------------*/
const STORE_KEY = 'putz_app_v2';

function loadStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) return { tasks:[], fryers:[], colds:[] };
    return JSON.parse(raw);
  }catch(e){
    console.error('load error', e);
    return { tasks:[], fryers:[], colds:[] };
  }
}
function saveStore(state){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

/* seed default if empty */
let store = loadStore();
if (!store.tasks) store = { tasks: [], fryers: [], colds: [] };

/* helper */
const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
const todayISO = () => new Date().toISOString().slice(0,10);

/* On load: move overdue tasks forward (not done) */
(function shiftOverdue(){
  const today = todayISO();
  let changed = false;
  store.tasks.forEach(task=>{
    if (!task.done && task.due && task.due < today){
      const from = task.due;
      const next = (d=>{ const x = new Date(d+'T00:00:00'); x.setDate(x.getDate()+1); return x.toISOString().slice(0,10); })(task.due);
      task.history = task.history || [];
      task.history.push({ from, movedAt: today });
      task.due = next;
      changed = true;
    }
  });
  if (changed) saveStore(store);
})();

/* UI wiring */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', ()=> {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.dataset.tab;
  document.querySelectorAll('main > section').forEach(s => s.style.display = (s.id === tab ? '' : 'none'));
}));

/* Dashboard utils */
function renderDashboard(){
  // progress today
  const today = todayISO();
  const todays = store.tasks.filter(t => t.due === today);
  const done = todays.filter(t=>t.done).length;
  const total = todays.length;
  const percent = total ? Math.round((done/total)*100) : 0;
  document.getElementById('todayProgress').textContent = percent + '%';
  document.getElementById('todaySummary').textContent = done + ' / ' + total + ' erledigt';

  // recent signatures
  const signed = [];
  store.tasks.forEach(t => { if (t.signed) signed.push({title:t.title,date:t.signedAt,signer:t.signer}); });
  signed.sort((a,b)=> b.date.localeCompare(a.date));
  document.getElementById('recentSignatures').textContent = signed.slice(0,6).map(s => `${s.title} — ${s.signer || '—'} (${s.date.slice(0,10)})`).join('\\n') || '— keine —';

  // open tasks
  const open = store.tasks.filter(t => !t.done);
  open.sort((a,b)=> (a.due||'').localeCompare(b.due||''));
  document.getElementById('openTasksList').textContent = open.slice(0,8).map(o => `${o.title} ${o.due?(' — '+o.due):''}`).join('\\n') || '— keine —';

  // fryer summary
  document.getElementById('fryerSummary').textContent = store.fryers.length ? store.fryers.map(f => `${f.name}: ${f.temp || '—'}°C ${f.status?('('+f.status+')'):''}`).join('\\n') : '— keine —';
  document.getElementById('coldSummary').textContent = store.colds.length ? store.colds.map(c => `${c.name}: ${c.temp || '—'}°C`).join('\\n') : '— keine —';
}

/* Tasks UI */
function renderTasks(){
  const container = document.getElementById('taskList');
  container.innerHTML = '';
  // sort by due date
  const list = [...store.tasks].sort((a,b)=> (a.due||'9999').localeCompare(b.due||'9999'));
  if (list.length === 0){
    container.innerHTML = '<div class="muted">Keine Aufgaben vorhanden.</div>';
    return;
  }
  list.forEach(task => {
    const div = document.createElement('div'); div.className = 'task';
    const left = document.createElement('div'); left.className = 'left';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!task.done;
    cb.addEventListener('change', ()=> { task.done = cb.checked; saveStore(store); renderTasks(); renderDashboard(); });
    const title = document.createElement('div'); title.className='title'; title.textContent = task.title;
    const meta = document.createElement('div'); meta.className='muted'; meta.style.marginLeft='8px'; meta.textContent = task.due ? 'Fällig: '+task.due : 'kein Datum';
    left.appendChild(cb); left.appendChild(title); left.appendChild(meta);

    const right = document.createElement('div');
    right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const btnSign = document.createElement('button'); btnSign.className='ghost small'; btnSign.textContent = task.signed ? 'Unterschrift ✓' : 'Unterschreiben';
    btnSign.addEventListener('click', ()=> openSignModal(task.id));
    const btnEdit = document.createElement('button'); btnEdit.className='ghost small'; btnEdit.textContent='Bearbeiten';
    btnEdit.addEventListener('click', ()=> openEditTask(task.id));
    const btnDel = document.createElement('button'); btnDel.className='ghost small danger'; btnDel.textContent='Löschen';
    btnDel.addEventListener('click', ()=> { if(confirm('Aufgabe wirklich löschen?')) { store.tasks = store.tasks.filter(x=>x.id!==task.id); saveStore(store); renderTasks(); renderDashboard(); } });

    if (task.history && task.history.length){
      const h = document.createElement('div'); h.className='muted'; h.textContent = 'verschoben: '+ task.history.map(h=>h.from).join(', ');
      h.style.fontSize='12px'; h.style.marginTop='6px';
      left.appendChild(h);
    }

    right.appendChild(btnSign); right.appendChild(btnEdit); right.appendChild(btnDel);

    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);

    // checklist quick view
    if (task.checklist && task.checklist.length){
      const cl = document.createElement('div'); cl.style.marginLeft='8px'; cl.style.marginTop='6px';
      task.checklist.forEach((c,i)=>{
        const lab = document.createElement('label'); lab.style.display='flex'; lab.style.gap='8px'; lab.style.fontSize='13px';
        const cc = document.createElement('input'); cc.type='checkbox'; cc.checked=!!c.checked;
        cc.addEventListener('change', ()=> { c.checked = cc.checked; saveStore(store); renderTasks(); });
        lab.appendChild(cc); lab.appendChild(document.createTextNode(c.text));
        cl.appendChild(lab);
      });
      container.appendChild(cl);
    }
  });
}

/* Open edit modal (simpler: prompt-based for single-file) */
function openEditTask(taskId){
  const t = store.tasks.find(x=>x.id===taskId);
  if (!t) return;
  const newTitle = prompt('Titel bearbeiten', t.title);
  if (newTitle === null) return;
  t.title = newTitle.trim() || t.title;
  const newDate = prompt('Datum (YYYY-MM-DD) — leer = kein Datum', t.due || '');
  if (newDate !== null) t.due = newDate.trim() || null;
  // checklist edit simple
  const cl = prompt('Checkliste (Komma-getrennt). Vorhanden: ' + (t.checklist? t.checklist.map(x=>x.text).join(', ') : ''), t.checklist ? t.checklist.map(x=>x.text).join(', ') : '');
  if (cl !== null){
    t.checklist = cl.split(',').map(s=>({ id: uid('c'), text: s.trim(), checked:false })).filter(x=>x.text);
  }
  saveStore(store); renderTasks(); renderDashboard();
}

/* Signature modal (implement as overlay) */
let signOverlay = null;
function openSignModal(taskId){
  const task = store.tasks.find(t=>t.id===taskId);
  if(!task) return;
  // create overlay
  signOverlay = document.createElement('div');
  signOverlay.style.position='fixed'; signOverlay.style.inset=0; signOverlay.style.background='rgba(0,0,0,0.6)'; signOverlay.style.display='flex';
  signOverlay.style.alignItems='center'; signOverlay.style.justifyContent='center'; signOverlay.style.zIndex='9999';
  const panel = document.createElement('div'); panel.className='card'; panel.style.width='min(720px,95%)'; panel.style.maxWidth='720px';
  panel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0;color:var(--accent)">Unterschreiben: ${escapeHtml(task.title)}</h3><div style="font-size:13px;color:var(--muted)">${task.due||''}</div></div>
    <div style="margin-top:8px"><canvas id="signCanvas" width="640" height="140"></canvas></div>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
      <input id="signName" placeholder="Name" style="background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:inherit" />
      <button id="saveSignBtn" class="primary">Speichern</button>
      <button id="clearSignBtn" class="ghost">Löschen</button>
      <button id="closeSignBtn" class="ghost">Schließen</button>
    </div>`;
  signOverlay.appendChild(panel);
  document.body.appendChild(signOverlay);

  const canvas = document.getElementById('signCanvas');
  const ctx = canvas.getContext('2d'); ctx.strokeStyle = '#dfffe6'; ctx.lineWidth = 2; ctx.lineCap='round';
  // load existing if any
  if (task.signatureDataUrl){
    const img = new Image(); img.onload = ()=> ctx.drawImage(img,0,0,canvas.width,canvas.height); img.src = task.signatureDataUrl;
    document.getElementById('signName').value = task.signer || '';
  }

  let drawing = false;
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX - rect.left, y:e.touches[0].clientY-rect.top };
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
  canvas.addEventListener('mousedown', e=>{ drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  canvas.addEventListener('mouseup', ()=> drawing=false);
  canvas.addEventListener('mouseleave', ()=> drawing=false);
  // touch
  canvas.addEventListener('touchstart', e=>{ e.preventDefault(); drawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  canvas.addEventListener('touchend', ()=> drawing=false);

  document.getElementById('saveSignBtn').addEventListener('click', ()=>{
    const data = canvas.toDataURL('image/png');
    task.signatureDataUrl = data;
    task.signed = true;
    const signer = document.getElementById('signName').value.trim() || 'unbekannt';
    task.signer = signer;
    task.signedAt = new Date().toISOString();
    saveStore(store); renderTasks(); renderDashboard();
    closeSignOverlay();
  });
  document.getElementById('clearSignBtn').addEventListener('click', ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    task.signatureDataUrl = null;
    task.signed = false;
    task.signer = null;
    saveStore(store); renderTasks(); renderDashboard();
  });
  document.getElementById('closeSignBtn').addEventListener('click', closeSignOverlay);

  function closeSignOverlay(){ if (signOverlay){ document.body.removeChild(signOverlay); signOverlay = null; } }
}

/* Fryers UI */
function renderFryers(){
  const cont = document.getElementById('fryerList'); cont.innerHTML = '';
  if (store.fryers.length===0){ cont.innerHTML = '<div class="muted">Keine Fritteusen angelegt.</div>'; return; }
  store.fryers.forEach(f => {
    const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
    d.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
      <div><strong>${escapeHtml(f.name)}</strong><div class="meta">${f.lastUpdated?('zuletzt: '+f.lastUpdated):'noch keine Messung'}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="small" type="number" id="temp_${f.id}" placeholder="°C" value="${f.temp||''}" style="width:100px" />
        <select id="stat_${f.id}" style="width:120px">
          <option value="">Status</option>
          <option value="F" ${f.status==='F'?'selected':''}>F – Filtern</option>
          <option value="X" ${f.status==='X'?'selected':''}>X – Neu</option>
          <option value="S" ${f.status==='S'?'selected':''}>S – Öl neu</option>
        </select>
        <input class="small" id="fat_${f.id}" placeholder="Fettwert" value="${f.fat||''}" style="width:110px" />
        <button class="ghost" id="saveF_${f.id}">Speichern</button>
        <button class="ghost danger" id="delF_${f.id}">Löschen</button>
      </div>
    </div>`;
    cont.appendChild(d);
    document.getElementById(`saveF_${f.id}`).addEventListener('click', ()=>{
      const temp = document.getElementById(`temp_${f.id}`).value;
      const stat = document.getElementById(`stat_${f.id}`).value;
      const fat = document.getElementById(`fat_${f.id}`).value;
      f.temp = temp || null; f.status = stat || null; f.fat = fat || null; f.lastUpdated = new Date().toLocaleString();
      saveStore(store); renderFryers(); renderDashboard();
    });
    document.getElementById(`delF_${f.id}`).addEventListener('click', ()=>{
      if (!confirm('Fritteuse löschen?')) return;
      store.fryers = store.fryers.filter(x=>x.id!==f.id); saveStore(store); renderFryers(); renderDashboard();
    });
  });
}

/* Colds UI */
function renderColds(){
  const cont = document.getElementById('coldList'); cont.innerHTML = '';
  if (store.colds.length===0){ cont.innerHTML = '<div class="muted">Keine Kühlstellen angelegt.</div>'; return; }
  store.colds.forEach(c => {
    const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
    d.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
      <div><strong>${escapeHtml(c.name)}</strong><div class="meta">${c.lastUpdated?('zuletzt: '+c.lastUpdated):'noch keine Messung'}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="small" type="number" id="ctemp_${c.id}" placeholder="°C" value="${c.temp||''}" style="width:100px" />
        <button class="ghost" id="saveC_${c.id}">Speichern</button>
        <button class="ghost danger" id="delC_${c.id}">Löschen</button>
      </div>
    </div>`;
    cont.appendChild(d);
    document.getElementById(`saveC_${c.id}`).addEventListener('click', ()=>{
      const temp = document.getElementById(`ctemp_${c.id}`).value;
      c.temp = temp || null; c.lastUpdated = new Date().toLocaleString();
      saveStore(store); renderColds(); renderDashboard();
    });
    document.getElementById(`delC_${c.id}`).addEventListener('click', ()=>{
      if (!confirm('Kühlstelle löschen?')) return;
      store.colds = store.colds.filter(x=>x.id!==c.id); saveStore(store); renderColds(); renderDashboard();
    });
  });
}

/* Admin: export/import/reset */
document.getElementById('btnExportJson').addEventListener('click', ()=>{
  const data = JSON.stringify(store, null, 2);
  const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'putz_export.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btnImport').addEventListener('click', ()=>{
  const fileInput = document.getElementById('importFile');
  if (!fileInput.files[0]) return alert('Datei wählen');
  const fr = new FileReader();
  fr.onload = ()=> {
    try{
      const data = JSON.parse(fr.result);
      if (!confirm('Importiert wird: ' + (data.tasks? data.tasks.length : 0) + ' Aufgaben. Fortfahren?')) return;
      store = data; saveStore(store); renderAll(); alert('Import fertig');
    }catch(e){ alert('Import fehlerhaft'); }
  };
  fr.readAsText(fileInput.files[0]);
});
document.getElementById('btnReset').addEventListener('click', ()=>{
  if (!confirm('Alle lokalen Daten löschen?')) return;
  store = { tasks:[], fryers:[], colds:[] }; saveStore(store); renderAll();
});
document.getElementById('btnGenerateMonth').addEventListener('click', ()=>{
  // quick generator: create tasks for each weekday based on simple sample template
  const today = new Date();
  const year = today.getFullYear(), month = today.getMonth();
  const days = [];
  const last = new Date(year, month+1, 0).getDate();
  for (let d=1; d<=last; d++){
    const dt = new Date(year, month, d);
    const wd = dt.getDay(); // 0-6
    // sample mapping: Mon(1) kitchen, Tue(2) fryer, Wed(3) cold check
    const map = {1:'Küche reinigen', 2:'Fritteuse kontrollieren', 3:'Kühlraum messen'};
    if (map[wd]){
      store.tasks.push({ id: uid('task'), title: map[wd], due: dt.toISOString().slice(0,10), done:false, checklist:[], history:[], signed:false, signatureDataUrl:null, signer:null, meta:{} });
    }
  }
  saveStore(store); renderAll(); alert('Monat generiert');
});
/* quick new task button */
document.getElementById('btnNewTask').addEventListener('click', ()=> {
  document.querySelector('.tab[data-tab="tasks"]').click();
  document.getElementById('taskTitle').focus();
});

/* Add task */
document.getElementById('addTaskBtn').addEventListener('click', ()=>{
  const title = document.getElementById('taskTitle').value.trim();
  const due = document.getElementById('taskDate').value || null;
  if (!title) return alert('Titel eingeben');
  const t = { id: uid('task'), title, due, done:false, checklist:[], history:[], signed:false, signatureDataUrl:null, signer:null, meta:{} };
  store.tasks.push(t); saveStore(store); document.getElementById('taskTitle').value=''; document.getElementById('taskDate').value=''; renderTasks(); renderDashboard();
});

/* Add fryer */
document.getElementById('addFryerBtn').addEventListener('click', ()=>{
  const name = document.getElementById('fryerName').value.trim();
  if (!name) return alert('Name angeben');
  store.fryers.push({ id: uid('fryer'), name, temp:null, status:null, fat:null, lastUpdated:null });
  document.getElementById('fryerName').value='';
  saveStore(store); renderFryers(); renderDashboard();
});

/* Add cold */
document.getElementById('addColdBtn').addEventListener('click', ()=>{
  const name = document.getElementById('coldName').value.trim();
  if (!name) return alert('Name angeben');
  store.colds.push({ id: uid('cold'), name, temp:null, lastUpdated:null });
  document.getElementById('coldName').value='';
  saveStore(store); renderColds(); renderDashboard();
});

/* Export (quick) */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const data = JSON.stringify(store, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'putz_export.json'; a.click(); URL.revokeObjectURL(url);
});

/* Utilities & initial render */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function renderAll(){
  renderDashboard(); renderTasks(); renderFryers(); renderColds();
  document.getElementById('rawData').textContent = JSON.stringify(store, null, 2);
}
renderAll();

/* show initial tab */
document.querySelector('.tab.active').click();

/* show stored signatures/counts in dashboard already set in renderDashboard */

/* Ensure date input default is today */
document.getElementById('taskDate').value = todayISO();

</script>
</body>
</html>
