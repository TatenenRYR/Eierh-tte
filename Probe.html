<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eierhütten – Eintragen</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-50">

<!-- LOGIN -->
<div id="loginPage" class="flex flex-col items-center justify-center min-h-screen p-6">
  <img src="logo.png" class="w-40 rounded-xl shadow mb-6">
  <h1 class="text-3xl font-bold mb-4 text-green-700">Willkommen bei Eierhütten!</h1>
  <button id="googleLogin" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">
    Mit Google anmelden
  </button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden max-w-3xl mx-auto p-6">
  <h2 class="text-2xl font-bold mb-4 text-center">Neue Eintragung</h2>

  <!-- Fortschritt -->
  <div class="w-full bg-gray-200 h-3 rounded mb-6">
    <div id="progressBar" class="bg-green-500 h-3 rounded" style="width:0%"></div>
  </div>

  <!-- Wizard Steps -->
  <form id="wizardForm" class="space-y-6">
    <!-- STEP 1 – Kategorie -->
    <div class="step">
      <h3 class="text-xl font-semibold mb-4">1. Was möchtest du eintragen?</h3>
      <div id="catOptions" class="grid grid-cols-2 gap-4">
        <!-- Beispielbilder lokal bereitstellen -->
        <div class="option"><img src="eierhuette.jpg" class="h-40 w-full object-cover rounded-t">
          <div class="p-3 text-center font-bold bg-white rounded-b">Eierhütte</div></div>
        <div class="option"><img src="hofladen.jpg" class="h-40 w-full object-cover rounded-t">
          <div class="p-3 text-center font-bold bg-white rounded-b">Hofladen</div></div>
        <div class="option"><img src="geschenk.jpg" class="h-40 w-full object-cover rounded-t">
          <div class="p-3 text-center font-bold bg-white rounded-b">Geschenkehütte</div></div>
        <div class="option"><img src="sonstiges.jpg" class="h-40 w-full object-cover rounded-t">
          <div class="p-3 text-center font-bold bg-white rounded-b">Sonstiges</div></div>
      </div>
    </div>

    <!-- STEP 2 – Name & Beschreibung -->
    <div class="step hidden">
      <h3 class="text-xl font-semibold mb-4">2. Name & Beschreibung</h3>
      <input id="hutName" class="w-full border p-2 rounded mb-3" placeholder="Name" required>
      <textarea id="hutDesc" class="w-full border p-2 rounded" placeholder="Beschreibung" required></textarea>
    </div>

    <!-- STEP 3 – Öffnungszeiten -->
    <div class="step hidden">
      <h3 class="text-xl font-semibold mb-4">3. Öffnungszeiten</h3>
      <input id="hutTimes" class="w-full border p-2 rounded" placeholder="z.B. Mo–Fr 08–18 Uhr">
    </div>

    <!-- STEP 4 – Standort -->
    <div class="step hidden">
      <h3 class="text-xl font-semibold mb-4">4. Standort</h3>
      <div id="map" class="h-60 rounded border"></div>
    </div>

    <!-- STEP 5 – Fotos -->
    <div class="step hidden">
      <h3 class="text-xl font-semibold mb-4">5. Fotos hochladen</h3>
      <input type="file" id="hutPhotos" multiple accept="image/*">
      <div id="photoPreview" class="grid grid-cols-3 gap-2 mt-3"></div>
    </div>

    <!-- STEP 6 – Zusammenfassung -->
    <div class="step hidden">
      <h3 class="text-xl font-semibold mb-4">6. Zusammenfassung</h3>
      <div id="summary" class="bg-gray-100 p-4 rounded"></div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between">
      <button type="button" id="prevBtn" class="bg-gray-200 px-4 py-2 rounded">Zurück</button>
      <button type="button" id="nextBtn" class="bg-green-600 text-white px-4 py-2 rounded">Weiter</button>
    </div>
  </form>

  <!-- Meine Einträge -->
  <div class="mt-12">
    <h3 class="text-xl font-bold mb-4">Meine Einträge</h3>
    <div id="hutList" class="grid gap-4"></div>
  </div>
</div>

<script>
/* === Firebase Config (eigene Daten einsetzen!) === */
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* === DOM === */
const loginPage = document.getElementById('loginPage');
const dashboard = document.getElementById('dashboard');
const steps = document.querySelectorAll('.step');
const progressBar = document.getElementById('progressBar');
let currentStep = 0;
let marker;
let category = "";

/* === Login === */
document.getElementById('googleLogin').onclick = () =>
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

auth.onAuthStateChanged(user => {
  if (user) {
    loginPage.classList.add('hidden');
    dashboard.classList.remove('hidden');
    loadHuts();
  } else {
    dashboard.classList.add('hidden');
    loginPage.classList.remove('hidden');
  }
});

/* === Wizard Navigation === */
function showStep(i){
  steps.forEach((s,idx)=>s.classList.toggle('hidden', idx!==i));
  progressBar.style.width = ((i)/(steps.length-1))*100 + '%';
  prevBtn.style.visibility = i===0 ? 'hidden':'visible';
  nextBtn.textContent = i===steps.length-1 ? 'Speichern' : 'Weiter';
  if(i===steps.length-1) buildSummary();
}
prevBtn.onclick = ()=>{ if(currentStep>0){ currentStep--; showStep(currentStep);} };
nextBtn.onclick = async ()=>{
  if(currentStep<steps.length-1){ currentStep++; showStep(currentStep);}
  else { await saveHut(); }
};
showStep(0);

/* === Kategorie-Auswahl === */
document.querySelectorAll('#catOptions .option').forEach(opt=>{
  opt.addEventListener('click',()=>{
    document.querySelectorAll('#catOptions .option')
      .forEach(o=>o.classList.remove('ring','ring-green-500'));
    opt.classList.add('ring','ring-green-500');
    category = opt.innerText.trim();
  });
});

/* === Karte === */
const map = L.map('map').setView([51,10],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
map.on('click', e=>{
  if (!marker) marker = L.marker(e.latlng,{draggable:true}).addTo(map);
  marker.setLatLng(e.latlng);
});

/* === Foto Vorschau === */
hutPhotos.addEventListener('change', e=>{
  const preview = document.getElementById('photoPreview');
  preview.innerHTML = '';
  [...e.target.files].forEach(f=>{
    const r = new FileReader();
    r.onload = () => preview.innerHTML +=
      `<img src="${r.result}" class="w-full h-24 object-cover rounded">`;
    r.readAsDataURL(f);
  });
});

/* === Zusammenfassung === */
function buildSummary(){
  summary.innerHTML = `
    <p><b>Kategorie:</b> ${category || '-'}</p>
    <p><b>Name:</b> ${hutName.value}</p>
    <p><b>Beschreibung:</b> ${hutDesc.value}</p>
    <p><b>Öffnungszeiten:</b> ${hutTimes.value}</p>
    <p><b>Standort:</b> ${marker ? marker.getLatLng().lat.toFixed(5)+', '+marker.getLatLng().lng.toFixed(5) : 'nicht gesetzt'}</p>
    <p><b>Bilder:</b> ${hutPhotos.files.length}</p>
  `;
}

/* === Speichern === */
async function saveHut(){
  const user = auth.currentUser;
  if(!user) return alert('Bitte anmelden.');
  const data = {
    userId: user.uid,
    category,
    name: hutName.value,
    desc: hutDesc.value,
    times: hutTimes.value,
    created: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(marker){
    const p = marker.getLatLng();
    data.location = new firebase.firestore.GeoPoint(p.lat,p.lng);
  }
  const urls = [];
  for(const f of hutPhotos.files){
    const ref = storage.ref(`huts/${user.uid}/${Date.now()}_${f.name}`);
    await ref.put(f);
    urls.push(await ref.getDownloadURL());
  }
  data.photos = urls;
  await db.collection('huts').add(data);
  alert('✅ Eintrag gespeichert!');
  hutName.value = hutDesc.value = hutTimes.value = '';
  hutPhotos.value = '';
  category = "";
  currentStep = 0;
  showStep(0);
  loadHuts();
}

/* === Eigene Hütten laden === */
async function loadHuts(){
  const list = document.getElementById('hutList');
  list.innerHTML = 'Lädt…';
  const snap = await db.collection('huts')
    .where('userId','==',auth.currentUser.uid)
    .orderBy('created','desc').get();
  list.innerHTML = '';
  snap.forEach(doc=>{
    const d = doc.data();
    const img = d.photos?.[0] || 'https://via.placeholder.com/300x200?text=Kein+Bild';
    list.innerHTML += `
      <div class="bg-white p-4 rounded shadow">
        <img src="${img}" class="w-full h-40 object-cover rounded mb-2">
        <h3 class="font-bold">${d.category || ''} – ${d.name}</h3>
        <p class="text-sm text-gray-600">${d.desc}</p>
      </div>`;
  });
}
</script>
</body>
</html>
