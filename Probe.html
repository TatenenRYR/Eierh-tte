<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H√ºtten Assistent ‚Äì Komplett</title>

  <!-- Firebase (compat, wie in deinem Projekt) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (Karten) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Quill (WYSIWYG f√ºr Beschreibung) -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap {
  height: 200px;
  z-index: 0;
}
.leaflet-container {
  z-index: 0 !important;
}
    /* Small helper for fixed bottom nav on small screens */
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; } /* space for fixed nav */
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
  </style>
</head>
<body class="bg-gray-100">
<!-- Login Screen -->
<!-- Login Screen -->
<div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen bg-green-50 hidden">
  <img src="https://cdn-icons-png.flaticon.com/512/1995/1995574.png" class="w-40 h-40 mb-6" alt="Funny Hut" />
  <h1 class="text-2xl font-bold text-green-700 mb-4">Willkommen beim H√ºtten-Assistent ü•ö</h1>
  <p class="text-gray-600 mb-6 text-center max-w-xs">
    Melde dich mit deinem Google-Konto an, um deine H√ºtten zu verwalten.
  </p>
  <button onclick="doGoogleLogin()" 
  class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-2xl shadow-lg transition w-64 justify-center font-medium">
  <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 bg-white rounded-full p-1" />
  <span>Mit Google anmelden</span>
  </button>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    <!-- Sidebar -->
    
    <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-4 transform -translate-x-full md:translate-x-0 transition-transform z-50">
      <div class="mt-6 border-t pt-3 text-sm">
  Angemeldet als: <span id="accountMail">-</span><br>
  <button class="mt-2 px-3 py-1 bg-red-600 text-white rounded" onclick="logout()">Logout</button>
      </div>
      <div class="text-2xl font-bold text-green-700 mb-6">üåø Assistent</div>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50" onclick="showMyEntries()">üìã Meine Eintragungen</button>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50" onclick="startNewEntry()">‚ûï Neue Eintragung</button>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50" onclick="showSupportTickets()">üì® Meine Support-Tickets</button>
      <button class="w-full text-left px-3 py-2 rounded hover:bg-green-50" onclick="openSupport()">üí¨ Support</button>
      <div class="mt-auto text-xs text-gray-400">v1.0 ‚Äì Komplett</div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col">
      <!-- topbar mobile -->
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">‚ò∞</button>
      </div>

      <!-- progressbar -->
      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <!-- question area -->
      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        <!-- dynamic content -->
      </section>

      <!-- fixed bottom nav -->
      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">‚¨ÖÔ∏è Zur√ºck</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter ‚û°Ô∏è</button>
      </div>
    </main>
  </div>

  <!-- Notification area -->
  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  // imgbb API key (wie in Admin-Code verwendet)
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";

  // Init firebase
    
  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">‚ùå Firebase konnte nicht initialisiert werden. Pr√ºfe die Konfiguration in der Datei.</div>`;
  }

  // Demo user: in deinem Produktivbetrieb sollte hier auth.onAuthStateChanged triggern
  let currentUser = { uid: "demo", email: "demo@example.com", displayName: "Demo" };
firebase.auth().onAuthStateChanged(u => {
  if (u) {
    currentUser = u;
    document.getElementById("accountMail").textContent = u.email;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainApp").classList.remove("hidden");

    // Sidebar geschlossen halten
    document.getElementById('sidebar').classList.add('-translate-x-full');

    // Tutorial-Startseite zeigen
    showTutorial();

  } else {
    // nicht eingeloggt
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("question-area").innerHTML = "";
  }
});
    async function doGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await firebase.auth().signInWithPopup(provider);
    showToast("‚úÖ Eingeloggt mit Google");
  } catch (e) {
    console.error("Google Login error", e);
    alert("Fehler beim Google-Login: " + e.message);
  }
    }

function logout() {
  firebase.auth().signOut();
}
    let mode = "entry"; // "entry" oder "list"
  /***********************
   * State & steps
   ***********************/
  let editingData = {};
  let step = 0;
  const stepsCount = 10; // 0..9

  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }

  /***********************
   * Render Flow (Questions)
   ***********************/
  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
      
    try {
      if (step === 0) {
        qa.innerHTML = `
  <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
    <h2 class="text-xl font-bold mb-3">üõ°Ô∏è Datenschutzerkl√§rung</h2>
    <div class="h-40 overflow-y-auto border p-2 mb-3 text-sm bg-gray-50 rounded">
      <p>Hier steht deine vollst√§ndige Datenschutzerkl√§rung ...</p>
      <p>...</p>
    </div>
    <label class="inline-flex items-center gap-2">
      <input id="dsCheck" type="checkbox" /> Ich akzeptiere die Datenschutzerkl√§rung
    </label>
  </div>`;
        return;
      }

      if (step === 1) {
        // Typ-Auswahl
        const opts = [
          { emoji: 'ü•ö', label: 'Eierh√ºtte', key: 'Eierh√ºtte' },
          { emoji: 'üè™', label: 'Hofladen', key: 'Hofladen' },
          { emoji: 'üè†', label: 'Selbstbedienungsh√§uschen', key: 'Selbstbedienung' },
          { emoji: 'üõù', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: 'üåÑ', label: 'Abenteuerhof', key: 'Abenteuerhof' }
        ];
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto';
        opts.forEach(o => {
          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer';
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key;
          };
          wrap.appendChild(card);
        });
        qa.appendChild(wrap);
        return;
      }

      if (step === 2) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üè∑Ô∏è Name der H√ºtte</h2>
            <input id="nameInput" class="w-full border p-2 rounded" placeholder="Name eingeben" value="${editingData.name || ''}">
          </div>`;
        return;
      }

      if (step === 3) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ü™ë Hat deine H√ºtte Sitzpl√§tze?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded" onclick="selectOption('sitzplaetze','Ja',this)">‚úÖ Ja</button>
              <button class="flex-1 p-3 border rounded" onclick="selectOption('sitzplaetze','Nein',this)">‚ùå Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 4) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üîå Gibt es Strom?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded" onclick="selectOption('strom','Ja',this)">‚ö° Ja</button>
              <button class="flex-1 p-3 border rounded" onclick="selectOption('strom','Nein',this)">‚ùå Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 5) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">‚ú® Extras (optional)</h2>
            <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. Getr√§nke, K√ºhlschrank" value="${editingData.extras || ''}">
          </div>`;
        return;
      }

      if (step === 6) {
        // Tiere toggle buttons (markieren, don't auto-next)
        const animals = ["üêê Ziege","üêÑ Kuh","üêì Huhn","üêï Hund","üêá Hase","üêà Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">üêæ Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const btn = document.createElement('button');
          const isSel = editingData.tiere.includes(t);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            // toggle
            if (t === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              // remove selected from others
              holder.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              return;
            }
            // if 'Keine Tiere' present -> remove it
            editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
            const idx = (editingData.tiere || []).indexOf(t);
            if (idx >= 0) {
              editingData.tiere.splice(idx, 1);
              btn.classList.remove('selected');
            } else {
              editingData.tiere.push(t);
              btn.classList.add('selected');
            }
          };
          holder.appendChild(btn);
        });
        return;
      }

      if (step === 7) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üìù Beschreibung</h2>
            <div id="quillContainer" class="bg-white"></div>
          </div>`;
        setTimeout(() => {
          // initialize quill and set content if exists
          const quill = new Quill('#quillContainer', { theme: 'snow' });
          if (editingData.beschreibung) quill.root.innerHTML = editingData.beschreibung;
          // store on change
          quill.on('text-change', () => { editingData.beschreibung = quill.root.innerHTML; });
        }, 120);
        return;
      }

      if (step === 8) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üè∑Ô∏è Schlagw√∂rter (Komma getrennt)</h2>
            <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. Fr√ºhst√ºck,Schattig" value="${(editingData.tags||[]).join(', ')}">
          </div>`;
        return;
      }

      if (step === 9) {
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">üìã √úbersicht</h2>
      <!-- ... deine √úbersichtsliste ... -->

      <h3 class="text-lg font-bold mt-4 mb-2">üìç Standort</h3>
      <div class="flex gap-2 mb-2">
        <input id="addressSearch" class="flex-1 border p-2 rounded" placeholder="Adresse suchen‚Ä¶" />
        <button class="px-3 py-2 bg-blue-600 text-white rounded" onclick="locateGPS()">üì° Mein Standort</button>
      </div>
      <div id="overview-map" class="h-64 rounded border mb-4"></div>

      <div class="flex gap-2">
        <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">‚úÖ Einreichen</button>
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="startNewEntry()">‚úñ Abbrechen</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird gepr√ºft und erst nach Freigabe sichtbar.</p>
    </div>`;

  setTimeout(() => {
    const map = L.map('overview-map').setView([51.3, 9.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker;
    if (editingData.location) {
      marker = L.marker([editingData.location.lat, editingData.location.lng], { draggable: true }).addTo(map);
      map.setView([editingData.location.lat, editingData.location.lng], 12);
    }

    map.on('click', e => {
      if (marker) marker.remove();
      marker = L.marker(e.latlng, { draggable: true }).addTo(map);
      editingData.location = { lat: e.latlng.lat, lng: e.latlng.lng };
      marker.on("dragend", ev => {
        const pos = ev.target.getLatLng();
        editingData.location = { lat: pos.lat, lng: pos.lng };
      });
    });

    // Adresse suchen
    document.getElementById('addressSearch').addEventListener('change', async (e) => {
      const q = e.target.value.trim();
      if (!q) return;
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (data && data.length > 0) {
        const { lat, lon } = data[0];
        map.setView([lat, lon], 14);
        if (marker) marker.remove();
        marker = L.marker([lat, lon], { draggable: true }).addTo(map);
        editingData.location = { lat: parseFloat(lat), lng: parseFloat(lon) };
        marker.on("dragend", ev => {
          const pos = ev.target.getLatLng();
          editingData.location = { lat: pos.lat, lng: pos.lng };
        });
      }
    });
  }, 200);
      return;
      }
      
    } catch (err) {
      console.error("renderQuestion error", err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler: ${err.message}</div>`;
    }
  }
function showTutorial() {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-2xl font-bold text-green-700 mb-4">üëã Willkommen!</h2>
      <p class="mb-4 text-gray-600">
        Sch√∂n, dass du den H√ºtten-Assistent benutzt. Hier ein kurzer √úberblick:
      </p>
      <ul class="list-disc ml-6 text-gray-700 mb-4">
        <li>√úber <strong>"Neue Eintragung"</strong> kannst du eine H√ºtte eintragen.</li>
        <li>Unter <strong>"Meine Eintragungen"</strong> siehst du deine H√ºtten, Fotos und Nachrichten.</li>
        <li>Im Bereich <strong>"Support"</strong> kannst du dich bei Fragen an uns wenden.</li>
      </ul>
      <p class="text-sm text-gray-500">
        Tipp: √úber die Men√ºleiste links findest du jederzeit alle Funktionen.
      </p>
    </div>`;
    }
  function selectOption(field, value, el) {
    // deselect siblings
    if (el && el.parentNode) {
      el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
      el.classList.add('selected');
    }
    editingData[field] = value;
  }

  function nextStep() {
    // validation for some steps
    if (step === 0) {
      const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked;
      if (!ok) { alert('Bitte Datenschutzerkl√§rung akzeptieren'); return; }
      editingData.datenschutz = true;
    }
    if (step === 2) {
      const v = document.getElementById('nameInput')?.value?.trim();
      if (!v) { alert('Bitte Namen eingeben'); return; }
      editingData.name = v;
    }
    if (step === 5) {
      editingData.extras = document.getElementById('extrasInput')?.value?.trim();
    }
    if (step === 7) {
      // description already captured via quill on change
    }
    if (step === 8) {
      const raw = document.getElementById('tagsInput')?.value || '';
      editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
    }

    if (step < stepsCount - 1) step++;
    renderQuestion();
    updateProgress();
  }

  function prevStep() {
    if (step > 0) step--;
    renderQuestion();
    updateProgress();
  }

  function startNewEntry() {
    if (!currentUser || !currentUser.uid) {
  showToast("Bitte zuerst einloggen");
  return;
    }
    editingData = {};
    step = 0;
    mode = "entry";
    renderQuestion();
    toggleSidebar();
    updateProgress();
  }

  async function submitEntry() {
    // ensure required fields
    if (!editingData.name || !editingData.typ) {
      alert('Bitte Typ und Name ausf√ºllen.');
      return;
    }
    // prepare object for firestore: follow existing structure & set status 'offen'
    const payload = {
      userId: currentUser.uid,
      name: editingData.name,
      typ: editingData.typ,
      sitzplaetze: editingData.sitzplaetze || 'Nein',
      strom: editingData.strom || 'Nein',
      extras: editingData.extras || '',
      tiere: editingData.tiere || [],
      beschreibung: editingData.beschreibung || '',
      tags: editingData.tags || [],
      status: 'offen',
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      datenschutzZustimmung: {
        bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(),
        durch: currentUser.email || null
      }
    };
    if (editingData.location && editingData.location.lat && editingData.location.lng) {
      payload.location = new firebase.firestore.GeoPoint(editingData.location.lat, editingData.location.lng);
    }
    try {
      await db.collection('eierhuetten').add(payload);
      showToast('‚úÖ Eintragung gesendet. Wird gepr√ºft.');
      startNewEntry();
    } catch (err) {
      console.error('submitEntry error', err);
      alert('Fehler beim Senden: ' + (err.message || err));
    }
  }
async function locateGPS() {
  if (!navigator.geolocation) return alert("GPS nicht verf√ºgbar");
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    editingData.location = { lat: latitude, lng: longitude };
    const map = L.map('overview-map').setView([latitude, longitude], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
    marker.on("dragend", ev => {
      const p = ev.target.getLatLng();
      editingData.location = { lat: p.lat, lng: p.lng };
    });
  });
        }
  /***********************
   * Sidebar actions: Meine Eintragungen (mit Bearbeitung)
   ***********************/
  async function showMyEntries() {
    if (!currentUser || !currentUser.uid) {
  showToast("Bitte zuerst einloggen");
  return;
}
    if (!db) { document.getElementById('question-area').innerHTML = '<div class="bg-red-100 p-4 rounded">Firestore nicht verf√ºgbar.</div>'; return; }
   mode = "list";
    const qa = document.getElementById('question-area');
    qa.innerHTML = '<div class="text-gray-500">‚è≥ Lade Eintragungen‚Ä¶</div>';
    try {
      const snapshot = await db.collection('eierhuetten').where('userId', '==', currentUser.uid).orderBy('erstelltAm','desc').get();
      const docs = snapshot.docs.filter(doc => {
        const st = doc.data().status;
        return st !== 'archiviert' && st !== 'deleted';
      });

      if (docs.length === 0) {
        qa.innerHTML = `<div class="bg-white p-6 rounded shadow max-w-2xl mx-auto">Du hast noch keine H√ºtten.</div>`;
        toggleSidebar();
        return;
      }

      // stats
      let total = 0, angenommen = 0, offen = 0;
      docs.forEach(d => { total++; if (d.data().status === 'angenommen') angenommen++; if (d.data().status === 'offen') offen++; });

      qa.innerHTML = '';
      const statsBar = document.createElement('div');
      statsBar.className = 'flex justify-around items-center text-sm bg-green-100 text-green-900 py-2 px-4 rounded mb-3 shadow-sm border border-green-300 max-w-2xl mx-auto';
      statsBar.innerHTML = `<div>ü•ö <strong>${total}</strong></div><div>‚úÖ <strong>${angenommen}</strong></div><div>‚è≥ <strong>${offen}</strong></div>`;
      qa.appendChild(statsBar);

      // render each hut card with edit controls
      for (const doc of docs) {
        const d = doc.data();
        const id = doc.id;
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow mb-4 max-w-2xl mx-auto';
        // badge color
        const statusTxt = d.status === "offen" ? "Wartet auf die Freigabe" : d.status;
        const badgeColor = d.status === 'accepted' || d.status === 'angenommen' ? 'bg-green-100 text-green-800' : (d.status === 'offen' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-700');
        card.innerHTML = `
          <div class="flex justify-between items-start gap-3">
            <div>
              <div class="font-bold text-lg">üè° ${escapeHtml(d.name || 'Unbenannt')}</div>
              <div class="text-xs text-gray-500 mt-1">${stripHtml(d.beschreibung || '')}</div>
              <div class="text-xs text-gray-500 mt-1">Extras: ${escapeHtml(d.extras || '-') } ‚Ä¢ Strom: ${escapeHtml(d.strom || '-') } ‚Ä¢ Sitzpl√§tze: ${escapeHtml(d.sitzplaetze || '-') }</div>
              <div class="text-xs text-gray-500 mt-1">Tiere: ${(Array.isArray(d.tiere)?d.tiere.join(', '):'-')}</div>
            </div>
            <div>
              <span class="px-2 py-1 rounded text-xs ${badgeColor}">${escapeHtml(statusTxt || '')}</span>
            </div>
          </div>

          <div class="mt-3 text-sm">
            <!-- editable fields (only active for accepted entries) -->
            ${d.status === 'angenommen' || d.status === 'accepted' ? `
              <label class="block mt-2">Name:<br>
                <input data-id="${id}" class="edit-name w-full border px-2 py-1 rounded" value="${escapeAttr(d.name||'')}" />
              </label>

              <label class="block mt-2">Sitzpl√§tze:
                <select data-id="${id}" class="edit-sitz border rounded px-2 py-1">
                  <option ${d.sitzplaetze==='Ja'?'selected':''}>Ja</option>
                  <option ${d.sitzplaetze==='Nein'?'selected':''}>Nein</option>
                </select>
              </label>

              <label class="block mt-2">Strom:
                <select data-id="${id}" class="edit-strom border rounded px-2 py-1">
                  <option ${d.strom==='Ja'?'selected':''}>Ja</option>
                  <option ${d.strom==='Nein'?'selected':''}>Nein</option>
                </select>
              </label>

              <label class="block mt-2">Extras:<br>
                <input data-id="${id}" class="edit-extras w-full border px-2 py-1 rounded" value="${escapeAttr(d.extras||'')}" />
              </label>

              <label class="block mt-2">Tiere:<br>
                <div class="tiere-buttons flex flex-wrap gap-1 mt-1" data-id="${id}">
                  ${["üêê Ziege","üêì Huhn","üêÑ Kuh","üêá Hase","üêï Hund","üêà Katze","Keine Tiere"].map(t => {
                    const isSelected = Array.isArray(d.tiere) && d.tiere.includes(t);
                    return `<button type="button" class="tiere-btn px-2 py-1 text-xs border rounded ${isSelected?'bg-green-200 border-green-400':'bg-gray-100 border-gray-300'}" data-tiere="${t}">${t}</button>`;
                  }).join('')}
                </div>
                <input type="hidden" data-id="${id}" class="edit-tiere-hidden" value='${Array.isArray(d.tiere)?escapeAttr(d.tiere.join(',')):""}' />
              </label>

              <label class="block mt-2">Beschreibung:<br>
                <div id="editor-${id}" class="quill-editor border rounded">${d.beschreibung || ''}</div>
              </label>

              <label class="block mt-2">Tags:<br>
                <input data-id="${id}" class="edit-tags w-full border px-2 py-1 rounded" value="${Array.isArray(d.tags)?escapeAttr(d.tags.join(', ')) : ''}" placeholder="Komma getrennt" />
              </label>

              <div class="mt-3">
                <button data-id="${id}" class="save-edit px-3 py-1 bg-green-600 text-white rounded">üíæ Speichern</button>
                <button data-id="${id}" class="delete-hut px-3 py-1 bg-red-600 text-white rounded ml-2">üóëÔ∏è L√∂schen</button>
              </div>
            ` : `
              <div class="text-sm text-gray-500 italic mt-2">‚õî Nach Freigabe bearbeitbar.</div>
              <div class="mt-2">
                <button data-id="${id}" class="delete-hut px-3 py-1 bg-red-600 text-white rounded">üóëÔ∏è L√∂schen</button>
              </div>
            `}
          </div>

          <!-- Fotos -->
          ${Array.isArray(d.fotos) && d.fotos.length ? `
            <div class="mt-3 grid grid-cols-3 gap-2">
              ${d.fotos.map((img, idx) => {
                const obj = (typeof img === 'string') ? { url: img, status: 'freigegeben' } : img;
                const pending = obj.status === 'wartet';
return `<div class="relative rounded overflow-hidden border p-1 bg-gray-50">
  <img src="${escapeAttr(obj.url)}" class="object-cover w-full h-24 rounded ${pending?'opacity-60':''}" />
  ${pending ? `<span class="absolute bottom-0 left-0 bg-yellow-500 text-white text-xs px-1">Wartet</span>` : ""}
  <button data-id="${id}" data-url="${escapeAttr(obj.url)}" class="delete-image absolute top-0 right-0 bg-red-600 text-white text-xs rounded-bl px-2">‚úï</button>
</div>`;
              }).join('')}
            </div>` : ''}

          <!-- upload -->
          <label class="block mt-3 text-sm">üì∑ Neues Bild:
            <input type="file" data-id="${id}" class="upload-image mt-1" accept="image/*">
          </label>
          <div id="progress-${id}" class="h-2 bg-gray-200 rounded hidden mt-2"><div class="h-2 bg-green-500 rounded" style="width:0%"></div></div>
          <div id="progress-label-${id}" class="text-xs text-gray-600 mt-1">0%</div>

          <!-- mini-map -->
          <div id="minimap-${id}" class="minimap mt-3 rounded border"></div>
       
        <div class="mt-3">
  <h4 class="font-bold text-sm mb-1">üí¨ Nachrichten</h4>
  <div id="msgs-${id}" class="space-y-1 text-sm text-gray-700"></div>
  <input id="msgInput-${id}" class="w-full border p-1 rounded mt-1" placeholder="Neue Nachricht..." />
  <button onclick="sendMsg('${id}')" class="mt-1 px-2 py-1 bg-green-600 text-white rounded text-xs">Senden</button>
</div>
        
        `;
        qa.appendChild(card);

        loadMessages(id);
        // after append: init quill editor, mini-map, attach events
        setTimeout(() => {
          // Quill
          const editorEl = document.getElementById(`editor-${id}`);
          if (editorEl) {
            const q = new Quill(`#editor-${id}`, { theme: 'snow' });
            if (d.beschreibung) q.root.innerHTML = d.beschreibung;
            // replace the save handler below to read from this quill
          }

          // map
          if (d.location && d.location.latitude && d.location.longitude) {
            try {
              const m = L.map(`minimap-${id}`, { zoomControl: true }).setView([d.location.latitude, d.location.longitude], 13);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
              const marker = L.marker([d.location.latitude, d.location.longitude], { draggable: (d.status==='angenommen') }).addTo(m);
              if (d.status === 'angenommen') {
                marker.on('dragend', async e => {
                  const pos = e.target.getLatLng();
                  await db.collection('eierhuetten').doc(id).update({ location: new firebase.firestore.GeoPoint(pos.lat, pos.lng) });
                  showToast('üìç Standort aktualisiert');
                });
              }
            } catch (err) { console.warn('map error', err); }
          }

        }, 300);
      } // end for

      // attach event delegation: Tiere buttons, save-edit, delete, upload
      setupMyEntriesDelegation();

      toggleSidebar();
    } catch (err) {
      console.error('showMyEntries error', err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler beim Laden: ${err.message}</div>`;
    }
  }

  /***********************
   * Delegation & Helpers for Editing UI
   ***********************/
  function setupMyEntriesDelegation() {
    // Tiere buttons (delegated)
    document.querySelectorAll('.tiere-buttons').forEach(container => {
      container.querySelectorAll('.tiere-btn').forEach(btn => {
        btn.onclick = () => {
          const t = btn.getAttribute('data-tiere');
          const parent = container;
          const hidden = parent.nextElementSibling; // edit-tiere-hidden
          let arr = hidden.value ? hidden.value.split(',').map(s=>s.trim()).filter(Boolean) : [];
          const idx = arr.indexOf(t);
          if (idx >= 0) {
            arr.splice(idx,1); btn.classList.remove('bg-green-200','border-green-400'); btn.classList.add('bg-gray-100','border-gray-300');
          } else {
            if (t === 'Keine Tiere') { arr = ['Keine Tiere']; parent.querySelectorAll('.tiere-btn').forEach(b=>b.classList.remove('bg-green-200','border-green-400')); btn.classList.add('bg-green-200','border-green-400'); }
            else {
              arr = arr.filter(x => x !== 'Keine Tiere');
              btn.classList.add('bg-green-200','border-green-400');
            }
          }
          hidden.value = arr.join(',');
        };
      });
    });

    // save edit buttons
    document.querySelectorAll('.save-edit').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        await saveEditFromUI(id);
      };
    });

    // delete hut
    document.querySelectorAll('.delete-hut').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('H√ºtte wirklich l√∂schen?')) return;
        try { await db.collection('eierhuetten').doc(id).update({ status: 'archiviert' }); showToast('H√ºtte archiviert'); showMyEntries(); }
        catch (e) { console.error(e); alert('Fehler: '+e.message); }
      };
    });

    // image upload inputs
    document.querySelectorAll('.upload-image').forEach(input => {
      input.onchange = async (ev) => {
        const id = input.getAttribute('data-id');
        await uploadImagesForHut(input.files, id);
      };
    });

    // delete image buttons
    document.querySelectorAll('.delete-image').forEach(btn => {
      btn.onclick = async (ev) => {
        const id = btn.getAttribute('data-id');
        const url = btn.getAttribute('data-url');
        if (!confirm('Dieses Bild l√∂schen?')) return;
        try {
          // remove from array
          const docRef = db.collection('eierhuetten').doc(id);
          const snap = await docRef.get();
          const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
          const newFotos = fotos.filter(f => (typeof f === 'string' ? f : f.url) !== url);
          await docRef.update({ fotos: newFotos });
          showToast('Bild entfernt');
          showMyEntries();
        } catch (e) { console.error(e); alert('Fehler: '+e.message); }
      };
    });
  }
function loadMessages(hutId) {
  const wrap = document.getElementById("msgs-" + hutId);
  if (!wrap) return;

  // Live-Listener
  db.collection("eierhuetten").doc(hutId)
    .collection("messages").orderBy("createdAt", "desc")
    .onSnapshot(snap => {
      wrap.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        wrap.innerHTML += `<div class="bg-gray-100 rounded px-2 py-1">
          <div>${escapeHtml(d.text)}</div>
          <div class="text-xs text-gray-500">
            ${d.sender || "-"} ¬∑ ${d.createdAt?.toDate?.().toLocaleString?.() || ""}
          </div>
        </div>`;
      });
    });
}

async function sendMsg(hutId) {
  const inp = document.getElementById("msgInput-"+hutId);
  const text = inp.value.trim();
  if (!text) return;
  await db.collection("eierhuetten").doc(hutId).collection("messages").add({
    text,
    sender: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  inp.value = "";
  loadMessages(hutId);
}
  async function saveEditFromUI(id) {
    try {
      const nameEl = document.querySelector(`.edit-name[data-id="${id}"]`);
      const sitzEl = document.querySelector(`.edit-sitz[data-id="${id}"]`);
      const stromEl = document.querySelector(`.edit-strom[data-id="${id}"]`);
      const extrasEl = document.querySelector(`.edit-extras[data-id="${id}"]`);
      const tiereHidden = document.querySelector(`.edit-tiere-hidden[data-id="${id}"]`);
      const tagsEl = document.querySelector(`.edit-tags[data-id="${id}"]`);
      const editorEl = document.getElementById(`editor-${id}`);

      const payload = {};
      if (nameEl) payload.name = nameEl.value.trim();
      if (sitzEl) payload.sitzplaetze = sitzEl.value;
      if (stromEl) payload.strom = stromEl.value;
      if (extrasEl) payload.extras = extrasEl.value.trim();
      if (tagsEl) payload.tags = tagsEl.value ? tagsEl.value.split(',').map(s=>s.trim()).filter(Boolean).slice(0,10) : [];
      if (tiereHidden) payload.tiere = tiereHidden.value ? tiereHidden.value.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if (editorEl) {
        // get quill contents
        try {
          const q = Quill.find(editorEl);
          if (q) payload.beschreibung = q.root.innerHTML;
        } catch (e) { console.warn('quill not found', e); }
      }

      // update firestore
      await db.collection('eierhuetten').doc(id).update(payload);
      // log
      await db.collection('eierhuetten').doc(id).collection('log').add({ admin: currentUser.email || currentUser.displayName || 'web', feld: 'edit', wert: JSON.stringify(payload), zeitpunkt: new Date() });
      showToast('‚úÖ √Ñnderungen gespeichert');
      // refresh list
      await showMyEntries();
    } catch (e) {
      console.error('saveEditFromUI error', e);
      alert('Fehler beim Speichern: ' + (e.message || e));
    }
  }

  /***********************
   * Image upload (immediate upload to imgbb + push to Firestore)
   ***********************/
  async function uploadImagesForHut(fileList, hutId) {
    if (!fileList || fileList.length === 0) return;
    const files = Array.from(fileList);
    const progressBar = document.getElementById(`progress-${hutId}`);
    const progressLabel = document.getElementById(`progress-label-${hutId}`);
    progressBar.classList.remove('hidden');
    let uploaded = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      progressLabel.textContent = `Lade ${i+1}/${files.length} ...`;
      try {
        const base64 = await fileToBase64(file);
        const fd = new FormData();
        fd.append('key', IMGBB_KEY);
        fd.append('image', base64);
        const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd });
        const json = await res.json();
        if (json && json.data && json.data.url) {
          uploaded.push({ url: json.data.url, delete_url: json.data.delete_url || null, status: 'wartet' });
        } else {
          console.warn('imgbb response invalid', json);
        }
        const pct = Math.round(((i+1)/files.length)*100);
        progressBar.querySelector('div').style.width = pct + '%';
      } catch (e) {
        console.error('upload error', e);
        showToast('Fehler beim Hochladen', 4000);
      }
    }

    // write to firestore
    if (uploaded.length > 0) {
      try {
        const ref = db.collection('eierhuetten').doc(hutId);
        await ref.update({ fotos: firebase.firestore.FieldValue.arrayUnion(...uploaded) });
        showToast('Bilder hochgeladen (warten auf Freigabe)');
      } catch (e) {
        console.error('write fotos error', e);
        alert('Fehler beim Speichern der Bild-Daten: ' + e.message);
      }
    }
    progressLabel.textContent = 'Fertig';
    setTimeout(()=>{ progressBar.classList.add('hidden'); progressLabel.textContent = '0%'; }, 1200);
    // refresh
    showMyEntries();
  }

  function fileToBase64(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const base64 = dataUrl.split(',')[1];
        res(base64);
      };
      reader.onerror = err => rej(err);
      reader.readAsDataURL(file);
    });
  }

  /***********************
   * Support form
   ***********************/
  function openSupport() {
    if (!currentUser || !currentUser.uid) {
  showToast("Bitte zuerst einloggen");
  return;
}
    mode = "list";
    const qa = document.getElementById('question-area');
    qa.innerHTML = `
      <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
        <h2 class="text-xl font-bold mb-3">üì® Support</h2>
        <input id="supName" class="w-full border p-2 rounded mb-2" placeholder="Dein Name" />
        <input id="supMail" class="w-full border p-2 rounded mb-2" placeholder="E-Mail" />
        <textarea id="supMsg" class="w-full border p-2 rounded mb-2" rows="5" placeholder="Nachricht"></textarea>
        <div class="flex gap-2">
          <button class="px-4 py-2 bg-green-600 text-white rounded" onclick="sendSupport()">Absenden</button>
          <button class="px-4 py-2 bg-gray-200 rounded" onclick="startNewEntry()">Abbrechen</button>
        </div>
      </div>`;
    toggleSidebar();
  }

  async function sendSupport() {
    const name = document.getElementById('supName').value.trim();
    const mail = document.getElementById('supMail').value.trim();
    const msg = document.getElementById('supMsg').value.trim();
    if (!msg || !mail) { alert('Bitte Nachricht und E-Mail ausf√ºllen'); return; }
    try {
      await db.collection('support').add({ name, mail, msg, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      showToast('‚úÖ Nachricht gesendet');
      startNewEntry();
    } catch (e) {
      console.error('sendSupport error', e);
      alert('Fehler: ' + e.message);
    }
  }

  /***********************
   * Utility, escape helpers
   ***********************/
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }
  function escapeAttr(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
function stripHtml(html) {
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}
  /***********************
   * Sidebar toggle + init
   ***********************/
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }
async function showSupportTickets() {
  if (!currentUser || !currentUser.uid) {
  showToast("Bitte zuerst einloggen");
  return;
}
  mode = "list";
  const qa = document.getElementById("question-area");
  qa.innerHTML = "‚è≥ Lade Support-Tickets‚Ä¶";
  const snap = await db.collection("support").where("mail","==",currentUser.email).orderBy("createdAt","desc").get();
  if (snap.empty) { qa.innerHTML = "<p>Keine Support-Anfragen gefunden.</p>"; return; }
  qa.innerHTML = "";
  snap.forEach(doc=>{
    const d = doc.data();
    qa.innerHTML += `
      <div class="bg-white p-4 rounded shadow mb-2">
        <div class="font-bold">üì® ${d.msg}</div>
        <div class="text-xs text-gray-500">Gesendet: ${d.createdAt?.toDate?.().toLocaleString?.() || '-'}</div>
        <div class="text-xs">Status: ${d.status || "offen"}</div>
        <button class="delete-support px-2 py-1 text-xs bg-red-600 text-white rounded mt-1" onclick="deleteSupport('${doc.id}')">L√∂schen</button>
      </div>`;
  });
  toggleSidebar();
}

async function deleteSupport(id) {
  if (!confirm("Ticket wirklich l√∂schen?")) return;
  await db.collection("support").doc(id).delete();
  showToast("Support-Ticket gel√∂scht");
  showSupportTickets();
}
  // initial render
  renderQuestion();
  updateProgress();

  // Expose helpful functions to window for inline handlers
  window.selectOption = selectOption;
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  window.startNewEntry = startNewEntry;
  window.showMyEntries = showMyEntries;
  window.openSupport = openSupport;
  window.toggleSidebar = toggleSidebar;
  window.submitEntry = submitEntry;

  </script>
</body>
</html>
