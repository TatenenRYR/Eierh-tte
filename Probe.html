<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eierhütten Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<!-- Leaflet (Karte) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-50">

<!-- ================= LOGIN ================= -->
<div id="loginPage" class="flex flex-col items-center justify-center min-h-screen p-6">
  <img src="https://images.unsplash.com/photo-1501004318641-b39e6451bec6?w=600" class="w-60 rounded-xl shadow mb-6">
  <h1 class="text-3xl font-bold mb-4 text-green-700">Willkommen bei Eierhütten!</h1>
  <p class="mb-6 text-gray-600 text-center max-w-md">
    Melde dich an, um deine Hütte einzutragen oder zu verwalten.
  </p>
  <button id="googleLogin" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700">
    Mit Google anmelden
  </button>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="hidden">
  <!-- Seiten-Navigation -->
  <nav class="fixed top-0 left-0 h-full w-20 bg-white shadow flex flex-col items-center py-6 space-y-6">
    <button class="navBtn" data-page="home">🏠</button>
    <button class="navBtn" data-page="new">➕</button>
    <button class="navBtn" data-page="list">📂</button>
    <button class="navBtn" data-page="support">💬</button>
    <button class="navBtn" data-page="profile">👤</button>
    <button id="logoutBtn" class="mt-auto text-red-600">⏏️</button>
  </nav>

  <!-- Hauptinhalt -->
  <main class="ml-20 p-6">
    <!-- HOME -->
    <section id="page-home">
      <h2 class="text-2xl font-bold mb-4">Hallo <span id="userName"></span> 👋</h2>
      <p class="text-gray-700">Willkommen zurück!  
         Du kannst neue Hütten eintragen oder deine bestehenden verwalten.</p>
      <img src="https://images.unsplash.com/photo-1506967228489-3f1ad26f9de3?w=800"
           class="rounded-xl mt-6 shadow">
    </section>

    <!-- NEUE HÜTTE -->
    <section id="page-new" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Neue Hütte eintragen</h2>
      <form id="hutForm" class="space-y-4 max-w-lg">
        <input class="w-full border p-2 rounded" id="hutName" placeholder="Name der Hütte" required>
        <textarea class="w-full border p-2 rounded" id="hutDesc" placeholder="Beschreibung" required></textarea>
        <input class="w-full border p-2 rounded" id="hutTimes" placeholder="Öffnungszeiten (z.B. 08–20 Uhr)">
        <div id="map" class="h-48 rounded border"></div>
        <input type="file" id="hutPhotos" multiple accept="image/*" class="mt-2">
        <div id="photoPreview" class="grid grid-cols-3 gap-2"></div>
        <button class="bg-green-600 text-white px-4 py-2 rounded">Speichern</button>
      </form>
    </section>

    <!-- MEINE HÜTTEN -->
    <section id="page-list" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Meine Hütten</h2>
      <div id="hutList" class="grid gap-4"></div>
    </section>

    <!-- SUPPORT -->
    <section id="page-support" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Support</h2>
      <textarea id="supportText" class="w-full border p-2 rounded" placeholder="Deine Nachricht"></textarea>
      <button id="supportSend" class="bg-green-600 text-white px-4 py-2 rounded mt-2">Senden</button>
      <div id="ticketList" class="mt-4 space-y-2"></div>
    </section>

    <!-- PROFILE -->
    <section id="page-profile" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Profil</h2>
      <img id="profilePic" class="w-24 h-24 rounded-full mb-2">
      <p id="profileEmail"></p>
    </section>
  </main>
</div>

<script>
/* ---------- Firebase Setup (deine Daten eintragen!) ---------- */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ---------- DOM ---------- */
const loginPage = document.getElementById('loginPage');
const dashboard = document.getElementById('dashboard');
const userName = document.getElementById('userName');

/* ---------- Login ---------- */
document.getElementById('googleLogin').onclick = () => {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};
document.getElementById('logoutBtn').onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  if (user) {
    loginPage.classList.add('hidden');
    dashboard.classList.remove('hidden');
    userName.textContent = user.displayName || user.email;
    document.getElementById('profilePic').src = user.photoURL || '';
    document.getElementById('profileEmail').textContent = user.email;
    loadHuts();
    loadTickets();
  } else {
    dashboard.classList.add('hidden');
    loginPage.classList.remove('hidden');
  }
});

/* ---------- Navigation ---------- */
document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
    document.getElementById('page-'+btn.dataset.page).classList.remove('hidden');
  };
});

/* ---------- Karte ---------- */
let marker;
const map = L.map('map').setView([51,10],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
map.on('click', e=>{
  if (!marker) marker = L.marker(e.latlng,{draggable:true}).addTo(map);
  marker.setLatLng(e.latlng);
});

/* ---------- Foto Vorschau ---------- */
document.getElementById('hutPhotos').addEventListener('change', e=>{
  const preview = document.getElementById('photoPreview');
  preview.innerHTML = '';
  [...e.target.files].forEach(f=>{
    const r = new FileReader();
    r.onload = () => preview.innerHTML += `<img src="${r.result}" class="w-full h-24 object-cover rounded">`;
    r.readAsDataURL(f);
  });
});

/* ---------- Neue Hütte speichern ---------- */
document.getElementById('hutForm').onsubmit = async e=>{
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return;
  const data = {
    userId: user.uid,
    name: hutName.value,
    desc: hutDesc.value,
    times: hutTimes.value,
    created: firebase.firestore.FieldValue.serverTimestamp()
  };
  if (marker) {
    const p = marker.getLatLng();
    data.location = new firebase.firestore.GeoPoint(p.lat, p.lng);
  }
  // Fotos hochladen
  const files = hutPhotos.files;
  const urls = [];
  for (const f of files){
    const ref = storage.ref(`huts/${user.uid}/${Date.now()}_${f.name}`);
    await ref.put(f);
    urls.push(await ref.getDownloadURL());
  }
  data.photos = urls;
  await db.collection('huts').add(data);
  hutForm.reset();
  photoPreview.innerHTML = '';
  alert('✅ Hütte gespeichert!');
  loadHuts();
};

/* ---------- Meine Hütten ---------- */
async function loadHuts(){
  const list = document.getElementById('hutList');
  list.innerHTML = 'Lädt…';
  const snap = await db.collection('huts')
    .where('userId','==',auth.currentUser.uid)
    .orderBy('created','desc')
    .get();
  list.innerHTML = '';
  snap.forEach(doc=>{
    const d = doc.data();
    const img = d.photos?.[0] || 'https://via.placeholder.com/300x200?text=Kein+Bild';
    list.innerHTML += `
      <div class="bg-white p-4 rounded shadow">
        <img src="${img}" class="w-full h-40 object-cover rounded mb-2">
        <h3 class="font-bold">${d.name}</h3>
        <p class="text-sm text-gray-600">${d.desc}</p>
      </div>`;
  });
}

/* ---------- Support ---------- */
document.getElementById('supportSend').onclick = async()=>{
  const text = supportText.value.trim();
  if (!text) return;
  await db.collection('support').add({
    userId: auth.currentUser.uid,
    text,
    created: firebase.firestore.FieldValue.serverTimestamp()
  });
  supportText.value = '';
  loadTickets();
};
async function loadTickets(){
  const box = document.getElementById('ticketList');
  const snap = await db.collection('support')
    .where('userId','==',auth.currentUser.uid)
    .orderBy('created','desc')
    .get();
  box.innerHTML = '';
  snap.forEach(doc=>{
    box.innerHTML += `<div class="bg-gray-100 p-2 rounded">${doc.data().text}</div>`;
  });
}
</script>
</body>
</html>
