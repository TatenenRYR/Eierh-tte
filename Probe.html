<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EierhÃ¼tten â€“ User Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body class="bg-gray-100">

<!-- LOGIN -->
<section id="login" class="flex justify-center items-center h-screen">
  <button id="loginBtn"
    class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded">
    Google Login
  </button>
</section>

<!-- APP -->
<section id="app" class="hidden max-w-4xl mx-auto p-4 space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-green-700">Meine EierhÃ¼tten</h1>
    <button id="logout" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
  </div>

  <!-- Ãœbersicht -->
  <div>
    <h2 class="text-xl font-bold mb-2">ðŸ“‹ Meine EintrÃ¤ge</h2>
    <div id="hutList" class="space-y-3"></div>
    <button id="newEntry" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">âž• Neue HÃ¼tte</button>
  </div>

  <!-- Wizard -->
  <div id="wizard" class="hidden bg-white p-4 rounded-xl shadow">
    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
      <div id="progress" class="bg-green-500 h-2 rounded-full" style="width:0%"></div>
    </div>
    <div id="stepContent" class="space-y-4"></div>
    <div class="flex justify-between mt-4">
      <button id="prevStep" class="bg-gray-300 px-4 py-2 rounded">ZurÃ¼ck</button>
      <button id="nextStep" class="bg-green-600 text-white px-4 py-2 rounded">Weiter</button>
    </div>
  </div>
</section>

<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// --- Login ---
const loginSec=document.getElementById('login');
const appSec=document.getElementById('app');
document.getElementById('loginBtn').onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
document.getElementById('logout').onclick=()=>auth.signOut();
auth.onAuthStateChanged(u=>{
  if(u){loginSec.classList.add('hidden');appSec.classList.remove('hidden');loadHuts();}
  else{appSec.classList.add('hidden');loginSec.classList.remove('hidden');}
});

// --- Meine HÃ¼tten laden ---
async function loadHuts(){
  const snap = await db.collection('eierhuetten').where('userId','==',auth.currentUser.uid).get();
  const box=document.getElementById('hutList');
  box.innerHTML = snap.empty ? '<p class="text-gray-500">Keine EintrÃ¤ge</p>' : '';
  snap.forEach(doc=>{
    const h = doc.data();
    const imgs = (h.fotos||[]).map(f=>`<img src="${typeof f==='string'?f:f.url}" class="w-24 h-24 object-cover rounded">`).join('');
    box.innerHTML += `
      <div class="bg-white p-3 rounded shadow space-y-2">
        <div class="font-bold text-lg">${h.name||'Ohne Namen'}</div>
        <div class="text-sm text-gray-500">Status: ${h.status||'offen'}</div>
        <div class="flex gap-2 flex-wrap">${imgs||'<span class="text-gray-400">keine Fotos</span>'}</div>
      </div>`;
  });
}

// --- Wizard Steps ---
let step=0, wizardData={}, files=[];
const steps=[
  {title:'Name',render:()=>`<input id="name" class="border p-2 rounded w-full" placeholder="Name"/>`},
  {title:'Beschreibung',render:()=>`<textarea id="desc" class="border p-2 rounded w-full" rows="3"></textarea>`},
  {title:'Standort',render:()=>`<div id="map" class="h-64 rounded"></div>`},
  {title:'Fotos',render:()=>`
     <input id="photos" type="file" multiple accept="image/*" class="block mb-2"/>
     <div id="preview" class="flex gap-2 flex-wrap"></div>`}
];
function renderStep(){
  document.getElementById('stepContent').innerHTML = 
    `<h3 class="text-lg font-bold mb-2">${steps[step].title}</h3>${steps[step].render()}`;
  document.getElementById('progress').style.width=((step+1)/steps.length*100)+'%';
  document.getElementById('prevStep').disabled = step===0;
  document.getElementById('nextStep').textContent = step===steps.length-1?'Speichern':'Weiter';

  if(step===2){ // Leaflet Karte
    const map=L.map('map').setView([51.1657,10.4515],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const marker=L.marker([51.1657,10.4515],{draggable:true}).addTo(map);
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      map.setView(latlng,13); marker.setLatLng(latlng);
      wizardData.location=new firebase.firestore.GeoPoint(...latlng);
    });
    marker.on('dragend',e=>{
      const pos=e.target.getLatLng();
      wizardData.location=new firebase.firestore.GeoPoint(pos.lat,pos.lng);
    });
  }
  if(step===3){
    document.getElementById('photos').onchange=e=>{
      files=[...e.target.files];
      const prev=document.getElementById('preview'); prev.innerHTML='';
      files.forEach(f=>{
        const r=new FileReader();
        r.onload=()=>prev.innerHTML+=`<img src="${r.result}" class="w-24 h-24 object-cover rounded">`;
        r.readAsDataURL(f);
      });
    };
  }
}
renderStep();
document.getElementById('prevStep').onclick=()=>{if(step>0){step--;renderStep();}};
document.getElementById('nextStep').onclick=async()=>{
  if(step===0) wizardData.name=document.getElementById('name').value;
  if(step===1) wizardData.beschreibung=document.getElementById('desc').value;
  if(step<steps.length-1){step++;renderStep();}
  else{
    // Upload Bilder
    const uploaded=[];
    for(const f of files){
      const ref=storage.ref(`huts/${Date.now()}_${f.name}`);
      await ref.put(f);
      uploaded.push(await ref.getDownloadURL());
    }
    await db.collection('eierhuetten').add({
      userId: auth.currentUser.uid,
      name: wizardData.name,
      beschreibung: wizardData.beschreibung,
      location: wizardData.location||null,
      fotos: uploaded,
      status: 'offen',
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('âœ… Eintrag gespeichert!');
    step=0; wizardData={}; files=[];
    document.getElementById('wizard').classList.add('hidden');
    loadHuts();
  }
};

// --- Buttons ---
document.getElementById('newEntry').onclick=()=>{
  document.getElementById('wizard').classList.remove('hidden');
  renderStep();
};
</script>
</body>
</html>
