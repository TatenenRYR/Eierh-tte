<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eierh√ºtten ‚Äì User Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body class="bg-gray-100">

<!-- LOGIN -->
<section id="login" class="flex justify-center items-center h-screen">
  <button id="loginBtn"
    class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 text-xl rounded-xl shadow-lg">
    üü¢ Mit Google anmelden
  </button>
</section>

<!-- APP -->
<section id="app" class="hidden max-w-5xl mx-auto p-4 space-y-8">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h1 class="text-3xl font-extrabold text-green-700">üê£ Meine Eierh√ºtten</h1>
    <button id="logout"
      class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl">Logout</button>
  </div>

  <!-- √úbersicht -->
  <div>
    <h2 class="text-2xl font-bold mb-4">üì∏ Meine Eintr√§ge</h2>
    <div id="hutList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    <div class="text-center mt-6">
      <button id="newEntry"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl text-lg">
        ‚ûï Neue H√ºtte eintragen
      </button>
    </div>
  </div>

  <!-- Wizard -->
  <div id="wizard" class="hidden bg-white p-6 rounded-2xl shadow-2xl">
    <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
      <div id="progress" class="bg-green-500 h-3 rounded-full" style="width:0%"></div>
    </div>
    <div id="stepContent" class="space-y-6"></div>
    <div class="flex justify-between mt-6">
      <button id="prevStep"
        class="bg-gray-300 px-6 py-3 rounded-xl text-lg">‚¨ÖÔ∏è Zur√ºck</button>
      <button id="nextStep"
        class="bg-green-600 text-white px-6 py-3 rounded-xl text-lg">Weiter ‚û°Ô∏è</button>
    </div>
  </div>
</section>

<script>
// ---- Firebase ----
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ---- Elemente ----
const loginSec=document.getElementById('login');
const appSec=document.getElementById('app');
const listBox=document.getElementById('hutList');

// Login
document.getElementById('loginBtn').onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
document.getElementById('logout').onclick=()=>auth.signOut();
auth.onAuthStateChanged(u=>{
  if(u){loginSec.classList.add('hidden');appSec.classList.remove('hidden');loadHuts();}
  else{appSec.classList.add('hidden');loginSec.classList.remove('hidden');}
});

// ---- Dashboard ----
async function loadHuts(){
  const snap = await db.collection('eierhuetten').where('userId','==',auth.currentUser.uid).get();
  listBox.innerHTML = snap.empty ? '<p class="text-gray-500">Keine Eintr√§ge</p>' : '';
  snap.forEach(doc=>{
    const h=doc.data();
    const fotos=(h.fotos||[]).map(url=>
      `<img src="${url}" class="w-full h-48 object-cover rounded-xl">`).join('');
    listBox.innerHTML += `
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        ${fotos || '<div class="bg-gray-200 h-48 flex items-center justify-center text-gray-400">Kein Bild</div>'}
        <div class="p-4">
          <div class="font-bold text-xl mb-1">${h.name||'Ohne Namen'}</div>
          <div class="text-gray-600 mb-2">${h.beschreibung||''}</div>
          <span class="text-sm text-gray-500">Status: ${h.status||'offen'}</span>
        </div>
      </div>`;
  });
}

// ---- Wizard Steps ----
let step=0, wizardData={}, files=[];
const steps=[
  {title:'üè∑Ô∏è Name & Beschreibung',render:()=>`
     <input id="name" class="border p-3 rounded-xl w-full mb-4" placeholder="Name der H√ºtte"/>
     <textarea id="desc" class="border p-3 rounded-xl w-full" rows="4"
       placeholder="Kurzbeschreibung"></textarea>`},
  {title:'üìç Standort w√§hlen',render:()=>`
     <div id="map" class="h-80 rounded-2xl"></div>`},
  {title:'üì∑ Fotos hochladen',render:()=>`
     <input id="photos" type="file" multiple accept="image/*" class="mb-4"/>
     <div id="preview" class="grid grid-cols-3 gap-3"></div>`},
  {title:'‚úÖ Zusammenfassung',render:()=>`
     <div class="bg-gray-50 p-4 rounded-xl">
       <p><b>Name:</b> ${wizardData.name||''}</p>
       <p><b>Beschreibung:</b> ${wizardData.beschreibung||''}</p>
       <p><b>Fotos:</b> ${files.length} ausgew√§hlt</p>
       <p><b>Standort:</b> ${wizardData.location ? 
         wizardData.location.latitude.toFixed(4)+','+wizardData.location.longitude.toFixed(4)
         : '‚Äì'}</p>
     </div>`}
];

function renderStep(){
  document.getElementById('stepContent').innerHTML =
    `<h3 class="text-2xl font-bold mb-4">${steps[step].title}</h3>${steps[step].render()}`;
  document.getElementById('progress').style.width=((step+1)/steps.length*100)+'%';
  document.getElementById('prevStep').disabled = step===0;
  document.getElementById('nextStep').textContent =
    step===steps.length-1 ? 'Eintrag speichern' : 'Weiter ‚û°Ô∏è';

  if(step===1){ // Karte
    const map=L.map('map').setView([51,10],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const m=L.marker([51,10],{draggable:true}).addTo(map);
    navigator.geolocation.getCurrentPosition(p=>{
      const latlng=[p.coords.latitude,p.coords.longitude];
      map.setView(latlng,13); m.setLatLng(latlng);
      wizardData.location=new firebase.firestore.GeoPoint(...latlng);
    });
    m.on('dragend',e=>{
      const pos=e.target.getLatLng();
      wizardData.location=new firebase.firestore.GeoPoint(pos.lat,pos.lng);
    });
  }
  if(step===2){
    document.getElementById('photos').onchange=e=>{
      files=[...e.target.files];
      const prev=document.getElementById('preview'); prev.innerHTML='';
      files.forEach(f=>{
        const r=new FileReader();
        r.onload=()=>prev.innerHTML+=
          `<img src="${r.result}" class="w-full h-32 object-cover rounded-xl">`;
        r.readAsDataURL(f);
      });
    };
  }
}
renderStep();

document.getElementById('prevStep').onclick=()=>{ if(step>0){step--;renderStep();} };
document.getElementById('nextStep').onclick=async ()=>{
  if(step===0){
    wizardData.name=document.getElementById('name').value;
    wizardData.beschreibung=document.getElementById('desc').value;
  }
  if(step<steps.length-1){ step++; renderStep(); }
  else{
    // Bilder hochladen
    const urls=[];
    for(const f of files){
      const ref=storage.ref(`huts/${Date.now()}_${f.name}`);
      await ref.put(f);
      urls.push(await ref.getDownloadURL());
    }
    await db.collection('eierhuetten').add({
      userId: auth.currentUser.uid,
      name: wizardData.name,
      beschreibung: wizardData.beschreibung,
      location: wizardData.location||null,
      fotos: urls,
      status: 'offen',
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('‚úÖ Eintrag gespeichert!');
    step=0; wizardData={}; files=[];
    document.getElementById('wizard').classList.add('hidden');
    loadHuts();
  }
};

// ---- Button Neue H√ºtte ----
document.getElementById('newEntry').onclick=()=>{
  document.getElementById('wizard').classList.remove('hidden');
  renderStep();
};
</script>
</body>
</html>
