<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Neue Eierhütte einreichen mit Karte</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; background: #f9f9f9; padding: 1rem; border-radius: 8px; }
  label { display: block; margin-top: 1rem; }
  input, button { padding: 0.5rem; width: 100%; margin-top: 0.25rem; }
  button { background-color: #2c7be5; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .message { margin-top: 1rem; }
  #map { height: 300px; margin-top: 1rem; border-radius: 8px; }
  #coords { margin-top: 0.5rem; font-weight: bold; }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let map, marker;

  function initMap() {
    // Standard-Koordinaten (Mitte Europa)
    const startCoords = [51.1657, 10.4515];

    map = L.map('map').setView(startCoords, 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Wenn Browser Standort erlaubt
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const userCoords = [pos.coords.latitude, pos.coords.longitude];
        map.setView(userCoords, 13);
        setMarker(userCoords);
      }, () => {
        // Fehler oder kein Zugriff, bleibt bei Standard
      });
    }

    // Marker per Klick setzen & Koordinaten aktualisieren
    map.on('click', e => {
      setMarker([e.latlng.lat, e.latlng.lng]);
    });
  }

  function setMarker(coords) {
    if (marker) {
      marker.setLatLng(coords);
    } else {
      marker = L.marker(coords, { draggable: true }).addTo(map);
      marker.on('dragend', () => {
        const pos = marker.getLatLng();
        updateCoords(pos.lat, pos.lng);
      });
    }
    updateCoords(coords[0], coords[1]);
  }

  function updateCoords(lat, lng) {
    document.getElementById('coords').innerText = `Latitude: ${lat.toFixed(5)}, Longitude: ${lng.toFixed(5)}`;
    // Speichere Koordinaten in unsichtbaren Feldern für Formular-Submit
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;
  }

  async function einreichen(event) {
    event.preventDefault();

    const name = document.getElementById('name').value.trim();
    const strom = document.getElementById('strom').checked;
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    const fotoFile = document.getElementById('foto').files[0];

    if (!name) {
      showMessage('Bitte den Namen der Hütte angeben.', true);
      return;
    }
    if (isNaN(lat) || isNaN(lng)) {
      showMessage('Bitte einen Ort auf der Karte auswählen.', true);
      return;
    }

    const kosten = 2.00;
    let fotoUrl = null;

    try {
      if (fotoFile) {
        const storageRef = storage.ref();
        const fotoRef = storageRef.child(`huetten_fotos/${Date.now()}_${fotoFile.name}`);
        const snapshot = await fotoRef.put(fotoFile);
        fotoUrl = await snapshot.ref.getDownloadURL();
      }

      await db.collection('huetten_pending').add({
        name,
        strom,
        lat,
        lng,
        status: 'offen',
        kosten,
        fotoUrl,
        eingereichtAm: new Date().toISOString(),
      });

      showMessage('Eierhütte erfolgreich eingereicht! Vielen Dank.');
      document.getElementById('einreichenForm').reset();
      document.getElementById('coords').innerText = '';
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }

    } catch (error) {
      showMessage('Fehler beim Einreichen: ' + error.message, true);
    }
  }

  function showMessage(msg, isError = false) {
    const messageEl = document.getElementById('message');
    messageEl.innerText = msg;
    messageEl.style.color = isError ? 'red' : 'green';
  }

  window.onload = initMap;
</script>

</head>
<body>

<h1>Neue Eierhütte einreichen</h1>

<form id="einreichenForm" onsubmit="einreichen(event)">

  <label for="name">Name der Hütte*</label>
  <input type="text" id="name" required />

  <label><input type="checkbox" id="strom" /> Strom vorhanden</label>

  <label>Standort auf Karte wählen*</label>
  <div id="map"></div>
  <div id="coords"></div>

  <!-- Versteckte Felder für Koordinaten -->
  <input type="hidden" id="lat" />
  <input type="hidden" id="lng" />

  <label for="foto">Foto (optional)</label>
  <input type="file" id="foto" accept="image/*" />

  <button type="submit">Hütte einreichen</button>
</form>

<p id="message" class="message"></p>

</body>
</html>
