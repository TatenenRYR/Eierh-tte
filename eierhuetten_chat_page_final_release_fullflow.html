<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="google-adsense-account" content="ca-pub-2577915567428766">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Assistent Chat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
 <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn {
      margin-top: 0.5rem; background: #fbbf24; color: #92400e;
      padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer;
      display: inline-block; margin-right: 0.5rem;
    }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .time-picker { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .time-picker input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 0.5rem; width: 45%; }
 
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #d1fae5;
  color: #065f46;
  padding: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: sans-serif;
  border: 1px solid #065f46;
}




    /* Hover-Effekte f√ºr Links */
  #consent-modal a:hover {
    color: #0056b3 !important;
    border-color: #0056b3 !important;
  }

  /* Button Hover-Effekt */
  #consent-accept:hover {
    background: linear-gradient(135deg, #45A049, #3e8e41);
    transform: translateY(-1px);
  }

  /* Button Klick-Effekt */
  #consent-accept:active {
    transform: translateY(0);
  }
   .hidden {
  display: none !important;
   }
 </style>
</head>
  <body class="bg-gray-50">
<!-- START: Login + Chat Screens inserted by assistant -->
<div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50">
  <h1 class="text-2xl font-bold mb-4">Eierh√ºttentour ‚Äî Anmeldung</h1>
  <button id="login-btn" class="px-5 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700">Mit Google anmelden</button>
</div>

<div id="chat-screen" class="hidden min-h-screen flex flex-col">
  <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
  <div class="p-3 bg-gray-50 border-t flex gap-2 items-center">
    <input id="chat-input" class="flex-1 border rounded px-3 py-2" placeholder="Antwort hier eingeben..." />
    <button id="send-btn" class="px-4 py-2 bg-green-600 text-white rounded">Senden</button>
    <button id="my-huts-btn" class="px-3 py-2 bg-blue-500 text-white rounded">Meine H√ºtten</button>
  </div>
</div>
<!-- END: Login + Chat Screens -->

  <!-- Login -->
  <div id="login-section" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow max-w-sm w-full text-center space-y-4">
      <h1 class="text-2xl font-bold">Login</h1>
      <p class="text-gray-500">Bitte mit Google anmelden.</p>
      <button id="google-login" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded w-full">
        Mit Google anmelden
      </button>
    </div>
  </div>

<!-- Werbung oberhalb vom Chat -->
<div id="adsense-container" style="margin:20px auto; text-align:center; display:none;">
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-2577915567428766"
       data-ad-slot="3060614235"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
</div>
  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">

    
    
    <!-- Navigation -->
<div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    üë§ <span id="user-name">L√§dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîÑ
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üè†
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîì
    </button>
  </div>
</div>


    
    <div class="text-center font-bold text-2xl text-green-700 mb-4">H√ºtten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
   <input type="file" id="image-upload" accept="image/*" multiple hidden />
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>


<!-- Consent Modal -->

<div id="consent-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">    <div style="background:white; padding:25px 30px; max-width:520px; width:100%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:sans-serif; line-height:1.6; color:#333;">  
    
    <h2 style="margin-top:0; font-size:1.6rem; font-weight:600; color:#222; margin-bottom:15px;">Datenschutz & Cookies</h2>  
    
    <p style="margin-bottom:15px; font-size:1rem;">  
      Wir verwenden Cookies und √§hnliche Technologien, um unsere Dienste bereitzustellen und zu verbessern.  
      Mehr dazu in unserer   
      <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">  
        Datenschutzerkl√§rung  
      </a>.  
    </p>  
    
    <label style="display:flex; align-items:center; margin-top:15px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-privacy" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Datenschutzerkl√§rung</a> zu</span>  
    </label>  
    
    <label style="display:flex; align-items:center; margin-top:10px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-cookies" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der Verwendung von Cookies gem√§√ü der <a href="/cookies.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Cookie-Richtlinie</a> zu</span>  
    </label>  

    <div style="margin-top:25px; text-align:right;">  
<button id="consent-accept" onclick="acceptConsent()" style="padding:10px 20px; background:linear-gradient(135deg, #4CAF50, #45A049); color:white; border:none; border-radius:6px; font-size:1rem; font-weight:500; cursor:pointer; transition:background 0.3s, transform 0.1s;">
  Zustimmen
</button>
    </div>  
  </div>  
</div>  


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.firebasestorage.app",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
    measurementId: "G-16V6K5GXDT"
  };

  if (!window.firebase) {
    console.error('Firebase SDKs not loaded.'); 
  } else {
    try { firebase.app(); } catch(e) { firebase.initializeApp(firebaseConfig); }
  }

  // expose services globally
  if (window.firebase) {
    window.db = firebase.firestore();
    window.auth = firebase.auth();
    window.storage = firebase.storage();
    window.functions = firebase.functions();
  }

  // Google Login wiring: show login screen until authenticated
  let authInitialized = false;
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('chat-screen').classList.remove('hidden');
      // greet
      if (typeof addMessage === 'function') addMessage('üëã Willkommen, ' + (user.displayName || 'Nutzer') + '!', 'bot');
    } else {
      currentUser = null;
      document.getElementById('chat-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      // attach login button
      const btn = document.getElementById('login-btn');
      if (btn && !btn._bound) { btn.addEventListener('click', ()=> firebase.auth().signInWithPopup(provider).catch(err=>alert('Login-Fehler: '+err.message))); btn._bound = true; }
    }
  });
</script>


<script>
/* Final release script: Google login + full hut submission chat flow */

// Globals
let currentUser = null;
let editingData = {};
let step = null;

// DOM refs
const chatWindow = () => document.getElementById('chat-window');
const inputField = () => document.getElementById('chat-input');

// small helper: add chat bubble
function addMessage(htmlContent, who='bot') {
  const wrapper = document.createElement('div');
  wrapper.className = who === 'bot' ? 'message bot bg-gray-100 p-3 rounded shadow' : 'message user bg-green-50 p-3 rounded self-end';
  wrapper.innerHTML = htmlContent;
  chatWindow().appendChild(wrapper);
  chatWindow().scrollTop = chatWindow().scrollHeight;
  return wrapper;
}

// escape html
function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

// Firestore helpers (db will be set after firebase init)
async function saveDraft(id, partial = {}) { if (!id) return; try { await db.collection('eierhuetten').doc(id).set({ ...partial, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); } catch(e){} }

// Geocode with Nominatim
async function geocodeAddress(address) { try { const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=${encodeURIComponent(address)}`; const res = await fetch(url, { headers: { 'User-Agent': 'EierhuettenApp/1.0' } }); const data = await res.json(); if (!data || !data.length) return null; return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), display_name: data[0].display_name }; } catch(e) { return null; } }

// Haversine (meters)
function haversineDistance(lat1, lon1, lat2, lon2) { const R=6371e3, toRad=x=>x*Math.PI/180; const œÜ1=toRad(lat1), œÜ2=toRad(lat2); const ŒîœÜ=toRad(lat2-lat1), ŒîŒª=toRad(lon2-lon1); const a=Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2; const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c; }

// Duplicate check (20m)
async function locationExistsNearby(lat,lng,radius=20) { const delta=0.00018; const minLat=lat-delta, maxLat=lat+delta; try { const snap = await db.collection('eierhuetten').where('location.latitude','>=',minLat).where('location.latitude','<=',maxLat).get(); if (snap.empty) return false; for (const doc of snap.docs) { const d = doc.data(); if (!d.location || d.status === 'archiviert') continue; const dist = haversineDistance(lat,lng,d.location.latitude,d.location.longitude); if (dist <= radius) return true; } return false; } catch(e) { return false; } }

// Show confirmation map as bot bubble
function showLocationConfirmation(lat,lng,label) { addMessage(`üìç Gefundene Adresse: <strong>${escapeHtml(label)}</strong>`, 'bot'); const mapId='confirm-map-'+Date.now(); const mapBubble=document.createElement('div'); mapBubble.className='message bot'; mapBubble.innerHTML=`<div id="${mapId}" style="height:320px;border:1px solid #ddd;border-radius:6px;margin-top:6px;"></div>`; chatWindow().appendChild(mapBubble); const btnBubble=document.createElement('div'); btnBubble.className='message bot'; btnBubble.innerHTML=`<button class="choice-btn" id="confirm-yes">‚úÖ Ja, passt</button> <button class="choice-btn" id="confirm-retry">üîÑ Neu w√§hlen</button>`; chatWindow().appendChild(btnBubble); chatWindow().scrollTop = chatWindow().scrollHeight; setTimeout(()=>{ try { const map = L.map(mapId).setView([lat,lng],16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); const marker = L.marker([lat,lng],{draggable:true}).addTo(map); marker.on('dragend', e=>{ const pos=e.target.getLatLng(); editingData.location = new firebase.firestore.GeoPoint(pos.lat,pos.lng); }); editingData.location = new firebase.firestore.GeoPoint(lat,lng); } catch(e) { addMessage('‚ö†Ô∏è Karte konnte nicht geladen werden.','bot'); } },200); setTimeout(()=>{ const yes=document.getElementById('confirm-yes'); const retry=document.getElementById('confirm-retry'); if (yes) yes.onclick=async ()=>{ addMessage('‚úÖ Standort gespeichert.','bot'); addMessage('‚è≥ Dein Vorschlag wird nun vom Team gepr√ºft und nach Freigabe sichtbar.','bot'); await submitNewHut(); }; if (retry) retry.onclick=()=>{ addMessage('üîÑ Bitte gib eine neue Adresse ein:','bot'); step='address_input'; }; },300); }

// Tag suggestions under input (uses tag_counts collection)
async function showTagSuggestions(query) { if (!query || query.length < 1) return; try { const snap = await db.collection('tag_counts').orderBy('count','desc').limit(20).get(); const tags = snap.docs.map(d=>({ tag:d.id, count:d.data().count||0 })).filter(t=>t.tag.startsWith(query.toLowerCase())); if (!tags.length) return; const container = document.createElement('div'); container.className='message bot'; tags.slice(0,8).forEach(t=>{ const btn=document.createElement('button'); btn.className='choice-btn'; btn.textContent=`${t.tag} (${t.count})`; btn.onclick=()=>{ if (inputField()) inputField().value = t.tag; container.remove(); if (inputField()) inputField().focus(); }; container.appendChild(btn); }); chatWindow().appendChild(container); chatWindow().scrollTop = chatWindow().scrollHeight; } catch(e) {} }

// increment tag counts (cloud function preferred)
async function incrementTagCounts(tags) { if (!Array.isArray(tags) || !tags.length) return; try { if (firebase.functions) { try { const fn = firebase.app().functions('us-central1').httpsCallable('incrementTagCounts'); await fn({ tags }); return; } catch(e){} } const batch = db.batch(); tags.forEach(tag=>{ const id = tag.toLowerCase().trim(); if (!id) return; batch.set(db.collection('tag_counts').doc(id), { count: firebase.firestore.FieldValue.increment(1) }, { merge: true }); }); await batch.commit(); } catch(e) {} }

// submitNewHut - create id at submit, check duplicate, write, increment tags
async function submitNewHut() { if (!editingData) editingData = {}; if (!editingData.id) editingData.id = db.collection('eierhuetten').doc().id; if (!editingData.location) { addMessage('‚ö†Ô∏è Es wurde noch kein Standort gespeichert. Bitte Adresse eingeben oder GPS w√§hlen.','bot'); return; } const lat = editingData.location.latitude, lng = editingData.location.longitude; if (await locationExistsNearby(lat,lng,20)) { addMessage('‚ö†Ô∏è An der ausgew√§hlten Stelle existiert bereits eine H√ºtte.','bot'); return; } try { const docRef = db.collection('eierhuetten').doc(editingData.id); const final = { ...editingData, fotos: (editingData.fotos||[]).filter(f=>f&&f.url), userId: currentUser? currentUser.uid : null, status: 'offen', erstelltAm: editingData.createdAt || firebase.firestore.FieldValue.serverTimestamp() }; await docRef.set(final, { merge: true }); if (final.tags && final.tags.length) await incrementTagCounts(final.tags); addMessage('‚úÖ Vielen Dank ‚Äî deine H√ºtte wurde eingereicht!','bot'); addMessage('üîé Wir pr√ºfen deinen Vorschlag nun. Du kannst deine Eintr√§ge unter ‚ÄûMeine H√ºtten‚Äú sehen, sobald sie freigegeben sind.','bot'); const btn = document.createElement('div'); btn.className='message bot'; btn.innerHTML = `<button class="choice-btn" onclick="showMyHuts()">‚û°Ô∏è Meine H√ºtten anzeigen</button>`; chatWindow().appendChild(btn); step = null; editingData = {}; } catch(e) { addMessage('‚ùå Fehler beim Abschicken: ' + (e.message||e), 'bot'); } }

// handle address input -> geocode and show confirmation
async function handleAddressInput(txt) { const coords = await geocodeAddress(txt.trim()); if (!coords) { addMessage('‚ùå Adresse konnte nicht gefunden werden. Bitte erneut eingeben.','bot'); return; } editingData.address = coords.display_name; editingData.location = new firebase.firestore.GeoPoint(coords.lat, coords.lng); showLocationConfirmation(coords.lat, coords.lng, editingData.address); }

// handle GPS location
function handleGPSLocation(lat,lng) { editingData.location = new firebase.firestore.GeoPoint(lat,lng); showLocationConfirmation(lat,lng,'GPS-Standort'); }

// askForAnimals (buttons)
function askForAnimals() { addMessage('üêæ Welche Tiere gibt es an der H√ºtte? (Mehrfachauswahl m√∂glich)','bot'); const tiere=['üêê Ziege','üêÑ Kuh','üêì Huhn','üêï Hund','üêá Hase','‚ùå Keine']; editingData.tiere = editingData.tiere || []; const container=document.createElement('div'); container.className='message bot'; tiere.forEach(tier=>{ const btn=document.createElement('button'); btn.className='choice-btn'; btn.textContent = tier; btn.onclick = ()=>{ if (tier === '‚ùå Keine') { editingData.tiere = []; addMessage('‚ùå Keine Tiere ausgew√§hlt','bot'); } else { if (!editingData.tiere.includes(tier)) editingData.tiere.push(tier); addMessage('‚úÖ Aktuell gew√§hlt: ' + editingData.tiere.join(', '),'bot'); } }; container.appendChild(btn); }); const weiter=document.createElement('button'); weiter.className='choice-btn mt-2'; weiter.textContent='‚û°Ô∏è Weiter'; weiter.onclick=async ()=>{ await saveDraft(editingData.id,{ tiere: editingData.tiere }); step='beschreibung_input'; addMessage('üìù Bitte gib eine kurze Beschreibung deiner H√ºtte ein:','bot'); }; container.appendChild(weiter); chatWindow().appendChild(container); chatWindow().scrollTop = chatWindow().scrollHeight; }

// showMyHuts - render user's huts as a single bot bubble block
async function showMyHuts() { chatWindow().innerHTML = ''; const snap = await db.collection('eierhuetten').where('userId','==', currentUser.uid).get(); if (snap.empty) { addMessage('Du hast noch keine H√ºtten.','bot'); return; } const wrapper=document.createElement('div'); wrapper.className='message bot'; wrapper.style.padding='12px'; wrapper.style.borderRadius='8px'; wrapper.style.background='#f7f7f9'; wrapper.innerHTML = '<strong>Meine H√ºtten</strong><div id="hut-list" style="margin-top:8px;"></div>'; chatWindow().appendChild(wrapper); const list = wrapper.querySelector('#hut-list'); snap.docs.forEach(doc=>{ const d = doc.data(); const id = doc.id; const item=document.createElement('div'); item.style.borderTop='1px solid #e5e7eb'; item.style.padding='8px 0'; item.innerHTML = `<div style="font-weight:600">üè° ${escapeHtml(d.name||'(ohne Namen)')}</div><div>üìå Status: ${escapeHtml(d.status||'offen')}</div>`; const actions=document.createElement('div'); actions.style.marginTop='6px'; const editBtn=document.createElement('button'); editBtn.className='choice-btn'; editBtn.textContent='‚úèÔ∏è Bearbeiten'; editBtn.onclick=()=>{ alert('Bearbeiten noch nicht implementiert'); }; const delBtn=document.createElement('button'); delBtn.className='choice-btn'; delBtn.textContent='üóëÔ∏è L√∂schen'; delBtn.onclick=async ()=>{ if (!confirm('H√ºtte l√∂schen?')) return; await db.collection('eierhuetten').doc(id).delete(); addMessage('üóëÔ∏è H√ºtte gel√∂scht.','bot'); showMyHuts(); }; actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions); if (d.status==='angenommen') { const chatArea=document.createElement('div'); chatArea.id='chat-messages-'+id; chatArea.style.marginTop='6px'; chatArea.innerText='Lade Nachrichten...'; item.appendChild(chatArea); try { await ladeHutNachrichtenListe(id); } catch(e) { chatArea.innerHTML='<em>Fehler beim Laden</em>'; } } else { const info=document.createElement('div'); info.style.fontStyle='italic'; info.textContent='üí¨ Nachrichten erst nach Freigabe'; item.appendChild(info); } list.appendChild(item); }); chatWindow().scrollTop = chatWindow().scrollHeight; }

// Hook input field for tag suggestions when in tags_input step
document.addEventListener('input', function(e) { if (e.target && e.target.id === 'chat-input') { if (step === 'tags_input') { const q = e.target.value.trim().toLowerCase(); if (q.length >= 2) showTagSuggestions(q); } } });

// Basic chat flow controller: process user input depending on step
async function processUserInput(txt) {
  txt = (txt || '').trim();
  if (!txt) return;
  addMessage(escapeHtml(txt), 'user');

  // Vorschlags flow (example email/comment)
  if (step === 'suggest_email') { editingData.email = txt; addMessage('‚úÖ Danke! M√∂chtest du noch einen Kommentar hinzuf√ºgen?', 'bot'); step = 'suggest_comment'; return; }
  if (step === 'suggest_comment') { editingData.comment = txt; addMessage('üìç Bitte w√§hle den Standort deiner H√ºtte aus.', 'bot'); showLocationChoices(); step = 'suggest_location'; return; }

  // H√ºtten-Flow
  if (step === 1) { editingData.name = txt; editingData.id = editingData.id || db.collection('eierhuetten').doc().id; step = 2; addMessage('ü™ë Hat deine H√ºtte Sitzpl√§tze? (Ja / Nein)', 'bot'); return; }

  if (step === 2) { editingData.sitzplaetze = txt; step = 3; addMessage('üîå Gibt es Strom? (Ja / Nein)', 'bot'); return; }
  if (step === 3) { editingData.strom = txt; step = 4; addMessage('‚ú® Extras? (oder "keine")', 'bot'); return; }
  if (step === 4) { editingData.extras = txt; step = 5; askForAnimals(); return; }

  if (step === 'beschreibung_input') { editingData.beschreibung = txt; step = 'tags_input'; addMessage('üè∑Ô∏è Bitte f√ºge bis zu 5 Schlagw√∂rter hinzu (durch Komma getrennt).', 'bot'); return; }

  if (step === 'tags_input') { const tags = txt.split(',').map(t=>t.trim()).filter(t=>t.length>0); if (tags.length > 5) { addMessage('‚ö†Ô∏è Bitte max. 5 Tags angeben.', 'bot'); return; } editingData.tags = tags; step = 'zeiten_input'; addMessage('üïí Wie lauten die √ñffnungszeiten? ("Immer ge√∂ffnet" oder "Von ‚Äì Bis")', 'bot'); return; }

  if (step === 'zeiten_input') { editingData.oeffnungszeiten = txt; addMessage('üìç Bitte w√§hle nun den Standort: Gib eine Adresse ein oder schreibe "GPS" f√ºr aktuellen Standort.', 'bot'); step = 'address_input'; return; }

  // Address input step
  if (step === 'address_input') { if (txt.toLowerCase() === 'gps') { navigator.geolocation.getCurrentPosition(pos => { handleGPSLocation(pos.coords.latitude, pos.coords.longitude); }, err => { addMessage('‚ùå GPS nicht verf√ºgbar: ' + err.message, 'bot'); }); return; } else { await handleAddressInput(txt); return; } }

  // Fallback
  addMessage('Ich habe das nicht verstanden. Bitte antworte passend zur Frage.', 'bot');
}

// Start new hut flow
function startNewHutFlow() { editingData = {}; step = 1; addMessage('üìù Bitte gib den Namen deiner H√ºtte ein:', 'bot'); }

// show location choices
function showLocationChoices() { addMessage('üìç Standort w√§hlen: Adresse eingeben oder "GPS" f√ºr aktuellen Standort', 'bot'); step='address_input'; }

// wire send button and Enter key
document.addEventListener('DOMContentLoaded', function() { const sendBtn = document.getElementById('send-btn'); const input = document.getElementById('chat-input'); const myHutsBtn = document.getElementById('my-huts-btn'); if (sendBtn && input) { sendBtn.addEventListener('click', ()=>{ processUserInput(input.value); input.value=''; }); input.addEventListener('keydown', e=>{ if (e.key==='Enter') { processUserInput(input.value); input.value=''; } }); } if (myHutsBtn) myHutsBtn.addEventListener('click', ()=>{ showMyHuts(); }); });

// Expose functions for other UI pieces
window.startNewHutFlow = startNewHutFlow;
window.handleAddressInput = handleAddressInput;
window.handleGPSLocation = handleGPSLocation;
window.showMyHuts = showMyHuts;

// FIREBASE Initialization will attach db/auth before use (injected separately)
</script>

</body>
  </html>
