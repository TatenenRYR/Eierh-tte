<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten-Gruppen-Radtour üö¥</title>
  <!-- Styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; z-index:0; }
    #loadingOverlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:white; color:#10b981;
      font-size:1.5em; display:flex;
      align-items:center; justify-content:center;
      z-index:2000;
    }
    #controls {
      position: fixed; top:10px; left:10px;
      background: white; padding:10px; border-radius: 8px;
      box-shadow:0 3px 6px rgba(0,0,0,0.15); z-index:1001;
    }
    #controls button { display:block; margin:6px 0; width:160px; }
    #menuBtn, #styleToggleBtn, #followBtn, #groupTrackingToggle {
      position:fixed; z-index:1001;
    }
    #menuBtn { top:10px; right:140px; background:#10b981; }
    #styleToggleBtn { top:10px; right:10px; background:#6366f1; }
    #followBtn { top:60px; right:10px; background:#3b82f6; display:none; }
    #groupTrackingToggle {
      top:60px; left:10px;
      background:white; padding:8px 12px; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      user-select:none; font-size:14px;
    }
    #menuPanel {
      position:fixed; top:110px; right:10px;
      background:white; padding:12px; border-radius:8px;
      box-shadow:0 3px 6px rgba(0,0,0,0.15);
      max-width:260px; display:none; z-index:1002;
    }
    #routeInfo {
      position:fixed; bottom:10px; left:50%;
      transform: translateX(-50%);
      background:white; padding:10px; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      z-index:1001; font-size:14px;
    }
    .toast {
      position:fixed; bottom:80px; left:50%;
      transform: translateX(-50%);
      background:#10b981; color:white;
      padding:8px 16px; border-radius:8px;
      font-size:14px; display:none; z-index:1003;
    }
  </style>
  <!-- Firebase & Leaflet -->
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
</head>
<body>
  <!-- Ladeanzeige -->
  <div id="loadingOverlay">‚è≥ Karte l√§dt...</div>

  <!-- Steuerpanel + Auth -->
  <div id="controls">
    <button id="loginBtn" style="background:#10b981">üîê Google Anmelden</button>
    <button id="logoutBtn" style="background:#ef4444; display:none">üö™ Abmelden</button>
    <span id="userInfo" style="display:block; margin-top:8px;">Nicht angemeldet</span>
  </div>

  <!-- Map-UI -->
  <button id="menuBtn">‚ò∞ Men√º</button>
  <button id="styleToggleBtn">üåì Stil</button>
  <button id="followBtn">üìç Folgen</button>
  <label id="groupTrackingToggle" style="display:none">
    <input type="checkbox" id="groupTrackCheckbox" /> Gruppen live
  </label>
  <div id="menuPanel">
    <h4>üö¥ Gruppen-Route</h4>
    <ul id="selectedList"></ul>
    <label><input type="radio" name="routeMode" value="normal" checked> Normale</label><br>
    <label><input type="radio" name="routeMode" value="optimized"> Optimiert</label><br><br>
    <button onclick="recalculateRoute()">üîÑ Route neu</button>
    <button onclick="resetSelection()">üóë Zur√ºcksetzen</button>
  </div>
  <div id="routeInfo"></div>
  <div class="toast" id="toast"></div>
  <div id="map"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithRedirect, signOut, onAuthStateChanged, getRedirectResult
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, deleteDoc, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // UI-Elemente
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    const styleToggleBtn = document.getElementById('styleToggleBtn');
    const followBtn = document.getElementById('followBtn');
    const groupToggle = document.getElementById('groupTrackingToggle');
    const groupCheckbox = document.getElementById('groupTrackCheckbox');
    const selectedList = document.getElementById('selectedList');
    const routeInfo = document.getElementById('routeInfo');
    const toast = document.getElementById('toast');

    let map, lightLayer, darkLayer;
    let bikeMarker, userId, groupTracking = false, groupUnsub = null;
    const groupMarkers = {};
    const huts = [], hutMarkers = {}, selectedHuts = [];
    let routingControl;

    // Auth Handling
    loginBtn.onclick = () => signInWithRedirect(auth, provider);
    logoutBtn.onclick = () => {
      signOut(auth);
      if (userId) deleteDoc(doc(db,'group_positions',userId));
      location.reload();
    };

    getRedirectResult(auth).catch(console.error);
    onAuthStateChanged(auth, user => {
      document.getElementById('loadingOverlay').style.display = 'none';
      if (user) {
        loginBtn.style.display='none';
        logoutBtn.style.display='block';
        userInfo.innerText = `Hi, ${user.displayName}`;
        userId = user.uid;
        showCoreUI();
        initMap();
        locateUser();
        loadHuts();
        setupGroupTrackingToggle();
      } else {
        loginBtn.style.display='block';
        logoutBtn.style.display='none';
        userInfo.innerText = 'Nicht angemeldet';
        hideCoreUI();
      }
    });

    function showCoreUI() {
      [menuBtn, styleToggleBtn].forEach(el => el.style.display='block');
      groupToggle.style.display = 'block';
    }
    function hideCoreUI() {
      [menuBtn, styleToggleBtn, followBtn, groupToggle].forEach(el => el.style.display='none');
      map?.remove();
    }

    // Map + styles
    function initMap() {
      map = L.map('map').setView([51.5,10.5],6);
      lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'});
      darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬© OSM'});
      lightLayer.addTo(map);
    }
    styleToggleBtn.onclick = () => {
      map.hasLayer(lightLayer) ? (map.removeLayer(lightLayer), darkLayer.addTo(map)) :
      (map.removeLayer(darkLayer), lightLayer.addTo(map));
    };

    // User location + group updates
    function locateUser() {
      navigator.geolocation.watchPosition(pos => {
        const ll = [pos.coords.latitude,pos.coords.longitude];
        if (!bikeMarker) {
          bikeMarker = L.marker(ll,{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[36,36],iconAnchor:[18,18]})}).addTo(map);
          followBtn.style.display = 'none';
          map.setView(ll,15);
        } else {
          bikeMarker.setLatLng(ll);
        }
        if (groupTracking) {
          setDoc(doc(db,'group_positions',userId),{lat:ll[0],lng:ll[1],timestamp:serverTimestamp(),name:auth.currentUser.displayName});
        }
      },err=>showToast('GPS nicht verf√ºgbar'));
      map.on('movestart',()=>{
        followBtn.style.display = bikeMarker && map.getCenter().distanceTo(bikeMarker.getLatLng())>50 ? 'block':'none';
      });
      followBtn.onclick = ()=>{
        followBtn.style.display='none';
        map.setView(bikeMarker.getLatLng(),15);
      };
    }

    // Group-tracking toggle
    function setupGroupTrackingToggle() {
      groupCheckbox.onchange = () => {
        groupTracking = groupCheckbox.checked;
        if (groupTracking) startGroupTracking();
        else stopGroupTracking();
      };
    }
    function startGroupTracking() {
      groupUnsub = onSnapshot(collection(db,'group_positions'),snap=>{
        snap.docChanges().forEach(c=>{
          const id = c.doc.id, d = c.doc.data();
          if (id===userId) return;
          if ((c.type==='added'||c.type==='modified') && d.lat&&d.lng) {
            groupMarkers[id]?.setLatLng([d.lat,d.lng]) ||
              (groupMarkers[id]=L.marker([d.lat,d.lng],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/1946/1946429.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map).bindPopup(d.name));
          } else if (c.type==='removed') {
            groupMarkers[id] && map.removeLayer(groupMarkers[id]) && delete groupMarkers[id];
          }
        });
      });
      showToast('Gruppen-Tracking an');
    }
    function stopGroupTracking() {
      groupUnsub?.();
      deleteDoc(doc(db,'group_positions',userId));
      Object.values(groupMarkers).forEach(m=>map.removeLayer(m));
      showToast('Gruppen-Tracking aus');
    }

    // Huts & route
    function loadHuts() {
      onSnapshot(collection(db,'eierhuetten'),snap=>{
        selectedHuts.length=0;
        Object.values(hutMarkers).forEach(m=>map.removeLayer(m));
        snap.forEach(doc=>{
          const d=doc.data(), id=doc.id;
          if (d.location?.latitude) {
            const m=L.marker([d.location.latitude,d.location.longitude],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map);
            m.bindPopup(`<strong>${d.name||'Unbenannt'}</strong><br>üîå Strom: ${d.strom?'Ja':'Nein'}<br><button onclick="toggleSel('${id}')">${selectedHuts.includes(id)?'‚ùå Entfernen':'‚úÖ Zur Route'}</button>`);
            hutMarkers[id]=m;
            huts.findIndex(h=>h.id===id)<0 && huts.push({id,d});
          }
        });
        updateList();
      });
    }
    window.toggleSel= id => {
      const pt = huts.find(h=>h.id===id);
      if (!pt) return;
      const idx = selectedHuts.indexOf(id);
      if (idx<0) selectedHuts.push(id), hutMarkers[id].setIcon(L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',iconSize:[38,38],iconAnchor:[19,38]}));
      else selectedHuts.splice(idx,1), hutMarkers[id].setIcon(L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',iconSize:[32,32],iconAnchor:[16,32]}));
      updateList();
      recalculateRoute();
      showToast(idx<0?'H√ºtte hinzugef√ºgt':'H√ºtte entfernt');
    };
    function updateList(){
      selectedList.innerHTML='';
      selectedHuts.forEach(id=>{
        const h=huts.find(o=>o.id===id);
        if (h) {
          const li=document.createElement('li');
          li.textContent = h.d.name;
          selectedList.appendChild(li);
        }
      });
    }
    function recalculateRoute(){
      if (!bikeMarker||!selectedHuts.length) return;
      const pts=[bikeMarker.getLatLng()];
      const mode=document.querySelector('input[name="routeMode"]:checked').value;
      const arr=mode==='optimized'? [...selectedHuts].sort(): selectedHuts;
      arr.forEach(id=>{
        const h=huts.find(o=>o.id===id);
        if (h) pts.push([h.d.location.latitude,h.d.location.longitude]);
      });
      routingControl && routingControl.remove();
      routingControl = L.Routing.control({waypoints:pts, createMarker:()=>null, show:false, lineOptions:{styles:[{color:mode==='optimized'?'orange':'#10b981',weight:5}]}}).addTo(map);
      routingControl.on('routesfound',e=>{
        const r=e.routes[0];
        routeInfo.innerText = `üö¥ ${(r.summary.totalDistance/1000).toFixed(1)}¬†km ¬∑ ‚è± ${Math.round(r.summary.totalTime/60)}¬†min`;
      });
    }
    function resetSelection(){
      selectedHuts.splice(0);
      Object.values(hutMarkers).forEach(m=>m.setIcon(L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/616/616408.png',iconSize:[32,32],iconAnchor:[16,32]})));
      routingControl && routingControl.remove();
      routeInfo.innerText='';
      updateList();
      showToast('Route zur√ºckgesetzt');
    }
    menuBtn.onclick = ()=>menuPanel.style.display = menuPanel.style.display==='block'?'none':'block';

    // Toast
    function showToast(msg){
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none',3000);
    }
  </script>
</body>
</html>
