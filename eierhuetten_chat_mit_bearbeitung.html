<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EierhÃ¼tten Assistent Chat - Mit Bearbeitung</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 600px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    .hidden { display: none; }
    .minimap, #map, #edit-map { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .edit-input, select { display: block; width: 100%; padding: 0.4rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 0.4rem; }
    .edit-form { background: #fefefe; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
    .edit-buttons { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem; }
  </style>
</head>
<body class="p-6">
  <!-- Login -->
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>
  <!-- Chat -->
  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">
      ðŸ¥š EierhÃ¼tten Assistent Chat
    </div>
    <div id="chat-window" aria-live="polite" role="log"></div>
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off"
             class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

  let currentUser = null, step = 0, formData = {};

  const chatWindow = document.getElementById('chat-window'),
        chatInput  = document.getElementById('chat-input'),
        sendBtn    = document.getElementById('send-btn');

  function addMessage(text, sender='bot') {
    const d = document.createElement('div');
    d.className = `message ${sender}`;
    d.textContent = text;
    chatWindow.appendChild(d);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addChoices(opts, cb) {
    const c = document.createElement('div');
    c.className = 'message bot';
    opts.forEach(o => {
      const b = document.createElement('button');
      b.className = 'choice-btn';
      b.textContent = o;
      b.onclick = () => { addMessage(o,'user'); c.remove(); cb(o.toLowerCase()); };
      c.appendChild(b);
    });
    chatWindow.appendChild(c);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function startDialog() {
    chatWindow.innerHTML = '';
    addMessage('Hallo ðŸ‘‹ Ich bin dein Assistent fÃ¼r EierhÃ¼tten. Wie kann ich dir helfen?');
    addChoices(['Neue HÃ¼tte erstellen','Meine HÃ¼tten anzeigen'], handleIntent);
    step = 0; formData = {};
  }

  function handleIntent(input) {
    if (input.includes('erstellen')) {
      step = 1; addMessage('Wie soll deine HÃ¼tte heiÃŸen?');
    } else if (input.includes('meine')) {
      showMyHuts();
    } else {
      startDialog();
    }
  }

  function processInput(txt) {
    if (step===1) {
      formData.name=txt; step=2;
      addMessage('Hat deine HÃ¼tte SitzplÃ¤tze?');
      addChoices(['Ja','Nein'], r=>{
        formData.sitz=r; step=3;
        addMessage('Gibt es Strom?');
        addChoices(['Ja','Nein'], s=>{
          formData.strom=s; step=4;
          addMessage('Extras? (oder â€žweiterâ€œ fÃ¼r keine)');
        });
      });
    }
    else if(step===4) {
      formData.extras=txt==='weiter'?'':txt; step=5;
      addMessage('WÃ¤hle Ã–ffnungszeiten:');
      addChoices(['08:00â€“20:00','24/7'], o=>{
        formData.open=o; step=6; showMap();
      });
    }
    else startDialog();
  }

  function showMap() {
    addMessage('Klicke auf die Karte, um den Standort zu wÃ¤hlen.');
    const mdiv = document.createElement('div'); mdiv.id='map'; chatWindow.appendChild(mdiv);
    const map = L.map('map').setView([51.2,10.5],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let mk;
    map.on('click', e=>{
      if(mk) mk.setLatLng(e.latlng);
      else mk = L.marker(e.latlng,{ draggable:true }).addTo(map);
      formData.loc=e.latlng;
      addMessage(`Standort gespeichert: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`);
      addChoices(['Einreichen','Abbrechen'], ans=>{
        if(ans.includes('einreichen')) submitHut();
        else startDialog();
      });
    });
  }

  async function submitHut(){
    if(!formData.name||!formData.loc){ addMessage('Bitte alle Daten eingeben.'); return; }
    const doc = {
      name: formData.name,
      sitzplaetze: formData.sitz,
      strom: formData.strom,
      extras: formData.extras,
      oeffnungszeiten: formData.open,
      location: new firebase.firestore.GeoPoint(formData.loc.lat, formData.loc.lng),
      userId: currentUser.uid,
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'offen',
      fotos: []
    };
    await db.collection('eierhuetten').add(doc);
    addMessage('ðŸŽ‰ Deine HÃ¼tte wurde eingereicht!');
    startDialog();
  }

  async function showMyHuts(){
    chatWindow.innerHTML='';
    const snap = await db.collection('eierhuetten')
      .where('userId','==',currentUser.uid)
      .orderBy('erstelltAm','desc').get();
    if(snap.empty){ addMessage('Keine HÃ¼tten gefunden.'); return; }
    snap.forEach(doc=>{
      const d=doc.data(), id=doc.id;
      // Karteikarte:
      const card = document.createElement('div');
      card.className='message bot p-4 bg-blue-50 rounded space-y-2';
      card.innerHTML=`
        <div><strong>${d.name}</strong> (${d.status})</div>
        <div>SitzplÃ¤tze: ${d.sitzplaetze}</div>
        <div>Strom: ${d.strom}</div>
        <div>Extras: ${d.extras||'â€“'}</div>
        <div>Ã–ffnungszeiten: ${d.oeffnungszeiten}</div>
        <div class="minimap" id="mini-${id}"></div>
        <div class="flex gap-2">
          <button onclick="editHut('${id}')" class="bg-yellow-300 px-2 py-1 rounded">Bearbeiten</button>
          <button onclick="deleteHut('${id}','${d.name}')" class="bg-red-300 px-2 py-1 rounded">LÃ¶schen</button>
        </div>
      `;
      chatWindow.appendChild(card);
      // Mini-Karte
      if(d.location){
        const mv=L.map(`mini-${id}`,{zoomControl:false,dragging:false}).setView([d.location.latitude,d.location.longitude],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mv);
        L.marker([d.location.latitude,d.location.longitude]).addTo(mv);
        setTimeout(()=>mv.invalidateSize(),200);
      }
    });
  }

  // Bearbeiten-Funktion mit Formular im Chat:
  let currentEditMap = null;
  async function editHut(id){
    chatWindow.innerHTML=''; // clear chat window for edit form
    const doc = await db.collection('eierhuetten').doc(id).get();
    if(!doc.exists){ addMessage('HÃ¼tte nicht gefunden.'); return; }
    const d = doc.data();

    // Formular als HTML-String:
    const formHTML = `
      <div class="edit-form">
        <label><strong>Name:</strong><input type="text" id="edit-name" class="edit-input" value="${d.name||''}"/></label>
        <label><strong>SitzplÃ¤tze:</strong>
          <select id="edit-sitz" class="edit-input">
            <option value="ja" ${d.sitzplaetze==='ja'?'selected':''}>Ja</option>
            <option value="nein" ${d.sitzplaetze==='nein'?'selected':''}>Nein</option>
          </select>
        </label>
        <label><strong>Strom:</strong>
          <select id="edit-strom" class="edit-input">
            <option value="ja" ${d.strom==='ja'?'selected':''}>Ja</option>
            <option value="nein" ${d.strom==='nein'?'selected':''}>Nein</option>
          </select>
        </label>
        <label><strong>Extras:</strong><input type="text" id="edit-extras" class="edit-input" value="${d.extras||''}"/></label>
        <label><strong>Ã–ffnungszeiten:</strong>
          <select id="edit-open" class="edit-input">
            <option value="08:00â€“20:00" ${d.oeffnungszeiten==='08:00â€“20:00'?'selected':''}>08:00â€“20:00</option>
            <option value="24/7" ${d.oeffnungszeiten==='24/7'?'selected':''}>24/7</option>
          </select>
        </label>
        <label><strong>Standort:</strong>
          <div id="edit-map"></div>
        </label>
        <div class="edit-buttons">
          <button id="cancel-edit" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Abbrechen</button>
          <button id="save-edit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
        </div>
      </div>
    `;
    const div = document.createElement('div');
    div.className = 'message bot';
    div.innerHTML = formHTML;
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    // Leaflet Karte initialisieren
    if(currentEditMap){ currentEditMap.remove(); currentEditMap=null; }
    currentEditMap = L.map('edit-map').setView([d.location.latitude, d.location.longitude], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentEditMap);
    const marker = L.marker([d.location.latitude, d.location.longitude], {draggable:true}).addTo(currentEditMap);

    // Marker Position bei Drag aktualisieren
    marker.on('dragend', e => {
      const pos = e.target.getLatLng();
      formData.loc = pos;
    });
    formData.loc = {lat: d.location.latitude, lng: d.location.longitude};

    // Button Events
    document.getElementById('cancel-edit').onclick = () => {
      chatWindow.innerHTML = '';
      startDialog();
    };
    document.getElementById('save-edit').onclick = async () => {
      const updated = {
        name: document.getElementById('edit-name').value.trim(),
        sitzplaetze: document.getElementById('edit-sitz').value,
        strom: document.getElementById('edit-strom').value,
        extras: document.getElementById('edit-extras').value.trim(),
        oeffnungszeiten: document.getElementById('edit-open').value,
      };
      if(formData.loc){
        updated.location = new firebase.firestore.GeoPoint(formData.loc.lat, formData.loc.lng);
      }
      try {
        await db.collection('eierhuetten').doc(id).update(updated);
        addMessage('âœ… HÃ¼tte wurde gespeichert.');
        showMyHuts();
      } catch(e) {
