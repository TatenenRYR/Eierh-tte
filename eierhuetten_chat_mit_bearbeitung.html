<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten Assistent Chat - Vollst√§ndig</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    .hidden { display: none; }
    .minimap, #map { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .edit-input, select { display: block; width: 100%; padding: 0.4rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 0.4rem; }
    .log-entry { font-size: 0.8rem; color: #555; margin-top: 0.2rem; padding-left: 1rem; }
    .foto-thumb { position: relative; display: inline-block; margin-right: 8px; margin-bottom: 8px; }
    .foto-thumb img { width: 80px; height: 80px; object-fit: cover; border-radius: 0.25rem; border: 1px solid #ccc; }
    .foto-thumb button { position: absolute; top: 0; right: 0; background: #dc2626; color: white; border: none; border-radius: 0 0.25rem 0.25rem 0; cursor: pointer; padding: 2px 5px; font-size: 12px; }
  </style>
</head>
<body class="p-6">
  <!-- Login -->
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>
  <!-- Chat -->
  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">
      ü•ö Eierh√ºtten Assistent Chat
    </div>
    <div id="chat-window" aria-live="polite" role="log"></div>
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off"
             class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>

  <script>
    // Firebase initialisieren
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

    let currentUser = null, step = 0, formData = {};

    const chatWindow = document.getElementById('chat-window'),
          chatInput  = document.getElementById('chat-input'),
          sendBtn    = document.getElementById('send-btn');

    function addMessage(text, sender='bot') {
      const d = document.createElement('div');
      d.className = `message ${sender}`;
      d.textContent = text;
      chatWindow.appendChild(d);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    function addChoices(opts, cb) {
      const c = document.createElement('div');
      c.className = 'message bot';
      opts.forEach(o => {
        const b = document.createElement('button');
        b.className = 'choice-btn';
        b.textContent = o;
        b.onclick = () => { addMessage(o,'user'); c.remove(); cb(o.toLowerCase()); };
        c.appendChild(b);
      });
      chatWindow.appendChild(c);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function startDialog() {
      chatWindow.innerHTML = '';
      addMessage('Hallo üëã Ich bin dein Assistent f√ºr Eierh√ºtten. Wie kann ich dir helfen?');
      addChoices(['Neue H√ºtte erstellen','Meine H√ºtten anzeigen'], handleIntent);
      step = 0; formData = {};
    }

    function handleIntent(input) {
      if (input.includes('erstellen')) {
        step = 1; addMessage('Wie soll deine H√ºtte hei√üen?');
      } else if (input.includes('meine')) {
        showMyHuts();
      } else {
        startDialog();
      }
    }

    function processInput(txt) {
      if (step===1) {
        formData.name=txt; step=2;
        addMessage('Hat deine H√ºtte Sitzpl√§tze?');
        addChoices(['Ja','Nein'], r=>{ formData.sitz=r; step=3; addMessage('Gibt es Strom?'); addChoices(['Ja','Nein'], s=>{ formData.strom=s; step=4; addMessage('Extras? (oder ‚Äûweiter‚Äú f√ºr keine)'); }); });
      }
      else if(step===4) {
        formData.extras=txt==='weiter'?'':txt; step=5;
        addMessage('W√§hle √ñffnungszeiten:');
        addChoices(['08:00‚Äì20:00','24/7'], o=>{ formData.open=o; step=6; showMap(); });
      }
      else startDialog();
    }

    function showMap() {
      addMessage('Klicke auf die Karte, um den Standort zu w√§hlen.');
      const mdiv = document.createElement('div'); mdiv.id='map'; chatWindow.appendChild(mdiv);
      const map = L.map('map').setView([51.2,10.5],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      let mk;
      map.on('click', e=>{
        if(mk) mk.setLatLng(e.latlng);
        else mk = L.marker(e.latlng,{ draggable:true }).addTo(map);
        formData.loc=e.latlng;
        addMessage(`Standort gespeichert: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`);
        addChoices(['Einreichen','Abbrechen'], ans=>{
          if(ans.includes('einreichen')) submitHut();
          else startDialog();
        });
      });
    }

    async function submitHut(){
      if(!formData.name||!formData.loc){ addMessage('Bitte alle Daten eingeben.'); return; }
      const doc = {
        name: formData.name,
        sitzplaetze: formData.sitz,
        strom: formData.strom,
        extras: formData.extras,
        oeffnungszeiten: formData.open,
        location: new firebase.firestore.GeoPoint(formData.loc.lat, formData.loc.lng),
        userId: currentUser.uid,
        erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'offen',
        fotos: []
      };
      await db.collection('eierhuetten').add(doc);
      addMessage('üéâ Deine H√ºtte wurde eingereicht!');
      startDialog();
    }

    async function showMyHuts(){
      chatWindow.innerHTML='';
      const snap = await db.collection('eierhuetten')
        .where('userId','==',currentUser.uid)
        .orderBy('erstelltAm','desc').get();
      if(snap.empty){ addMessage('Keine H√ºtten gefunden.'); return; }
      snap.forEach(doc=>{
        const d=doc.data(), id=doc.id;
        // Karteikarte:
        const card = document.createElement('div');
        card.className='message bot p-4 bg-blue-50 rounded space-y-2';
        card.innerHTML=`
          <div><strong>${d.name}</strong> (${d.status})</div>
          <div>Sitzpl√§tze: ${d.sitzplaetze}</div>
          <div>Strom: ${d.strom}</div>
          <div>Extras: ${d.extras||'‚Äì'}</div>
          <div>√ñffnungszeiten: ${d.oeffnungszeiten}</div>
          <div class="minimap" id="mini-${id}"></div>
          <div class="flex gap-2">
            <button onclick="editHut('${id}')" class="bg-yellow-300 px-2 py-1 rounded">Bearbeiten</button>
            <button onclick="deleteHut('${id}','${d.name}')" class="bg-red-300 px-2 py-1 rounded">L√∂schen</button>
          </div>
        `;
        chatWindow.appendChild(card);
        // Mini-Karte
        if(d.location){
          const mv=L.map(`mini-${id}`,{zoomControl:false,dragging:false}).setView([d.location.latitude,d.location.longitude],13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mv);
          L.marker([d.location.latitude,d.location.longitude]).addTo(mv);
          setTimeout(()=>mv.invalidateSize(),200);
        }
      });
    }

    function editHut(id){
      // ... hier k√∂nntest du analog Formular zur Bearbeitung einf√ºgen ...
      addMessage('Bearbeiten-Funktion noch nicht implementiert.');
    }

    function deleteHut(id,name){
      // Mathe-Frage
      const a=Math.floor(Math.random()*10)+1, b=Math.floor(Math.random()*10)+1;
      const ans=prompt(`Sicherheit: ${a} + ${b} = ?`);
      if(parseInt(ans)!==(a+b)){ alert('Falsche Antwort'); return; }
      if(!confirm(`H√ºtte "${name}" wirklich l√∂schen?`)) return;
      db.collection('eierhuetten').doc(id).delete();
      addMessage(`H√ºtte "${name}" gel√∂scht.`);
      showMyHuts();
    }

    auth.onAuthStateChanged(user=>{
      if(user){
        currentUser=user;
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-section').classList.remove('hidden');
        startDialog();
      } else {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('main-section').classList.add('hidden');
      }
    });

    document.getElementById('google-login')
      .addEventListener('click',()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()));

    sendBtn.addEventListener('click',()=>{
      const v=chatInput.value.trim();
      if(v){ addMessage(v,'user'); chatInput.value=''; processInput(v); }
    });
    chatInput.addEventListener('keypress',e=>{ if(e.key==='Enter') sendBtn.click(); });
  </script>
</body>
</html>
