<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eierh√ºtten-Radtour</title>
  <link rel="preload" as="image" href="./bike-icon.png">
  <link rel="preload" as="image" href="./file_00000000de6c61f8ad4432078ea06ea3.png">
  <link rel="preload" as="image" href="./file_000000008694624687786cae69507aa3.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
    #menuBtn, #followBtn, #styleToggleBtn {
      position: fixed; background: #10b981; color: white; padding: 10px 14px;
      border: none; border-radius: 10px; z-index: 1001; cursor: pointer;
    }
    #menuBtn { top: 10px; left: 10px; }
    #followBtn { top: 60px; right: 10px; background: #3b82f6; display: none; }
    #styleToggleBtn { top: 10px; right: 10px; background: #6366f1; }
    #routeInfo {
      position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1001; font-size: 14px;
    }
    #menuPanel {
      position: fixed; top: 60px; left: 10px; background: white;
      border: 1px solid #ccc; padding: 10px; border-radius: 8px;
      z-index: 1001; display: none; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 300px;
    }
    #menuPanel h3 { margin-top: 0; }
    #menuPanel label { display: block; margin: 5px 0; }
    #menuPanel button {
      margin-top: 10px; width: 100%; background: #10b981; color: white;
      border: none; padding: 8px; border-radius: 6px; cursor: pointer;
    }
    #menuPanel .submit-btn { background: #ef4444; margin-top: 20px; }
    .arrow-wrapper { width: 80px; height: 80px; position: relative; }
    .arrow-spike {
      width: 20px; height: 20px; position: absolute;
      top: 0; left: 50%; transform: translateX(-50%) rotate(0deg);
      background: url('https://cdn-icons-png.flaticon.com/512/892/892692.png') no-repeat center;
      background-size: contain;
    }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.95); z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5em; font-weight: bold; color: #10b981;
    }
  </style>
</head>
<body>
<div id="loadingOverlay">‚è≥ Karte wird geladen...</div>
<button id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
<button id="followBtn" onclick="enableAutoFollow()">üìç Folge mir</button>
<button id="styleToggleBtn" onclick="toggleMapStyle()">üåì Stil</button>
<div id="routeInfo"></div>
<div id="menuPanel">
  <h3>üö¥ Men√º</h3>
  <strong>Ausgew√§hlte Eierh√ºtten:</strong>
  <ul id="selectedList"></ul>
  <label><input type="radio" name="routeMode" value="normal" checked> Normale Reihenfolge</label>
  <label><input type="radio" name="routeMode" value="optimized"> Optimierte Route</label>
  <button onclick="recalculateRoute()">üîÑ Route neu berechnen</button>
  <button onclick="resetSelection()">üóë Auswahl zur√ºcksetzen</button>
  <button class="submit-btn" onclick="window.location.href='chat.html'">‚ûï Neue H√ºtte einreichen</button>
</div>
<div id="map"></div>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour"
});
const db = firebase.firestore();
</script>
<script>
let lightLayer, darkLayer, currentStyle = 'light';
const map = L.map('map');
lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
});
darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors & Carto'
});
lightLayer.addTo(map);
map.setView([51.5, 10.5], 6);function toggleMapStyle() { if (currentStyle === 'light') { map.removeLayer(lightLayer); darkLayer.addTo(map); currentStyle = 'dark'; } else { map.removeLayer(darkLayer); lightLayer.addTo(map); currentStyle = 'light'; } }

let userMarker, directionMarker, autoFollow = true; let allHuts = [], hutMarkers = {}, selectedHuts = [], routingControl; const followBtn = document.getElementById("followBtn"); const selectedList = document.getElementById("selectedList");

const ICONS = { bike: './bike-icon.png', egg: './file_00000000de6c61f8ad4432078ea06ea3.png', eggSelected: './file_000000008694624687786cae69507aa3.png' };

const eggIcon = L.icon({ iconUrl: ICONS.egg, iconSize: [32, 32], iconAnchor: [16, 32] }); const eggSelectedIcon = L.icon({ iconUrl: ICONS.eggSelected, iconSize: [36, 36], iconAnchor: [18, 36] }); const bikeIcon = L.icon({ iconUrl: ICONS.bike, iconSize: [36, 36], iconAnchor: [18, 18] });

function enableAutoFollow() { autoFollow = true; followBtn.style.display = "none"; if (userMarker) map.setView(userMarker.getLatLng(), 15); }

map.on('movestart', () => { if (autoFollow) { autoFollow = false; followBtn.style.display = "block"; } });

function locateUser() { navigator.geolocation.watchPosition(pos => { const latlng = [pos.coords.latitude, pos.coords.longitude]; if (!userMarker) { userMarker = L.marker(latlng, { icon: bikeIcon }).addTo(map); const wrapper = document.createElement('div'); wrapper.className = 'arrow-wrapper'; const arrow = document.createElement('div'); arrow.className = 'arrow-spike'; wrapper.appendChild(arrow); const arrowIcon = L.divIcon({ html: wrapper.outerHTML, iconSize: [80, 80], className: '' }); directionMarker = L.marker(latlng, { icon: arrowIcon }).addTo(map); } else { userMarker.setLatLng(latlng); directionMarker.setLatLng(latlng); } if (autoFollow) map.setView(latlng, 15); });

if (window.DeviceOrientationEvent) { window.addEventListener("deviceorientation", e => { const spike = document.querySelector('.arrow-spike'); if (spike && e.alpha != null) { spike.style.transform = translateX(-50%) rotate(${e.alpha}deg); } }, true); } }

function loadHutsLive() { db.collection("eierhuetten").onSnapshot(snap => { allHuts = []; Object.values(hutMarkers).forEach(m => map.removeLayer(m)); hutMarkers = {}; snap.forEach(doc => { const d = doc.data(); if (!d.location) return; const hut = { id: doc.id, name: d.name || 'Unbenannt', lat: d.location.latitude, lng: d.location.longitude, strom: d.strom === true || String(d.strom).toLowerCase() === 'ja', oeffnungszeiten: d.oeffnungszeiten || '' }; allHuts.push(hut); renderHut(hut); }); updateSelectedList(); recalculateRoute(); document.getElementById("loadingOverlay").style.display = "none"; }); }

function renderHut(hut) { const marker = L.marker([hut.lat, hut.lng], { icon: eggIcon, name: hut.name }).addTo(map); marker.bindPopup(() => <strong>${hut.name}</strong><br> üîå Strom: ${hut.strom ? 'Ja' : 'Nein'}<br> üïí √ñffnungszeiten: ${hut.oeffnungszeiten || 'unbekannt'}<br> <button onclick="toggleSelection('${hut.id}')"> ${selectedHuts.includes(hut.id) ? '‚ùå Entfernen' : '‚úÖ Zur Route'} </button>); hutMarkers[hut.id] = marker; }

window.toggleSelection = function(id) { const idx = selectedHuts.indexOf(id); if (idx >= 0) { selectedHuts.splice(idx, 1); hutMarkers[id].setIcon(eggIcon); } else { selectedHuts.push(id); hutMarkers[id].setIcon(eggSelectedIcon); } updateSelectedList(); recalculateRoute(); map.closePopup(); }

function updateSelectedList() { selectedList.innerHTML = ''; selectedHuts.forEach(id => { const hut = allHuts.find(h => h.id === id); if (hut) { const li = document.createElement('li'); li.textContent = hut.name; selectedList.appendChild(li); } }); }

function recalculateRoute() { try { if (!userMarker) return; const points = [userMarker.getLatLng()]; const routeMode = document.querySelector("input[name='routeMode']:checked").value; const hutsToUse = [...selectedHuts]; if (routeMode === "optimized") hutsToUse.sort(); hutsToUse.forEach(id => { const hut = allHuts.find(h => h.id === id); if (hut) points.push(L.latLng(hut.lat, hut.lng)); }); if (routingControl && routingControl._container) { map.removeControl(routingControl); } if (points.length < 2) return; const routeColor = (routeMode === 'optimized') ? 'orange' : '#10b981'; routingControl = L.Routing.control({ waypoints: points, lineOptions: { styles: [{ color: routeColor, weight: 5 }] }, createMarker: () => null, show: false }).addTo(map).on('routesfound', e => { const r = e.routes[0]; document.getElementById('routeInfo').innerText = üö¥ ${(r.summary.totalDistance/1000).toFixed(1)}‚ÄØkm ¬∑ ‚è± ${Math.round(r.summary.totalTime/60)}‚ÄØmin; }); } catch (err) { console.error("Fehler bei Routenberechnung:", err); } }

function resetSelection() { selectedHuts.forEach(id => { if (hutMarkers[id]) hutMarkers[id].setIcon(eggIcon); }); selectedHuts = []; updateSelectedList(); recalculateRoute(); }

window.toggleSidebar = function () { const panel = document.getElementById("menuPanel"); panel.style.display = (panel.style.display === "block") ? "none" : "block"; }

locateUser(); loadHutsLive(); </script>

</body>
</html>
