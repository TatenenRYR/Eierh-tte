<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eierh√ºtten Chat</title>
<style>
  /* DEIN ORIGINALES DESIGN: KEINE √ÑNDERUNGEN */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #222; color: #eee;
    display: flex; flex-direction: column; height: 100vh;
  }
  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 600px;
    margin: auto;
    border: 2px solid #4caf50;
    border-radius: 8px;
    overflow: hidden;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #111;
  }
  #messages .message {
    margin-bottom: 1rem;
    line-height: 1.4;
  }
  #messages .message.user {
    color: #4caf50;
    text-align: right;
  }
  #messages .message.bot {
    color: #aaa;
    text-align: left;
  }
  #input-form {
    display: flex;
    border-top: 1px solid #4caf50;
    background: #333;
  }
  #input-form input[type="text"] {
    flex: 1;
    border: none;
    padding: 0.75rem;
    background: #222;
    color: #eee;
    font-size: 1rem;
  }
  #input-form button {
    background: #4caf50;
    border: none;
    color: white;
    padding: 0 1rem;
    cursor: pointer;
  }
  #input-form button:disabled {
    background: #777;
    cursor: default;
  }
  #map {
    height: 300px;
    display: none; /* wird dynamisch gezeigt */
  }
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
</head>
<body>

<div class="chat-container">
  <div id="messages"></div>
  <!-- Tipp-Buttons werden dynamisch eingef√ºgt -->
  <form id="input-form">
    <input type="text" id="input" autocomplete="off" placeholder="Nachricht eingeben..." />
    <button type="submit">Senden</button>
  </form>
  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  // --- DOM Elemente ---
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const chatForm = document.getElementById("input-form");
  const mapEl = document.getElementById("map");

  // --- Leaflet Karte ---
  const map = L.map(mapEl).setView([51.1657, 10.4515], 6); // Deutschland-Zentrum
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "¬© OpenStreetMap"
  }).addTo(map);
  let marker = null;

  // --- Chat-Status ---
  let dialogState = null;
  let hutData = {};
  let selectedHutId = null;

  // --- Funktion: Nachrichten anzeigen ---
  function addMessage(text, sender = "bot") {
    const msg = document.createElement("div");
    msg.classList.add("message", sender);
    msg.textContent = text;
    messagesEl.appendChild(msg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // --- Tipps als anklickbare Buttons ---
  const tips = [
    "Tipps: Klicke auf eine Option, um zu starten.",
    "Neue H√ºtte erstellen",
    "Meine H√ºtten anzeigen",
    "Standort senden"
  ];

  const tipsEl = document.createElement("div");
  tipsEl.style.padding = "0.5rem";
  tipsEl.style.fontSize = "0.9rem";
  tipsEl.style.color = "#aaa";
  tipsEl.style.display = "flex";
  tipsEl.style.justifyContent = "space-around";
  tipsEl.style.gap = "1rem";
  tipsEl.style.flexWrap = "wrap";

  tips.forEach((tip, i) => {
    const tipBtn = document.createElement("button");
    tipBtn.textContent = tip;
    tipBtn.style.background = "transparent";
    tipBtn.style.border = "1px solid #4caf50";
    tipBtn.style.color = "#4caf50";
    tipBtn.style.borderRadius = "5px";
    tipBtn.style.padding = "0.25rem 0.75rem";
    tipBtn.style.cursor = "pointer";
    tipBtn.disabled = (i === 0); // erster Text ist nur Info, kein Button

    tipBtn.addEventListener("click", () => {
      if (tip === "Neue H√ºtte erstellen") {
        startNewHut();
      } else if (tip === "Meine H√ºtten anzeigen") {
        showMyHuts();
      } else if (tip === "Standort senden") {
        sendLocation();
      }
    });

    tipsEl.appendChild(tipBtn);
  });

  // Tipps oberhalb der Nachrichten anzeigen
  const chatContainer = document.querySelector(".chat-container");
  chatContainer.insertBefore(tipsEl, messagesEl);

  // Tipps deaktivieren (nach H√ºtteneintrag)
  function disableTips() {
    Array.from(tipsEl.querySelectorAll("button")).forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "default";
    });
  }

  // --- Auth-Status √ºberwachen ---
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      addMessage("Willkommen zur√ºck, " + user.email);
    } else {
      addMessage("Bitte melde dich an, um H√ºtten einzutragen.");
      askLogin();
    }
  });

  // --- Login erzwingen ---
  function askLogin() {
    addMessage("Bitte melde dich mit Email und Passwort an.");
    dialogState = "awaiting_login_email";
  }

  // --- Funktionen f√ºr H√ºtte ---
  function startNewHut() {
    if (!currentUser) {
      addMessage("Bitte erst einloggen.");
      askLogin();
      return;
    }
    dialogState = "awaiting_name";
    hutData = { userId: currentUser.uid, status: "offen", erstelltAm: firebase.firestore.FieldValue.serverTimestamp() };
    addMessage("Wie soll deine neue H√ºtte hei√üen?");
    mapEl.style.display = "none";
  }

  async function showMyHuts() {
    if (!currentUser) {
      addMessage("Bitte erst einloggen.");
      askLogin();
      return;
    }
    try {
      const snapshot = await db.collection("eierhuetten").where("userId", "==", currentUser.uid).get();
      if (snapshot.empty) {
        addMessage("Keine H√ºtten gefunden.");
      } else {
        snapshot.forEach(doc => {
          const d = doc.data();
          addMessage(`üè† ${d.name || 'Ohne Namen'} (${d.status || 'Status unbekannt'}) ‚Äì ID: ${doc.id}`);
        });
      }
    } catch (e) {
      addMessage("Fehler beim Abrufen der H√ºtten: " + e.message);
    }
  }

  function sendLocation() {
    if (!navigator.geolocation) {
      addMessage("Geolocation wird nicht unterst√ºtzt.");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      addMessage(`üìç Dein aktueller Standort: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`);
    }, () => {
      addMessage("‚ùå Standort konnte nicht abgerufen werden.");
    });
  }

  // --- Chat-Eingabe ---
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = inputEl.value.trim();
    if (!msg) return;
    addMessage(msg, "user");
    inputEl.value = "";

    if (!currentUser) {
      addMessage("Bitte zuerst einloggen.");
      askLogin();
      return;
    }

    if (dialogState === "awaiting_login_email") {
      hutData = {};
      hutData.email = msg;
      dialogState = "awaiting_login_password";
      addMessage("Bitte Passwort eingeben.");
      return;
    }

    if (dialogState === "awaiting_login_password") {
      try {
        await auth.signInWithEmailAndPassword(hutData.email, msg);
        addMessage("Login erfolgreich!");
        dialogState = null;
      } catch (e) {
        addMessage("Login fehlgeschlagen: " + e.message);
      }
      return;
    }

    if (dialogState === "awaiting_name") {
      hutData.name = msg;
      dialogState = "awaiting_location";
      mapEl.style.display = "block";
      map.invalidateSize();
      addMessage("Klicke auf die Karte, um den Standort auszuw√§hlen oder sende deinen aktuellen Standort mit 'Standort senden'.");
      return;
    }

    // Weitere Befehle
    const cmd = msg.toLowerCase();
    if (/zeige.*(h√ºtten|meine)/.test(cmd)) {
      await showMyHuts();
    } else if (/neue.*(h√ºtte|eintragen|hinzuf√ºgen)/.test(cmd)) {
      startNewHut();
    } else if (/standort\s*(senden|√ºbertragen)/.test(cmd)) {
      sendLocation();
    } else {
      addMessage("Befehl nicht erkannt. Versuche z.B. 'zeige meine H√ºtten', 'neue H√ºtte erstellen', 'Standort senden'.");
    }
  });

  // --- Karte Klick: Standort setzen & H√ºtte speichern ---
  map.on('click', async function(e) {
    if (dialogState !== "awaiting_location") {
      addMessage("Bitte erst eine neue H√ºtte anlegen, bevor du einen Standort ausw√§hlst.");
      return;
    }
    const { lat, lng } = e.latlng;

    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);

    hutData.location = new firebase.firestore.GeoPoint(lat, lng);

    try {
      await db.collection("eierhuetten").add(hutData);
      addMessage("üìç Standort gespeichert und H√ºtte erfolgreich eingetragen.");
      dialogState = null;
      mapEl.style.display = "none";
      disableTips();
    } catch (e) {
      addMessage("Fehler beim Speichern der H√ºtte: " + e.message);
    }
  });
</script>
</body>
</html>
