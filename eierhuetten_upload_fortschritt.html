<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intelligenter Chatbot</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .chat-container {
      width: 100%;
      max-width: 600px;
      height: 90vh;
      background: #1e1e1e;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    #messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .message {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 15px;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
      position: relative;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .bot {
      background: #2c7a7b;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .user {
      background: #4a5568;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .tip {
      background: #1f4040;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      animation: fadeIn 0.5s forwards;
    }
    #input-area {
      display: flex;
      padding: 0.5rem;
      background: #2d2d2d;
    }
    #chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 20px;
      border: none;
      font-size: 1rem;
      outline: none;
    }
    #send-btn {
      margin-left: 0.5rem;
      padding: 0 1.2rem;
      border: none;
      border-radius: 20px;
      background: #285e61;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    #send-btn:disabled { background: #444; cursor: not-allowed; }
    #location-options {
      display: flex;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    .loc-btn {
      flex: 1;
      padding: 0.5rem;
      background: #285e61;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .loc-btn:disabled { background: #444; cursor: not-allowed; }
    #map { height: 250px; border-radius: 10px; margin-top: 0.5rem; display: none; }
    @media (max-width: 480px) {
      .chat-container { height: 100vh; border-radius: 0; }
      #map { height: 200px; }
    }
  </style>
</head>
<body>
<div class="chat-container">
  <div id="messages"></div>
  <div id="input-area">
    <input type="text" id="chat-input" placeholder="Nachricht eingeben..." autocomplete="off" />
    <button id="send-btn" disabled>Senden</button>
  </div>
  <div id="map"></div>
</div><!-- Firebase --><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script><script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><script>
  // Firebase init
  const firebaseConfig = {...}; // DEIN CONFIG
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const mapEl = document.getElementById('map');
  let map, marker; let state = 'start'; let tempData = {};

  function addMessage(text, sender='bot') {
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // Tipps anklickbar
  window.addEventListener('DOMContentLoaded', () => {
    const actions = [() => startNewHut(),
                     () => parseCommand('zeige meine H√ºtten'),
                     () => parseCommand('Standort senden')];
    const tips = ['Erstelle eine neue H√ºtte', 'Zeige meine H√ºtten', 'Standort senden'];
    tips.forEach((text,i) => {
      setTimeout(() => {
        const tipEl = document.createElement('div');
        tipEl.className = 'tip';
        tipEl.textContent = `Tipp: ${text}`;
        tipEl.onclick = actions[i];
        messagesEl.appendChild(tipEl);
      }, 500 + i*800);
    });
    addMessage('Hallo! Wie kann ich dir helfen?');
  });

  inputEl.addEventListener('input', () => sendBtn.disabled = !inputEl.value.trim());
  sendBtn.addEventListener('click', () => handleUser(inputEl.value.trim()));
  inputEl.addEventListener('keypress', e => { if(e.key==='Enter' && !sendBtn.disabled) handleUser(inputEl.value.trim()); });

  function handleUser(msg) {
    addMessage(msg,'user'); inputEl.value=''; sendBtn.disabled=true;
    if(state==='start') parseCommand(msg);
    else if(state==='await_name') { tempData.name=msg; askLocationChoice(); }
  }

  function parseCommand(msg) {
    const m=msg.toLowerCase();
    if(m.includes('neue h√ºtte')) startNewHut();
    else if(m.includes('zeige')&&m.includes('h√ºtten')) addMessage('Hier sind deine H√ºtten: ...');
    else if(m.includes('standort')) askLocationChoice();
    else addMessage('Nicht verstanden. Versuch: neue H√ºtte, zeige H√ºtten, Standort senden.');
  }

  function startNewHut() {
    addMessage('Wie soll die neue H√ºtte hei√üen?'); state='await_name'; tempData={ userId: auth.currentUser.uid };
  }

  function askLocationChoice() {
    addMessage('W√§hle Standort:');
    const opts=document.createElement('div'); opts.id='location-options';
    const cur=document.createElement('button'); cur.textContent='Aktueller Standort'; cur.className='loc-btn';
    const mapBtn=document.createElement('button'); mapBtn.textContent='Auf Karte ausw√§hlen'; mapBtn.className='loc-btn';
    opts.append(cur,mapBtn); messagesEl.appendChild(opts); messagesEl.scrollTop=messagesEl.scrollHeight;
    cur.onclick=()=> { disableLocButtons(); getCurrentLocation(); };
    mapBtn.onclick=()=> { disableLocButtons(); initMap(); };
    state='await_location';
  }

  function disableLocButtons(){ document.querySelectorAll('.loc-btn').forEach(b=>b.disabled=true); }

  function getCurrentLocation() {
    if(!navigator.geolocation) return addMessage('Geolocation nicht unterst√ºtzt.');
    navigator.geolocation.getCurrentPosition(async pos=>{
      const loc={ latitude:pos.coords.latitude, longitude:pos.coords.longitude };
      tempData.location=loc;
      await db.collection('eierhuetten').add({ ...tempData, status:'offen', erstelltAm: firebase.firestore.FieldValue.serverTimestamp() });
      addMessage(`üìç Standort gesendet: ${loc.latitude.toFixed(5)},${loc.longitude.toFixed(5)}`);
      addMessage('‚úÖ H√ºtte eingetragen!'); state='start';
    },()=>addMessage('Konnte Standort nicht abrufen.'));
  }

  function initMap() {
    mapEl.style.display='block';
    if(!map) {
      map=L.map(mapEl).setView([49.0,8.4],8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OSM' }).addTo(map);
      map.on('click', async e=>{
        const loc={ latitude:e.latlng.lat, longitude:e.latlng.lng };
        if(marker) marker.remove(); marker=L.marker([loc.latitude,loc.longitude]).addTo(map);
        tempData.location=loc;
        await db.collection('eierhuetten').add({ ...tempData, status:'offen', erstelltAm: firebase.firestore.FieldValue.serverTimestamp() });
        addMessage(`üìç Standort gew√§hlt: ${loc.latitude.toFixed(5)},${loc.longitude.toFixed(5)}`);
        addMessage('‚úÖ H√ºtte eingetragen!'); state='start';
      });
    } else map.invalidateSize();
  }
</script></body>
</html>
