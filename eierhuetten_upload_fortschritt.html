<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meine EierhÃ¼tten</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f9f9f9; }
    .card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .hidden { display: none; }
    #map { height: 300px; margin-bottom: 1rem; }
    progress { width: 100%; margin-bottom: 1rem; }
    .upload-status { margin: 0.5rem 0; color: green; font-weight: bold; }
    #successMsg { background: #4caf50; color: white; padding: 1rem; border-radius: 6px; text-align: center; margin-bottom: 1rem; display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Neue EierhÃ¼tte einreichen</h1>
    <input id="hut-name" placeholder="Name der HÃ¼tte" />
    <textarea id="hut-desc" placeholder="Beschreibung"></textarea>
    <input type="file" id="hut-image" accept="image/*" />
    <progress id="uploadProgress" value="0" max="100" class="hidden"></progress>
    <div id="uploadStatus" class="upload-status"></div>
    <div id="map"></div>
    <input id="hut-lat" type="hidden" />
    <input id="hut-lng" type="hidden" />
    <button id="submitBtn">Einreichen</button>
  </div>  <div id="successMsg">ðŸŽ‰ HÃ¼tte erfolgreich eingereicht!</div>  <!-- Leaflet und Firebase -->  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script>
    function debug(...args) {
      const log = document.createElement('pre');
      log.textContent = '[DEBUG] ' + args.map(a => JSON.stringify(a)).join(' ');
      document.body.appendChild(log);
    }

    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Dummy User fÃ¼r Test (ersetzen durch echten Login)
    const userId = "TESTUSER-123";

    // Karte initialisieren
    let map = L.map('map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([51.1657, 10.4515], { draggable: true }).addTo(map);

    marker.on('dragend', () => updateCoords(marker.getLatLng()));
    map.on('click', e => {
      marker.setLatLng(e.latlng);
      updateCoords(e.latlng);
    });

    function updateCoords(latlng) {
      document.getElementById('hut-lat').value = latlng.lat;
      document.getElementById('hut-lng').value = latlng.lng;
    }

    document.getElementById('submitBtn').onclick = async () => {
      const name = document.getElementById('hut-name').value.trim();
      const desc = document.getElementById('hut-desc').value.trim();
      const lat = parseFloat(document.getElementById('hut-lat').value);
      const lng = parseFloat(document.getElementById('hut-lng').value);
      const fileInput = document.getElementById('hut-image');
      const file = fileInput.files[0];

      if (!name || isNaN(lat) || isNaN(lng)) {
        alert('Bitte alle Felder ausfÃ¼llen.');
        return;
      }

      let imageUrl = "";

      if (file) {
        const storageRef = storage.ref().child('hÃ¼tten_bilder/' + Date.now() + '_' + file.name);
        const uploadTask = storageRef.put(file);

        document.getElementById('uploadProgress').classList.remove('hidden');
        document.getElementById('uploadStatus').textContent = 'Upload lÃ¤uft...';

        uploadTask.on('state_changed', 
          snapshot => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('uploadProgress').value = progress;
            debug('Upload lÃ¤uft', progress + '%');
          }, 
          error => {
            debug('Upload-Fehler:', error);
            alert('Fehler beim Hochladen des Bildes.');
          }, 
          async () => {
            imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
            debug('Bild-URL:', imageUrl);
            await saveHut(name, desc, lat, lng, imageUrl);
          }
        );
      } else {
        await saveHut(name, desc, lat, lng, imageUrl);
      }
    };

    async function saveHut(name, desc, lat, lng, imageUrl) {
      try {
        await db.collection('eierhuetten').add({
          userId,
          name,
          beschreibung: desc,
          location: { latitude: lat, longitude: lng },
          bild: imageUrl,
          erstelltAm: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('successMsg').style.display = 'block';
        setTimeout(() => document.getElementById('successMsg').style.display = 'none', 3000);
        debug('HÃ¼tte gespeichert');
      } catch (e) {
        debug('Fehler beim Speichern:', e);
        alert('Fehler beim Speichern der HÃ¼tte.');
      }
    }
  </script></body>
</html>
