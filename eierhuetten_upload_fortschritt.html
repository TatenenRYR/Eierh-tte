<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HÃ¼tten-Dialog mit Karte</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { background: #121212; color: #fff; margin:0; font-family:'Segoe UI', sans-serif; }
    .chat-container { display:flex; flex-direction:column; height:100vh; max-width:600px; margin:auto; padding:1rem; }
    #messages { flex:1; overflow-y:auto; margin-bottom:1rem; }
    .message { padding:0.75rem; border-radius:10px; margin:0.5rem 0; max-width:80%; }
    .bot { background:#4caf50; align-self:flex-start; }
    .user { background:#333; align-self:flex-end; }
    form { display:flex; gap:0.5rem; }
    input { flex:1; padding:0.75rem; border:none; border-radius:5px; }
    button { padding:0.75rem 1rem; background:#4caf50; color:#fff; border:none; border-radius:5px; cursor:pointer; }
    #map-container { display:none; height:300px; margin-top:1rem; border:2px solid #4caf50; border-radius:8px; }
  </style>
</head>
<body>
<div class="chat-container">
  <div id="messages"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="Nachricht eingebenâ€¦" autocomplete="off"/>
    <button type="submit">Senden</button>
  </form>
  <div id="map-container">
    <div id="map" style="height:100%;"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import L from "https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let dialogState = null;
  const hutData = {};

  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chat-form');
  const inputEl = document.getElementById('chat-input');
  const mapContainer = document.getElementById('map-container');
  let map, marker;

  const addMessage = (text, who="bot") => {
    const div = document.createElement('div');
    div.className = `message ${who}`;
    div.textContent = text;
    messagesEl.append(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  };

  const askLogin = async () => {
    try {
      setPersistence(auth, browserLocalPersistence);
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      currentUser = result.user;
      addMessage(`Willkommen ${currentUser.displayName}! Was mÃ¶chtest du tun?`);
    } catch(e) {
      addMessage(`Login-Fehler: ${e.message}`);
    }
  };

  onAuthStateChanged(auth, user => {
    if(user) {
      currentUser = user;
      addMessage(`Willkommen zurÃ¼ck, ${user.displayName}!`);
    } else {
      addMessage("Bitte melde dich an.");
      askLogin();
    }
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const text = inputEl.value.trim();
    if(!text) return;
    addMessage(text,"user");
    inputEl.value="";

    if(!currentUser) {
      addMessage("Du bist nicht eingeloggt, ich leite zum Login weiter.");
      return askLogin();
    }

    switch(dialogState) {
      case "awaiting_name":
        hutData.name = text;
        dialogState = "awaiting_location";
        addMessage("Tippe oder klicke den Standort auf der Karte.");
        showMap();
        break;

      case "awaiting_location":
        addMessage("Bitte wÃ¤hle den Standort auf der Karte.");
        break;

      default:
        const cmd = text.toLowerCase();
        if(cmd.includes("zeige hÃ¼tten")) {
          const q = query(collection(db,'eierhuetten'), where("userId","==",currentUser.uid));
          const snap = await getDocs(q);
          if(snap.empty) addMessage("Keine HÃ¼tten gefunden.");
          else snap.forEach(d=>addMessage(`ðŸ  ${d.data().name} (Status: ${d.data().status})`));
        } 
        else if(cmd.includes("neue hÃ¼tte")) {
          dialogState="awaiting_name";
          addMessage("Wie soll deine HÃ¼tte heiÃŸen?");
        } 
        else addMessage("Sag z.â€¯B. 'zeige HÃ¼tten' oder 'neue HÃ¼tte'");
    }
  });

  const showMap = () => {
    mapContainer.style.display='block';
    if(!map) {
      map = L.map('map').setView([51.1657,10.4515],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([51.1657,10.4515], { draggable:true })
        .addTo(map)
        .on('dragend', e => saveLocation(e.target.getLatLng()));
      map.on('click', e => saveLocation(e.latlng));
    }
  };

  const saveLocation = async latlng => {
    hutData.location = { latitude: latlng.lat, longitude: latlng.lng };
    mapContainer.style.display='none';
    dialogState = null;
    await addDoc(collection(db,'eierhuetten'), {
      userId: currentUser.uid,
      name: hutData.name,
      location: hutData.location,
      status: 'offen',
      erstelltAm: serverTimestamp()
    });
    addMessage("âœ… HÃ¼tte eingetragen: " + hutData.name);
  };
</script>
</body>
</html>
