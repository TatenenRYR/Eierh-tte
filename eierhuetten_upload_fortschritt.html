<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eierh√ºtten KI-Chat</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #121212; color: #eee;
      display: flex; align-items: center; justify-content: center;
      height: 100vh;
    }
    .container {
      width: 95vw; max-width: 600px;
      height: 90vh; display: flex; flex-direction: column;
      background: #1e1e1e; border-radius: 12px;
      overflow: hidden; box-shadow: 0 0 15px #000;
    }
    .chat {
      flex: 1; padding: 1rem; overflow-y: auto;
      display: flex; flex-direction: column;
    }
    .input-area {
      display: flex; border-top: 1px solid #333;
      background: #181818; padding: .5rem;
    }
    .input-area input {
      flex: 1; padding: .75rem;
      border: none; border-radius: 8px;
      background: #2c2c2c; color: #fff;
      font-size: 1rem; outline: none;
    }
    .input-area button {
      margin-left: .5rem; padding: .75rem 1rem;
      background: #4e7f4e; border: none; color: white;
      border-radius: 8px; cursor: pointer;
      font-size: 1rem;
    }
    .message {
      display: flex; margin-bottom: .75rem;
    }
    .message.user { justify-content: flex-end; }
    .message.bot  { justify-content: flex-start; }
    .bubble {
      max-width: 75%; padding: .75rem 1rem;
      border-radius: 16px; line-height: 1.4;
      animation: fadeIn .4s;
    }
    .message.user .bubble { background: #3b8c3b; }
    .message.bot  .bubble { background: #333; display: flex; align-items: center; }
    .bot-icon {
      width: 32px; height: 32px; margin-right: .5rem;
      background: url('https://cdn-icons-png.flaticon.com/512/188/188987.png') center/cover no-repeat;
      border-radius: 50%; animation: bounceIn .8s;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="chat" class="chat"></div>
  <div class="input-area">
    <input id="inp" type="text" placeholder="Nachricht..." disabled>
    <button id="btn" onclick="handleSend()" disabled>Senden</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // ‚Äî‚Äî‚Äî Firebase initialisieren ‚Äî‚Äî‚Äî
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  let currentUser = null;

  const chatEl = document.getElementById('chat');
  const inp    = document.getElementById('inp');
  const btn    = document.getElementById('btn');

  // ‚Äî‚Äî‚Äî Utility zum Hinzuf√ºgen von Nachrichten ‚Äî‚Äî‚Äî
  function addMessage(sender, text) {
    const m = document.createElement('div');
    m.className = 'message ' + sender;
    m.innerHTML = (sender==='bot'
      ? '<div class="bot-icon"></div>'
      : '') +
      '<div class="bubble animate__animated animate__fadeIn">'+ text +'</div>';
    chatEl.appendChild(m);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function bot(text) {
    addMessage('bot', text);
  }

  // ‚Äî‚Äî‚Äî Senden behandeln ‚Äî‚Äî‚Äî
  function handleSend() {
    const text = inp.value.trim();
    if (!text) return;  // keine Leerzeichen
    addMessage('user', text);
    inp.value = '';
    interpret(text.toLowerCase());
  }

  // ‚Äî‚Äî‚Äî Chat-Logik als KI-Simulation ‚Äî‚Äî‚Äî
  async function interpret(msg) {
    if (!currentUser) {
      bot('üîí Bitte warte kurz, du wirst eingeloggt...');
      return;
    }

    if (msg.includes('zeige h√ºtten')) {
      try {
        const q = db.collection('eierhuetten').where('userId','==',currentUser.uid);
        const snap = await q.get();
        if (snap.empty) {
          bot('üîç Keine H√ºtten gefunden.');
        } else {
          snap.forEach(d => {
            const o = d.data();
            bot('üè† '+ o.name +' ‚Ä¢ Status: '+ (o.status||'offen'));
          });
        }
      } catch(e){
        bot('‚ùå Fehler beim Laden der H√ºtten.');
        console.error(e);
      }
    }
    else if (msg.includes('neue h√ºtte')) {
      bot('üì¶ Toll! Wie soll die H√ºtte hei√üen?');
      // hier k√∂nnte man weiteren Dialog ansto√üen...
    }
    else {
      bot('ü§î Ich habe das nicht verstanden. Schreibe ‚Äûzeige H√ºtten‚Äú oder ‚Äûneue H√ºtte‚Äú');
    }
  }

  // ‚Äî‚Äî‚Äî Auth-State & automatisches Re-Login ‚Äî‚Äî‚Äî
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => {
      auth.onAuthStateChanged(u => {
        if (u) {
          currentUser = u;
          inp.disabled = false;
          btn.disabled = false;
          bot('üëã Willkommen '+ (u.displayName||u.email));
        } else {
          // sofort Google-Login-Popup
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithPopup(provider).catch(err=>{
            bot('‚ùå Login fehlgeschlagen.');
            console.error(err);
          });
        }
      });
    });
</script>

</body>
</html>
