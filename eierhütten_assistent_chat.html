<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EierhÃ¼tten Assistent</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f4f8; margin: 0; padding: 0; }
    #login { display: flex; justify-content: center; padding: 20px; }
    #login button { padding: 10px 20px; font-size: 1.1rem; background: #4285F4; color: white; border: none; border-radius: .5rem; cursor: pointer; }
    #chat-container { display: none; flex-direction: column; height: 100vh; }
    #chat-window { flex: 1; overflow-y: auto; padding: 1rem; }
    #input-area { display: flex; padding: .5rem; border-top: 1px solid #ccc; background: white; }
    #chat-input { flex: 1; padding: .5rem; border: 1px solid #ccc; border-radius: .5rem; }
    #send-btn { margin-left: .5rem; padding: .5rem 1rem; background: #4CAF50; color: white; border: none; border-radius: .5rem; cursor: pointer; }
    .message { max-width: 70%; margin-bottom: .75rem; padding: .6rem .9rem; border-radius: 1rem; position: relative; }
    .bot { background: #fff8e1; align-self: flex-start; border: 1px solid #fcd34d; }
    .bot::before { content: 'ðŸ¥š'; position: absolute; top: -10px; left: -24px; font-size: 1.5rem; }
    .user { background: #DCF8C6; align-self: flex-end; }
    button.choice { margin: .2rem; background: #fafafa; border: 1px solid #0284C7; color: #0284C7; padding: .3rem .6rem; border-radius: .5rem; cursor: pointer; }
  </style>
</head>
<body>

  <div id="login"><button id="google-login">Mit Google anmelden</button></div>

  <div id="chat-container">
    <div id="chat-window"></div>
    <div id="input-area">
      <input id="chat-input" placeholder="Schreibe hier..." autocomplete="off" />
      <button id="send-btn">Senden</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById('google-login');
    const loginDiv = document.getElementById('login');
    const chatContainer = document.getElementById('chat-container');

    loginBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    let currentUser = null;
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loginDiv.style.display = 'none';
        chatContainer.style.display = 'flex';
        addBot("Hallo " + (user.displayName || "Nutzer") + "! Was mÃ¶chtest du tun?");
        showChoices(["Neue HÃ¼tte einreichen","Meine HÃ¼tten ansehen","Hilfe"]);
      } else {
        loginDiv.style.display = 'flex';
        chatContainer.style.display = 'none';
      }
    });

    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    let step = 0, form = {};

    sendBtn.onclick = () => handleInput(chatInput.value.trim());
    chatInput.onkeydown = e => e.key === 'Enter' && handleInput(chatInput.value.trim());

    function addBot(text) {
      const div = document.createElement('div');
      div.className = 'message bot';
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function addUser(text) {
      const div = document.createElement('div');
      div.className = 'message user';
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showChoices(options) {
      const container = document.createElement('div');
      container.className = 'message bot';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = opt;
        btn.onclick = () => {
          addUser(opt);
          container.remove();
          handleInput(opt.toLowerCase());
        };
        container.appendChild(btn);
      });
      chatWindow.appendChild(container);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function handleInput(input) {
      if (!input) return;
      addUser(input);
      chatInput.value = '';

      const lower = input.toLowerCase();

      if (step === 0) {
        if (lower.includes('neu')) {
          form = {};
          step = 1;
          addBot("Wie heiÃŸt deine HÃ¼tte?");
        }
        else if (lower.includes('meine')) {
          addBot("âŒ› LÃ¤dtâ€¦");
          // TODO: Firestore-Abfrage nach eigenen HÃ¼tten
          addBot("ðŸ“‹ (Feature folgt)");
          showChoices(["Neue HÃ¼tte einreichen"]);
        }
        else if (lower.includes('hilfe')) {
          addBot("Du kannst z.B. machen:");
          showChoices(["Neue HÃ¼tte einreichen","Meine HÃ¼tten ansehen"]);
        }
        else {
          addBot("Bitte wÃ¤hle: neue HÃ¼tte, meine HÃ¼tten oder Hilfe.");
          showChoices(["Neue HÃ¼tte einreichen","Meine HÃ¼tten ansehen","Hilfe"]);
        }
      }
      else if (step === 1) {
        form.name = input;
        step = 2;
        addBot("Gibt es SitzplÃ¤tze? (ja/nein)");
      }
      else if (step === 2) {
        form.sitzplaetze = lower;
        step = 3;
        addBot("Gibt es Strom? (ja/nein)");
      }
      else if (step === 3) {
        form.strom = lower;
        step = 4;
        addBot("Beschreibe deine HÃ¼tte:");
      }
      else if (step === 4) {
        form.beschreibung = input;
        step = 5;
        addBot("ðŸ‘‰ Bitte wÃ¤hle den Standort auf der Karte:");
        showMapForm();
      }
    }

    function showMapForm() {
      const mapDiv = document.createElement('div');
      mapDiv.id = 'map';
      mapDiv.style.height = '200px';
      chatWindow.appendChild(mapDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      form.lat = form.lng = null;
      const m = L.map(mapDiv).setView([51.1657,10.4515],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
      let mark;
      m.on('click', e => {
        if (mark) mark.setLatLng(e.latlng);
        else mark = L.marker(e.latlng).addTo(m);
        form.lat = e.latlng.lat;
        form.lng = e.latlng.lng;
        if (form.lat && form.lng) {
          addBot(`ðŸ“Œ Standort gewÃ¤hlt: ${form.lat.toFixed(5)}, ${form.lng.toFixed(5)}`);
          step = 6;
          showChoices(["Foto hinzufÃ¼gen", "Ãœberspringen"]);
        }
      });
    }

    sendBtn.onclick = handleInput;
    chatInput.onkeydown = e => e.key === 'Enter' && handleInput(chatInput.value.trim());

    async function handlePhoto() {
      step = 7;
      addBot("Foto bitte als Link oder Base64-String einfÃ¼gen:");
    }

    async function submitForm() {
      addBot("ðŸš€ Speichere deine HÃ¼tteâ€¦");
      try {
        await addDoc(collection(db, 'eierhuetten'), {
          name: form.name,
          sitzplaetze: form.sitzplaetze,
          strom: form.strom,
          beschreibung: form.beschreibung,
          location: { latitude: form.lat, longitude: form.lng },
          userId: currentUser.uid,
          status: 'offen',
          erstelltAm: serverTimestamp()
        });
        addBot("âœ… Deine HÃ¼tte wurde erfolgreich eingereicht!");
      } catch (err) {
        addBot("âŒ Fehler: " + err.message);
      }
      step = 0;
      showChoices(["Neue HÃ¼tte einreichen"]);
    }

    // Choice handler for steps >=6
    chatWindow.addEventListener('click', async e => {
      if (e.target.matches('button.choice')) {
        const choice = e.target.textContent.toLowerCase();
        if (step === 6 && choice.includes('foto')) {
          await handlePhoto();
        }
        else if (step === 6 && choice.includes('Ã¼berspringen')) {
          await submitForm();
        }
      }
    });

    // Photo input from chat
    chatInput.addEventListener('keydown', async e => {
      if (step === 7 && e.key === 'Enter') {
        form.foto = chatInput.value.trim();
        chatInput.value = '';
        await submitForm();
      }
    });
  </script>
</body>
</html>
