<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten Assistent Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 75%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    #map { width: 100%; height: 400px; margin-top: .75rem; border-radius: .5rem; }
    .hidden { display: none; }
  </style>
</head>
<body class="p-6">
  <div id="login-section" class="max-w-md mx-auto text-center">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
      Mit Google anmelden
    </button>
  </div>  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
    <div class="text-center font-bold text-2xl text-green-700 mb-4">ü•ö Eierh√ºtten Assistent Chat</div><div id="key-section" class="mb-4">
  <input id="api-key" type="text" placeholder="OpenRouter API-Key eingeben"
    class="border border-gray-300 px-3 py-2 rounded w-full mb-2" />
  <button id="save-key" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">Key speichern</button>
</div>

<div id="chat-window" aria-live="polite" role="log"></div>

<div id="input-area">
  <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
  <button id="send-btn">Senden</button>
</div>

  </section><script>
const config = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(config);

const auth = firebase.auth();
const db = firebase.firestore();

const ui = {
  loginSection: document.getElementById('login-section'),
  mainSection: document.getElementById('main-section'),
  chatWindow: document.getElementById('chat-window'),
  chatInput: document.getElementById('chat-input'),
  sendBtn: document.getElementById('send-btn'),
  apiKeyInput: document.getElementById('api-key'),
  saveKeyBtn: document.getElementById('save-key'),
  keySection: document.getElementById('key-section')
};

let state = {
  currentUser: null,
  apiKey: localStorage.getItem('openrouter_api_key') || '',
  step: 0,
  formData: {}
};

function scrollToBottom() {
  ui.chatWindow.scrollTop = ui.chatWindow.scrollHeight;
}

function addMessage(text, sender = 'bot') {
  const msg = document.createElement('div');
  msg.className = `message ${sender}`;
  msg.textContent = text;
  ui.chatWindow.appendChild(msg);
  scrollToBottom();
}

function addChoices(options, callback) {
  const box = document.createElement('div');
  box.className = 'message bot';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.onclick = () => {
      addMessage(opt, 'user');
      box.remove();
      callback(opt.toLowerCase());
    };
    box.appendChild(btn);
  });
  ui.chatWindow.appendChild(box);
  scrollToBottom();
}

function checkKeyAndStart() {
  if (state.apiKey.length > 20) {
    ui.keySection.classList.add('hidden');
    startDialog();
  } else {
    ui.keySection.classList.remove('hidden');
  }
}

ui.saveKeyBtn.onclick = () => {
  const key = ui.apiKeyInput.value.trim();
  if (key.length > 20) {
    state.apiKey = key;
    localStorage.setItem('openrouter_api_key', key);
    checkKeyAndStart();
  } else {
    alert('Bitte g√ºltigen API-Key eingeben.');
  }
};

auth.onAuthStateChanged(user => {
  state.currentUser = user;
  ui.loginSection.classList.toggle('hidden', !!user);
  ui.mainSection.classList.toggle('hidden', !user);
  if (user) {
    ui.apiKeyInput.value = state.apiKey;
    checkKeyAndStart();
  }
});

document.getElementById('google-login').onclick = () =>
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

ui.sendBtn.onclick = handleInput;
ui.chatInput.onkeydown = e => e.key === 'Enter' && handleInput();

function handleInput() {
  const input = ui.chatInput.value.trim();
  if (!input) return;
  addMessage(input, 'user');
  ui.chatInput.value = '';
  processStep(input.toLowerCase());
}

function processStep(input) {
  const data = state.formData;
  switch (state.step) {
    case 0:
      if (input.includes('neu')) {
        addMessage('Wie soll deine Eierh√ºtte hei√üen?', 'bot');
        state.step = 1;
      } else {
        addMessage('Bitte w√§hle eine Option:', 'bot');
        addChoices(['Neue H√ºtte einreichen', 'Meine H√ºtten ansehen'], processStep);
      }
      break;
    case 1:
      data.name = input;
      addMessage('Gibt es Sitzpl√§tze?', 'bot');
      addChoices(['Ja', 'Nein'], choice => {
        data.sitzplaetze = choice;
        addMessage('Gibt es Strom?', 'bot');
        addChoices(['Ja', 'Nein'], strom => {
          data.strom = strom;
          addMessage('Gib noch Extras an (optional):', 'bot');
          state.step = 2;
        });
      });
      state.step = -1;
      break;
    case 2:
      data.extras = input.includes('nein') ? '' : input;
      addMessage('Standort bitte auf der Karte ausw√§hlen (folgt)', 'bot');
      state.step = 3;
      break;
    default:
      addMessage('Danke! Deine Daten sind fast fertig.', 'bot');
  }
}

function startDialog() {
  addMessage('Willkommen! Was m√∂chtest du tun?', 'bot');
  addChoices(['Neue H√ºtte einreichen', 'Meine H√ºtten ansehen', 'Hilfe'], processStep);
}
</script></body>
</html>
