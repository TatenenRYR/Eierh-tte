<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EierhÃ¼tten Assistent Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    .hidden { display: none; }
    #map, .preview-map { width: 100%; height: 300px; margin-top: 1rem; border-radius: 0.5rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .edit-input, .status-dropdown { display: block; width: 100%; padding: 0.4rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 0.4rem; }
  </style>
</head>
<body class="p-6"><!-- ... vorheriger HTML-Code bleibt bestehen ... --><script>
// ... vorheriger JS-Code bleibt bestehen ...

function showMyHuts() {
  chatWindow.innerHTML = '';
  db.collection('eierhuetten').where('userId', '==', currentUser.uid).orderBy('erstelltAm', 'desc').get().then(snapshot => {
    if (snapshot.empty) return addMessage('âŒ Keine HÃ¼tten gefunden.', 'bot');
    snapshot.forEach(doc => {
      const d = doc.data();
      const container = document.createElement('div');
      container.className = 'message bot';
      const hutId = doc.id;
      container.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded space-y-1 text-sm">
          <div><strong>ğŸ“ Name:</strong> ${d.name}</div>
          <div><strong>ğŸª‘ SitzplÃ¤tze:</strong> ${d.sitzplaetze}</div>
          <div><strong>ğŸ”Œ Strom:</strong> ${d.strom}</div>
          <div><strong>âœ¨ Extras:</strong> ${d.extras}</div>
          <div><strong>Status:</strong>
            <select class="status-dropdown" onchange="updateStatus('${hutId}', this.value)">
              <option value="offen" ${d.status === 'offen' ? 'selected' : ''}>offen</option>
              <option value="angenommen" ${d.status === 'angenommen' ? 'selected' : ''}>angenommen</option>
              <option value="abgelehnt" ${d.status === 'abgelehnt' ? 'selected' : ''}>abgelehnt</option>
            </select>
          </div>
          <div class="minimap" id="minimap-${doc.id}"></div>
          <div class="mt-2 flex gap-2">
            <button onclick="editHut('${doc.id}', ${JSON.stringify(d).replace(/"/g, '&quot;')})" class="bg-yellow-100 text-yellow-900 px-2 py-1 rounded">âœï¸ Bearbeiten</button>
            <button onclick="deleteHut('${doc.id}')" class="bg-red-100 text-red-900 px-2 py-1 rounded">ğŸ—‘ï¸ LÃ¶schen</button>
          </div>
        </div>
      `;
      chatWindow.appendChild(container);

      // Mini-Karte initialisieren
      if (d.location && d.location.latitude && d.location.longitude) {
        const mapDiv = document.getElementById(`minimap-${doc.id}`);
        const m = L.map(mapDiv, { zoomControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false }).setView([d.location.latitude, d.location.longitude], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([d.location.latitude, d.location.longitude]).addTo(m);
        setTimeout(() => m.invalidateSize(), 200);
      }
    });
  }).catch(err => addMessage('âš ï¸ Fehler beim Laden deiner HÃ¼tten: ' + err.message, 'bot'));
}

function updateStatus(hutId, newStatus) {
  db.collection('eierhuetten').doc(hutId).update({ status: newStatus }).then(() => {
    addMessage(`âœ… Status aktualisiert: ${newStatus}`, 'bot');
  });
}
</script></body>
</html>
