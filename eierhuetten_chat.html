<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten Assistent Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 75%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    button.choice-btn { background: #e0f2fe; border: 1px solid #0284c7; color: #0369a1; padding: 0.3rem 0.7rem; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem; }
    button.choice-btn:hover { background: #bae6fd; }
    .hidden { display: none; }
    #map, .preview-map { width: 100%; height: 300px; margin-top: 1rem; border-radius: 0.5rem; }
  </style>
</head>
<body class="p-6"><div id="login-section" class="max-w-md mx-auto text-center">
  <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
    Mit Google anmelden
  </button>
</div><section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">
  <div class="text-center font-bold text-2xl text-green-700 mb-4">ü•ö Eierh√ºtten Assistent Chat</div>
  <div id="chat-window" aria-live="polite" role="log"></div>
  <div id="input-area">
    <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
    <button id="send-btn">Senden</button>
  </div>
</section><script>
const adminEmail = "admin@eierhuette.de";
let isAdminMode = false;

function handleAdminCommand(txt) {
  const input = txt.toLowerCase().trim();
  if (input === "/admin on") {
    if (currentUser?.email === adminEmail) {
      isAdminMode = true;
      addMessage("üîí Admin-Modus aktiviert.", 'bot');
      showAllHutsForAdmin();
    } else {
      addMessage("‚ùå Du bist nicht berechtigt, den Admin-Modus zu aktivieren.", 'bot');
    }
    return true;
  }
  if (input === "/admin off") {
    isAdminMode = false;
    addMessage("üîì Admin-Modus deaktiviert. Zur√ºck zum Benutzer-Modus.", 'bot');
    startDialog();
    return true;
  }
  if (isAdminMode) {
    if (input === "/delete all") {
      const confirm = prompt("‚ö†Ô∏è Bist du sicher, dass du ALLE H√ºtten l√∂schen m√∂chtest? Tippe JA zum Best√§tigen.");
      if (confirm === "JA") {
        db.collection("eierhuetten").get().then(snapshot => {
          const batch = db.batch();
          snapshot.forEach(doc => batch.delete(doc.ref));
          batch.commit().then(() => addMessage("üóëÔ∏è Alle H√ºtten wurden gel√∂scht.", 'bot'));
        });
      } else {
        addMessage("Abgebrochen. Es wurden keine Daten gel√∂scht.", 'bot');
      }
    }
    return true;
  }
  return false;
}

function showAllHutsForAdmin() {
  chatWindow.innerHTML = '';
  addMessage('üõ†Ô∏è Alle eingereichten H√ºtten:', 'bot');
  db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get().then(snapshot => {
    if (snapshot.empty) return addMessage('Keine H√ºtten gefunden.', 'bot');
    snapshot.forEach(doc => {
      const h = doc.data();
      const id = doc.id;
      const coords = h.location ? `${h.location.latitude.toFixed(5)}, ${h.location.longitude.toFixed(5)}` : '-';
      const div = document.createElement('div');
      div.className = 'message bot';
      div.innerHTML = `
        <div class="p-3 border border-gray-300 bg-gray-50 rounded text-sm space-y-1">
          <div><strong>Name:</strong> ${h.name}</div>
          <div><strong>Sitzpl√§tze:</strong> ${h.sitzplaetze}</div>
          <div><strong>Strom:</strong> ${h.strom}</div>
          <div><strong>Extras:</strong> ${h.extras}</div>
          <div><strong>Status:</strong> ${h.status}</div>
          <div><strong>Koordinaten:</strong> ${coords}</div>
          <div class="flex gap-2 mt-2">
            <button onclick="updateStatus('${id}')" class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üü¢ Status √§ndern</button>
            <button onclick="editHut('${id}')" class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">‚úèÔ∏è Bearbeiten</button>
            <button onclick="deleteHut('${id}')" class="bg-red-100 text-red-800 px-2 py-1 rounded">üóëÔ∏è L√∂schen</button>
          </div>
        </div>`;
      chatWindow.appendChild(div);
    });
  });
}

function updateStatus(id) {
  const status = prompt("Neuen Status eingeben (z.‚ÄØB. offen, angenommen, abgelehnt):");
  if (status) {
    db.collection('eierhuetten').doc(id).update({ status }).then(() => {
      addMessage(`‚úÖ Status aktualisiert auf: ${status}`, 'bot');
      showAllHutsForAdmin();
    });
  }
}

function editHut(id) {
  const neuesFeld = prompt("Welches Feld m√∂chtest du bearbeiten? (name, strom, sitzplaetze, extras)");
  const neuerWert = prompt("Gib den neuen Wert ein:");
  if (neuesFeld && neuerWert) {
    db.collection('eierhuetten').doc(id).update({ [neuesFeld]: neuerWert }).then(() => {
      addMessage(`‚úèÔ∏è Feld '${neuesFeld}' aktualisiert.`, 'bot');
      showAllHutsForAdmin();
    });
  }
}

function deleteHut(id) {
  const conf = confirm("‚ö†Ô∏è M√∂chtest du diese H√ºtte wirklich l√∂schen?");
  if (conf) {
    db.collection('eierhuetten').doc(id).delete().then(() => {
      addMessage("üóëÔ∏è H√ºtte gel√∂scht.", 'bot');
      showAllHutsForAdmin();
    });
  }
}

// ‚ú® ADMIN COMMAND PRECHECK
sendBtn.onclick = () => {
  const txt = chatInput.value.trim();
  if (!txt) return;
  if (handleAdminCommand(txt)) return;
  processUserInput(txt);
};

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const txt = chatInput.value.trim();
    if (!txt) return;
    if (handleAdminCommand(txt)) return;
    processUserInput(txt);
  }
});
</script></body>
</html>
