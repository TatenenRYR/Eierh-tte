<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Eierh√ºtten Chat-Einreichung</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #chat { max-width: 600px; margin: auto; padding: 1rem; }
    .message { margin: 1rem 0; padding: 0.8rem; border-radius: 12px; max-width: 80%; }
    .user { background: #def; align-self: flex-end; }
    .bot { background: #eee; align-self: flex-start; }
    #messages { display: flex; flex-direction: column; }
    #input-container { display: flex; gap: 0.5rem; margin-top: 1rem; }
    #map { height: 300px; margin-top: 1rem; }
    #debug { background: #111; color: #0f0; padding: 0.5rem; font-family: monospace; display: none; }
    #summary { background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
  </style>
</head>
<body>
  <div id="chat">
    <button onclick="loginWithGoogle()">üîê Mit Google anmelden</button>
    <div id="messages"></div>
    <div id="map"></div>
    <div id="input-container">
      <input id="user-input" placeholder="Antwort..." />
      <button onclick="handleUserInput()">Senden</button>
    </div>
    <div id="summary" style="display:none;"></div>
    <button onclick="toggleDebug()">ü™õ Debug anzeigen</button>
    <div id="debug"></div>
  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
      measurementId: "G-16V6K5GXDT"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;

    function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(result => {
        currentUser = result.user;
        debug(`Angemeldet als ${currentUser.displayName} (${currentUser.uid})`);
        showMessage(`Hallo ${currentUser.displayName}! Ich helfe dir beim Einreichen deiner Eierh√ºtte.`, 'bot');
        askNext();
      }).catch(err => alert("Fehler beim Login: " + err.message));
    }

    let formData = {
      name: '',
      extras: '',
      strom: '',
      location: null,
      ort: '',
      beschreibung: ''
    };
    let step = 0;

    function handleUserInput() {
      const input = document.getElementById('user-input');
      const text = input.value.trim();
      if (!text) return;
      showMessage(text, 'user');
      input.value = '';
      processInput(text);
    }

    function processInput(text) {
      switch (step) {
        case 0:
          formData.name = text;
          step++;
          askNext();
          break;
        case 1:
          formData.strom = text.toLowerCase().includes("ja") ? "ja" : "nein";
          step++;
          askNext();
          break;
        case 2:
          formData.extras = text;
          generateKIBeschreibung();
          step++;
          askNext();
          break;
      }
    }

    function askNext() {
      const fragen = [
        "Wie hei√üt deine Eierh√ºtte?",
        "Gibt es eine Stromversorgung f√ºr E-Bikes? (Ja/Nein)",
        "M√∂chtest du noch etwas hinzuf√ºgen? (z.B. Besonderheiten, Tipps)",
        "Bitte w√§hle den Standort auf der Karte oder nutze den Button f√ºr deinen aktuellen Standort."
      ];
      if (step < fragen.length) {
        showMessage(fragen[step], 'bot');
        if (step === 3) {
          document.getElementById('input-container').style.display = 'none';
          initMap();
        }
      }
    }

    function showMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      document.getElementById('messages').appendChild(msg);
    }

    function toggleDebug() {
      const dbg = document.getElementById('debug');
      dbg.style.display = dbg.style.display === 'none' ? 'block' : 'none';
    }

    function debug(msg) {
      document.getElementById('debug').innerText += `\n${msg}`;
    }

    async function generateKIBeschreibung() {
      const prompt = `Erstelle eine kurze freundliche Beschreibung f√ºr eine Eierh√ºtte mit dem Namen "${formData.name}", ${formData.strom === "ja" ? "Stromversorgung vorhanden" : "keine Stromversorgung"} und folgendem Hinweis: ${formData.extras}`;
      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + localStorage.getItem("openrouter-key"),
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "mistralai/mistral-7b-instruct:free",
            messages: [
              { role: "system", content: "Du bist ein hilfsbereiter Textgenerator f√ºr eine Eierh√ºtten-App." },
              { role: "user", content: prompt }
            ]
          })
        });
        const data = await response.json();
        formData.beschreibung = data.choices?.[0]?.message?.content || "Beschreibung folgt.";
        debug("Beschreibung generiert:", formData.beschreibung);
      } catch (e) {
        debug("Fehler bei Beschreibung:", e.message);
      }
    }

    function initMap() {
      const map = L.map('map').setView([48.5, 9], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      const marker = L.marker([48.5, 9], { draggable: true }).addTo(map);
      formData.location = { lat: 48.5, lng: 9 };
      marker.on('dragend', () => {
        formData.location = marker.getLatLng();
        debug(`Standort gew√§hlt: ${JSON.stringify(formData.location)}`);
        finalizeSubmission();
      });

      const btn = document.createElement('button');
      btn.textContent = "üìç Aktueller Standort";
      btn.onclick = () => {
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          formData.location = { lat: latitude, lng: longitude };
          marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude], 15);
          debug("Aktueller Standort √ºbernommen.");
          finalizeSubmission();
        });
      };
      document.getElementById('map').appendChild(btn);
    }

    function finalizeSubmission() {
      document.getElementById('map').style.display = 'none';
      document.getElementById('input-container').style.display = 'none';
      showMessage("Hier ist eine √úbersicht deiner Angaben:", 'bot');
      const summary = document.getElementById('summary');
      summary.style.display = 'block';
      summary.innerHTML = `
        <b>Name:</b> ${formData.name}<br>
        <b>Strom:</b> ${formData.strom}<br>
        <b>Extras:</b> ${formData.extras}<br>
        <b>Standort:</b> ${formData.location.lat.toFixed(4)}, ${formData.location.lng.toFixed(4)}<br>
        <b>Beschreibung:</b><br>${formData.beschreibung}<br><br>
        <button onclick="submitToFirestore()">‚úÖ Einreichen</button>
        <button onclick="window.location.reload()">‚ùå Abbrechen</button>
      `;
    }

    async function submitToFirestore() {
      if (!currentUser) return alert("Nicht angemeldet.");
      await db.collection("eierhuetten").add({
        ...formData,
        userId: currentUser.uid,
        erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
        status: "offen",
        history: [new Date().toLocaleString() + ': Erstellt']
      });
      alert("Anfrage eingereicht!");
      window.location.reload();
    }
  </script></body>
</html>
