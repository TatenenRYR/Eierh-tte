<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EierhÃ¼tten-Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-sm"><!-- Login --><div id="login-section" class="p-6 text-center">
  <button id="google-login" class="bg-red-600 text-white px-4 py-2 rounded">Mit Google anmelden</button>
</div><!-- Chat und Formular --><section id="chat-section" class="hidden max-w-3xl mx-auto bg-white rounded-xl shadow p-4 mt-6">
  <div class="flex justify-between items-center border-b pb-2 mb-4">
    <h2 class="text-xl font-bold text-green-700">ğŸ¥š EierhÃ¼tten-Assistent</h2>
  </div>  <!-- API Key -->  <div id="key-input-section" class="mb-4">
    <input id="chat-api-key" placeholder="OpenRouter API-Key eingeben" class="border px-3 py-2 w-full rounded">
    <button onclick="saveChatKey()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Key speichern</button>
  </div>  <div id="chat-window" class="h-80 overflow-y-auto mb-4 space-y-2"></div>
  <div id="input-row" class="flex gap-2">
    <input id="chat-input" class="flex-grow border px-3 py-2 rounded" placeholder="Nachricht...">
    <button onclick="sendeNachricht()" class="bg-green-600 text-white px-4 py-2 rounded">Senden</button>
  </div>
</section><!-- Eigene HÃ¼tten anzeigen --><section id="meine-huetten" class="hidden max-w-5xl mx-auto mt-12">
  <h2 class="text-2xl font-bold mb-4">ğŸ§º Deine eingereichten EierhÃ¼tten</h2>
  <div id="huetten-liste" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
</section><script>
// Firebase Konfiguration
const firebaseConfig = { /* ...Firebase-Konfiguration hier einfÃ¼gen... */ };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore();

let currentUser, OPENROUTER_KEY = localStorage.getItem('openrouter_api_key');

// Google Login
async function handleLogin() {
  const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  currentUser = result.user;
  document.getElementById('login-section').classList.add('hidden');
  document.getElementById('chat-section').classList.remove('hidden');
  if (!OPENROUTER_KEY) document.getElementById('key-input-section').classList.remove('hidden');
  else document.getElementById('key-input-section').classList.add('hidden');
  showMsg(`Willkommen ${currentUser.displayName}! Wie soll deine HÃ¼tte heiÃŸen?`, 'bot');
}

function saveChatKey() {
  const key = document.getElementById('chat-api-key').value.trim();
  if (key.length > 20) {
    localStorage.setItem('openrouter_api_key', key);
    OPENROUTER_KEY = key;
    document.getElementById('key-input-section').classList.add('hidden');
  }
}

// Nachrichtenanzeige
function showMsg(msg, sender = 'bot') {
  const d = document.createElement('div');
  d.className = sender === 'user' ? 'text-right bg-green-100 p-2 rounded' : 'bg-gray-200 p-2 rounded';
  d.textContent = msg;
  document.getElementById('chat-window').appendChild(d);
  document.getElementById('chat-window').scrollTop = chatWindow.scrollHeight;
}

// Ablaufsteuerung
let step = 0, formData = {}, marker;
async function sendeNachricht() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  showMsg(text, 'user');
  input.value = '';
  if (step === 0) {
    formData.name = text;
    showMsg('Bitte wÃ¤hle den Standort auf der Karte.', 'bot');
    initMap();
    step++;
  } else if (step === 1) {
    formData.sitzplatz = text.toLowerCase();
    showMsg('Gibt es Strom? (ja/nein)', 'bot');
    step++;
  } else if (step === 2) {
    formData.strom = text.toLowerCase();
    showMsg('Sonstige Besonderheiten?', 'bot');
    step++;
  } else if (step === 3) {
    formData.extras = text;
    showSummary();
  }
}

function initMap() {
  document.getElementById('input-row').style.display = 'none';
  const mapDiv = document.createElement('div');
  mapDiv.id = 'map';
  mapDiv.style.height = '300px';
  document.getElementById('chat-section').appendChild(mapDiv);
  const map = L.map('map').setView([51, 10], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  navigator.geolocation?.getCurrentPosition(p => map.setView([p.coords.latitude, p.coords.longitude], 15));
  map.on('click', e => {
    formData.loc = e.latlng;
    if (marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng).addTo(map);
    map.remove();
    mapDiv.remove();
    document.getElementById('input-row').style.display = 'flex';
    showMsg('Standort gespeichert. Gibt es SitzplÃ¤tze?', 'bot');
    step = 1;
  });
}

async function showSummary() {
  const summary = `Name: ${formData.name}\nStandort: ${formData.loc?.lat.toFixed(4)}, ${formData.loc?.lng.toFixed(4)}\nSitzplatz: ${formData.sitzplatz}\nStrom: ${formData.strom}\nExtras: ${formData.extras}`;
  showMsg('Zusammenfassung:\n' + summary, 'bot');
  showMsg('Beschreibung wird erstellt...', 'bot');
  const prompt = `Erstelle eine ansprechende Beschreibung fÃ¼r eine EierhÃ¼tte namens ${formData.name} mit ${formData.sitzplatz === 'ja' ? 'SitzplÃ¤tzen' : 'keinen SitzplÃ¤tzen'} und ${formData.strom === 'ja' ? 'Stromanschluss' : 'ohne Strom'}${formData.extras ? '. Besonderheiten: ' + formData.extras : ''}.`;
  const response = await fetch('https://us-central1-eierhuettentour.cloudfunctions.net/chatWithOpenRouter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: prompt, key: OPENROUTER_KEY })
  }).then(r => r.json());
  formData.beschreibung = response.reply;
  showMsg('Beschreibung: ' + formData.beschreibung, 'bot');
  const btn = document.createElement('button');
  btn.textContent = 'Einreichen';
  btn.className = 'mt-2 bg-green-700 text-white px-4 py-2 rounded';
  btn.onclick = async () => {
    await db.collection('eierhuetten').add({ ...formData, userId: currentUser.uid, erstelltAm: firebase.firestore.FieldValue.serverTimestamp(), status: 'offen' });
    showMsg('âœ… Eingereicht!', 'bot');
  };
  document.getElementById('chat-window').appendChild(btn);
}

// Meine HÃ¼tten anzeigen
async function ladeMeineHuetten() {
  const snap = await db.collection('eierhuetten').where('userId', '==', currentUser.uid).orderBy('erstelltAm', 'desc').get();
  const container = document.getElementById('huetten-liste');
  document.getElementById('meine-huetten').classList.remove('hidden');
  snap.forEach(doc => {
    const h = doc.data();
    const card = document.createElement('div');
    card.className = 'bg-white p-4 rounded shadow';
    card.innerHTML = `<h3 class='font-bold text-lg mb-1'>${h.name}</h3><p>${h.beschreibung}</p><p class='mt-1 text-sm text-gray-500'>Status: ${h.status}</p>`;
    container.appendChild(card);
  });
}

document.getElementById('google-login').onclick = handleLogin;
</script></body>
</html>
