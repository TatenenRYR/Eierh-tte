<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eierh√ºtten Upload ‚Äì KI+GPS</title>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {{ background: #121212; color: #eee; font-family: sans-serif; }}
    #chat {{ max-width: 600px; margin: 2rem auto; background: #1e1e1e; border-radius: 10px; padding: 1rem; }}
    #messages {{ max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }}
    .msg {{ padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; }}
    .bot {{ background: #2c2c2c; }}
    .user {{ background: #1abc9c; color: #000; text-align: right; }}
    #map {{ height: 250px; margin-top: 1rem; display: none; }}
    button {{ background: #1abc9c; border: none; padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 5px; cursor: pointer; }}
    input, #send {{ padding: 0.5rem; border-radius: 4px; border: none; width: calc(100% - 90px); }}
    form {{ display: flex; gap: 0.5rem; }}
  </style>
</head>
<body>
<div id="chat">
  <div id="messages"></div>
  <form id="form">
    <input id="input" placeholder="Nachricht eingeben‚Ä¶" />
    <button id="send" type="submit">Senden</button>
  </form>
  <button onclick="standortSenden()">üìç Standort senden</button>
  <div id="map"></div>
</div>

<script>
const openaiKey = "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";

const firebaseConfig = {{
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
}};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let state = null;
let hutData = {{}};
let marker;
let map = L.map('map').setView([51.1657, 10.4515], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

auth.onAuthStateChanged(user => {{
  if (!user) alert('Bitte melde dich in Firebase an.');
  hutData.userId = user.uid;
}});

document.getElementById('form').addEventListener('submit', async e => {{
  e.preventDefault();
  const input = document.getElementById('input');
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, 'user');
  input.value = '';

  if (!state) {{
    hutData = {{
      userId: firebase.auth().currentUser.uid,
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'offen'
    }};
    state = 'awaiting_name';
    addMessage('Wie hei√üt die H√ºtte?');
    return;
  }}

  if (state === 'awaiting_name') {{
    hutData.name = msg;
    state = 'awaiting_description';
    addMessage('Beschreibe die H√ºtte. (Oder schreibe "Vorschlag", um die KI zu nutzen)');
    return;
  }}

  if (state === 'awaiting_description') {{
    if (msg.toLowerCase().includes("vorschlag")) {{
      addMessage('‚è≥ Beschreibung wird von der KI erstellt...');
      hutData.beschreibung = await beschreibungMitKI(hutData.name);
      addMessage('‚úÖ KI-Beschreibung: ' + hutData.beschreibung);
    }} else {{
      hutData.beschreibung = msg;
    }}
    state = 'awaiting_strom';
    addMessage('Gibt es Strom an der H√ºtte?');
    return;
  }}

  if (state === 'awaiting_strom') {{
    addMessage('‚è≥ Frage wird an KI gesendet...');
    const strom = await checkStromMitKI(msg);
    if (strom === null) {{
      addMessage('Antwort unklar. Bitte versuche es mit "Ja" oder "Nein".');
      return;
    }}
    hutData.strom = strom;
    state = 'awaiting_location';
    document.getElementById('map').style.display = 'block';
    map.invalidateSize();
    addMessage('üìç Karte anzeigen. Klick auf einen Punkt oder nutze "Standort senden".');
    return;
  }}
}});

map.on('click', async e => {{
  if (state !== 'awaiting_location') return;
  if (marker) map.removeLayer(marker);
  marker = L.marker(e.latlng).addTo(map);
  hutData.location = new firebase.firestore.GeoPoint(e.latlng.lat, e.latlng.lng);
  await db.collection('eierhuetten').add(hutData);
  addMessage('‚úÖ H√ºtte gespeichert. Danke!');
  state = null;
}});

function standortSenden() {{
  if (!navigator.geolocation) {{
    addMessage('‚ùå GPS nicht verf√ºgbar');
    return;
  }}
  navigator.geolocation.getCurrentPosition(pos => {{
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    map.setView(latlng, 15);
    if (marker) map.removeLayer(marker);
    marker = L.marker(latlng).addTo(map);
    hutData.location = new firebase.firestore.GeoPoint(latlng[0], latlng[1]);
    addMessage('üìç Standort gesetzt. Du kannst ihn durch Klick auf die Karte noch √§ndern.');
  }}, () => {{
    addMessage('‚ùå Standortzugriff verweigert');
  }});
}}

function addMessage(text, cls='bot') {{
  const msgEl = document.createElement('div');
  msgEl.textContent = text;
  msgEl.className = `msg ${cls}`;
  document.getElementById('messages').appendChild(msgEl);
  document.getElementById('messages').scrollTop = 9999;
}}

async function checkStromMitKI(userInput) {{
  const prompt = `Beantworte nur mit true oder false: Gibt es Strom an der H√ºtte? Der Benutzer sagt: "${userInput}"`;
  try {{
    const res = await fetch("https://api.openai.com/v1/completions", {{
      method: "POST",
      headers: {{
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiKey}`
      }},
      body: JSON.stringify({{
        model: "text-davinci-003",
        prompt,
        max_tokens: 5,
        temperature: 0
      }})
    }});
    const data = await res.json();
    const reply = data.choices?.[0]?.text?.trim().toLowerCase();
    if (reply.includes("true")) return true;
    if (reply.includes("false")) return false;
    return null;
  }} catch (e) {{
    addMessage('OpenAI-Fehler: ' + e.message);
    return null;
  }}
}}

async function beschreibungMitKI(hutName) {{
  const prompt = `Beschreibe in 1‚Äì2 S√§tzen eine H√ºtte namens "${hutName}" f√ºr Radfahrer, z.‚ÄØB. was man dort vorfindet.`;
  try {{
    const res = await fetch("https://api.openai.com/v1/completions", {{
      method: "POST",
      headers: {{
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiKey}`
      }},
      body: JSON.stringify({{
        model: "text-davinci-003",
        prompt,
        max_tokens: 100,
        temperature: 0.7
      }})
    }});
    const data = await res.json();
    return data.choices?.[0]?.text?.trim() || "";
  }} catch (e) {{
    addMessage('Fehler bei Beschreibung: ' + e.message);
    return "Eine sch√∂ne Rastm√∂glichkeit f√ºr Radfahrer.";
  }}
}}
</script>
</body>
</html>
