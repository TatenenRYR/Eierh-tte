<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eierh√ºtten melden</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; background: #f8f8f8; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
    #chat { width: 100%; max-width: 600px; margin-top: 1rem; background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #messages { min-height: 200px; margin-bottom: 1rem; display: flex; flex-direction: column; }
    .msg { padding: .5rem .75rem; margin: .25rem 0; border-radius: .75rem; max-width: 80%; white-space: pre-wrap; }
    .user { background: #dcf8c6; align-self: flex-end; }
    .bot { background: #f1f0f0; align-self: flex-start; }
    #map { height: 300px; width: 100%; margin-bottom: 1rem; display: none; border-radius: 1rem; }
    input, button { padding: .5rem; font-size: 1rem; margin-top: .5rem; width: 100%; border-radius: .5rem; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
    .buttons { display: flex; gap: .5rem; }
    .buttons button { flex: 1; margin-top: .5rem; }
  </style>
</head>
<body>
<div id="chat">
  <div id="messages"></div>
  <input id="userInput" placeholder="Antwort eingeben...">
  <div class="buttons">
    <button onclick="sendMessage()">Antwort senden</button>
    <button onclick="getLocation()">üìç Standort senden</button>
    <button onclick="neustart()">Neu starten</button>
  </div>
  <div id="map"></div>
</div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
let dialogState = 'awaiting_description';
let hutData = {};
let map, marker;
const mapEl = document.getElementById('map');
const messagesEl = document.getElementById('messages');
const openaiKey = "sk-proj-..."; // DEIN API KEY

function addMessage(text, sender = 'bot') {
  const msg = document.createElement('div');
  msg.className = 'msg ' + sender;
  msg.textContent = text;
  messagesEl.appendChild(msg);
  msg.scrollIntoView();
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, 'user');
  input.value = '';
  handleMessage(msg);
}

function neustart() {
  dialogState = 'awaiting_description';
  hutData = {};
  messagesEl.innerHTML = '';
  marker?.remove();
  mapEl.style.display = 'none';
  addMessage('Bitte beschreibe die H√ºtte oder gib einen kurzen Hinweis.');
}

async function handleMessage(msg) {
  if (msg.toLowerCase().includes("√ºberspringen") || msg.toLowerCase().includes("wei√ü ich nicht")) {
    if (dialogState === 'awaiting_location') {
      mapEl.style.display = 'block'; initMap(); addMessage('üìç Klicke auf die Karte oder nutze ‚ÄûStandort senden‚Äú.');
      return;
    }
    dialogState = nextState(dialogState);
    askNext();
    return;
  }

  switch(dialogState) {
    case 'awaiting_description': hutData.beschreibung = msg; break;
    case 'awaiting_strom': hutData.strom = await kiErkenneJaNein('strom', 'Gibt es Strom?', msg); break;
    case 'awaiting_verkauf': hutData.verkauf = await kiErkenneJaNein('verkauf', 'Gibt es einen Verkauf?', msg); break;
    case 'awaiting_sitzplatz': hutData.sitzplatz = await kiErkenneJaNein('sitzplatz', 'Gibt es Sitzpl√§tze?', msg); break;
    case 'awaiting_ueberdacht': hutData.ueberdacht = await kiErkenneJaNein('ueberdacht', 'Ist die H√ºtte √ºberdacht?', msg); break;
  }

  if (dialogState !== 'awaiting_location') {
    dialogState = nextState(dialogState);
    askNext();
  } else {
    mapEl.style.display = 'block'; initMap(); addMessage('üìç Klicke auf die Karte oder nutze ‚ÄûStandort senden‚Äú.');
  }
}

function nextState(current) {
  const states = ['awaiting_description','awaiting_strom','awaiting_verkauf','awaiting_sitzplatz','awaiting_ueberdacht','awaiting_location'];
  return states[states.indexOf(current)+1];
}

function askNext() {
  const fragen = {
    awaiting_strom: 'Gibt es Strom (z.‚ÄØB. f√ºr E-Bikes)?',
    awaiting_verkauf: 'Gibt es etwas zu kaufen (Eier, Snacks)?',
    awaiting_sitzplatz: 'Gibt es eine Sitzgelegenheit?',
    awaiting_ueberdacht: 'Ist die H√ºtte √ºberdacht?'
  };
  if (fragen[dialogState]) addMessage(fragen[dialogState]);
}

async function kiErkenneJaNein(feldName, frage, userInput) {
  const prompt = `Beantworte nur mit true oder false: ${frage} Der Benutzer sagt: "${userInput}"`;
  try {
    const res = await fetch("https://api.openai.com/v1/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${openaiKey}` },
      body: JSON.stringify({ model: "text-davinci-003", prompt, max_tokens: 5, temperature: 0 })
    });
    const data = await res.json();
    const reply = data?.choices?.[0]?.text?.trim().toLowerCase();
    if (reply?.includes("true")) return true;
    if (reply?.includes("false")) return false;
  } catch (e) { addMessage(`‚ùå KI-Fehler: ${e.message}`); }

  const t = userInput.toLowerCase();
  const p = { strom:["ja","strom","steckdose","e-bike"], verkauf:["eier","verkauf","snack","automat"], sitzplatz:["bank","tisch","stuhl","b√§nke","sitzplatz","hocker","platz","sitzen"], ueberdacht:["dach","√ºberdacht","unterstand"] };
  const n = { strom:["kein","nein"], verkauf:["leer","nichts","nein"], sitzplatz:["keine","nicht","nein"], ueberdacht:["nicht","kein","nein"] };
  if (n[feldName]?.some(w=>t.includes(w))) return false;
  if (p[feldName]?.some(w=>t.includes(w))) return true;
  addMessage(`‚ùì Ich konnte nicht erkennen, ob "${feldName}" zutrifft. Bitte antworte mit ‚Äûja‚Äú, ‚Äûnein‚Äú oder schreibe z.‚ÄØB. ‚Äûes gibt eine Bank‚Äú. Du kannst auch ‚Äû√ºberspringen‚Äú schreiben.`);
  return null;
}

function getLocation() {
  navigator.geolocation.getCurrentPosition(pos => setLocation(pos.coords.latitude, pos.coords.longitude),
    () => addMessage('‚ùå Standortzugriff verweigert'));
}

function initMap() {
  if (map) return;
  map = L.map('map').setView([51.1657, 10.4515], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.on('click', e => setLocation(e.latlng.lat, e.latlng.lng));
}

function setLocation(lat, lon) {
  if (!map) initMap();
  if (marker) marker.setLatLng([lat, lon]);
  else marker = L.marker([lat, lon]).addTo(map);
  map.setView([lat, lon], 17);
  hutData.lat = lat;
  hutData.lon = lon;
  zeigeZusammenfassung();
}

async function zeigeZusammenfassung() {
  const prompt = `Erstelle eine sch√∂ne, kurze Beschreibung f√ºr folgende Eierh√ºtte auf Deutsch. 
Beschreibung: ${hutData.beschreibung}
Strom: ${hutData.strom ? "ja" : "nein"}
Verkauf: ${hutData.verkauf ? "ja" : "nein"}
Sitzplatz: ${hutData.sitzplatz ? "ja" : "nein"}
√úberdacht: ${hutData.ueberdacht ? "ja" : "nein"}
Koordinaten: ${hutData.lat}, ${hutData.lon}`;
  try {
    const res = await fetch("https://api.openai.com/v1/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${openaiKey}` },
      body: JSON.stringify({ model: "text-davinci-003", prompt, max_tokens: 150, temperature: 0.7 })
    });
    const data = await res.json();
    const reply = data?.choices?.[0]?.text?.trim();
    if (reply) addMessage("üìç Zusammenfassung:\n" + reply);
    else addMessage("‚ùå Beschreibung konnte nicht erzeugt werden.");
  } catch (e) {
    addMessage("‚ùå Fehler beim Erzeugen der Beschreibung: " + e.message);
  }
}

// Start
addMessage('Bitte beschreibe die H√ºtte oder gib einen kurzen Hinweis.');
</script></body>
</html>
