<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eierh√ºtten Assistent</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Login -->
<div id="login-section" class="text-center p-6">
  <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded">
    Mit Google anmelden
  </button>
</div>

<!-- Chat-Bereich -->
<section id="chat-section" class="max-w-3xl mx-auto mt-8 bg-white shadow-lg rounded-xl overflow-hidden hidden">
  <div class="bg-green-600 text-white text-xl font-bold p-4">ü•ö Eierh√ºtten Assistent</div>
  <div id="chat-window" class="p-4 h-96 overflow-y-auto space-y-4 text-sm bg-gray-50"></div>
  <div class="p-4 border-t flex gap-2">
    <input id="chat-input" type="text" class="flex-grow border border-gray-300 rounded px-3 py-2" placeholder="Schreibe eine Nachricht...">
    <button onclick="sendeNachricht()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Senden</button>
  </div>
</section>

<!-- Bereich f√ºr hochgeladene H√ºtten -->
<section id="meine-huetten" class="max-w-5xl mx-auto mt-12 hidden">
  <h2 class="text-2xl font-bold mb-4">üß∫ Deine eingereichten Eierh√ºtten</h2>
  <div id="huetten-liste" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
</section>

<!-- Button zum Anzeigen der Liste -->
<div class="text-center mt-6">
  <button onclick="ladeMeineHuetten(currentUser?.uid)" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
    Meine H√ºtten ansehen
  </button>
</div>

<!-- Styles (Chat-Optik) -->
<style>
  #chat-window .user {
    text-align: right;
    background-color: #d1fae5;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    display: inline-block;
    max-width: 80%;
  }
  #chat-window .bot {
    background-color: #f1f5f9;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    display: inline-block;
    max-width: 80%;
  }
</style>

<!-- Firebase Config -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
</script>

<!-- Chat & Nutzerlogik -->
<script>
let currentUser = null;

document.getElementById("google-login").onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await firebase.auth().signInWithPopup(provider);
    currentUser = result.user;
    document.getElementById("chat-section").classList.remove("hidden");
    document.getElementById("login-section").classList.add("hidden");
    zeigeNachricht(`Hallo ${currentUser.displayName}! Ich helfe dir beim Einreichen deiner H√ºtte.`, "bot");
  } catch (error) {
    alert("Login fehlgeschlagen: " + error.message);
  }
};

const chatWindow = document.getElementById("chat-window");
const input = document.getElementById("chat-input");

function sendeNachricht() {
  const text = input.value.trim();
  if (!text) return;
  zeigeNachricht(text, "user");
  input.value = "";
  setTimeout(() => {
    zeigeNachricht("Danke f√ºr deine Nachricht! Ich helfe dir bei der H√ºttenerstellung.", "bot");
  }, 500);
}

function zeigeNachricht(text, sender) {
  const div = document.createElement("div");
  div.className = sender;
  div.innerText = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}
</script>

<!-- H√ºttenabfrage -->
<script>
async function ladeMeineHuetten(uid) {
  if (!uid) {
    alert("Bitte zuerst mit Google einloggen.");
    return;
  }
  const container = document.getElementById("huetten-liste");
  container.innerHTML = "<p>‚è≥ Lade deine Eintr√§ge...</p>";
  document.getElementById("meine-huetten").classList.remove("hidden");
  try {
    const snapshot = await firebase.firestore()
      .collection("eierhuetten")
      .where("userId", "==", uid)
      .orderBy("erstelltAm", "desc")
      .get();
    container.innerHTML = "";
    if (snapshot.empty) {
      container.innerHTML = "<p>‚ùå Du hast noch keine H√ºtten eingereicht.</p>";
      return;
    }
    snapshot.forEach(doc => {
      const h = doc.data();
      const div = document.createElement("div");
      div.className = "bg-white rounded-xl shadow-md p-4 border border-gray-200";
      div.innerHTML = `
        <h3 class="text-lg font-bold text-green-700">${h.name || "Unbenannte H√ºtte"}</h3>
        <p><strong>Status:</strong> ${h.status || "offen"}</p>
        ${h.ort ? `<p><strong>Ort:</strong> ${h.ort}</p>` : ""}
        ${h.beschreibung ? `<p><strong>Beschreibung:</strong> ${h.beschreibung}</p>` : ""}
        <p><strong>Strom:</strong> ${h.strom || "‚Äî"}</p>
        <p><strong>Sitzplatz:</strong> ${h.sitzplatz || "‚Äî"}</p>
        <p><strong>√úberdacht:</strong> ${h.ueberdacht || "‚Äî"}</p>
        <p class="text-sm text-gray-500 mt-2">‚è±Ô∏è Eingereicht: ${h.erstelltAm?.toDate().toLocaleString()}</p>
      `;
      container.appendChild(div);
    });
  } catch (error) {
    container.innerHTML = `<p class='text-red-600'>Fehler beim Laden: ${error.message}</p>`;
  }
}
</script>

</body>
</html>
