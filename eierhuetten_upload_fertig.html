<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eierh√ºtten melden</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; background: #f8f8f8; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
    #chat { width: 100%; max-width: 600px; margin-top: 1rem; background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #messages { min-height: 200px; margin-bottom: 1rem; }
    .msg { padding: .5rem .75rem; margin: .25rem 0; border-radius: .75rem; max-width: 80%; }
    .user { background: #dcf8c6; align-self: flex-end; }
    .bot { background: #f1f0f0; align-self: flex-start; }
    #map { height: 300px; width: 100%; margin-bottom: 1rem; display: none; border-radius: 1rem; }
    input, button { padding: .5rem; font-size: 1rem; margin-top: .5rem; width: 100%; border-radius: .5rem; border: 1px solid #ccc; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
  </style>
</head>
<body>
<div id="chat">
  <div id="messages"></div>
  <input id="userInput" placeholder="Antwort eingeben...">
  <button onclick="sendMessage()">Antwort senden</button>
  <button onclick="getLocation()">üìç Standort senden</button>
  <button onclick="neustart()">Neu starten</button>
  <div id="map"></div>
</div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
let dialogState = 'awaiting_description';
let hutData = {};
let map, marker;
const mapEl = document.getElementById('map');
const openaiKey = "sk-proj-..."; // <-- DEIN API KEY

function addMessage(text, sender = 'bot') {
  const msg = document.createElement('div');
  msg.className = 'msg ' + sender;
  msg.textContent = text;
  document.getElementById('messages').appendChild(msg);
  msg.scrollIntoView();
}

function sendMessage() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return;
  addMessage(msg, 'user');
  input.value = '';
  handleMessage(msg);
}

function neustart() {
  dialogState = 'awaiting_description';
  hutData = {};
  document.getElementById('messages').innerHTML = '';
  marker?.remove();
  addMessage('Bitte beschreibe die H√ºtte oder gib einen kurzen Hinweis.');
}

async function handleMessage(msg) {
  if (dialogState === 'awaiting_description') {
    hutData.beschreibung = msg;
    dialogState = 'awaiting_strom';
    addMessage('Gibt es Strom (z.‚ÄØB. f√ºr E-Bikes)?');
    return;
  }
  if (dialogState === 'awaiting_strom') {
    const result = await kiErkenneJaNein('strom', 'Gibt es Strom?', msg);
    if (result === null) return;
    hutData.strom = result;
    dialogState = 'awaiting_verkauf';
    addMessage('Gibt es etwas zu kaufen (Eier, Snacks)?');
    return;
  }
  if (dialogState === 'awaiting_verkauf') {
    const result = await kiErkenneJaNein('verkauf', 'Gibt es einen Verkauf?', msg);
    if (result === null) return;
    hutData.verkauf = result;
    dialogState = 'awaiting_sitzplatz';
    addMessage('Gibt es eine Sitzgelegenheit?');
    return;
  }
  if (dialogState === 'awaiting_sitzplatz') {
    const result = await kiErkenneJaNein('sitzplatz', 'Gibt es Sitzpl√§tze?', msg);
    if (result === null) return;
    hutData.sitzplatz = result;
    dialogState = 'awaiting_ueberdacht';
    addMessage('Ist die H√ºtte √ºberdacht?');
    return;
  }
  if (dialogState === 'awaiting_ueberdacht') {
    const result = await kiErkenneJaNein('ueberdacht', 'Ist die H√ºtte √ºberdacht?', msg);
    if (result === null) return;
    hutData.ueberdacht = result;
    dialogState = 'awaiting_location';
    mapEl.style.display = 'block';
    map.invalidateSize();
    addMessage('üìç Klicke auf die Karte oder nutze ‚ÄûStandort senden‚Äú.');
    return;
  }
}

async function kiErkenneJaNein(feldName, frage, userInput) {
  const prompt = `Beantworte nur mit true oder false: ${frage} Der Benutzer sagt: "${userInput}"`;
  try {
    const res = await fetch("https://api.openai.com/v1/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiKey}`
      },
      body: JSON.stringify({ model: "text-davinci-003", prompt, max_tokens: 5, temperature: 0 })
    });
    const data = await res.json();
    const reply = data?.choices?.[0]?.text?.trim().toLowerCase();
    if (reply?.includes("true")) return true;
    if (reply?.includes("false")) return false;
  } catch (e) { addMessage(`‚ùå KI-Fehler: ${e.message}`); }
  const t = userInput.toLowerCase();
  const p = { strom:["ja","strom","steckdose","e-bike"], verkauf:["eier","verkauf","snack","automat"], sitzplatz:["bank","tisch","stuhl"], ueberdacht:["dach","√ºberdacht"] };
  const n = { strom:["kein","nein"], verkauf:["leer","nichts"], sitzplatz:["keine","nicht"], ueberdacht:["nicht","kein"] };
  if (n[feldName]?.some(w=>t.includes(w))) return false;
  if (p[feldName]?.some(w=>t.includes(w))) return true;
  addMessage(`‚ùì "${feldName}" unklar. Bitte klarer antworten.`);
  return null;
}

function getLocation() {
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    setLocation(lat, lon);
  });
}

function setLocation(lat, lon) {
  if (!map) initMap(lat, lon);
  if (marker) marker.setLatLng([lat, lon]);
  else marker = L.marker([lat, lon]).addTo(map);
  map.setView([lat, lon], 17);
  hutData.lat = lat;
  hutData.lon = lon;
  zeigeZusammenfassung();
}

function initMap(lat, lon) {
  map = L.map('map').setView([lat, lon], 17);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);
  map.on('click', e => setLocation(e.latlng.lat, e.latlng.lng));
}

async function zeigeZusammenfassung() {
  const prompt = `Erstelle eine kurze sch√∂ne Beschreibung f√ºr folgende Eierh√ºtte:

Beschreibung: ${hutData.beschreibung}
Strom: ${hutData.strom}
Verkauf: ${hutData.verkauf}
Sitzplatz: ${hutData.sitzplatz}
√úberdacht: ${hutData.ueberdacht}
Standort: ${hutData.lat}, ${hutData.lon}`;

  try {
    const res = await fetch("https://api.openai.com/v1/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${openaiKey}`
      },
      body: JSON.stringify({ model: "text-davinci-003", prompt, max_tokens: 120, temperature: 0.7 })
    });
    const data = await res.json();
    const reply = data?.choices?.[0]?.text?.trim();
    if (reply) addMessage("üìç Zusammenfassung:\n" + reply);
    else addMessage("‚ùå Beschreibung konnte nicht erzeugt werden.");
  } catch (e) {
    addMessage("‚ùå Fehler beim Erzeugen der Beschreibung: " + e.message);
  }
}

addMessage('Bitte beschreibe die H√ºtte oder gib einen kurzen Hinweis.');
</script></body>
</html>
