<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierhütten-Eintrag</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #f1f1f1; color: #333; margin: 0; padding: 1rem; }
    .container { max-width: 600px; margin: auto; background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input, textarea, select, button { width: 100%; padding: 0.5rem; margin-top: 0.2rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #28a745; color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 1rem; }
    button:hover { background: #218838; }
    #chatBox { margin-top: 2rem; background: #fafafa; border-radius: 10px; padding: 1rem; max-height: 300px; overflow-y: auto; }
    .chat-msg { margin-bottom: 1rem; }
    .user { font-weight: bold; color: #007bff; }
    .ai { font-weight: bold; color: #6f42c1; }
    .bubble { background: #e9ecef; padding: 0.7rem; border-radius: 10px; margin-top: 0.3rem; white-space: pre-wrap; }
    #debugConsole { background: #111; color: #0f0; padding: 0.5rem; font-size: 0.8rem; overflow: auto; max-height: 150px; border-radius: 6px; margin-top: 1rem; display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>🪺 Eierhütte einreichen</h2><label>📍 Ort</label> <input id="ort" placeholder="z. B. Meisenstraße 12, Dorf" />

<label>🪑 Sitzplatz vorhanden?</label> <select id="sitzplatz"> <option value="ja">Ja</option> <option value="nein">Nein</option> </select>

<label>🔌 Stromversorgung für E-Bikes?</label> <select id="strom"> <option value="ja">Ja</option> <option value="nein">Nein</option> </select>

<label>📋 Weitere Infos</label>

  <textarea id="zusatz" rows="3" placeholder="Besonderheiten, Öffnungszeiten etc."></textarea><label>🔑 OpenRouter API-Key</label> <input id="apiKeyInput" placeholder="org-..." oninput="saveApiKey()" />

<button onclick="beschreibungErstellen()">🧠 Beschreibung mit KI generieren</button>

  <div id="chatBox"></div><button onclick="einreichen()">📤 Anfrage an Firestore senden</button> <button onclick="toggleDebug()">🛠️ Debug an/aus</button> <button onclick="clearDebug()">🧹 Debug löschen</button>

  <pre id="debugConsole"></pre></div><script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let debugMode = true;
function debug(msg, data) {
  if (!debugMode) return;
  const line = `[DEBUG] ${msg}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
  console.log(line);
  const el = document.getElementById("debugConsole");
  if (el) el.textContent += line + "\n";
}
function clearDebug() {
  document.getElementById("debugConsole").textContent = "";
  console.clear();
}
function toggleDebug() {
  debugMode = !debugMode;
  document.getElementById("debugConsole").style.display = debugMode ? 'block' : 'none';
  debug("Debug-Modus: " + (debugMode ? "aktiv" : "inaktiv"));
}
function saveApiKey() {
  const key = document.getElementById("apiKeyInput").value.trim();
  if (key) localStorage.setItem("openrouter_api_key", key);
}
function getApiKey() {
  return localStorage.getItem("openrouter_api_key") || "";
}
document.addEventListener("DOMContentLoaded", () => {
  const saved = getApiKey();
  if (saved) document.getElementById("apiKeyInput").value = saved;
});
function addChatMessage(sender, text) {
  const chatBox = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = "chat-msg";
  div.innerHTML = `<div class="${sender}">${sender === 'user' ? '👤 Du' : '🤖 KI'}</div><div class="bubble">${text}</div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

let letzteBeschreibung = "";

async function beschreibungErstellen() {
  const ort = document.getElementById("ort").value.trim();
  const sitz = document.getElementById("sitzplatz").value;
  const strom = document.getElementById("strom").value;
  const zusatz = document.getElementById("zusatz").value.trim();
  const key = getApiKey();
  if (!key) return alert("Bitte OpenRouter API-Key eingeben.");
  const prompt = `Erstelle eine freundliche, vollständige Beschreibung einer Eierhütte. Ort: ${ort}. Sitzplatz: ${sitz}. Strom: ${strom}. Zusatzinfos: ${zusatz}`;
  addChatMessage("user", prompt);
  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${key}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "mistralai/mistral-7b-instruct:free",
        messages: [
          { role: "system", content: "Du bist ein freundlicher Beschreibungshelfer für eine Fahrradtour-App mit Eierhütten." },
          { role: "user", content: prompt }
        ]
      })
    });
    const data = await res.json();
    debug("Antwort erhalten", data);
    const beschreibung = data.choices?.[0]?.message?.content || "❌ Keine Beschreibung erhalten.";
    letzteBeschreibung = beschreibung;
    addChatMessage("ai", beschreibung);
  } catch (err) {
    debug("Fehler bei Anfrage", err);
    alert("Fehler bei der Beschreibung: " + err.message);
  }
}

async function einreichen() {
  const ort = document.getElementById("ort").value.trim();
  const strom = document.getElementById("strom").value;
  const sitz = document.getElementById("sitzplatz").value;
  const zusatz = document.getElementById("zusatz").value.trim();
  const beschreibung = letzteBeschreibung || `Ort: ${ort}. Sitzplatz: ${sitz}. Strom: ${strom}. Zusatz: ${zusatz}`;
  const location = { latitude: 0, longitude: 0 }; // Geolocation kann noch integriert werden
  try {
    await db.collection("eierhuetten").add({
      name: ort,
      beschreibung,
      location,
      strom,
      bildUrl: null,
      status: "offen",
      history: [`${new Date().toLocaleString()}: Erstellt`],
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("✅ Anfrage erfolgreich übermittelt!");
  } catch (e) {
    debug("Fehler beim Einreichen", e);
    alert("❌ Fehler beim Speichern in Firestore.");
  }
}
</script></body>
</html>
