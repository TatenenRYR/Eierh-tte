<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierh√ºtten Assistent</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #chat-window .user { background-color: #d1fae5; text-align: right; padding: .5rem 1rem; border-radius: 1rem; display: inline-block; max-width: 80%; }
    #chat-window .bot { background-color: #f1f5f9; padding: .5rem 1rem; border-radius: 1rem; display: inline-block; max-width: 80%; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="login-section" class="text-center p-6">
    <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded">Mit Google anmelden</button>
  </div>  <section id="chat-section" class="max-w-3xl mx-auto mt-8 bg-white shadow-lg rounded-xl overflow-hidden hidden">
    <div class="bg-green-600 text-white text-xl font-bold p-4">ü•ö Eierh√ºtten Assistent</div>
    <div id="key-input-section" class="p-4 border-b">
      <input id="chat-api-key" type="text" placeholder="OpenRouter API-Key eingeben" class="border px-3 py-2 rounded w-full mb-2" />
      <button onclick="saveChatKey()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Key speichern</button>
    </div>
    <div id="chat-window" class="p-4 h-96 overflow-y-auto space-y-4 text-sm bg-gray-50"></div>
    <div id="input-row" class="p-4 border-t flex gap-2">
      <input id="chat-input" type="text" class="flex-grow border border-gray-300 rounded px-3 py-2" placeholder="Schreibe eine Nachricht...">
      <button onclick="sendeNachricht()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Senden</button>
    </div>
  </section>  <section id="meine-huetten" class="max-w-5xl mx-auto mt-12 hidden">
    <h2 class="text-2xl font-bold mb-4">üß∫ Deine eingereichten Eierh√ºtten</h2>
    <div id="huetten-liste" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
  </section>  <div class="text-center mt-6">
    <button onclick="ladeMeineHuetten(currentUser?.uid)" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
      Meine H√ºtten ansehen
    </button>
  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
      measurementId: "G-16V6K5GXDT"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    let currentUser;
    let OPENROUTER_KEY = localStorage.getItem('openrouter_api_key');
    if (!OPENROUTER_KEY) document.getElementById('key-input-section').classList.remove('hidden');
    else document.getElementById('key-input-section').classList.add('hidden');

    function saveChatKey() {
      const key = document.getElementById('chat-api-key').value.trim();
      if (key.length > 20) {
        localStorage.setItem('openrouter_api_key', key);
        OPENROUTER_KEY = key;
        document.getElementById('key-input-section').classList.add('hidden');
      } else alert('Bitte g√ºltigen API-Key eingeben');
    }

    document.getElementById('google-login').onclick = async () => {
      const res = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      currentUser = res.user;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('chat-section').classList.remove('hidden');
      showMsg(`Hallo ${currentUser.displayName}!`, 'bot');
      if (!OPENROUTER_KEY) document.getElementById('key-input-section').classList.remove('hidden');
      startChat();
    };

    const chatWindow = document.getElementById('chat-window');
    function showMsg(msg, role) {
      const d = document.createElement('div');
      d.className = role;
      d.textContent = msg;
      chatWindow.appendChild(d);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function sendeNachricht() {
      const input = document.getElementById('chat-input');
      const txt = input.value.trim();
      if (!txt) return;
      showMsg(txt, 'user');
      input.value = '';
      processStep(txt);
    }

    let step = 0, formData = {}, map, marker;
    function startChat() {
      showMsg('Wie soll deine Eierh√ºtte hei√üen?', 'bot');
      step = 0;
    }

    function processStep(input) {
      if (step === 0) {
        formData.name = input;
        showMsg('Bitte w√§hle den Standort auf der Karte aus und best√§tige ihn.', 'bot');
        showMap();
        step++;
      } else if (step === 1) {
        // Wird durch Button gesteuert
      } else if (step === 2) {
        formData.sitzplatz = input;
        frageMitButtons('Gibt es Strom?', 3);
      } else if (step === 3) {
        formData.strom = input;
        frageExtras();
        step++;
      } else if (step === 4) {
        formData.extras = input;
        zeigeZusammenfassung();
        step++;
      }
    }

    function frageMitButtons(frage, nextStep) {
      showMsg(frage, 'bot');
      const container = document.createElement('div');
      container.className = 'flex gap-2';
      ['Ja', 'Nein'].forEach(text => {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'bg-gray-300 px-4 py-1 rounded';
        btn.onclick = () => {
          showMsg(text, 'user');
          container.remove();
          step = nextStep;
          processStep(text.toLowerCase());
        };
        container.appendChild(btn);
      });
      chatWindow.appendChild(container);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function frageExtras() {
      showMsg('M√∂chtest du noch etwas hinzuf√ºgen? (z.B. Besonderheiten, Tipps)', 'bot');
    }

    function showMap() {
      const mapDiv = document.createElement('div');
      mapDiv.id = 'map';
      mapDiv.style.height = '300px';
      chatWindow.appendChild(mapDiv);
      map = L.map('map').setView([51.2, 10.5], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.on('click', e => {
        formData.loc = e.latlng;
        if (marker) marker.setLatLng(e.latlng);
        else marker = L.marker(e.latlng).addTo(map);
        if (!document.getElementById('confirm-map')) {
          const btn = document.createElement('button');
          btn.textContent = 'üìç Standort √ºbernehmen';
          btn.id = 'confirm-map';
          btn.className = 'block mt-2 bg-green-600 text-white px-4 py-2 rounded';
          btn.onclick = () => {
            map.remove();
            btn.remove();
            showMsg(`Standort gesetzt: ${formData.loc.lat.toFixed(5)}, ${formData.loc.lng.toFixed(5)}`, 'bot');
            frageMitButtons('Gibt es Sitzpl√§tze?', 2);
            step++;
          };
          chatWindow.appendChild(btn);
        }
      });
    }

    async function zeigeZusammenfassung() {
      showMsg('Bitte warten ‚Äì Beschreibung wird generiert...', 'bot');
      const prompt = `Erstelle eine Beschreibung f√ºr eine Eierh√ºtte mit folgenden Eigenschaften: Name: ${formData.name}, Sitzplatz: ${formData.sitzplatz}, Strom: ${formData.strom}, Infos: ${formData.extras}`;
      let beschreibung = 'Fehler beim Erstellen der Beschreibung';
      try {
        const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENROUTER_KEY}`
          },
          body: JSON.stringify({
            model: 'mistral/mistral-7b-instruct',
            messages: [{ role: 'user', content: prompt }]
          })
        });
        const data = await res.json();
        beschreibung = data.choices[0].message.content;
      } catch (e) {
        beschreibung = '‚ùå Fehler bei der KI-Beschreibung';
      }
      formData.beschreibung = beschreibung;

      const summary = `‚úÖ **Zusammenfassung**\n\nüìç Name: ${formData.name}\nüìå Standort: ${formData.loc.lat.toFixed(5)}, ${formData.loc.lng.toFixed(5)}\nü™ë Sitzplatz: ${formData.sitzplatz}\nüîå Strom: ${formData.strom}\nüìã Extras: ${formData.extras}\nüìù Beschreibung: ${beschreibung}`;
      showMsg(summary, 'bot');

      const btn = document.createElement('button');
      btn.textContent = '‚úÖ Einreichen';
      btn.className = 'block mt-4 mb-4 bg-green-600 text-white px-6 py-2 rounded';
      btn.onclick = async () => {
        await db.collection('eierhuetten').add({
          ...formData,
          userId: currentUser.uid,
          erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'offen'
        });
        showMsg('‚úÖ Erfolgreich eingereicht!', 'bot');
      };
      chatWindow.appendChild(btn);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function ladeMeineHuetten(uid) {
      if (!uid) return alert('Anmeldung erforderlich');
      const s = document.getElementById('meine-huetten');
      s.classList.remove('hidden');
      const l = document.getElementById('huetten-liste');
      l.innerHTML = '';
      const snap = await db.collection('eierhuetten').where('userId', '==', uid).orderBy('erstelltAm', 'desc').get();
      if (snap.empty) {
        l.innerHTML = '<p>Keine Eintr√§ge.</p>';
        return;
      }
      snap.forEach(doc => {
        const h = doc.data();
        const d = document.createElement('div');
        d.className = 'bg-white p-4 rounded shadow';
        d.innerHTML = `<h3>${h.name}</h3><p>${h.beschreibung}</p><p><strong>Status:</strong> ${h.status}</p>`;
        l.appendChild(d);
      });
    }
  </script></body>
</html>
