<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EierhÃ¼tten-Radtour mit Gruppen-Trekking</title>

  <!-- Leaflet & Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; z-index:0; }
    /* restliches CSS unverÃ¤ndert... */
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour"
    });
    const db = firebase.firestore();
  </script>
</head>
<body>
  <!-- Ladebildschirm -->
  <div id="loadingOverlay">â³ Karte lÃ¤dt...</div>

  <!-- UI-Buttons, Sidebar, Toasts, etc. wie gehabt... -->

  <div id="map"></div>

  <!-- Leaflet & Routing Machine JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // Karte & Layer (unverÃ¤ndert)
    const map = L.map('map');
    const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OSM contributors'
    });
    light.addTo(map);
    map.setView([51.5, 10.5], 6);

    // MarkerCluster-Gruppe initialisieren
    const markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    // Icons unverÃ¤ndert...
    const bikeIcon = L.icon({ iconUrl: './bike-icon.png', iconSize: [36,36], iconAnchor: [18,18] });
    const eggIcon = L.icon({ iconUrl: './file_00000000de6c61f8ad4432078ea06ea3.png', iconSize: [32,32], iconAnchor: [16,32] });
    const eggSelectedIcon = L.icon({ iconUrl: './file_000000008694624687786cae69507aa3.png', iconSize: [36,36], iconAnchor: [18,36] });
    const groupMemberIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/1946/1946429.png', iconSize: [32, 32], iconAnchor: [16, 32] });

    // State
    let userMarker, directionMarker, autoFollow = true;
    let allHuts = [], selectedHuts = [], hutMarkers = {}, routingControl;

    // Gruppen-Tracking, locateUser() etc. unverÃ¤ndert...
    locateUser();

    // HÃ¼tten live laden und in Cluster packen
    function loadHutsLive() {
      db.collection('eierhuetten').onSnapshot(snap => {
        allHuts = [];
        // entferne alte Marker
        markerCluster.clearLayers();
        hutMarkers = {};

        snap.forEach(doc => {
          const d = doc.data();
          if (!d.location) return;
          const hut = {
            id: doc.id,
            name: d.name || 'Unbenannt',
            lat: d.location.latitude,
            lng: d.location.longitude,
            strom: (d.strom === true || String(d.strom).toLowerCase() === 'ja'),
            oeffnungszeiten: d.oeffnungszeiten || ''
          };
          allHuts.push(hut);

          const m = L.marker([hut.lat, hut.lng], { icon: eggIcon });
          m.bindPopup(`
            <strong>${hut.name}</strong><br>
            ğŸ”Œ Strom: ${hut.strom ? 'Ja' : 'Nein'}<br>
            ğŸ•’ Ã–ffnungszeiten: ${hut.oeffnungszeiten}<br>
            <button onclick="toggleSelection('${hut.id}')">
              ${selectedHuts.includes(hut.id) ? 'âŒ Entfernen' : 'âœ… Zur Route'}
            </button>
          `);
          markerCluster.addLayer(m);
          hutMarkers[hut.id] = m;
        });

        // Karte laden abgeschlossen
        document.getElementById('loadingOverlay').style.display = 'none';
        updateSelectedList();
        recalculateRoute();
      });
    }

    // Auswahl umschalten (unverÃ¤ndert)
    function toggleSelection(id) {
      const i = selectedHuts.indexOf(id);
      if (i >= 0) {
        selectedHuts.splice(i, 1);
        hutMarkers[id].setIcon(eggIcon);
      } else {
        selectedHuts.push(id);
        hutMarkers[id].setIcon(eggSelectedIcon);
      }
      updateSelectedList();
      recalculateRoute();
    }

    // Listen-Update wie gehabt...
    function updateSelectedList() { /* ... */ }

    // **Verbesserte Fahrrad-Routenberechnung** mit OSRM-Bike-Profil
    function recalculateRoute() {
      if (!userMarker || selectedHuts.length === 0) return;
      const waypoints = [userMarker.getLatLng()];
      selectedHuts.forEach(id => {
        const h = allHuts.find(x => x.id === id);
        if (h) waypoints.push(L.latLng(h.lat, h.lng));
      });

      if (routingControl) map.removeControl(routingControl);
      routingControl = L.Routing.control({
        waypoints: waypoints,
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#10b981', weight: 5 }] },
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1',
          profile: 'bike'
        }),
        show: false
      }).addTo(map).on('routesfound', e => {
        const r = e.routes[0];
        document.getElementById('routeInfo').innerText =
          `ğŸš´ ${(r.summary.totalDistance / 1000).toFixed(1)} km Â· â± ${Math.round(r.summary.totalTime / 60)} min`;
      });
    }

    // Restliche Funktionen: resetSelection(), toggleSidebar(), etc. bleiben unverÃ¤ndert...

    // Automatische Fallback-Ausblendung des Loaders nach 10s
    window.onload = () => {
      setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
      }, 10000);
    };

    // Initialisierung
    loadHutsLive();
  </script>
</body>
</html>
