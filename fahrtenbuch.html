<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“– Fahrtenbuch</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase (compat, stabil im Browser) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    /* Leaflet Tooltip fÃ¼r User/Marker etc. (wird hier nur fÃ¼r Style-Konsistenz genutzt) */
    .user-label {
      background: rgba(255,255,255,0.92);
      border-radius: 6px;
      padding: 4px 8px;
      color: #111827; /* gray-900 */
      font-size: .8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      border: 1px solid rgba(0,0,0,.06);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- App Wrapper -->
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold">ğŸ“– Mein Fahrtenbuch</h1>
      <button id="refreshBtn" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 transition">
        â†» Aktualisieren
      </button>
    </header>

    <!-- Profil Card -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6">
      <div class="flex items-center gap-4 sm:gap-6">
        <div class="relative">
          <img id="profilePic" src="default.jpg" alt="Profilbild"
               class="w-20 h-20 sm:w-24 sm:h-24 rounded-full object-cover ring-2 ring-indigo-100 cursor-pointer" />
          <button id="picBtn" class="absolute -bottom-2 -right-2 bg-white border rounded-full p-2 shadow hover:shadow-md"
                  title="Profilbild Ã¤ndern">ğŸ“·</button>
        
    </div>
  </div>
</div>
        
        </div>
        <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input id="profileName" placeholder="Dein Name"
                 class="rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"/>
          <select id="profileTitle" class="rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="">Kein Titel</option>
          </select>

          <div class="col-span-1 sm:col-span-2 flex items-center gap-3">
            <button id="saveProfileBtn" class="rounded-xl px-4 py-2 bg-gray-100 hover:bg-gray-200 transition">ğŸ’¾ Speichern</button>
            <button id="syncProfileBtn" class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700 transition">ğŸŒ Ã–ffentlich machen</button>
          </div>

          <input id="shareLink" readonly
                 class="col-span-1 sm:col-span-2 rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
                 placeholder="Profil-Share-Link erscheint hier nach dem Syncâ€¦"/>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <p class="text-gray-500">Gesamt Distanz</p>
        <p id="totalKm" class="text-2xl font-semibold">0 km</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <p class="text-gray-500">Gesamt Zeit</p>
        <p id="totalTime" class="text-2xl font-semibold">0 h</p>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <p class="text-gray-500">Ã˜ Geschwindigkeit</p>
        <p id="avgSpeed" class="text-2xl font-semibold">0 km/h</p>
      </div>
    </section>

    <!-- Charts -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“Š AktivitÃ¤t</h2>
      <div class="grid lg:grid-cols-2 gap-6">
        <div>
          <canvas id="distChart" height="110"></canvas>
        </div>
        <div>
          <canvas id="monthChart" height="110"></canvas>
        </div>
      </div>
    </section>

    <!-- Badges -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ… Meine Abzeichen</h2>
      <div id="badgeList" class="flex flex-wrap gap-3"></div>
    </section>

    <!-- Fahrten-Tabelle + Map -->
    <section class="bg-white rounded-2xl shadow p-4 sm:p-6">
      <div class="flex gap-2 mb-4">
  <button id="exportCsvBtn" 
    class="rounded-xl px-3 py-2 bg-indigo-600 text-white hover:bg-indigo-700 transition">
    ğŸ“„ CSV
  </button>
  <button id="exportExcelBtn" 
    class="rounded-xl px-3 py-2 bg-indigo-600 text-white hover:bg-indigo-700 transition">
    ğŸ“Š Excel
  </button>
  <button id="exportPdfBtn" 
    class="rounded-xl px-3 py-2 bg-indigo-600 text-white hover:bg-indigo-700 transition">
    ğŸ“ PDF
  </button>
      </div>
      <div class="flex items-center justify-between mb-4 gap-3">
        <h2 class="text-xl font-semibold">Touren</h2>
        <div class="flex items-center gap-2">
          <input id="searchInput" class="rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
                 placeholder="Suche (Datum/Strecke)â€¦"/>
          <select id="sortSelect" class="rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
            <option value="date_desc">Neueste zuerst</option>
            <option value="date_asc">Ã„lteste zuerst</option>
            <option value="dist_desc">Distanz (â†“)</option>
            <option value="dist_asc">Distanz (â†‘)</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto rounded-xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left px-4 py-3">Datum</th>
              <th class="text-left px-4 py-3">Dauer</th>
              <th class="text-left px-4 py-3">Distanz</th>
              <th class="text-left px-4 py-3">Ã˜ Speed</th>
              <th class="text-left px-4 py-3">Aktion</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>

      <div id="map" class="mt-4 h-[320px] rounded-xl border"></div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden
                         bg-gray-900 text-white px-4 py-2 rounded-xl shadow-lg"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Firebase Setup
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.firebasestorage.app",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
  measurementId: "G-16V6K5GXDT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Globals
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let map, routeLayer;
let rides = []; // zusammengefÃ¼hrt: Firestore + localStorage
let distChart, monthChart;
const userId = initUserId();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Utils
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initUserId(){
  let id = localStorage.getItem("userId");
  if (!id) {
    id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
    localStorage.setItem("userId", id);
  }
  return id;
}

function toast(msg, type="info") {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  t.style.background = type === "error" ? "#dc2626" : type === "ok" ? "#065f46" : "#111827";
  setTimeout(() => t.classList.add("hidden"), 2200);
}

function fmtDate(iso) {
  const d = new Date(iso);
  return d.toLocaleString();
}
function fmtHMS(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return h ? `${h}h ${m}min` : `${m}min`;
}
function km(m){ return (m/1000).toFixed(1); }
function kmh(m, s){ return ( (m/1000) / (s/3600) ).toFixed(1); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Profil / Titel / Badges
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let titleDefs = {};
async function loadTitleDefs() {
  const snap = await db.collection("titles").get();
  snap.forEach(doc => {
    const t = doc.data();
    titleDefs[doc.id] = t.name;
  });
}

let badgeDefs = {};
async function loadBadgeDefs() {
  const snap = await db.collection("badgesDefs").get();
  snap.forEach(doc => {
    const b = doc.data();
    badgeDefs[doc.id] = { name: b.name, icon: b.icon };
  });
}


function loadProfileUI(){
  document.getElementById("profileName").value = localStorage.getItem("profileName") || "";
  const pic = localStorage.getItem("profilePic");
  if (pic) document.getElementById("profilePic").src = pic;
  renderTitles();
}

async function renderTitles(){
  const sel = document.getElementById("profileTitle");
  sel.innerHTML = "<option value=''>Kein Titel</option>";

  const badges = JSON.parse(localStorage.getItem("badges") || "[]");
  const snap = await db.collection("titles").get();

  badges.forEach(b => {
    const match = snap.docs.find(d => d.id === b.id);
    if (match) {
      const t = match.data();
      const opt = document.createElement("option");
      opt.value = t.name;
      opt.textContent = t.name;
      sel.appendChild(opt);
    }
  });

  if (localStorage.getItem("adminTitle")) {
    const opt = document.createElement("option");
    opt.value = "ğŸ‘‘ Admin";
    opt.textContent = "ğŸ‘‘ Admin";
    sel.appendChild(opt);
  }

  sel.value = localStorage.getItem("profileTitle") || "";
}


async function syncProfileToFirebase(){
  try {
    const profile = {
      name: localStorage.getItem("profileName") || "",
      title: localStorage.getItem("profileTitle") || "",
      pic: localStorage.getItem("profilePic") || "",
      badges: JSON.parse(localStorage.getItem("badges") || "[]"),
      stats: {
        totalKm: document.getElementById("totalKm").textContent,
        totalTime: document.getElementById("totalTime").textContent,
        avgSpeed: document.getElementById("avgSpeed").textContent
      },
      updatedAt: new Date().toISOString()
    };
    await db.collection("profiles").doc(userId).set(profile, { merge: true });
    const link = `${location.origin}/profile.html?id=${userId}`;
    document.getElementById("shareLink").value = link;
    toast("Profil synchronisiert", "ok");
  } catch(e){
    console.error(e);
    toast("Profil Sync fehlgeschlagen", "error");
  }
}

function renderBadges(){
  const list = document.getElementById("badgeList");
  const badges = JSON.parse(localStorage.getItem("badges") || "[]");
  list.innerHTML = "";
  if (!badges.length){
    list.innerHTML = `<div class="text-gray-500">Noch keine Abzeichen freigeschaltet ğŸš€</div>`;
    return;
  }
  for (const b of badges){
    const card = document.createElement("div");
    card.className = "px-3 py-2 rounded-xl border bg-white hover:shadow transition";
    card.innerHTML = `<div class="text-2xl text-center">${b.icon || "ğŸ…"}</div>
                      <div class="text-center">${b.title || b.id}</div>
                      <div class="text-xs text-gray-500 text-center">${new Date(b.date).toLocaleDateString()}</div>`;
    list.appendChild(card);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Fahrten laden (Firestore + localStorage)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadRidesFromFirestore(){
  try{
    const snap = await db.collection("users").doc(userId).collection("rides").orderBy("startTime", "desc").get();
    const arr = [];
    snap.forEach(doc => arr.push({ id: doc.id, ...doc.data(), source: "cloud" }));
    return arr;
  }catch(e){
    console.warn("Firestore load error:", e);
    return [];
  }
}
function loadRidesFromLocal(){
  const local = JSON.parse(localStorage.getItem("fahrtenbuch") || "[]");
  // map zu kompatiblem Format
  return local.map((l, idx) => ({
    id: `local-${idx}-${l.date}`,
    startTime: l.date,
    endTime: l.date, // nicht exakt, aber fÃ¼r Anzeige ok
    duration: l.duration,
    distance: l.distance,
    avgSpeed: l.avgSpeed,
    route: (l.route || []).map(p => Array.isArray(p) ? {lat:p[0], lng:p[1]} : p),
    source: "local"
  }));
}

/* Dubletten-Schutz: wenn es dieselben Zeit-/Distanzwerte sind, nimm Cloud */
function mergeRides(cloud, local){
  const key = r => `${new Date(r.startTime).getTime()}_${Math.round(r.distance||0)}_${Math.round(r.duration||0)}`;
  const map = new Map();
  for (const r of local){ map.set(key(r), r); }
  for (const r of cloud){ map.set(key(r), r); } // Cloud Ã¼berschreibt
  return Array.from(map.values());
}

/* Migration alter Koordinaten ([lat,lng] â†’ {lat,lng}) fÃ¼r Cloud */
async function migrateRideCoords(){
  try{
    const snap = await db.collection("users").doc(userId).collection("rides").get();
    const batch = db.batch();
    let changed = 0;
    snap.forEach(doc => {
      const d = doc.data();
      const fixArrToObj = (arr) => Array.isArray(arr) ? arr.map(p => Array.isArray(p) ? ({lat:p[0], lng:p[1]}) : p) : [];
      const newCoords = fixArrToObj(d.coords || []);
      const newPlanned = fixArrToObj(d.routePlanned || []);
      const needUpdate = JSON.stringify(newCoords) !== JSON.stringify(d.coords || []) ||
                         JSON.stringify(newPlanned) !== JSON.stringify(d.routePlanned || []);
      if (needUpdate){
        batch.update(doc.ref, { coords: newCoords, routePlanned: newPlanned });
        changed++;
      }
    });
    if (changed>0){
      await batch.commit();
      console.log(`Migration: ${changed} Fahrten korrigiert`);
    }
  }catch(e){
    console.warn("Migration skipped/failed:", e);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Tabelle & Map Rendering
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStats(list){
  if (!list.length){
    document.getElementById("totalKm").innerText = "0 km";
    document.getElementById("totalTime").innerText = "0 h";
    document.getElementById("avgSpeed").innerText = "0 km/h";
    return;
  }
  const totalDist = list.reduce((a,b)=>a+(b.distance||0),0);
  const totalTime = list.reduce((a,b)=>a+(b.duration||0),0);
  const avg = totalDist && totalTime ? ( (totalDist/1000) / (totalTime/3600) ) : 0;

  document.getElementById("totalKm").innerText = `${(totalDist/1000).toFixed(1)} km`;
  document.getElementById("totalTime").innerText = `${(totalTime/3600).toFixed(1)} h`;
  document.getElementById("avgSpeed").innerText = `${avg.toFixed(1)} km/h`;
}

function renderCharts(list){
  // Distanz-Zeitreihe (pro Fahrt)
  const labels = list.map(r => new Date(r.startTime).toLocaleDateString());
  const dists = list.map(r => (r.distance||0)/1000);

  if (distChart) distChart.destroy();
  distChart = new Chart(document.getElementById("distChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{ label: "Distanz (km)", data: dists }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Monats-Summen
  const byMonth = {};
  for (const r of list){
    const d = new Date(r.startTime);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    byMonth[k] = (byMonth[k]||0) + (r.distance||0)/1000;
  }
  const mLabels = Object.keys(byMonth).sort();
  const mData = mLabels.map(k => byMonth[k]);

  if (monthChart) monthChart.destroy();
  monthChart = new Chart(document.getElementById("monthChart"), {
    type: "line",
    data: { labels: mLabels, datasets: [{ label: "Monatsdistanz (km)", data: mData, tension: .3 }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function renderTable(list){
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Keine Fahrten gefunden</td></tr>`;
    return;
  }
  for (const r of list){
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    const distKm = km(r.distance||0);
    const avg = r.duration ? kmh(r.distance||0, r.duration) : "0.0";
    tr.innerHTML = `
      <td class="px-4 py-3">${fmtDate(r.startTime)}</td>
      <td class="px-4 py-3">${fmtHMS(r.duration||0)}</td>
      <td class="px-4 py-3">${distKm} km</td>
      <td class="px-4 py-3">${avg} km/h</td>
      <td class="px-4 py-3">
        <button class="px-3 py-1 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition">Anzeigen</button>
      </td>`;
    tr.querySelector("button").onclick = () => showRoute(r);
    tbody.appendChild(tr);
  }
}

function ensureMap(){
  if (!map){
    map = L.map("map").setView([51, 10], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  }
}
function showRoute(ride){
  ensureMap();
  if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }

  const route = (ride.route && ride.route.length) ? ride.route
               : (ride.coords && ride.coords.length) ? ride.coords
               : (ride.routePlanned || []);

  const latlngs = route.map(p => L.latLng(p.lat, p.lng)).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));

  if (!latlngs.length){
    toast("Keine Route/Koordinaten vorhanden", "error");
    return;
  }
  routeLayer = L.polyline(latlngs, { color: "#1d4ed8", weight: 4 }).addTo(map);
  map.fitBounds(routeLayer.getBounds(), { padding: [30,30] });
}

/* Suche/Sortierung */
function applySearchSort(source){
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const sort = document.getElementById("sortSelect").value;
  let arr = [...source];

  if (q){
    arr = arr.filter(r => {
      const d = new Date(r.startTime).toLocaleString().toLowerCase();
      const dist = String(Math.round((r.distance||0)/100)/10);
      return d.includes(q) || dist.includes(q);
    });
  }

  arr.sort((a,b)=>{
    if (sort==="date_asc") return new Date(a.startTime)-new Date(b.startTime);
    if (sort==="date_desc") return new Date(b.startTime)-new Date(a.startTime);
    if (sort==="dist_asc") return (a.distance||0)-(b.distance||0);
    if (sort==="dist_desc") return (b.distance||0)-(a.distance||0);
    return 0;
  });

  return arr;
}
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Export Funktionen
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function exportToCSV() {
  if (!rides.length) return toast("Keine Fahrten zum Export", "error");

  const header = ["Datum", "Dauer", "Distanz (km)", "Ã˜ Speed (km/h)"];
  const rows = rides.map(r => [
    fmtDate(r.startTime),
    fmtHMS(r.duration || 0),
    (r.distance / 1000).toFixed(2),
    r.duration ? kmh(r.distance || 0, r.duration) : "0.0"
  ]);

  const csvContent = [header, ...rows].map(e => e.join(";")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "fahrtenbuch.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function exportToExcel() {
  if (!rides.length) return toast("Keine Fahrten zum Export", "error");

  let content = `
    <table>
      <tr><th>Datum</th><th>Dauer</th><th>Distanz (km)</th><th>Ã˜ Speed (km/h)</th></tr>
      ${rides.map(r => `
        <tr>
          <td>${fmtDate(r.startTime)}</td>
          <td>${fmtHMS(r.duration || 0)}</td>
          <td>${(r.distance / 1000).toFixed(2)}</td>
          <td>${r.duration ? kmh(r.distance || 0, r.duration) : "0.0"}</td>
        </tr>`).join("")}
    </table>`;

  const blob = new Blob([content], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "fahrtenbuch.xls";
  a.click();
  URL.revokeObjectURL(url);
}

function exportToPDF() {
  if (!rides.length) return toast("Keine Fahrten zum Export", "error");

  // Simpler Ansatz: HTML â†’ neues Fenster â†’ Drucken als PDF
  let html = `
    <h2>ğŸ“– Fahrtenbuch Export</h2>
    <table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse; width:100%">
      <tr style="background:#eee">
        <th>Datum</th><th>Dauer</th><th>Distanz (km)</th><th>Ã˜ Speed (km/h)</th>
      </tr>
      ${rides.map(r => `
        <tr>
          <td>${fmtDate(r.startTime)}</td>
          <td>${fmtHMS(r.duration || 0)}</td>
          <td>${(r.distance / 1000).toFixed(2)}</td>
          <td>${r.duration ? kmh(r.distance || 0, r.duration) : "0.0"}</td>
        </tr>`).join("")}
    </table>`;

  const w = window.open("", "_blank");
  w.document.write(`<html><head><title>Fahrtenbuch</title></head><body>${html}</body></html>`);
  w.document.close();
  w.print(); // User kann als PDF speichern
}

// Button-Events
document.getElementById("exportCsvBtn").onclick = exportToCSV;
document.getElementById("exportExcelBtn").onclick = exportToExcel;
document.getElementById("exportPdfBtn").onclick = exportToPDF;
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Profilbild Upload via ImgBB
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function uploadProfilePic(file) {
  try {
    // Datei in Base64 umwandeln
    const reader = new FileReader();
    const base64 = await new Promise((resolve, reject) => {
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = () => reject("Fehler beim Lesen der Datei");
      reader.readAsDataURL(file);
    });

    // Upload zu ImgBB
    const formData = new FormData();
    formData.append("key", "5df04de9bfd2776f101329be4193e44c"); // dein ImgBB API Key
    formData.append("image", base64);

    const res = await fetch("https://api.imgbb.com/1/upload", {
      method: "POST",
      body: formData
    });
    const json = await res.json();

    if (json?.data?.url) {
      const url = json.data.url;

      // Lokale Speicherung
      localStorage.setItem("profilePic", url);
      document.getElementById("profilePic").src = url;

      // In Firebase speichern
      await db.collection("profiles").doc(userId).set(
        { pic: url },
        { merge: true }
      );

      toast("Profilbild hochgeladen âœ…", "ok");
    } else {
      console.error("Upload fehlgeschlagen", json);
      toast("âŒ Upload fehlgeschlagen", "error");
    }
  } catch (err) {
    console.error(err);
    toast("âŒ Fehler beim Upload", "error");
  }
}



  // ğŸ“· Button Ã¶ffnet Popup
document.getElementById("picBtn").addEventListener("click", () => {
  document.getElementById("picModal").classList.remove("hidden");
  document.getElementById("picModal").classList.add("flex");
});

// âŒ Modal schlieÃŸen
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("picModal").classList.add("hidden");
  document.getElementById("picModal").classList.remove("flex");
});

// ğŸ¨ Avatar generieren mit Stil-Auswahl
document.getElementById("avatarBtn").addEventListener("click", async () => {
  const style = document.getElementById("avatarStyle").value;
  const seed = localStorage.getItem("profileName") || userId;
  const url = `https://api.dicebear.com/7.x/${style}/png?seed=${encodeURIComponent(seed)}`;

  try {
    localStorage.setItem("profilePic", url);
    document.getElementById("profilePic").src = url;

    await db.collection("profiles").doc(userId).set(
      { pic: url },
      { merge: true }
    );

    toast("ğŸ¨ Avatar generiert âœ…", "ok");
  } catch (err) {
    console.error(err);
    toast("âŒ Fehler beim Generieren", "error");
  }

  document.getElementById("picModal").classList.add("hidden");
  document.getElementById("picModal").classList.remove("flex");
});

// ğŸ“¤ Eigenes Bild hochladen
document.getElementById("uploadBtn").addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    if (file) uploadProfilePic(file); // nutzt deine vorhandene Funktion
  };
  input.click();

  document.getElementById("picModal").classList.add("hidden");
  document.getElementById("picModal").classList.remove("flex");
});
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Initialisierung
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function init(){
  // Profil UI
  loadProfileUI();
  renderBadges();

  // Migration (silent best effort)
  await migrateRideCoords();

  // Rides sammeln
  const cloud = await loadRidesFromFirestore();
  const local = loadRidesFromLocal();
  rides = mergeRides(cloud, local);

  // Render
  renderStats(rides);
  renderCharts(rides);
  renderTable(applySearchSort(rides));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Events
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById("refreshBtn").addEventListener("click", async ()=>{
  toast("Lade Datenâ€¦");
  await init();
  toast("Aktualisiert", "ok");
});

document.getElementById("searchInput").addEventListener("input", ()=>{
  renderTable(applySearchSort(rides));
});
document.getElementById("sortSelect").addEventListener("change", ()=>{
  renderTable(applySearchSort(rides));
});

document.getElementById("saveProfileBtn").addEventListener("click", ()=>{
  localStorage.setItem("profileName", document.getElementById("profileName").value);
  localStorage.setItem("profileTitle", document.getElementById("profileTitle").value);
  toast("Profil gespeichert", "ok");
});

document.getElementById("syncProfileBtn").addEventListener("click", syncProfileToFirebase);


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Start
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
init();
</script>
  <!-- Profilbild-Auswahl Popup -->
<div id="picModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-xl p-6 w-96 text-center">
    <h3 class="text-lg font-semibold mb-4">Profilbild auswÃ¤hlen</h3>

    <!-- Avatar Styles -->
    <label class="block text-left text-sm font-medium mb-1">ğŸ¨ Avatar-Stil</label>
    <select id="avatarStyle" class="w-full rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 mb-4">
      <option value="bottts">ğŸ¤– Bottts</option>
      <option value="pixel-art">ğŸŸ¦ Pixel Art</option>
      <option value="identicon">ğŸŒ€ Identicon</option>
      <option value="adventurer">ğŸ§™ Adventurer</option>
      <option value="big-ears">ğŸ° Big Ears</option>
    </select>

    <div class="flex flex-col gap-3">
      <button id="avatarBtn" 
        class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition">
        ğŸ¨ Avatar generieren
      </button>
      <button id="uploadBtn" 
        class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition">
        ğŸ“¤ Eigenes Bild hochladen
      </button>
      <button id="closeModal" 
        class="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300 transition">
        âŒ Abbrechen
      </button>
    </div>
  </div>
</div>
</body>
</html>
