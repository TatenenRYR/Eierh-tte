<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>📖 Fahrtenbuch</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin:20px; background:#f8f8f8; }
    .profile { display:flex; align-items:center; gap:20px; margin-bottom:20px; }
    .profile img { width:80px; height:80px; border-radius:50%; object-fit:cover; cursor:pointer; }
    .stats { margin:20px 0; padding:15px; background:#fff; border-radius:10px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; border-bottom:1px solid #ddd; }
  </style>
</head>
<body>
  <h1>📖 Mein Fahrtenbuch</h1>

  <div class="profile">
    <img id="profilePic" src="default.jpg" alt="Profilbild">
    <div>
      <input id="profileName" placeholder="Dein Name" />
      <button onclick="saveProfile()">💾 Speichern</button>
    </div>
  </div>

  <div class="stats">
    <h2>Statistik</h2>
    <p id="totalKm">0 km gesamt</p>
    <p id="totalTime">0 h gesamt</p>
    <p id="avgSpeed">0 km/h Ø Geschwindigkeit</p>
  </div>

  <canvas id="chart" height="100"></canvas>

  <h2>Touren</h2>
  <table>
    <thead>
      <tr><th>Datum</th><th>Distanz</th><th>Dauer</th><th>Ø Geschwindigkeit</th></tr>
    </thead>
    <tbody id="logTable"></tbody>
  </table>

<script>
function loadProfile() {
  document.getElementById("profileName").value = localStorage.getItem("profileName") || "";
  const pic = localStorage.getItem("profilePic");
  if (pic) document.getElementById("profilePic").src = pic;
}
function saveProfile() {
  localStorage.setItem("profileName", document.getElementById("profileName").value);
  alert("✔️ Profil gespeichert");
}
document.getElementById("profilePic").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      localStorage.setItem("profilePic", ev.target.result);
      document.getElementById("profilePic").src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  input.click();
};

function formatTime(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  return h > 0 ? `${h}h ${m}min` : `${m}min`;
}

function renderFahrtenbuch() {
  const logs = JSON.parse(localStorage.getItem("fahrtenbuch") || "[]");
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";

  let totalKm=0, totalTime=0, speeds=[];
  logs.forEach(l => {
    totalKm += l.distance/1000;
    totalTime += l.duration;
    speeds.push(l.avgSpeed);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(l.date).toLocaleString()}</td>
      <td>${(l.distance/1000).toFixed(1)} km</td>
      <td>${formatTime(l.duration)}</td>
      <td>${l.avgSpeed.toFixed(1)} km/h</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById("totalKm").innerText = totalKm.toFixed(1)+" km gesamt";
  document.getElementById("totalTime").innerText = (totalTime/3600).toFixed(1)+" h gesamt";
  document.getElementById("avgSpeed").innerText = (speeds.reduce((a,b)=>a+b,0)/speeds.length || 0).toFixed(1)+" km/h Ø Geschwindigkeit";

  new Chart(document.getElementById("chart"), {
    type:"line",
    data:{
      labels: logs.map(l=>new Date(l.date).toLocaleDateString()),
      datasets:[{
        label:"Distanz (km)",
        data: logs.map(l=>l.distance/1000),
        borderColor:"blue",
        fill:false
      }]
    }
  });
}

loadProfile();
renderFahrtenbuch();
</script>
</body>
</html>
