<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard V6</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Generelle Stile (wie V5) */
    body { font-family: 'Inter', sans-serif; }
    .nav-group-title { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem; margin-top: 1rem; }
    .nav-btn { display: flex; align-items: center; gap: 0.75rem; text-align: left; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; color: #374151; }
    .nav-btn:hover { background-color: #f3f4f6; }
    .nav-btn.active { background-color: #10b981; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-backdrop.flex { display: flex; }
    .modal-content { background: white; border-radius: 0.75rem; padding: 0; width: 100%; max-width: 56rem; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 1.5rem; }
    .modal-tab { padding: 1rem 0.5rem; margin-bottom: -1px; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280; }
    .modal-tab:hover { color: #111827; }
    .modal-tab.active { color: #10b981; border-color: #10b981; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .ql-container { min-height: 150px; font-size: 1rem; }
    .admin-table { width: 100%; text-align: left; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .admin-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .admin-table tr:hover { background-color: #f9fafb; }
    /* Inline Edit */
    .inline-edit-input { border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 0.375rem; width: 100%; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    .inline-edit-select { border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 0.375rem; width: auto; background-color: white; font-size: 0.75rem; line-height: 1rem; }

    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .button-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    .priority-Hoch { border-left: 4px solid #ef4444; } .priority-Normal { border-left: 4px solid #f97316; } .priority-Niedrig { border-left: 4px solid #84cc16; }
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5 !important; border-color: #10b981 !important; transform: scale(1.01); }
    #smartUploadPreview .image-card { transition: all 0.25s ease; }
    #smartUploadPreview .image-card:hover { transform: scale(1.03); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #smartUploadProgress { transition: opacity 0.3s; }

  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an.</p>
      <button id="login-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full">Mit Google Anmelden</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4"> <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1> </div>
      <nav class="flex-1 space-y-1">
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä Dashboard</button>
        <div class="nav-group-title">Inhalte</div>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('moderation')">üõ°Ô∏è Moderation <span id="mod-queue-badge" class="ml-auto bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">Benutzer</div>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets <span id="support-queue-badge" class="ml-auto bg-blue-400 text-blue-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">System</div>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Gamification</button>
        <button class="nav-btn w-full" onclick="showSection('system-logs')">üìú System-Protokoll</button>
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200"> <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div> <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button> </div>
    </aside>

    <!-- Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      <!-- √úbersicht (Dashboard) -->
      <section id="overview" class="space-y-8">
        <div> <h2 class="section-title">Willkommen zur√ºck!</h2> <p class="text-gray-600">√úberblick √ºber die aktuellen Aktivit√§ten.</p> </div>
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6"></div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 card"> <h3 class="font-bold text-lg mb-4">H√ºtten-Registrierungen (Letzte 30 Tage)</h3> <canvas id="registrationsChart"></canvas> </div>
          <div class="lg:col-span-2 card"> <h3 class="font-bold text-lg mb-4">Letzte Admin-Aktivit√§ten</h3> <div id="admin-log-widget" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
        </div>
      </section>

       <!-- H√ºttenliste -->
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4"> <h2 class="section-title">üè† Alle H√ºtten verwalten</h2> <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-emerald-700 transition">+ H√ºtte hinzuf√ºgen</button> </div>
        <div class="card">
            <div class="flex justify-between items-center gap-4 mb-4">
                <div class="flex gap-4">
                    <input id="search-input" placeholder="üîç Suchen nach Name..." class="p-2 border rounded-md w-full">
                    <select id="status-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Status</option> <option value="angenommen">Angenommen</option> <option value="offen">Offen</option> <option value="abgelehnt">Abgelehnt</option> </select>
                </div>
                <div id="bulk-action-container" class="hidden">
                    <select id="bulk-action-select" class="p-2 border rounded-md bg-white"> <option value="">Massen-Aktion...</option> <option value="approve">Auswahl freigeben</option> <option value="reject">Auswahl ablehnen</option> <option value="delete">Auswahl L√ñSCHEN</option> </select>
                    <button id="bulk-action-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg ml-2 hover:bg-blue-700">OK</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead> <tr> <th class="w-10"><input type="checkbox" id="select-all-checkbox"></th> <th>Name</th> <th>Status</th> <th>Erstellt am</th> <th>Pending Fotos</th> <th>Aktionen</th> </tr> </thead>
                    <tbody id="hut-table-body"></tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      
      <!-- Moderation -->
      <section id="moderation" class="hidden">
        <h2 class="section-title">üõ°Ô∏è Moderations-Warteschlange</h2>
        <div class="card">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg">üÜï Neue Eintragungen</h3> <button id="bulk-approve-huts" onclick="bulkApproveHuts()" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm">Alle freigeben</button> </div> <div id="neueListe-page" class="space-y-2 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
                 <div> <h3 class="font-bold text-lg mb-4">üì∑ Fotos warten auf Freigabe</h3> <div id="pending-fotos-page" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
            </div>
        </div>
      </section>
      
      <!-- Support-Tickets -->
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <div class="mb-4 flex gap-4">
              <input id="support-search" class="p-2 border rounded-md flex-grow" placeholder="Suche nach E-Mail oder Inhalt...">
              <select id="support-status-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Status</option> <option value="offen">Offen</option> <option value="bearbeitet">Bearbeitet</option> <option value="geschlossen">Geschlossen</option> <option value="archiviert">Archiviert</option>
              </select>
              <select id="support-priority-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Priorit√§ten</option> <option value="Hoch">Hoch</option> <option value="Normal">Normal</option> <option value="Niedrig">Niedrig</option>
              </select>
          </div>
          <table class="admin-table">
            <thead> <tr> <th class="px-4 py-2">Priorit√§t</th> <th class="px-4 py-2">Datum</th> <th class="px-4 py-2">User</th> <th class="px-4 py-2">Nachrichten</th> <th class="px-4 py-2">Status</th> <th class="px-4 py-2">Aktionen</th> </tr> </thead>
            <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile Verwaltung</h2>
        <div class="card">
          <div class="relative max-w-md"> <input id="profile-search" type="text" class="w-full border p-2 rounded-md" placeholder="Profil nach Name suchen..." /> <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded-md shadow-lg hidden z-10"></div> </div>
          <div id="profile-admin-area" class="hidden space-y-4 mt-6 border-t pt-6">
              <!-- Profil-Details hier -->
              <div class="flex items-center space-x-4"> <img id="profile-pic-admin" class="w-24 h-24 rounded-full border" src="https://placehold.co/96x96/eee/ccc?text=Profil" /> <input id="profile-pic-url" class="flex-1 border p-2 rounded" placeholder="Profilbild-URL √§ndern..." /> </div>
              <input id="profile-name-admin" class="w-full border p-2 rounded" placeholder="Name" /> <textarea id="profile-bio-admin" class="w-full border p-2 rounded" placeholder="Kurzbeschreibung / Bio"></textarea>
              <label class="block font-bold">Titel</label> <select id="profile-title-admin" class="w-full border p-2 rounded"></select>
              <label class="block font-bold">Abzeichen</label> <div id="profile-badges-admin" class="flex flex-wrap gap-2"></div>
              <label class="block font-bold">Rolle</label> <select id="profile-role-admin" class="w-full border p-2 rounded"> <option value="user">üë§ User</option> <option value="admin">üëë Admin</option> <option value="mod">üõ°Ô∏è Moderator</option> </select>
              <label class="inline-flex items-center space-x-2"> <input id="profile-banned-admin" type="checkbox" class="form-checkbox"> <span>üö´ Account gesperrt</span> </label>
              <div class="text-sm text-gray-600" id="profile-stats"></div>
              <div class="flex space-x-2"> <button onclick="saveProfileAdmin()" class="bg-green-600 text-white px-3 py-1 rounded">üíæ Speichern</button> <button onclick="deleteProfileAdmin()" class="bg-red-600 text-white px-3 py-1 rounded">üóëÔ∏è L√∂schen</button> </div>
          </div>
        </div>
      </section>
      
      <!-- Gamification -->
      <section id="gamification" class="hidden">
          <h2 class="section-title">üèÜ Gamification</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="card"> <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel Verwaltung</h3> <div id="title-list" class="space-y-2"></div> <form id="title-form" class="mt-4 space-y-2 border-t pt-4"> <input id="title-name" placeholder="Titel-Name" class="border p-2 rounded w-full"> <select id="title-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> </select> <input id="title-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Titel speichern</button> </form> </div>
              <div class="card"> <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen Verwaltung</h3> <div id="badge-list-admin" class="space-y-2"></div> <form id="badge-form" class="mt-4 space-y-2 border-t pt-4"> <input id="badge-name" placeholder="Abzeichen-Name" class="border p-2 rounded w-full"> <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"> <input id="badge-icon" placeholder="Emoji/Icon (Fallback)" class="border p-2 rounded w-full"> <select id="badge-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> <option value="night">Nachtfahrt</option> </select> <input id="badge-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Abzeichen speichern</button> </form> </div>
          </div>
      </section>
      
      <!-- System-Protokoll -->
      <section id="system-logs" class="hidden">
        <h2 class="section-title">üìú Globales System-Protokoll</h2>
        <div class="card"> <input id="log-search-input" class="w-full border p-2 rounded-md mb-4" placeholder="Logs durchsuchen..."> <div id="admin-log-full-list" class="space-y-3 max-h-[70vh] overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
      </section>
    </main>
  </div>
  
  <!-- Modals -->
  <div id="support-reply-modal" class="modal-backdrop"> <!-- Support Modal --> </div>
  <div id="hut-edit-modal" class="modal-backdrop"> <!-- Hut Edit Modal --> </div>
  <div id="admin-map-container" style="display:none;"></div>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = { apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", authDomain: "eierhuettentour.firebaseapp.com", projectId: "eierhuettentour", storageBucket: "eierhuettentour.appspot.com", messagingSenderId: "348272135205", appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc" };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === GLOBALE VARIABLEN ===
  let currentUser = null; let allHuts = []; let filteredHuts = []; let currentPage = 1; const hutsPerPage = 15; let currentEditingHutId = null; let currentEditingSupportTicketId = null; let registrationsChartInstance; let adminModalMap; let adminModalMarker; let adminModalLocation; let quillInstance = null; const _supportMessageUnsubs = new Map();

  // === DOM-ELEMENTE ===
  const notification = document.getElementById('notification'); const hutEditModal = document.getElementById('hut-edit-modal'); const hutEditModalContent = document.getElementById('hut-edit-modal-content'); const supportReplyModal = document.getElementById('support-reply-modal'); const hutTableBody = document.getElementById('hut-table-body'); const selectAllCheckbox = document.getElementById('select-all-checkbox'); const bulkActionContainer = document.getElementById('bulk-action-container'); const bulkActionBtn = document.getElementById('bulk-action-btn'); const supportTicketsBody = document.getElementById('support-tickets-body');

  // === TIERE MAPPING ===
  const TIERE_EMOJI_TO_NAME = { "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege", "üêë": "Schaf", "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase", "üêî": "Huhn", "ü¶Ü": "Ente", "üê¥": "Pferd", "‚ùå": "Keine Tiere" };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries( Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e]) );
  function normalizeToEmojiArray(arr) { if (!Array.isArray(arr)) return []; return arr.map(v => { if (!v) return null; v = String(v).trim(); if (TIERE_EMOJI_TO_NAME[v]) return v; if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; return null; }).filter(Boolean); }
  
  // === INITIALISIERUNG & AUTH ===
  document.getElementById('login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  document.getElementById('logout-btn').onclick = () => auth.signOut();
  auth.onAuthStateChanged(async user => {
      const loginSection = document.getElementById('login-section'); const dashboard = document.getElementById('dashboard'); const adminUserInfo = document.getElementById('admin-user-info');
      if (user) {
          currentUser = user; const adminDoc = await db.collection('admins').doc(user.email).get(); if (!adminDoc.exists) { alert('Zugriff verweigert'); auth.signOut(); return; }
          adminUserInfo.textContent = `Angemeldet: ${user.displayName || user.email}`; loginSection.classList.add('hidden'); dashboard.style.display = 'grid';
          // Event Listeners
          document.getElementById('search-input')?.addEventListener('input', applySearchAndSort); document.getElementById('status-filter')?.addEventListener('change', applySearchAndSort); document.getElementById('select-all-checkbox')?.addEventListener('change', toggleAllCheckboxes); document.getElementById('bulk-action-btn')?.addEventListener('click', handleBulkAction); document.getElementById('hut-table-body')?.addEventListener('change', updateBulkActionUI); document.getElementById('support-search')?.addEventListener('input', applySupportFilters); document.getElementById('support-status-filter')?.addEventListener('change', applySupportFilters); document.getElementById('support-priority-filter')?.addEventListener('change', applySupportFilters); document.getElementById('log-search-input')?.addEventListener('input', loadAdminLogs);
          initHutsListener(); initLiveModerationQueues(); initLiveSupportQueue(); loadAdminLogs(); showSection('overview');
      } else { currentUser = null; loginSection.classList.remove('hidden'); dashboard.style.display = 'none'; adminUserInfo.textContent = ''; _supportMessageUnsubs.forEach(unsub => unsub()); _supportMessageUnsubs.clear(); }
  });

  // === ADMIN LOGGING ===
  async function logAdminAction(action, details = {}) { try { const logEntry = { adminEmail: currentUser.email, adminName: currentUser.displayName || 'N/A', action, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...details }; await db.collection('adminLogs').add(logEntry); } catch (e) { console.error("Log Error:", e); } }
  let fullLogDataCache = [];
  function loadAdminLogs() {
      const logWidget = document.getElementById('admin-log-widget'); const logFullList = document.getElementById('admin-log-full-list'); const logSearchInput = document.getElementById('log-search-input');
      const render = (logs) => {
          const searchTerm = logSearchInput.value.toLowerCase(); const filteredLogs = searchTerm ? logs.filter(log => (log.action?.toLowerCase().includes(searchTerm) || log.adminName?.toLowerCase().includes(searchTerm) || log.hutName?.toLowerCase().includes(searchTerm) || log.ticketId === searchTerm)) : logs;
          logFullList.innerHTML = filteredLogs.map(log => { const time = log.timestamp?.toDate().toLocaleString('de-DE') || ''; let detail = log.hutName ? `H√ºtte: ${escapeHtml(log.hutName)}` : log.ticketId ? `Ticket: ${escapeHtml(log.ticketId)}` : ''; return `<div class="py-2 border-b border-gray-100"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-gray-600">${detail}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`; }).join('') || '<p>Keine Logs.</p>';
          logWidget.innerHTML = logs.slice(0, 10).map(log => { const time = log.timestamp?.toDate().toLocaleDateString('de-DE') || ''; return `<div class="pt-2"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`; }).join('') || '<p>Keine Aktivit√§ten.</p>';
      };
      if (!loadAdminLogs.listenerAttached) { db.collection('adminLogs').orderBy('timestamp', 'desc').limit(200).onSnapshot(snapshot => { fullLogDataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); render(fullLogDataCache); }, err => console.error("Log Load Error:", err)); loadAdminLogs.listenerAttached = true; } 
      else { render(fullLogDataCache); }
  }
  loadAdminLogs.listenerAttached = false;

  // === DATENLADEN & STATISTIKEN ===
  function initHutsListener() { db.collection('eierhuetten').orderBy('erstelltAm', 'desc').onSnapshot(snapshot => { allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); applySearchAndSort(); renderStats(allHuts); renderRegistrationsChart(allHuts); if (currentEditingHutId && hutEditModal.classList.contains('flex')) { openHutModal(currentEditingHutId); } }, err => console.error("Huts Listener Error:", err)); }
  function renderStats(list) { const total = list.length; const angenommen = list.filter(h => h.status === 'angenommen').length; const offen = list.filter(h => h.status === 'offen').length; const abgelehnt = list.filter(h => h.status === 'abgelehnt').length; const pendingFotos = list.reduce((sum, h) => sum + (h.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length, 0); const statsContainer = document.getElementById('statsContainer'); statsContainer.innerHTML = `<div class="card text-center"><p class="text-3xl font-bold">${total}</p><p>Gesamt</p></div><div class="card text-center bg-green-50"><p class="text-3xl font-bold text-green-600">${angenommen}</p><p>Angenommen</p></div><div class="card text-center bg-yellow-50"><p class="text-3xl font-bold text-yellow-600">${offen}</p><p>Offen</p></div><div class="card text-center bg-blue-50"><p class="text-3xl font-bold text-blue-600">${pendingFotos}</p><p>Fotos offen</p></div><div class="card text-center bg-red-50"><p class="text-3xl font-bold text-red-600">${abgelehnt}</p><p>Abgelehnt</p></div>`; const modQueueCount = offen + pendingFotos; const modQueueBadge = document.getElementById('mod-queue-badge'); modQueueBadge.textContent = modQueueCount; modQueueBadge.classList.toggle('hidden', modQueueCount === 0); }
  function renderRegistrationsChart(list) { const ctx = document.getElementById('registrationsChart')?.getContext('2d'); if (!ctx) return; const today = new Date(); const labels = []; const data = Array(30).fill(0); for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); labels.push(d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })); } list.forEach(hut => { const hutDate = hut.erstelltAm?.toDate(); if (!hutDate) return; const diffTime = today - hutDate; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); if (diffDays >= 0 && diffDays < 30) { const index = 29 - diffDays; data[index]++; } }); const chartData = { labels: labels, datasets: [{ label: 'Neue H√ºtten', data: data, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, fill: true, tension: 0.1 }] }; if (registrationsChartInstance) { registrationsChartInstance.data = chartData; registrationsChartInstance.update(); } else { registrationsChartInstance = new Chart(ctx, { type: 'line', data: chartData }); } }

  // === H√úTTEN-TABELLE & BULK-ACTIONS ===
  function applySearchAndSort() { const search = document.getElementById('search-input').value.toLowerCase(); const status = document.getElementById('status-filter').value; filteredHuts = allHuts.filter(hut => (hut.name?.toLowerCase().includes(search) || hut.id.includes(search)) && (status === "" || hut.status === status)); currentPage = 1; renderPage(currentPage); updateBulkActionUI(); }
  function renderPage(page) { const start = (page - 1) * hutsPerPage; const end = start + hutsPerPage; const hutsToRender = filteredHuts.slice(start, end); renderHutsTable(hutsToRender); renderPagination(filteredHuts.length); }
  function renderHutsTable(list) {
      hutTableBody.innerHTML = ''; if (list.length === 0) { hutTableBody.innerHTML = '<tr><td colspan="6" class="text-center italic py-4">Keine H√ºtten gefunden.</td></tr>'; return; }
      list.forEach(hut => {
          let sC = 'bg-gray-100 text-gray-700'; if (hut.status === 'angenommen') sC = 'bg-green-100 text-green-700'; else if (hut.status === 'offen') sC = 'bg-yellow-100 text-yellow-700'; else if (hut.status === 'abgelehnt') sC = 'bg-red-100 text-red-700';
          const pFc = (hut.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length;
          const row = document.createElement('tr'); row.className = 'hover:bg-gray-50';
          row.innerHTML = `
              <td><input type="checkbox" class="hut-checkbox" data-id="${hut.id}"></td>
              <td>
                  <input type="text" value="${escapeAttr(hut.name || 'Unbenannt')}" data-id="${hut.id}" class="inline-edit-input font-semibold text-emerald-700 bg-transparent border-transparent focus:border-gray-300 focus:bg-white p-1" onchange="inlineUpdateField('${hut.id}', 'name', this.value)" placeholder="Name eingeben...">
                  <p class="text-xs text-gray-400">${hut.id}</p>
              </td>
              <td>
                  <select class="inline-edit-select text-xs font-medium px-2 py-1 rounded-full ${sC}" onchange="inlineUpdateField('${hut.id}', 'status', this.value)">
                      ${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}
                  </select>
              </td>
              <td class="text-sm text-gray-600">${hut.erstelltAm?.toDate().toLocaleDateString('de-DE') || '-'}</td>
              <td class="text-sm ${pFc > 0 ? 'text-blue-600 font-semibold' : ''}">${pFc}</td>
              <td><button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Details</button></td>
          `;
          hutTableBody.appendChild(row);
      });
  }
  function renderPagination(totalItems) { const tP = Math.ceil(totalItems / hutsPerPage); const pC = document.getElementById('pagination'); pC.innerHTML = ''; if (tP <= 1) return; const cPB = (l, p, iA = false, iD = false) => { const b = document.createElement('button'); b.innerHTML = l; b.disabled = iD; b.className = `px-3 py-1 border rounded-md mx-1 ${iA ? 'bg-emerald-600 text-white' : 'bg-white hover:bg-gray-100'} ${iD ? 'text-gray-300' : ''}`; if (!iD) b.onclick = () => { currentPage = p; renderPage(currentPage); }; return b; }; pC.appendChild(cPB('&laquo;', currentPage - 1, false, currentPage === 1)); let sP = Math.max(1, currentPage - 2); let eP = Math.min(tP, currentPage + 2); if (sP > 1) pC.appendChild(cPB('1', 1)); if (sP > 2) pC.appendChild(cPB('...', 1, false, true)); for (let i = sP; i <= eP; i++) pC.appendChild(cPB(i, i, i === currentPage)); if (eP < tP - 1) pC.appendChild(cPB('...', tP, false, true)); if (eP < tP) pC.appendChild(cPB(tP, tP)); pC.appendChild(cPB('&raquo;', currentPage + 1, false, currentPage === tP)); }
  function toggleAllCheckboxes() { const iC = selectAllCheckbox.checked; hutTableBody.querySelectorAll('.hut-checkbox').forEach(cb => cb.checked = iC); updateBulkActionUI(); }
  function updateBulkActionUI() { const sC = hutTableBody.querySelectorAll('.hut-checkbox:checked').length; bulkActionContainer.classList.toggle('hidden', sC === 0); if (sC === 0) selectAllCheckbox.checked = false; }
  async function handleBulkAction() { const act = document.getElementById('bulk-action-select').value; const sIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id); if (!act || sIds.length === 0) { showNotification('‚ö†Ô∏è Aktion & H√ºtten w√§hlen.'); return; } let cM = `Aktion '${act}' f√ºr ${sIds.length} H√ºtten?`; if (act === 'delete') cM = `‚ùó ${sIds.length} H√ºtten L√ñSCHEN?`; if (!confirm(cM)) return; bulkActionBtn.disabled = true; bulkActionBtn.classList.add('button-loading'); let succ = 0; for (const id of sIds) { try { if (act === 'approve') await quickUpdateStatus(id, 'angenommen'); else if (act === 'reject') await quickUpdateStatus(id, 'abgelehnt'); else if (act === 'delete') await deleteHut(id, true); succ++; } catch (e) { console.error(`Bulk Error ${id}:`, e); } } bulkActionBtn.disabled = false; bulkActionBtn.classList.remove('button-loading'); showNotification(`‚úÖ ${succ}/${sIds.length} verarbeitet.`); applySearchAndSort(); }
  async function inlineUpdateField(hutId, field, value) {
      if (!value && field === 'name') { showNotification('‚ùå Name darf nicht leer sein.'); renderPage(currentPage); return; } // Prevent empty name
      try {
          const ref = db.collection('eierhuetten').doc(hutId);
          await ref.update({ [field]: value });
          const hut = allHuts.find(h => h.id === hutId);
          logAdminAction(`Inline Update: ${field} -> ${value}`, { hutId, hutName: hut?.name });
          ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: field, wert: value, zeitpunkt: new Date() });
          showNotification(`‚úÖ ${field} aktualisiert.`);
          // Optional: Highlight row briefly
          const row = hutTableBody.querySelector(`input[data-id="${hutId}"]`)?.closest('tr');
          if(row) { row.style.backgroundColor = '#d1fae5'; setTimeout(() => row.style.backgroundColor = '', 1000); }
      } catch(e) { console.error("Inline Update Error:", e); showNotification(`‚ùå Fehler: ${e.message}`); renderPage(currentPage); /* Revert UI on error */ }
  }


  // === H√úTTEN-MODAL ===
  function closeHutModal() { /* ... V5 code ... */ }
  async function openHutModal(hutId) { /* ... V5 code ... */ }
  async function generateDescriptionForModal() { /* ... V5 code ... */ }
  async function suggestTagsForEditModal(hutId) { /* ... V5 code ... */ }
  function collectCurrentModalData() { /* ... V5 code ... */ }
  function showModalTab(tabId) { /* ... V5 code ... */ }
  function initModalMap(location) { /* ... V5 code ... */ }
  function handleMarkerDrag(e) { /* ... V5 code ... */ }

  // === H√úTTEN-CRUD ===
  async function saveHutFromModal() { /* ... V5 code ... */ }
  async function quickUpdateStatus(hutId, status) { /* ... V5 code ... */ } // Wird auch f√ºr Bulk verwendet
  async function deleteHut(id, skipConfirm = false) { /* ... V5 code ... */ }

  // === FOTO-VERWALTUNG ===
  async function approveFoto(hutId, index) { /* ... V5 code ... */ }
  async function rejectFoto(hutId, index) { /* ... V5 code ... */ }
  async function renderSmartImageUploader(container, docRef, existingImages = [], entryId) { /* ... V5 code ... */ }
  function debounce(func, wait) { /* ... V5 code ... */ }
  async function generateSingleImageTitle(buttonElement) { /* ... V5 code ... */ }
  async function generateSmartImageTitle(url, filename = "") { /* ... V5 code ... */ }

  // === TIERE-VERWALTUNG ===
  async function toggleTier(hutId, emoji) { /* ... V5 code ... */ }
  
  // === √ñFFNUNGSZEITEN EDITOR ===
  const DAY_LABELS = [ /* ... V5 code ... */ ];
  function renderOpeningHoursEditor(elemId, data = {}) { /* ... V5 code ... */ }
  function attachOpeningHoursListeners(elemId) { /* ... V5 code ... */ }
  function collectOpeningHours(elemId) { /* ... V5 code ... */ }
  function normalizeOpeningHours(oeff) { /* ... V5 code ... */ }

  // === NAVIGATION ===
  function showSection(id) { /* ... V5 code ... */ }
  function showNotification(message) { /* ... V5 code ... */ }

  // === MODERATIONS-SEITE ===
  function initLiveModerationQueues() { /* ... V5 code ... */ }
  async function bulkApproveHuts() { /* ... V5 code ... */ }

  // === SUPPORT-SYSTEM ===
  let currentSupportTickets = []; let allSupportTickets = []; const SUPPORT_MSG_MAX = 500;
  function initLiveSupportQueue() { /* ... V5 code ... */ }
  function applySupportFilters() { /* ... V5 code ... */ }
  function renderSupportTable() { /* ... V5 code ... */ }
  async function loadSupportMessagePreview(ticketId) { /* ... V5 code ... */ }
  async function openReplyModal(ticketId) { /* ... V5 code ... */ }
  function closeReplyModal() { /* ... V5 code ... */ }
  async function saveSupportTicketChanges() { /* ... V5 code ... */ }
  function deleteSupportTicketFromModal() { /* ... V5 code ... */ }
  async function deleteSupport(ticketId) { /* ... V5 code ... */ }
  document.getElementById("modal-reply-text")?.addEventListener("input", e => { const left = SUPPORT_MSG_MAX - e.target.value.length; document.getElementById("modal-reply-counter").innerText = `${left} Zeichen √ºbrig`; });
  
  // === PROFIL-VERWALTUNG ===
  let currentProfileId = null;
  async function loadProfileAdmin(id) { /* ... V5 code ... */ }
  async function saveProfileAdmin() { /* ... V5 code ... */ }
  async function deleteProfileAdmin() { /* ... V5 code ... */ }
  document.getElementById('profile-search')?.addEventListener('input', async e => { /* ... V5 code ... */ });
  window.selectProfile = (id, name) => { /* ... V5 code ... */ };

  // === TITEL & ABZEICHEN ===
  let titleEditId = null; let badgeEditId = null;
  async function loadTitles() { /* ... V5 code ... */ }
  window.editTitle = (id, name, type, value) => { /* ... V5 code ... */ };
  window.deleteTitle = async (id, name) => { /* ... V5 code ... */ };
  document.getElementById("title-form")?.addEventListener("submit", async (e) => { /* ... V5 code ... */ });
  async function loadBadges() { /* ... V5 code ... */ }
  window.editBadge = (id, name, icon, type, value) => { /* ... V5 code ... */ };
  window.deleteBadge = async (id, name) => { /* ... V5 code ... */ };
  document.getElementById("badge-form")?.addEventListener("submit", async (e) => { /* ... V5 code ... */ });
  async function badgeFormUploadToImgBB(file) { /* ... V5 code ... */ }
  document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]')?.addEventListener('click', () => { loadTitles(); loadBadges(); });
  
  // === HILFSFUNKTIONEN ===
  function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function escapeAttr(s) { if (!s && s !== 0) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  function stripHtml(html){ if(!html) return ''; let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
  
  // === KI Beschreibung & Tags ===
  async function generateProfessionalDescription(d) { /* ... V5 code ... */ }
  async function generateAITags(data) { /* ... V5 code ... */ }


</script>
</body>
</html>
