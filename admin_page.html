<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard V4</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Generelle Stil-Anpassungen */
    body { font-family: 'Inter', sans-serif; }
    .nav-group-title {
        font-size: 0.75rem; font-weight: 600; color: #6b7280;
        text-transform: uppercase; letter-spacing: 0.05em;
        padding: 0.5rem 1rem; margin-top: 1rem;
    }
    .nav-btn {
      display: flex; align-items: center; gap: 0.75rem; text-align: left;
      padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s;
      font-weight: 500; color: #374151;
    }
    .nav-btn:hover { background-color: #f3f4f6; }
    .nav-btn.active {
      background-color: #10b981; color: white; font-weight: 600;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    
    /* Leaflet Karten-Stil */
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    
    /* Modal Stile */
    .modal-backdrop {
        position: fixed; inset: 0; z-index: 40;
        background-color: rgba(0, 0, 0, 0.6); display: none; /* Changed */
        align-items: center; justify-content: center; padding: 1rem;
    }
    .modal-backdrop.flex { display: flex; } /* Added */
    .modal-content {
        background: white; border-radius: 0.75rem; padding: 0;
        width: 100%; max-width: 56rem; /* Increased width */
        max-height: 90vh; display: flex; flex-direction: column;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
    
    /* Modal Tabs */
    .modal-tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 1.5rem; }
    .modal-tab {
        padding: 1rem 0.5rem; margin-bottom: -1px; border-bottom: 2px solid transparent;
        cursor: pointer; font-weight: 500; color: #6b7280;
    }
    .modal-tab:hover { color: #111827; }
    .modal-tab.active { color: #10b981; border-color: #10b981; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    
    /* Quill Editor height */
    .ql-container { min-height: 150px; }

    /* Admin-Tabelle */
    .admin-table { width: 100%; text-align: left; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .admin-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .admin-table tr:hover { background-color: #f9fafb; }
    
    /* Notification */
    #notification {
      position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white;
      padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    /* Lade-Spinner & Button Loading State */
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .button-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    
    /* Priority Colors */
    .priority-Hoch { border-left: 4px solid #ef4444; } /* red-500 */
    .priority-Normal { border-left: 4px solid #f97316; } /* orange-500 */
    .priority-Niedrig { border-left: 4px solid #84cc16; } /* lime-500 */
  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an, um fortzufahren.</p>
      <button id="login-btn"
        class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full">
        Mit Google Anmelden
      </button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- üü¶ Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4">
        <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1>
      </div>
      <nav class="flex-1 space-y-1">
        <!-- Gruppe 1 -->
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä Dashboard</button>
        
        <!-- Gruppe 2: Inhalte -->
        <div class="nav-group-title">Inhalte</div>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('moderation')">
            üõ°Ô∏è Moderation
            <span id="mod-queue-badge" class="ml-auto bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        
        <!-- Gruppe 3: Benutzer -->
        <div class="nav-group-title">Benutzer</div>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('support')">
            üì® Support-Tickets
            <span id="support-queue-badge" class="ml-auto bg-blue-400 text-blue-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        
        <!-- Gruppe 4: System -->
        <div class="nav-group-title">System</div>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Gamification</button>
        <button class="nav-btn w-full" onclick="showSection('system-logs')">üìú System-Protokoll</button>
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200">
         <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div>
         <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button>
      </div>
    </aside>

    <!-- üü© Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      
      <!-- √úbersicht (Dashboard) -->
      <section id="overview" class="space-y-8">
        <div> <h2 class="section-title">Willkommen zur√ºck!</h2> <p class="text-gray-600">√úberblick √ºber die aktuellen Aktivit√§ten.</p> </div>
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6"></div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 card"> <h3 class="font-bold text-lg mb-4">H√ºtten-Registrierungen (Letzte 30 Tage)</h3> <canvas id="registrationsChart"></canvas> </div>
          <div class="lg:col-span-2 card"> <h3 class="font-bold text-lg mb-4">Letzte Admin-Aktivit√§ten</h3> <div id="admin-log-widget" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
        </div>
      </section>

      <!-- H√ºttenliste -->
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4"> <h2 class="section-title">üè† Alle H√ºtten verwalten</h2> <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-emerald-700 transition">+ H√ºtte hinzuf√ºgen</button> </div>
        <div class="card">
            <div class="flex justify-between items-center gap-4 mb-4">
                <div class="flex gap-4">
                    <input id="search-input" placeholder="üîç Suchen nach Name..." class="p-2 border rounded-md w-full">
                    <select id="status-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Status</option> <option value="angenommen">Angenommen</option> <option value="offen">Offen</option> <option value="abgelehnt">Abgelehnt</option> </select>
                </div>
                <div id="bulk-action-container" class="hidden">
                    <select id="bulk-action-select" class="p-2 border rounded-md bg-white"> <option value="">Massen-Aktion...</option> <option value="approve">Auswahl freigeben</option> <option value="reject">Auswahl ablehnen</option> <option value="delete">Auswahl L√ñSCHEN</option> </select>
                    <button id="bulk-action-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg ml-2 hover:bg-blue-700">OK</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead> <tr> <th class="w-10"><input type="checkbox" id="select-all-checkbox"></th> <th>Name</th> <th>Status</th> <th>Erstellt am</th> <th>Pending Fotos</th> <th>Aktionen</th> </tr> </thead>
                    <tbody id="hut-table-body"></tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      
      <!-- Moderation -->
      <section id="moderation" class="hidden">
        <h2 class="section-title">üõ°Ô∏è Moderations-Warteschlange</h2>
        <div class="card">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg">üÜï Neue Eintragungen</h3> <button id="bulk-approve-huts" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm">Alle freigeben</button> </div> <div id="neueListe-page" class="space-y-2 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
                 <div> <h3 class="font-bold text-lg mb-4">üì∑ Fotos warten auf Freigabe</h3> <div id="pending-fotos-page" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
            </div>
        </div>
      </section>
      
      <!-- Support-Tickets -->
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <div class="mb-4 flex gap-4">
              <input id="support-search" class="p-2 border rounded-md flex-grow" placeholder="Suche nach E-Mail oder Inhalt...">
              <select id="support-status-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Status</option> <option value="offen">Offen</option> <option value="bearbeitet">Bearbeitet</option> <option value="geschlossen">Geschlossen</option> <option value="archiviert">Archiviert</option>
              </select>
              <select id="support-priority-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Priorit√§ten</option> <option value="Hoch">Hoch</option> <option value="Normal">Normal</option> <option value="Niedrig">Niedrig</option>
              </select>
          </div>
          <table class="admin-table">
            <thead> <tr> <th class="px-4 py-2">Priorit√§t</th> <th class="px-4 py-2">Datum</th> <th class="px-4 py-2">User</th> <th class="px-4 py-2">Nachrichten</th> <th class="px-4 py-2">Status</th> <th class="px-4 py-2">Aktionen</th> </tr> </thead>
            <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile Verwaltung</h2>
        <div class="card">
          <div class="relative max-w-md"> <input id="profile-search" type="text" class="w-full border p-2 rounded-md" placeholder="Profil nach Name suchen..." /> <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded-md shadow-lg hidden z-10"></div> </div>
          <div id="profile-admin-area" class="hidden space-y-4 mt-6 border-t pt-6"></div>
        </div>
      </section>
      
      <!-- Gamification -->
      <section id="gamification" class="hidden">
          <h2 class="section-title">üèÜ Gamification</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="card">
                  <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel Verwaltung</h3>
                  <div id="title-list" class="space-y-2"></div>
                  <form id="title-form" class="mt-4 space-y-2 border-t pt-4"> <input id="title-name" placeholder="Titel-Name" class="border p-2 rounded w-full"> <select id="title-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> </select> <input id="title-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Titel speichern</button> </form>
              </div>
              <div class="card">
                  <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen Verwaltung</h3>
                  <div id="badge-list-admin" class="space-y-2"></div>
                  <form id="badge-form" class="mt-4 space-y-2 border-t pt-4"> <input id="badge-name" placeholder="Abzeichen-Name" class="border p-2 rounded w-full"> <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"> <input id="badge-icon" placeholder="Emoji/Icon (Fallback)" class="border p-2 rounded w-full"> <select id="badge-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> <option value="night">Nachtfahrt</option> </select> <input id="badge-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Abzeichen speichern</button> </form>
              </div>
          </div>
      </section>
      
      <!-- System-Protokoll -->
      <section id="system-logs" class="hidden">
        <h2 class="section-title">üìú Globales System-Protokoll</h2>
        <div class="card"> <input id="log-search-input" class="w-full border p-2 rounded-md mb-4" placeholder="Logs durchsuchen (z.B. nach Aktion oder Admin-Name)..."> <div id="admin-log-full-list" class="space-y-3 max-h-[70vh] overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
      </section>
    </main>
  </div>
  
  <!-- Modals -->
  <div id="support-reply-modal" class="modal-backdrop">
      <div class="modal-content max-w-2xl">
        <div class="modal-header"> <h3 class="text-lg font-bold">Ticket bearbeiten</h3> <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button> </div>
        <div class="modal-body grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Left: Conversation & Reply -->
            <div>
                <div id="modal-ticket-info" class="text-sm text-gray-500 mb-4"></div>
                <div id="modal-message-history" class="space-y-3 max-h-60 overflow-y-auto border rounded p-3 mb-4 bg-gray-50"></div>
                <h4 class="font-semibold mb-2">Antworten:</h4>
                <textarea id="modal-reply-text" class="w-full border p-2 rounded-md mb-2" rows="4" maxlength="500" placeholder="Deine Antwort an den Benutzer..."></textarea>
                <div class="text-xs text-gray-500 mb-4 text-right" id="modal-reply-counter">500 Zeichen √ºbrig</div>
            </div>
            <!-- Right: Admin Actions -->
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-1">Status</label>
                    <select id="modal-ticket-status" class="w-full border p-2 rounded-md bg-white"></select>
                </div>
                 <div>
                    <label class="block font-semibold mb-1">Priorit√§t</label>
                    <select id="modal-ticket-priority" class="w-full border p-2 rounded-md bg-white">
                        <option value="Niedrig">Niedrig</option>
                        <option value="Normal">Normal</option>
                        <option value="Hoch">Hoch</option>
                    </select>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Interne Notizen (Nur Admins)</h4>
                    <div id="modal-internal-notes-history" class="space-y-2 max-h-40 overflow-y-auto border rounded p-2 mb-2 bg-gray-50 text-xs"></div>
                    <textarea id="modal-internal-note" class="w-full border p-2 rounded-md" rows="3" placeholder="Interne Notiz hinzuf√ºgen..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer flex justify-between">
            <button onclick="deleteSupportTicketFromModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">Ticket L√∂schen</button>
            <div class="flex gap-2">
                <button onclick="closeReplyModal()" class="px-4 py-2 bg-gray-300 rounded-lg text-sm">Abbrechen</button>
                <button onclick="saveSupportTicketChanges()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">Speichern & Senden</button>
            </div>
        </div>
      </div>
  </div>

  <div id="hut-edit-modal" class="modal-backdrop">
      <div id="hut-edit-modal-content" class="modal-content">
        <div class="flex justify-center items-center h-64"> <div class="spinner"></div> </div>
      </div>
  </div>
  
  <!-- Platzhalter f√ºr Admin-Karte (neue H√ºtte) -->
  <div id="admin-map-container" style="display:none;"></div>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // === GLOBALE VARIABLEN ===
  let currentUser = null;
  let allHuts = [];
  let filteredHuts = []; // F√ºr die H√ºtten-Tabelle
  let currentPage = 1;
  const hutsPerPage = 15;
  let currentEditingHutId = null;
  let currentEditingSupportTicketId = null; // F√ºr Support-Modal
  let registrationsChartInstance;
  let adminModalMap;
  let adminModalMarker;
  let adminModalLocation;
  let quillInstance = null; // F√ºr den Editor im Hut-Modal
  const _supportMessageUnsubs = new Map(); // Unsubscriber f√ºr Support-Nachrichten

  // === DOM-ELEMENTE ===
  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const notification = document.getElementById('notification');
  const statsContainer = document.getElementById('statsContainer');
  const hutEditModal = document.getElementById('hut-edit-modal');
  const hutEditModalContent = document.getElementById('hut-edit-modal-content');
  const supportReplyModal = document.getElementById('support-reply-modal'); // Support Modal
  const adminUserInfo = document.getElementById('admin-user-info');
  const hutTableBody = document.getElementById('hut-table-body');
  const selectAllCheckbox = document.getElementById('select-all-checkbox');
  const bulkActionContainer = document.getElementById('bulk-action-container');
  const bulkActionBtn = document.getElementById('bulk-action-btn');
  const modQueueBadge = document.getElementById('mod-queue-badge');
  const supportQueueBadge = document.getElementById('support-queue-badge');
  const supportTicketsBody = document.getElementById('support-tickets-body');
  const supportSearchInput = document.getElementById('support-search');
  const supportStatusFilter = document.getElementById('support-status-filter');
  const supportPriorityFilter = document.getElementById('support-priority-filter');

  // === TIERE MAPPING ===
  const TIERE_EMOJI_TO_NAME = { "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege", "üêë": "Schaf", "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase", "üêî": "Huhn", "ü¶Ü": "Ente", "üê¥": "Pferd", "‚ùå": "Keine Tiere" };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries( Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e]) );

  function normalizeToEmojiArray(arr) {
    if (!Array.isArray(arr)) return [];
    return arr.map(v => {
      if (!v) return null;
      v = String(v).trim();
      if (TIERE_EMOJI_TO_NAME[v]) return v; // already emoji
      if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; // name -> emoji
      return null;
    }).filter(Boolean);
  }
  
  // === INITIALISIERUNG & AUTH ===
  document.getElementById('login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  document.getElementById('logout-btn').onclick = () => auth.signOut();

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      const adminDoc = await db.collection('admins').doc(user.email).get();
      if (!adminDoc.exists) { alert('Zugriff verweigert'); auth.signOut(); return; }
      
      adminUserInfo.textContent = `Angemeldet als ${user.displayName || user.email}`;
      loginSection.classList.add('hidden');
      dashboard.classList.add('hidden'); // 'hidden' statt 'flex'
      dashboard.style.display = 'grid'; // explizit grid setzen

      // Event Listeners
      searchInput.addEventListener('input', applySearchAndSort);
      statusFilter.addEventListener('change', applySearchAndSort);
      selectAllCheckbox.addEventListener('change', toggleAllCheckboxes);
      bulkActionBtn.addEventListener('click', handleBulkAction);
      hutTableBody.addEventListener('change', updateBulkActionUI);
      supportSearchInput.addEventListener('input', applySupportFilters);
      supportStatusFilter.addEventListener('change', applySupportFilters);
      supportPriorityFilter.addEventListener('change', applySupportFilters);


      // Live Listeners starten
      initHutsListener();
      initLiveModerationQueues();
      initLiveSupportQueue(); // L√§dt auch initial die Liste
      loadAdminLogs();
      
      showSection('overview');
    } else {
      currentUser = null;
      loginSection.classList.remove('hidden');
      dashboard.style.display = 'none'; // 'hidden' statt 'flex'
      adminUserInfo.textContent = '';
      // Clear listeners if necessary
       _supportMessageUnsubs.forEach(unsub => unsub());
       _supportMessageUnsubs.clear();
    }
  });

  // === ADMIN LOGGING ===
  async function logAdminAction(action, details = {}) {
      if (!currentUser) return;
      try {
          const logEntry = { adminEmail: currentUser.email, adminName: currentUser.displayName || 'N/A', action, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...details };
          await db.collection('adminLogs').add(logEntry);
      } catch (e) { console.error("Log Error:", e); }
  }

  function loadAdminLogs() {
      const logWidget = document.getElementById('admin-log-widget');
      const logFullList = document.getElementById('admin-log-full-list');
      const logSearchInput = document.getElementById('log-search-input');
      let fullLogData = []; // Cache f√ºr client-seitige Filterung

      const renderLogs = (snapshot) => {
          fullLogData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          applyLogFilter(); // Render based on current filter

          // Update Widget (immer die neuesten 10)
          logWidget.innerHTML = fullLogData.slice(0, 10).map(log => {
              const time = log.timestamp?.toDate().toLocaleDateString('de-DE') || '';
              return `<div class="pt-2"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`;
          }).join('') || '<p class="text-gray-500 italic">Keine Aktivit√§ten.</p>';
      };
      
      const applyLogFilter = () => {
          const term = logSearchInput.value.toLowerCase();
          const filteredLogs = term ? fullLogData.filter(log => 
              (log.action?.toLowerCase().includes(term) || 
               log.adminName?.toLowerCase().includes(term) ||
               log.hutName?.toLowerCase().includes(term) ||
               log.profileName?.toLowerCase().includes(term) ||
               log.ticketId === term)
          ) : fullLogData;

          logFullList.innerHTML = filteredLogs.map(log => {
              const time = log.timestamp?.toDate().toLocaleString('de-DE') || '';
              let detailText = log.hutName ? `H√ºtte: ${escapeHtml(log.hutName)}` : 
                               log.ticketId ? `Ticket: ${escapeHtml(log.ticketId)}` : 
                               log.profileName ? `Profil: ${escapeHtml(log.profileName)}` : '';
              return `<div class="pt-2 pb-2 border-b border-gray-100"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-gray-600">${detailText}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`;
          }).join('') || '<p class="text-gray-500 italic">Keine Logs gefunden.</p>';
      };

      db.collection('adminLogs').orderBy('timestamp', 'desc').limit(100) // Lade mehr f√ºr Filterung
        .onSnapshot(renderLogs, err => { console.error("Log Load Error:", err); /* Error UI */ });
      
      logSearchInput.addEventListener('input', applyLogFilter);
  }

  // === DATENLADEN & STATISTIKEN ===
  function initHutsListener() {
    db.collection('eierhuetten').orderBy('erstelltAm', 'desc').onSnapshot(snapshot => {
      allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      applySearchAndSort();
      renderStats(allHuts);
      renderRegistrationsChart(allHuts);
      if (currentEditingHutId && document.getElementById('hut-edit-modal').classList.contains('flex')) {
         // Nur wenn Modal offen ist, Inhalt aktualisieren (verhindert Neuladen bei Hintergrund-Updates)
         openHutModal(currentEditingHutId); 
      }
      // showNotification('üîÑ Live-Update: H√ºttendaten.'); // Kann nervig sein, ggf. entfernen
    }, err => console.error("Huts Listener Error:", err));
  }

  function renderStats(list) {
      const total = list.length;
      const angenommen = list.filter(h => h.status === 'angenommen').length;
      const offen = list.filter(h => h.status === 'offen').length;
      const abgelehnt = list.filter(h => h.status === 'abgelehnt').length;
      const pendingFotos = list.reduce((sum, h) => sum + (h.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length, 0);

      statsContainer.innerHTML = `
          <div class="card text-center"><p class="text-3xl font-bold">${total}</p><p class="text-gray-500">Gesamt</p></div>
          <div class="card text-center bg-green-50"><p class="text-3xl font-bold text-green-600">${angenommen}</p><p class="text-gray-500">Angenommen</p></div>
          <div class="card text-center bg-yellow-50"><p class="text-3xl font-bold text-yellow-600">${offen}</p><p class="text-gray-500">Offen</p></div>
          <div class="card text-center bg-blue-50"><p class="text-3xl font-bold text-blue-600">${pendingFotos}</p><p class="text-gray-500">Fotos offen</p></div>
          <div class="card text-center bg-red-50"><p class="text-3xl font-bold text-red-600">${abgelehnt}</p><p class="text-gray-500">Abgelehnt</p></div>
      `;
      const modQueueCount = offen + pendingFotos;
      modQueueBadge.textContent = modQueueCount;
      modQueueBadge.classList.toggle('hidden', modQueueCount === 0);
  }

  function renderRegistrationsChart(list) {
      const ctx = document.getElementById('registrationsChart')?.getContext('2d');
      if (!ctx) return;
      
      const today = new Date();
      const labels = [];
      const data = Array(30).fill(0); // Array mit 30 Nullen initialisieren
      
      for (let i = 29; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          labels.push(d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }));
      }
      
      list.forEach(hut => {
          const hutDate = hut.erstelltAm?.toDate();
          if (!hutDate) return;
          const diffTime = today - hutDate; // Keine Notwendigkeit f√ºr Math.abs
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays >= 0 && diffDays < 30) {
              const index = 29 - diffDays;
              data[index]++;
          }
      });
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'Neue H√ºtten', data: data,
          backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2, fill: true, tension: 0.1
        }]
      };

      if (registrationsChartInstance) {
          registrationsChartInstance.data = chartData;
          registrationsChartInstance.update();
      } else {
          registrationsChartInstance = new Chart(ctx, { type: 'line', data: chartData });
      }
  }


  // === H√úTTEN-TABELLE & BULK-ACTIONS ===
  function applySearchAndSort() {
    const search = searchInput.value.toLowerCase() || "";
    const status = statusFilter.value || "";
    filteredHuts = allHuts.filter(hut => 
        (hut.name?.toLowerCase().includes(search) || hut.id.includes(search)) && 
        (status === "" || hut.status === status)
    );
    // Beibehaltung der Sortierung nach erstelltAm (aus Firestore)
    currentPage = 1;
    renderPage(currentPage);
    updateBulkActionUI();
  }

  function renderPage(page) {
    const start = (page - 1) * hutsPerPage;
    const end = start + hutsPerPage;
    const hutsToRender = filteredHuts.slice(start, end);
    renderHutsTable(hutsToRender);
    renderPagination(filteredHuts.length);
  }

  function renderHutsTable(list) {
    hutTableBody.innerHTML = '';
    if (list.length === 0) { hutTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 italic py-4">Keine H√ºtten gefunden.</td></tr>'; return; }
    list.forEach(hut => {
      let statusColor = 'bg-gray-100 text-gray-700';
      if (hut.status === 'angenommen') statusColor = 'bg-green-100 text-green-700'; else if (hut.status === 'offen') statusColor = 'bg-yellow-100 text-yellow-700'; else if (hut.status === 'abgelehnt') statusColor = 'bg-red-100 text-red-700';
      const pendingFotosCount = (hut.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length;
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td><input type="checkbox" class="hut-checkbox" data-id="${hut.id}"></td>
        <td><p class="font-semibold text-emerald-700">${escapeHtml(hut.name || 'Unbenannt')}</p><p class="text-xs text-gray-400">${hut.id}</p></td>
        <td><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${escapeHtml(hut.status || 'N/A')}</span></td>
        <td class="text-sm text-gray-600">${hut.erstelltAm?.toDate().toLocaleDateString('de-DE') || '-'}</td>
        <td class="text-sm ${pendingFotosCount > 0 ? 'text-blue-600 font-semibold' : ''}">${pendingFotosCount}</td>
        <td><button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Bearbeiten</button></td>
      `;
      hutTableBody.appendChild(row);
    });
  }
  
  function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / hutsPerPage);
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = '';
      if (totalPages <= 1) return;

      const createPageBtn = (label, pageNum, isActive = false, isDisabled = false) => {
          const btn = document.createElement('button');
          btn.innerHTML = label; // Use innerHTML for potential arrows
          btn.disabled = isDisabled;
          btn.className = `px-3 py-1 border rounded-md mx-1 ${isActive ? 'bg-emerald-600 text-white' : 'bg-white hover:bg-gray-100'} ${isDisabled ? 'text-gray-300 cursor-not-allowed' : ''}`;
          if (!isDisabled) {
              btn.onclick = () => { currentPage = pageNum; renderPage(currentPage); };
          }
          return btn;
      };

      // Previous Button
      paginationContainer.appendChild(createPageBtn('&laquo;', currentPage - 1, false, currentPage === 1));

      // Page Numbers (simplified example: show current +/- 2 pages)
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) paginationContainer.appendChild(createPageBtn('1', 1));
      if (startPage > 2) paginationContainer.appendChild(createPageBtn('...', 1, false, true)); // Ellipsis

      for (let i = startPage; i <= endPage; i++) {
          paginationContainer.appendChild(createPageBtn(i, i, i === currentPage));
      }

      if (endPage < totalPages - 1) paginationContainer.appendChild(createPageBtn('...', totalPages, false, true)); // Ellipsis
      if (endPage < totalPages) paginationContainer.appendChild(createPageBtn(totalPages, totalPages));
      
      // Next Button
      paginationContainer.appendChild(createPageBtn('&raquo;', currentPage + 1, false, currentPage === totalPages));
  }
  
  function toggleAllCheckboxes() {
      const isChecked = selectAllCheckbox.checked;
      hutTableBody.querySelectorAll('.hut-checkbox').forEach(cb => cb.checked = isChecked);
      updateBulkActionUI();
  }
  
  function updateBulkActionUI() {
      const selectedCount = hutTableBody.querySelectorAll('.hut-checkbox:checked').length;
      bulkActionContainer.classList.toggle('hidden', selectedCount === 0);
      if (selectedCount === 0) selectAllCheckbox.checked = false;
  }
  
  async function handleBulkAction() {
      const action = document.getElementById('bulk-action-select').value;
      const selectedIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id);
      if (!action || selectedIds.length === 0) { showNotification('‚ö†Ô∏è Bitte Aktion und H√ºtten ausw√§hlen.'); return; }
      
      let confirmMessage = `M√∂chten Sie die ${selectedIds.length} ausgew√§hlten H√ºtten wirklich ${action}?`;
      if (action === 'delete') confirmMessage = `‚ùó ACHTUNG: ${selectedIds.length} H√ºtten ENDG√úLTIG L√ñSCHEN?`;
      if (!confirm(confirmMessage)) return;

      bulkActionBtn.disabled = true; bulkActionBtn.classList.add('button-loading');
      
      let successCount = 0;
      for (const id of selectedIds) {
          try {
              if (action === 'approve') await quickUpdateStatus(id, 'angenommen');
              else if (action === 'reject') await quickUpdateStatus(id, 'abgelehnt');
              else if (action === 'delete') await deleteHut(id, true); // true = skip confirm
              successCount++;
          } catch (e) { console.error(`Bulk Error for ${id}:`, e); }
      }
      
      bulkActionBtn.disabled = false; bulkActionBtn.classList.remove('button-loading');
      showNotification(`‚úÖ ${successCount}/${selectedIds.length} H√ºtten verarbeitet.`);
      applySearchAndSort(); // Reload list
  }
  
  
  // === H√úTTEN-MODAL (mit Tabs & √ñffnungszeiten) ===
  function closeHutModal() {
    hutEditModal.classList.remove('flex');
    hutEditModalContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>'; // Reset
    currentEditingHutId = null;
    adminModalMap = null; adminModalLocation = null; quillInstance = null; // Instanzen zur√ºcksetzen
  }

  async function openHutModal(hutId) {
      currentEditingHutId = hutId;
      let hut;
      let title = "Neue H√ºtte erstellen";
      let logs = [];
      let stats = { views: 0, routeStarts: 0 };

      if (hutId) {
          hut = allHuts.find(h => h.id === hutId);
          if (!hut) { showNotification('‚ùå H√ºtte nicht gefunden.'); return; }
          title = `H√ºtte bearbeiten: ${escapeHtml(hut.name)}`;
          stats = { views: hut.views || 0, routeStarts: hut.routeStarts || 0 };
          try {
              const logSnap = await db.collection('eierhuetten').doc(hutId).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get();
              logs = logSnap.docs.map(doc => doc.data());
          } catch (e) { console.error("Log Load Error:", e); }
      } else {
          hut = { id: null, name: 'Neue H√ºtte', status: 'angenommen', tiere: [], fotos: [], location: null, oeffnungszeiten: {} }; // Default √ñffnungszeiten ist leeres Objekt
      }
      
      // --- HTML-Bl√∂cke f√ºr Tabs ---
      const selectedEmojis = new Set(normalizeToEmojiArray(hut.tiere || []));
      const tiereHTML = Object.entries(TIERE_EMOJI_TO_NAME).map(([emoji, name]) => `<button type="button" data-emoji="${emoji}" class="admin-tiere-btn text-2xl rounded p-2 ${selectedEmojis.has(emoji) ? 'bg-yellow-200 ring-2 ring-yellow-400' : 'bg-gray-100 hover:bg-gray-200'}" title="${escapeAttr(name)}">${emoji}</button>`).join('');
      
      const tabStammdaten = `<div class="space-y-6"> <div class="grid grid-cols-1 md:grid-cols-2 gap-6"> <div class="space-y-4"> <div><label class="block font-semibold mb-1">Name</label><input id="modal-hut-name" class="w-full border p-2 rounded-md" value="${escapeAttr(hut.name || '')}"></div> <div><label class="block font-semibold mb-1">Status</label><select id="modal-hut-status" class="w-full border p-2 rounded-md bg-white">${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}</select></div> <div class="relative"><label class="block font-semibold mb-1">Beschreibung</label><div id="quillContainer" class="bg-white border rounded min-h-[150px]"></div><button id="aiDescBtnModal" class="absolute top-0 right-0 mt-1 mr-1 px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">ü™Ñ KI</button></div> <div class="grid grid-cols-2 gap-4"> <div><label class="block font-semibold mb-1">Strom</label><select id="modal-hut-strom" class="w-full border p-2 rounded-md bg-white">${['Ja','Nein', 'Unbekannt'].map(o => `<option ${o===(hut.strom || 'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div> <div><label class="block font-semibold mb-1">Sitzpl√§tze</label><select id="modal-hut-sitzplaetze" class="w-full border p-2 rounded-md bg-white">${['Ja','Nein', 'Unbekannt'].map(o => `<option ${o===(hut.sitzplaetze || 'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div> </div> </div> <div><label class="block font-semibold mb-1">Standort</label><div id="modal-map" class="minimap"></div><p class="text-xs text-gray-500 mt-1">Marker ziehen.</p></div> </div> <div><label class="block font-semibold mb-1">Tiere</label><div id="modal-tiere-container" class="flex flex-wrap gap-2">${tiereHTML}</div></div> </div>`;
      
      const tabOeffnungszeiten = `<div id="openingEditorWrapper" class="mt-3">${renderOpeningHoursEditor(hut.id || 'new', hut.oeffnungszeiten)}</div>`;

      const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];
      const fotosFreigegeben = fotos.map(f => typeof f === 'string' ? { url: f, status: 'freigegeben', title:'' } : f).filter(f => f.status === 'freigegeben');
      const fotosWartend = fotos.map((f, i) => ({ ...f, originalIndex: i })).filter(f => f && typeof f === 'object' && f.status === 'wartet');
      const tabFotos = `<div class="space-y-4"> <div><label class="block mb-2 font-semibold">üì∑ Neues Bild hochladen</label><input type="file" ${hut.id ? '' : 'disabled'} accept="image/*" onchange="initImageUpload(this, '${hut.id}')" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4" /> ${!hut.id ? '<p class="text-sm text-red-500 italic">Erst speichern.</p>' : ''}</div> ${fotosWartend.length > 0 ? `<div><h4 class="font-medium mb-2">Warten auf Freigabe (${fotosWartend.length})</h4><div class="flex flex-wrap gap-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md">${fotosWartend.map(f => `<div class="relative w-24 h-24 rounded overflow-hidden border-2 border-yellow-400"><img src="${f.url}" alt="wartet" class="object-cover w-full h-full" /><div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/60 opacity-0 hover:opacity-100 transition"><button onclick="approveFoto('${hut.id}', ${f.originalIndex})" class="bg-green-600 mb-1 px-2 py-1 rounded">‚úî</button><button onclick="rejectFoto('${hut.id}', ${f.originalIndex})" class="bg-red-600 px-2 py-1 rounded">‚úñ</button></div></div>`).join('')}</div></div>` : ''} <div><h4 class="font-medium mb-2">Freigegebene Fotos (${fotosFreigegeben.length})</h4><div id="modal-fotos-freigegeben" class="flex flex-wrap gap-3 p-2 bg-gray-50 border rounded-md">${fotosFreigegeben.length > 0 ? fotosFreigegeben.map((f, idx) => `<div class="relative group w-32 h-40 border rounded overflow-hidden bg-white p-2 flex flex-col items-center shadow-sm"><img src="${f.url}" class="object-cover w-full h-24 rounded mb-2"><input data-url="${f.url}" class="imageTitleInput w-full text-xs border rounded p-1 text-center" value="${escapeAttr(f.title || '')}" placeholder="Titel..."><div class="flex justify-between gap-1 mt-1"><button onclick="generateSingleImageTitle(this)" class="kiBtn text-xs bg-blue-600 text-white rounded px-2 py-0.5 hover:bg-blue-700">ü™Ñ KI</button><button onclick="rejectFoto('${hut.id}', ${fotos.findIndex(orig => orig && (orig.url === f.url || orig === f.url))})" class="removeBtn text-xs bg-red-600 text-white rounded px-2 py-0.5 hover:bg-red-700">‚úï</button></div></div>`).join('') : '<p class="text-gray-500 italic">Keine Fotos.</p>'}</div></div> </div>`;
      
      const tabStatistik = `<div class="text-center space-y-4"><div class="p-4 bg-blue-50 rounded-lg"><p class="text-3xl font-bold text-blue-600">${stats.views}</p><p class="text-sm text-gray-600">Gesamte Aufrufe</p></div><div class="p-4 bg-green-50 rounded-lg"><p class="text-3xl font-bold text-green-600">${stats.routeStarts}</p><p class="text-sm text-gray-600">Routenstarts</p></div></div>`;
      
      const tabProtokoll = `<div><ul class="text-sm max-h-96 overflow-y-auto mt-2 border p-2 rounded-md bg-gray-50 divide-y">${logs.length > 0 ? logs.map(log => `<li class="py-2"><strong>${escapeHtml(log.admin)}</strong> √§nderte <em>${escapeHtml(log.feld)}</em> ${log.wert ? `auf <code>${escapeHtml(String(log.wert).substring(0, 100))}...</code>` : ''}<span class="block text-xs text-gray-400">${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</span></li>`).join('') : '<p class="text-gray-500 italic">Keine Logs.</p>'}</ul></div>`;
      
      hutEditModalContent.innerHTML = `
        <div class="modal-header"> <h2 class="text-2xl font-bold">${title}</h2> <button onclick="closeHutModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button> </div>
        <div class="modal-tab-nav"> <button class="modal-tab active" onclick="showModalTab('stammdaten')">Stammdaten</button> <button class="modal-tab" onclick="showModalTab('oeffnungszeiten')">√ñffnungszeiten</button> <button class="modal-tab" onclick="showModalTab('fotos')">Fotomontage</button> <button class="modal-tab" onclick="showModalTab('statistik')">Statistiken</button> <button class="modal-tab" onclick="showModalTab('protokoll')">Protokoll</button> </div>
        <div class="modal-body"> <div id="tab-stammdaten" class="modal-tab-content active">${tabStammdaten}</div> <div id="tab-oeffnungszeiten" class="modal-tab-content">${tabOeffnungszeiten}</div> <div id="tab-fotos" class="modal-tab-content">${tabFotos}</div> <div id="tab-statistik" class="modal-tab-content">${tabStatistik}</div> <div id="tab-protokoll" class="modal-tab-content">${tabProtokoll}</div> </div>
        <div class="modal-footer flex justify-between items-center"> <div>${hutId ? `<button id="deleteHutBtnModal" onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">L√∂schen</button>` : ''}</div> <div class="flex gap-4"> <button onclick="closeHutModal()" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400">Abbrechen</button> <button id="saveHutBtnModal" onclick="saveHutFromModal()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-700">Speichern</button> </div> </div>
      `;

      hutEditModal.classList.add('flex');
      
      // Initialisiere Quill NACH dem Einf√ºgen ins DOM
      setTimeout(() => {
          if (document.getElementById('quillContainer')) {
              quillInstance = new Quill("#quillContainer", { theme: "snow" });
              if (hut.beschreibung) quillInstance.root.innerHTML = hut.beschreibung;
              // Event Listener f√ºr KI-Button im Modal
              const aiBtnModal = document.getElementById('aiDescBtnModal');
              if (aiBtnModal) {
                  aiBtnModal.onclick = async () => {
                      showToast("üß† Generiere KI-Beschreibung...", 3000);
                      // Sammle aktuelle Daten aus dem Modal f√ºr die KI
                      const currentModalData = {
                          ...hut, // Basisdaten
                          name: document.getElementById('modal-hut-name')?.value || hut.name,
                          strom: document.getElementById('modal-hut-strom')?.value || hut.strom,
                          sitzplaetze: document.getElementById('modal-hut-sitzplaetze')?.value || hut.sitzplaetze,
                          tiere: Array.from(document.querySelectorAll('#modal-tiere-container .admin-tiere-btn.bg-yellow-200')).map(b => b.dataset.emoji),
                          fotos: Array.from(document.querySelectorAll('#modal-fotos-freigegeben .imageTitleInput')).map(inp => ({ url: inp.dataset.url, title: inp.value }))
                      };
                      const desc = await generateProfessionalDescription(currentModalData); 
                      quillInstance.root.innerHTML = `<p>${desc.replace(/\n/g, '</p><p>')}</p>`;
                  };
              }
          }
      }, 100);

      initModalMap(hut.location);
      
      // Event Listener f√ºr Tiere & Bildtitel
      document.getElementById('modal-tiere-container')?.addEventListener('click', e => {
          const btn = e.target.closest('.admin-tiere-btn');
          if (!btn) return;
          const emoji = btn.dataset.emoji;
          if (currentEditingHutId && emoji) {
             toggleTier(currentEditingHutId, emoji); // Direkte Speicherung bei Klick
             // UI wird durch onSnapshot aktualisiert, kein manuelles toggeln n√∂tig
          } else if (!currentEditingHutId && emoji) { // Nur UI toggle bei NEUER H√ºtte
              btn.classList.toggle('bg-yellow-200'); btn.classList.toggle('ring-2'); btn.classList.toggle('ring-yellow-400'); btn.classList.toggle('bg-gray-100');
          }
      });
      document.getElementById('modal-fotos-freigegeben')?.addEventListener('input', async e => {
          if (e.target.classList.contains('imageTitleInput') && currentEditingHutId) {
              const url = e.target.dataset.url;
              const newTitle = e.target.value;
              const hutRef = db.collection('eierhuetten').doc(currentEditingHutId);
              const hutDoc = await hutRef.get();
              const fotos = Array.isArray(hutDoc.data().fotos) ? [...hutDoc.data().fotos] : [];
              const index = fotos.findIndex(f => f && (f.url === url || f === url));
              if (index !== -1) {
                  if (typeof fotos[index] === 'string') { fotos[index] = { url: fotos[index], title: newTitle, status: 'freigegeben' }; } 
                  else { fotos[index].title = newTitle; }
                  await hutRef.update({ fotos });
                  logAdminAction('Bildtitel ge√§ndert', { hutId: currentEditingHutId, hutName: hutDoc.data().name, url });
              }
          }
      });
  }

  // Helper zum Generieren von KI-Titeln f√ºr EINZELNE Bilder im Modal
  async function generateSingleImageTitle(buttonElement) {
      const input = buttonElement.closest('div').querySelector('.imageTitleInput');
      const img = buttonElement.closest('.relative').querySelector('img');
      if (!input || !img) return;
      
      buttonElement.textContent = 'üß†...'; buttonElement.disabled = true;
      try {
          const url = img.src;
          const suggestion = await generateSmartImageTitle(url);
          input.value = suggestion;
          input.dispatchEvent(new Event('input', { bubbles: true })); // Trigger save
          showToast('ü™Ñ KI-Titel generiert!');
      } catch (e) {
          showToast('‚ùå Fehler bei KI-Titel.');
      } finally {
           buttonElement.textContent = 'ü™Ñ KI'; buttonElement.disabled = false;
      }
  }
  
  function showModalTab(tabId) {
      hutEditModalContent.querySelectorAll('.modal-tab').forEach(btn => btn.classList.remove('active'));
      hutEditModalContent.querySelector(`.modal-tab[onclick="showModalTab('${tabId}')"]`)?.classList.add('active');
      hutEditModalContent.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`tab-${tabId}`)?.classList.add('active');
      
      // Karte nur initialisieren/neu rendern, wenn der Tab aktiv wird
      if (tabId === 'stammdaten') {
           if (!adminModalMap) {
               const hut = allHuts.find(h => h.id === currentEditingHutId);
               initModalMap(hut?.location);
           } else {
               // Wichtig: Kurze Verz√∂gerung, damit das Tab sichtbar ist
               setTimeout(() => adminModalMap.invalidateSize(), 50);
           }
      }
  }
  
  function initModalMap(location) {
      let lat = location?.latitude || 51.1657; let lng = location?.longitude || 10.4515; let zoom = location ? 13 : 6;
      adminModalLocation = location ? new firebase.firestore.GeoPoint(lat, lng) : null;

      // Wichtig: Map Container muss im DOM sein UND SICHTBAR
      const mapContainer = document.getElementById('modal-map');
      if (!mapContainer || !mapContainer.offsetParent) { 
          //console.warn("Map container not visible yet for initModalMap"); 
          return; // Nicht initialisieren, wenn unsichtbar
      }

      if (adminModalMap) { // Falls schon vorhanden, nur neu zentrieren/Marker setzen
          adminModalMap.setView([lat, lng], zoom);
          if (adminModalMarker) adminModalMarker.setLatLng([lat, lng]);
          else adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap).on('dragend', handleMarkerDrag);
          adminModalMap.invalidateSize();
          return;
      }
      
      // Nur neu erstellen, wenn nicht vorhanden
      try {
          adminModalMap = L.map('modal-map').setView([lat, lng], zoom);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminModalMap);
          adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap).on('dragend', handleMarkerDrag);
          adminModalMap.invalidateSize(); // Sicherstellen, dass die Gr√∂√üe stimmt
      } catch(e) { console.error("Leaflet Error:", e); }
  }

  function handleMarkerDrag(e) {
      const pos = e.target.getLatLng();
      adminModalLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
  }

  // === H√úTTEN-CRUD ===
  async function saveHutFromModal() {
      const saveBtn = document.getElementById('saveHutBtnModal');
      saveBtn.disabled = true; saveBtn.classList.add('button-loading'); saveBtn.textContent = 'Speichern';

      const name = document.getElementById('modal-hut-name')?.value || '';
      const status = document.getElementById('modal-hut-status')?.value || 'offen';
      const beschreibung = quillInstance ? quillInstance.root.innerHTML : '';
      const strom = document.getElementById('modal-hut-strom')?.value || 'Unbekannt';
      const sitzplaetze = document.getElementById('modal-hut-sitzplaetze')?.value || 'Unbekannt';
      const oeffnungszeiten = collectOpeningHours(currentEditingHutId || 'new'); // Holt Daten vom Editor
      
      if (!name) { showNotification('‚ùå Name fehlt.'); saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); return; }
      if (!adminModalLocation) { showNotification('‚ùå Standort fehlt.'); saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); return; }
      
      let tiere = []; // Tiere werden nur bei Update √ºber toggleTier gespeichert, hier nur f√ºr NEU relevant
      if (!currentEditingHutId) { document.querySelectorAll('#modal-tiere-container .admin-tiere-btn.bg-yellow-200').forEach(btn => tiere.push(btn.dataset.emoji)); }

      const data = { name, status, beschreibung, strom, sitzplaetze, location: adminModalLocation, oeffnungszeiten: normalizeOpeningHours(oeffnungszeiten) };

      try {
          if (currentEditingHutId) {
              const hutRef = db.collection('eierhuetten').doc(currentEditingHutId);
              await hutRef.update(data);
              logAdminAction(`H√ºtte aktualisiert`, { hutId: currentEditingHutId, hutName: data.name });
              showNotification('‚úÖ H√ºtte aktualisiert.');
          } else {
              data.erstelltAm = firebase.firestore.FieldValue.serverTimestamp(); data.userId = currentUser.uid; data.fotos = []; data.tiere = tiere;
              const docRef = await db.collection('eierhuetten').add(data);
              logAdminAction('Neue H√ºtte erstellt', { hutId: docRef.id, hutName: data.name });
              showNotification('‚úÖ Neue H√ºtte erstellt.');
          }
          closeHutModal();
      } catch (e) { showNotification('‚ùå Speicherfehler: '+e.message); console.error(e); } 
      finally { saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); }
  }
  
  async function quickUpdateStatus(hutId, status) {
      try {
          const hutRef = db.collection('eierhuetten').doc(hutId);
          await hutRef.update({ status });
          const hut = allHuts.find(h => h.id === hutId);
          logAdminAction(`Status auf '${status}' gesetzt`, { hutId, hutName: hut?.name || id });
          hutRef.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'status', wert: status, zeitpunkt: new Date() });
      } catch(e) { console.error("QuickUpdate Error:", e); showNotification(`‚ùå Fehler bei ${hutId}: ${e.message}`); }
  }

  async function deleteHut(id, skipConfirm = false) {
      if (!skipConfirm && !confirm(`‚ùó H√ºtte ${id} ENDG√úLTIG L√ñSCHEN?`)) return;
      const deleteBtn = document.getElementById('deleteHutBtnModal');
      if(deleteBtn) { deleteBtn.disabled = true; deleteBtn.classList.add('button-loading'); }

      try {
          const hutRef = db.collection('eierhuetten').doc(id);
          const hutDoc = await hutRef.get();
          if(!hutDoc.exists) throw new Error("H√ºtte nicht gefunden.");
          const hut = hutDoc.data();
          const hutName = hut.name || `ID: ${id}`;
          
          // TODO: PayPal Abo k√ºndigen?

          if (Array.isArray(hut.fotos)) {
              for (const f of hut.fotos) { if (f && typeof f === "object" && f.delete_url) { try { await fetch(f.delete_url, { method: 'DELETE' }); } catch (e) { /* ignore */ } } }
          }
          await hutRef.delete();
          logAdminAction('H√ºtte gel√∂scht', { hutId: id, hutName });
          showNotification('üóëÔ∏è H√ºtte gel√∂scht.');
          closeHutModal();
      } catch (err) { showNotification('‚ùå L√∂schfehler: ' + err.message); console.error(err); }
      finally { if(deleteBtn) { deleteBtn.disabled = false; deleteBtn.classList.remove('button-loading'); } }
  }

  // === FOTO-VERWALTUNG ===
  async function approveFoto(hutId, index) {
      try {
          const ref = db.collection('eierhuetten').doc(hutId);
          const snap = await ref.get();
          const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
          const f = fotos[index];
          if (!f || typeof f === 'string') return;
          fotos[index] = { ...f, status: 'freigegeben' };
          await ref.update({ fotos });
          logAdminAction('Foto freigegeben', { hutId, hutName: snap.data().name, url: f.url });
          ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto freigegeben: ${f.url}`, zeitpunkt: new Date() });
          showNotification('‚úÖ Bild freigegeben');
      } catch (err) { showNotification('‚ùå Fehler beim Freigeben.'); console.error(err); }
  }

  async function rejectFoto(hutId, index) {
      if (!confirm('Foto wirklich l√∂schen?')) return;
      try {
          const ref = db.collection('eierhuetten').doc(hutId);
          const snap = await ref.get();
          let fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
          const f = fotos[index];
          if (!f) return;
          const deleteUrl = (f && typeof f === 'object' && f.delete_url) ? f.delete_url : null;
          fotos.splice(index, 1);
          await ref.update({ fotos });
          logAdminAction('Foto abgelehnt/gel√∂scht', { hutId, hutName: snap.data().name, url: (f.url || 'N/A') });
          ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto gel√∂scht: ${f.url || 'N/A'}`, zeitpunkt: new Date() });
          if (deleteUrl) { try { await fetch(deleteUrl, { method: 'DELETE' }); } catch (e) { /* ignore */ } }
          showNotification('üóëÔ∏è Bild entfernt');
      } catch (err) { showNotification('‚ùå Fehler beim Entfernen.'); console.error(err); }
  }

  async function initImageUpload(input, hutId) {
      const files = Array.from(input.files);
      if (files.length === 0 || !hutId) return;
      showNotification(`‚è≥ Lade ${files.length} Bild(er) hoch...`);
      // Optional: Show progress bar
      
      const uploadedObjects = [];
      for (let file of files) {
          try {
              const base64 = await new Promise((resolve, reject) => { /* ... FileReader ... */ });
              const formData = new FormData(); formData.append('key', 'YOUR_IMGBB_KEY'); formData.append('image', base64);
              const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
              const json = await res.json();
              if (json?.data?.url) {
                  const title = await generateSmartImageTitle(json.data.url, file.name);
                  uploadedObjects.push({ url: json.data.url, delete_url: json.data.delete_url || null, status: 'wartet', title });
              }
          } catch (err) { showNotification(`‚ùå Upload-Fehler: ${err}`); }
      }
      if (uploadedObjects.length > 0) {
          try {
              await db.collection('eierhuetten').doc(hutId).update({ fotos: firebase.firestore.FieldValue.arrayUnion(...uploadedObjects) });
              const hut = allHuts.find(h => h.id === hutId);
              logAdminAction(`Neue(s) Foto(s) hochgeladen`, { hutId, hutName: hut.name, count: uploadedObjects.length });
              showNotification('‚úÖ Bilder hochgeladen (warten auf Freigabe).');
          } catch (err) { showNotification('‚ùå Fehler beim Speichern: ' + err.message); }
      }
      // Optional: Hide progress bar
  }
  
  async function generateSmartImageTitle(url, filename = "") { 
      const cleanName = (filename || url.split('/').pop()).replace(/\.[^/.]+$/, "").toLowerCase().replace(/[-_]/g, ' ');
      // Simple heuristic based on common terms
      if (cleanName.includes("automat")) return "Verkaufsautomat";
      if (cleanName.includes("huhn") || cleanName.includes("h√ºhner")) return "H√ºhner";
      if (cleanName.includes("kuh") || cleanName.includes("k√ºhe")) return "K√ºhe auf der Weide";
      if (cleanName.includes("h√ºtte") || cleanName.includes("huette")) return "Selbstbedienungsh√ºtte";
      if (cleanName.includes("hof")) return "Der Hof";
      if (cleanName.includes("laden")) return "Hofladen Innenansicht";
      if (cleanName.includes("spielplatz")) return "Spielplatz";
      if (cleanName.includes("landschaft") || cleanName.includes("aussen") || cleanName.includes("wiese")) return "Au√üenansicht / Landschaft";
      // Fallback
      return cleanName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') || "Detailaufnahme"; 
  }


  // === TIERE-VERWALTUNG ===
  async function toggleTier(hutId, emoji) {
      const ref = db.collection('eierhuetten').doc(hutId);
      let newArray = [];
      try {
          await db.runTransaction(async tx => {
              const doc = await tx.get(ref);
              if (!doc.exists) throw new Error('H√ºtte nicht gefunden');
              let tiere = normalizeToEmojiArray(doc.data().tiere || []);
              const idx = tiere.indexOf(emoji);
              if (idx >= 0) { tiere.splice(idx, 1); } 
              else { tiere = tiere.filter(t => t !== '‚ùå'); if (emoji === '‚ùå') tiere = ['‚ùå']; else tiere.push(emoji); }
              newArray = tiere;
              tx.update(ref, { tiere });
          });
          const hut = allHuts.find(h => h.id === hutId);
          logAdminAction(`Tiere ge√§ndert: ${newArray.join(', ')}`, { hutId, hutName: hut.name });
          ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'tiere', wert: newArray.join(', '), zeitpunkt: new Date() });
          showNotification(`üêæ Tiere aktualisiert.`);
      } catch (e) { showNotification('‚ùå Fehler bei Tier-Auswahl'); console.error(e); }
  }
  
  // === √ñFFNUNGSZEITEN EDITOR ===
  const DAY_LABELS = [ { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" }, { key: "mi", label: "Mittwoch" }, { key: "do", label: "Donnerstag" }, { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" }, { key: "so", label: "Sonntag" } ];
  function renderOpeningHoursEditor(elemId, data = {}) {
      let html = `<div id="openhours-${elemId}" class="space-y-2 mt-2"> <table class="w-full text-sm border border-gray-200 rounded overflow-hidden"> <thead class="bg-gray-100 text-gray-700"> <tr> <th class="py-2 px-3 text-left">Tag</th> <th class="py-2 px-3 text-center">Ge√∂ffnet</th> <th class="py-2 px-3 text-center">Von</th> <th class="py-2 px-3 text-center">Bis</th> </tr> </thead> <tbody class="divide-y">`;
      DAY_LABELS.forEach(day => {
          const d = data[day.key] || { open: false, from: "", to: "" };
          html += `<tr> <td class="py-2 px-3">${day.label}</td> <td class="text-center"><input type="checkbox" class="oh-open" data-day="${day.key}" ${d.open ? "checked" : ""}/></td> <td class="text-center"><input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${d.from || ''}" ${!d.open ? "disabled" : ""}/></td> <td class="text-center"><input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${d.to || ''}" ${!d.open ? "disabled" : ""}/></td> </tr>`;
      });
      html += `</tbody> </table> <p class="text-xs text-gray-500">Tipp: Leere Felder bedeuten "geschlossen".</p> </div>`;
      setTimeout(() => attachOpeningHoursListeners(elemId), 0); // Attach listeners after render
      return html;
  }
  function attachOpeningHoursListeners(elemId) {
      const container = document.getElementById(`openhours-${elemId}`);
      if (!container) return;
      container.addEventListener("change", (e) => {
          if (e.target.classList.contains("oh-open")) {
              const dayKey = e.target.dataset.day; const row = e.target.closest("tr");
              const fromInput = row.querySelector(`.oh-from[data-day="${dayKey}"]`); const toInput = row.querySelector(`.oh-to[data-day="${dayKey}"]`);
              fromInput.disabled = !e.target.checked; toInput.disabled = !e.target.checked;
              if (!e.target.checked) { fromInput.value = ""; toInput.value = ""; }
          }
      });
  }
  function collectOpeningHours(elemId) {
      const wrapper = document.getElementById(`openhours-${elemId}`); if (!wrapper) return {};
      const result = {};
      DAY_LABELS.forEach(day => {
          const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`); const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`); const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
          const open = openCheckbox ? openCheckbox.checked : false;
          result[day.key] = { open, from: open ? (fromInput?.value || "") : "", to: open ? (toInput?.value || "") : "" };
      });
      return result;
  }
  function normalizeOpeningHours(oeff) {
      if (typeof oeff === 'object' && oeff.mo) return oeff; // Bereits korrekt
      const result = {}; DAY_LABELS.forEach(day => result[day.key] = { open: false, from: "", to: "" });
      // TODO: Konvertierungslogik f√ºr alte Formate (String, Array) hier einf√ºgen
      console.warn("Opening hours normalization needed for:", oeff); // Hinweis, falls Konvertierung n√∂tig
      return result;
  }


  // === NAVIGATION ===
  function showSection(id) {
      document.querySelectorAll('main > section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id)?.classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.nav-btn[onclick="showSection('${id}')"]`)?.classList.add('active');
  }
  function showNotification(message) {
      notification.textContent = message; notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 4000);
  }

  // === MODERATIONS-SEITE ===
  function initLiveModerationQueues() {
      // 1. Neue H√ºtten
      db.collection('eierhuetten').where('status', '==', 'offen')
        .onSnapshot(snapshot => {
          const container = document.getElementById("neueListe-page"); if(!container) return;
          if (snapshot.empty) { container.innerHTML = "<p class='italic text-gray-500'>Keine neuen.</p>"; return; }
          container.innerHTML = "";
          snapshot.forEach(doc => {
              const hut = doc.data(); const row = document.createElement("div");
              row.className = "flex items-center justify-between bg-white shadow-sm rounded px-3 py-2 border";
              row.innerHTML = `<p class="font-medium text-blue-600 truncate max-w-[50%]">${escapeHtml(hut.name)}</p> <div class="flex space-x-2 flex-shrink-0"> <button onclick="quickUpdateStatus('${doc.id}', 'angenommen')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">Annehmen</button> <button onclick="openHutModal('${doc.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Details</button> </div>`;
              container.appendChild(row);
          });
          document.getElementById('bulk-approve-huts').onclick = async () => { /* ... Bulk Approve ... */ };
        });

      // 2. Wartende Fotos
      db.collection('eierhuetten')
        .onSnapshot(snapshot => {
          const container = document.getElementById("pending-fotos-page"); if(!container) return;
          const pending = [];
          snapshot.forEach(doc => {
              const data = doc.data();
              const waitingPhotos = (data.fotos || []).map((f, i) => ({...f, originalIndex: i})).filter(f => f && typeof f === 'object' && f.status === 'wartet');
              if (waitingPhotos.length > 0) pending.push({ id: doc.id, name: data.name, waitingPhotos });
          });
          if (pending.length === 0) { container.innerHTML = "<p class='italic text-gray-500'>Keine Fotos offen.</p>"; return; }
          container.innerHTML = "";
          pending.forEach(hut => {
              const row = document.createElement("div"); row.className = "bg-white shadow-sm rounded p-3 border";
              row.innerHTML = `<div class="flex justify-between items-center mb-2"><p class="font-medium text-blue-600">${escapeHtml(hut.name)}</p><button onclick="openHutModal('${hut.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Anzeigen</button></div> <div class="flex flex-wrap gap-2">${hut.waitingPhotos.map(f => `<div class="relative w-16 h-16 rounded overflow-hidden border"><img src="${f.url}" alt="wartet" class="object-cover w-full h-full" /><div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 hover:opacity-100 transition"><button onclick="approveFoto('${hut.id}', ${f.originalIndex})" class="text-white text-lg">‚úî</button><button onclick="rejectFoto('${hut.id}', ${f.originalIndex})" class="text-white text-lg ml-2">‚úñ</button></div></div>`).join('')}</div>`;
              container.appendChild(row);
          });
        });
  }

  // === SUPPORT-SYSTEM (Erweitert) ===
  let currentSupportTickets = []; let allSupportTickets = [];
  const SUPPORT_MSG_MAX = 500;

  function initLiveSupportQueue() {
      db.collection('support').orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
            allSupportTickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            applySupportFilters();
            const openCount = allSupportTickets.filter(t => t.status === 'offen').length;
            supportQueueBadge.textContent = openCount; supportQueueBadge.classList.toggle('hidden', openCount === 0);
            if (currentEditingSupportTicketId && supportReplyModal.classList.contains('flex')) {
                openReplyModal(currentEditingSupportTicketId); // Refresh modal if open
            }
        }, err => console.error("Support Listener Error:", err));
  }
  
  function applySupportFilters() {
      const searchTerm = supportSearchInput.value.toLowerCase();
      const statusFilterVal = supportStatusFilter.value;
      const priorityFilterVal = supportPriorityFilter.value;
      currentSupportTickets = allSupportTickets.filter(ticket => {
          const searchMatch = (ticket.mail?.toLowerCase().includes(searchTerm) || ticket.internalNotes?.some(n => n.text?.toLowerCase().includes(searchTerm)));
          const statusMatch = (statusFilterVal === "") || (ticket.status === statusFilterVal);
          const priorityMatch = (priorityFilterVal === "") || ((ticket.priority || 'Normal') === priorityFilterVal); // Default to Normal if not set
          return searchMatch && statusMatch && priorityMatch;
      });
      renderSupportTable();
  }

  function renderSupportTable() {
    supportTicketsBody.innerHTML = '';
    if (currentSupportTickets.length === 0) { supportTicketsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 italic py-4">Keine Tickets gefunden.</td></tr>'; return; }
    currentSupportTickets.forEach(ticket => {
      const id = ticket.id; const datum = ticket.createdAt?.toDate().toLocaleString('de-DE') || '-'; const email = ticket.mail || '-'; const status = ticket.status || 'offen'; const priority = ticket.priority || 'Normal';
      const row = document.createElement('tr'); row.className = `align-top hover:bg-gray-50 priority-${priority}`;
      row.innerHTML = `<td class="px-4 py-2 text-sm font-semibold">${priority}</td> <td class="px-4 py-2 text-xs text-gray-600">${datum}</td> <td class="px-4 py-2 text-xs">${escapeHtml(email)}</td> <td class="px-4 py-2 text-xs"><div id="msgs-preview-${id}" class="max-h-16 overflow-hidden text-ellipsis">...</div></td> <td class="px-4 py-2"><span class="text-xs font-medium px-2 py-1 rounded-full ${status === 'offen' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${escapeHtml(status)}</span></td> <td class="px-4 py-2 space-x-1"><button onclick="openReplyModal('${id}')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">√ñffnen</button></td>`;
      supportTicketsBody.appendChild(row);
      loadSupportMessagePreview(id);
    });
  }
  
  async function loadSupportMessagePreview(ticketId) { /* ... implementierung ... */ } // Platzhalter

  async function openReplyModal(ticketId) {
    currentEditingSupportTicketId = ticketId;
    const ticket = allSupportTickets.find(t => t.id === ticketId);
    if (!ticket) { showNotification("Ticket nicht gefunden"); return; }

    document.getElementById("modal-ticket-info").innerText = `Ticket-ID: ${ticketId} ¬∑ User: ${escapeHtml(ticket.mail || '-')}`;
    document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-reply-counter").innerText = `${SUPPORT_MSG_MAX} Zeichen √ºbrig`; document.getElementById("modal-internal-note").value = "";

    const statusSelect = document.getElementById("modal-ticket-status"); statusSelect.innerHTML = ['offen', 'bearbeitet', 'geschlossen', 'archiviert'].map(opt => `<option value="${opt}" ${opt === (ticket.status || 'offen') ? 'selected' : ''}>${opt}</option>`).join('');
    const prioritySelect = document.getElementById("modal-ticket-priority"); prioritySelect.value = ticket.priority || 'Normal';

    const msgHistoryEl = document.getElementById("modal-message-history"); msgHistoryEl.innerHTML = '‚è≥ Lade Nachrichten...';
    _supportMessageUnsubs.get(ticketId)?.();
    const unsub = db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "asc")
      .onSnapshot(snap => {
        msgHistoryEl.innerHTML = snap.docs.map(doc => { const d = doc.data(); const time = d.createdAt?.toDate().toLocaleString() || ''; const isAdmin = d.sender === 'Admin'; return `<div class="p-2 rounded ${isAdmin ? 'bg-blue-50 text-blue-800' : 'bg-gray-100 text-gray-800'}"><p>${escapeHtml(d.text || '')}</p><p class="text-xs text-right opacity-70">${isAdmin ? 'Admin' : 'User'} - ${time}</p></div>`; }).join('') || '<p class="italic text-gray-500">Keine Nachrichten.</p>';
        msgHistoryEl.scrollTop = msgHistoryEl.scrollHeight;
      }, err => { msgHistoryEl.innerHTML = '<p class="text-red-500">Fehler beim Laden.</p>'; console.error(err); });
    _supportMessageUnsubs.set(ticketId, unsub);

    const notesHistoryEl = document.getElementById("modal-internal-notes-history"); notesHistoryEl.innerHTML = (ticket.internalNotes || []).map(note => `<div class="border-b pb-1 mb-1"><p>${escapeHtml(note.text || '')}</p><p class="text-xs text-gray-400 text-right">${escapeHtml(note.adminName || 'Admin')} - ${note.timestamp?.toDate().toLocaleString() || ''}</p></div>`).join('') || '<p class="italic text-gray-500">Keine Notizen.</p>';
    notesHistoryEl.scrollTop = notesHistoryEl.scrollHeight;

    supportReplyModal.classList.add('flex');
  }

  function closeReplyModal() {
    _supportMessageUnsubs.get(currentEditingSupportTicketId)?.(); _supportMessageUnsubs.delete(currentEditingSupportTicketId);
    supportReplyModal.classList.remove('flex'); currentEditingSupportTicketId = null;
  }

  async function saveSupportTicketChanges() {
    const saveBtn = event.target; saveBtn.disabled = true; saveBtn.classList.add('button-loading');
    const ticketId = currentEditingSupportTicketId; if (!ticketId) return;
    const replyText = document.getElementById("modal-reply-text").value.trim(); const internalNoteText = document.getElementById("modal-internal-note").value.trim(); const newStatus = document.getElementById("modal-ticket-status").value; const newPriority = document.getElementById("modal-ticket-priority").value;
    try {
        const ticketRef = db.collection("support").doc(ticketId); let updates = { status: newStatus, priority: newPriority }; let actionLog = [`Status: ${newStatus}`, `Priorit√§t: ${newPriority}`];
        if (replyText) { await ticketRef.collection("messages").add({ text: replyText, sender: "Admin", createdAt: firebase.firestore.FieldValue.serverTimestamp() }); actionLog.push("Antwort gesendet"); }
        if (internalNoteText) { updates.internalNotes = firebase.firestore.FieldValue.arrayUnion({ text: internalNoteText, adminName: currentUser.displayName || currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); actionLog.push("Interne Notiz"); }
        await ticketRef.update(updates);
        logAdminAction(`Support bearbeitet: ${actionLog.join(', ')}`, { ticketId }); showNotification("‚úÖ Ticket aktualisiert.");
        document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-internal-note").value = "";
    } catch (err) { alert("Fehler: " + err.message); } finally { saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); }
  }
  
  function deleteSupportTicketFromModal() {
      const ticketId = currentEditingSupportTicketId;
      if (ticketId) { deleteSupport(ticketId); closeReplyModal(); }
  }
   async function deleteSupport(ticketId) { // Shared delete function
      if (!confirm(`Ticket ${ticketId} wirklich l√∂schen?`)) return;
      try {
          _supportMessageUnsubs.get(ticketId)?.(); _supportMessageUnsubs.delete(ticketId);
          await db.collection('support').doc(ticketId).delete(); // Haupt-Doc l√∂schen (Subcollection bleibt, aber ok)
          logAdminAction(`Support-Ticket gel√∂scht`, { ticketId }); showNotification("üóëÔ∏è Ticket gel√∂scht");
          // Liste wird durch onSnapshot aktualisiert
      } catch (err) { showNotification('‚ùå L√∂schfehler: ' + err.message); console.error(err); }
  }

  document.getElementById("modal-reply-text").addEventListener("input", e => { const left = SUPPORT_MSG_MAX - e.target.value.length; document.getElementById("modal-reply-counter").innerText = `${left} Zeichen √ºbrig`; });
  
  // === PROFIL-VERWALTUNG ===
  let currentProfileId = null;
  async function loadProfileAdmin(id) { /* ... implementation from v3 ... */ }
  async function saveProfileAdmin() { /* ... implementation from v3 ... */ }
  async function deleteProfileAdmin() { /* ... implementation from v3 ... */ }
  document.getElementById('profile-search').addEventListener('input', async e => { /* ... implementation from v3 ... */ });
  window.selectProfile = (id, name) => { /* ... implementation from v3 ... */ };

  // === TITEL & ABZEICHEN ===
  async function loadTitles() { /* ... implementation from v3 ... */ }
  window.editTitle = (id, name, type, value) => { /* ... implementation from v3 ... */ };
  window.deleteTitle = async (id, name) => { /* ... implementation from v3 ... */ };
  document.getElementById("title-form").addEventListener("submit", async (e) => { /* ... implementation from v3 ... */ });
  async function loadBadges() { /* ... implementation from v3 ... */ }
  window.editBadge = (id, name, icon, type, value) => { /* ... implementation from v3 ... */ };
  window.deleteBadge = async (id, name) => { /* ... implementation from v3 ... */ };
  document.getElementById("badge-form").addEventListener("submit", async (e) => { /* ... implementation from v3 ... */ });
  async function badgeFormUploadToImgBB(file) { /* ... implementation from v3 ... */ }
  document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]').addEventListener('click', () => { loadTitles(); loadBadges(); });
  
  // === HILFSFUNKTIONEN ===
  function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function escapeAttr(s) { if (!s && s !== 0) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  function stripHtml(html){ if(!html) return ''; let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
  
  // === KI Beschreibung (Beispiel aus User Assistant) ===
  async function generateProfessionalDescription(d) {
      const name = (d.name || 'dieser Ort').trim();
      const extras = d.extras ? `Hier gibt es ${d.extras}.` : '';
      const tiere = Array.isArray(d.tiere) && d.tiere.length && !d.tiere.includes('Keine Tiere') ? `Tiere vor Ort: ${d.tiere.join(', ')}.` : '';
      const photoTitles = (d.fotos || []).map(f => typeof f === 'string' ? '' : f.title).filter(Boolean);
      let fotosTxt = photoTitles.length > 0 ? `Die Fotos zeigen u.a. ${photoTitles.slice(0, 2).join(' und ')}.` : '';
      const tone = ['idyllisch', 'einladend', 'malerisch', 'authentisch'][Math.floor(Math.random()*4)];
      const landscape = ['weiten Wiesen', 'alten Obstb√§umen', 'sanften H√ºgeln'][Math.floor(Math.random()*3)];
      const ending = ['Ein Ort zum Verweilen.', 'Hier sp√ºrt man die Liebe zur Natur.'][Math.floor(Math.random()*2)];
      const paragraphs = [`${name} ist ein ${tone}er Ort, eingebettet zwischen ${landscape}.`, extras, tiere, fotosTxt, ending].filter(Boolean);
      return paragraphs.join('\n'); // Quill f√ºgt <p> hinzu
  }


</script>
</body>
</html>

