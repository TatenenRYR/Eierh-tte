<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard V5</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Generelle Stile (wie V4) */
    body { font-family: 'Inter', sans-serif; }
    .nav-group-title { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem; margin-top: 1rem; }
    .nav-btn { display: flex; align-items: center; gap: 0.75rem; text-align: left; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; color: #374151; }
    .nav-btn:hover { background-color: #f3f4f6; }
    .nav-btn.active { background-color: #10b981; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-backdrop.flex { display: flex; }
    .modal-content { background: white; border-radius: 0.75rem; padding: 0; width: 100%; max-width: 56rem; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 1.5rem; }
    .modal-tab { padding: 1rem 0.5rem; margin-bottom: -1px; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280; }
    .modal-tab:hover { color: #111827; }
    .modal-tab.active { color: #10b981; border-color: #10b981; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .ql-container { min-height: 150px; font-size: 1rem; } /* Quill Anpassung */
    .admin-table { width: 100%; text-align: left; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
    .admin-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .admin-table tr:hover { background-color: #f9fafb; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .button-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    .priority-Hoch { border-left: 4px solid #ef4444; } .priority-Normal { border-left: 4px solid #f97316; } .priority-Niedrig { border-left: 4px solid #84cc16; }

    /* Stile f√ºr Smart Image Uploader (aus Assistent √ºbernommen) */
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5 !important; border-color: #10b981 !important; transform: scale(1.01); }
    #smartUploadPreview .image-card { transition: all 0.25s ease; }
    #smartUploadPreview .image-card:hover { transform: scale(1.03); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #smartUploadProgress { transition: opacity 0.3s; }

  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an.</p>
      <button id="login-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full">Mit Google Anmelden</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4"> <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1> </div>
      <nav class="flex-1 space-y-1">
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä Dashboard</button>
        <div class="nav-group-title">Inhalte</div>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('moderation')">üõ°Ô∏è Moderation <span id="mod-queue-badge" class="ml-auto bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">Benutzer</div>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets <span id="support-queue-badge" class="ml-auto bg-blue-400 text-blue-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">System</div>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Gamification</button>
        <button class="nav-btn w-full" onclick="showSection('system-logs')">üìú System-Protokoll</button>
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200"> <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div> <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button> </div>
    </aside>

    <!-- Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      <!-- √úbersicht (Dashboard) -->
      <section id="overview" class="space-y-8">
        <div> <h2 class="section-title">Willkommen zur√ºck!</h2> <p class="text-gray-600">√úberblick √ºber die aktuellen Aktivit√§ten.</p> </div>
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6"></div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 card"> <h3 class="font-bold text-lg mb-4">H√ºtten-Registrierungen (Letzte 30 Tage)</h3> <canvas id="registrationsChart"></canvas> </div>
          <div class="lg:col-span-2 card"> <h3 class="font-bold text-lg mb-4">Letzte Admin-Aktivit√§ten</h3> <div id="admin-log-widget" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
        </div>
      </section>

       <!-- H√ºttenliste -->
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4"> <h2 class="section-title">üè† Alle H√ºtten verwalten</h2> <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-emerald-700 transition">+ H√ºtte hinzuf√ºgen</button> </div>
        <div class="card">
            <div class="flex justify-between items-center gap-4 mb-4">
                <div class="flex gap-4">
                    <input id="search-input" placeholder="üîç Suchen nach Name..." class="p-2 border rounded-md w-full">
                    <select id="status-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Status</option> <option value="angenommen">Angenommen</option> <option value="offen">Offen</option> <option value="abgelehnt">Abgelehnt</option> </select>
                </div>
                <div id="bulk-action-container" class="hidden">
                    <select id="bulk-action-select" class="p-2 border rounded-md bg-white"> <option value="">Massen-Aktion...</option> <option value="approve">Auswahl freigeben</option> <option value="reject">Auswahl ablehnen</option> <option value="delete">Auswahl L√ñSCHEN</option> </select>
                    <button id="bulk-action-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg ml-2 hover:bg-blue-700">OK</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="admin-table">
                    <thead> <tr> <th class="w-10"><input type="checkbox" id="select-all-checkbox"></th> <th>Name</th> <th>Status</th> <th>Erstellt am</th> <th>Pending Fotos</th> <th>Aktionen</th> </tr> </thead>
                    <tbody id="hut-table-body"></tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      
      <!-- Moderation -->
      <section id="moderation" class="hidden">
        <h2 class="section-title">üõ°Ô∏è Moderations-Warteschlange</h2>
        <div class="card">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg">üÜï Neue Eintragungen</h3> <button id="bulk-approve-huts" onclick="bulkApproveHuts()" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm">Alle freigeben</button> </div> <div id="neueListe-page" class="space-y-2 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
                 <div> <h3 class="font-bold text-lg mb-4">üì∑ Fotos warten auf Freigabe</h3> <div id="pending-fotos-page" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded-md border"></div> </div>
            </div>
        </div>
      </section>
      
      <!-- Support-Tickets -->
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <div class="mb-4 flex gap-4">
              <input id="support-search" class="p-2 border rounded-md flex-grow" placeholder="Suche nach E-Mail oder Inhalt...">
              <select id="support-status-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Status</option> <option value="offen">Offen</option> <option value="bearbeitet">Bearbeitet</option> <option value="geschlossen">Geschlossen</option> <option value="archiviert">Archiviert</option>
              </select>
              <select id="support-priority-filter" class="p-2 border rounded-md bg-white">
                  <option value="">Alle Priorit√§ten</option> <option value="Hoch">Hoch</option> <option value="Normal">Normal</option> <option value="Niedrig">Niedrig</option>
              </select>
          </div>
          <table class="admin-table">
            <thead> <tr> <th class="px-4 py-2">Priorit√§t</th> <th class="px-4 py-2">Datum</th> <th class="px-4 py-2">User</th> <th class="px-4 py-2">Nachrichten</th> <th class="px-4 py-2">Status</th> <th class="px-4 py-2">Aktionen</th> </tr> </thead>
            <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile Verwaltung</h2>
        <div class="card">
          <div class="relative max-w-md"> <input id="profile-search" type="text" class="w-full border p-2 rounded-md" placeholder="Profil nach Name suchen..." /> <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded-md shadow-lg hidden z-10"></div> </div>
          <div id="profile-admin-area" class="hidden space-y-4 mt-6 border-t pt-6">
              <!-- Profil-Details hier -->
              <div class="flex items-center space-x-4">
                 <img id="profile-pic-admin" class="w-24 h-24 rounded-full border" src="https://placehold.co/96x96/eee/ccc?text=Profil" />
                 <input id="profile-pic-url" class="flex-1 border p-2 rounded" placeholder="Profilbild-URL √§ndern..." />
               </div>
               <input id="profile-name-admin" class="w-full border p-2 rounded" placeholder="Name" />
               <textarea id="profile-bio-admin" class="w-full border p-2 rounded" placeholder="Kurzbeschreibung / Bio"></textarea>
               <label class="block font-bold">Titel</label> <select id="profile-title-admin" class="w-full border p-2 rounded"></select>
               <label class="block font-bold">Abzeichen</label> <div id="profile-badges-admin" class="flex flex-wrap gap-2"></div>
               <label class="block font-bold">Rolle</label> <select id="profile-role-admin" class="w-full border p-2 rounded"> <option value="user">üë§ User</option> <option value="admin">üëë Admin</option> <option value="mod">üõ°Ô∏è Moderator</option> </select>
               <label class="inline-flex items-center space-x-2"> <input id="profile-banned-admin" type="checkbox" class="form-checkbox"> <span>üö´ Account gesperrt</span> </label>
               <div class="text-sm text-gray-600" id="profile-stats"></div>
               <div class="flex space-x-2"> <button onclick="saveProfileAdmin()" class="bg-green-600 text-white px-3 py-1 rounded">üíæ Speichern</button> <button onclick="deleteProfileAdmin()" class="bg-red-600 text-white px-3 py-1 rounded">üóëÔ∏è L√∂schen</button> </div>
          </div>
        </div>
      </section>
      
      <!-- Gamification -->
      <section id="gamification" class="hidden">
          <h2 class="section-title">üèÜ Gamification</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="card">
                  <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel Verwaltung</h3>
                  <div id="title-list" class="space-y-2"></div>
                  <form id="title-form" class="mt-4 space-y-2 border-t pt-4"> <input id="title-name" placeholder="Titel-Name" class="border p-2 rounded w-full"> <select id="title-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> </select> <input id="title-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Titel speichern</button> </form>
              </div>
              <div class="card">
                  <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen Verwaltung</h3>
                  <div id="badge-list-admin" class="space-y-2"></div>
                  <form id="badge-form" class="mt-4 space-y-2 border-t pt-4"> <input id="badge-name" placeholder="Abzeichen-Name" class="border p-2 rounded w-full"> <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"> <input id="badge-icon" placeholder="Emoji/Icon (Fallback)" class="border p-2 rounded w-full"> <select id="badge-condition" class="border p-2 rounded w-full"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> <option value="night">Nachtfahrt</option> </select> <input id="badge-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Abzeichen speichern</button> </form>
              </div>
          </div>
      </section>
      
      <!-- System-Protokoll -->
      <section id="system-logs" class="hidden">
        <h2 class="section-title">üìú Globales System-Protokoll</h2>
        <div class="card"> <input id="log-search-input" class="w-full border p-2 rounded-md mb-4" placeholder="Logs durchsuchen (z.B. nach Aktion oder Admin-Name)..."> <div id="admin-log-full-list" class="space-y-3 max-h-[70vh] overflow-y-auto text-sm divide-y divide-gray-100"></div> </div>
      </section>
    </main>
  </div>
  
  <!-- Modals -->
  <div id="support-reply-modal" class="modal-backdrop">
     <div class="modal-content max-w-2xl">
        <div class="modal-header"> <h3 class="text-lg font-bold">Ticket bearbeiten</h3> <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button> </div>
        <div class="modal-body grid grid-cols-1 md:grid-cols-2 gap-6">
            <div> <div id="modal-ticket-info" class="text-sm text-gray-500 mb-4"></div> <div id="modal-message-history" class="space-y-3 max-h-60 overflow-y-auto border rounded p-3 mb-4 bg-gray-50"></div> <h4 class="font-semibold mb-2">Antworten:</h4> <textarea id="modal-reply-text" class="w-full border p-2 rounded-md mb-2" rows="4" maxlength="500" placeholder="Deine Antwort an den Benutzer..."></textarea> <div class="text-xs text-gray-500 mb-4 text-right" id="modal-reply-counter">500 Zeichen √ºbrig</div> </div>
            <div class="space-y-4"> <div> <label class="block font-semibold mb-1">Status</label> <select id="modal-ticket-status" class="w-full border p-2 rounded-md bg-white"></select> </div> <div> <label class="block font-semibold mb-1">Priorit√§t</label> <select id="modal-ticket-priority" class="w-full border p-2 rounded-md bg-white"> <option value="Niedrig">Niedrig</option> <option value="Normal">Normal</option> <option value="Hoch">Hoch</option> </select> </div> <div> <h4 class="font-semibold mb-2">Interne Notizen</h4> <div id="modal-internal-notes-history" class="space-y-2 max-h-40 overflow-y-auto border rounded p-2 mb-2 bg-gray-50 text-xs"></div> <textarea id="modal-internal-note" class="w-full border p-2 rounded-md" rows="3" placeholder="Interne Notiz hinzuf√ºgen..."></textarea> </div> </div>
        </div>
        <div class="modal-footer flex justify-between"> <button onclick="deleteSupportTicketFromModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">Ticket L√∂schen</button> <div class="flex gap-2"> <button onclick="closeReplyModal()" class="px-4 py-2 bg-gray-300 rounded-lg text-sm">Abbrechen</button> <button onclick="saveSupportTicketChanges()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">Speichern & Senden</button> </div> </div>
      </div>
  </div>
  <div id="hut-edit-modal" class="modal-backdrop">
      <div id="hut-edit-modal-content" class="modal-content">
        <div class="flex justify-center items-center h-64"> <div class="spinner"></div> </div>
      </div>
  </div>
  <div id="admin-map-container" style="display:none;"></div>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = { apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", authDomain: "eierhuettentour.firebaseapp.com", projectId: "eierhuettentour", storageBucket: "eierhuettentour.appspot.com", messagingSenderId: "348272135205", appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc" };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  // const storage = firebase.storage(); // Vorerst nicht ben√∂tigt durch ImgBB

  // === GLOBALE VARIABLEN ===
  let currentUser = null; let allHuts = []; let filteredHuts = []; let currentPage = 1; const hutsPerPage = 15; let currentEditingHutId = null; let currentEditingSupportTicketId = null; let registrationsChartInstance; let adminModalMap; let adminModalMarker; let adminModalLocation; let quillInstance = null; const _supportMessageUnsubs = new Map();

  // === DOM-ELEMENTE ===
  const notification = document.getElementById('notification'); const hutEditModal = document.getElementById('hut-edit-modal'); const hutEditModalContent = document.getElementById('hut-edit-modal-content'); const supportReplyModal = document.getElementById('support-reply-modal'); const hutTableBody = document.getElementById('hut-table-body'); const selectAllCheckbox = document.getElementById('select-all-checkbox'); const bulkActionContainer = document.getElementById('bulk-action-container'); const bulkActionBtn = document.getElementById('bulk-action-btn'); const supportTicketsBody = document.getElementById('support-tickets-body');

  // === TIERE MAPPING ===
  const TIERE_EMOJI_TO_NAME = { "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege", "üêë": "Schaf", "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase", "üêî": "Huhn", "ü¶Ü": "Ente", "üê¥": "Pferd", "‚ùå": "Keine Tiere" };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries( Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e]) );
  function normalizeToEmojiArray(arr) { if (!Array.isArray(arr)) return []; return arr.map(v => { if (!v) return null; v = String(v).trim(); if (TIERE_EMOJI_TO_NAME[v]) return v; if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; return null; }).filter(Boolean); }
  
  // === INITIALISIERUNG & AUTH ===
  document.getElementById('login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  document.getElementById('logout-btn').onclick = () => auth.signOut();
  auth.onAuthStateChanged(async user => {
      const loginSection = document.getElementById('login-section');
      const dashboard = document.getElementById('dashboard');
      const adminUserInfo = document.getElementById('admin-user-info');
      if (user) {
          currentUser = user; const adminDoc = await db.collection('admins').doc(user.email).get(); if (!adminDoc.exists) { alert('Zugriff verweigert'); auth.signOut(); return; }
          adminUserInfo.textContent = `Angemeldet: ${user.displayName || user.email}`; loginSection.classList.add('hidden'); dashboard.style.display = 'grid';
          // Event Listeners
          document.getElementById('search-input')?.addEventListener('input', applySearchAndSort); document.getElementById('status-filter')?.addEventListener('change', applySearchAndSort); document.getElementById('select-all-checkbox')?.addEventListener('change', toggleAllCheckboxes); document.getElementById('bulk-action-btn')?.addEventListener('click', handleBulkAction); document.getElementById('hut-table-body')?.addEventListener('change', updateBulkActionUI); document.getElementById('support-search')?.addEventListener('input', applySupportFilters); document.getElementById('support-status-filter')?.addEventListener('change', applySupportFilters); document.getElementById('support-priority-filter')?.addEventListener('change', applySupportFilters); document.getElementById('log-search-input')?.addEventListener('input', loadAdminLogs); // Re-use load function for filtering
          initHutsListener(); initLiveModerationQueues(); initLiveSupportQueue(); loadAdminLogs(); showSection('overview');
      } else { currentUser = null; loginSection.classList.remove('hidden'); dashboard.style.display = 'none'; adminUserInfo.textContent = ''; _supportMessageUnsubs.forEach(unsub => unsub()); _supportMessageUnsubs.clear(); }
  });

  // === ADMIN LOGGING ===
  async function logAdminAction(action, details = {}) { try { const logEntry = { adminEmail: currentUser.email, adminName: currentUser.displayName || 'N/A', action, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...details }; await db.collection('adminLogs').add(logEntry); } catch (e) { console.error("Log Error:", e); } }
  let fullLogDataCache = []; // Cache f√ºr Logs
  function loadAdminLogs() {
      const logWidget = document.getElementById('admin-log-widget'); const logFullList = document.getElementById('admin-log-full-list'); const logSearchInput = document.getElementById('log-search-input');
      const render = (logs) => {
          const searchTerm = logSearchInput.value.toLowerCase();
          const filteredLogs = searchTerm ? logs.filter(log => (log.action?.toLowerCase().includes(searchTerm) || log.adminName?.toLowerCase().includes(searchTerm) || log.hutName?.toLowerCase().includes(searchTerm) || log.ticketId === searchTerm)) : logs;
          logFullList.innerHTML = filteredLogs.map(log => { const time = log.timestamp?.toDate().toLocaleString('de-DE') || ''; let detail = log.hutName ? `H√ºtte: ${escapeHtml(log.hutName)}` : log.ticketId ? `Ticket: ${escapeHtml(log.ticketId)}` : ''; return `<div class="py-2 border-b border-gray-100"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-gray-600">${detail}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`; }).join('') || '<p>Keine Logs.</p>';
          logWidget.innerHTML = logs.slice(0, 10).map(log => { const time = log.timestamp?.toDate().toLocaleDateString('de-DE') || ''; return `<div class="pt-2"><p class="font-medium">${escapeHtml(log.action)}</p><p class="text-xs text-gray-400">${escapeHtml(log.adminName)} - ${time}</p></div>`; }).join('') || '<p>Keine Aktivit√§ten.</p>';
      };
      // Listener nur einmal anf√ºgen
      if (!loadAdminLogs.listenerAttached) {
          db.collection('adminLogs').orderBy('timestamp', 'desc').limit(200) // Mehr laden f√ºr Filterung
            .onSnapshot(snapshot => { fullLogDataCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); render(fullLogDataCache); }, err => console.error("Log Load Error:", err));
          loadAdminLogs.listenerAttached = true;
      } else { render(fullLogDataCache); } // Nur neu rendern bei Filter
  }
  loadAdminLogs.listenerAttached = false; // Initialer Zustand

  // === DATENLADEN & STATISTIKEN ===
  function initHutsListener() { db.collection('eierhuetten').orderBy('erstelltAm', 'desc').onSnapshot(snapshot => { allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); applySearchAndSort(); renderStats(allHuts); renderRegistrationsChart(allHuts); if (currentEditingHutId && hutEditModal.classList.contains('flex')) { openHutModal(currentEditingHutId); } }, err => console.error("Huts Listener Error:", err)); }
  function renderStats(list) { const total = list.length; const angenommen = list.filter(h => h.status === 'angenommen').length; const offen = list.filter(h => h.status === 'offen').length; const abgelehnt = list.filter(h => h.status === 'abgelehnt').length; const pendingFotos = list.reduce((sum, h) => sum + (h.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length, 0); const statsContainer = document.getElementById('statsContainer'); statsContainer.innerHTML = `<div class="card text-center"><p class="text-3xl font-bold">${total}</p><p>Gesamt</p></div><div class="card text-center bg-green-50"><p class="text-3xl font-bold text-green-600">${angenommen}</p><p>Angenommen</p></div><div class="card text-center bg-yellow-50"><p class="text-3xl font-bold text-yellow-600">${offen}</p><p>Offen</p></div><div class="card text-center bg-blue-50"><p class="text-3xl font-bold text-blue-600">${pendingFotos}</p><p>Fotos offen</p></div><div class="card text-center bg-red-50"><p class="text-3xl font-bold text-red-600">${abgelehnt}</p><p>Abgelehnt</p></div>`; const modQueueCount = offen + pendingFotos; const modQueueBadge = document.getElementById('mod-queue-badge'); modQueueBadge.textContent = modQueueCount; modQueueBadge.classList.toggle('hidden', modQueueCount === 0); }
  function renderRegistrationsChart(list) { const ctx = document.getElementById('registrationsChart')?.getContext('2d'); if (!ctx) return; const today = new Date(); const labels = []; const data = Array(30).fill(0); for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); labels.push(d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })); } list.forEach(hut => { const hutDate = hut.erstelltAm?.toDate(); if (!hutDate) return; const diffTime = today - hutDate; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); if (diffDays >= 0 && diffDays < 30) { const index = 29 - diffDays; data[index]++; } }); const chartData = { labels: labels, datasets: [{ label: 'Neue H√ºtten', data: data, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, fill: true, tension: 0.1 }] }; if (registrationsChartInstance) { registrationsChartInstance.data = chartData; registrationsChartInstance.update(); } else { registrationsChartInstance = new Chart(ctx, { type: 'line', data: chartData }); } }

  // === H√úTTEN-TABELLE & BULK-ACTIONS ===
  function applySearchAndSort() { const search = document.getElementById('search-input').value.toLowerCase(); const status = document.getElementById('status-filter').value; filteredHuts = allHuts.filter(hut => (hut.name?.toLowerCase().includes(search) || hut.id.includes(search)) && (status === "" || hut.status === status)); currentPage = 1; renderPage(currentPage); updateBulkActionUI(); }
  function renderPage(page) { const start = (page - 1) * hutsPerPage; const end = start + hutsPerPage; const hutsToRender = filteredHuts.slice(start, end); renderHutsTable(hutsToRender); renderPagination(filteredHuts.length); }
  function renderHutsTable(list) { hutTableBody.innerHTML = ''; if (list.length === 0) { hutTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 italic py-4">Keine H√ºtten gefunden.</td></tr>'; return; } list.forEach(hut => { let sC = 'bg-gray-100 text-gray-700'; if (hut.status === 'angenommen') sC = 'bg-green-100 text-green-700'; else if (hut.status === 'offen') sC = 'bg-yellow-100 text-yellow-700'; else if (hut.status === 'abgelehnt') sC = 'bg-red-100 text-red-700'; const pFc = (hut.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length; const row = document.createElement('tr'); row.className = 'hover:bg-gray-50'; row.innerHTML = `<td><input type="checkbox" class="hut-checkbox" data-id="${hut.id}"></td><td><p class="font-semibold text-emerald-700">${escapeHtml(hut.name || 'Unbenannt')}</p><p class="text-xs text-gray-400">${hut.id}</p></td><td><span class="text-xs font-medium px-2 py-1 rounded-full ${sC}">${escapeHtml(hut.status || 'N/A')}</span></td><td class="text-sm text-gray-600">${hut.erstelltAm?.toDate().toLocaleDateString('de-DE') || '-'}</td><td class="text-sm ${pFc > 0 ? 'text-blue-600 font-semibold' : ''}">${pFc}</td><td><button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">Bearbeiten</button></td>`; hutTableBody.appendChild(row); }); }
  function renderPagination(totalItems) { const totalPages = Math.ceil(totalItems / hutsPerPage); const pC = document.getElementById('pagination'); pC.innerHTML = ''; if (totalPages <= 1) return; const cPB = (l, p, iA = false, iD = false) => { const b = document.createElement('button'); b.innerHTML = l; b.disabled = iD; b.className = `px-3 py-1 border rounded-md mx-1 ${iA ? 'bg-emerald-600 text-white' : 'bg-white hover:bg-gray-100'} ${iD ? 'text-gray-300 cursor-not-allowed' : ''}`; if (!iD) b.onclick = () => { currentPage = p; renderPage(currentPage); }; return b; }; pC.appendChild(cPB('&laquo;', currentPage - 1, false, currentPage === 1)); let sP = Math.max(1, currentPage - 2); let eP = Math.min(totalPages, currentPage + 2); if (sP > 1) pC.appendChild(cPB('1', 1)); if (sP > 2) pC.appendChild(cPB('...', 1, false, true)); for (let i = sP; i <= eP; i++) pC.appendChild(cPB(i, i, i === currentPage)); if (eP < totalPages - 1) pC.appendChild(cPB('...', totalPages, false, true)); if (eP < totalPages) pC.appendChild(cPB(totalPages, totalPages)); pC.appendChild(cPB('&raquo;', currentPage + 1, false, currentPage === totalPages)); }
  function toggleAllCheckboxes() { const iC = selectAllCheckbox.checked; hutTableBody.querySelectorAll('.hut-checkbox').forEach(cb => cb.checked = iC); updateBulkActionUI(); }
  function updateBulkActionUI() { const sC = hutTableBody.querySelectorAll('.hut-checkbox:checked').length; bulkActionContainer.classList.toggle('hidden', sC === 0); if (sC === 0) selectAllCheckbox.checked = false; }
  async function handleBulkAction() { const act = document.getElementById('bulk-action-select').value; const sIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id); if (!act || sIds.length === 0) { showNotification('‚ö†Ô∏è Bitte Aktion und H√ºtten ausw√§hlen.'); return; } let cM = `Aktion '${act}' f√ºr ${sIds.length} H√ºtten ausf√ºhren?`; if (act === 'delete') cM = `‚ùó ${sIds.length} H√ºtten L√ñSCHEN?`; if (!confirm(cM)) return; bulkActionBtn.disabled = true; bulkActionBtn.classList.add('button-loading'); let succ = 0; for (const id of sIds) { try { if (act === 'approve') await quickUpdateStatus(id, 'angenommen'); else if (act === 'reject') await quickUpdateStatus(id, 'abgelehnt'); else if (act === 'delete') await deleteHut(id, true); succ++; } catch (e) { console.error(`Bulk Error ${id}:`, e); } } bulkActionBtn.disabled = false; bulkActionBtn.classList.remove('button-loading'); showNotification(`‚úÖ ${succ}/${sIds.length} verarbeitet.`); applySearchAndSort(); }
  
  // === H√úTTEN-MODAL ===
  function closeHutModal() { hutEditModal.classList.remove('flex'); hutEditModalContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>'; currentEditingHutId = null; adminModalMap = null; adminModalLocation = null; quillInstance = null; }
  async function openHutModal(hutId) {
      currentEditingHutId = hutId; let hut; let title = "Neue H√ºtte"; let logs = []; let stats = { views: 0, routeStarts: 0 };
      if (hutId) { hut = allHuts.find(h => h.id === hutId); if (!hut) { showNotification('‚ùå H√ºtte nicht gefunden.'); return; } title = `Bearbeiten: ${escapeHtml(hut.name)}`; stats = { views: hut.views || 0, routeStarts: hut.routeStarts || 0 }; try { const logSnap = await db.collection('eierhuetten').doc(hutId).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get(); logs = logSnap.docs.map(doc => doc.data()); } catch (e) { console.error("Log Error:", e); } } 
      else { hut = { id: null, name: '', status: 'angenommen', tiere: [], fotos: [], location: null, oeffnungszeiten: {}, beschreibung: '', extras: '', tags: [] }; }
      const selectedEmojis = new Set(normalizeToEmojiArray(hut.tiere || [])); const tiereHTML = Object.entries(TIERE_EMOJI_TO_NAME).map(([emoji, name]) => `<button type="button" data-emoji="${emoji}" class="admin-tiere-btn text-2xl rounded p-2 ${selectedEmojis.has(emoji) ? 'bg-yellow-200 ring-2 ring-yellow-400' : 'bg-gray-100 hover:bg-gray-200'}" title="${escapeAttr(name)}">${emoji}</button>`).join('');
      const tabStammdaten = `<div class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block font-semibold mb-1">Name</label><input id="modal-hut-name" class="w-full border p-2 rounded-md" value="${escapeAttr(hut.name || '')}"></div><div><label class="block font-semibold mb-1">Status</label><select id="modal-hut-status" class="w-full border p-2 rounded-md bg-white">${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}</select></div><div class="relative"><div class="flex justify-between items-center mb-1"><label class="block font-semibold">Beschreibung</label><button id="aiDescBtnModal" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">ü™Ñ KI-Vorschlag</button></div><div id="quillContainer" class="bg-white border rounded min-h-[150px]"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="block font-semibold mb-1">Strom</label><select id="modal-hut-strom" class="w-full border p-2 rounded-md bg-white">${['Ja','Nein', 'Unbekannt'].map(o => `<option ${o===(hut.strom || 'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div><div><label class="block font-semibold mb-1">Sitzpl√§tze</label><select id="modal-hut-sitzplaetze" class="w-full border p-2 rounded-md bg-white">${['Ja','Nein', 'Unbekannt'].map(o => `<option ${o===(hut.sitzplaetze || 'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div></div><div><label class="block font-semibold mb-1">Extras</label><input id="modal-hut-extras" class="w-full border p-2 rounded-md" value="${escapeAttr(hut.extras || '')}"></div></div><div><label class="block font-semibold mb-1">Standort</label><div id="modal-map" class="minimap"></div><p class="text-xs text-gray-500 mt-1">Marker ziehen.</p></div></div><div><label class="block font-semibold mb-1">Tiere</label><div id="modal-tiere-container" class="flex flex-wrap gap-2">${tiereHTML}</div></div><div class="relative"><label class="block font-semibold mb-1">Tags</label><input id="modal-hut-tags" class="w-full border p-2 rounded-md pr-20" value="${escapeAttr((hut.tags || []).join(', '))}"> <button onclick="suggestTagsForEditModal('${hut.id || 'new'}')" class="absolute top-1/2 right-2 transform -translate-y-1/2 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">ü™Ñ KI</button></div></div>`;
      const tabOeffnungszeiten = `<div id="openingEditorWrapper" class="mt-3">${renderOpeningHoursEditor(hut.id || 'new', hut.oeffnungszeiten)}</div>`;
      const tabFotos = `<div id="photoUploaderContainerModal" class="mt-3"></div>`;
      const tabStatistik = `<div class="text-center space-y-4"><div class="p-4 bg-blue-50 rounded-lg"><p class="text-3xl font-bold text-blue-600">${stats.views}</p><p>Aufrufe</p></div><div class="p-4 bg-green-50 rounded-lg"><p class="text-3xl font-bold text-green-600">${stats.routeStarts}</p><p>Routenstarts</p></div></div>`;
      const tabProtokoll = `<div><ul class="text-sm max-h-96 overflow-y-auto mt-2 border p-2 rounded-md bg-gray-50 divide-y">${logs.length > 0 ? logs.map(log => `<li class="py-2"><strong>${escapeHtml(log.admin)}</strong> √§nderte <em>${escapeHtml(log.feld)}</em> ${log.wert ? `auf <code>${escapeHtml(String(log.wert).substring(0, 100))}...</code>` : ''}<span class="block text-xs text-gray-400">${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</span></li>`).join('') : '<p>Keine Logs.</p>'}</ul></div>`;
      hutEditModalContent.innerHTML = `<div class="modal-header"><h2 class="text-2xl font-bold">${title}</h2><button onclick="closeHutModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div class="modal-tab-nav"><button class="modal-tab active" onclick="showModalTab('stammdaten')">Stammdaten</button><button class="modal-tab" onclick="showModalTab('oeffnungszeiten')">√ñffnungszeiten</button><button class="modal-tab" onclick="showModalTab('fotos')">Fotos</button><button class="modal-tab" onclick="showModalTab('statistik')">Statistiken</button><button class="modal-tab" onclick="showModalTab('protokoll')">Protokoll</button></div><div class="modal-body"><div id="tab-stammdaten" class="modal-tab-content active">${tabStammdaten}</div><div id="tab-oeffnungszeiten" class="modal-tab-content">${tabOeffnungszeiten}</div><div id="tab-fotos" class="modal-tab-content">${tabFotos}</div><div id="tab-statistik" class="modal-tab-content">${tabStatistik}</div><div id="tab-protokoll" class="modal-tab-content">${tabProtokoll}</div></div><div class="modal-footer flex justify-between items-center"><div>${hutId ? `<button id="deleteHutBtnModal" onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">L√∂schen</button>` : ''}</div><div class="flex gap-4"><button onclick="closeHutModal()" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400">Abbrechen</button><button id="saveHutBtnModal" onclick="saveHutFromModal()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-700">Speichern</button></div></div>`;
      hutEditModal.classList.add('flex');
      setTimeout(() => { if (document.getElementById('quillContainer')) { quillInstance = new Quill("#quillContainer", { theme: "snow" }); if (hut.beschreibung) quillInstance.root.innerHTML = hut.beschreibung; document.getElementById('aiDescBtnModal')?.addEventListener('click', generateDescriptionForModal); } const photoContainer = document.getElementById('photoUploaderContainerModal'); if (photoContainer) { renderSmartImageUploader(photoContainer, db.collection('eierhuetten').doc(hut.id || 'new'), hut.fotos, hut.id || 'new'); } initModalMap(hut.location); }, 100); // Verz√∂gert, damit DOM bereit ist
      document.getElementById('modal-tiere-container')?.addEventListener('click', e => { const btn = e.target.closest('.admin-tiere-btn'); if (!btn) return; const emoji = btn.dataset.emoji; if (currentEditingHutId && emoji) { toggleTier(currentEditingHutId, emoji); } else if (!currentEditingHutId && emoji) { btn.classList.toggle('bg-yellow-200'); btn.classList.toggle('ring-2'); btn.classList.toggle('ring-yellow-400'); btn.classList.toggle('bg-gray-100'); } });
  }
  async function generateDescriptionForModal() { if (!quillInstance) return; const data = collectCurrentModalData(); showToast("üß† Generiere KI-Beschreibung...", 3000); try { const desc = await generateProfessionalDescription(data); quillInstance.root.innerHTML = `<p>${desc.replace(/\n/g, '</p><p>')}</p>`; } catch(e) { showToast("‚ùå KI-Fehler: "+e.message) } }
  async function suggestTagsForEditModal(hutId) { const tagsInput = document.getElementById('modal-hut-tags'); if (!tagsInput) return; const data = collectCurrentModalData(); showToast("üß† Generiere KI-Tags...", 2000); try { const tags = await generateAITags(data); tagsInput.value = tags.join(', '); } catch(e) { showToast("‚ùå KI-Fehler: "+e.message) } }
  function collectCurrentModalData() { const base = currentEditingHutId ? allHuts.find(h => h.id === currentEditingHutId) : {}; return { ...base, name: document.getElementById('modal-hut-name')?.value || '', beschreibung: quillInstance ? quillInstance.root.innerHTML : '', strom: document.getElementById('modal-hut-strom')?.value || 'Unbekannt', sitzplaetze: document.getElementById('modal-hut-sitzplaetze')?.value || 'Unbekannt', extras: document.getElementById('modal-hut-extras')?.value || '', tiere: Array.from(document.querySelectorAll('#modal-tiere-container .admin-tiere-btn.bg-yellow-200')).map(b => b.dataset.emoji), tags: (document.getElementById('modal-hut-tags')?.value || '').split(',').map(t=>t.trim()).filter(Boolean) }; }
  function showModalTab(tabId) { document.querySelectorAll('#hut-edit-modal .modal-tab').forEach(b => b.classList.remove('active')); document.querySelector(`#hut-edit-modal .modal-tab[onclick="showModalTab('${tabId}')"]`)?.classList.add('active'); document.querySelectorAll('#hut-edit-modal .modal-tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`tab-${tabId}`)?.classList.add('active'); if (tabId === 'stammdaten') { setTimeout(() => { if (!adminModalMap) { const hut = allHuts.find(h => h.id === currentEditingHutId); initModalMap(hut?.location); } else { adminModalMap.invalidateSize(); } }, 50); } if (tabId === 'fotos' && currentEditingHutId && !document.getElementById(`smartUploadZone-${currentEditingHutId}`)) { const hut = allHuts.find(h => h.id === currentEditingHutId); const cont = document.getElementById('photoUploaderContainerModal'); if (cont && hut) { renderSmartImageUploader(cont, db.collection('eierhuetten').doc(hut.id), hut.fotos, hut.id); } } }
  function initModalMap(location) { let lat = location?.latitude || 51.16; let lng = location?.longitude || 10.45; let zoom = location ? 13 : 6; adminModalLocation = location ? new firebase.firestore.GeoPoint(lat, lng) : null; const mapCont = document.getElementById('modal-map'); if (!mapCont || !mapCont.offsetParent) return; if (adminModalMap) { adminModalMap.setView([lat, lng], zoom); if (adminModalMarker) adminModalMarker.setLatLng([lat, lng]); else adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap).on('dragend', handleMarkerDrag); adminModalMap.invalidateSize(); return; } try { adminModalMap = L.map('modal-map').setView([lat, lng], zoom); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminModalMap); adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap).on('dragend', handleMarkerDrag); adminModalMap.invalidateSize(); } catch(e) { console.error("Leaflet Error:", e); } }
  function handleMarkerDrag(e) { const pos = e.target.getLatLng(); adminModalLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng); }

  // === H√úTTEN-CRUD ===
  async function saveHutFromModal() {
      const saveBtn = document.getElementById('saveHutBtnModal'); saveBtn.disabled = true; saveBtn.classList.add('button-loading');
      const name = document.getElementById('modal-hut-name')?.value || ''; const status = document.getElementById('modal-hut-status')?.value || 'offen'; const beschreibung = quillInstance ? quillInstance.root.innerHTML : ''; const strom = document.getElementById('modal-hut-strom')?.value || 'Unbekannt'; const sitzplaetze = document.getElementById('modal-hut-sitzplaetze')?.value || 'Unbekannt'; const extras = document.getElementById('modal-hut-extras')?.value || ''; const tags = (document.getElementById('modal-hut-tags')?.value || '').split(',').map(t=>t.trim()).filter(Boolean); const oeffnungszeiten = collectOpeningHours(currentEditingHutId || 'new');
      if (!name) { showNotification('‚ùå Name fehlt.'); saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); return; } if (!adminModalLocation) { showNotification('‚ùå Standort fehlt.'); saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); return; }
      let tiere = []; if (!currentEditingHutId) { document.querySelectorAll('#modal-tiere-container .admin-tiere-btn.bg-yellow-200').forEach(btn => tiere.push(btn.dataset.emoji)); }
      const data = { name, status, beschreibung, strom, sitzplaetze, location: adminModalLocation, extras, tags, oeffnungszeiten: normalizeOpeningHours(oeffnungszeiten) };
      try {
          if (currentEditingHutId) { const hutRef = db.collection('eierhuetten').doc(currentEditingHutId); await hutRef.update(data); logAdminAction(`H√ºtte aktualisiert`, { hutId: currentEditingHutId, hutName: data.name }); showNotification('‚úÖ H√ºtte aktualisiert.'); } 
          else { data.erstelltAm = firebase.firestore.FieldValue.serverTimestamp(); data.userId = currentUser.uid; data.fotos = []; data.tiere = tiere; data.views = 0; data.routeStarts = 0; const docRef = await db.collection('eierhuetten').add(data); logAdminAction('Neue H√ºtte erstellt', { hutId: docRef.id, hutName: data.name }); showNotification('‚úÖ Neue H√ºtte erstellt.'); }
          closeHutModal();
      } catch (e) { showNotification('‚ùå Speicherfehler: '+e.message); console.error(e); } finally { saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); }
  }
  async function quickUpdateStatus(hutId, status) { try { const ref = db.collection('eierhuetten').doc(hutId); await ref.update({ status }); const hut = allHuts.find(h => h.id === hutId); logAdminAction(`Status: '${status}'`, { hutId, hutName: hut?.name }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'status', wert: status, zeitpunkt: new Date() }); } catch(e) { console.error("QuickUpdate Error:", e); showNotification(`‚ùå Fehler ${hutId}: ${e.message}`); } }
  async function deleteHut(id, skipConfirm = false) { if (!skipConfirm && !confirm(`‚ùó H√ºtte ${id} L√ñSCHEN?`)) return; const btn = document.getElementById('deleteHutBtnModal'); if(btn) { btn.disabled = true; btn.classList.add('button-loading'); } try { const ref = db.collection('eierhuetten').doc(id); const doc = await ref.get(); if(!doc.exists) throw new Error("Nicht gefunden."); const hut = doc.data(); const name = hut.name || id; if (Array.isArray(hut.fotos)) { for (const f of hut.fotos) { if (f && typeof f === "object" && f.delete_url) { try { await fetch(f.delete_url, { method: 'DELETE' }); } catch (e) {} } } } await ref.delete(); logAdminAction('H√ºtte gel√∂scht', { hutId: id, hutName: name }); showNotification('üóëÔ∏è H√ºtte gel√∂scht.'); closeHutModal(); } catch (err) { showNotification('‚ùå L√∂schfehler: ' + err.message); console.error(err); } finally { if(btn) { btn.disabled = false; btn.classList.remove('button-loading'); } } }

  // === FOTO-VERWALTUNG ===
  async function approveFoto(hutId, index) { try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : []; const f = fotos[index]; if (!f || typeof f === 'string') return; fotos[index] = { ...f, status: 'freigegeben' }; await ref.update({ fotos }); logAdminAction('Foto freigegeben', { hutId, hutName: snap.data().name, url: f.url }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto freigegeben: ${f.url}`, zeitpunkt: new Date() }); showNotification('‚úÖ Bild freigegeben'); } catch (err) { showNotification('‚ùå Fehler beim Freigeben.'); console.error(err); } }
  async function rejectFoto(hutId, index) {
      if (!confirm('Foto wirklich l√∂schen?')) return;
      try {
          const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); if (!snap.exists) throw new Error("H√ºtte nicht gefunden."); let fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : []; const f = fotos[index]; if (!f) return;
          const urlToDelete = typeof f === 'string' ? f : f.url; const deleteUrlApi = (f && typeof f === 'object' && f.delete_url) ? f.delete_url : null; fotos.splice(index, 1); await ref.update({ fotos }); logAdminAction('Foto gel√∂scht', { hutId, hutName: snap.data().name, url: urlToDelete }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto gel√∂scht: ${urlToDelete}`, zeitpunkt: new Date() }); if (deleteUrlApi) { try { await fetch(deleteUrlApi, { method: 'DELETE' }); } catch (e) { console.warn('imgbb delete failed', e); } } showNotification('üóëÔ∏è Bild entfernt');
          if (currentEditingHutId === hutId && hutEditModal.classList.contains('flex')) { // Re-render uploader if modal is open
              const photoContainer = document.getElementById('photoUploaderContainerModal'); if (photoContainer) { renderSmartImageUploader(photoContainer, ref, fotos, hutId); }
          }
      } catch (err) { showNotification('‚ùå Fehler beim Entfernen: ' + err.message); console.error(err); }
  }
  async function renderSmartImageUploader(container, docRef, existingImages = [], entryId) {
      const isNewEntry = entryId === 'new';
      container.innerHTML = `<div class="bg-white rounded-xl p-4"> <h3 class="text-sm font-semibold mb-3">üì∏ Fotos verwalten</h3> <div id="smartUploadZone-${entryId}" class="relative border-2 border-dashed ${isNewEntry ? 'border-gray-300 bg-gray-100 cursor-not-allowed' : 'border-gray-300 bg-gray-50 hover:bg-green-50 hover:border-green-400 cursor-pointer'} transition rounded-xl p-6 text-center mb-4"> <p class="text-gray-600 text-sm">${isNewEntry ? 'Bitte H√ºtte zuerst speichern' : 'Ziehe Bilder hierher oder klicke'}</p> <input id="smartUploadInput-${entryId}" type="file" accept="image/*" multiple class="hidden" ${isNewEntry ? 'disabled' : ''}> <div id="smartUploadProgress-${entryId}" class="hidden absolute bottom-2 left-2 right-2 h-1 bg-gray-200 rounded"><div id="smartUploadBar-${entryId}" class="h-1 bg-green-500 rounded transition-all" style="width:0%"></div></div> </div> <div id="smartUploadPreview-${entryId}" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div> </div>`;
      const zone = container.querySelector(`#smartUploadZone-${entryId}`); const input = container.querySelector(`#smartUploadInput-${entryId}`); const preview = container.querySelector(`#smartUploadPreview-${entryId}`); const bar = container.querySelector(`#smartUploadBar-${entryId}`); const barContainer = container.querySelector(`#smartUploadProgress-${entryId}`);
      let currentImages = (existingImages || []).map((img, idx) => { const base = typeof img === 'string' ? { url: img, status: 'freigegeben', title: '' } : { ...img }; base.originalIndex = idx; return base; });
      function renderPreview() {
          preview.innerHTML = ""; if (!currentImages.length) { preview.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm italic py-4">Noch keine Bilder.</div>`; return; }
          currentImages.forEach((img) => { const card = document.createElement("div"); const isPending = img.status === 'wartet'; card.className = `image-card relative group w-full aspect-[4/3] border rounded overflow-hidden bg-gray-50 p-1 flex flex-col items-center shadow-sm ${isPending ? 'border-yellow-400 border-2' : ''}`; card.innerHTML = `<img src="${img.url}" class="object-cover w-full h-2/3 rounded mb-1 ${isPending ? 'opacity-70' : ''}"> <input data-idx="${img.originalIndex}" class="imageTitleInput w-full text-[10px] border rounded p-0.5 text-center mb-0.5" value="${escapeAttr(img.title || '')}" placeholder="Titel..."> <div class="flex justify-center gap-1 w-full"> <button onclick="generateSingleImageTitle(this)" title="KI Titel" class="kiBtn text-[10px] bg-blue-500 text-white rounded px-1 hover:bg-blue-600">ü™Ñ</button> ${isPending ? `<button onclick="approveFoto('${entryId}', ${img.originalIndex})" title="Freigeben" class="approveBtn text-[10px] bg-green-500 text-white rounded px-1 hover:bg-green-600">‚úî</button>` : ''} <button onclick="rejectFoto('${entryId}', ${img.originalIndex})" title="L√∂schen" class="removeBtn text-[10px] bg-red-500 text-white rounded px-1 hover:bg-red-600">‚úï</button> </div> ${isPending ? '<div class="absolute top-1 left-1 bg-yellow-400 text-yellow-900 text-[9px] px-1 rounded font-semibold">Wartet</div>' : ''}`;
              card.querySelector(".imageTitleInput").addEventListener("input", debounce(async (e) => { const idx = parseInt(e.target.dataset.idx); const newTitle = e.target.value; const imgToUpdate = currentImages.find(img => img.originalIndex === idx); if(imgToUpdate) imgToUpdate.title = newTitle; try { await docRef.update({ fotos: currentImages.map(({originalIndex, ...rest}) => rest) }); } catch(err) { console.error("Error saving title:", err); showToast("Fehler beim Titel speichern."); } }, 500));
              preview.appendChild(card);
          });
      }
      if (!isNewEntry) { zone.onclick = () => input.click(); zone.ondragover = (e) => { e.preventDefault(); zone.classList.add("bg-green-100", "border-green-400"); }; zone.ondragleave = () => zone.classList.remove("bg-green-100", "border-green-400"); zone.ondrop = (e) => { e.preventDefault(); zone.classList.remove("bg-green-100", "border-green-400"); handleFiles(e.dataTransfer.files); }; input.onchange = (e) => handleFiles(e.target.files); }
      renderPreview();
      async function handleFiles(files) {
          const list = Array.from(files); if (!list.length) return; barContainer.classList.remove("hidden"); let succ = 0;
          for (let i = 0; i < list.length; i++) {
              bar.style.width = `${((i + 1) / list.length) * 100}%`;
              try {
                  const base64 = await new Promise((resolve, reject) => { const r=new FileReader(); r.onload=()=>resolve(r.result.split(',')[1]); r.onerror=reject; r.readAsDataURL(list[i]); });
                  const formData = new FormData(); formData.append('key', IMGBB_KEY); formData.append('image', base64);
                  const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData }); const json = await res.json(); if (!json.success) throw new Error(json.error.message);
                  const url = json.data.url; const title = await generateSmartImageTitle(url, list[i].name); const newImage = { url, title, delete_url: json.data.delete_url || null, status: 'wartet' };
                  await docRef.update({ fotos: firebase.firestore.FieldValue.arrayUnion(newImage) });
                  // Update local state after successful upload
                  const updatedSnap = await docRef.get(); currentImages = (updatedSnap.data().fotos || []).map((img, idx) => ({ ...img, originalIndex: idx }));
                  succ++;
              } catch(e) { showNotification(`‚ùå Upload-Fehler: ${e.message}`); console.error(e); }
          }
          barContainer.classList.add("hidden"); bar.style.width = '0%'; showNotification(`‚úÖ ${succ}/${list.length} Bilder hochgeladen (warten auf Freigabe).`); logAdminAction(`${succ} Foto(s) hochgeladen`, { hutId: entryId, hutName: allHuts.find(h=>h.id===entryId)?.name }); renderPreview();
      }
  }
  function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func.apply(this, args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };
  async function generateSingleImageTitle(buttonElement) { const input = buttonElement.closest('div').querySelector('.imageTitleInput'); const img = buttonElement.closest('.image-card').querySelector('img'); if (!input || !img) return; buttonElement.textContent = 'üß†...'; buttonElement.disabled = true; try { const url = img.src; const suggestion = await generateSmartImageTitle(url); input.value = suggestion; input.dispatchEvent(new Event('input', { bubbles: true })); showToast('ü™Ñ KI-Titel!'); } catch (e) { showToast('‚ùå KI-Fehler.'); } finally { buttonElement.textContent = 'ü™Ñ'; buttonElement.disabled = false; } }
  async function generateSmartImageTitle(url, filename = "") { const cleanName = (filename || url.split('/').pop()).replace(/\.[^/.]+$/, "").toLowerCase().replace(/[-_]/g, ' '); if (cleanName.includes("automat")) return "Verkaufsautomat"; if (cleanName.includes("huhn") || cleanName.includes("h√ºhner")) return "H√ºhner"; if (cleanName.includes("kuh") || cleanName.includes("k√ºhe")) return "K√ºhe"; if (cleanName.includes("h√ºtte") || cleanName.includes("huette")) return "H√ºtte"; if (cleanName.includes("hof")) return "Hofansicht"; if (cleanName.includes("laden")) return "Hofladen"; if (cleanName.includes("spielplatz")) return "Spielplatz"; if (cleanName.includes("landschaft") || cleanName.includes("aussen")) return "Au√üenansicht"; return cleanName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') || "Detail"; }

  // === TIERE-VERWALTUNG ===
  async function toggleTier(hutId, emoji) { const ref = db.collection('eierhuetten').doc(hutId); let newArr = []; try { await db.runTransaction(async tx => { const doc = await tx.get(ref); if (!doc.exists) throw new Error('H√ºtte nicht gefunden'); let tiere = normalizeToEmojiArray(doc.data().tiere || []); const idx = tiere.indexOf(emoji); if (idx >= 0) tiere.splice(idx, 1); else { tiere = tiere.filter(t => t !== '‚ùå'); if (emoji === '‚ùå') tiere = ['‚ùå']; else tiere.push(emoji); } newArr = tiere; tx.update(ref, { tiere }); }); const hut = allHuts.find(h => h.id === hutId); logAdminAction(`Tiere ge√§ndert: ${newArr.join(', ')}`, { hutId, hutName: hut?.name }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'tiere', wert: newArr.join(', '), zeitpunkt: new Date() }); /* UI wird durch onSnapshot aktualisiert */ } catch (e) { showNotification('‚ùå Fehler Tiere'); console.error(e); } }
  
  // === √ñFFNUNGSZEITEN EDITOR ===
  const DAY_LABELS = [ { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" }, { key: "mi", label: "Mittwoch" }, { key: "do", label: "Donnerstag" }, { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" }, { key: "so", label: "Sonntag" } ];
  function renderOpeningHoursEditor(elemId, data = {}) { let html = `<div id="openhours-${elemId}" class="space-y-2 mt-2"> <table class="w-full text-sm border border-gray-200 rounded overflow-hidden"> <thead class="bg-gray-100 text-gray-700"> <tr> <th class="py-2 px-3 text-left">Tag</th> <th class="py-2 px-3 text-center">Ge√∂ffnet</th> <th class="py-2 px-3 text-center">Von</th> <th class="py-2 px-3 text-center">Bis</th> </tr> </thead> <tbody class="divide-y">`; DAY_LABELS.forEach(day => { const d = data[day.key] || { open: false, from: "", to: "" }; html += `<tr> <td class="py-2 px-3">${day.label}</td> <td class="text-center"><input type="checkbox" class="oh-open" data-day="${day.key}" ${d.open ? "checked" : ""}/></td> <td class="text-center"><input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${d.from || ''}" ${!d.open ? "disabled" : ""}/></td> <td class="text-center"><input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${d.to || ''}" ${!d.open ? "disabled" : ""}/></td> </tr>`; }); html += `</tbody> </table> <p class="text-xs text-gray-500">Tipp: Leere Felder = geschlossen.</p> </div>`; setTimeout(() => attachOpeningHoursListeners(elemId), 0); return html; }
  function attachOpeningHoursListeners(elemId) { const cont = document.getElementById(`openhours-${elemId}`); if (!cont) return; cont.addEventListener("change", (e) => { if (e.target.classList.contains("oh-open")) { const dayK = e.target.dataset.day; const row = e.target.closest("tr"); const fI = row.querySelector(`.oh-from[data-day="${dayK}"]`); const tI = row.querySelector(`.oh-to[data-day="${dayK}"]`); fI.disabled = !e.target.checked; tI.disabled = !e.target.checked; if (!e.target.checked) { fI.value = ""; tI.value = ""; } } }); }
  function collectOpeningHours(elemId) { const wrap = document.getElementById(`openhours-${elemId}`); if (!wrap) return {}; const res = {}; DAY_LABELS.forEach(day => { const oC = wrap.querySelector(`.oh-open[data-day="${day.key}"]`); const fI = wrap.querySelector(`.oh-from[data-day="${day.key}"]`); const tI = wrap.querySelector(`.oh-to[data-day="${day.key}"]`); const open = oC ? oC.checked : false; res[day.key] = { open, from: open ? (fI?.value || "") : "", to: open ? (tI?.value || "") : "" }; }); return res; }
  function normalizeOpeningHours(oeff) { if (typeof oeff === 'object' && oeff.mo && typeof oeff.mo === 'object') return oeff; const res = {}; DAY_LABELS.forEach(day => res[day.key] = { open: false, from: "", to: "" }); console.warn("√ñffnungszeiten normalisiert:", oeff); return res; }

  // === NAVIGATION ===
  function showSection(id) { document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden')); document.getElementById(id)?.classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.nav-btn[onclick="showSection('${id}')"]`)?.classList.add('active'); }
  function showNotification(message) { notification.textContent = message; notification.style.display = 'block'; setTimeout(() => notification.style.display = 'none', 4000); }

  // === MODERATIONS-SEITE ===
  function initLiveModerationQueues() {
      db.collection('eierhuetten').where('status', '==', 'offen').onSnapshot(snap => { const cont = document.getElementById("neueListe-page"); if(!cont) return; if (snap.empty) { cont.innerHTML = "<p>Keine neuen.</p>"; return; } cont.innerHTML = ""; snap.forEach(doc => { const hut = doc.data(); const row = document.createElement("div"); row.className = "flex items-center justify-between bg-white shadow-sm rounded px-3 py-2 border"; row.innerHTML = `<p class="font-medium text-blue-600 truncate max-w-[50%]">${escapeHtml(hut.name)}</p><div class="flex space-x-2"><button onclick="quickUpdateStatus('${doc.id}', 'angenommen')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">Annehmen</button><button onclick="openHutModal('${doc.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Details</button></div>`; cont.appendChild(row); }); });
      db.collection('eierhuetten').onSnapshot(snap => { const cont = document.getElementById("pending-fotos-page"); if(!cont) return; const pending = []; snap.forEach(doc => { const data = doc.data(); const waitP = (data.fotos || []).map((f, i) => ({...f, originalIndex: i})).filter(f => f && typeof f === 'object' && f.status === 'wartet'); if (waitP.length > 0) pending.push({ id: doc.id, name: data.name, waitP }); }); if (pending.length === 0) { cont.innerHTML = "<p>Keine Fotos offen.</p>"; return; } cont.innerHTML = ""; pending.forEach(hut => { const row = document.createElement("div"); row.className = "bg-white shadow-sm rounded p-3 border"; row.innerHTML = `<div class="flex justify-between items-center mb-2"><p class="font-medium text-blue-600">${escapeHtml(hut.name)}</p><button onclick="openHutModal('${hut.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Anzeigen</button></div><div class="flex flex-wrap gap-2">${hut.waitP.map(f => `<div class="relative w-16 h-16 rounded overflow-hidden border"><img src="${f.url}" alt="wartet" class="object-cover w-full h-full" /><div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 hover:opacity-100 transition"><button onclick="approveFoto('${hut.id}', ${f.originalIndex})" class="text-white text-lg">‚úî</button><button onclick="rejectFoto('${hut.id}', ${f.originalIndex})" class="text-white text-lg ml-2">‚úñ</button></div></div>`).join('')}</div>`; cont.appendChild(row); }); });
  }
  async function bulkApproveHuts() { const ids = Array.from(document.querySelectorAll('#neueListe-page button[onclick^="quickUpdateStatus"]')).map(btn => btn.onclick.toString().match(/'([^']+)'/)[1]); if (!ids.length || !confirm(`${ids.length} H√ºtten freigeben?`)) return; for (const id of ids) { await quickUpdateStatus(id, 'angenommen'); } showNotification(`${ids.length} H√ºtten freigegeben.`); }


  // === SUPPORT-SYSTEM ===
  let currentSupportTickets = []; let allSupportTickets = []; const SUPPORT_MSG_MAX = 500;
  function initLiveSupportQueue() { db.collection('support').orderBy('createdAt', 'desc').onSnapshot(snap => { allSupportTickets = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); applySupportFilters(); const openCount = allSupportTickets.filter(t => t.status === 'offen').length; const badge = document.getElementById('support-queue-badge'); badge.textContent = openCount; badge.classList.toggle('hidden', openCount === 0); if (currentEditingSupportTicketId && supportReplyModal.classList.contains('flex')) { openReplyModal(currentEditingSupportTicketId); } }, err => console.error("Support Listener:", err)); }
  function applySupportFilters() { const sT = document.getElementById('support-search').value.toLowerCase(); const sF = document.getElementById('support-status-filter').value; const pF = document.getElementById('support-priority-filter').value; currentSupportTickets = allSupportTickets.filter(t => { const sM = (t.mail?.toLowerCase().includes(sT) || t.internalNotes?.some(n => n.text?.toLowerCase().includes(sT))); const stM = (sF === "") || (t.status === sF); const pM = (pF === "") || ((t.priority || 'Normal') === pF); return sM && stM && pM; }); renderSupportTable(); }
  function renderSupportTable() { supportTicketsBody.innerHTML = ''; if (currentSupportTickets.length === 0) { supportTicketsBody.innerHTML = '<tr><td colspan="6" class="text-center italic py-4">Keine Tickets gefunden.</td></tr>'; return; } currentSupportTickets.forEach(t => { const id = t.id; const d = t.createdAt?.toDate().toLocaleString('de-DE') || '-'; const e = t.mail || '-'; const s = t.status || 'offen'; const p = t.priority || 'Normal'; const row = document.createElement('tr'); row.className = `align-top hover:bg-gray-50 priority-${p}`; row.innerHTML = `<td class="px-4 py-2 font-semibold">${p}</td><td class="px-4 py-2 text-xs">${d}</td><td class="px-4 py-2 text-xs">${escapeHtml(e)}</td><td class="px-4 py-2 text-xs"><div id="msgs-preview-${id}" class="max-h-16 overflow-hidden text-ellipsis">...</div></td><td class="px-4 py-2"><span class="text-xs font-medium px-2 py-1 rounded-full ${s === 'offen' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${escapeHtml(s)}</span></td><td class="px-4 py-2"><button onclick="openReplyModal('${id}')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">√ñffnen</button></td>`; supportTicketsBody.appendChild(row); loadSupportMessagePreview(id); }); }
  async function loadSupportMessagePreview(ticketId) { const pEl = document.getElementById(`msgs-preview-${ticketId}`); if (!pEl) return; try { const mS = await db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "desc").limit(1).get(); if (!mS.empty) { const lM = mS.docs[0].data(); pEl.textContent = `${lM.sender === 'Admin' ? 'Admin: ' : ''}${lM.text || ''}`; } else { pEl.textContent = "(Keine Nachrichten)"; } } catch (e) { pEl.textContent = "(Fehler)"; } }
  async function openReplyModal(ticketId) { currentEditingSupportTicketId = ticketId; const t = allSupportTickets.find(t => t.id === ticketId); if (!t) { showNotification("Ticket nicht gefunden"); return; } document.getElementById("modal-ticket-info").innerText = `ID: ${ticketId} ¬∑ User: ${escapeHtml(t.mail || '-')}`; document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-reply-counter").innerText = `${SUPPORT_MSG_MAX} Zeichen √ºbrig`; document.getElementById("modal-internal-note").value = ""; const statSel = document.getElementById("modal-ticket-status"); statSel.innerHTML = ['offen', 'bearbeitet', 'geschlossen', 'archiviert'].map(o => `<option value="${o}" ${o === (t.status || 'offen') ? 'selected' : ''}>${o}</option>`).join(''); const prioSel = document.getElementById("modal-ticket-priority"); prioSel.value = t.priority || 'Normal'; const msgHistEl = document.getElementById("modal-message-history"); msgHistEl.innerHTML = '‚è≥...'; _supportMessageUnsubs.get(ticketId)?.(); const unsub = db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "asc").onSnapshot(snap => { msgHistEl.innerHTML = snap.docs.map(doc => { const d = doc.data(); const time = d.createdAt?.toDate().toLocaleString() || ''; const iA = d.sender === 'Admin'; return `<div class="p-2 rounded ${iA ? 'bg-blue-50' : 'bg-gray-100'}"><p>${escapeHtml(d.text || '')}</p><p class="text-xs text-right opacity-70">${iA ? 'Admin' : 'User'} - ${time}</p></div>`; }).join('') || '<p>Keine Nachrichten.</p>'; msgHistEl.scrollTop = msgHistEl.scrollHeight; }, err => { msgHistEl.innerHTML = '<p class="text-red-500">Fehler.</p>'; console.error(err); }); _supportMessageUnsubs.set(ticketId, unsub); const notesHistEl = document.getElementById("modal-internal-notes-history"); notesHistEl.innerHTML = (t.internalNotes || []).map(note => `<div class="border-b pb-1 mb-1"><p>${escapeHtml(note.text || '')}</p><p class="text-xs text-gray-400 text-right">${escapeHtml(note.adminName || 'Admin')} - ${note.timestamp?.toDate().toLocaleString() || ''}</p></div>`).join('') || '<p>Keine Notizen.</p>'; notesHistEl.scrollTop = notesHistEl.scrollHeight; supportReplyModal.classList.add('flex'); }
  function closeReplyModal() { _supportMessageUnsubs.get(currentEditingSupportTicketId)?.(); _supportMessageUnsubs.delete(currentEditingSupportTicketId); supportReplyModal.classList.remove('flex'); currentEditingSupportTicketId = null; }
  async function saveSupportTicketChanges() { const saveBtn = event.target; saveBtn.disabled = true; saveBtn.classList.add('button-loading'); const tId = currentEditingSupportTicketId; if (!tId) return; const repTxt = document.getElementById("modal-reply-text").value.trim(); const intTxt = document.getElementById("modal-internal-note").value.trim(); const nStat = document.getElementById("modal-ticket-status").value; const nPrio = document.getElementById("modal-ticket-priority").value; try { const tRef = db.collection("support").doc(tId); let upds = { status: nStat, priority: nPrio }; let actLog = [`Status: ${nStat}`, `Prio: ${nPrio}`]; if (repTxt) { await tRef.collection("messages").add({ text: repTxt, sender: "Admin", createdAt: firebase.firestore.FieldValue.serverTimestamp() }); actLog.push("Antwort"); } if (intTxt) { upds.internalNotes = firebase.firestore.FieldValue.arrayUnion({ text: intTxt, adminName: currentUser.displayName || currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); actLog.push("Notiz"); } await tRef.update(upds); logAdminAction(`Support bearbeitet: ${actLog.join(', ')}`, { ticketId: tId }); showNotification("‚úÖ Ticket aktualisiert."); document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-internal-note").value = ""; } catch (err) { alert("Fehler: " + err.message); } finally { saveBtn.disabled = false; saveBtn.classList.remove('button-loading'); } }
  function deleteSupportTicketFromModal() { const tId = currentEditingSupportTicketId; if (tId) { deleteSupport(tId); closeReplyModal(); } }
  async function deleteSupport(ticketId) { if (!confirm(`Ticket ${ticketId} l√∂schen?`)) return; try { _supportMessageUnsubs.get(ticketId)?.(); _supportMessageUnsubs.delete(ticketId); await db.collection('support').doc(ticketId).delete(); logAdminAction(`Support-Ticket gel√∂scht`, { ticketId }); showNotification("üóëÔ∏è Ticket gel√∂scht"); } catch (err) { showNotification('‚ùå L√∂schfehler: ' + err.message); console.error(err); } }
  document.getElementById("modal-reply-text")?.addEventListener("input", e => { const left = SUPPORT_MSG_MAX - e.target.value.length; document.getElementById("modal-reply-counter").innerText = `${left} Zeichen √ºbrig`; });
  
  // === PROFIL-VERWALTUNG ===
  let currentProfileId = null;
  async function loadProfileAdmin(id) {
    if (!id) { // If called without ID (e.g., after selection) get it from hidden input
      id = document.getElementById('profile-selected-id')?.value;
    }
    if (!id) return; // Still no ID, abort
    currentProfileId = id; // Set global ID
    const snap = await db.collection("profiles").doc(id).get();
    if (!snap.exists) { alert("Profil nicht gefunden!"); return; }
    const data = snap.data();
    document.getElementById("profile-admin-area").classList.remove("hidden");
    document.getElementById("profile-pic-admin").src = data.pic || "https://placehold.co/96x96/eee/ccc?text=Profil";
    document.getElementById("profile-pic-url").value = data.pic || "";
    document.getElementById("profile-name-admin").value = data.name || "";
    document.getElementById("profile-bio-admin").value = data.bio || "";
    document.getElementById("profile-role-admin").value = data.role || "user";
    document.getElementById("profile-banned-admin").checked = data.banned || false;
    document.getElementById("profile-stats").textContent = `Fahrten: ${data.rides || 0} | Km: ${data.km || 0}`;
    const titleSel = document.getElementById("profile-title-admin"); titleSel.innerHTML = "<option value=''>Kein Titel</option>"; const titleSnap = await db.collection("titles").get(); titleSnap.forEach(doc => { const t = doc.data(); const opt = document.createElement("option"); opt.value = t.name; opt.textContent = t.name; titleSel.appendChild(opt); }); titleSel.value = data.title || "";
    const badgeCont = document.getElementById("profile-badges-admin"); badgeCont.innerHTML = ""; const badgeSnap = await db.collection("badgesDefs").get(); badgeSnap.forEach(doc => { const b = doc.data(); const wrap = document.createElement('label'); wrap.className = 'inline-flex items-center gap-1 mr-2'; const chk = document.createElement("input"); chk.type = "checkbox"; chk.value = doc.id; chk.checked = (data.badges || []).includes(doc.id); wrap.appendChild(chk); const lbl = document.createElement("span"); lbl.textContent = `${b.icon || "üèÖ"} ${b.name}`; wrap.appendChild(lbl); badgeCont.appendChild(wrap); });
  }
  async function saveProfileAdmin() { if (!currentProfileId) return; const badges = [...document.querySelectorAll("#profile-badges-admin input:checked")].map(i => i.value); await db.collection("profiles").doc(currentProfileId).update({ name: document.getElementById("profile-name-admin").value, pic: document.getElementById("profile-pic-url").value, bio: document.getElementById("profile-bio-admin").value, title: document.getElementById("profile-title-admin").value, role: document.getElementById("profile-role-admin").value, banned: document.getElementById("profile-banned-admin").checked, badges: badges }); logAdminAction('Profil gespeichert', { profileId: currentProfileId, profileName: document.getElementById("profile-name-admin").value }); showNotification("‚úîÔ∏è Profil gespeichert!"); }
  async function deleteProfileAdmin() { if (!currentProfileId) return; const name = document.getElementById('profile-name-admin')?.value || currentProfileId; if (!confirm(`Profil "${name}" wirklich l√∂schen?`)) return; await db.collection("profiles").doc(currentProfileId).delete(); logAdminAction('Profil gel√∂scht', { profileId: currentProfileId, profileName: name }); showNotification("üóëÔ∏è Profil gel√∂scht!"); document.getElementById("profile-admin-area").classList.add("hidden"); currentProfileId = null; document.getElementById('profile-search').value = ''; }
  document.getElementById('profile-search')?.addEventListener('input', async e => { const q = e.target.value.trim(); const box = document.getElementById('profile-suggestions'); if (q.length < 2) { box.classList.add('hidden'); return; } const snap = await db.collection('profiles').orderBy('name').startAt(q).endAt(q + '\uf8ff').limit(5).get(); box.innerHTML = snap.empty ? "<p>Keine Treffer</p>" : snap.docs.map(d => `<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectProfile('${d.id}', '${escapeAttr(d.data().name)}')">${escapeHtml(d.data().name)}</div>`).join(''); box.classList.remove('hidden'); });
  window.selectProfile = (id, name) => { document.getElementById('profile-search').value = name; document.getElementById('profile-selected-id').value = id; document.getElementById('profile-suggestions').classList.add('hidden'); loadProfileAdmin(id); };

  // === TITEL & ABZEICHEN ===
  let titleEditId = null; let badgeEditId = null;
  async function loadTitles() { const list = document.getElementById("title-list"); if (!list) return; const snap = await db.collection("titles").get(); list.innerHTML = ""; snap.forEach(doc => { const t = doc.data(); list.innerHTML += `<div class="p-2 border rounded flex justify-between items-center text-sm"><span><strong>${t.name}</strong> (${t.conditionType} ‚â• ${t.conditionValue})</span><div class="space-x-1"><button onclick="editTitle('${doc.id}', '${escapeAttr(t.name)}', '${t.conditionType}', ${t.conditionValue})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚úèÔ∏è</button><button onclick="deleteTitle('${doc.id}', '${escapeAttr(t.name)}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button></div></div>`; }); }
  window.editTitle = (id, name, type, value) => { titleEditId = id; document.getElementById("title-name").value = name; document.getElementById("title-condition").value = type; document.getElementById("title-value").value = value; };
  window.deleteTitle = async (id, name) => { if (!confirm(`Titel "${name}" l√∂schen?`)) return; await db.collection("titles").doc(id).delete(); logAdminAction('Titel gel√∂scht', { titleId: id, titleName: name }); showNotification('Titel gel√∂scht'); loadTitles(); };
  document.getElementById("title-form")?.addEventListener("submit", async (e) => { e.preventDefault(); const payload = { name: document.getElementById("title-name").value.trim(), conditionType: document.getElementById("title-condition").value, conditionValue: parseInt(document.getElementById("title-value").value) || 0 }; if (!payload.name) return; if (titleEditId) { await db.collection("titles").doc(titleEditId).update(payload); logAdminAction('Titel aktualisiert', { titleId: titleEditId, titleName: payload.name }); } else { const ref = await db.collection("titles").add(payload); logAdminAction('Titel erstellt', { titleId: ref.id, titleName: payload.name }); } titleEditId = null; e.target.reset(); loadTitles(); });
  async function loadBadges() { const list = document.getElementById("badge-list-admin"); if (!list) return; const snap = await db.collection("badgesDefs").get(); list.innerHTML = ""; snap.forEach(doc => { const b = doc.data(); const icon = b.iconUrl ? `<img src="${b.iconUrl}" class="w-5 h-5 inline rounded">` : (b.icon || "üèÖ"); list.innerHTML += `<div class="p-2 border rounded flex justify-between items-center text-sm"><span>${icon} <strong>${b.name}</strong> (${b.conditionType} ‚â• ${b.conditionValue})</span><div class="space-x-1"><button onclick="editBadge('${doc.id}', '${escapeAttr(b.name)}', '${escapeAttr(b.icon)}', '${b.conditionType}', ${b.conditionValue})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚úèÔ∏è</button><button onclick="deleteBadge('${doc.id}', '${escapeAttr(b.name)}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button></div></div>`; }); }
  window.editBadge = (id, name, icon, type, value) => { badgeEditId = id; document.getElementById("badge-name").value = name; document.getElementById("badge-icon").value = icon; document.getElementById("badge-condition").value = type; document.getElementById("badge-value").value = value; document.getElementById('badge-icon-file').value = ''; }; // Reset file input
  window.deleteBadge = async (id, name) => { if (!confirm(`Abzeichen "${name}" l√∂schen?`)) return; await db.collection("badgesDefs").doc(id).delete(); logAdminAction('Abzeichen gel√∂scht', { badgeId: id, badgeName: name }); showNotification('Abzeichen gel√∂scht'); loadBadges(); };
  document.getElementById("badge-form")?.addEventListener("submit", async (e) => { e.preventDefault(); const payload = { name: document.getElementById("badge-name").value.trim(), icon: document.getElementById("badge-icon").value.trim(), conditionType: document.getElementById("badge-condition").value, conditionValue: parseInt(document.getElementById("badge-value").value) || 0, iconUrl: '' }; if (!payload.name) return; const fileInput = document.getElementById("badge-icon-file"); if (fileInput.files.length > 0) { try { payload.iconUrl = await badgeFormUploadToImgBB(fileInput.files[0]); } catch (err) { alert("‚ùå Fehler Upload"); return; } } if (!payload.icon && !payload.iconUrl) payload.icon = 'üèÖ'; if (badgeEditId) { await db.collection("badgesDefs").doc(badgeEditId).update(payload); logAdminAction('Abzeichen aktualisiert', { badgeId: badgeEditId, badgeName: payload.name }); } else { const ref = await db.collection("badgesDefs").add(payload); logAdminAction('Abzeichen erstellt', { badgeId: ref.id, badgeName: payload.name }); } badgeEditId = null; e.target.reset(); loadBadges(); });
  async function badgeFormUploadToImgBB(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async () => { const base64 = reader.result.split(",")[1]; const formData = new FormData(); formData.append("key", IMGBB_KEY); formData.append("image", base64); try { const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData }); const json = await res.json(); if (json?.data?.url) resolve(json.data.url); else reject("ImgBB Error"); } catch (err) { reject(err); } }; reader.onerror = () => reject("File Read Error"); reader.readAsDataURL(file); }); }
  document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]')?.addEventListener('click', () => { loadTitles(); loadBadges(); }); // Load on section view
  
  // === HILFSFUNKTIONEN ===
  function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function escapeAttr(s) { if (!s && s !== 0) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  function stripHtml(html){ if(!html) return ''; let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
  
  // === KI Beschreibung & Tags ===
  async function generateProfessionalDescription(d) { const name = (d.name || 'dieser Ort').trim(); const extras = d.extras ? `Extras: ${d.extras}.` : ''; const tiere = Array.isArray(d.tiere) && d.tiere.length && !d.tiere.includes('Keine Tiere') ? `Tiere: ${d.tiere.join(', ')}.` : ''; const pTs = (d.fotos || []).map(f => typeof f === 'string' ? '' : f.title).filter(Boolean); let fTxt = pTs.length > 0 ? `Fotos zeigen ${pTs.slice(0, 2).join(' und ')}.` : ''; const tone = ['idyllisch', 'einladend', 'malerisch'][Math.floor(Math.random()*3)]; const land = ['Wiesen', 'Obstb√§umen', 'H√ºgeln'][Math.floor(Math.random()*3)]; const end = ['Ein Ort zum Verweilen.', 'Liebe zur Natur.', 'Ruhe und Genuss.'][Math.floor(Math.random()*3)]; const paras = [`${name} ist ein ${tone}er Ort, bei ${land}.`, extras, tiere, fTxt, end].filter(Boolean); return paras.join('\n'); }
  async function generateAITags(data) { const tags = new Set(); const corpus = [data.name, stripHtml(data.beschreibung), data.extras, data.typ].join(' ').toLowerCase(); const map = { 'regional': ['regional', 'bauernhof'], 'bio': ['bio'], 'fr√ºhst√ºck': ['fr√ºhst√ºck', 'eier'], 'familie': ['kinder', 'spielplatz'], 'getr√§nke': ['getr√§nke', 'k√ºhlschrank'], 'radweg': ['radweg'], 'natur': ['natur', 'ruhe'], 'tiere': ['tiere'], 'hofladen': ['hofladen'], 'automat': ['automat', '24/7'], 'selbstbedienung': ['selbstbedienung'] }; Object.keys(map).forEach(tag => { map[tag].forEach(kw => { if (corpus.includes(kw)) tags.add(tag); }); }); if (data.tiere && !data.tiere.includes('Keine Tiere')) tags.add('tiere'); if (data.sitzplaetze === 'Ja') tags.add('sitzm√∂glichkeit'); return Array.from(tags).slice(0, 10); } // Max 10 Tags


</script>
</body>
</html>

