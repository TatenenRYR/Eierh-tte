<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eierh√ºtten Admin-Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.paypal.com/sdk/js?client-id=AbnXzFW_R-XwHEQCBVth0OY1zkq3Rl0Op-bqTcbmvAlbQqgh45zAWtkmuWiNp4dF7ijTW4vs90Ec7gyG&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .minimap { height: 200px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
    .progress-bar { width: 100%; background-color: #e5e7eb; border-radius: 0.5rem; margin-top: 5px; }
    .progress-fill { height: 8px; background-color: #10b981; border-radius: 0.5rem; width: 0%; transition: width 0.3s; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="notification"></div>

  <div id="login-section" class="flex items-center justify-center h-screen">
    <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded">
      Admin Login mit Google
    </button>
  </div>

  <div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    üë§ <span id="user-name">L√§dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîÑ
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üè†
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîì
    </button>
  </div>
</div>

  <div id="dashboard" class="hidden p-6 max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-green-700">ü•ö Eierh√ºtten Admin Dashboard</h1>

  <!-- Statistiken -->
  <div id="stats" class="mb-6 text-gray-700"></div>
<!-- Neue Eintragungen -->
<h2 class="text-2xl font-bold mt-10 mb-4 text-green-700">üÜï Neue Eintragungen</h2>
<div id="neueListe" class="space-y-2 bg-gray-50 p-4 rounded shadow">
  <!-- Wird durch renderNewEntries(list) gef√ºllt -->
</div>
  <!-- Suchfeld -->
<select id="sortSelect" class="mb-4 p-2 border rounded">
  <option value="name">üî§ Nach Name</option>
  <option value="createdAt">üïí Neueste zuerst</option>
</select>
    <input id="search-input" 
       type="text" 
       placeholder="üîç Suchen..." 
       class="mb-4 p-2 border rounded w-full">
  <!-- H√ºttenliste -->
  <div id="hut-list" class="space-y-4"></div>
<!-- Support-Tickets -->
<h2 class="text-2xl font-bold mt-10 mb-4 text-blue-800">üì® Support-Tickets</h2>
<div class="overflow-auto bg-white rounded shadow mb-10">
  <table class="min-w-full text-sm">
    <thead class="bg-blue-100 text-left">
      <tr>
        <th class="px-4 py-2">Datum</th>
        <th class="px-4 py-2">User</th>
        <th class="px-4 py-2">Nachricht</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Aktionen</th>
      </tr>
    </thead>
    <tbody id="support-tickets-body" class="divide-y divide-gray-200">
      <!-- Wird per JS bef√ºllt -->
    </tbody>
  </table>
</div>
    <!-- Pagination -->
  <div id="pagination" class="mt-4 flex flex-wrap justify-center gap-2"></div>

    
<form id="admin-hut-form" class="space-y-3">
  <label class="block">
    <span class="font-semibold">üè† H√ºttenname</span>
    <input type="text" id="admin-hut-name" class="w-full border px-3 py-2 rounded" required>
  </label>

  <div>
    <span class="font-semibold block mb-1">üìç Standort ausw√§hlen</span>
    <div id="admin-map" style="height: 300px; border-radius: 8px;"></div>
  </div>


  <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
    ‚ûï H√ºtte anlegen
  </button>
</form>
</div>


<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  const hutList = document.getElementById('hut-list');
  const searchInput = document.getElementById('search-input');
  const notification = document.getElementById('notification');
  const stats = document.getElementById('stats');
  let huts = [], currentUser = null;
let adminMarker;
let adminMap;
let adminLocation;

document.addEventListener('DOMContentLoaded', () => {
  // Leaflet-Karte initialisieren
  adminMap = L.map('admin-map').setView([51.1657, 10.4515], 6); // Mitte Deutschland
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap);

  // Startmarker
  adminMarker = L.marker([51.1657, 10.4515], { draggable: true }).addTo(adminMap);

  // Marker-Bewegung √ºberwachen
  adminMarker.on('dragend', e => {
    const pos = e.target.getLatLng();
    adminLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
  });

  // Standort automatisch setzen, falls verf√ºgbar
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    adminMap.setView([latitude, longitude], 13);
    adminMarker.setLatLng([latitude, longitude]);
    adminLocation = new firebase.firestore.GeoPoint(latitude, longitude);
  });
});

// Formular absenden
document.getElementById('admin-hut-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!adminLocation) {
    alert('‚ùå Bitte w√§hle einen Standort auf der Karte.');
    return;
  }

  editingData = {
    name: document.getElementById('admin-hut-name').value.trim(),
    location: adminLocation,
    fotos: []
  };

  const files = document.getElementById('admin-hut-images').files;
  if (files.length > 0) {
    addMessage(`‚è≥ Lade ${files.length} Bild(er) hoch...`, 'bot');
    const uploads = [];
    for (let file of files) {
      try {
        const img = await uploadToImgBB(file);
        uploads.push(img);
      } catch (err) {
        console.error('‚ùå Upload-Fehler:', err);
        addMessage('‚ùå Fehler beim Hochladen eines Bildes.', 'bot');
      }
    }
    editingData.fotos = uploads;
  }

  // Direkt speichern ohne PayPal
  submitNewHutAdmin();
});
async function submitNewHutAdmin() {
  if (!editingData.name || !editingData.location) {
    addMessage('‚ùå Bitte gib alle Daten ein (mindestens Name und Standort).', 'bot');
    return;
  }

  // üîí Nur g√ºltige Bilder √ºbernehmen
  const validFotos = (editingData.fotos || []).filter(f =>
    typeof f === 'object' && f.url && f.delete_url
  );

  const hut = {
    ...editingData,
    userId: currentUser.uid,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'angenommen',        // ‚úÖ Direkt freigeschaltet
    fotos: validFotos,
    aboMonate: null,             // Kein Abo
    paypalSubscriptionId: null,  // Kein PayPal
    datenschutzZustimmung: {
      best√§tigtAm: firebase.firestore.FieldValue.serverTimestamp(),
      durch: firebase.auth().currentUser?.email || "Admin"
    }
  };

  try {
    await db.collection('eierhuetten').add(hut);
    addMessage('‚úÖ H√ºtte ohne PayPal erfolgreich erstellt und freigeschaltet.', 'bot');
    step = 0;
    editingData = {};
    showMyHuts(); // Aktualisieren
  } catch (err) {
    addMessage('‚ùå Fehler beim Erstellen der H√ºtte: ' + err.message, 'bot');
  }
}

  
  function showNotification(message) {
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 4000);
  }

  document.getElementById('login-btn').onclick = () => {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  };

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      const adminDoc = await db.collection('admins').doc(user.email).get();
      if (!adminDoc.exists) {
        alert('Zugriff verweigert: Du bist kein Admin.');
        return;
      }
      loginSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      db.collection('eierhuetten').onSnapshot(() => {
        showNotification('üîÑ Live-Update: H√ºttendaten wurden aktualisiert.');
        loadHuts();
      });
      
        initLiveNewHuts();
    }
  });

  searchInput.addEventListener('input', () => {
  const term = searchInput.value.trim().toLowerCase();

  if (!term) {
    filteredHuts = []; // keine Filterung
  } else {
    filteredHuts = allHuts.filter(hut => {
      return [
        hut.name,
        hut.status,
        hut.paypalSubscriptionId,
        hut.strom,
        hut.sitzplaetze,
        hut.oeffnungszeiten
      ].some(field => (field || '').toLowerCase().includes(term));
    });
  }

  currentPage = 1;
  renderPage();
});

/*  async function loadHuts() {
    const snapshot = await db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get();
    huts = await Promise.all(snapshot.docs.map(async doc => {
      const data = doc.data();
      const logSnap = await db.collection('eierhuetten').doc(doc.id).collection('log').orderBy('zeitpunkt', 'desc').get();
      return {
        id: doc.id,
        ...data,
        logCount: logSnap.size,
        logs: logSnap.docs.map(d => d.data())
      };
    }));
    renderHuts(huts);
    renderStats(huts);
  }*/
  async function loadHuts() {
    const snapshot = await db.collection('eierhuetten').orderBy('name').get();
    allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    currentPage = 1;
    renderPage(currentPage);
  }

  function renderStats(list) {
    const total = list.length;
    const withStrom = list.filter(h => h.strom === 'Ja').length;
    const withFotos = list.filter(h => Array.isArray(h.fotos) && h.fotos.length > 0).length;
    const count247 = list.filter(h => h.oeffnungszeiten === '24/7').length;
    stats.innerHTML = `üî¢ <strong>${total}</strong> H√ºtten ¬∑ ‚ö° ${withStrom} mit Strom ¬∑ üñºÔ∏è ${withFotos} mit Fotos ¬∑ üïí ${count247} sind 24/7 ge√∂ffnet`;
  }

 async function approveFoto(hutId, index) {
  try {
    const ref = db.collection('eierhuetten').doc(hutId);
    const snap = await ref.get();
    const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];

    const f = fotos[index];
    if (!f || typeof f === 'string') {
      // Strings sind per Definition schon "freigegeben"
      showNotification('‚ÑπÔ∏è Dieses Foto ist bereits freigegeben.');
      return;
    }
    fotos[index] = { ...f, status: 'freigegeben' };

    await ref.update({ fotos });
    await ref.collection('log').add({
      admin: currentUser.displayName || currentUser.email,
      feld: 'fotos',
      wert: `Foto freigegeben: ${f.url}`,
      zeitpunkt: new Date()
    });
    showNotification('‚úÖ Bild freigegeben');
    loadHuts();
  } catch (err) {
    console.error(err);
    showNotification('‚ùå Fehler beim Freigeben.');
  }
}

async function rejectFoto(hutId, index) {
  try {
    const ref = db.collection('eierhuetten').doc(hutId);
    const snap = await ref.get();
    const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];

    const f = fotos[index];
    if (!f) return;

    // ggf. zuerst bei imgbb l√∂schen
    const deleteUrl = typeof f === 'object' ? f.delete_url : null;
    fotos.splice(index, 1);

    await ref.update({ fotos });
    await ref.collection('log').add({
      admin: currentUser.displayName || currentUser.email,
      feld: 'fotos',
      wert: `Foto abgelehnt/gel√∂scht: ${typeof f === 'string' ? f : f.url}`,
      zeitpunkt: new Date()
    });

    if (deleteUrl) {
      try { await fetch(deleteUrl); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
    }
    showNotification('üóëÔ∏è Bild entfernt');
    loadHuts();
  } catch (err) {
    console.error(err);
    showNotification('‚ùå Fehler beim Entfernen.');
  }
}

/*async function rejectFoto(hutId, index) {
  const doc = await db.collection('eierhuetten').doc(hutId).get();
  const fotos = doc.data().fotos || [];
  const { delete_url } = fotos[index];
  fotos.splice(index, 1);
  await db.collection('eierhuetten').doc(hutId).update({ fotos });

  if (delete_url) {
    fetch(delete_url)
      .then(() => showNotification('üóëÔ∏è Bild gel√∂scht'))
      .catch(e => console.warn('Fehler beim L√∂schen', e));
  }

  loadHuts();
}*/
  async function initImageUpload(input, hutId) {
  const files = Array.from(input.files);
  if (files.length === 0) return;

  showNotification(`‚è≥ Lade ${files.length} Bild(er) hoch...`);

  const uploadedObjects = [];

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const reader = new FileReader();

    const base64 = await new Promise((resolve, reject) => {
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
      reader.readAsDataURL(file);
    });

    try {
      const formData = new FormData();
      formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // imgbb API Key
      formData.append('image', base64);

      const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
      const json = await res.json();

      if (json?.data?.url) {
        uploadedObjects.push({
          url: json.data.url,
          delete_url: json.data.delete_url || null,
          status: 'wartet'
        });
      } else {
        console.warn('‚ùå Upload unvollst√§ndig:', json);
        showNotification(`‚ùå Fehler beim Hochladen von Bild ${i + 1}`);
      }
    } catch (err) {
      console.error(err);
      showNotification(`‚ùå Upload-Fehler: ${err}`);
    }
  }

  if (uploadedObjects.length > 0) {
    try {
      await db.collection('eierhuetten').doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(...uploadedObjects)
      });
      showNotification('‚úÖ Bilder hochgeladen (warten auf Freigabe).');
      loadHuts();
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Speichern der Bilder: ' + err.message);
    }
  }
}
 /* function updateField(hutId, field, value) {
    db.collection('eierhuetten').doc(hutId).update({ [field]: value });
    db.collection('eierhuetten').doc(hutId).collection('log').add({
      admin: currentUser.displayName || currentUser.email,
      feld: field,
      wert: value,
      zeitpunkt: new Date()
    });
    // Reaktion auf Status√§nderung f√ºr Abo-Verwaltung
  if (field === 'status') {
    const aboRef = db.collection('abos').doc(hutId);

    if (value === 'offen') {
      aboRef.update({
        status: 'paused',
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
      logHistory(hutId, 'Abo automatisch pausiert wegen Status "offen"');

    } else if (value === 'abgelehnt') {
      aboRef.update({
        status: 'cancelled',
        updated: firebase.firestore.FieldValue.serverTimestamp()
      });
      logHistory(hutId, 'Abo automatisch gek√ºndigt wegen Status "abgelehnt"');
    }
  }
  }*/
  

  /*function renderHuts(list) {
    hutList.innerHTML = '';
    list.forEach(hut => {
      const el = document.createElement('div');
      el.className = 'bg-white p-4 rounded shadow space-y-2';

      el.innerHTML = `
  <input class="text-xl font-bold w-full mb-2" value="${hut.name || ''}" onchange="updateField('${hut.id}', 'name', this.value)">

  <label>Status:
    <select onchange="updateField('${hut.id}', 'status', this.value)" class="w-full mb-2">
      ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===hut.status?'selected':''}>${s}</option>`).join('')}
    </select>
  </label>

  <label>√ñffnungszeiten:
    <select onchange="updateField('${hut.id}', 'oeffnungszeiten', this.value)" class="w-full mb-2">
      ${['08:00‚Äì20:00','24/7'].map(o => `<option ${o===hut.oeffnungszeiten?'selected':''}>${o}</option>`).join('')}
    </select>
  </label>

  <label>Strom:
    <select onchange="updateField('${hut.id}', 'strom', this.value)" class="w-full mb-2">
      ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
    </select>
  </label>

  <label>Sitzpl√§tze:
    <select onchange="updateField('${hut.id}', 'sitzplaetze', this.value)" class="w-full mb-2">
      ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
    </select>
  </label>

  <label>Fotos (freigegeben):</label>
  <div class="flex flex-wrap gap-2 mb-2" id="fotos-container-${hut.id}">
    ${Array.isArray(hut.fotos) ? hut.fotos.map((foto, i) => {
      const f = typeof foto === 'string' ? { url: foto, status: 'freigegeben' } : foto;
      if (f.status !== 'freigegeben') return '';
      return `
        <div class="relative w-24 h-24 rounded overflow-hidden border border-gray-300">
          <img src="${f.url}" alt="Foto" class="object-cover w-full h-full" />
          <button onclick="deleteFoto('${hut.id}', '${f.url}')" title="Foto l√∂schen" 
                  class="absolute top-0 right-0 bg-red-600 text-white rounded-bl px-1 text-sm font-bold hover:bg-red-700">√ó</button>
        </div>
      `;
    }).join('') : '<p class="text-gray-500">Keine Fotos</p>'}
  </div>

  ${Array.isArray(hut.fotos) && hut.fotos.some(f => typeof f !== 'string' && f.status === 'wartet') ? `
    <label>Fotos (warten auf Freigabe):</label>
    <div class="flex flex-wrap gap-2 mb-2">
      ${hut.fotos.map((f, i) => {
        if (typeof f === 'string' || f.status !== 'wartet') return '';
        return `
          <div class="relative w-24 h-24 rounded overflow-hidden border border-yellow-400 border-dashed">
            <img src="${f.url}" alt="wartet" class="object-cover w-full h-full opacity-50 grayscale" />
            <div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/50">
              ‚è≥ Wartet
              <button onclick="approveFoto('${hut.id}', ${i})" class="bg-green-600 mt-1 px-1 rounded">‚úî Freigeben</button>
              <button onclick="rejectFoto('${hut.id}', ${i})" class="bg-red-600 mt-1 px-1 rounded">‚úñ L√∂schen</button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  ` : ''}

 <label>Foto hochladen:
  <input type="file" accept="image/*" onchange="uploadFoto(this, '${hut.id}')">
  <div class="progress-bar"><div class="progress-fill" id="progress-${hut.id}"></div></div>
</label>


  <div class="minimap" id="map-${hut.id}"></div>

  <details>
    <summary>Bearbeitungs-Log (${hut.logCount})</summary>
    <ul class="text-xs max-h-48 overflow-auto">
      ${hut.logs.map(log => `<li><strong>${log.admin}</strong> hat <em>${log.feld}</em> auf <code>${log.wert}</code>${log.kommentar ? ` (Kommentar: ${log.kommentar})` : ''} ge√§ndert am ${new Date(log.zeitpunkt.seconds * 1000).toLocaleString()}</li>`).join('')}
    </ul>
  </details>

          <!-- Abo -->
        ${hut.aboStart && hut.paypalSubscriptionId ? `
          <details class="bg-blue-50 border border-blue-200 rounded p-2 my-2 text-sm">
            <summary class="cursor-pointer">üí≥ Abo-Informationen</summary>
            <div><strong>Start:</strong> ${hut.aboStart?.toDate?.().toLocaleDateString("de-DE") || '-'}</div>
            <div><strong>PayPal-ID:</strong> ${hut.paypalSubscriptionId}</div>
            <div><strong>Status:</strong> aktiv</div>
            ${Array.isArray(hut.aboHistory) && hut.aboHistory.length ? `
              <div class="mt-2"><strong>Zahlungsverlauf:</strong>
                <ul class="list-disc ml-5 text-xs">
                  ${hut.aboHistory.map(e => `
                    <li>${new Date(e.zeitpunkt?.seconds * 1000).toLocaleDateString("de-DE")} ‚Äì ${e.betrag}‚ÄØ‚Ç¨ via ${e.methode}</li>
                  `).join('')}
                </ul>
              </div>
            ` : '<div class="text-xs text-gray-500 mt-2 italic">Kein Verlauf vorhanden.</div>'}
          </details>
        ` : `
          <div class="my-2 text-sm">
            <strong>üí≥ Kein aktives Abo</strong><br>
            <div id="${paypalContainerId}" class="my-2"></div>
          </div>

        `}

  <button onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-2 py-1 rounded mt-3 w-full">H√ºtte l√∂schen</button>
`;

      hutList.appendChild(el);

      if (hut.location?.latitude && hut.location?.longitude) {
        const map = L.map(`map-${hut.id}`, {
          zoomControl: false,
          dragging: true,
          scrollWheelZoom: true,
          doubleClickZoom: true,
          boxZoom: true,
          keyboard: true
        }).setView([hut.location.latitude, hut.location.longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const marker = L.marker([hut.location.latitude, hut.location.longitude], { draggable: true }).addTo(map);

        marker.on('dragend', async (e) => {
          const newPos = e.target.getLatLng();
          const kommentar = prompt('Bitte Kommentar zur Standort√§nderung eingeben:');
          if (kommentar === null) {
            marker.setLatLng([hut.location.latitude, hut.location.longitude]);
            return;
          }
          await db.collection('eierhuetten').doc(hut.id).update({
            location: {
              latitude: newPos.lat,
              longitude: newPos.lng
            }
          });
          await db.collection('eierhuetten').doc(hut.id).collection('log').add({
            admin: currentUser.displayName || currentUser.email,
            feld: 'location',
            wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`,
            kommentar: kommentar,
            zeitpunkt: new Date()
          });
          showNotification(`üìç Standort von "${hut.name}" wurde aktualisiert.`);
        });
      }
    });
  }*/
  // √Ñnderung best√§tigen + speichern (ohne Abo-Verwaltung)
function updateField(hutId, field, value) {
  if (!confirm(`‚ö†Ô∏è Willst du wirklich das Feld "${field}" auf "${value}" √§ndern?`)) {
    return; // Abbrechen, wenn Admin nicht best√§tigt
  }

  db.collection('eierhuetten').doc(hutId).update({ [field]: value });
  db.collection('eierhuetten').doc(hutId).collection('log').add({
    admin: currentUser.displayName || currentUser.email,
    feld: field,
    wert: value,
    zeitpunkt: new Date()
  });
}

async function renderHuts(list) {
  hutList.innerHTML = '';

  for (const hut of list) {
    try {
      const el = document.createElement('div');
      el.className = 'bg-white p-4 rounded shadow space-y-2';
const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];
      // Logs laden
      let logs = [];
      try {
        const logSnap = await db.collection('eierhuetten')
          .doc(hut.id)
          .collection('log')
          .orderBy('zeitpunkt', 'desc')
          .limit(20)
          .get();
        logs = logSnap.docs.map(doc => doc.data());
      } catch (err) {
        console.error(`‚ùå Fehler beim Laden der Logs f√ºr H√ºtte ${hut.id}:`, err);
      }

      // Nachrichten laden
      let messagesHTML = '<p class="text-sm text-gray-500 italic">üí¨ Nachrichten deaktiviert.</p>';
      if (hut.allowMessages) {
        try {
          const msgSnap = await db.collection('hutMessages')
            .where('hutId', '==', hut.id)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();

          const normale = [];
          const archivierte = [];

          msgSnap.forEach(doc => {
            const m = doc.data();
            const datum = m.createdAt?.toDate().toLocaleString('de-DE') || '-';
            const msgHTML = `
              <div class="p-2 bg-white border rounded text-sm flex justify-between items-center">
                <div>
                  <div><strong>${m.senderName || 'Unbekannt'}</strong> ‚Äì ${datum}</div>
                  <div class="mt-1">${m.message || ''}</div>
                </div>
                <div class="space-x-2">
                  <button onclick="deleteMessage('${doc.id}')" 
                    class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button>
                  ${!m.archived ? `
                    <button onclick="archiveMessage('${doc.id}')" 
                      class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">üì¶</button>
                  ` : ''}
                </div>
              </div>
            `;
            if (m.archived) archivierte.push(msgHTML);
            else normale.push(msgHTML);
          });

          messagesHTML = `
            <div class="mt-4 p-2 bg-gray-50 border rounded">
              <strong>üí¨ Nachrichten</strong>
              <div class="mt-2 space-y-2 max-h-60 overflow-y-auto">
                ${normale.length ? normale.join('') : '<p class="text-gray-500">üì≠ Keine Nachrichten.</p>'}
              </div>
            </div>
            <div class="mt-4 p-2 bg-gray-100 border rounded">
              <strong>üì¶ Archivierte Nachrichten</strong>
              <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                ${archivierte.length ? archivierte.join('') : '<p class="text-gray-500">üì≠ Keine archivierten Nachrichten.</p>'}
              </div>
            </div>
          `;
        } catch (err) {
          console.error(`‚ùå Fehler beim Laden der Nachrichten f√ºr H√ºtte ${hut.id}:`, err);
          messagesHTML = '<p class="text-sm text-red-500">‚ùå Fehler beim Laden der Nachrichten.</p>';
        }
      }

      // Haupt-HTML
      el.innerHTML = `
        <input class="text-xl font-bold w-full mb-2" 
          value="${hut.name || ''}" 
          onchange="updateField('${hut.id}', 'name', this.value)">

        <!-- Status -->
        <label>Status:
          <select onchange="updateField('${hut.id}', 'status', this.value)" class="w-full mb-2">
            ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===hut.status?'selected':''}>${s}</option>`).join('')}
          </select>
        </label>

        <!-- Strom -->
        <label>Strom:
          <select onchange="updateField('${hut.id}', 'strom', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <!-- Sitzpl√§tze -->
        <label>Sitzpl√§tze:
          <select onchange="updateField('${hut.id}', 'sitzplaetze', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <div class="minimap" id="map-${hut.id}"></div>

<!-- Fotos (freigegeben) -->
<label>Fotos (freigegeben):</label>
<div class="flex flex-wrap gap-2 mb-2" id="fotos-container-${hut.id}">
  ${
    fotos.some(f => (typeof f !== 'string' && f.status === 'freigegeben') || typeof f === 'string')
      ? fotos.map((foto, i) => {
          const f = typeof foto === 'string' ? { url: foto, status: 'freigegeben' } : foto;
          if (f.status !== 'freigegeben') return '';
          return `
            <div class="relative w-24 h-24 rounded overflow-hidden border border-gray-300">
              <img src="${f.url}" alt="Foto" class="object-cover w-full h-full" />
              <button onclick="deleteFoto('${hut.id}', ${i})" title="Foto l√∂schen" 
                      class="absolute top-0 right-0 bg-red-600 text-white rounded-bl px-1 text-sm font-bold hover:bg-red-700">√ó</button>
            </div>`;
        }).join('')
      : '<p class="text-gray-500">Keine Fotos</p>'
  }
</div>

<!-- Fotos (warten auf Freigabe) -->
${
  fotos.some(f => typeof f === 'object' && f.status === 'wartet') ? `
    <label>Fotos (warten auf Freigabe):</label>
    <div class="flex flex-wrap gap-2 mb-2">
      ${fotos.map((f, i) => {
        if (typeof f === 'string' || f.status !== 'wartet') return '';
        return `
          <div class="relative w-24 h-24 rounded overflow-hidden border border-yellow-400 border-dashed">
            <img src="${f.url}" alt="wartet" class="object-cover w-full h-full opacity-50 grayscale" />
            <div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/50">
              ‚è≥ Wartet
              <button onclick="approveFoto('${hut.id}', ${i})" class="bg-green-600 mt-1 px-1 rounded">‚úî Freigeben</button>
              <button onclick="rejectFoto('${hut.id}', ${i})" class="bg-red-600 mt-1 px-1 rounded">‚úñ L√∂schen</button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  ` : ''
}
<!-- Upload -->
<label class="block mt-2 text-sm">üì∑ Neues Bild:
  <input type="file" accept="image/*" onchange="initImageUpload(this, '${hut.id}')" class="upload-image mt-1" />
</label>
<div id="progress-${hut.id}" class="h-2 bg-gray-200 rounded hidden mt-2">
  <div class="h-2 bg-green-500 rounded" style="width: 0%"></div>
</div>
        <!-- Chat erlauben -->
        <label>Chat:
          <select onchange="updateField('${hut.id}', 'allowMessages', this.value)" class="w-full mb-2">
            <option value="true" ${hut.allowMessages ? 'selected' : ''}>‚úÖ Aktiv</option>
            <option value="false" ${!hut.allowMessages ? 'selected' : ''}>‚ùå Deaktiv</option>
          </select>
        </label>

        <!-- Nachrichtenbereich -->
        ${messagesHTML}

        <!-- Logs -->
        <details class="mt-3">
          <summary>Bearbeitungs-Log (${logs.length})</summary>
          <ul class="text-xs max-h-48 overflow-auto">
            ${logs.map(log => `
              <li><strong>${log.admin}</strong> √§nderte <em>${log.feld}</em> 
              auf <code>${log.wert}</code> 
              am ${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</li>
            `).join('')}
          </ul>
        </details>

        <button onclick="deleteHut('${hut.id}')" 
          class="bg-red-600 text-white px-2 py-1 rounded mt-3 w-full">H√ºtte l√∂schen</button>
      `;

      hutList.appendChild(el);

      // Karte anzeigen
      if (hut.location?.latitude && hut.location?.longitude) {
        const map = L.map(`map-${hut.id}`, {
          zoomControl: false,
          dragging: true,
          scrollWheelZoom: true,
          doubleClickZoom: true,
          boxZoom: true,
          keyboard: true
        }).setView([hut.location.latitude, hut.location.longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const marker = L.marker([hut.location.latitude, hut.location.longitude], { draggable: true }).addTo(map);

        // invalidateSize fix, falls Container versteckt war
        setTimeout(() => map.invalidateSize(), 200);

        marker.on('dragend', async (e) => {
          const newPos = e.target.getLatLng();
          const kommentar = prompt('Bitte Kommentar zur Standort√§nderung eingeben:');
          if (kommentar === null) {
            marker.setLatLng([hut.location.latitude, hut.location.longitude]);
            return;
          }
          await db.collection('eierhuetten').doc(hut.id).update({
            location: { latitude: newPos.lat, longitude: newPos.lng }
          });
          await db.collection('eierhuetten').doc(hut.id).collection('log').add({
            admin: currentUser.displayName || currentUser.email,
            feld: 'location',
            wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`,
            kommentar: kommentar,
            zeitpunkt: new Date()
          });
          showNotification(`üìç Standort von "${hut.name}" wurde aktualisiert.`);
        });
      }

    } catch (err) {
      console.warn(`‚ùå H√ºtte konnte nicht gerendert werden: ${hut?.id || 'unbekannt'}`, err);
      const fallback = document.createElement('div');
      fallback.className = 'bg-red-100 text-red-800 p-2 rounded mb-2';
      fallback.textContent = `‚ö†Ô∏è H√ºtte konnte nicht geladen werden (ID: ${hut?.id || 'unbekannt'})`;
      hutList.appendChild(fallback);
    }
  }
}
 /* async function renderHuts(list) {
  hutList.innerHTML = '';

  for (const hut of list) {
    try {
      const el = document.createElement('div');
      el.className = 'bg-white p-4 rounded shadow space-y-2';

      const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];

      // Logs laden mit try/catch
      let logs = [];
      try {
        const logSnap = await db.collection('eierhuetten')
          .doc(hut.id)
          .collection('log')
          .orderBy('zeitpunkt', 'desc')
          .limit(20)
          .get();
        logs = logSnap.docs.map(doc => doc.data());
      } catch (err) {
        console.error(`‚ùå Fehler beim Laden der Logs f√ºr H√ºtte ${hut.id}:`, err);
      }

      // Nachrichten laden mit try/catch
      let messagesHTML = '<p class="text-sm text-gray-500 italic">üí¨ Nachrichten deaktiviert.</p>';
      if (hut.allowMessages) {
        try {
          const msgSnap = await db.collection('hutMessages')
            .where('hutId', '==', hut.id)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();

          const normale = [];
          const archivierte = [];

          msgSnap.forEach(doc => {
            const m = doc.data();
            const datum = m.createdAt?.toDate().toLocaleString('de-DE') || '-';
            const msgHTML = `
              <div class="p-2 bg-white border rounded text-sm flex justify-between items-center">
                <div>
                  <div><strong>${m.senderName || 'Unbekannt'}</strong> ‚Äì ${datum}</div>
                  <div class="mt-1">${m.message || ''}</div>
                </div>
                <div class="space-x-2">
                  <button onclick="deleteMessage('${doc.id}')" 
                    class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button>
                  ${!m.archived ? `
                    <button onclick="archiveMessage('${doc.id}')" 
                      class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">üì¶</button>
                  ` : ''}
                </div>
              </div>
            `;
            if (m.archived) archivierte.push(msgHTML);
            else normale.push(msgHTML);
          });

          messagesHTML = `
            <div class="mt-4 p-2 bg-gray-50 border rounded">
              <strong>üí¨ Nachrichten</strong>
              <div class="mt-2 space-y-2 max-h-60 overflow-y-auto">
                ${normale.length ? normale.join('') : '<p class="text-gray-500">üì≠ Keine Nachrichten.</p>'}
              </div>
            </div>
            <div class="mt-4 p-2 bg-gray-100 border rounded">
              <strong>üì¶ Archivierte Nachrichten</strong>
              <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                ${archivierte.length ? archivierte.join('') : '<p class="text-gray-500">üì≠ Keine archivierten Nachrichten.</p>'}
              </div>
            </div>
          `;
        } catch (err) {
          console.error(`‚ùå Fehler beim Laden der Nachrichten f√ºr H√ºtte ${hut.id}:`, err);
          messagesHTML = '<p class="text-sm text-red-500">‚ùå Fehler beim Laden der Nachrichten.</p>';
        }
      }

      // Haupt-HTML f√ºr H√ºtte
      el.innerHTML = `
        <input class="text-xl font-bold w-full mb-2" 
          value="${hut.name || ''}" 
          onchange="updateField('${hut.id}', 'name', this.value)">

        <!-- Status -->
        <label>Status:
          <select onchange="updateField('${hut.id}', 'status', this.value)" class="w-full mb-2">
            ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===hut.status?'selected':''}>${s}</option>`).join('')}
          </select>
        </label>

        <!-- Strom -->
        <label>Strom:
          <select onchange="updateField('${hut.id}', 'strom', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <!-- Sitzpl√§tze -->
        <label>Sitzpl√§tze:
          <select onchange="updateField('${hut.id}', 'sitzplaetze', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>
<div class="minimap" id="map-${hut.id}"></div>

        <!-- Nachrichtenbereich -->
        ${messagesHTML}

        <!-- Logs -->
        <details class="mt-3">
          <summary>Bearbeitungs-Log (${logs.length})</summary>
          <ul class="text-xs max-h-48 overflow-auto">
            ${logs.map(log => `
              <li><strong>${log.admin}</strong> √§nderte <em>${log.feld}</em> 
              auf <code>${log.wert}</code> 
              am ${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</li>
            `).join('')}
          </ul>
        </details>

        <button onclick="deleteHut('${hut.id}')" 
          class="bg-red-600 text-white px-2 py-1 rounded mt-3 w-full">H√ºtte l√∂schen</button>
      `;

      hutList.appendChild(el);

      if (hut.location?.latitude && hut.location?.longitude) {
        const map = L.map(`map-${hut.id}`, {
          zoomControl: false,
          dragging: true,
          scrollWheelZoom: true,
          doubleClickZoom: true,
          boxZoom: true,
          keyboard: true
        }).setView([hut.location.latitude, hut.location.longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const marker = L.marker([hut.location.latitude, hut.location.longitude], { draggable: true }).addTo(map);

        marker.on('dragend', async (e) => {
          const newPos = e.target.getLatLng();
          const kommentar = prompt('Bitte Kommentar zur Standort√§nderung eingeben:');
          if (kommentar === null) {
            marker.setLatLng([hut.location.latitude, hut.location.longitude]);
            return;
          }
          await db.collection('eierhuetten').doc(hut.id).update({
            location: {
              latitude: newPos.lat,
              longitude: newPos.lng
            }
          });
          await db.collection('eierhuetten').doc(hut.id).collection('log').add({
            admin: currentUser.displayName || currentUser.email,
            feld: 'location',
            wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`,
            kommentar: kommentar,
            zeitpunkt: new Date()
          });
          showNotification(`üìç Standort von "${hut.name}" wurde aktualisiert.`);
        });
      }

    } catch (err) {
      console.warn(`‚ùå H√ºtte konnte nicht gerendert werden: ${hut?.id || 'unbekannt'}`, err);
      const fallback = document.createElement('div');
      fallback.className = 'bg-red-100 text-red-800 p-2 rounded mb-2';
      fallback.textContent = `‚ö†Ô∏è H√ºtte konnte nicht geladen werden (ID: ${hut?.id || 'unbekannt'})`;
      hutList.appendChild(fallback);
    }
  }
}*/

// Hilfsfunktionen
async function deleteMessage(id) {
  try {
    await db.collection("hutMessages").doc(id).delete();
    alert("üóëÔ∏è Nachricht gel√∂scht");
    location.reload();
  } catch (err) {
    console.error("‚ùå Fehler beim L√∂schen:", err);
  }
}

async function archiveMessage(id) {
  try {
    await db.collection("hutMessages").doc(id).update({ archived: true });
    alert("üì¶ Nachricht archiviert");
    location.reload();
  } catch (err) {
    console.error("‚ùå Fehler beim Archivieren:", err);
  }
}
 /* function renderHuts(list) {
  hutList.innerHTML = '';
  list.forEach(hut => {
    try {
      const el = document.createElement('div');
      el.className = 'bg-white p-4 rounded shadow space-y-2';

      const logs = Array.isArray(hut.logs) ? hut.logs : [];
      const aboHistory = Array.isArray(hut.aboHistory) ? hut.aboHistory : [];
      const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];

      const paypalContainerId = `paypal-${hut.id}`;

      el.innerHTML = `
        <input class="text-xl font-bold w-full mb-2" value="${hut.name || ''}" onchange="updateField('${hut.id}', 'name', this.value)">

        <!-- Status -->
        <label>Status:
          <select onchange="updateField('${hut.id}', 'status', this.value)" class="w-full mb-2">
            ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===hut.status?'selected':''}>${s}</option>`).join('')}
          </select>
        </label>

        <!-- √ñffnungszeiten -->
        <label>√ñffnungszeiten:
          <select onchange="updateField('${hut.id}', 'oeffnungszeiten', this.value)" class="w-full mb-2">
            ${['08:00‚Äì20:00','24/7'].map(o => `<option ${o===hut.oeffnungszeiten?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <!-- Strom & Sitzpl√§tze -->
        <label>Strom:
          <select onchange="updateField('${hut.id}', 'strom', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <label>Sitzpl√§tze:
          <select onchange="updateField('${hut.id}', 'sitzplaetze', this.value)" class="w-full mb-2">
            ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
          </select>
        </label>

        <!-- Fotos -->
        <label>Fotos (freigegeben):</label>
        <div class="flex flex-wrap gap-2 mb-2" id="fotos-container-${hut.id}">
          ${
            fotos.some(f => (typeof f !== 'string' && f.status === 'freigegeben') || typeof f === 'string')
              ? fotos.map((foto, i) => {
                  const f = typeof foto === 'string' ? { url: foto, status: 'freigegeben' } : foto;
                  if (f.status !== 'freigegeben') return '';
                  return `
                    <div class="relative w-24 h-24 rounded overflow-hidden border border-gray-300">
                      <img src="${f.url}" alt="Foto" class="object-cover w-full h-full" />
                      <button onclick="deleteFoto('${hut.id}', '${f.url}')" title="Foto l√∂schen" 
                              class="absolute top-0 right-0 bg-red-600 text-white rounded-bl px-1 text-sm font-bold hover:bg-red-700">√ó</button>
                    </div>`;
                }).join('')
              : '<p class="text-gray-500">Keine Fotos</p>'
          }
        </div>

        <!-- Fotos in Warteschlange -->
        ${
          fotos.some(f => typeof f === 'object' && f.status === 'wartet') ? `
            <label>Fotos (warten auf Freigabe):</label>
            <div class="flex flex-wrap gap-2 mb-2">
              ${fotos.map((f, i) => {
                if (typeof f === 'string' || f.status !== 'wartet') return '';
                return `
                  <div class="relative w-24 h-24 rounded overflow-hidden border border-yellow-400 border-dashed">
                    <img src="${f.url}" alt="wartet" class="object-cover w-full h-full opacity-50 grayscale" />
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/50">
                      ‚è≥ Wartet
                      <button onclick="approveFoto('${hut.id}', ${i})" class="bg-green-600 mt-1 px-1 rounded">‚úî Freigeben</button>
                      <button onclick="rejectFoto('${hut.id}', ${i})" class="bg-red-600 mt-1 px-1 rounded">‚úñ L√∂schen</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : ''
        }
<!-- Upload -->
        <!-- Upload -->
        <label class="block mt-2 text-sm">üì∑ Neues Bild:
          <input type="file" accept="image/*" onchange="initImageUpload(this, '${hut.id}')" class="upload-image mt-1" />
        </label>
        <div id="progress-${hut.id}" class="h-2 bg-gray-200 rounded hidden mt-2">
          <div class="h-2 bg-green-500 rounded" style="width: 0%"></div>
        </div>

        <!-- Minimap -->
        <div class="minimap" id="map-${hut.id}"></div>

        <!-- Logs -->
        <details>
          <summary>Bearbeitungs-Log (${logs.length})</summary>
          <ul class="text-xs max-h-48 overflow-auto">
            ${logs.map(log => `
              <li><strong>${log.admin}</strong> hat <em>${log.feld}</em> auf <code>${log.wert}</code>${log.kommentar ? ` (Kommentar: ${log.kommentar})` : ''} ge√§ndert am ${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</li>
            `).join('')}
          </ul>
        </details>

        <!-- Nachrichtenbereich -->
${hut.allowMessages ? `
  <div class="mt-4 p-2 bg-gray-50 border rounded">
    <strong>üí¨ Nachrichten</strong>
    <div id="chat-messages-${hut.id}" class="mt-2 space-y-2 max-h-60 overflow-y-auto">‚è≥ L√§dt...</div>
  </div>
` : `
  <div class="mt-4 text-sm text-gray-500 italic">
    üí¨ Nachrichten sind f√ºr diese H√ºtte deaktiviert.
  </div>
`}

        <button onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-2 py-1 rounded mt-3 w-full">H√ºtte l√∂schen</button>
      `;

      hutList.appendChild(el);
if (hut.allowMessages) ladeNachrichten(hut.id);
      // Minimap
      if (hut.location?.latitude && hut.location?.longitude) {
        const map = L.map(`map-${hut.id}`, {
          zoomControl: false,
          dragging: true,
          scrollWheelZoom: true,
          doubleClickZoom: true,
          boxZoom: true,
          keyboard: true
        }).setView([hut.location.latitude, hut.location.longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const marker = L.marker([hut.location.latitude, hut.location.longitude], { draggable: true }).addTo(map);

        marker.on('dragend', async (e) => {
          const newPos = e.target.getLatLng();
          const kommentar = prompt('Bitte Kommentar zur Standort√§nderung eingeben:');
          if (kommentar === null) {
            marker.setLatLng([hut.location.latitude, hut.location.longitude]);
            return;
          }
          await db.collection('eierhuetten').doc(hut.id).update({
            location: {
              latitude: newPos.lat,
              longitude: newPos.lng
            }
          });
          await db.collection('eierhuetten').doc(hut.id).collection('log').add({
            admin: currentUser.displayName || currentUser.email,
            feld: 'location',
            wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`,
            kommentar,
            zeitpunkt: new Date()
          });
          showNotification(`üìç Standort von "${hut.name}" wurde aktualisiert.`);
        });
      }
    } catch (err) {
      console.warn(`‚ùå H√ºtte konnte nicht gerendert werden: ${hut?.id || 'unbekannt'}`, err);
      const fallback = document.createElement('div');
      fallback.className = 'bg-red-100 text-red-800 p-2 rounded mb-2';
      fallback.textContent = `‚ö†Ô∏è H√ºtte konnte nicht geladen werden (ID: ${hut?.id || 'unbekannt'})`;
      hutList.appendChild(fallback);
    }
  });
  }*/
  let allHuts = [];
let filteredHuts = [];
let currentPage = 1;
const hutsPerPage = 15;

function renderPage(page) {
  const start = (page - 1) * hutsPerPage;
  const end = start + hutsPerPage;
  const source = filteredHuts.length ? filteredHuts : allHuts;
  const hutsToRender = source.slice(start, end); // <--- Fix hier!

  renderHuts(hutsToRender);
  renderPagination(source.length); // <--- √úbergeben der tats√§chlichen Anzahl
}
function renderPagination(totalItems) {
  const totalPages = Math.ceil(totalItems / hutsPerPage);
  const paginationContainer = document.getElementById('pagination');

  paginationContainer.innerHTML = '';

  if (totalPages <= 1) return;

  const createPageBtn = (label, pageNum) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.disabled = pageNum === currentPage;
    btn.className = 'px-2 py-1 border rounded mx-1';
    btn.onclick = () => {
      currentPage = pageNum;
      renderPage(currentPage);
    };
    return btn;
  };

  for (let i = 1; i <= totalPages; i++) {
    paginationContainer.appendChild(createPageBtn(i, i));
  }
}

  function applySearchAndSort() {
  const search = document.getElementById("search-input")?.value.toLowerCase() || "";
  const sortBy = document.getElementById("sortSelect")?.value || "name";

  // filtern nach Name, Status, Strom, Sitzpl√§tzen
  filteredHuts = allHuts.filter(hut => {
    const name = hut.name?.toLowerCase() || "";
    const status = hut.status?.toLowerCase() || "";
    const strom = hut.strom?.toLowerCase() || "";
    const sitz = hut.sitzplaetze?.toLowerCase() || "";
    return (
      name.includes(search) ||
      status.includes(search) ||
      strom.includes(search) ||
      sitz.includes(search)
    );
  });

  // sortieren
  filteredHuts.sort((a, b) => {
    if (sortBy === "name") return (a.name || "").localeCompare(b.name || "");
    if (sortBy === "createdAt") return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
    return 0;
  });

  // neu rendern
  currentPage = 1;
  renderPage(currentPage);

  // Statistiken aktualisieren
  const source = filteredHuts.length ? filteredHuts : allHuts;
  renderStats(source);
  }
// Upload-Funktion:
/*async function initImageUpload(input, hutId) {
  const files = Array.from(input.files);
  if (files.length === 0) return;

  showNotification(`‚è≥ Lade ${files.length} Bild(er) hoch...`);

  const uploadedUrls = [];

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const reader = new FileReader();

    const base64 = await new Promise((resolve, reject) => {
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
      reader.readAsDataURL(file);
    });

    try {
      const formData = new FormData();
      formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // dein imgbb Key
      formData.append('image', base64);

      const res = await fetch('https://api.imgbb.com/1/upload', {
        method: 'POST',
        body: formData
      });

      const json = await res.json();

      if (json?.data?.url) {
        uploadedUrls.push(json.data.url);
      } else {
        console.warn('‚ùå Upload war unvollst√§ndig oder fehlerhaft:', json);
        showNotification(`‚ùå Fehler beim Hochladen von Bild ${i + 1}`);
      }
    } catch (err) {
      console.error(err);
      showNotification(`‚ùå Upload-Fehler: ${err}`);
    }
  }

  if (uploadedUrls.length > 0) {
    try {
      // URLs als Strings zu Firestore hinzuf√ºgen
      await db.collection('eierhuetten').doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(...uploadedUrls)
      });
      showNotification('‚úÖ Bilder wurden erfolgreich hochgeladen.');
      loadHuts(); // falls du die Liste neu laden willst
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Speichern der Bilder in der Datenbank: ' + err.message);
    }
  }
}*/

// Beispiel Upload-Funktion aus HTML
function uploadFoto(input, hutId) {
  initImageUpload(input, hutId)
    .then(uploads => {
      // Hier kannst du die Uploads weiterverarbeiten, falls n√∂tig
      console.log('Uploads:', uploads);
    });
}


// Diese Funktion rufst du im HTML-Attribut onchange auf
/*function uploadFoto(input, hutId) {
  initImageUpload(input, hutId);
}
*/
  /*async function uploadFoto(input, hutId) {
    const file = input.files[0];
    if (!file) return;
    const ref = storage.ref(`fotos/${hutId}/${Date.now()}_${file.name}`);
    const task = ref.put(file);
    task.on('state_changed', snapshot => {
      const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      document.getElementById(`progress-${hutId}`).style.width = `${percent}%`;
    },
    err => alert('Upload fehlgeschlagen: ' + err.message),
    async () => {
      const url = await task.snapshot.ref.getDownloadURL();
      await db.collection('eierhuetten').doc(hutId).update({
        fotos: firebase.firestore.FieldValue.arrayUnion(url)
      });
      updateField(hutId, 'fotos', url);
      showNotification('üì∏ Foto erfolgreich hochgeladen.');
      document.getElementById(`progress-${hutId}`).style.width = `0%`;
      loadHuts();
    });
  }*/

  async function deleteFoto(hutId, index) {
  // kleine Rechen-Sicherheitsabfrage
  const a = Math.floor(Math.random() * 10) + 1;
  const b = Math.floor(Math.random() * 10) + 1;
  const answer = a + b;

  const userAnswer = prompt(`Bitte rechne zur Best√§tigung: ${a} + ${b} = ?`);
  if (userAnswer === null) return;
  if (parseInt(userAnswer) !== answer) {
    alert('Falsche Antwort. Foto wird nicht gel√∂scht.');
    return;
  }
  if (!confirm('Foto wirklich l√∂schen?')) return;

  try {
    const ref = db.collection('eierhuetten').doc(hutId);
    const snap = await ref.get();
    const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
    const f = fotos[index];
    if (!f) return;

    const url = typeof f === 'string' ? f : f.url;
    const deleteUrl = typeof f === 'object' ? f.delete_url : null;

    fotos.splice(index, 1);
    await ref.update({ fotos });

    await ref.collection('log').add({
      admin: currentUser.displayName || currentUser.email,
      feld: 'fotos',
      wert: `Foto gel√∂scht: ${url}`,
      zeitpunkt: new Date()
    });

    if (deleteUrl) {
      try { await fetch(deleteUrl); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
    }

    showNotification('Foto wurde gel√∂scht.');
    loadHuts();
  } catch (e) {
    alert('Fehler beim L√∂schen des Fotos: ' + e.message);
  }
}

  async function deleteHut(id) {
  if (!confirm('M√∂chtest du diese H√ºtte wirklich l√∂schen?')) return;

  db.collection('eierhuetten').doc(id).get().then(doc => {
    if (!doc.exists) {
      showNotification('‚ùå H√ºtte nicht gefunden.', 'bot');
      return;
    }

    const hut = doc.data();

    // Pr√ºfen, ob Abo existiert
    if (hut.paypalSubscriptionId) {
      showNotification('üîÑ K√ºndige PayPal-Abo...', 'bot');
      console.log('‚û°Ô∏è Sende Abo-K√ºndigung f√ºr:', hut.paypalSubscriptionId);

      fetch('https://us-central1-eierhuettentour.cloudfunctions.net/cancelPaypalSubscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriptionId: hut.paypalSubscriptionId })
      })
      .then(async response => {
        if (!response.ok) {
          let errorText = await response.text();
          try {
            const errorJson = JSON.parse(errorText);
            throw new Error(errorJson.error || 'Unbekannter Fehler bei K√ºndigung');
          } catch {
            throw new Error(errorText);
          }
        }

        const result = await response.json();
        if (result.success) {
          showNotification('‚úÖ Abo erfolgreich gek√ºndigt.', 'bot');
          console.log('‚úÖ K√ºndigung erfolgreich');

          // Danach H√ºtte l√∂schen
          db.collection('eierhuetten').doc(id).delete().then(() => {
            showNotification('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
            korrigiereFehlendeAbos().then(() => showMyHuts());
          });
        } else {
          console.error('‚ùå Fehler bei K√ºndigung:', result.error || result);
          if (confirm(`‚ö†Ô∏è Das PayPal-Abo konnte nicht automatisch gek√ºndigt werden.\nM√∂chtest du die H√ºtte trotzdem l√∂schen?`)) {
            db.collection('eierhuetten').doc(id).delete().then(() => {
              showNotification('üóëÔ∏è H√ºtte gel√∂scht (Abo evtl. noch aktiv).', 'bot');
              loadHuts();
            });
          } else {
            showNotification('üö´ L√∂schvorgang abgebrochen.', 'bot');
          }
        }
      })
      .catch(err => {
        console.error('‚ùå Fehler bei K√ºndigung:', err.message || err);
        if (confirm(`‚ö†Ô∏è Fehler bei der PayPal-K√ºndigung: ${err.message || 'Unbekannt'}\nM√∂chtest du die H√ºtte trotzdem l√∂schen?`)) {
          db.collection('eierhuetten').doc(id).delete().then(() => {
            showNotification('üóëÔ∏è H√ºtte gel√∂scht (Abo evtl. noch aktiv).', 'bot');
            loadHuts();
          });
        } else {
          showNotification('üö´ L√∂schvorgang abgebrochen.', 'bot');
        }
      });

    } else {
      // Kein Abo ‚Üí direkt l√∂schen
      db.collection('eierhuetten').doc(id).delete().then(() => {
        showNotification('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
        loadHuts();
      });
    }
  }).catch(err => {
    console.error('‚ùå Fehler beim Abrufen der H√ºtte:', err.message || err);
    showNotification('‚ùå Fehler beim L√∂schen der H√ºtte.', 'bot');
  });
}
// Live-Update f√ºr neue H√ºtten
function initLiveNewHuts() {
  db.collection('eierhuetten')
    .where('status', '==', 'offen')
    .onSnapshot(snapshot => {
      const neue = [];
      snapshot.forEach(doc => {
        neue.push({ id: doc.id, ...doc.data() });
      });
      renderNewEntries(neue);
      showNotification('üîÑ Live-Update: Neue Eintragungen wurden aktuallisiert.');
    }, err => {
      console.error("‚ùå Fehler beim Live-Update der neuen H√ºtten:", err);
    });
}

function renderNewEntries(list) {
  const neueListe = document.getElementById("neueListe");
  const neue = list.filter(h => h.status === "offen");
  if (neue.length === 0) {
    neueListe.innerHTML = "<p class='italic text-gray-500'>Keine neuen Eintragungen.</p>";
    return;
  }

  neueListe.innerHTML = "";
  neue.forEach(hut => {
    const row = document.createElement("div");
    row.className = "flex justify-between items-center bg-white shadow rounded px-3 py-2";
    row.innerHTML = `
      <a href="#hut-${hut.id}" class="text-blue-600 hover:underline font-medium">${hut.name}</a>
      <div class="space-x-2">
        <button onclick="updateField('${hut.id}', 'status', 'angenommen')" class="px-2 py-1 bg-green-500 text-white rounded">Annehmen</button>
        <button onclick="updateField('${hut.id}', 'status', 'abgelehnt')" class="px-2 py-1 bg-red-500 text-white rounded">Ablehnen</button>
      </div>
    `;
    neueListe.appendChild(row);
  });
}
   // Warten bis DOM geladen ist
  document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
      const nameEl = document.getElementById('user-name');
      const topbar = document.getElementById('topbar');
document.getElementById("search-input").addEventListener("input", applySearchAndSort);
  document.getElementById("sortSelect").addEventListener("change", applySearchAndSort);

      if (user) {
        // Eingeloggt ‚Üí Zeige Topbar
        nameEl.textContent = user.displayName || user.email || 'Unbekannt';
        topbar.style.display = 'flex';
        ladeSupportTickets(); // ‚¨ÖÔ∏è Support-Anfragen laden
        
      } else {
        // Nicht eingeloggt ‚Üí Weiterleiten
        //window.location.href = 'login.html'; // oder deine Login-Seite
      }
    });
  });
  
function logout() {
  firebase.auth().signOut().then(() => {
    location.reload(); // Seite neu laden nach Logout
  }).catch(error => {
    alert('Fehler beim Abmelden: ' + error.message);
  });
}
function goToMainPage() {
  window.location.href = '/'; // Passe ggf. die URL an (z.‚ÄØB. '/index.html')
}
function refresh() {
 location.reload(); // ‚¨ÖÔ∏è Das l√§dt die gesamte Seite neu
}
async function ladeSupportTickets() {
  const snapshot = await db.collection('supportTickets').orderBy('createdAt', 'desc').get();
  const body = document.getElementById('support-tickets-body');
  body.innerHTML = '';

  snapshot.forEach(doc => {
    const ticket = doc.data();
    const id = doc.id;
    const datum = ticket.createdAt?.toDate().toLocaleString('de-DE') || '-';
    const email = ticket.email || '-';
    const status = ticket.status || 'offen';
    const message = ticket.message || '(keine Nachricht)';

    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-4 py-2 text-xs text-gray-600">${datum}</td>
      <td class="px-4 py-2 text-xs">${email}</td>
      <td class="px-4 py-2 text-sm">${message}</td>
      <td class="px-4 py-2">
        <select onchange="updateSupportStatus('${id}', this.value)" class="border rounded px-2 py-1 text-sm">
          ${['offen', 'bearbeitet', 'archiviert'].map(opt => `
            <option value="${opt}" ${opt === status ? 'selected' : ''}>${opt}</option>
          `).join('')}
        </select>
      </td>
      <td class="px-4 py-2 space-x-2">
        <button onclick="mailtoSupport('${email}', \`${message.replace(/`/g, "'")}\`)" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">Antworten</button>
        <button onclick="loescheSupportTicket('${id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">L√∂schen</button>
      </td>
    `;
    body.appendChild(row);
  });
}

  function mailtoSupport(email, message) {
  const subject = 'Supportanfrage zu Eierh√ºtten-Tour';
  const body = `Hallo,\n\nzu deiner Supportanfrage:\n\n"${message}"\n\nAntwort:\n\n[Hier deine Antwort einf√ºgen]`;
  window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
}

async function updateSupportStatus(id, neuerStatus) {
  await db.collection('supportTickets').doc(id).update({ status: neuerStatus });
  showNotification('‚úÖ Status aktualisiert');
}

async function loescheSupportTicket(id) {
  if (!confirm('Dieses Support-Ticket wirklich l√∂schen?')) return;
  await db.collection('supportTickets').doc(id).delete();
  showNotification('üóëÔ∏è Support-Ticket gel√∂scht');
  ladeSupportTickets();
}
 /* async function ladeSupportAnfragen() {
  const snapshot = await db.collection('supportTickets').orderBy('zeitpunkt', 'desc').limit(100).get();
  const body = document.getElementById('support-body');
  body.innerHTML = ''; // Tabelle leeren

  snapshot.forEach(doc => {
    const anfrage = doc.data();
    const zeile = document.createElement('tr');

    zeile.innerHTML = `
      <td class="px-4 py-2 text-xs text-gray-600">${anfrage.zeitpunkt?.toDate().toLocaleString('de-DE') || '-'}</td>
      <td class="px-4 py-2">${anfrage.nachricht || '(leer)'}</td>
      <td class="px-4 py-2">${anfrage.status || 'offen'}</td>
      <td class="px-4 py-2 space-x-2">
        <button onclick="archiviereSupport('${doc.id}')" class="text-sm bg-green-600 text-white px-2 py-1 rounded">Archivieren</button>
        <button onclick="loescheSupport('${doc.id}')" class="text-sm bg-red-600 text-white px-2 py-1 rounded">L√∂schen</button>
      </td>
    `;

    body.appendChild(zeile);
  });
  }
  async function archiviereSupport(id) {
  await db.collection('supportTickets').doc(id).update({ status: 'archiviert' });
  showNotification('üìÅ Support-Anfrage archiviert.');
  ladeSupportAnfragen();
}

async function loescheSupport(id) {
  if (!confirm('M√∂chtest du diese Support-Anfrage wirklich l√∂schen?')) return;
  await db.collection('supportTickets').doc(id).delete();
  showNotification('üóëÔ∏è Support-Anfrage gel√∂scht.');
  ladeSupportAnfragen();
}*/
</script>
</body>
</html>
