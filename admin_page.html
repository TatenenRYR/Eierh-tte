<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard V9 (Typ editierbar)</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Generelle Stile (Basis V8) */
    body { font-family: 'Inter', sans-serif; }
    .nav-group-title { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem; margin-top: 1rem; }
    .nav-btn { display: flex; align-items: center; gap: 0.75rem; text-align: left; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; color: #374151; }
    .nav-btn:hover { background-color: #f3f4f6; }
    .nav-btn.active { background-color: #10b981; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    #dashboard-map { height: 400px; width: 100%; border-radius: 0.5rem; margin-top: 1rem; z-index: 1; }
    .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-backdrop.flex { display: flex; }
    .modal-content { background: white; border-radius: 0.75rem; padding: 0; width: 100%; max-width: 64rem; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 1.5rem; overflow-x: auto; white-space: nowrap; }
    .modal-tab { padding: 1rem 0.5rem; margin-bottom: -1px; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280; flex-shrink: 0; }
    .modal-tab:hover { color: #111827; }
    .modal-tab.active { color: #10b981; border-color: #10b981; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .ql-container { min-height: 150px; font-size: 1rem; }
    .admin-table { width: 100%; text-align: left; border-collapse: collapse; table-layout: fixed; }
    .admin-table th, .admin-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; word-wrap: break-word; }
    .admin-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .admin-table tr:hover { background-color: #f9fafb; }
    
    .inline-edit-input { border: 1px solid transparent; padding: 0.25rem 0.5rem; border-radius: 0.375rem; width: 100%; box-shadow: none; background-color: transparent; }
    .inline-edit-input:hover { border-color: #d1d5db; background-color: #f9fafb; }
    .inline-edit-input:focus { border-color: #10b981; background-color: white; ring: 1 ring-emerald-500; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    .inline-edit-select { border: 1px solid transparent; padding: 0.1rem 0.5rem; border-radius: 9999px; width: auto; background-color: transparent; font-size: 0.75rem; line-height: 1rem; appearance: none; cursor: pointer; }
    .inline-edit-select:hover { border-color: #d1d5db; }
    .inline-edit-select { padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1em 1em; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .button-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    .priority-Hoch { border-left: 4px solid #ef4444; } .priority-Normal { border-left: 4px solid #f97316; } .priority-Niedrig { border-left: 4px solid #84cc16; }
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5 !important; border-color: #10b981 !important; transform: scale(1.01); }
    #smartUploadPreview .image-card { transition: all 0.25s ease; }
    #smartUploadPreview .image-card:hover { transform: scale(1.03); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #smartUploadProgress { transition: opacity 0.3s; }
    .info-icon { display: inline-block; width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; vertical-align: middle; fill: currentColor; }
    #ai-reply-suggestion-area, #ai-ticket-analysis-area { background-color: #eff6ff; border: 1px solid #93c5fd; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; font-size: 0.875rem; color: #1e40af; }
    .admin-flag { display: inline-block; margin-right: 0.25rem; padding: 0.1rem 0.4rem; font-size: 0.7rem; font-weight: 600; border-radius: 9999px; }
    .flag-standort { background-color: #fef3c7; color: #92400e; } .flag-beschreibung { background-color: #fee2e2; color: #991b1b; } .flag-top { background-color: #d1fae5; color: #065f46; }
  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-sm w-full">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an.</p>
      <button id="login-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full mb-4">Mit Google Anmelden</button>
      <div id="authError" class="mt-2 text-center text-red-500 text-sm"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4"> <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1> </div>
      <nav class="flex-1 space-y-1">
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä Dashboard</button>
        <div class="nav-group-title">Inhalte</div>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('moderation')">üõ°Ô∏è Moderation <span id="mod-queue-badge" class="ml-auto bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">Benutzer</div>
        <button class="nav-btn w-full" onclick="showSection('users')">üë• Benutzer verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile bearbeiten</button>
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets <span id="support-queue-badge" class="ml-auto bg-blue-400 text-blue-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">System</div>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Gamification</button>
        <button class="nav-btn w-full" onclick="showSection('system-logs')">üìú Protokoll & Export</button>
        <button class="nav-btn w-full" onclick="showSection('my-account')">‚öôÔ∏è Mein Account</button>
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200"> <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div> <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button> </div>
    </aside>

    <!-- Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      <section id="overview" class="space-y-8">
         <div> <h2 class="section-title">Willkommen zur√ºck!</h2> <p class="text-gray-600">√úberblick.</p> </div>
         <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">L√§dt...</div>
         <div class="card"><h3 class="font-bold mb-2 text-lg">H√ºtten-Standorte</h3><div id="dashboard-map">Karte l√§dt...</div></div>
         <div class="grid grid-cols-1 lg:grid-cols-5 gap-8"> <div class="lg:col-span-3 card"> <h3 class="font-bold mb-4">Registrierungen (30T)</h3> <canvas id="registrationsChart"></canvas> </div> <div class="lg:col-span-2 card"> <h3 class="font-bold mb-4">Letzte Admin-Aktionen</h3> <div id="admin-log-widget" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y">L√§dt...</div> </div> </div>
      </section>
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4"> <h2 class="section-title">üè† H√ºtten verwalten</h2> <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-emerald-700">+ H√ºtte</button> </div>
        <div class="card">
            <div class="flex justify-between items-center gap-4 mb-4">
                <div class="flex gap-4"> <input id="search-input" placeholder="üîç Suchen..." class="p-2 border rounded-md w-full"> <select id="status-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Status</option> <option value="angenommen">Angenommen</option> <option value="offen">Offen</option> <option value="abgelehnt">Abgelehnt</option> </select> <select id="flag-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Flags</option> <option value="standort">üìç Ort?</option> <option value="beschreibung">üìù Text?</option> <option value="top">‚≠ê Top</option> </select> </div>
                <div id="bulk-action-container" class="hidden"> <select id="bulk-action-select" class="p-2 border rounded-md bg-white"> <option value="">Aktion...</option> <option value="approve">Freigeben</option> <option value="reject">Ablehnen</option> <option value="delete">L√ñSCHEN</option> <option value="add_tag">Tag Hinzuf.</option> <option value="remove_tag">Tag Entf.</option> </select> <button id="bulk-action-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg ml-2 hover:bg-blue-700">OK</button> </div>
            </div>
            <div class="overflow-x-auto">
                <table id="hut-table" class="admin-table">
                    <thead>
                        <tr>
                            <th class="w-[5%]"><input type="checkbox" id="select-all-checkbox"></th>
                            <th class="w-[30%]">Name & Flags</th>
                            <th class="w-[15%]">Status</th>
                            <th class="w-[15%]">Erstellt</th>
                            <th class="w-[10%] text-center">Fotos offen</th>
                            <th class="w-[15%]">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="hut-table-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      <section id="moderation" class="hidden">
        <h2 class="section-title">üõ°Ô∏è Moderation</h2>
        <div class="card"> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"> <div> <div class="flex justify-between mb-4"> <h3 class="font-bold">üÜï Neue Eintr√§ge</h3> <button id="bulk-approve-huts" onclick="bulkApproveHuts()" class="bg-green-500 text-white px-3 py-1 rounded text-sm">Alle freigeben</button> </div> <div id="neueListe-page" class="space-y-2 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 border">L√§dt...</div> </div> <div> <h3 class="font-bold mb-4">üì∑ Fotos offen</h3> <div id="pending-fotos-page" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 border">L√§dt...</div> </div> </div> </div>
      </section>
      <section id="users" class="hidden">
          <h2 class="section-title">üë• Benutzer verwalten</h2>
          <div class="card">
              <input id="user-search-input" placeholder="üîç Nach Name oder E-Mail suchen..." class="p-2 border rounded-md w-full mb-4">
              <div class="overflow-x-auto">
                  <table id="user-table" class="admin-table">
                      <thead>
                          <tr>
                              <th class="w-[30%]">Name / E-Mail</th>
                              <th class="w-[15%]">Rolle</th>
                              <th class="w-[10%] text-center">Eintr√§ge</th>
                              <th class="w-[15%]">Premium</th>
                              <th class="w-[15%]">Letzter Login</th>
                              <th class="w-[15%]">Aktionen</th>
                          </tr>
                      </thead>
                      <tbody id="user-table-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody>
                  </table>
              </div>
          </div>
      </section>
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile bearbeiten</h2>
        <div class="card"> <div class="relative max-w-md mb-6"> <input id="profile-search" type="text" class="w-full border p-2 rounded" placeholder="Profil suchen..." /> <input type="hidden" id="profile-selected-id"> <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded shadow-lg hidden z-10"></div> </div> <div id="profile-admin-area" class="hidden space-y-4 border-t pt-6"> <!-- Profil Details --> </div> </div>
      </section>
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <div class="mb-4 flex gap-4"> <input id="support-search" class="p-2 border rounded flex-grow" placeholder="Suche..."> <select id="support-status-filter" class="p-2 border rounded bg-white"> <option value="">Status</option> <option value="offen">Offen</option> <option value="bearbeitet">In Bearb.</option> <option value="geschlossen">Geschl.</option> <option value="archiviert">Archiv</option> </select> <select id="support-priority-filter" class="p-2 border rounded bg-white"> <option value="">Prio</option> <option value="Hoch">Hoch</option> <option value="Normal">Normal</option> <option value="Niedrig">Niedrig</option> </select> </div>
          <table class="admin-table">
              <thead>
                  <tr>
                      <th class="w-[10%]">Prio</th>
                      <th class="w-[15%]">Datum</th>
                      <th class="w-[20%]">User</th>
                      <th class="w-[30%]">Nachrichten</th>
                      <th class="w-[10%]">Status</th>
                      <th class="w-[15%]">Aktionen</th>
                  </tr>
              </thead>
              <tbody id="support-tickets-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody>
          </table>
        </div>
      </section>
      <section id="gamification" class="hidden">
          <h2 class="section-title">üèÜ Gamification</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="card"> <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel</h3> <div id="title-list" class="space-y-2">L√§dt...</div> <form id="title-form" class="mt-4 space-y-2 border-t pt-4"> <input id="title-name" placeholder="Name" class="border p-2 rounded w-full"> <select id="title-condition" class="border p-2 rounded w-full"> <option value="rides">Fahrten</option> <option value="distance">KM</option> </select> <input id="title-value" type="number" placeholder="Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded w-full">Speichern</button> </form> </div>
              <div class="card"> <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen</h3> <div id="badge-list-admin" class="space-y-2">L√§dt...</div> <form id="badge-form" class="mt-4 space-y-2 border-t pt-4"> <input id="badge-name" placeholder="Name" class="border p-2 rounded w-full"> <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:..."> <input id="badge-icon" placeholder="Emoji Fallback" class="border p-2 rounded w-full"> <select id="badge-condition" class="border p-2 rounded w-full"> <option value="rides">Fahrten</option> <option value="distance">KM</option> <option value="night">Nacht</option> </select> <input id="badge-value" type="number" placeholder="Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded w-full">Speichern</button> </form> </div>
          </div>
      </section>
      <section id="system-logs" class="hidden">
        <h2 class="section-title">üìú Protokoll & Export</h2>
        <div class="card">
            <div class="flex justify-between items-center mb-4"> <input id="log-search-input" class="w-1/2 border p-2 rounded" placeholder="Logs durchsuchen..."> <button onclick="exportHutsToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">CSV Export</button> </div>
            <div id="admin-log-full-list" class="space-y-3 max-h-[60vh] overflow-y-auto text-sm divide-y">L√§dt...</div>
        </div>
      </section>
      <section id="my-account" class="hidden">
          <h2 class="section-title">‚öôÔ∏è Mein Admin-Account</h2>
          <div class="card max-w-lg mx-auto" id="my-account-details"> L√§dt Account-Infos... </div>
      </section>
    </main>
  </div>
  
  <!-- Modals -->
   <div id="support-reply-modal" class="modal-backdrop"> <div class="modal-content max-w-2xl"> <!-- Support Modal --> </div> </div>
   <div id="hut-edit-modal" class="modal-backdrop"> <div id="hut-edit-modal-content" class="modal-content"> <div class="flex justify-center items-center h-64"><div class="spinner"></div></div> </div> </div>
   <div id="event-edit-modal" class="modal-backdrop hidden"> <div class="modal-content max-w-lg">
       <div class="modal-header"> <h3 id="event-modal-title" class="text-lg font-bold">Event</h3> <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button> </div>
       <form id="event-modal-form" class="modal-body space-y-4"> <input type="hidden" id="event-modal-hut-id"> <input type="hidden" id="event-modal-event-id"> <div> <label class="block font-semibold mb-1">Titel</label> <input id="event-modal-title-input" type="text" class="w-full border p-2 rounded-md" required> </div> <div> <label class="block font-semibold mb-1">Beschreibung</label> <textarea id="event-modal-desc" class="w-full border p-2 rounded-md" rows="3"></textarea> </div> <div class="grid grid-cols-2 gap-4"> <div> <label class="block font-semibold mb-1">Start</label> <input id="event-modal-start" type="date" class="w-full border p-2 rounded-md" required> </div> <div> <label class="block font-semibold mb-1">Ende</label> <input id="event-modal-end" type="date" class="w-full border p-2 rounded-md" required> </div> </div> </form>
       <div class="modal-footer flex justify-end gap-3"> <button onclick="closeEventModal()" class="px-4 py-2 bg-gray-300 rounded-lg text-sm">Abbrechen</button> <button onclick="saveEventFromModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">Speichern</button> </div>
   </div> </div>
   <div id="bulk-tag-modal" class="modal-backdrop">
        <div class="modal-content max-w-md">
           <div class="modal-header"><h3 class="text-lg font-bold">Tag f√ºr Auswahl bearbeiten</h3><button onclick="closeBulkTagModal()">X</button></div>
           <div class="modal-body space-y-4">
               <p id="bulk-tag-modal-info"></p>
               <input id="bulk-tag-name" class="w-full border p-2 rounded" placeholder="Tag Name...">
           </div>
           <div class="modal-footer flex justify-end gap-3">
               <button onclick="closeBulkTagModal()" class="bg-gray-300 px-4 py-2 rounded">Abbrechen</button>
               <button id="bulk-tag-confirm-btn" onclick="confirmBulkTagAction()" class="bg-blue-600 text-white px-4 py-2 rounded">Best√§tigen</button>
           </div>
       </div>
   </div>
   <div id="admin-map-container" style="display:none;"></div>

  <!-- SVG Icons -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="icon-user" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-tag" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm11.293 1.293a1 1 0 011.414 0l2 2a1 1 0 010 1.414l-8 8a1 1 0 01-.707.293H7a1 1 0 01-1-1v-4.586a1 1 0 01.293-.707l8-8zM9 8a1 1 0 100-2 1 1 0 000 2z" /></symbol>
</svg>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = { apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", authDomain: "eierhuettentour.firebaseapp.com", projectId: "eierhuettentour", storageBucket: "eierhuettentour.appspot.com", messagingSenderId: "348272135205", appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc" };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === GLOBALE VARIABLEN ===
  let currentUser = null; let allHuts = []; let filteredHuts = []; let currentPage = 1; const hutsPerPage = 15; let currentEditingHutId = null; let currentEditingSupportTicketId = null; let registrationsChartInstance; let adminModalMap; let adminModalMarker; let adminModalLocation; let quillInstance = null; const _supportMessageUnsubs = new Map(); let dashboardMap; let dashboardMarkers = L.layerGroup(); let currentBulkAction = null; 
  let allUsers = []; // Global deklariert
  let filteredUsers = []; // Global deklariert

  // === DOM-ELEMENTE ===
  const notification = document.getElementById('notification'); const hutEditModal = document.getElementById('hut-edit-modal'); const hutEditModalContent = document.getElementById('hut-edit-modal-content'); const supportReplyModal = document.getElementById('support-reply-modal'); const hutTableBody = document.getElementById('hut-table-body'); const selectAllCheckbox = document.getElementById('select-all-checkbox'); const bulkActionContainer = document.getElementById('bulk-action-container'); const bulkActionBtn = document.getElementById('bulk-action-btn'); const supportTicketsBody = document.getElementById('support-tickets-body'); const eventEditModal = document.getElementById('event-edit-modal'); const bulkTagModal = document.getElementById('bulk-tag-modal'); const userTableBody = document.getElementById('user-table-body');

  // === TIERE MAPPING ===
  const TIERE_EMOJI_TO_NAME = { "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege", "üêë": "Schaf", "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase", "üêî": "Huhn", "ü¶Ü": "Ente", "üê¥": "Pferd", "‚ùå": "Keine Tiere" };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries( Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e]) );
  function normalizeToEmojiArray(arr) { if (!Array.isArray(arr)) return []; return arr.map(v => { if (!v) return null; v = String(v).trim(); if (TIERE_EMOJI_TO_NAME[v]) return v; if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; return null; }).filter(Boolean); }
  
  // === AUTHENTICATION & ERROR HANDLING ===
  document.getElementById('login-btn').onclick = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) { handleAuthError(e); } };
  document.getElementById('logout-btn').onclick = () => auth.signOut();
  auth.onAuthStateChanged(async user => {
      const loginSection = document.getElementById('login-section'); const dashboard = document.getElementById('dashboard'); const adminUserInfo = document.getElementById('admin-user-info');
      if (user) {
          currentUser = user; const adminDoc = await db.collection('admins').doc(user.email).get(); if (!adminDoc.exists) { alert('Zugriff verweigert'); auth.signOut(); return; }
          adminUserInfo.textContent = `Angemeldet: ${user.displayName || user.email}`; loginSection.classList.add('hidden'); dashboard.style.display = 'grid';
          // Event Listeners
          document.getElementById('search-input')?.addEventListener('input', applySearchAndSort); document.getElementById('status-filter')?.addEventListener('change', applySearchAndSort); document.getElementById('flag-filter')?.addEventListener('change', applySearchAndSort); document.getElementById('select-all-checkbox')?.addEventListener('change', toggleAllCheckboxes); document.getElementById('bulk-action-btn')?.addEventListener('click', handleBulkAction); document.getElementById('hut-table-body')?.addEventListener('change', updateBulkActionUI); document.getElementById('support-search')?.addEventListener('input', applySupportFilters); document.getElementById('support-status-filter')?.addEventListener('change', applySupportFilters); document.getElementById('support-priority-filter')?.addEventListener('change', applySupportFilters); document.getElementById('log-search-input')?.addEventListener('input', loadAdminLogs); document.getElementById('user-search-input')?.addEventListener('input', applyUserSearchFilter);
          // Initial Load
          initHutsListener(); initLiveModerationQueues(); initLiveSupportQueue(); loadAdminLogs(); loadUsers(); showMyAccount(); initDashboardMap(); showSection('overview');
      } else { currentUser = null; loginSection.classList.remove('hidden'); dashboard.style.display = 'none'; adminUserInfo.textContent = ''; _supportMessageUnsubs.forEach(unsub => unsub()); _supportMessageUnsubs.clear(); if(dashboardMap) { dashboardMap.remove(); dashboardMap = null; } }
  });
  function handleAuthError(error) { const el = document.getElementById('authError'); if (!el) return; let msg = "Fehler."; switch (error.code) { case 'auth/account-exists-with-different-credential': msg = "Account existiert mit anderen Credentials."; break; case 'auth/popup-closed-by-user': case 'auth/cancelled-popup-request': msg = "Anmeldung abgebrochen."; break; default: msg = `Fehler (${error.code})`; } el.textContent = msg; console.error("Auth Error:", error); }

  // === ADMIN LOGGING ===
  async function logAdminAction(action, details = {}) { try { await db.collection('adminLogs').add({ adminEmail: currentUser.email, adminName: currentUser.displayName || 'N/A', action, timestamp: firebase.firestore.FieldValue.serverTimestamp(), ...details }); } catch (e) { console.error("Log Error:", e); } }
  let fullLogDataCache = []; function loadAdminLogs() { const logW = document.getElementById('admin-log-widget'); const logFL = document.getElementById('admin-log-full-list'); const logSI = document.getElementById('log-search-input'); const render = (logs) => { const term = logSI.value.toLowerCase(); const fLogs = term ? logs.filter(l => (l.action?.toLowerCase().includes(term) || l.adminName?.toLowerCase().includes(term) || l.hutName?.toLowerCase().includes(term) || l.ticketId === term || l.profileName?.toLowerCase().includes(term))) : logs; logFL.innerHTML = fLogs.map(l => { const t = l.timestamp?.toDate().toLocaleString('de-DE') || ''; let d = l.hutName ? `H√ºtte: ${escapeHtml(l.hutName)}` : l.ticketId ? `Ticket: ${escapeHtml(l.ticketId)}` : l.profileName ? `Profil: ${escapeHtml(l.profileName)}` : ''; return `<div class="py-2 border-b"><p>${escapeHtml(l.action)}</p><p class="text-gray-600">${d}</p><p class="text-xs text-gray-400">${escapeHtml(l.adminName)} - ${t}</p></div>`; }).join('') || '<p>Keine Logs.</p>'; logW.innerHTML = logs.slice(0, 10).map(l => { const t = l.timestamp?.toDate().toLocaleDateString('de-DE') || ''; return `<div class="pt-2"><p>${escapeHtml(l.action)}</p><p class="text-xs text-gray-400">${escapeHtml(l.adminName)} - ${t}</p></div>`; }).join('') || '<p>Keine Aktivit√§ten.</p>'; }; if (!loadAdminLogs.listenerAttached) { db.collection('adminLogs').orderBy('timestamp', 'desc').limit(200).onSnapshot(snap => { fullLogDataCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); render(fullLogDataCache); }, err => console.error("Log Load Error:", err)); loadAdminLogs.listenerAttached = true; } else { render(fullLogDataCache); } } loadAdminLogs.listenerAttached = false;

  // === DATENLADEN & STATISTIKEN & DASHBOARD MAP ===
  function initHutsListener() { db.collection('eierhuetten').orderBy('erstelltAm', 'desc').onSnapshot(snap => { allHuts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); applySearchAndSort(); renderStats(allHuts); renderRegistrationsChart(allHuts); updateDashboardMapMarkers(); if (currentEditingHutId && hutEditModal.classList.contains('flex')) { openHutModal(currentEditingHutId); } }, err => console.error("Huts Listener:", err)); }
  function renderStats(list) { const t=list.length; const a=list.filter(h=>h.status==='angenommen').length; const o=list.filter(h=>h.status==='offen').length; const ab=list.filter(h=>h.status==='abgelehnt').length; const pF=list.reduce((s,h)=>s+(h.fotos||[]).filter(f=>f&&typeof f==='object'&&f.status==='wartet').length,0); const sC=document.getElementById('statsContainer'); sC.innerHTML=`<div class="card text-center"><p class="text-3xl font-bold">${t}</p><p>Gesamt</p></div><div class="card text-center bg-green-50"><p class="text-3xl text-green-600">${a}</p><p>Angenommen</p></div><div class="card text-center bg-yellow-50"><p class="text-3xl text-yellow-600">${o}</p><p>Offen</p></div><div class="card text-center bg-blue-50"><p class="text-3xl text-blue-600">${pF}</p><p>Fotos offen</p></div><div class="card text-center bg-red-50"><p class="text-3xl text-red-600">${ab}</p><p>Abgelehnt</p></div>`; const mQC=o+pF; const mQB=document.getElementById('mod-queue-badge'); mQB.textContent=mQC; mQB.classList.toggle('hidden',mQC===0); }
  function renderRegistrationsChart(list) { const ctx = document.getElementById('registrationsChart')?.getContext('2d'); if (!ctx) return; const today = new Date(); const labels = []; const data = Array(30).fill(0); for (let i = 29; i >= 0; i--) { const d = new Date(today); d.setDate(d.getDate() - i); labels.push(d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })); } list.forEach(hut => { const hD = hut.erstelltAm?.toDate(); if (!hD) return; const diff = Math.floor((today - hD) / 864e5); if (diff >= 0 && diff < 30) data[29 - diff]++; }); const cD = { labels, datasets: [{ label: 'Neue H√ºtten', data, backgroundColor: 'rgba(16,185,129,.2)', borderColor: '#10b981', borderWidth: 2, fill: true, tension: .1 }] }; if (registrationsChartInstance) { registrationsChartInstance.data = cD; registrationsChartInstance.update(); } else { registrationsChartInstance = new Chart(ctx, { type: 'line', data: cD }); } }
  function initDashboardMap() { if (dashboardMap || !document.getElementById('dashboard-map')) return; try { dashboardMap = L.map('dashboard-map').setView([51.16, 10.45], 6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSG' }).addTo(dashboardMap); dashboardMarkers.addTo(dashboardMap); updateDashboardMapMarkers(); } catch(e) { console.error("Dashboard Map Error:", e); document.getElementById('dashboard-map').textContent = 'Kartenfehler.'; } }
  function updateDashboardMapMarkers() { if (!dashboardMap) return; dashboardMarkers.clearLayers(); const statusColors = { 'angenommen': 'green', 'offen': 'orange', 'abgelehnt': 'red' }; const hutsWithLoc = allHuts.filter(h => h.location?.latitude && h.location?.longitude); const markers = []; hutsWithLoc.forEach(hut => { const color = statusColors[hut.status] || 'grey'; const icon = L.divIcon({ className: `bg-${color}-500 w-2.5 h-2.5 rounded-full border border-white shadow`, iconSize: [10, 10], html: '' }); const marker = L.marker([hut.location.latitude, hut.location.longitude], { icon }) .bindPopup(`<b>${escapeHtml(hut.name)}</b><br>${hut.status}<br><button onclick="openHutModal('${hut.id}')" class='text-blue-600 underline text-xs'>Details</button>`); markers.push(marker); }); if (typeof L.markerClusterGroup === 'function') { const clusterGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true, maxClusterRadius: 40 }); clusterGroup.addLayers(markers); dashboardMarkers.addLayer(clusterGroup); } else { markers.forEach(marker => marker.addTo(dashboardMarkers)); } }

  // === H√úTTEN-TABELLE & INLINE EDIT & BULK ACTIONS ===
  function applySearchAndSort() { const s=document.getElementById('search-input').value.toLowerCase(); const st=document.getElementById('status-filter').value; const fl=document.getElementById('flag-filter').value; filteredHuts = allHuts.filter(h => (h.name?.toLowerCase().includes(s)||h.id.includes(s)) && (st===""||h.status===st) && (fl==="" || (h.adminFlags && h.adminFlags[fl])) ); currentPage = 1; renderPage(currentPage); updateBulkActionUI(); }
  function renderPage(page) { const s=(page - 1)*hutsPerPage; const e=s+hutsPerPage; renderHutsTable(filteredHuts.slice(s, e)); renderPagination(filteredHuts.length); }
  function renderHutsTable(list) {
      hutTableBody.innerHTML = ''; if (list.length === 0) { hutTableBody.innerHTML = `<tr><td colspan="6" class="text-center italic py-4">Keine H√ºtten gefunden.</td></tr>`; return; }
      list.forEach(hut => {
          let sC = 'bg-gray-100'; if (hut.status === 'angenommen') sC = 'bg-green-100 text-green-700'; else if (hut.status === 'offen') sC = 'bg-yellow-100 text-yellow-700'; else if (hut.status === 'abgelehnt') sC = 'bg-red-100 text-red-700';
          const pFc = (hut.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length;
          const flagsHtml = hut.adminFlags ? Object.entries(hut.adminFlags).filter(([, v]) => v).map(([k]) => { let fC='', fT=k; if(k==='standort'){fC='flag-standort';fT='üìç?';} else if(k==='beschreibung'){fC='flag-beschreibung';fT='üìù?';} else if(k==='top'){fC='flag-top';fT='‚≠ê';} return `<span class="admin-flag ${fC}" title="${k}">${fT}</span>`; }).join(' ') : '';
          const row = document.createElement('tr'); row.className = 'hover:bg-gray-50';
          row.innerHTML = `
              <td><input type="checkbox" class="hut-checkbox" data-id="${hut.id}"></td>
              <td> <input type="text" value="${escapeAttr(hut.name||'')}" data-id="${hut.id}" class="inline-edit-input font-semibold text-emerald-700" onchange="inlineUpdateField('${hut.id}', 'name', this.value)"> <div class="mt-1">${flagsHtml}</div> <p class="text-xs text-gray-400 mt-1">${hut.id}</p> </td>
              <td> <select class="inline-edit-select text-xs font-medium px-2 py-1 ${sC}" onchange="inlineUpdateField('${hut.id}', 'status', this.value)"> ${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')} </select> </td>
              <td class="text-sm">${hut.erstelltAm?.toDate().toLocaleDateString('de-DE')||'-'}</td>
              <td class="text-sm text-center ${pFc>0?'font-semibold':''}">${pFc}</td>
              <td><button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Details</button></td>
          `;
          hutTableBody.appendChild(row);
      });
  }
  function renderPagination(totalItems) { const tP=Math.ceil(totalItems/hutsPerPage); const pC=document.getElementById('pagination'); pC.innerHTML=''; if(tP<=1) return; const cPB=(l,p,iA=false,iD=false)=>{const b=document.createElement('button'); b.innerHTML=l; b.disabled=iD; b.className=`px-3 py-1 border rounded mx-1 ${iA?'bg-emerald-600 text-white':'bg-white'} ${iD?'text-gray-300':'hover:bg-gray-100'}`; if(!iD)b.onclick=()=>{currentPage=p; renderPage(currentPage);}; return b;}; pC.appendChild(cPB('&laquo;',currentPage-1,false,currentPage===1)); let sP=Math.max(1,currentPage-2); let eP=Math.min(tP,currentPage+2); if(sP>1) pC.appendChild(cPB('1',1)); if(sP>2) pC.appendChild(cPB('...',1,false,true)); for(let i=sP;i<=eP;i++)pC.appendChild(cPB(i,i,i===currentPage)); if(eP<tP-1) pC.appendChild(cPB('...',tP,false,true)); if(eP<tP) pC.appendChild(cPB(tP,tP)); pC.appendChild(cPB('&raquo;',currentPage+1,false,currentPage===tP)); }
  function toggleAllCheckboxes() { const iC = selectAllCheckbox.checked; hutTableBody.querySelectorAll('.hut-checkbox').forEach(cb => cb.checked = iC); updateBulkActionUI(); }
  function updateBulkActionUI() { const sC = hutTableBody.querySelectorAll('.hut-checkbox:checked').length; bulkActionContainer.classList.toggle('hidden', sC === 0); if (sC === 0) selectAllCheckbox.checked = false; }
  async function handleBulkAction() {
      currentBulkAction = document.getElementById('bulk-action-select').value; const sIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id); if (!currentBulkAction || sIds.length === 0) { showNotification('‚ö†Ô∏è Aktion & H√ºtten w√§hlen.'); return; }
      if (currentBulkAction === 'add_tag' || currentBulkAction === 'remove_tag') { document.getElementById('bulk-tag-modal-info').textContent = `Tag ${currentBulkAction === 'add_tag' ? 'hinzuf√ºgen zu' : 'entfernen von'} ${sIds.length} H√ºtten:`; document.getElementById('bulk-tag-name').value = ''; bulkTagModal.classList.add('flex'); } 
      else { let cM = `Aktion '${currentBulkAction}' f√ºr ${sIds.length} H√ºtten?`; if (currentBulkAction === 'delete') cM = `‚ùó ${sIds.length} H√ºtten L√ñSCHEN?`; if (!confirm(cM)) return; executeBulkAction(sIds, currentBulkAction); }
  }
  function closeBulkTagModal() { bulkTagModal.classList.remove('flex'); currentBulkAction = null; }
  async function confirmBulkTagAction() { const tag = document.getElementById('bulk-tag-name').value.trim(); if (!tag) { showNotification("‚ùå Tag?"); return; } const sIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id); closeBulkTagModal(); executeBulkAction(sIds, currentBulkAction, tag); }
  async function executeBulkAction(sIds, action, tagName = null) { bulkActionBtn.disabled = true; bulkActionBtn.classList.add('button-loading'); let succ = 0; let actDesc = action; if(tagName) actDesc += ` '${tagName}'`; for (const id of sIds) { try { if (action === 'approve') await quickUpdateStatus(id, 'angenommen'); else if (action === 'reject') await quickUpdateStatus(id, 'abgelehnt'); else if (action === 'delete') await deleteHut(id, true); else if (action === 'add_tag' && tagName) await addTagToHut(id, tagName); else if (action === 'remove_tag' && tagName) await removeTagFromHut(id, tagName); succ++; } catch (e) { console.error(`Bulk Error ${id}:`, e); } } logAdminAction(`Bulk: ${actDesc}`, { count: sIds.length, success: succ }); bulkActionBtn.disabled = false; bulkActionBtn.classList.remove('button-loading'); showNotification(`‚úÖ ${succ}/${sIds.length} verarbeitet.`); applySearchAndSort(); document.getElementById('bulk-action-select').value = ''; }
  async function addTagToHut(hutId, tag) { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayUnion(tag) }); }
  async function removeTagFromHut(hutId, tag) { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayRemove(tag) }); }
  async function inlineUpdateField(hutId, field, value) { if (!value && field === 'name') { showNotification('‚ùå Name leer.'); renderPage(currentPage); return; } try { const ref = db.collection('eierhuetten').doc(hutId); await ref.update({ [field]: value }); const hut = allHuts.find(h => h.id === hutId); logAdminAction(`Inline: ${field}=${value}`, { hutId, hutName: hut?.name }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: field, wert: value, zeitpunkt: new Date() }); showNotification(`‚úÖ ${field} aktualisiert.`); const row = hutTableBody.querySelector(`input[data-id="${hutId}"]`)?.closest('tr') || hutTableBody.querySelector(`select[onchange*="'${hutId}'"]`)?.closest('tr'); if(row) { row.style.backgroundColor='#d1fae5'; setTimeout(()=>row.style.backgroundColor='',1000); } } catch(e) { console.error("Inline Error:", e); showNotification(`‚ùå Fehler: ${e.message}`); renderPage(currentPage); } }

  // === H√úTTEN-MODAL ===
  function closeHutModal() { hutEditModal.classList.remove('flex'); hutEditModalContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>'; currentEditingHutId = null; adminModalMap = null; adminModalLocation = null; quillInstance = null; }
  async function openHutModal(hutId) {
      currentEditingHutId = hutId; let hut; let title = "Neue H√ºtte"; let logs = []; let stats = { views: 0, routeStarts: 0 }; let events = []; let messages = [];
      if (hutId) {
          hut = allHuts.find(h => h.id === hutId); if (!hut) { showNotification('‚ùå H√ºtte nicht gefunden.'); return; }
          title = `Bearbeiten: ${escapeHtml(hut.name)}`; stats = { views: hut.views || 0, routeStarts: hut.routeStarts || 0 };
          try {
              const [logSnap, eventSnap, msgSnap] = await Promise.all([ db.collection('eierhuetten').doc(hutId).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get(), db.collection('eierhuetten').doc(hutId).collection('events').orderBy('startDate', 'desc').get(), db.collection('hutMessages').where('hutId', '==', hutId).orderBy('createdAt', 'desc').limit(50).get() ]);
              logs = logSnap.docs.map(doc => doc.data()); events = eventSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })); messages = msgSnap.docs.map(doc => ({ id: doc.id, hutId: hutId, ...doc.data() }));
          } catch (e) { console.error("Modal Data Error:", e); showNotification("Fehler Details."); }
      } else { hut = { id: null, name: '', status: 'angenommen', tiere: [], fotos: [], location: null, oeffnungszeiten: {}, beschreibung: '', extras: '', tags: [], typ: 'Eierh√ºtte', adminFlags: {}, adminNotes: '' }; }
      
      const typIconMap = { 'Eierh√ºtte': 'ü•ö', 'Hofladen': 'üè™', 'Selbstbedienung': 'üè†', 'Spielplatz': 'üõù', 'Abenteuerhof': 'üåÑ', 'Automat': 'üç∂', default: '‚ùì' };
      const creatorInfo = hut.userMail ? `<div class="mt-4 pt-4 border-t text-sm flex items-center"><svg class="info-icon"><use href="#icon-user"></use></svg> Erstellt: <strong>${escapeHtml(hut.userMail)}</strong></div>` : '';
      // KORREKTUR: Dropdown f√ºr Typ
      const typeDropdown = `<div><label class="font-semibold mb-1 flex items-center"><svg class="info-icon"><use href="#icon-tag"></use></svg> Typ</label><select id="modal-hut-typ" class="w-full border p-2 rounded bg-white">${['Eierh√ºtte', 'Hofladen', 'Selbstbedienung', 'Spielplatz', 'Abenteuerhof', 'Automat'].map(t => `<option value="${t}" ${t===(hut.typ||'Eierh√ºtte')?'selected':''}>${typIconMap[t] || '‚ùì'} ${t}</option>`).join('')}</select></div>`;
      
      const sE = new Set(normalizeToEmojiArray(hut.tiere || [])); const tH = Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => `<button type="button" data-emoji="${e}" class="admin-tiere-btn text-2xl p-2 rounded ${sE.has(e)?'bg-yellow-200 ring-2 ring-yellow-400':'bg-gray-100 hover:bg-gray-200'}" title="${escapeAttr(n)}">${e}</button>`).join('');
      const adminNotesHtml = `<div class="mt-6 pt-6 border-t"><h4 class="font-semibold mb-2">Interne Infos</h4><div class="mb-3"><label class="block text-sm font-medium mb-1">Flags:</label><div class="flex flex-wrap gap-x-4 gap-y-1"><label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb" data-flag="standort" ${hut.adminFlags?.standort?'checked':''}> <span class="ml-2 text-sm">üìç Standort?</span></label><label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb" data-flag="beschreibung" ${hut.adminFlags?.beschreibung?'checked':''}> <span class="ml-2 text-sm">üìù Text?</span></label><label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb" data-flag="top" ${hut.adminFlags?.top?'checked':''}> <span class="ml-2 text-sm">‚≠ê Top</span></label></div></div><div><label class="block text-sm font-medium mb-1">Notizen:</label><textarea id="modal-hut-admin-notes" class="w-full border p-2 rounded text-sm" rows="3" placeholder="Nur f√ºr Admins...">${escapeHtml(hut.adminNotes||'')}</textarea></div></div>`;
      const tabStammdaten = `<div class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="font-semibold mb-1">Name</label><input id="modal-hut-name" class="w-full border p-2 rounded" value="${escapeAttr(hut.name||'')}"></div> <div class="grid grid-cols-2 gap-4"> <div><label class="font-semibold mb-1">Status</label><select id="modal-hut-status" class="w-full border p-2 rounded">${['offen','angenommen','abgelehnt'].map(s=>`<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}</select></div> ${typeDropdown} {/* KORREKTUR HIER */} </div> <div class="relative"><div class="flex justify-between items-center mb-1"><label class="font-semibold">Beschreibung</label><button id="aiDescBtnModal" class="px-2 py-1 bg-green-600 text-white rounded text-xs">‚ú® KI</button></div><div id="quillContainer" class="bg-white border rounded min-h-[150px]"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="font-semibold mb-1">Strom</label><select id="modal-hut-strom" class="w-full border p-2 rounded">${['Ja','Nein','Unbekannt'].map(o=>`<option ${o===(hut.strom||'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div><div><label class="font-semibold mb-1">Sitzpl√§tze</label><select id="modal-hut-sitzplaetze" class="w-full border p-2 rounded">${['Ja','Nein','Unbekannt'].map(o=>`<option ${o===(hut.sitzplaetze||'Unbekannt')?'selected':''}>${o}</option>`).join('')}</select></div></div><div><label class="font-semibold mb-1">Extras</label><input id="modal-hut-extras" class="w-full border p-2 rounded" value="${escapeAttr(hut.extras||'')}"></div> ${creatorInfo} </div><div><label class="font-semibold mb-1">Standort</label><div id="modal-map" class="minimap"></div><p class="text-xs text-gray-500 mt-1">Marker ziehen.</p></div></div><div><label class="font-semibold mb-1">Tiere</label><div id="modal-tiere-container" class="flex flex-wrap gap-2">${tH}</div></div><div class="relative"><label class="font-semibold mb-1">Tags</label><input id="modal-hut-tags" class="w-full border p-2 rounded pr-24" value="${escapeAttr((hut.tags||[]).join(', '))}"> <button onclick="suggestTagsForEditModal('${hut.id||'new'}')" class="absolute top-1/2 right-2 transform -translate-y-1/2 px-2 py-1 bg-blue-500 text-white rounded text-xs">‚ú® KI</button></div> ${adminNotesHtml} </div>`;
      const tabOeff = `<div id="openingEditorWrapper" class="mt-3">${renderOpeningHoursEditor(hut.id||'new', hut.oeffnungszeiten)}</div>`; const tabFotos = `<div id="photoUploaderContainerModal" class="mt-3"></div>`; const tabEvents = `<div><button ${hutId ? '' : 'disabled'} onclick="openEventModal('${hutId}', null)" class="mb-4 bg-purple-600 text-white px-3 py-1 rounded text-sm ${hutId ? 'hover:bg-purple-700' : ''}">+ Event</button>${!hutId ? '<span class="text-xs text-gray-500 ml-2">H√ºtte erst speichern.</span>' : ''}<div id="modal-event-list" class="space-y-3">${events.length>0?events.map(ev=>renderEventCard(hutId,ev)).join(''):'<p>Keine Events.</p>'}</div></div>`; const tabMessages = `<div id="modal-message-list" class="space-y-3 max-h-96 overflow-y-auto border rounded p-3 bg-gray-50 text-sm">${messages.length>0?messages.map(msg=>renderMessageCard(msg)).join(''):'<p>Keine Nachrichten.</p>'}</div>`; const tabStat = `<div class="text-center space-y-4"><div class="p-4 bg-blue-50 rounded"><p class="text-3xl font-bold text-blue-600">${stats.views}</p><p>Aufrufe</p></div><div class="p-4 bg-green-50 rounded"><p class="text-3xl font-bold text-green-600">${stats.routeStarts}</p><p>Routenstarts</p></div></div>`; const tabProt = `<div><ul class="text-sm max-h-96 overflow-y-auto mt-2 border p-2 rounded bg-gray-50 divide-y">${logs.length>0?logs.map(l=>`<li class="py-2"><strong>${escapeHtml(l.admin)}</strong> √§nderte <em>${escapeHtml(l.feld)}</em> ${l.wert?`auf <code>${escapeHtml(String(l.wert).substring(0,100))}</code>`:''}<span class="block text-xs text-gray-400">${new Date(l.zeitpunkt?.seconds*1000||Date.now()).toLocaleString()}</span></li>`).join(''):'<p>Keine Logs.</p>'}</ul></div>`;
      hutEditModalContent.innerHTML=`<div class="modal-header"><h2 class="text-2xl font-bold">${title}</h2><button onclick="closeHutModal()">X</button></div><div class="modal-tab-nav"><button class="modal-tab active" onclick="showModalTab('stammdaten')">Stamm</button><button class="modal-tab" onclick="showModalTab('oeffnungszeiten')">Zeiten</button><button class="modal-tab" onclick="showModalTab('fotos')">Fotos</button><button class="modal-tab" onclick="showModalTab('events')">Events</button><button class="modal-tab" onclick="showModalTab('messages')">Nachrichten</button><button class="modal-tab" onclick="showModalTab('statistik')">Statistik</button><button class="modal-tab" onclick="showModalTab('protokoll')">Protokoll</button></div><div class="modal-body"><div id="tab-stammdaten" class="modal-tab-content active">${tabStammdaten}</div><div id="tab-oeffnungszeiten" class="modal-tab-content">${tabOeff}</div><div id="tab-fotos" class="modal-tab-content">${tabFotos}</div><div id="tab-events" class="modal-tab-content">${tabEvents}</div><div id="tab-messages" class="modal-tab-content">${tabMessages}</div><div id="tab-statistik" class="modal-tab-content">${tabStat}</div><div id="tab-protokoll" class="modal-tab-content">${tabProt}</div></div><div class="modal-footer flex justify-between"><div>${hutId?`<button id="deleteHutBtnModal" onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-4 py-2 rounded">L√∂schen</button>`:''}</div><div class="flex gap-4"><button onclick="closeHutModal()" class="bg-gray-300 px-4 py-2 rounded">Abbrechen</button><button id="saveHutBtnModal" onclick="saveHutFromModal()" class="bg-emerald-600 text-white px-6 py-2 rounded font-semibold">Speichern</button></div></div>`;
      hutEditModal.classList.add('flex');
      setTimeout(()=>{ if(document.getElementById('quillContainer')){quillInstance=new Quill("#quillContainer",{theme:"snow"}); if(hut.beschreibung)quillInstance.root.innerHTML=hut.beschreibung; document.getElementById('aiDescBtnModal')?.addEventListener('click',generateDescriptionForModal);} const pC=document.getElementById('photoUploaderContainerModal'); if(pC){renderSmartImageUploader(pC,db.collection('eierhuetten').doc(hut.id||'new'),hut.fotos,hut.id||'new');} initModalMap(hut.location); }, 100);
      document.getElementById('modal-tiere-container')?.addEventListener('click', e=>{ const b=e.target.closest('.admin-tiere-btn'); if(!b) return; const em=b.dataset.emoji; if(currentEditingHutId&&em){toggleTier(currentEditingHutId,em);} else if(!currentEditingHutId&&em){ b.classList.toggle('bg-yellow-200'); b.classList.toggle('ring-2'); b.classList.toggle('bg-gray-100');} });
  }
  async function generateDescriptionForModal() { if (!quillInstance) return; const data = collectCurrentModalData(); const btn = document.getElementById('aiDescBtnModal'); btn.disabled = true; btn.classList.add('button-loading'); showToast("üß† KI Beschreibung...", 5000); try { const desc = await callGeminiGenerateDescription(data); quillInstance.root.innerHTML = `<p>${desc.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`; } catch (e) { showToast("‚ùå KI Fehler: " + e.message); console.error("Gemini Desc Error:", e); } finally { btn.disabled = false; btn.classList.remove('button-loading'); } }
  async function suggestTagsForEditModal(hutId) { const tagsInput = document.getElementById('modal-hut-tags'); if (!tagsInput) return; const data = collectCurrentModalData(); const btn = event.target; btn.disabled = true; btn.classList.add('button-loading'); showToast("üß† KI Tags...", 3000); try { const tags = await callGeminiGenerateTags(data); tagsInput.value = tags.join(', '); } catch (e) { showToast("‚ùå KI Fehler: " + e.message); console.error("Gemini Tags Error:", e); } finally { btn.disabled = false; btn.classList.remove('button-loading'); } }
  function collectCurrentModalData() { const base = currentEditingHutId ? allHuts.find(h => h.id === currentEditingHutId) : {}; const adminFlags = {}; document.querySelectorAll('#hut-edit-modal .admin-flag-cb').forEach(cb => { adminFlags[cb.dataset.flag] = cb.checked; }); return { ...base, name: document.getElementById('modal-hut-name')?.value || '', beschreibung: quillInstance ? quillInstance.root.innerHTML : '', strom: document.getElementById('modal-hut-strom')?.value || 'Unbekannt', sitzplaetze: document.getElementById('modal-hut-sitzplaetze')?.value || 'Unbekannt', extras: document.getElementById('modal-hut-extras')?.value || '', tiere: Array.from(document.querySelectorAll('#modal-tiere-container .admin-tiere-btn.bg-yellow-200')).map(b => b.dataset.emoji), tags: (document.getElementById('modal-hut-tags')?.value || '').split(',').map(t=>t.trim()).filter(Boolean), typ: document.getElementById('modal-hut-typ')?.value || base.typ || 'Eierh√ºtte', adminNotes: document.getElementById('modal-hut-admin-notes')?.value || '', adminFlags }; }
  function showModalTab(tabId) { document.querySelectorAll('#hut-edit-modal .modal-tab').forEach(b=>b.classList.remove('active')); document.querySelector(`#hut-edit-modal .modal-tab[onclick="showModalTab('${tabId}')"]`)?.classList.add('active'); document.querySelectorAll('#hut-edit-modal .modal-tab-content').forEach(c=>c.classList.remove('active')); document.getElementById(`tab-${tabId}`)?.classList.add('active'); if(tabId==='stammdaten'){setTimeout(()=> {if(!adminModalMap){const h=allHuts.find(h=>h.id===currentEditingHutId); initModalMap(h?.location);} else {adminModalMap.invalidateSize();}}, 50);} if(tabId==='fotos'&&currentEditingHutId&&!document.getElementById(`smartUploadZone-${currentEditingHutId}`)){const h=allHuts.find(h=>h.id===currentEditingHutId); const c=document.getElementById('photoUploaderContainerModal'); if(c&&h){renderSmartImageUploader(c,db.collection('eierhuetten').doc(h.id),h.fotos,h.id);}} }
  function initModalMap(location) { let lat = location?.latitude || 51.16; let lng = location?.longitude || 10.45; let zoom = location ? 13 : 6; adminModalLocation = location ? new firebase.firestore.GeoPoint(lat, lng) : null; const mapCont = document.getElementById('modal-map'); if (!mapCont || !mapCont.offsetParent) return; if (adminModalMap) { adminModalMap.remove(); adminModalMap = null; } try { adminModalMap = L.map('modal-map').setView([lat, lng], zoom); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminModalMap); adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap).on('dragend', handleMarkerDrag); setTimeout(() => adminModalMap.invalidateSize(), 50); } catch(e) { console.error("Leaflet Error:", e); } }
  function handleMarkerDrag(e) { const pos = e.target.getLatLng(); adminModalLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng); }

  // === H√úTTEN-CRUD ===
  async function saveHutFromModal() { const sB=document.getElementById('saveHutBtnModal'); sB.disabled=true; sB.classList.add('button-loading'); const data = collectCurrentModalData(); if(!data.name){showNotification('‚ùå Name fehlt.');sB.disabled=false;sB.classList.remove('button-loading');return;} if(!adminModalLocation){showNotification('‚ùå Standort fehlt.');sB.disabled=false;sB.classList.remove('button-loading');return;} data.location = adminModalLocation; data.oeffnungszeiten = normalizeOpeningHours(collectOpeningHours(currentEditingHutId||'new')); try{ if(currentEditingHutId){const ref=db.collection('eierhuetten').doc(currentEditingHutId); await ref.update(data); logAdminAction('H√ºtte aktualisiert',{hutId:currentEditingHutId, hutName:data.name}); showNotification('‚úÖ Aktualisiert.');} else{ data.erstelltAm=firebase.firestore.FieldValue.serverTimestamp(); data.userId=currentUser.uid; data.userMail = currentUser.email; data.fotos=[]; data.views=0; data.routeStarts=0; if(!data.typ) data.typ='Eierh√ºtte'; const ref=await db.collection('eierhuetten').add(data); logAdminAction('H√ºtte erstellt',{hutId:ref.id, hutName:data.name}); showNotification('‚úÖ Erstellt.');} closeHutModal();} catch(e){showNotification('‚ùå Fehler: '+e.message); console.error(e);} finally{sB.disabled=false; sB.classList.remove('button-loading');} }
  async function quickUpdateStatus(hutId, status) { try { const ref = db.collection('eierhuetten').doc(hutId); await ref.update({ status }); const hut = allHuts.find(h => h.id === hutId); logAdminAction(`Status: '${status}'`, { hutId, hutName: hut?.name }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'status', wert: status, zeitpunkt: new Date() }); } catch(e) { console.error("QuickUpdate Error:", e); showNotification(`‚ùå Fehler ${hutId}: ${e.message}`); } }
  async function deleteHut(id, skipConfirm = false) { if (!skipConfirm && !confirm(`‚ùó H√ºtte ${id} L√ñSCHEN?`)) return; const btn = document.getElementById('deleteHutBtnModal'); if(btn) { btn.disabled = true; btn.classList.add('button-loading'); } try { const ref = db.collection('eierhuetten').doc(id); const doc = await ref.get(); if(!doc.exists) throw new Error("Nicht gefunden."); const hut = doc.data(); const name = hut.name || id; if (Array.isArray(hut.fotos)) { for (const f of hut.fotos) { if (f && typeof f === "object" && f.delete_url) { try { await fetch(f.delete_url, { method: 'DELETE' }); } catch (e) {} } } } await ref.delete(); logAdminAction('H√ºtte gel√∂scht', { hutId: id, hutName: name }); showNotification('üóëÔ∏è H√ºtte gel√∂scht.'); closeHutModal(); } catch (err) { showNotification('‚ùå L√∂schfehler: ' + err.message); console.error(err); } finally { if(btn) { btn.disabled = false; btn.classList.remove('button-loading'); } } }

  // === FOTO-VERWALTUNG ===
  async function approveFoto(hutId, index) { try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : []; const f = fotos[index]; if (!f || typeof f === 'string') return; fotos[index] = { ...f, status: 'freigegeben' }; await ref.update({ fotos }); logAdminAction('Foto freigegeben', { hutId, hutName: snap.data().name, url: f.url }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto frei: ${f.url}`, zeitpunkt: new Date() }); showNotification('‚úÖ Bild frei.'); if (currentEditingHutId === hutId) openHutModal(hutId); } catch (err) { showNotification('‚ùå Fehler.'); console.error(err); } }
  async function rejectFoto(hutId, index) { if (!confirm('Foto l√∂schen?')) return; try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); if (!snap.exists) throw new Error("H√ºtte nicht da."); let fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : []; const f = fotos[index]; if (!f) return; const urlDel = typeof f === 'string' ? f : f.url; const apiDel = (f && typeof f === 'object' && f.delete_url) ? f.delete_url : null; fotos.splice(index, 1); await ref.update({ fotos }); logAdminAction('Foto gel√∂scht', { hutId, hutName: snap.data().name, url: urlDel }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'fotos', wert: `Foto gel√∂scht: ${urlDel}`, zeitpunkt: new Date() }); if (apiDel) { try { await fetch(apiDel, { method: 'DELETE' }); } catch (e) {} } showNotification('üóëÔ∏è Bild weg.'); if (currentEditingHutId === hutId) openHutModal(hutId); } catch (err) { showNotification('‚ùå Fehler: ' + err.message); console.error(err); } }
  async function renderSmartImageUploader(container, docRef, existingImages = [], entryId) { const isNew = entryId === 'new'; container.innerHTML = `<div class="bg-white rounded-xl p-4"><h3 class="text-sm font-semibold mb-3">üì∏ Fotos</h3><div id="smartUploadZone-${entryId}" class="relative border-2 border-dashed ${isNew ? 'border-gray-300 bg-gray-100 cursor-not-allowed' : 'border-gray-300 bg-gray-50 hover:bg-green-50 hover:border-green-400 cursor-pointer'} transition rounded-xl p-6 text-center mb-4"><p class="text-gray-600 text-sm">${isNew ? 'H√ºtte speichern zum Hochladen' : 'Bilder hierher ziehen / klicken'}</p><input id="smartUploadInput-${entryId}" type="file" accept="image/*" multiple class="hidden" ${isNew?'disabled':''}> <div id="smartUploadProgress-${entryId}" class="hidden absolute bottom-2 left-2 right-2 h-1 bg-gray-200 rounded"><div id="smartUploadBar-${entryId}" class="h-1 bg-green-500 rounded" style="width:0%"></div></div></div><div id="smartUploadPreview-${entryId}" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div></div>`; const zone = container.querySelector(`#smartUploadZone-${entryId}`); const input = container.querySelector(`#smartUploadInput-${entryId}`); const preview = container.querySelector(`#smartUploadPreview-${entryId}`); const bar = container.querySelector(`#smartUploadBar-${entryId}`); const barCont = container.querySelector(`#smartUploadProgress-${entryId}`); let currentImages = (existingImages || []).map((img, idx) => { const base = typeof img === 'string' ? { url: img, status: 'freigegeben', title: '' } : { ...img }; base.originalIndex = idx; return base; }); function renderPreview() { preview.innerHTML = ""; if (!currentImages.length) { preview.innerHTML = `<div class="col-span-full text-center text-gray-400 italic py-4">Keine Bilder.</div>`; return; } currentImages.forEach((img) => { const card = document.createElement("div"); const isPend = img.status === 'wartet'; card.className = `image-card relative group w-full aspect-[4/3] border rounded overflow-hidden bg-gray-50 p-1 flex flex-col shadow-sm ${isPend?'border-yellow-400 border-2':''}`; card.innerHTML = `<img src="${img.url}" class="object-cover w-full h-2/3 rounded mb-1 ${isPend?'opacity-70':''}"> <input data-idx="${img.originalIndex}" class="imageTitleInput w-full text-[10px] border rounded p-0.5 text-center mb-0.5" value="${escapeAttr(img.title||'')}" placeholder="Titel..."> <div class="flex justify-center gap-1 w-full"><button onclick="generateSingleImageTitle(this)" title="KI Titel" class="kiBtn text-[10px] bg-blue-500 text-white rounded px-1">ü™Ñ</button> ${isPend?`<button onclick="approveFoto('${entryId}', ${img.originalIndex})" title="Freigeben" class="approveBtn text-[10px] bg-green-500 text-white rounded px-1">‚úî</button>`:''} <button onclick="rejectFoto('${entryId}', ${img.originalIndex})" title="L√∂schen" class="removeBtn text-[10px] bg-red-500 text-white rounded px-1">‚úï</button></div> ${isPend?'<div class="absolute top-1 left-1 bg-yellow-400 text-yellow-900 text-[9px] px-1 rounded font-semibold">Wartet</div>':''}`; card.querySelector(".imageTitleInput").addEventListener("input", debounce(async (e) => { const idx = parseInt(e.target.dataset.idx); const nT = e.target.value; const imgToUpd = currentImages.find(img => img.originalIndex === idx); if(imgToUpd) imgToUpd.title = nT; try { await docRef.update({ fotos: currentImages.map(({originalIndex, ...rest}) => rest) }); } catch(err) { console.error("Title Save Error:", err); } }, 500)); preview.appendChild(card); }); } if (!isNew) { zone.onclick=()=>input.click(); zone.ondragover=(e)=>{e.preventDefault();zone.classList.add("bg-green-100","border-green-400");}; zone.ondragleave=()=>zone.classList.remove("bg-green-100","border-green-400"); zone.ondrop=(e)=>{e.preventDefault();zone.classList.remove("bg-green-100","border-green-400");handleFiles(e.dataTransfer.files);}; input.onchange=(e)=>handleFiles(e.target.files); } renderPreview(); async function handleFiles(files) { const list=Array.from(files); if(!list.length)return; barCont.classList.remove("hidden"); let succ=0; for(let i=0;i<list.length;i++){ bar.style.width=`${((i+1)/list.length)*100}%`; try{ const b64=await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(list[i]);}); const fd=new FormData(); fd.append('key',IMGBB_KEY); fd.append('image',b64); const rp=await fetch('https://api.imgbb.com/1/upload',{method:'POST',body:fd}); const j=await rp.json(); if(!j.success)throw new Error(j.error.message); const url=j.data.url; const title=await generateSmartImageTitle(url,list[i].name); const nImg={url,title,delete_url:j.data.delete_url||null,status:'wartet'}; await docRef.update({fotos:firebase.firestore.FieldValue.arrayUnion(nImg)}); const uSnap=await docRef.get(); currentImages=(uSnap.data().fotos||[]).map((img,idx)=>({...img,originalIndex:idx})); succ++; }catch(e){showNotification(`‚ùå Upload Fehler: ${e.message}`);console.error(e);} } barCont.classList.add("hidden"); bar.style.width='0%'; showNotification(`‚úÖ ${succ}/${list.length} Bilder hochgeladen.`); logAdminAction(`${succ} Foto(s) hochgeladen`,{hutId:entryId,hutName:allHuts.find(h=>h.id===entryId)?.name}); renderPreview(); } }
  function debounce(func, wait) { let t; return function(...a){const later=()=>{clearTimeout(t);func.apply(this,a);};clearTimeout(t);t=setTimeout(later,wait);};};
  async function generateSingleImageTitle(btnEl) { const inp=btnEl.closest('div').querySelector('.imageTitleInput'); const img=btnEl.closest('.image-card').querySelector('img'); if(!inp||!img) return; btnEl.textContent='üß†...'; btnEl.disabled=true; try{ const url=img.src; const sug=await generateSmartImageTitle(url); inp.value=sug; inp.dispatchEvent(new Event('input',{bubbles:true})); showToast('ü™Ñ Titel!');} catch(e){showToast('‚ùå KI Fehler.');} finally{btnEl.textContent='ü™Ñ'; btnEl.disabled=false;} }
  async function generateSmartImageTitle(url, filename = "") { const cN=(filename||url.split('/').pop()).replace(/\.[^/.]+$/,"").toLowerCase().replace(/[-_]/g,' '); if(cN.includes("automat")) return "Verkaufsautomat"; if(cN.includes("huhn")) return "H√ºhner"; if(cN.includes("kuh")) return "K√ºhe"; if(cN.includes("h√ºtte")) return "H√ºtte"; if(cN.includes("hof")) return "Hofansicht"; if(cN.includes("laden")) return "Hofladen"; if(cN.includes("spielplatz")) return "Spielplatz"; if(cN.includes("landschaft")) return "Au√üenansicht"; return cN.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ') || "Detail"; }

  // === TIERE-VERWALTUNG ===
  async function toggleTier(hutId, emoji) { const ref = db.collection('eierhuetten').doc(hutId); let newArr = []; try { await db.runTransaction(async tx => { const doc = await tx.get(ref); if (!doc.exists) throw new Error('H√ºtte nicht gefunden'); let tiere = normalizeToEmojiArray(doc.data().tiere || []); const idx = tiere.indexOf(emoji); if (idx >= 0) tiere.splice(idx, 1); else { tiere = tiere.filter(t => t !== '‚ùå'); if (emoji === '‚ùå') tiere = ['‚ùå']; else tiere.push(emoji); } newArr = tiere; tx.update(ref, { tiere }); }); const hut = allHuts.find(h => h.id === hutId); logAdminAction(`Tiere ge√§ndert: ${newArr.join(', ')}`, { hutId, hutName: hut?.name }); ref.collection('log').add({ admin: currentUser.displayName || currentUser.email, feld: 'tiere', wert: newArr.join(', '), zeitpunkt: new Date() }); /* UI updated by onSnapshot */ } catch (e) { showNotification('‚ùå Fehler Tiere'); console.error(e); } }
  
  // === √ñFFNUNGSZEITEN EDITOR ===
  const DAY_LABELS = [ { key: "mo", label: "Mo" }, { key: "di", label: "Di" }, { key: "mi", label: "Mi" }, { key: "do", label: "Do" }, { key: "fr", label: "Fr" }, { key: "sa", label: "Sa" }, { key: "so", label: "So" } ];
  function renderOpeningHoursEditor(elemId, data = {}) { let html = `<div id="openhours-${elemId}" class="space-y-2 mt-2"><table class="w-full text-sm border rounded"><thead><tr><th>Tag</th><th>Offen</th><th>Von</th><th>Bis</th></tr></thead><tbody>`; DAY_LABELS.forEach(day => { const d = normalizeOpeningHours(data)[day.key] || { open: false, from: "", to: "" }; html += `<tr><td>${day.label}</td><td><input type="checkbox" class="oh-open" data-day="${day.key}" ${d.open?"checked":""}></td><td><input type="time" class="oh-from border rounded px-1 text-sm" data-day="${day.key}" value="${d.from||''}" ${!d.open?"disabled":""}></td><td><input type="time" class="oh-to border rounded px-1 text-sm" data-day="${day.key}" value="${d.to||''}" ${!d.open?"disabled":""}></td></tr>`; }); html += `</tbody></table><p class="text-xs text-gray-500">Leer = geschlossen.</p></div>`; setTimeout(() => attachOpeningHoursListeners(elemId), 0); return html; }
  function attachOpeningHoursListeners(elemId) { const cont = document.getElementById(`openhours-${elemId}`); if (!cont) return; cont.addEventListener("change", (e) => { if (e.target.classList.contains("oh-open")) { const dayK = e.target.dataset.day; const row = e.target.closest("tr"); const fI = row.querySelector(`.oh-from[data-day="${dayK}"]`); const tI = row.querySelector(`.oh-to[data-day="${dayK}"]`); fI.disabled = !e.target.checked; tI.disabled = !e.target.checked; if (!e.target.checked) { fI.value = ""; tI.value = ""; } } }); }
  function collectOpeningHours(elemId) { const wrap = document.getElementById(`openhours-${elemId}`); if (!wrap) return {}; const res = {}; DAY_LABELS.forEach(day => { const oC = wrap.querySelector(`.oh-open[data-day="${day.key}"]`); const fI = wrap.querySelector(`.oh-from[data-day="${day.key}"]`); const tI = wrap.querySelector(`.oh-to[data-day="${day.key}"]`); const open = oC ? oC.checked : false; res[day.key] = { open, from: open ? (fI?.value || "") : "", to: open ? (tI?.value || "") : "" }; }); return res; }
  function normalizeOpeningHours(oeff) { if (typeof oeff === 'object' && oeff.mo && typeof oeff.mo === 'object') return oeff; const res = {}; DAY_LABELS.forEach(day => res[day.key] = { open: false, from: "", to: "" }); if (typeof oeff === 'string' && oeff.toLowerCase().includes('immer')) { DAY_LABELS.forEach(day => res[day.key] = { open: true, from: "00:00", to: "23:59" }); } else if (Array.isArray(oeff)) { oeff.forEach(item => { const key = item.tag?.toLowerCase().substring(0, 2); if (key && res[key]) { res[key] = { open: true, from: item.von || "", to: item.bis || "" }; } }); } else { console.warn("√ñffnungszeiten normalisiert (unbekannt):", oeff); } return res; }

  // === EVENT MANAGEMENT ===
  function renderEventCard(hutId, ev) { const now=new Date(); let sC="bg-gray-200"; let sT="Abgelaufen"; if(ev.endDate?.toDate()>now){if(ev.startDate?.toDate()<=now){sC="bg-green-100 text-green-700 animate-pulse"; sT="L√§uft";}else{sC="bg-yellow-100 text-yellow-700"; sT="Geplant";}} return `<div class="border rounded p-3 bg-white shadow-sm"><div class="flex justify-between"><div class="max-w-[70%]"><h4 class="font-semibold text-purple-800 truncate">${escapeHtml(ev.title)}</h4><p class="text-xs text-gray-500">${ev.startDate?.toDate().toLocaleDateString()}-${ev.endDate?.toDate().toLocaleDateString()}</p><p class="text-sm mt-1 truncate">${escapeHtml(ev.desc||'')}</p></div><div class="flex flex-col items-end gap-1"><span class="text-[10px] font-semibold px-2 py-0.5 rounded ${sC}">${sT}</span><div class="flex gap-1 mt-1"><button onclick="openEventModal('${hutId}','${ev.id}')" class="text-xs bg-blue-500 text-white rounded px-2 py-0.5">‚úèÔ∏è</button><button onclick="deleteEvent('${hutId}','${ev.id}')" class="text-xs bg-red-500 text-white rounded px-2 py-0.5">üóëÔ∏è</button></div></div></div></div>`; }
  async function openEventModal(hutId, eventId = null) {
      const form = document.getElementById('event-modal-form');
      const titleEl = document.getElementById('event-modal-title');
      if (!form || !titleEl || !eventEditModal) return;
      form.reset(); // Formular immer zur√ºcksetzen
      document.getElementById('event-modal-hut-id').value = hutId;
      document.getElementById('event-modal-event-id').value = eventId || '';
      
      if(eventId){
          titleEl.textContent = 'Event bearbeiten';
          try {
              const doc = await db.collection('eierhuetten').doc(hutId).collection('events').doc(eventId).get();
              if(doc.exists){
                  const ev = doc.data();
                  document.getElementById('event-modal-title-input').value = ev.title || '';
                  document.getElementById('event-modal-desc').value = ev.desc || '';
                  document.getElementById('event-modal-start').value = ev.startDate?.toDate().toISOString().slice(0,10) || '';
                  document.getElementById('event-modal-end').value = ev.endDate?.toDate().toISOString().slice(0,10) || '';
              } else { showNotification("Event nicht gefunden."); return; }
          } catch(e) { showNotification("Fehler beim Laden."); return; }
      } else {
          titleEl.textContent = 'Neues Event erstellen';
      }
      eventEditModal.classList.add('flex');
  }
  function closeEventModal() { eventEditModal.classList.remove('flex'); }
  async function saveEventFromModal() { const hutId=document.getElementById('event-modal-hut-id').value; const eventId=document.getElementById('event-modal-event-id').value; const title=document.getElementById('event-modal-title-input').value; const desc=document.getElementById('event-modal-desc').value; const startStr=document.getElementById('event-modal-start').value; const endStr=document.getElementById('event-modal-end').value; if(!hutId||!title||!startStr||!endStr){showNotification('‚ùå Felder fehlen.'); return;} const start=new Date(startStr); const end=new Date(endStr); if(end<start){showNotification('‚ùå Enddatum vor Start.'); return;} const eventData={title,desc,startDate:firebase.firestore.Timestamp.fromDate(start),endDate:firebase.firestore.Timestamp.fromDate(end)}; const eventRef=db.collection('eierhuetten').doc(hutId).collection('events'); try{ if(eventId){await eventRef.doc(eventId).update(eventData); logAdminAction('Event aktualisiert',{hutId,eventId,eventTitle:title}); showNotification('‚úÖ Event aktualisiert.');} else{const ref=await eventRef.add({...eventData,createdAt:firebase.firestore.FieldValue.serverTimestamp()}); logAdminAction('Event erstellt',{hutId,eventId:ref.id,eventTitle:title}); showNotification('‚úÖ Event erstellt.');} closeEventModal(); if(currentEditingHutId===hutId)openHutModal(hutId); } catch(e){showNotification('‚ùå Fehler: '+e.message); console.error(e);} }
  async function deleteEvent(hutId, eventId) { if(!confirm(`Event ${eventId} l√∂schen?`)) return; try{ await db.collection('eierhuetten').doc(hutId).collection('events').doc(eventId).delete(); logAdminAction('Event gel√∂scht',{hutId,eventId}); showNotification('üóëÔ∏è Event gel√∂scht.'); if(currentEditingHutId===hutId)openHutModal(hutId); } catch(e){showNotification('‚ùå Fehler: '+e.message); console.error(e);} }

  // === H√úTTEN NACHRICHTEN ===
   function renderMessageCard(msg) { const d=msg.createdAt?.toDate?.().toLocaleString("de-DE")||"-"; return `<div class="border-b pb-2 mb-2"><div class="flex justify-between text-xs text-gray-500 mb-1"><span>Von: ${escapeHtml(msg.senderName||"Gast")}</span><span>${d}</span></div><p>${escapeHtml(msg.message||"")}</p><button class="text-red-500 text-xs hover:underline mt-1" onclick="deleteHutMessage('${msg.hutId}','${msg.id}')">L√∂schen</button></div>`; }
   async function deleteHutMessage(hutId, msgId) { if(!confirm("Nachricht l√∂schen?"))return; try{ await db.collection("hutMessages").doc(msgId).delete(); logAdminAction('Nachricht gel√∂scht',{hutId, msgId}); showNotification("üóëÔ∏è Nachricht gel√∂scht."); if(currentEditingHutId===hutId)openHutModal(hutId); } catch(err){showNotification("‚ùå Fehler: "+err.message); console.error(err);} }

  // === USER MANAGEMENT ===
  // KORREKTUR: 'let' entfernt, da global deklariert
  // allUsers = []; // Bereits global initialisiert
  // filteredUsers = []; // Bereits global initialisiert
  async function loadUsers() { userTableBody.innerHTML = `<tr><td colspan="6">Lade...</td></tr>`; try { const [pS, bS] = await Promise.all([ db.collection('profiles').get(), db.collection('betreiber').get() ]); const bMap = new Map(bS.docs.map(d => [d.id, d.data()])); allUsers = pS.docs.map(d => { const p = d.data(); const b = bMap.get(d.id) || {}; return { id: d.id, name: p.name || '?', email: p.email || d.id, role: p.role || 'user', hutCount: allHuts.filter(h => h.userId === d.id).length, isPremium: b.premium || false, premiumUntil: b.premium_until || null, lastLogin: p.lastLogin ? new Date(p.lastLogin.seconds * 1000).toLocaleDateString('de-DE') : '-', banned: p.banned || false }; }); applyUserSearchFilter(); } catch (e) { userTableBody.innerHTML = `<tr><td colspan="6" class="text-red-500">Fehler: ${e.message}</td></tr>`; console.error(e); } }
  function applyUserSearchFilter() { const term = document.getElementById('user-search-input').value.toLowerCase(); filteredUsers = term ? allUsers.filter(u => u.name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term)) : allUsers; renderUsersTable(); }
  function renderUsersTable() { userTableBody.innerHTML = ''; if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="6" class="italic">Keine User.</td></tr>`; return; } filteredUsers.forEach(u => { const row = document.createElement('tr'); row.className = `hover:bg-gray-50 ${u.banned ? 'opacity-50 bg-red-50' : ''}`; const pTxt = u.isPremium ? `Ja (${u.premiumUntil ? 'bis '+new Date(u.premiumUntil).toLocaleDateString() : '?'})` : 'Nein'; row.innerHTML = `<td><p>${escapeHtml(u.name)}</p><p class="text-xs text-gray-500">${escapeHtml(u.email)}</p></td> <td><select class="inline-edit-select text-xs" onchange="updateUserRole('${u.id}', this.value)">${['user','mod','admin'].map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}</select></td> <td class="text-center">${u.hutCount}</td> <td class="text-sm">${pTxt}</td> <td class="text-sm">${u.lastLogin}</td> <td> <button onclick="toggleUserBan('${u.id}', ${u.banned})" class="text-xs px-2 py-1 rounded ${u.banned ? 'bg-green-500' : 'bg-red-500'} text-white">${u.banned ? 'Entsperren' : 'Sperren'}</button> <button onclick="openUserProfileForEditing('${u.id}')" class="text-xs ml-1 px-2 py-1 rounded bg-blue-500 text-white">Bearbeiten</button> </td>`; userTableBody.appendChild(row); }); }
  async function updateUserRole(userId, newRole) { try { await db.collection('profiles').doc(userId).update({ role: newRole }); logAdminAction(`User Rolle: ${newRole}`, { userId, profileName: allUsers.find(u=>u.id===userId)?.name }); showNotification("Rolle ok."); loadUsers(); } catch(e) { showNotification("Fehler Rolle."); } }
  async function toggleUserBan(userId, isBanned) { try { await db.collection('profiles').doc(userId).update({ banned: !isBanned }); logAdminAction(`User ${isBanned ? 'entsperrt' : 'gesperrt'}`, { userId, profileName: allUsers.find(u=>u.id===userId)?.name }); showNotification(`User ${isBanned ? 'entsperrt' : 'gesperrt'}.`); loadUsers(); } catch(e) { showNotification("Fehler Sperren."); } }
  function openUserProfileForEditing(userId) { showSection('profiles'); document.getElementById('profile-search').value = userId; loadProfileAdmin(userId); }
  document.querySelector('.nav-btn[onclick="showSection(\'users\')"]')?.addEventListener('click', loadUsers);

  // === NAVIGATION ===
  function showSection(id) { document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden')); document.getElementById(id)?.classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.nav-btn[onclick="showSection('${id}')"]`)?.classList.add('active'); if(id === 'users') loadUsers(); if(id === 'overview') setTimeout(() => dashboardMap?.invalidateSize(), 50); }
  function showNotification(message) { notification.textContent = message; notification.style.display = 'block'; setTimeout(() => notification.style.display = 'none', 4000); }

  // === MODERATIONS-SEITE ===
  function initLiveModerationQueues() {
      db.collection('eierhuetten').where('status','==','offen').onSnapshot(snap=>{ const cont=document.getElementById("neueListe-page"); if(!cont)return; if(snap.empty){cont.innerHTML="<p>Keine neuen.</p>"; return;} cont.innerHTML=""; snap.forEach(doc=>{ const h=doc.data(); const row=document.createElement("div"); row.className="flex items-center justify-between bg-white shadow-sm rounded px-3 py-2 border"; row.innerHTML=`<p class="font-medium truncate max-w-[50%]">${escapeHtml(h.name)}</p><div class="flex space-x-2"><button onclick="quickUpdateStatus('${doc.id}','angenommen')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">Annehmen</button><button onclick="openHutModal('${doc.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Details</button></div>`; cont.appendChild(row); }); });
      db.collection('eierhuetten').onSnapshot(snap=>{ const cont=document.getElementById("pending-fotos-page"); if(!cont)return; const pending=[]; snap.forEach(doc=>{ const d=doc.data(); const wP=(d.fotos||[]).map((f,i)=>({...f,originalIndex:i})).filter(f=>f&&typeof f==='object'&&f.status==='wartet'); if(wP.length>0)pending.push({id:doc.id,name:d.name,wP}); }); if(pending.length===0){cont.innerHTML="<p>Keine Fotos offen.</p>"; return;} cont.innerHTML=""; pending.forEach(hut=>{ const row=document.createElement("div"); row.className="bg-white shadow-sm rounded p-3 border"; row.innerHTML=`<div class="flex justify-between mb-2"><p class="font-medium">${escapeHtml(hut.name)}</p><button onclick="openHutModal('${hut.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Anzeigen</button></div><div class="flex flex-wrap gap-2">${hut.wP.map(f=>`<div class="relative w-16 h-16 rounded border"><img src="${f.url}" class="object-cover w-full h-full"><div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 hover:opacity-100 transition"><button onclick="approveFoto('${hut.id}',${f.originalIndex})" class="text-white text-lg">‚úî</button><button onclick="rejectFoto('${hut.id}',${f.originalIndex})" class="text-white text-lg ml-2">‚úñ</button></div></div>`).join('')}</div>`; cont.appendChild(row); }); });
  }
  async function bulkApproveHuts() { const ids=Array.from(document.querySelectorAll('#neueListe-page button[onclick^="quickUpdateStatus"]')).map(b=>b.onclick.toString().match(/'([^']+)'/)[1]); if(!ids.length||!confirm(`${ids.length} H√ºtten freigeben?`)) return; for(const id of ids){await quickUpdateStatus(id,'angenommen');} showNotification(`${ids.length} H√ºtten frei.`); }

  // === SUPPORT-SYSTEM ===
  let currentSupportTickets = []; let allSupportTickets = []; const SUPPORT_MSG_MAX = 500;
  const CANNED_RESPONSES = [ { title: "Standard Begr√º√üung", text: "Hallo,\nvielen Dank f√ºr Ihre Nachricht. Wir k√ºmmern uns darum.\n\nViele Gr√º√üe,\nIhr Team" }, { title: "Standort Korrektur", text: "Hallo,\ndanke f√ºr den Hinweis. Wir haben das gepr√ºft & korrigiert.\n\nViele Gr√º√üe" }, { title: "√ñffnungszeiten Frage", text: "Hallo,\ndie √ñffnungszeiten werden vom Betreiber gepflegt. Am besten kurz vor dem Besuch nochmal pr√ºfen.\n\nViele Gr√º√üe" } ];
  function initLiveSupportQueue() { db.collection('support').orderBy('createdAt','desc').onSnapshot(snap=>{ allSupportTickets=snap.docs.map(d=>({id:d.id,...d.data()})); applySupportFilters(); const oC=allSupportTickets.filter(t=>t.status==='offen').length; const b=document.getElementById('support-queue-badge'); b.textContent=oC; b.classList.toggle('hidden',oC===0); if(currentEditingSupportTicketId&&supportReplyModal.classList.contains('flex')){openReplyModal(currentEditingSupportTicketId);} }, err=>console.error("Support Listener:", err)); }
  function applySupportFilters() { const sT=document.getElementById('support-search').value.toLowerCase(); const sF=document.getElementById('support-status-filter').value; const pF=document.getElementById('support-priority-filter').value; currentSupportTickets=allSupportTickets.filter(t=>{ const sM=(t.mail?.toLowerCase().includes(sT)||t.internalNotes?.some(n=>n.text?.toLowerCase().includes(sT)) || t.msg?.toLowerCase().includes(sT)); const stM=(sF==="")||(t.status===sF); const pM=(pF==="")||((t.priority||'Normal')===pF); return sM&&stM&&pM; }); renderSupportTable(); }
  function renderSupportTable() { supportTicketsBody.innerHTML = ''; if(currentSupportTickets.length===0){supportTicketsBody.innerHTML='<tr><td colspan="6" class="text-center italic py-4">Keine Tickets.</td></tr>'; return;} currentSupportTickets.forEach(t=>{ const id=t.id; const d=t.createdAt?.toDate().toLocaleString('de-DE')||'-'; const e=t.mail||'-'; const s=t.status||'offen'; const p=t.priority||'Normal'; const row=document.createElement('tr'); row.className=`align-top hover:bg-gray-50 priority-${p}`; row.innerHTML=`<td class="px-4 py-2 font-semibold">${p}</td><td class="px-4 py-2 text-xs">${d}</td><td class="px-4 py-2 text-xs">${escapeHtml(e)}</td><td class="px-4 py-2 text-xs"><div id="msgs-preview-${id}" class="max-h-16 overflow-hidden">...</div></td><td class="px-4 py-2"><span class="text-xs px-2 py-1 rounded ${s==='offen'?'bg-yellow-100 text-yellow-700':'bg-gray-100'}">${escapeHtml(s)}</span></td><td class="px-4 py-2"><button onclick="openReplyModal('${id}')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">√ñffnen</button></td>`; supportTicketsBody.appendChild(row); loadSupportMessagePreview(id); }); }
  async function loadSupportMessagePreview(tId) { const pEl=document.getElementById(`msgs-preview-${tId}`); if(!pEl)return; try{ const mS=await db.collection("support").doc(tId).collection("messages").orderBy("createdAt","desc").limit(1).get(); if(!mS.empty){const lM=mS.docs[0].data(); pEl.textContent=`${lM.sender==='Admin'?'Admin: ':''}${lM.text||''}`;} else { const ticketDoc = await db.collection("support").doc(tId).get(); pEl.textContent = ticketDoc.data()?.msg || "(Keine Nachrichten)";} } catch(e){pEl.textContent="(Fehler)";} }
  async function openReplyModal(tId) { currentEditingSupportTicketId=tId; const t=allSupportTickets.find(t=>t.id===tId); if(!t){showNotification("Ticket nicht da"); return;} const modalContent = supportReplyModal.querySelector('.modal-content'); if(!modalContent) { supportReplyModal.innerHTML = '<div class="modal-content max-w-2xl">...</div>'; modalContent = supportReplyModal.querySelector('.modal-content'); } modalContent.innerHTML = `<div class="modal-header"><h3 class="text-lg font-bold">Ticket bearbeiten</h3><button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div class="modal-body grid grid-cols-1 md:grid-cols-2 gap-6"><div id="support-modal-left"></div><div id="support-modal-right"></div></div><div class="modal-footer flex justify-between"><button onclick="deleteSupportTicketFromModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">Ticket L√∂schen</button><div class="flex gap-2"><button onclick="closeReplyModal()" class="px-4 py-2 bg-gray-300 rounded-lg text-sm">Abbrechen</button><button id="saveSupportBtn" onclick="saveSupportTicketChanges()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">Speichern</button></div></div>`; document.getElementById("support-modal-left").innerHTML = `<div id="modal-ticket-info" class="text-sm text-gray-500 mb-2">ID: ${tId} ¬∑ User: ${escapeHtml(t.mail||'-')}</div><div id="ai-ticket-analysis-area" class="mb-4 hidden"><p class="font-medium text-sm">KI Analyse:</p><p id="ai-ticket-summary" class="text-sm my-1"></p><p id="ai-ticket-category" class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full inline-block"></p></div><div id="modal-message-history" class="space-y-3 max-h-60 overflow-y-auto border rounded p-3 mb-4 bg-gray-50">‚è≥...</div><h4 class="font-semibold mb-2">Antworten:</h4><textarea id="modal-reply-text" rows="4" maxlength="500" placeholder="Antwort..." class="w-full border p-2 rounded mb-2"></textarea><div id="modal-reply-counter" class="text-xs text-right">${SUPPORT_MSG_MAX} Z.</div><div class="flex items-center gap-2 mt-2 mb-2"><select id="canned-response-select" class="flex-grow border p-1 rounded text-sm bg-white"><option value="">Vordefiniert...</option></select><button onclick="insertCannedResponse()" class="text-xs bg-gray-200 px-2 py-1 rounded">Einf.</button></div><button id="ai-reply-btn" onclick="generateSupportReplySuggestion()" class="w-full mt-2 px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">‚ú® KI-Antwort</button><div id="ai-reply-suggestion-area" class="hidden mt-2 p-2 bg-green-50 border rounded text-sm"><p class="font-medium">Vorschlag:</p><p id="ai-reply-suggestion-text"></p><button onclick="useAISuggestion()" class="text-xs bg-gray-200 px-2 py-0.5 rounded mt-1">√úbernehmen</button></div>`; document.getElementById("support-modal-right").innerHTML = `<div class="space-y-4"><div><label>Status</label><select id="modal-ticket-status" class="w-full border p-2 rounded"></select></div><div><label>Prio</label><select id="modal-ticket-priority" class="w-full border p-2 rounded">${['Niedrig','Normal','Hoch'].map(p=>`<option value="${p}" ${p===(t.priority||'Normal')?'selected':''}>${p}</option>`).join('')}</select></div><div><h4>Interne Notizen</h4><div id="modal-internal-notes-history" class="max-h-40 overflow-y-auto border rounded p-2 mb-2 bg-gray-50 text-xs"></div><textarea id="modal-internal-note" rows="3" placeholder="Notiz..." class="w-full border p-2 rounded"></textarea></div></div>`; document.getElementById("modal-ticket-status").innerHTML = ['offen','bearbeitet','geschlossen','archiviert'].map(o=>`<option value="${o}" ${o===(t.status||'offen')?'selected':''}>${o}</option>`).join(''); const cannedSelect = document.getElementById('canned-response-select'); if(cannedSelect) { cannedSelect.innerHTML = '<option value="">Vordefiniert...</option>' + CANNED_RESPONSES.map((r, i) => `<option value="${i}">${r.title}</option>`).join(''); } const msgHistEl=document.getElementById("modal-message-history"); const notesHistEl=document.getElementById("modal-internal-notes-history"); analyzeTicketWithGemini(tId, t); _supportMessageUnsubs.get(tId)?.(); const unsub=db.collection("support").doc(tId).collection("messages").orderBy("createdAt","asc").onSnapshot(snap=>{msgHistEl.innerHTML=snap.docs.map(doc=>{const d=doc.data(); const time=d.createdAt?.toDate().toLocaleString()||''; const iA=d.sender==='Admin'; return `<div class="p-2 rounded ${iA?'bg-blue-50':'bg-gray-100'}"><p>${escapeHtml(d.text||'')}</p><p class="text-xs text-right opacity-70">${iA?'Admin':'User'} - ${time}</p></div>`;}).join('')||(t.msg ? `<div class="p-2 rounded bg-gray-100"><p>${escapeHtml(t.msg)}</p><p class="text-xs text-right opacity-70">User - ${t.createdAt?.toDate().toLocaleString()||''}</p></div>` : '<p>Keine Nachrichten.</p>'); msgHistEl.scrollTop=msgHistEl.scrollHeight;}, err=>{msgHistEl.innerHTML='<p class="text-red-500">Fehler.</p>'; console.error(err);}); _supportMessageUnsubs.set(tId,unsub); notesHistEl.innerHTML=(t.internalNotes||[]).map(n=>`<div class="border-b pb-1 mb-1"><p>${escapeHtml(n.text||'')}</p><p class="text-xs text-right">${escapeHtml(n.adminName||'A')} - ${n.timestamp?.toDate().toLocaleString()||''}</p></div>`).join('')||'<p>Keine Notizen.</p>'; notesHistEl.scrollTop=notesHistEl.scrollHeight; supportReplyModal.classList.add('flex'); }
  function closeReplyModal() { _supportMessageUnsubs.get(currentEditingSupportTicketId)?.(); _supportMessageUnsubs.delete(currentEditingSupportTicketId); supportReplyModal.classList.remove('flex'); currentEditingSupportTicketId=null; }
  async function saveSupportTicketChanges() { const sB=document.getElementById('saveSupportBtn'); sB.disabled=true; sB.classList.add('button-loading'); const tId=currentEditingSupportTicketId; if(!tId)return; const rTxt=document.getElementById("modal-reply-text").value.trim(); const iTxt=document.getElementById("modal-internal-note").value.trim(); const nS=document.getElementById("modal-ticket-status").value; const nP=document.getElementById("modal-ticket-priority").value; try{ const tRef=db.collection("support").doc(tId); let upds={status:nS, priority:nP}; let aL=[`Status: ${nS}`,`Prio: ${nP}`]; if(rTxt){await tRef.collection("messages").add({text:rTxt, sender:"Admin", createdAt:firebase.firestore.FieldValue.serverTimestamp()}); aL.push("Antwort");} if(iTxt){upds.internalNotes=firebase.firestore.FieldValue.arrayUnion({text:iTxt, adminName:currentUser.displayName||currentUser.email, timestamp:firebase.firestore.FieldValue.serverTimestamp()}); aL.push("Notiz");} await tRef.update(upds); logAdminAction(`Support bearbeitet: ${aL.join(', ')}`,{ticketId:tId}); showNotification("‚úÖ Ticket aktualisiert."); document.getElementById("modal-reply-text").value=""; document.getElementById("modal-internal-note").value=""; document.getElementById('ai-reply-suggestion-area').classList.add('hidden'); } catch(err){alert("Fehler: "+err.message);} finally{sB.disabled=false; sB.classList.remove('button-loading');} }
  function deleteSupportTicketFromModal() { const tId=currentEditingSupportTicketId; if(tId){deleteSupport(tId); closeReplyModal();} }
  async function deleteSupport(tId) { if(!confirm(`Ticket ${tId} l√∂schen?`)) return; try{ _supportMessageUnsubs.get(tId)?.(); _supportMessageUnsubs.delete(tId); await db.collection('support').doc(tId).delete(); logAdminAction(`Support gel√∂scht`,{ticketId:tId}); showNotification("üóëÔ∏è Ticket weg"); } catch(err){showNotification('‚ùå Fehler: '+err.message); console.error(err);} }
  document.getElementById("modal-reply-text")?.addEventListener("input", e=>{ const left=SUPPORT_MSG_MAX-e.target.value.length; document.getElementById("modal-reply-counter").innerText=`${left} Zeichen`; });
  function insertCannedResponse() { const sel = document.getElementById('canned-response-select'); const idx = sel.value; const ta = document.getElementById('modal-reply-text'); if (idx !== "" && ta && CANNED_RESPONSES[idx]) { ta.value += (ta.value ? '\n\n' : '') + CANNED_RESPONSES[idx].text; ta.dispatchEvent(new Event('input', { bubbles: true })); sel.value = ""; } }
  
   // === GEMINI API CALL ===
   async function callGeminiAPI(systemPrompt, userQuery) {
       const apiKey = "AIzaSyB3FT8CdN9WkNjfQ5vutbjLCEibGSl3nnQ"; // Provided Key
       const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
       const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
        for (let i = 0; i < 3; i++) { try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.text(); console.error(`Gemini API Error (${response.status}):`, errorBody); try { const errorJson = JSON.parse(errorBody); throw new Error(errorJson.error?.message || `API Error ${response.status}`); } catch { throw new Error(`API Error ${response.status}: ${response.statusText}`); } } const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text; if (text) return text.trim(); console.warn("No text in Gemini response:", result); throw new Error("Leere Antwort von Gemini."); } catch (error) { console.error(`Gemini Versuch ${i+1} fehlgeschlagen:`, error.message); if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); else throw error; } } throw new Error("Gemini API konnte nach 3 Versuchen nicht erreicht werden.");
    }

   // === GEMINI INTEGRATION FUNCTIONS ===
   async function generateSupportReplySuggestion() {
       const aiBtn = document.getElementById('ai-reply-btn'); const suggestionArea = document.getElementById('ai-reply-suggestion-area'); const suggestionTextEl = document.getElementById('ai-reply-suggestion-text');
       if (!currentEditingSupportTicketId || !aiBtn || !suggestionArea || !suggestionTextEl) return;
       aiBtn.disabled = true; aiBtn.classList.add('button-loading'); suggestionTextEl.textContent = 'Denke...'; suggestionArea.classList.remove('hidden');
       try {
           const historyElements = document.querySelectorAll('#modal-message-history > div'); let historyText = "Verlauf:\n";
           historyElements.forEach(el => { const sender = el.querySelector('.opacity-70')?.textContent.split('-')[0].trim() || '?'; const msg = el.querySelector('p:not(.opacity-70)')?.textContent || ''; historyText += `${sender}: ${msg}\n`; });
           const systemPrompt = "Antworte als freundlicher Support f√ºr RadlMap (Hofl√§den/H√ºtten). Gib einen kurzen, hilfreichen Antwortvorschlag auf die LETZTE Nachricht. Max 2 S√§tze.";
           const userQuery = `${historyText}\n---\nAntwortvorschlag:`;
           const suggestion = await callGeminiAPI(systemPrompt, userQuery);
           suggestionTextEl.textContent = suggestion; suggestionArea.classList.remove('hidden');
       } catch (error) { suggestionTextEl.textContent = 'Fehler.'; console.error("AI Reply Error:", error); } 
       finally { aiBtn.disabled = false; aiBtn.classList.remove('button-loading'); }
   }
   function useAISuggestion() { const suggestion = document.getElementById('ai-reply-suggestion-text')?.textContent; const replyTA = document.getElementById('modal-reply-text'); if (suggestion && replyTA) { replyTA.value = suggestion; replyTA.dispatchEvent(new Event('input', { bubbles: true })); document.getElementById('ai-reply-suggestion-area').classList.add('hidden'); } }
   async function callGeminiGenerateDescription(d) { const systemPrompt = "Erstelle eine ansprechende, kurze Beschreibung (max 3 Abs√§tze) f√ºr den Ort. Ton: einladend, leicht werblich."; const details = `Name: ${d.name||'-'} Typ: ${d.typ||'-'} Extras: ${d.extras||'-'} Tiere: ${(d.tiere||[]).join(', ')} Tags: ${(d.tags||[]).join(', ')}`; return callGeminiAPI(systemPrompt, details); }
   async function callGeminiGenerateTags(data) { const systemPrompt = "Analysiere Name & Beschreibung. Schlage max. 10 relevante Tags (kurz, Komma-getrennt) vor."; const inputText = `Name: ${data.name||''}\nBeschreibung: ${stripHtml(data.beschreibung||'')}`; const tagString = await callGeminiAPI(systemPrompt, inputText); return tagString.split(',').map(t => t.trim()).filter(Boolean); }
   async function analyzeTicketWithGemini(ticketId, ticketData) { const analysisArea = document.getElementById('ai-ticket-analysis-area'); const summaryEl = document.getElementById('ai-ticket-summary'); const categoryEl = document.getElementById('ai-ticket-category'); if (!analysisArea || !summaryEl || !categoryEl) return; analysisArea.classList.remove('hidden'); summaryEl.textContent = 'Analysiere...'; categoryEl.textContent = ''; try { const msgSnap = await db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "desc").limit(5).get(); let historyText = "Konversation:\n"; msgSnap.docs.reverse().forEach(doc => { const d = doc.data(); historyText += `${d.sender === 'Admin' ? 'Support' : 'User'}: ${d.text}\n`; }); if (!msgSnap.docs.length && ticketData.msg) { historyText += `User: ${ticketData.msg}\n`; } const systemPrompt = "Analysiere Ticket. Erstelle 1 Satz Zusammenfassung. Schlage EINE Kategorie vor: Standortproblem, √ñffnungszeiten, Feedback, Technisches Problem, Foto-Problem, Sonstiges."; const userQuery = `${historyText}\n---\nZusammenfassung und Kategorie:`; const result = await callGeminiAPI(systemPrompt, userQuery); const lines = result.split('\n'); const summary = lines[0] || result; let category = "Sonstiges"; const categoryLine = lines.find(line => line.toLowerCase().includes("kategorie:")); if (categoryLine) { category = categoryLine.split(':')[1]?.trim() || category; const allowed = ["Standortproblem", "√ñffnungszeiten", "Feedback", "Technisches Problem", "Foto-Problem", "Sonstiges"]; if (!allowed.includes(category)) category = "Sonstiges"; } summaryEl.textContent = `Zfg: ${summary}`; categoryEl.textContent = `Kat: ${category}`; } catch (error) { summaryEl.textContent = 'Fehler.'; console.error("AI Ticket Analysis Error:", error); } }

  // === USER MANAGEMENT ===
  // KORREKTUR: 'let' entfernt, da global deklariert
  async function loadUsers() { userTableBody.innerHTML = `<tr><td colspan="6">Lade...</td></tr>`; try { const [pS, bS] = await Promise.all([ db.collection('profiles').get(), db.collection('betreiber').get() ]); const bMap = new Map(bS.docs.map(d => [d.id, d.data()])); allUsers = pS.docs.map(d => { const p = d.data(); const b = bMap.get(d.id) || {}; return { id: d.id, name: p.name || '?', email: p.email || d.id, role: p.role || 'user', hutCount: allHuts.filter(h => h.userId === d.id).length, isPremium: b.premium || false, premiumUntil: b.premium_until || null, lastLogin: p.lastLogin ? new Date(p.lastLogin.seconds * 1000).toLocaleDateString('de-DE') : '-', banned: p.banned || false }; }); applyUserSearchFilter(); } catch (e) { userTableBody.innerHTML = `<tr><td colspan="6" class="text-red-500">Fehler: ${e.message}</td></tr>`; console.error(e); } }
  function applyUserSearchFilter() { const term = document.getElementById('user-search-input').value.toLowerCase(); filteredUsers = term ? allUsers.filter(u => u.name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term)) : allUsers; renderUsersTable(); }
  function renderUsersTable() { userTableBody.innerHTML = ''; if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="6" class="italic">Keine User.</td></tr>`; return; } filteredUsers.forEach(u => { const row = document.createElement('tr'); row.className = `hover:bg-gray-50 ${u.banned ? 'opacity-50 bg-red-50' : ''}`; const pTxt = u.isPremium ? `Ja (${u.premiumUntil ? 'bis '+new Date(u.premiumUntil).toLocaleDateString() : '?'})` : 'Nein'; row.innerHTML = `<td><p>${escapeHtml(u.name)}</p><p class="text-xs text-gray-500">${escapeHtml(u.email)}</p></td> <td><select class="inline-edit-select text-xs" onchange="updateUserRole('${u.id}', this.value)">${['user','mod','admin'].map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}</select></td> <td class="text-center">${u.hutCount}</td> <td class="text-sm">${pTxt}</td> <td class="text-sm">${u.lastLogin}</td> <td> <button onclick="toggleUserBan('${u.id}', ${u.banned})" class="text-xs px-2 py-1 rounded ${u.banned ? 'bg-green-500' : 'bg-red-500'} text-white">${u.banned ? 'Entsperren' : 'Sperren'}</button> <button onclick="openUserProfileForEditing('${u.id}')" class="text-xs ml-1 px-2 py-1 rounded bg-blue-500 text-white">Bearbeiten</button> </td>`; userTableBody.appendChild(row); }); }
  async function updateUserRole(userId, newRole) { try { await db.collection('profiles').doc(userId).update({ role: newRole }); logAdminAction(`User Rolle: ${newRole}`, { userId, profileName: allUsers.find(u=>u.id===userId)?.name }); showNotification("Rolle ok."); loadUsers(); } catch(e) { showNotification("Fehler Rolle."); } }
  async function toggleUserBan(userId, isBanned) { try { await db.collection('profiles').doc(userId).update({ banned: !isBanned }); logAdminAction(`User ${isBanned ? 'entsperrt' : 'gesperrt'}`, { userId, profileName: allUsers.find(u=>u.id===userId)?.name }); showNotification(`User ${isBanned ? 'entsperrt' : 'gesperrt'}.`); loadUsers(); } catch(e) { showNotification("Fehler Sperren."); } }
  function openUserProfileForEditing(userId) { showSection('profiles'); document.getElementById('profile-search').value = userId; loadProfileAdmin(userId); }
  document.querySelector('.nav-btn[onclick="showSection(\'users\')"]')?.addEventListener('click', loadUsers);

  // === PROFIL-VERWALTUNG ===
  let currentProfileId = null;
  async function loadProfileAdmin(id) { if(!id)id=document.getElementById('profile-selected-id')?.value; if(!id)return; currentProfileId=id; try{ const [pS,bS]=await Promise.all([db.collection("profiles").doc(id).get(), db.collection("betreiber").doc(id).get()]); if(!pS.exists){alert("Profil nicht da"); document.getElementById("profile-admin-area").classList.add("hidden"); return;} const pD=pS.data(); const bD=bS.data()||{}; const profileArea = document.getElementById("profile-admin-area"); profileArea.innerHTML = `<div><img id="profile-pic-admin" class="w-24 h-24 rounded-full border" src="${pD.pic||'https://placehold.co/96x96'}"><input id="profile-pic-url" class="w-full mt-2 border p-2 rounded" value="${pD.pic||''}" placeholder="Bild-URL..."></div> <input id="profile-name-admin" class="w-full border p-2 rounded" value="${escapeAttr(pD.name||'')}"> <textarea id="profile-bio-admin" class="w-full border p-2 rounded" placeholder="Bio...">${escapeHtml(pD.bio||'')}</textarea> <label>Titel</label> <select id="profile-title-admin" class="w-full border p-2 rounded"></select> <label>Abzeichen</label> <div id="profile-badges-admin" class="flex flex-wrap gap-2"></div> <label>Rolle</label> <select id="profile-role-admin" class="w-full border p-2 rounded"> <option value="user">User</option> <option value="admin">Admin</option> <option value="mod">Mod</option> </select> <label><input id="profile-banned-admin" type="checkbox" ${pD.banned?'checked':''}> Gesperrt</label> <div id="profile-stats">${`Fahrten: ${pD.rides||0} | Km: ${pD.km||0}`}</div> <div id="premium-section" class="mt-4 pt-4 border-t"><label class="font-bold">Premium</label><div class="flex items-center gap-4"><label><input id="profile-premium-admin" type="checkbox" ${bD.premium?'checked':''}> Aktiv</label><div><label>Bis:</label><input id="profile-premium-until-admin" type="date" class="border rounded p-1 ml-1 text-sm" value="${bD.premium_until?bD.premium_until.split('T')[0]:''}"></div></div></div> <div class="flex gap-2"> <button onclick="saveProfileAdmin()" class="bg-green-600 text-white px-3 py-1 rounded">Speichern</button> <button onclick="deleteProfileAdmin()" class="bg-red-600 text-white px-3 py-1 rounded">L√∂schen</button> </div>`; profileArea.classList.remove("hidden"); profileArea.querySelector("#profile-role-admin").value=pD.role||"user"; const tS=profileArea.querySelector("#profile-title-admin"); tS.innerHTML="<option value=''>Kein Titel</option>"; const tSn=await db.collection("titles").get(); tSn.forEach(d=>{const opt=document.createElement("option"); opt.value=d.data().name; opt.textContent=d.data().name; tS.appendChild(opt);}); tS.value=pD.title||""; const bC=profileArea.querySelector("#profile-badges-admin"); bC.innerHTML=""; const bSn=await db.collection("badgesDefs").get(); bSn.forEach(d=>{const b=d.data(); const w=document.createElement('label'); w.className='inline-flex items-center gap-1 mr-2'; const c=document.createElement("input"); c.type="checkbox"; c.value=d.id; c.checked=(pD.badges||[]).includes(d.id); w.appendChild(c); const l=document.createElement("span"); l.textContent=`${b.icon||"üèÖ"} ${b.name}`; w.appendChild(l); bC.appendChild(w); }); } catch(e){console.error("Profile Load Error:",e); showNotification("Fehler Profil.");} }
  async function saveProfileAdmin() { if(!currentProfileId)return; const sB=event.target; sB.disabled=true; sB.classList.add('button-loading'); try{ const badges=[...document.querySelectorAll("#profile-badges-admin input:checked")].map(i=>i.value); const pUpd={name:document.getElementById("profile-name-admin").value, pic:document.getElementById("profile-pic-url").value, bio:document.getElementById("profile-bio-admin").value, title:document.getElementById("profile-title-admin").value, role:document.getElementById("profile-role-admin").value, banned:document.getElementById("profile-banned-admin").checked, badges:badges}; const prem=document.getElementById("profile-premium-admin").checked; const premUStr=document.getElementById("profile-premium-until-admin").value; const premU=premUStr?new Date(premUStr).toISOString():null; const bUpd={premium:prem, premium_until:premU}; await Promise.all([db.collection("profiles").doc(currentProfileId).update(pUpd), db.collection("betreiber").doc(currentProfileId).set(bUpd,{merge:true})]); logAdminAction('Profil gespeichert',{profileId:currentProfileId, profileName:pUpd.name, premium:prem}); showNotification("‚úîÔ∏è Profil gespeichert!");} catch(e){showNotification("‚ùå Fehler: "+e.message); console.error(e);} finally{sB.disabled=false; sB.classList.remove('button-loading');} }
  async function deleteProfileAdmin() { if(!currentProfileId)return; const name=document.getElementById('profile-name-admin')?.value||currentProfileId; if(!confirm(`Profil "${name}" l√∂schen?`)) return; try{ await db.collection("profiles").doc(currentProfileId).delete(); await db.collection("betreiber").doc(currentProfileId).delete(); logAdminAction('Profil gel√∂scht',{profileId:currentProfileId, profileName:name}); showNotification("üóëÔ∏è Profil weg!"); document.getElementById("profile-admin-area").classList.add("hidden"); currentProfileId=null; document.getElementById('profile-search').value=''; } catch(e) { showNotification("‚ùå L√∂schfehler Profil."); } }
  document.getElementById('profile-search')?.addEventListener('input', async e=>{ const q=e.target.value.trim(); const box=document.getElementById('profile-suggestions'); if(q.length<2){box.classList.add('hidden'); return;} const snap=await db.collection('profiles').orderBy('name').startAt(q).endAt(q+'\uf8ff').limit(5).get(); box.innerHTML=snap.empty?"<p>Nix</p>":snap.docs.map(d=>`<div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectProfile('${d.id}','${escapeAttr(d.data().name)}')">${escapeHtml(d.data().name)}</div>`).join(''); box.classList.remove('hidden'); });
  window.selectProfile=(id, name)=>{ document.getElementById('profile-search').value=name; document.getElementById('profile-selected-id').value=id; document.getElementById('profile-suggestions').classList.add('hidden'); loadProfileAdmin(id); };

  // === TITEL & ABZEICHEN ===
  let titleEditId = null; let badgeEditId = null; async function loadTitles() { const list = document.getElementById("title-list"); if (!list) return; try { const snap = await db.collection("titles").get(); list.innerHTML = ""; snap.forEach(doc => { const t = doc.data(); list.innerHTML += `<div class="p-2 border rounded flex justify-between text-sm"><span><strong>${t.name}</strong> (${t.conditionType} ‚â• ${t.conditionValue})</span><div class="space-x-1"><button onclick="editTitle('${doc.id}', '${escapeAttr(t.name)}', '${t.conditionType}', ${t.conditionValue})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚úèÔ∏è</button><button onclick="deleteTitle('${doc.id}', '${escapeAttr(t.name)}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button></div></div>`; }); } catch (e) { list.innerHTML = "<p class='text-red-500'>Fehler.</p>"; } }
  window.editTitle = (id, name, type, value) => { titleEditId = id; document.getElementById("title-name").value = name; document.getElementById("title-condition").value = type; document.getElementById("title-value").value = value; };
  window.deleteTitle = async (id, name) => { if (!confirm(`Titel "${name}" l√∂schen?`)) return; try { await db.collection("titles").doc(id).delete(); logAdminAction('Titel gel√∂scht', { titleId: id, titleName: name }); showNotification('Titel gel√∂scht'); loadTitles(); } catch(e) { showNotification("Fehler"); } };
  document.getElementById("title-form")?.addEventListener("submit", async (e) => { e.preventDefault(); const payload = { name: document.getElementById("title-name").value.trim(), conditionType: document.getElementById("title-condition").value, conditionValue: parseInt(document.getElementById("title-value").value) || 0 }; if (!payload.name) return; try { if (titleEditId) { await db.collection("titles").doc(titleEditId).update(payload); logAdminAction('Titel aktualisiert', { titleId: titleEditId, titleName: payload.name }); } else { const ref = await db.collection("titles").add(payload); logAdminAction('Titel erstellt', { titleId: ref.id, titleName: payload.name }); } titleEditId = null; e.target.reset(); loadTitles(); } catch(e) { showNotification("Fehler"); } });
  async function loadBadges() { const list = document.getElementById("badge-list-admin"); if (!list) return; try { const snap = await db.collection("badgesDefs").get(); list.innerHTML = ""; snap.forEach(doc => { const b = doc.data(); const icon = b.iconUrl ? `<img src="${b.iconUrl}" class="w-5 h-5 inline rounded">` : (b.icon || "üèÖ"); list.innerHTML += `<div class="p-2 border rounded flex justify-between text-sm"><span>${icon} <strong>${b.name}</strong> (${b.conditionType} ‚â• ${b.conditionValue})</span><div class="space-x-1"><button onclick="editBadge('${doc.id}', '${escapeAttr(b.name)}', '${escapeAttr(b.icon)}', '${b.conditionType}', ${b.conditionValue})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚úèÔ∏è</button><button onclick="deleteBadge('${doc.id}', '${escapeAttr(b.name)}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">üóëÔ∏è</button></div></div>`; }); } catch (e) { list.innerHTML = "<p class='text-red-500'>Fehler.</p>"; } }
  window.editBadge = (id, name, icon, type, value) => { badgeEditId = id; document.getElementById("badge-name").value = name; document.getElementById("badge-icon").value = icon; document.getElementById("badge-condition").value = type; document.getElementById("badge-value").value = value; document.getElementById('badge-icon-file').value = ''; };
  window.deleteBadge = async (id, name) => { if (!confirm(`Abzeichen "${name}" l√∂schen?`)) return; try { await db.collection("badgesDefs").doc(id).delete(); logAdminAction('Abzeichen gel√∂scht', { badgeId: id, badgeName: name }); showNotification('Abzeichen gel√∂scht'); loadBadges(); } catch(e) { showNotification("Fehler"); } };
  document.getElementById("badge-form")?.addEventListener("submit", async (e) => { e.preventDefault(); const payload = { name: document.getElementById("badge-name").value.trim(), icon: document.getElementById("badge-icon").value.trim(), conditionType: document.getElementById("badge-condition").value, conditionValue: parseInt(document.getElementById("badge-value").value) || 0, iconUrl: '' }; if (!payload.name) return; const fileInput = document.getElementById("badge-icon-file"); if (fileInput.files.length > 0) { try { payload.iconUrl = await badgeFormUploadToImgBB(fileInput.files[0]); } catch (err) { alert("‚ùå Upload Fehler"); return; } } if (!payload.icon && !payload.iconUrl) payload.icon = 'üèÖ'; try { if (badgeEditId) { await db.collection("badgesDefs").doc(badgeEditId).update(payload); logAdminAction('Abzeichen aktualisiert', { badgeId: badgeEditId, badgeName: payload.name }); } else { const ref = await db.collection("badgesDefs").add(payload); logAdminAction('Abzeichen erstellt', { badgeId: ref.id, badgeName: payload.name }); } badgeEditId = null; e.target.reset(); loadBadges(); } catch(e) { showNotification("Fehler"); } });
  async function badgeFormUploadToImgBB(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async () => { const b64 = reader.result.split(",")[1]; const fd = new FormData(); fd.append("key", IMGBB_KEY); fd.append("image", b64); try { const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: fd }); const json = await res.json(); if (json?.data?.url) resolve(json.data.url); else reject("ImgBB Error"); } catch (err) { reject(err); } }; reader.onerror = () => reject("File Read Error"); reader.readAsDataURL(file); }); }
  document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]')?.addEventListener('click', () => { loadTitles(); loadBadges(); });
   
   // === MEIN ADMIN ACCOUNT ===
   function showMyAccount() { const accS = document.getElementById('my-account'); if (!currentUser || !accS) return; accS.innerHTML = `<h2 class="section-title">‚öôÔ∏è Mein Admin-Account</h2><div class="card max-w-lg mx-auto"><div class="flex items-center space-x-4 mb-6"><img src="${currentUser.photoURL || 'https://placehold.co/64x64'}" class="w-16 h-16 rounded-full border"><div><p class="font-semibold">${escapeHtml(currentUser.displayName||'Admin')}</p><p class="text-sm text-gray-500">${escapeHtml(currentUser.email)}</p></div></div><p class="text-sm text-gray-600">Ihre Anmeldeinfos.</p></div>`; }

   // === DATA EXPORT ===
   function exportHutsToCSV() { if (filteredHuts.length === 0) { showNotification("Keine Daten zum Export."); return; } const headers = ["ID", "Name", "Typ", "Status", "ErstelltAm", "UserID", "UserMail", "Lat", "Lng", "Strom", "Sitzpl√§tze", "Extras", "Tags", "Tiere", "Views", "RouteStarts", "AdminNotes"]; const rows = filteredHuts.map(h => [ h.id, h.name, h.typ, h.status, h.erstelltAm?.toDate().toISOString(), h.userId, h.userMail, h.location?.latitude, h.location?.longitude, h.strom, h.sitzplaetze, h.extras, (h.tags || []).join(';'), (h.tiere || []).join(';'), h.views || 0, h.routeStarts || 0, h.adminNotes || '' ]); let csv = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r => r.map(c => `"${String(c || '').replace(/"/g, '""')}"`).join(",")).join("\n"); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "huetten_export.csv"); link.click(); link.remove(); logAdminAction("CSV Export", { count: filteredHuts.length }); }

  // === HILFSFUNKTIONEN ===
  function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function escapeAttr(s) { if (!s && s !== 0) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  function stripHtml(html){ if(!html) return ''; let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
  
  // === KI (GEMINI) FUNKTIONEN ===
  async function callGeminiAPI(systemPrompt, userQuery) { const apiKey = "AIzaSyB3FT8CdN9WkNjfQ5vutbjLCEibGSl3nnQ"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; for (let i = 0; i < 3; i++) { try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.text(); console.error(`Gemini API Error (${response.status}):`, errorBody); try { const errorJson = JSON.parse(errorBody); throw new Error(errorJson.error?.message || `API Error ${response.status}`); } catch { throw new Error(`API Error ${response.status}: ${response.statusText}`); } } const result = await response.json(); const text = result.candidates?.[0]?.content?.parts?.[0]?.text; if (text) return text.trim(); console.warn("No text in Gemini response:", result); throw new Error("Leere Antwort von Gemini."); } catch (error) { console.error(`Gemini Versuch ${i+1} fehlgeschlagen:`, error.message); if (i < 2) await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); else throw error; } } throw new Error("Gemini API konnte nach 3 Versuchen nicht erreicht werden."); }
  async function generateSupportReplySuggestion() { const aiBtn = document.getElementById('ai-reply-btn'); const suggestionArea = document.getElementById('ai-reply-suggestion-area'); const suggestionTextEl = document.getElementById('ai-reply-suggestion-text'); if (!currentEditingSupportTicketId || !aiBtn || !suggestionArea || !suggestionTextEl) return; aiBtn.disabled = true; aiBtn.classList.add('button-loading'); suggestionTextEl.textContent = 'Denke...'; suggestionArea.classList.remove('hidden'); try { const historyElements = document.querySelectorAll('#modal-message-history > div'); let historyText = "Verlauf:\n"; historyElements.forEach(el => { const sender = el.querySelector('.opacity-70')?.textContent.split('-')[0].trim() || '?'; const msg = el.querySelector('p:not(.opacity-70)')?.textContent || ''; historyText += `${sender}: ${msg}\n`; }); const systemPrompt = "Antworte als freundlicher Support f√ºr RadlMap (Hofl√§den/H√ºtten). Gib einen kurzen, hilfreichen Antwortvorschlag auf die LETZTE Nachricht. Max 2 S√§tze."; const userQuery = `${historyText}\n---\nAntwortvorschlag:`; const suggestion = await callGeminiAPI(systemPrompt, userQuery); suggestionTextEl.textContent = suggestion; suggestionArea.classList.remove('hidden'); } catch (error) { suggestionTextEl.textContent = 'Fehler.'; console.error("AI Reply Error:", error); } finally { aiBtn.disabled = false; aiBtn.classList.remove('button-loading'); } }
  function useAISuggestion() { const suggestion = document.getElementById('ai-reply-suggestion-text')?.textContent; const replyTA = document.getElementById('modal-reply-text'); if (suggestion && replyTA) { replyTA.value = suggestion; replyTA.dispatchEvent(new Event('input', { bubbles: true })); document.getElementById('ai-reply-suggestion-area').classList.add('hidden'); } }
  async function callGeminiGenerateDescription(d) { const systemPrompt = "Erstelle eine ansprechende, kurze Beschreibung (max 3 Abs√§tze) f√ºr den Ort. Ton: einladend, leicht werblich."; const details = `Name: ${d.name||'-'} Typ: ${d.typ||'-'} Extras: ${d.extras||'-'} Tiere: ${(d.tiere||[]).join(', ')} Tags: ${(d.tags||[]).join(', ')}`; return callGeminiAPI(systemPrompt, details); }
  async function callGeminiGenerateTags(data) { const systemPrompt = "Analysiere Name & Beschreibung. Schlage max. 10 relevante Tags (kurz, Komma-getrennt) vor."; const inputText = `Name: ${data.name||''}\nBeschreibung: ${stripHtml(data.beschreibung||'')}`; const tagString = await callGeminiAPI(systemPrompt, inputText); return tagString.split(',').map(t => t.trim()).filter(Boolean); }
  async function analyzeTicketWithGemini(ticketId, ticketData) { const analysisArea = document.getElementById('ai-ticket-analysis-area'); const summaryEl = document.getElementById('ai-ticket-summary'); const categoryEl = document.getElementById('ai-ticket-category'); if (!analysisArea || !summaryEl || !categoryEl) return; analysisArea.classList.remove('hidden'); summaryEl.textContent = 'Analysiere...'; categoryEl.textContent = ''; try { const msgSnap = await db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "desc").limit(5).get(); let historyText = "Konversation:\n"; msgSnap.docs.reverse().forEach(doc => { const d = doc.data(); historyText += `${d.sender === 'Admin' ? 'Support' : 'User'}: ${d.text}\n`; }); if (!msgSnap.docs.length && ticketData.msg) { historyText += `User: ${ticketData.msg}\n`; } const systemPrompt = "Analysiere Ticket. Erstelle 1 Satz Zusammenfassung. Schlage EINE Kategorie vor: Standortproblem, √ñffnungszeiten, Feedback, Technisches Problem, Foto-Problem, Sonstiges."; const userQuery = `${historyText}\n---\nZusammenfassung und Kategorie:`; const result = await callGeminiAPI(systemPrompt, userQuery); const lines = result.split('\n'); const summary = lines[0] || result; let category = "Sonstiges"; const categoryLine = lines.find(line => line.toLowerCase().includes("kategorie:")); if (categoryLine) { category = categoryLine.split(':')[1]?.trim() || category; const allowed = ["Standortproblem", "√ñffnungszeiten", "Feedback", "Technisches Problem", "Foto-Problem", "Sonstiges"]; if (!allowed.includes(category)) category = "Sonstiges"; } summaryEl.textContent = `Zfg: ${summary}`; categoryEl.textContent = `Kat: ${category}`; } catch (error) { summaryEl.textContent = 'Fehler.'; console.error("AI Ticket Analysis Error:", error); } }

</script>
</body>
</html>
