<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Generelle Stil-Anpassungen */
    body { font-family: 'Inter', sans-serif; }
    .nav-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-align: left;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
      font-weight: 500;
      color: #374151; /* gray-700 */
    }
    .nav-btn:hover { background-color: #f3f4f6; /* gray-100 */ }
    .nav-btn.active {
      background-color: #10b981; /* emerald-500 */
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937; /* gray-800 */
    }
    .card {
      background-color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    
    /* Leaflet Karten-Stil */
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    
    /* Modal Stile */
    .modal-backdrop {
        position: fixed; inset: 0; z-index: 40;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex; align-items: center; justify-content: center;
        padding: 1rem;
    }
    .modal-content {
        background: white; border-radius: 0.75rem; padding: 2rem;
        width: 100%; max-width: 48rem; /* 768px */
        max-height: 90vh; overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    
    /* Notification */
    #notification {
      position: fixed; top: 1rem; right: 1rem;
      background: #38bdf8; color: white;
      padding: 1rem; border-radius: 0.5rem; display: none;
      z-index: 9999; max-width: 300px;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    /* Lade-Spinner */
    .spinner {
      border: 4px solid #f3f4f6; /* gray-100 */
      border-top: 4px solid #10b981; /* emerald-500 */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an, um fortzufahren.</p>
      <button id="login-btn"
        class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full">
        Mit Google Anmelden
      </button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- üü¶ Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4">
        <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1>
      </div>
      <nav class="flex-1 space-y-2">
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä √úbersicht</button>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile</button>
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets</button>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Titel & Abzeichen</button>
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200">
         <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div>
         <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button>
      </div>
    </aside>

    <!-- üü© Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      
      <!-- √úbersicht -->
      <section id="overview" class="space-y-8">
        <div>
          <h2 class="section-title">Willkommen zur√ºck!</h2>
          <p class="text-gray-600">Hier ist ein √úberblick √ºber die aktuellen Aktivit√§ten.</p>
        </div>

        <!-- Statistiken -->
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <!-- Stat-Karten werden hier via JS geladen -->
        </div>
        
        <!-- Moderations-Warteschlange -->
        <div class="card">
            <h3 class="font-bold text-lg mb-4">Moderations-Warteschlange</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">üÜï Neue Eintragungen</h4>
                    <div id="neueListe" class="space-y-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-md border"></div>
                </div>
                 <div>
                    <h4 class="font-semibold mb-2">üì∑ Fotos warten auf Freigabe</h4>
                    <div id="pending-fotos" class="space-y-2 max-h-64 overflow-y-auto p-2 bg-gray-50 rounded-md border"></div>
                </div>
            </div>
        </div>

        <!-- Diagramme & Aktivit√§ten -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 card">
             <h3 class="font-bold text-lg mb-4">H√ºtten-Registrierungen (Letzte 30 Tage)</h3>
             <canvas id="registrationsChart"></canvas>
          </div>
          <div class="lg:col-span-2 card">
              <h3 class="font-bold text-lg mb-4">Letzte Admin-Aktivit√§ten</h3>
              <div id="admin-log-list" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y divide-gray-100">
                <!-- Log-Eintr√§ge werden hier via JS geladen -->
              </div>
          </div>
        </div>
      </section>

      <!-- H√ºttenliste -->
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-title">üè† Alle H√ºtten verwalten</h2>
            <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-emerald-700 transition">+ H√ºtte hinzuf√ºgen</button>
        </div>
        <div class="card">
            <div class="flex items-center gap-4 mb-4">
              <select id="sortSelect" class="p-2 border rounded-md bg-white">
                <option value="name">üî§ Nach Name</option>
                <option value="erstelltAm">üïí Neueste zuerst</option>
              </select>
              <input id="search-input" placeholder="üîç Suchen nach Name, Status etc." class="p-2 border rounded-md w-full">
            </div>
            <div id="hut-list" class="space-y-3">
                <!-- H√ºtten-Liste wird hier via JS geladen -->
            </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      
      <!-- Support-Tickets -->
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-left">
              <tr>
                <th class="px-4 py-2 font-semibold">Datum</th>
                <th class="px-4 py-2 font-semibold">User</th>
                <th class="px-4 py-2 font-semibold">Nachrichten</th>
                <th class="px-4 py-2 font-semibold">Status</th>
                <th class="px-4 py-2 font-semibold">Aktionen</th>
              </tr>
            </thead>
            <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Profile -->
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile Verwaltung</h2>
        <div class="card">
          <div class="relative max-w-md">
            <input id="profile-search" type="text" class="w-full border p-2 rounded-md" placeholder="Profil nach Name suchen..." />
            <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded-md shadow-lg hidden z-10"></div>
          </div>
          <div id="profile-admin-area" class="hidden space-y-4 mt-6 border-t pt-6">
            <!-- Profil-Details werden hier geladen -->
          </div>
        </div>
      </section>
      
      <!-- Gamification: Titel & Abzeichen -->
      <section id="gamification" class="hidden space-y-8">
          <h2 class="section-title">üèÜ Titel & Abzeichen verwalten</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Titel -->
              <div class="card">
                  <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel Verwaltung</h3>
                  <div id="title-list" class="space-y-2"></div>
                  <form id="title-form" class="mt-4 space-y-2 border-t pt-4">
                    <input id="title-name" placeholder="Titel-Name" class="border p-2 rounded w-full">
                    <select id="title-condition" class="border p-2 rounded w-full">
                      <option value="rides">Anzahl Fahrten</option>
                      <option value="distance">Gesamtkilometer</option>
                    </select>
                    <input id="title-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full">
                    <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Titel speichern</button>
                  </form>
              </div>
              <!-- Abzeichen -->
              <div class="card">
                  <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen Verwaltung</h3>
                  <div id="badge-list-admin" class="space-y-2"></div>
                  <form id="badge-form" class="mt-4 space-y-2 border-t pt-4">
                    <input id="badge-name" placeholder="Abzeichen-Name" class="border p-2 rounded w-full">
                    <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    <input id="badge-icon" placeholder="Emoji/Icon (Fallback)" class="border p-2 rounded w-full">
                    <select id="badge-condition" class="border p-2 rounded w-full">
                      <option value="rides">Anzahl Fahrten</option>
                      <option value="distance">Gesamtkilometer</option>
                      <option value="night">Nachtfahrt</option>
                    </select>
                    <input id="badge-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full">
                    <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded-lg w-full">Abzeichen speichern</button>
                  </form>
              </div>
          </div>
      </section>
    </main>
  </div>
  
  <!-- Modals (versteckt) -->
  <div id="support-reply-modal" class="modal-backdrop hidden">
      <div class="modal-content">
        <h3 class="text-lg font-bold mb-2">Antwort auf Ticket</h3>
        <div id="modal-ticket-info" class="text-sm text-gray-500 mb-4"></div>
        <textarea id="modal-reply-text" class="w-full border p-2 rounded-md mb-2" rows="5" maxlength="500"></textarea>
        <div class="text-xs text-gray-500 mb-4" id="modal-reply-counter">500 Zeichen √ºbrig</div>
        <div class="flex justify-end gap-2">
          <button onclick="closeReplyModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Abbrechen</button>
          <button onclick="sendReply()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">Antworten & schlie√üen</button>
        </div>
      </div>
  </div>

  <div id="hut-edit-modal" class="modal-backdrop hidden">
      <div id="hut-edit-modal-content" class="modal-content">
        <!-- Inhalt wird dynamisch via JS gef√ºllt -->
        <div class="flex justify-center items-center h-64">
            <div class="spinner"></div>
        </div>
      </div>
  </div>
  
  <!-- Das ist der Platzhalter f√ºr die Admin-Karte, die f√ºr das Hinzuf√ºgen neuer H√ºtten ben√∂tigt wird -->
  <div id="admin-map-container" style="display:none;"></div>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // === GLOBALE VARIABLEN ===
  let currentUser = null;
  let allHuts = [];
  let filteredHuts = [];
  let currentPage = 1;
  const hutsPerPage = 15;
  let currentEditingHutId = null;
  let registrationsChartInstance;
  let adminModalMap;
  let adminModalMarker;
  let adminModalLocation; // Speichert GeoPoint f√ºr Modal-Bearbeitung

  // === DOM-ELEMENTE ===
  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  const hutList = document.getElementById('hut-list');
  const searchInput = document.getElementById('search-input');
  const sortSelect = document.getElementById('sortSelect');
  const notification = document.getElementById('notification');
  const statsContainer = document.getElementById('statsContainer');
  const hutEditModal = document.getElementById('hut-edit-modal');
  const hutEditModalContent = document.getElementById('hut-edit-modal-content');
  const adminUserInfo = document.getElementById('admin-user-info');

  // === TIERE MAPPING (Normalisierung) ===
  const TIERE_EMOJI_TO_NAME = {
    "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege",
    "üêë": "Schaf", "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase",
    "üêî": "Huhn", "ü¶Ü": "Ente", "üê¥": "Pferd", "‚ùå": "Keine Tiere"
  };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries(
    Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e])
  );

  function normalizeToEmojiArray(arr) {
    if (!Array.isArray(arr)) return [];
    return arr.map(v => {
      if (!v) return null;
      v = String(v).trim();
      if (TIERE_EMOJI_TO_NAME[v]) return v; // already emoji
      if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; // name -> emoji
      return null;
    }).filter(Boolean);
  }
  
  // === INITIALISIERUNG & AUTH ===
  document.getElementById('login-btn').onclick = () => {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  };
  
  document.getElementById('logout-btn').onclick = () => {
    auth.signOut();
  };

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      const adminDoc = await db.collection('admins').doc(user.email).get();
      if (!adminDoc.exists) {
        alert('Zugriff verweigert: Du bist kein Admin.');
        auth.signOut();
        return;
      }
      adminUserInfo.textContent = `Angemeldet als ${user.displayName || user.email}`;
      loginSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      
      // Event Listeners f√ºr Suche/Sortierung
      searchInput.addEventListener('input', applySearchAndSort);
      sortSelect.addEventListener('change', applySearchAndSort);

      // Starte alle Live-Listener
      initHutsListener(); // Diese ersetzt das alte loadHuts()
      initLiveNewHuts();
      initLivePendingFotos();
      ladeSupportTickets();
      loadAdminLogs();
      
      showSection('overview'); // Starte auf der √úbersichtsseite
    } else {
      currentUser = null;
      loginSection.classList.remove('hidden');
      dashboard.classList.add('hidden');
      adminUserInfo.textContent = '';
    }
  });

  // === ADMIN LOGGING (NEUE FUNKTION) ===
  async function logAdminAction(action, hutId = null, hutName = null) {
      if (!currentUser) return;
      try {
          await db.collection('adminLogs').add({
              adminEmail: currentUser.email,
              adminName: currentUser.displayName || 'N/A',
              action: action,
              hutId: hutId,
              hutName: hutName,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch (e) {
          console.error("Fehler beim Schreiben des Admin-Logs:", e);
      }
  }

  function loadAdminLogs() {
      const logList = document.getElementById('admin-log-list');
      db.collection('adminLogs').orderBy('timestamp', 'desc').limit(15)
        .onSnapshot(snapshot => {
            if (snapshot.empty) {
                logList.innerHTML = '<p class="text-gray-500 italic">Keine Aktivit√§ten protokolliert.</p>';
                return;
            }
            logList.innerHTML = snapshot.docs.map(doc => {
                const log = doc.data();
                const time = log.timestamp?.toDate().toLocaleString('de-DE') || '';
                return `
                <div class="pt-2">
                    <p class="font-medium">${log.action}</p>
                    <p class="text-gray-600">${log.hutName ? `H√ºtte: ${log.hutName}` : ''}</p>
                    <p class="text-xs text-gray-400">${log.adminName} - ${time}</p>
                </div>
                `;
            }).join('');
        }, err => {
            console.error("Fehler beim Laden der Admin-Logs:", err);
            logList.innerHTML = '<p class="text-red-500">Fehler beim Laden der Logs.</p>';
        });
  }

  // === DATENLADEN & STATISTIKEN ===
  
  // Haupt-Listener f√ºr H√ºtten
  function initHutsListener() {
    db.collection('eierhuetten').onSnapshot(snapshot => {
      allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Wende aktuelle Filter und Sortierung an
      applySearchAndSort(); 
      
      // Statistiken und Diagramme aktualisieren
      renderStats(allHuts);
      renderRegistrationsChart(allHuts);

      // Wenn ein Modal ge√∂ffnet ist, aktualisiere dessen Inhalt
      if (currentEditingHutId) {
          openHutModal(currentEditingHutId);
      }
      
      showNotification('üîÑ Live-Update: H√ºttendaten aktualisiert.');
    }, err => {
      console.error("Fehler beim H√ºtten-Listener:", err);
      showNotification('‚ùå Fehler beim Laden der H√ºtten.');
    });
  }

  function renderStats(list) {
    const total = list.length;
    const withStrom = list.filter(h => h.strom === 'Ja').length;
    const withFotos = list.filter(h => Array.isArray(h.fotos) && h.fotos.length > 0).length;
    const count247 = list.filter(h => h.oeffnungszeiten === '24/7').length;
    const newEntries = list.filter(h => h.status === 'offen').length;
    const pendingFotos = list.reduce((sum, h) =>
        sum + (Array.isArray(h.fotos)
               ? h.fotos.filter(f => f.status === 'wartet').length
               : 0), 0);
               
    statsContainer.innerHTML = `
      <div class="card text-center">
        <p class="text-3xl font-bold">${total}</p>
        <p class="text-gray-500">Gesamt&nbsp;H√ºtten</p>
      </div>
      <div class="card text-center ${newEntries > 0 ? 'bg-yellow-50' : ''}">
        <p class="text-3xl font-bold ${newEntries > 0 ? 'text-yellow-600' : ''}">${newEntries}</p>
        <p class="text-gray-500">Neue&nbsp;Eintragungen</p>
      </div>
      <div class="card text-center ${pendingFotos > 0 ? 'bg-blue-50' : ''}">
        <p class="text-3xl font-bold ${pendingFotos > 0 ? 'text-blue-600' : ''}">${pendingFotos}</p>
        <p class="text-gray-500">wartende&nbsp;Fotos</p>
      </div>
      <div class="card text-center">
        <p class="text-3xl font-bold">${withStrom}</p>
        <p class="text-gray-500">mit&nbsp;Strom</p>
      </div>
      <div class="card text-center">
        <p class="text-3xl font-bold">${count247}</p>
        <p class="text-gray-500">24/7 ge√∂ffnet</p>
      </div>
    `;
  }
  
  // Neues Diagramm f√ºr Registrierungen
  function renderRegistrationsChart(list) {
      const ctx = document.getElementById('registrationsChart').getContext('2d');
      const today = new Date();
      const labels = [];
      const data = [];
      
      for (let i = 29; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          labels.push(d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }));
          data.push(0);
      }
      
      list.forEach(hut => {
          const hutDate = hut.erstelltAm?.toDate();
          if (!hutDate) return;
          
          const diffTime = Math.abs(today - hutDate);
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays < 30) {
              const index = 29 - diffDays;
              data[index]++;
          }
      });
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: 'Neue H√ºtten',
          data: data,
          backgroundColor: 'rgba(16, 185, 129, 0.2)', // emerald-500/20
          borderColor: 'rgba(16, 185, 129, 1)', // emerald-500
          borderWidth: 2,
          fill: true,
          tension: 0.1
        }]
      };

      if (registrationsChartInstance) {
          registrationsChartInstance.data = chartData;
          registrationsChartInstance.update();
      } else {
          registrationsChartInstance = new Chart(ctx, { type: 'line', data: chartData });
      }
  }

  // === H√úTTEN-HAUPTLISTE (NEU: Nur Zusammenfassung) ===
  
  function applySearchAndSort() {
    const search = searchInput.value.toLowerCase() || "";
    const sortBy = sortSelect.value || "name";

    filteredHuts = allHuts.filter(hut => {
      const name = hut.name?.toLowerCase() || "";
      const status = hut.status?.toLowerCase() || "";
      return name.includes(search) || status.includes(search);
    });

    filteredHuts.sort((a, b) => {
      if (sortBy === "name") {
        return (a.name || "").localeCompare(b.name || "");
      }
      if (sortBy === "erstelltAm") {
        const timeA = a.erstelltAm?.toMillis() || 0;
        const timeB = b.erstelltAm?.toMillis() || 0;
        return timeB - timeA;
      }
      return 0;
    });

    currentPage = 1;
    renderPage(currentPage);
  }

  function renderPage(page) {
    const start = (page - 1) * hutsPerPage;
    const end = start + hutsPerPage;
    const source = filteredHuts.length ? filteredHuts : allHuts;
    const hutsToRender = source.slice(start, end);

    renderHutsList(hutsToRender);
    renderPagination(source.length);
  }

  function renderHutsList(list) {
    hutList.innerHTML = '';
    if (list.length === 0) {
        hutList.innerHTML = '<p class="text-gray-500 italic">Keine H√ºtten gefunden.</p>';
        return;
    }
    list.forEach(hut => {
      const el = document.createElement('div');
      el.className = 'bg-white p-3 rounded-lg shadow-sm border flex justify-between items-center';
      
      let statusColor = 'bg-gray-200 text-gray-700';
      if (hut.status === 'angenommen') statusColor = 'bg-green-100 text-green-700';
      if (hut.status === 'offen') statusColor = 'bg-yellow-100 text-yellow-700';
      if (hut.status === 'abgelehnt') statusColor = 'bg-red-100 text-red-700';
      
      el.innerHTML = `
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-emerald-700 truncate">${hut.name || 'Unbenannte H√ºtte'}</p>
          <p class="text-sm text-gray-500">
            ${hut.erstelltAm?.toDate().toLocaleDateString('de-DE') || 'Kein Datum'}
          </p>
        </div>
        <div class="flex items-center gap-4 ml-4">
            <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">
              ${hut.status || 'N/A'}
            </span>
            <button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700">
              Bearbeiten
            </button>
        </div>
      `;
      hutList.appendChild(el);
    });
  }
  
  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / hutsPerPage);
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = '';
    if (totalPages <= 1) return;

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 border rounded-md mx-1 ${i === currentPage ? 'bg-emerald-600 text-white' : 'bg-white'}`;
        btn.onclick = () => {
          currentPage = i;
          renderPage(currentPage);
        };
        paginationContainer.appendChild(btn);
    }
  }
  
  // === H√úTTEN-MODAL (NEU: Bearbeitungs-Popup) ===

  function closeHutModal() {
    hutEditModal.classList.add('hidden');
    hutEditModalContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="spinner"></div></div>'; // Reset
    currentEditingHutId = null;
    adminModalMap = null; // Map-Instanz zerst√∂ren
    adminModalLocation = null;
  }

  async function openHutModal(hutId) {
      currentEditingHutId = hutId;
      let hut;
      let title = "Neue H√ºtte erstellen";

      if (hutId) {
          hut = allHuts.find(h => h.id === hutId);
          if (!hut) {
              showNotification('‚ùå Fehler: H√ºtte nicht gefunden.');
              return;
          }
          title = `H√ºtte bearbeiten: ${hut.name}`;
      } else {
          // Vorlage f√ºr neue H√ºtte
          hut = {
              id: null, name: 'Neue H√ºtte', status: 'angenommen',
              beschreibung: '', strom: 'Nein', sitzplaetze: 'Nein',
              tiere: [], tags: [], fotos: [], location: null,
              erstelltAm: null
          };
      }
      
      // Lade Logs f√ºr diese H√ºtte
      let logs = [];
      if (hutId) {
        try {
            const logSnap = await db.collection('eierhuetten').doc(hutId).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get();
            logs = logSnap.docs.map(doc => doc.data());
        } catch (e) { console.error("Fehler beim Log-Laden:", e); }
      }

      // --- HTML f√ºr Modal-Inhalt ---
      
      // Tiere
      const selectedEmojis = new Set(normalizeToEmojiArray(hut.tiere || []));
      const tiereHTML = Object.entries(TIERE_EMOJI_TO_NAME).map(([emoji, name]) => `
        <button type="button" data-emoji="${emoji}"
          class="admin-tiere-btn text-2xl rounded p-2 ${selectedEmojis.has(emoji) ? 'bg-yellow-200 ring-2 ring-yellow-400' : 'bg-gray-100 hover:bg-gray-200'}"
          title="${name}">
          ${emoji}
        </button>
      `).join('');
      
      // Fotos
      const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];
      const fotosFreigegeben = fotos.map((f, i) => (typeof f === 'string' ? { url: f, status: 'freigegeben' } : f))
                                    .filter(f => f.status === 'freigegeben');
      const fotosWartend = fotos.map((f, i) => ({ ...f, originalIndex: i }))
                                .filter(f => typeof f === 'object' && f.status === 'wartet');

      // --- Setze Modal-HTML ---
      hutEditModalContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${title}</h2>
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Linke Spalte: Stammdaten -->
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-1">Name</label>
                        <input id="modal-hut-name" class="w-full border p-2 rounded-md" value="${hut.name || ''}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Status</label>
                        <select id="modal-hut-status" class="w-full border p-2 rounded-md bg-white">
                            ${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Beschreibung</label>
                        <textarea id="modal-hut-beschreibung" class="w-full border p-2 rounded-md" rows="3">${hut.beschreibung || ''}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-semibold mb-1">Strom</label>
                            <select id="modal-hut-strom" class="w-full border p-2 rounded-md bg-white">
                                ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block font-semibold mb-1">Sitzpl√§tze</label>
                            <select id="modal-hut-sitzplaetze" class="w-full border p-2 rounded-md bg-white">
                                ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Tiere</label>
                        <div id="modal-tiere-container" class="flex flex-wrap gap-2">${tiereHTML}</div>
                    </div>
                </div>
                
                <!-- Rechte Spalte: Karte -->
                <div>
                    <label class="block font-semibold mb-1">Standort</label>
                    <div id="modal-map" class="minimap"></div>
                    <p class="text-xs text-gray-500 mt-1">Marker ziehen, um Standort zu √§ndern.</p>
                </div>
            </div>
            
            <!-- Foto-Sektion -->
            <div>
                <h3 class="font-semibold text-lg border-t pt-4 mb-2">Fotos</h3>
                <label class="block mb-2 text-sm">üì∑ Neues Bild hochladen (wird automatisch zur Freigabe markiert):</label>
                <input type="file" accept="image/*" onchange="initImageUpload(this, '${hut.id}')" class="w-full border p-2 rounded file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4" />

                ${fotosWartend.length > 0 ? `
                    <h4 class="font-medium mb-2">Warten auf Freigabe (${fotosWartend.length})</h4>
                    <div class="flex flex-wrap gap-2 mb-4 p-2 bg-yellow-50 border border-yellow-200 rounded-md">
                        ${fotosWartend.map(f => `
                          <div class="relative w-24 h-24 rounded overflow-hidden border-2 border-yellow-400">
                            <img src="${f.url}" alt="wartet" class="object-cover w-full h-full" />
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/60 opacity-0 hover:opacity-100 transition">
                              <button onclick="approveFoto('${hut.id}', ${f.originalIndex})" class="bg-green-600 mb-1 px-2 py-1 rounded">‚úî</button>
                              <button onclick="rejectFoto('${hut.id}', ${f.originalIndex})" class="bg-red-600 px-2 py-1 rounded">‚úñ</button>
                            </div>
                          </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <h4 class="font-medium mb-2">Freigegebene Fotos (${fotosFreigegeben.length})</h4>
                <div class="flex flex-wrap gap-2 p-2 bg-gray-50 border rounded-md">
                    ${fotosFreigegeben.length > 0 ? fotosFreigegeben.map(f => `
                        <div class="relative w-24 h-24 rounded overflow-hidden border">
                          <img src="${f.url}" alt="Foto" class="object-cover w-full h-full" />
                          <button onclick="rejectFoto('${hut.id}', ${fotos.findIndex(orig => orig.url === f.url)})" title="Foto l√∂schen" 
                                  class="absolute top-0 right-0 bg-red-600 text-white rounded-bl px-1 text-sm font-bold hover:bg-red-700 opacity-50 hover:opacity-100 transition">√ó</button>
                        </div>
                    `).join('') : '<p class="text-gray-500 italic">Keine freigegebenen Fotos.</p>'}
                </div>
            </div>
            
            <!-- Log-Sektion -->
            ${hutId ? `
            <div>
                <details class="mt-3">
                  <summary class="font-semibold cursor-pointer">Bearbeitungs-Log (${logs.length})</summary>
                  <ul class="text-xs max-h-48 overflow-auto mt-2 border p-2 rounded-md bg-gray-50">
                    ${logs.map(log => `
                      <li class="py-1 border-b"><strong>${log.admin}</strong> √§nderte <em>${log.feld}</em> 
                      auf <code>${log.wert || ''}</code> 
                      am ${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</li>
                    `).join('')}
                  </ul>
                </details>
            </div>
            ` : ''}
            
            <!-- Buttons -->
            <div class="flex justify-between items-center border-t pt-6 mt-6">
                <div>
                    ${hutId ? `<button onclick="deleteHut('${hut.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">H√ºtte l√∂schen</button>` : ''}
                </div>
                <div class="flex gap-4">
                    <button onclick="closeHutModal()" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400">Abbrechen</button>
                    <button onclick="saveHutFromModal()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-700">Speichern</button>
                </div>
            </div>
        </div>
      `;

      // Modal anzeigen
      hutEditModal.classList.remove('hidden');
      
      // Karte initialisieren (NACHDEM das Modal sichtbar ist)
      initModalMap(hut.location);
      
      // Event-Listener f√ºr Tiere-Buttons im Modal
      document.getElementById('modal-tiere-container').addEventListener('click', e => {
          const btn = e.target.closest('.admin-tiere-btn');
          if (!btn) return;
          const emoji = btn.dataset.emoji;
          if (hut.id && emoji) {
              // Toggle-Funktion direkt aufrufen
              toggleTier(hut.id, emoji);
              // UI optimistisch aktualisieren (wird durch Snapshot-Listener sowieso korrigiert)
              btn.classList.toggle('bg-yellow-200');
              btn.classList.toggle('ring-2');
              btn.classList.toggle('ring-yellow-400');
              btn.classList.toggle('bg-gray-100');
          } else if (!hut.id) {
              // Bei NEUER H√ºtte nur UI toggeln, Speicherung erfolgt mit "Speichern"
              btn.classList.toggle('bg-yellow-200');
              btn.classList.toggle('ring-2');
              btn.classList.toggle('ring-yellow-400');
              btn.classList.toggle('bg-gray-100');
          }
      });
  }
  
  function initModalMap(location) {
      // Standard-Standort (Mitte DE), falls keine Location
      let lat = location?.latitude || 51.1657;
      let lng = location?.longitude || 10.4515;
      let zoom = location ? 13 : 6;
      
      // Globalen Standort f√ºr Speicherung setzen
      adminModalLocation = location ? new firebase.firestore.GeoPoint(lat, lng) : null;

      // Warte kurz, bis das Modal gerendert ist
      setTimeout(() => {
          try {
            adminModalMap = L.map('modal-map').setView([lat, lng], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminModalMap);
            
            adminModalMarker = L.marker([lat, lng], { draggable: true }).addTo(adminModalMap);
            
            adminModalMarker.on('dragend', e => {
                const pos = e.target.getLatLng();
                adminModalLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
            });
            
            adminModalMap.invalidateSize(); // WICHTIG f√ºr Modals
          } catch(e) {
              console.error("Leaflet-Fehler im Modal:", e);
              document.getElementById('modal-map').innerHTML = '<p class="text-red-500">Karten-Fehler. Bitte neu laden.</p>';
          }
      }, 100); // 100ms Verz√∂gerung
  }

  // === H√úTTEN-CRUD (CREATE, READ, UPDATE, DELETE) ===

  async function saveHutFromModal() {
      const name = document.getElementById('modal-hut-name').value;
      const status = document.getElementById('modal-hut-status').value;
      const beschreibung = document.getElementById('modal-hut-beschreibung').value;
      const strom = document.getElementById('modal-hut-strom').value;
      const sitzplaetze = document.getElementById('modal-hut-sitzplaetze').value;
      
      if (!name) {
          showNotification('‚ùå Name ist ein Pflichtfeld.');
          return;
      }
      if (!adminModalLocation) {
          showNotification('‚ùå Bitte einen Standort auf der Karte w√§hlen.');
          return;
      }
      
      // Tiere auslesen (nur relevant f√ºr NEUE H√ºtten)
      let tiere = [];
      if (!currentEditingHutId) {
          document.querySelectorAll('#modal-tiere-container .admin-tiere-btn').forEach(btn => {
              if (btn.classList.contains('bg-yellow-200')) {
                  tiere.push(btn.dataset.emoji);
              }
          });
      }

      const data = {
          name, status, beschreibung, strom, sitzplaetze,
          location: adminModalLocation,
      };

      try {
          if (currentEditingHutId) {
              // Bestehende H√ºtte aktualisieren
              const hutRef = db.collection('eierhuetten').doc(currentEditingHutId);
              await hutRef.update(data);
              
              // Log-Eintr√§ge f√ºr ge√§nderte Felder
              const oldHut = allHuts.find(h => h.id === currentEditingHutId);
              Object.keys(data).forEach(key => {
                  if (JSON.stringify(oldHut[key]) !== JSON.stringify(data[key])) {
                      logAdminAction(`Feld '${key}' ge√§ndert`, currentEditingHutId, data.name);
                      // Detailliertes Log in der H√ºtte selbst
                      hutRef.collection('log').add({
                          admin: currentUser.displayName || currentUser.email,
                          feld: key,
                          wert: (typeof data[key] === 'object') ? JSON.stringify(data[key]) : data[key],
                          zeitpunkt: new Date()
                      });
                  }
              });
              
              showNotification('‚úÖ H√ºtte erfolgreich aktualisiert.');
          } else {
              // Neue H√ºtte erstellen
              data.erstelltAm = firebase.firestore.FieldValue.serverTimestamp();
              data.userId = currentUser.uid;
              data.fotos = []; // Leeres Foto-Array
              data.tiere = tiere; // Tiere aus Modal-Auswahl
              
              const docRef = await db.collection('eierhuetten').add(data);
              logAdminAction('Neue H√ºtte erstellt', docRef.id, data.name);
              showNotification('‚úÖ Neue H√ºtte erfolgreich erstellt.');
          }
          
          closeHutModal();
          // onSnapshot wird die Liste automatisch aktualisieren
          
      } catch (e) {
          console.error("Fehler beim Speichern der H√ºtte:", e);
          showNotification('‚ùå Fehler beim Speichern: ' + e.message);
      }
  }
  
  // Wird von den schnellen Buttons im Dashboard (√úbersicht) genutzt
  async function quickUpdateStatus(hutId, status) {
    if (!confirm(`‚ö†Ô∏è H√ºtte wirklich auf "${status}" setzen?`)) return;
    
    try {
        const hutRef = db.collection('eierhuetten').doc(hutId);
        await hutRef.update({ status });
        
        // Loggen
        const hut = allHuts.find(h => h.id === hutId);
        const hutName = hut ? hut.name : `ID: ${hutId}`;
        logAdminAction(`Status auf '${status}' gesetzt`, hutId, hutName);
        hutRef.collection('log').add({
            admin: currentUser.displayName || currentUser.email,
            feld: 'status',
            wert: status,
            zeitpunkt: new Date()
        });
        
        showNotification(`‚úÖ Status f√ºr ${hutName} aktualisiert.`);
    } catch(e) {
        console.error("Fehler bei quickUpdateStatus:", e);
        showNotification('‚ùå Fehler beim Status-Update.');
    }
  }

  async function deleteHut(id) {
    if (!confirm(`‚ùó M√∂chtest du die H√ºtte mit ID ${id} wirklich endg√ºltig l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.`)) return;

    try {
      const hutRef = db.collection('eierhuetten').doc(id);
      const hutDoc = await hutRef.get();
      const hut = hutDoc.data();
      const hutName = hut.name || `ID: ${id}`;
      
      // TODO: PayPal-Abo k√ºndigen, falls vorhanden (Logik aus Original √ºbernommen)
      if (hut.paypalSubscriptionId) {
          showNotification('‚ö†Ô∏è Diese H√ºtte hat ein Abo. K√ºndigung nicht implementiert.');
          // Hier k√§me die cancelPaypalSubscription-Logik hin
      }
      
      // TODO: Fotos von imgbb l√∂schen (Logik aus Original √ºbernommen)
      if (Array.isArray(hut.fotos)) {
          for (const f of hut.fotos) {
              if (typeof f === "object" && f.delete_url) {
                  try { await fetch(f.delete_url); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
              }
          }
      }

      await hutRef.delete();
      
      logAdminAction('H√ºtte gel√∂scht', id, hutName);
      showNotification('üóëÔ∏è H√ºtte endg√ºltig gel√∂scht.');
      closeHutModal(); // Falls sie im Modal ge√∂ffnet war
      // onSnapshot aktualisiert die Liste
      
    } catch (err) {
      console.error('‚ùå Fehler beim L√∂schen der H√ºtte:', err);
      showNotification('‚ùå Fehler beim L√∂schen: ' + err.message);
    }
  }

  // === FOTO-VERWALTUNG ===

  async function approveFoto(hutId, index) {
    try {
      const ref = db.collection('eierhuetten').doc(hutId);
      const snap = await ref.get();
      const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];

      const f = fotos[index];
      if (!f || typeof f === 'string') {
        showNotification('‚ÑπÔ∏è Dieses Foto ist bereits freigegeben.');
        return;
      }
      fotos[index] = { ...f, status: 'freigegeben' };

      await ref.update({ fotos });
      
      const hutName = snap.data().name || `ID: ${hutId}`;
      logAdminAction('Foto freigegeben', hutId, hutName);
      ref.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos',
        wert: `Foto freigegeben: ${f.url}`,
        zeitpunkt: new Date()
      });
      showNotification('‚úÖ Bild freigegeben');
      // onSnapshot aktualisiert das Modal/Liste
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Freigeben.');
    }
  }

  async function rejectFoto(hutId, index) {
    if (!confirm('Soll dieses Foto wirklich endg√ºltig gel√∂scht werden?')) return;
    try {
      const ref = db.collection('eierhuetten').doc(hutId);
      const snap = await ref.get();
      const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];

      const f = fotos[index];
      if (!f) return;
      
      const deleteUrl = (typeof f === 'object' && f.delete_url) ? f.delete_url : null;
      fotos.splice(index, 1); // Foto aus Array entfernen

      await ref.update({ fotos });
      
      const hutName = snap.data().name || `ID: ${hutId}`;
      logAdminAction('Foto abgelehnt/gel√∂scht', hutId, hutName);
      ref.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos',
        wert: `Foto abgelehnt/gel√∂scht: ${typeof f === 'string' ? f : f.url}`,
        zeitpunkt: new Date()
      });

      if (deleteUrl) {
        try { await fetch(deleteUrl); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
      }
      showNotification('üóëÔ∏è Bild entfernt');
      // onSnapshot aktualisiert das Modal/Liste
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Entfernen.');
    }
  }

  async function initImageUpload(input, hutId) {
    const files = Array.from(input.files);
    if (files.length === 0) return;
    if (!hutId) {
        showNotification('‚ùå Bitte H√ºtte zuerst speichern, um Fotos hochzuladen.');
        return;
    }

    showNotification(`‚è≥ Lade ${files.length} Bild(er) hoch...`);
    const uploadedObjects = [];

    for (let file of files) {
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
        reader.readAsDataURL(file);
      });

      try {
        const formData = new FormData();
        formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // imgbb API Key
        formData.append('image', base64);

        const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
        const json = await res.json();

        if (json?.data?.url) {
          uploadedObjects.push({
            url: json.data.url,
            delete_url: json.data.delete_url || null,
            status: 'wartet' // Neue Fotos warten immer
          });
        } else {
          showNotification(`‚ùå Fehler beim Hochladen von Bild.`);
        }
      } catch (err) {
        showNotification(`‚ùå Upload-Fehler: ${err}`);
      }
    }

    if (uploadedObjects.length > 0) {
      try {
        await db.collection('eierhuetten').doc(hutId).update({
          fotos: firebase.firestore.FieldValue.arrayUnion(...uploadedObjects)
        });
        
        const hut = allHuts.find(h => h.id === hutId);
        logAdminAction(`Neue(s) Foto(s) hochgeladen`, hutId, hut.name);
        showNotification('‚úÖ Bilder hochgeladen (warten auf Freigabe).');
        // onSnapshot aktualisiert das Modal
      } catch (err) {
        showNotification('‚ùå Fehler beim Speichern der Bilder: ' + err.message);
      }
    }
  }

  // === TIERE-VERWALTUNG (im Modal) ===
  
  async function toggleTier(hutId, emoji) {
    const ref = db.collection('eierhuetten').doc(hutId);
    let newArray = [];

    try {
      await db.runTransaction(async tx => {
        const doc = await tx.get(ref);
        if (!doc.exists) throw new Error('H√ºtte nicht gefunden');

        let tiere = normalizeToEmojiArray(doc.data().tiere || []);

        const idx = tiere.indexOf(emoji);
        if (idx >= 0) {
          tiere.splice(idx, 1); // Abw√§hlen
        } else {
          tiere = tiere.filter(t => t !== '‚ùå'); // "Keine Tiere" entfernen
          tiere.push(emoji); // Hinzuf√ºgen
        }
        
        if (emoji === '‚ùå') {
            tiere = ['‚ùå']; // "Keine Tiere" ist exklusiv
        }

        newArray = tiere;
        tx.update(ref, { tiere });
      });

      // Log nach erfolgreicher Transaktion
      const hut = allHuts.find(h => h.id === hutId);
      logAdminAction(`Tiere ge√§ndert: ${newArray.join(', ')}`, hutId, hut.name);
      ref.collection('log').add({
          admin: currentUser.displayName || currentUser.email,
          feld: 'tiere',
          wert: newArray.join(', '),
          zeitpunkt: new Date()
      });
      
      showNotification(`üêæ Tiere aktualisiert.`);
      // onSnapshot aktualisiert das Modal
      
    } catch (e) {
      console.error("Fehler bei toggleTier:", e);
      showNotification('‚ùå Fehler beim Speichern der Tier-Auswahl');
    }
  }
  
  // === TAGS & NAVIGATION ===
  
  async function addTag(hutId, tag) {
    // Diese Funktion scheint im Original-HTML nicht aufgerufen zu werden,
    // aber ich lasse sie f√ºr Vollst√§ndigkeit drin.
    if (!tag) return;
    const docRef = db.collection('eierhuetten').doc(hutId);
    await docRef.update({
        tags: firebase.firestore.FieldValue.arrayUnion(tag)
    });
  }

  async function removeTag(hutId, tag) {
    // Diese Funktion scheint im Original-HTML nicht aufgerufen zu werden.
    const docRef = db.collection('eierhuetten').doc(hutId);
    await docRef.update({
        tags: firebase.firestore.FieldValue.arrayRemove(tag)
    });
  }

  function showSection(id) {
    document.querySelectorAll('.dash-section').forEach(sec =>
      sec.classList.add('hidden')
    );
    document.getElementById(id)?.classList.remove('hidden');

    document.querySelectorAll('.nav-btn').forEach(btn =>
      btn.classList.remove('active')
    );
    document
      .querySelector(`.nav-btn[onclick="showSection('${id}')"]`)
      ?.classList.add('active');
  }

  function showNotification(message) {
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 4000);
  }

  // === √úBERSICHT: MODERATIONS-WARTESCHLANGE ===

  function initLiveNewHuts() {
    db.collection('eierhuetten').where('status', '==', 'offen')
      .onSnapshot(snapshot => {
        const neueListe = document.getElementById("neueListe");
        if (snapshot.empty) {
            neueListe.innerHTML = "<p class='italic text-gray-500'>Keine neuen Eintragungen.</p>";
            return;
        }
        
        neueListe.innerHTML = "";
        snapshot.forEach(doc => {
            const hut = doc.data();
            const row = document.createElement("div");
            row.className = "flex items-center justify-between bg-white shadow-sm rounded px-3 py-2 border";
            row.innerHTML = `
              <p class="font-medium text-blue-600 truncate max-w-[50%]">${hut.name}</p>
              <div class="flex space-x-2 flex-shrink-0">
                <button onclick="quickUpdateStatus('${doc.id}', 'angenommen')"
                        class="px-2 py-1 bg-green-500 text-white rounded text-xs">Annehmen</button>
                <button onclick="quickUpdateStatus('${doc.id}', 'abgelehnt')"
                        class="px-2 py-1 bg-red-500 text-white rounded text-xs">Ablehnen</button>
                <button onclick="openHutModal('${doc.id}')"
                        class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Details</button>
              </div>
            `;
            neueListe.appendChild(row);
        });
      });
  }

  function initLivePendingFotos() {
    db.collection('eierhuetten')
      .onSnapshot(snapshot => {
        const container = document.getElementById("pending-fotos");
        const pending = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            if (Array.isArray(data.fotos) && data.fotos.some(f => f && typeof f === "object" && f.status === "wartet")) {
                pending.push({ id: doc.id, ...data });
            }
        });
        
        if (pending.length === 0) {
            container.innerHTML = "<p class='italic text-gray-500'>Keine Fotos warten.</p>";
            return;
        }
        
        container.innerHTML = "";
        pending.forEach(hut => {
            const wartendeFotos = hut.fotos.map((f, i) => ({...f, originalIndex: i})).filter(f => f.status === 'wartet');
            const row = document.createElement("div");
            row.className = "flex items-center justify-between bg-white shadow-sm rounded px-3 py-2 border";
            row.innerHTML = `
                <div>
                    <p class="font-medium text-blue-600">${hut.name}</p>
                    <p class="text-xs text-gray-500">${wartendeFotos.length} Foto(s)</p>
                </div>
                <button onclick="openHutModal('${hut.id}')"
                        class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Anzeigen</button>
            `;
            container.appendChild(row);
        });
      });
  }

  // === SUPPORT-TICKETS (Logik aus Original √ºbernommen) ===
  let currentReplyTicketId = null;

  async function ladeSupportTickets() {
    const snapshot = await db.collection('support').orderBy('createdAt', 'desc').get();
    const body = document.getElementById('support-tickets-body');
    body.innerHTML = '';

    snapshot.forEach(doc => {
      const ticket = doc.data();
      const id = doc.id;
      const datum = ticket.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const email = ticket.mail || '-';
      const status = ticket.status || 'offen';

      const row = document.createElement('tr');
      row.className = "align-top";
      row.innerHTML = `
        <td class="px-4 py-2 text-xs text-gray-600">${datum}</td>
        <td class="px-4 py-2 text-xs">${email}</td>
        <td class="px-4 py-2 text-xs">
          <div id="msgs-${id}" class="space-y-1 max-h-24 overflow-y-auto">‚è≥...</div>
        </td>
        <td class="px-4 py-2">
          <select onchange="updateSupportStatus('${id}', this.value)" class="border rounded px-2 py-1 text-xs bg-white">
            ${['offen', 'bearbeitet', 'geschlossen', 'archiviert'].map(opt => `
              <option value="${opt}" ${opt === status ? 'selected' : ''}>${opt}</option>
            `).join('')}
          </select>
        </td>
        <td class="px-4 py-2 space-x-1">
          <button onclick="openReplyModal('${id}','${email}')" class="bg-green-600 text-white text-xs px-2 py-1 rounded">Antworten</button>
          <button onclick="loescheSupportTicket('${id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">L√∂schen</button>
        </td>
      `;
      body.appendChild(row);
      ladeSupportNachrichten(id);
    });
  }

  function ladeSupportNachrichten(ticketId) {
    const wrap = document.getElementById("msgs-" + ticketId);
    db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "asc")
      .onSnapshot(snap => {
        if (snap.empty) {
          wrap.innerHTML = "<div class='text-gray-500'>(keine)</div>"; return;
        }
        wrap.innerHTML = snap.docs.map(mdoc => {
            const d = mdoc.data();
            const senderClass = d.sender === 'Admin' ? 'text-blue-600 font-semibold' : '';
            return `<div class="border-b pb-1 mb-1"><p class="${senderClass}">${d.text || ''}</p></div>`;
        }).join('');
      });
  }

  function openReplyModal(ticketId, email) {
    currentReplyTicketId = ticketId;
    document.getElementById("modal-ticket-info").innerText = `Ticket-ID: ${ticketId} ¬∑ User: ${email}`;
    document.getElementById("modal-reply-text").value = "";
    document.getElementById("modal-reply-counter").innerText = "500 Zeichen √ºbrig";
    document.getElementById("support-reply-modal").classList.remove("hidden");
  }

  function closeReplyModal() {
    document.getElementById("support-reply-modal").classList.add("hidden");
    currentReplyTicketId = null;
  }

  async function sendReply() {
    const text = document.getElementById("modal-reply-text").value.trim();
    if (!text || !currentReplyTicketId) return;
    try {
      await db.collection("support").doc(currentReplyTicketId).collection("messages").add({
        text, sender: "Admin",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await db.collection("support").doc(currentReplyTicketId).update({
        status: "geschlossen"
      });
      logAdminAction(`Support-Ticket beantwortet`, currentReplyTicketId);
      showNotification("‚úÖ Antwort gesendet & Ticket geschlossen");
      closeReplyModal();
    } catch (err) {
      alert("Fehler: " + err.message);
    }
  }

  async function updateSupportStatus(id, neuerStatus) {
    await db.collection('support').doc(id).update({ status: neuerStatus });
    logAdminAction(`Support-Status ge√§ndert: ${neuerStatus}`, id);
    showNotification('‚úÖ Status aktualisiert');
  }

  async function loescheSupportTicket(id) {
    if (!confirm('Dieses Support-Ticket wirklich l√∂schen?')) return;
    await db.collection('support').doc(id).delete(); // Hauptdokument l√∂schen (Subkollektion wird nicht automatisch gel√∂scht, aber OK)
    logAdminAction(`Support-Ticket gel√∂scht`, id);
    showNotification('üóëÔ∏è Ticket gel√∂scht');
    ladeSupportTickets();
  }

  document.getElementById("modal-reply-text").addEventListener("input", e => {
    const left = 500 - e.target.value.length;
    document.getElementById("modal-reply-counter").innerText = `${left} Zeichen √ºbrig`;
  });

  // === PROFIL-VERWALTUNG (Logik aus Original √ºbernommen) ===
  let currentProfileId = null;

  async function loadProfileAdmin(id) {
      currentProfileId = id;
      const snap = await db.collection("profiles").doc(id).get();
      if (!snap.exists) return alert("Profil nicht gefunden!");
      
      const data = snap.data();
      const adminArea = document.getElementById("profile-admin-area");

      // Titel laden
      let titleOptions = "<option value=''>Kein Titel</option>";
      const titleSnap = await db.collection("titles").get();
      titleSnap.forEach(doc => {
        const t = doc.data();
        titleOptions += `<option value="${t.name}" ${data.title === t.name ? 'selected' : ''}>${t.name}</option>`;
      });

      // Abzeichen laden
      let badgeCheckboxes = "";
      const badgeSnap = await db.collection("badgesDefs").get();
      badgeSnap.forEach(doc => {
        const b = doc.data();
        const checked = (data.badges || []).includes(doc.id) ? 'checked' : '';
        badgeCheckboxes += `
            <label class="flex items-center space-x-2">
                <input type="checkbox" class="form-checkbox" value="${doc.id}" ${checked}>
                <span>${b.icon || "üèÖ"} ${b.name}</span>
            </label>
        `;
      });

      adminArea.innerHTML = `
        <div class="flex items-center space-x-4">
          <img id="profile-pic-admin" src="${data.pic || 'https://placehold.co/100x100/e2e8f0/718096?text=Profil'}" class="w-24 h-24 rounded-full border" />
          <input id="profile-pic-url" class="flex-1 border p-2 rounded-md" placeholder="Profilbild-URL √§ndern..." value="${data.pic || ''}" />
        </div>
        <input id="profile-name-admin" class="w-full border p-2 rounded-md" placeholder="Name" value="${data.name || ''}" />
        <textarea id="profile-bio-admin" class="w-full border p-2 rounded-md" placeholder="Kurzbeschreibung / Bio">${data.bio || ''}</textarea>
        
        <label class="block font-bold">Titel</label>
        <select id="profile-title-admin" class="w-full border p-2 rounded-md bg-white">${titleOptions}</select>
        
        <label class="block font-bold">Abzeichen</label>
        <div id="profile-badges-admin" class="flex flex-wrap gap-4">${badgeCheckboxes}</div>
        
        <label class="block font-bold">Rolle</label>
        <select id="profile-role-admin" class="w-full border p-2 rounded-md bg-white">
          <option value="user" ${data.role === 'user' ? 'selected': ''}>üë§ User</option>
          <option value="admin" ${data.role === 'admin' ? 'selected': ''}>üëë Admin</option>
          <option value="mod" ${data.role === 'mod' ? 'selected': ''}>üõ°Ô∏è Moderator</option>
        </select>
        
        <label class="inline-flex items-center space-x-2">
          <input id="profile-banned-admin" type="checkbox" class="form-checkbox" ${data.banned ? 'checked' : ''}>
          <span>üö´ Account gesperrt</span>
        </label>
        
        <div class="text-sm text-gray-600" id="profile-stats">
            Fahrten: ${data.rides || 0} | Km: ${data.km || 0} | Letzter Login: ${data.lastLogin?.toDate().toLocaleString('de-DE') || "‚Äì"}
        </div>
        
        <div class="flex space-x-2 mt-4">
          <button onclick="saveProfileAdmin()" class="bg-green-600 text-white px-4 py-2 rounded-lg">üíæ Speichern</button>
          <button onclick="deleteProfileAdmin()" class="bg-red-600 text-white px-4 py-2 rounded-lg">üóëÔ∏è L√∂schen</button>
        </div>
      `;
      adminArea.classList.remove("hidden");
  }

  async function saveProfileAdmin() {
    if (!currentProfileId) return;
    const badges = [...document.querySelectorAll("#profile-badges-admin input:checked")].map(i => i.value);

    const data = {
        name: document.getElementById("profile-name-admin").value,
        pic: document.getElementById("profile-pic-url").value,
        bio: document.getElementById("profile-bio-admin").value,
        title: document.getElementById("profile-title-admin").value,
        role: document.getElementById("profile-role-admin").value,
        banned: document.getElementById("profile-banned-admin").checked,
        badges: badges
    };
    
    await db.collection("profiles").doc(currentProfileId).update(data);
    logAdminAction(`Profil gespeichert: ${data.name}`, null, null);
    showNotification("‚úîÔ∏è Profil gespeichert!");
  }

  async function deleteProfileAdmin() {
    if (!currentProfileId) return;
    if (!confirm("Soll dieses Profil wirklich gel√∂scht werden?")) return;
    const name = document.getElementById("profile-name-admin").value;
    await db.collection("profiles").doc(currentProfileId).delete();
    logAdminAction(`Profil gel√∂scht: ${name}`, null, null);
    showNotification("üóëÔ∏è Profil gel√∂scht!");
    document.getElementById("profile-admin-area").classList.add("hidden");
    document.getElementById("profile-search").value = "";
  }
  
  document.getElementById('profile-search').addEventListener('input', async e => {
      const q = e.target.value.trim();
      const box = document.getElementById('profile-suggestions');
      if (q.length < 3) { box.classList.add('hidden'); return; }

      const snap = await db.collection('profiles').where('name', '>=', q).where('name', '<=', q + '\uf8ff').limit(5).get();
      
      box.innerHTML = snap.empty
        ? "<p class='p-2 text-gray-500 italic'>Keine Treffer</p>"
        : snap.docs.map(d => `
          <div class="p-2 hover:bg-gray-100 cursor-pointer"
               onclick="selectProfile('${d.id}', '${d.data().name.replace(/'/g,"\\'")}')">
            ${d.data().name}
          </div>`).join('');
      box.classList.remove('hidden');
  });

  window.selectProfile = (id, name) => {
    document.getElementById('profile-search').value = name;
    document.getElementById('profile-suggestions').classList.add('hidden');
    loadProfileAdmin(id);
  };
  

  // === TITEL & ABZEICHEN (Logik aus Original √ºbernommen) ===
  
  // ---- TITEL Verwaltung ----
  const titleList = document.getElementById("title-list");
  const titleForm = document.getElementById("title-form");
  let titleEditId = null;

  async function loadTitles() {
    if (!titleList) return;
    const snap = await db.collection("titles").orderBy("name").get();
    titleList.innerHTML = "";
    snap.forEach(doc => {
      const t = doc.data();
      titleList.innerHTML += `
        <div class="p-2 border rounded flex justify-between items-center">
          <span><strong>${t.name}</strong> (${t.conditionType} ‚â• ${t.conditionValue})</span>
          <div class="space-x-2">
            <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs" onclick="editTitle('${doc.id}', '${t.name}', '${t.conditionType}', ${t.conditionValue})">‚úèÔ∏è</button>
            <button class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="deleteTitle('${doc.id}', '${t.name}')">üóëÔ∏è</button>
          </div>
        </div>`;
    });
  }

  window.editTitle = (id, name, type, value) => {
    titleEditId = id;
    document.getElementById("title-name").value = name;
    document.getElementById("title-condition").value = type;
    document.getElementById("title-value").value = value;
  };

  window.deleteTitle = async (id, name) => {
    if (!confirm(`Diesen Titel "${name}" wirklich l√∂schen?`)) return;
    await db.collection("titles").doc(id).delete();
    logAdminAction(`Titel gel√∂scht: ${name}`);
    loadTitles();
  };

  titleForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      name: document.getElementById("title-name").value.trim(),
      conditionType: document.getElementById("title-condition").value,
      conditionValue: parseInt(document.getElementById("title-value").value) || 0
    };
    if (!payload.name) { alert("Bitte einen Titel-Namen angeben."); return; }

    if (titleEditId) {
      await db.collection("titles").doc(titleEditId).update(payload);
      logAdminAction(`Titel aktualisiert: ${payload.name}`);
    } else {
      await db.collection("titles").add(payload);
      logAdminAction(`Titel erstellt: ${payload.name}`);
    }
    titleEditId = null;
    titleForm.reset();
    loadTitles();
  });
  
  // ---- ABZEICHEN Verwaltung ----
  const badgeList = document.getElementById("badge-list-admin");
  const badgeForm = document.getElementById("badge-form");
  let badgeEditId = null;

  async function loadBadges() {
    const snap = await db.collection("badgesDefs").orderBy("name").get();
    badgeList.innerHTML = "";
    snap.forEach(doc => {
      const b = doc.data();
      const displayIcon = b.iconUrl ? `<img src="${b.iconUrl}" class="w-6 h-6 inline-block rounded" />` : (b.icon || "üèÖ");
      badgeList.innerHTML += `
        <div class="p-2 border rounded flex justify-between items-center">
          <span>${displayIcon} <strong>${b.name}</strong> (${b.conditionType} ‚â• ${b.conditionValue})</span>
          <div class="space-x-2">
            <button onclick="editBadge('${doc.id}', '${b.name}', '${b.icon || ''}', '${b.conditionType}', ${b.conditionValue})" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">‚úèÔ∏è</button>
            <button onclick="deleteBadge('${doc.id}', '${b.name}')" class="px-2 py-1 bg-red-600 text-white rounded text-xs">üóëÔ∏è</button>
          </div>
        </div>
      `;
    });
  }

  window.editBadge = (id, name, icon, type, value) => {
    badgeEditId = id;
    document.getElementById("badge-name").value = name;
    document.getElementById("badge-icon").value = icon;
    document.getElementById("badge-condition").value = type;
    document.getElementById("badge-value").value = value;
  };

  window.deleteBadge = async (id, name) => {
    if (!confirm(`Dieses Abzeichen "${name}" wirklich l√∂schen?`)) return;
    await db.collection("badgesDefs").doc(id).delete();
    logAdminAction(`Abzeichen gel√∂scht: ${name}`);
    loadBadges();
  };

  badgeForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("badge-name").value.trim();
    if (!name) return alert("Bitte Abzeichen-Namen eingeben!");
    
    const payload = {
        name,
        icon: document.getElementById("badge-icon").value.trim(),
        conditionType: document.getElementById("badge-condition").value,
        conditionValue: parseInt(document.getElementById("badge-value").value) || 0,
        createdAt: new Date()
    };
    
    const fileInput = document.getElementById("badge-icon-file");
    if (fileInput.files.length > 0) {
      try {
        payload.iconUrl = await badgeFormUploadToImgBB(fileInput.files[0]);
      } catch (err) {
        alert("‚ùå Fehler beim ImgBB-Upload: " + err);
      }
    }

    if (badgeEditId) {
        await db.collection("badgesDefs").doc(badgeEditId).update(payload);
        logAdminAction(`Abzeichen aktualisiert: ${payload.name}`);
    } else {
        await db.collection("badgesDefs").add(payload);
        logAdminAction(`Abzeichen erstellt: ${payload.name}`);
    }
    
    badgeEditId = null;
    badgeForm.reset();
    loadBadges();
  });
  
  async function badgeFormUploadToImgBB(file) {
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
        reader.readAsDataURL(file);
      });
      
      const formData = new FormData();
      formData.append("key", "5df04de9bfd2776f101329be4193e44c");
      formData.append("image", base64);
      
      const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData });
      const json = await res.json();
      if (json?.data?.url) return json.data.url;
      throw new Error("ImgBB Upload fehlgeschlagen");
  }

  // Initiales Laden beim Wechsel zur Sektion
  document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]').addEventListener('click', () => {
      loadTitles();
      loadBadges();
  });
  
  // (Die alte In-App-Konsole wurde entfernt, da sie sehr aufdringlich war. 
  //  Die Standard-Browser-Konsole (F12) ist f√ºr die Entwicklung besser geeignet.)

</script>
</body>
</html>
