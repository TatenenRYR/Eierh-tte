<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eierhütten Admin-Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .minimap { height: 150px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
    .editable-map { height: 300px; margin-top: 10px; border: 1px solid #ccc; border-radius: 0.5rem; }
    .preview-img { height: 150px; object-fit: cover; border-radius: 0.5rem; }
    .progress-bar { width: 100%; background-color: #e5e7eb; border-radius: 0.5rem; margin-top: 5px; }
    .progress-fill { height: 8px; background-color: #10b981; border-radius: 0.5rem; width: 0%; transition: width 0.3s; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="notification"></div>
  <div id="login-section" class="flex items-center justify-center h-screen">
    <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded">
      Admin Login mit Google
    </button>
  </div>
  <div id="dashboard" class="hidden p-6 max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-green-700">🥚 Eierhütten Admin Dashboard</h1>
    <div id="stats" class="mb-6 text-gray-700"></div>
    <input id="search-input" type="text" placeholder="Suche..." class="mb-4 w-full p-3 rounded border border-gray-300">
    <div id="hut-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.appspot.com",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const loginSection = document.getElementById('login-section');
    const dashboard = document.getElementById('dashboard');
    const hutList = document.getElementById('hut-list');
    const searchInput = document.getElementById('search-input');
    const notification = document.getElementById('notification');
    const stats = document.getElementById('stats');
    let huts = [], currentUser = null;

    function showNotification(message) {
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 4000);
    }

    document.getElementById('login-btn').onclick = () => {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    };

    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        const adminDoc = await db.collection('admins').doc(user.email).get();
        if (!adminDoc.exists) {
          alert('Zugriff verweigert: Du bist kein Admin.');
          return;
        }
        loginSection.classList.add('hidden');
        dashboard.classList.remove('hidden');
        db.collection('eierhuetten').onSnapshot(() => {
          showNotification('🔄 Live-Update: Hüttendaten wurden aktualisiert.');
          loadHuts();
        });
      }
    });

    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      const filtered = huts.filter(h => h.name?.toLowerCase().includes(term));
      renderHuts(filtered);
    });

    async function loadHuts() {
      const snapshot = await db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get();
      huts = await Promise.all(snapshot.docs.map(async doc => {
        const data = doc.data();
        const logSnap = await db.collection('eierhuetten').doc(doc.id).collection('log').get();
        return {
          id: doc.id,
          ...data,
          logCount: logSnap.size,
          logs: logSnap.docs.map(d => d.data())
        };
      }));
      renderHuts(huts);
      renderStats(huts);
    }

    function renderStats(list) {
      const total = list.length;
      const withStrom = list.filter(h => h.strom === 'Ja').length;
      const withFotos = list.filter(h => Array.isArray(h.fotos) && h.fotos.length > 0).length;
      const count247 = list.filter(h => h.oeffnungszeiten === '24/7').length;
      stats.innerHTML = `🔢 <strong>${total}</strong> Hütten · ⚡ ${withStrom} mit Strom · 🖼️ ${withFotos} mit Fotos · 🕒 ${count247} sind 24/7 geöffnet`;
    }
  </script></body>
</html>
