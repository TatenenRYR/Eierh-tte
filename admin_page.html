<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hütten Admin-Dashboard</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT: '#065f46', light: '#059669', hover: '#047857' }, // Emerald
            secondary: '#4f46e5', // Indigo
            ai: '#7c3aed', // Purple
          },
        },
      },
    }
  </script>

  <style>
    /* Grundstile & Helfer */
    .minimap { height: 200px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1;}
    #notification {
      position: fixed; top: 1rem; right: 1rem;
      background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem;
      display: none; z-index: 9999; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .nav-btn { @apply text-left px-3 py-2 rounded text-slate-700 hover:bg-emerald-50 transition duration-150; }
    .nav-btn.active { @apply bg-emerald-100 text-emerald-800 font-semibold; }
    .section-title { @apply text-2xl font-bold mb-4 border-b pb-2 text-slate-800; }
    .dash-section { @apply space-y-4; }
    .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 4px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Mobile Slide-Out-Menü Stile */
    #sidebar { transition: transform 0.3s ease-in-out; }
    #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
    body.sidebar-open #sidebar { transform: translateX(0); }
    body.sidebar-open #sidebar-overlay { opacity: 1; pointer-events: auto; }

    /* Hütten-Kacheln */
    .hut-card { @apply bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transition-transform duration-200 hover:scale-[1.02]; }
    .hut-card img { @apply w-full h-32 object-cover; }
    .hut-card-content { @apply p-3; }
    .hut-card-title { @apply font-bold text-lg text-primary truncate; }
    .hut-card-type { @apply text-sm text-slate-600 bg-slate-100 px-2 py-0.5 rounded-full inline-block; }

    /* Formular-Elemente (Vereinheitlichung) */
    .form-label { @apply block font-medium text-slate-700 text-sm mb-1; }
    .form-input { @apply w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none; }
    .form-select { @apply w-full border border-slate-300 rounded-lg p-2 bg-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none; }
    .form-textarea { @apply w-full border border-slate-300 rounded-lg p-2 h-24 focus:ring-2 focus:ring-primary focus:border-transparent outline-none; }
    .form-checkbox { @apply rounded border-slate-300 text-primary focus:ring-primary; }
    .form-file { @apply block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-primary hover:file:bg-emerald-100 cursor-pointer; }
    .form-section { @apply p-3 bg-slate-50 rounded-lg space-y-2 border border-slate-200; }

    /* Buttons */
    .btn { @apply px-4 py-2 rounded-lg font-semibold transition duration-150; }
    .btn-primary { @apply bg-primary text-white hover:bg-primary-hover; }
    .btn-secondary { @apply bg-secondary text-white hover:bg-indigo-700; }
    .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
    .btn-ai { @apply bg-ai text-white hover:bg-purple-700; }
    .btn-outline { @apply border border-slate-300 text-slate-700 hover:bg-slate-50; }
    .btn-sm { @apply px-3 py-1 text-sm; }
    .btn-xs { @apply px-2 py-1 text-xs; }

    /* Support Ticket Tabelle & Nachrichten */
    .support-table th { @apply px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider; }
    .support-table td { @apply px-4 py-3 text-sm text-slate-700 align-top; }
    .msg-bubble { @apply border rounded-lg p-2 mb-1 shadow-sm max-w-full break-words; }
    .msg-text { @apply text-sm text-slate-800; }
    .msg-meta { @apply text-[10px] text-slate-500 mt-1; }
    .tag-ai { @apply px-2 py-1 bg-ai text-white rounded-full text-xs font-medium leading-none; }
    .tag-button { @apply bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded-lg hover:bg-slate-300; }

    /* Log Liste */
    .log-summary { @apply cursor-pointer text-sm text-slate-600 hover:text-primary; }
    .log-list { @apply text-xs max-h-48 overflow-auto mt-2 p-2 bg-slate-50 rounded-lg border border-slate-200; }
    .log-item { @apply border-b border-slate-200 py-1 last:border-b-0; }
    .log-time { @apply text-slate-500 ml-1; }
  </style>
</head>

<body class="bg-slate-100 font-sans">
  <div id="notification"></div>

  <div id="login-section" class="flex items-center justify-center h-screen bg-slate-200">
    <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-2xl text-center">
      <h1 class="text-3xl font-bold text-primary mb-4">🏘 Hütten Admin</h1>
      <p class="text-slate-600 mb-6">Bitte melde dich an.</p>
      <div id="login-error" class="hidden bg-red-100 border border-red-300 text-red-700 px-4 py-2 rounded-lg mb-4 text-sm"></div>
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 btn">Mit Google Anmelden</button>
    </div>
  </div>

  <aside id="sidebar" class="w-64 bg-white shadow-lg fixed top-0 left-0 h-full z-40 transform -translate-x-full md:translate-x-0 md:relative md:flex-shrink-0">
    <div class="p-4 border-b"><h1 class="text-xl font-bold text-primary">🏘 Hütten Admin</h1></div>
    <nav class="p-4 space-y-1">
      <button class="nav-btn w-full" onclick="showSection('overview')">📊 Übersicht</button>
      <button class="nav-btn w-full" onclick="showSection('huts')">🏠 Hüttenliste</button>
      <button class="nav-btn w-full" onclick="showSection('support')">📨 Support-Tickets</button>
      <button class="nav-btn w-full" onclick="showSection('profiles')">👤 Profile</button>
      <button class="nav-btn w-full" onclick="showSection('titles')">👑 Titel</button>
      <button class="nav-btn w-full" onclick="showSection('badges')">🏅 Abzeichen</button>
    </nav>
  </aside>

  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none md:hidden" onclick="toggleMenu(false)"></div>

  <div id="dashboard" class="hidden md:flex flex-col flex-1 min-h-screen">

    <header class="sticky top-0 bg-white shadow-md z-20">
      <div class="flex items-center justify-between p-4">
        <button id="menu-toggle" onclick="toggleMenu(true)" class="md:hidden p-2 text-slate-700 border rounded-lg">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </button>
        <h2 id="header-title" class="text-xl font-semibold text-slate-800">Übersicht</h2>
        <button id="logout-btn" onclick="auth.signOut()" class="btn btn-danger btn-sm">Logout</button>
      </div>
    </header>

    <main class="flex-1 p-6 space-y-8 overflow-y-auto">

      <section id="overview" class="dash-section">
        <h2 class="section-title">📊 Übersicht</h2>
        <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <canvas id="statsChart" class="bg-white rounded-xl shadow-lg p-4 mt-6 max-h-[400px]"></canvas>
        <h2 class="section-title">🆕 Neue Eintragungen</h2>
        <div id="neueListe" class="space-y-2 bg-slate-50 p-4 rounded-xl shadow-inner"></div>
        <h2 class="section-title">📷 Fotos warten auf Freigabe</h2>
        <div id="pending-fotos" class="space-y-4 bg-slate-50 p-4 rounded-xl shadow-inner"></div>
      </section>

      <section id="huts" class="dash-section hidden">
        <div id="hut-list-view">
          <h2 class="section-title">🏠 Alle Hütten</h2>
          <div class="flex flex-col sm:flex-row items-center gap-2 mb-4">
            <select id="sortSelect" class="form-select w-full sm:w-auto">
              <option value="name">🔤 Nach Name</option>
              <option value="createdAt">🕒 Neueste zuerst</option>
            </select>
            <input id="search-input" placeholder="🔍 Suchen..." class="form-input w-full">
          </div>
          <div id="hut-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            </div>
          <div id="pagination" class="mt-4 flex flex-wrap justify-center gap-2"></div>
        </div>
        <div id="edit-hut-view" class="hidden">
           <button onclick="showHutList()" class="mb-4 btn btn-outline btn-sm">&larr; Zurück zur Liste</button>
           <h2 class="section-title" id="edit-hut-title">Hütte bearbeiten</h2>
           <div id="edit-hut-content" class="bg-white p-6 rounded-xl shadow-lg space-y-4">
             </div>
        </div>
      </section>

      <section id="support" class="dash-section hidden">
         <h2 class="section-title">📨 Support-Tickets</h2>
         <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
           <table class="min-w-full support-table">
             <thead><tr><th>Datum</th><th>User</th><th>Nachrichten</th><th>AI-Tags</th><th>Status</th><th>Aktionen</th></tr></thead>
             <tbody id="support-tickets-body" class="divide-y divide-slate-200"></tbody>
           </table>
         </div>
      </section>

      <div id="support-reply-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
           <h3 class="text-lg font-bold mb-2">Antwort auf Ticket</h3>
           <div id="modal-ticket-info" class="text-xs text-slate-500 mb-2"></div>
           <textarea id="modal-reply-text" class="form-textarea mb-2" rows="5" maxlength="500"></textarea>
           <button id="gemini-suggest-btn" onclick="geminiSuggestReply(this)" class="btn btn-ai btn-sm w-full mb-2 flex items-center justify-center gap-1">🤖 Antwort vorschlagen</button>
           <div class="text-xs text-slate-500 mb-3" id="modal-reply-counter">500 Zeichen übrig</div>
           <div class="flex justify-end gap-2">
             <button onclick="closeReplyModal()" class="btn btn-outline">Abbrechen</button>
             <button onclick="sendReply()" class="btn btn-primary">Antworten & schließen</button>
           </div>
        </div>
      </div>

      <section id="profiles" class="dash-section hidden">
        <h2 class="section-title">👤 Profile Verwaltung</h2>
        <div class="bg-white p-6 rounded-xl shadow-lg space-y-3">
          <div class="relative">
             <input id="profile-search" type="text" class="form-input" placeholder="Profil suchen (ID oder Name)..." />
             <input type="hidden" id="profile-selected-id">
             <div id="profile-suggestions" class="absolute bg-white border border-slate-300 w-full mt-1 rounded-lg shadow-lg hidden z-10"></div>
          </div>
          <div id="profile-admin-area" class="hidden space-y-4 pt-4 border-t border-slate-200">
            <div class="flex items-center space-x-4">
              <img id="profile-pic-admin" class="w-24 h-24 rounded-full border border-slate-300 object-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />
              <input id="profile-pic-url" class="form-input flex-1" placeholder="Profilbild-URL ändern..." />
            </div>
            <label class="form-label">Name</label><input id="profile-name-admin" class="form-input" placeholder="Name" />
            <label class="form-label">Bio</label><textarea id="profile-bio-admin" class="form-textarea" placeholder="Kurzbeschreibung / Bio"></textarea>
            <label class="form-label">Titel</label><select id="profile-title-admin" class="form-select"></select>
            <label class="form-label">Abzeichen</label><div id="profile-badges-admin" class="flex flex-wrap gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200"></div>
            <label class="form-label">Rolle</label><select id="profile-role-admin" class="form-select">
              <option value="user">👤 User</option> <option value="admin">👑 Admin</option> <option value="mod">🛡️ Moderator</option>
            </select>
            <label class="inline-flex items-center space-x-2"><input id="profile-banned-admin" type="checkbox" class="form-checkbox"><span>🚫 Account gesperrt</span></label>
            <div class="text-sm text-slate-600" id="profile-stats"></div>
            <div class="flex space-x-2">
              <button onclick="saveProfileAdmin()" class="btn btn-primary">💾 Speichern</button>
              <button onclick="deleteProfileAdmin()" class="btn btn-danger">🗑️ Löschen</button>
              <button onclick="openProfileLink()" class="btn btn-secondary">🔗 Öffnen</button>
            </div>
           </div>
        </div>
      </section>

      <section id="titles" class="dash-section hidden">
         <h2 class="section-title">👑 Titel Verwaltung</h2>
         <div id="title-list" class="space-y-2 bg-white p-6 rounded-xl shadow-lg"></div>
         <form id="title-form" class="mt-4 space-y-3 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold">Neuen Titel erstellen / Bearbeiten</h3>
            <div><label class="form-label">Titel-Name</label><input id="title-name" placeholder="Titel-Name" class="form-input"></div>
            <div><label class="form-label">Bedingung</label><select id="title-condition" class="form-select"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> </select></div>
            <div><label class="form-label">Wert</label><input id="title-value" type="number" placeholder="Bedingung Wert" class="form-input"></div>
            <button type="submit" class="btn btn-primary">➕ Titel speichern</button>
         </form>
      </section>

      <section id="badges" class="dash-section hidden">
         <h2 class="section-title">🏅 Abzeichen Verwaltung</h2>
         <div id="badge-list-admin" class="space-y-2 bg-white p-6 rounded-xl shadow-lg"></div>
         <form id="badge-form" class="mt-4 space-y-3 bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-semibold">Neues Abzeichen erstellen / Bearbeiten</h3>
            <div><label class="form-label">Abzeichen-Name</label><input id="badge-name" placeholder="Abzeichen-Name" class="form-input"></div>
            <div><label class="form-label">Icon hochladen (optional)</label><input id="badge-icon-file" type="file" accept="image/*" class="form-file"></div>
            <div><label class="form-label">Emoji/Icon (Fallback)</label><input id="badge-icon" placeholder="🏅" class="form-input"></div>
            <div><label class="form-label">Bedingung</label><select id="badge-condition" class="form-select"> <option value="rides">Anzahl Fahrten</option> <option value="distance">Gesamtkilometer</option> <option value="night">Nachtfahrt</option> </select></div>
            <div><label class="form-label">Wert</label><input id="badge-value" type="number" placeholder="Bedingung Wert" class="form-input"></div>
            <button type="submit" class="btn btn-primary">➕ Abzeichen speichern</button>
         </form>
      </section>

    </main>
  </div>

<div id="admin-map" style="display:none;"></div>

<script type="module">
  import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://sdk.gemini.ai/v1.5/gemini-ai.js";
  const GEMINI_API_KEY = "AIzaSyB3FT8CdN9WkNjfQ5vutbjLCEibGSl3nnQ"; // ⚠️ UNSICHER!
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
  const safetySettings = [ { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE }, { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE }, { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE }, { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE }, ];
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash", safetySettings });
  console.log("🤖 Gemini AI (Frontend-Modus) initialisiert.");

  // --- Helper: Lade-Button ---
  function setButtonLoading(button, isLoading, originalText = null) { if (!button) return; if (isLoading) { button.disabled = true; if (!button.dataset.originalText) { button.dataset.originalText = button.innerHTML; } button.innerHTML = `<span class="spinner"></span> Warten...`; } else { button.disabled = false; if (button.dataset.originalText) { button.innerHTML = button.dataset.originalText; delete button.dataset.originalText; } else if (originalText) { button.innerHTML = originalText; } } }

  // --- KI-Funktion 1: Support-Antwort ---
  window.geminiSuggestReply = async (button) => { const originalText = button.innerHTML; setButtonLoading(button, true); const replyText = document.getElementById("modal-reply-text"); const ticketId = window.currentReplyTicketId; if (!ticketId || !window.supportMessages || !window.supportMessages[ticketId]) { alert("Fehler: Ticket-ID/Nachrichten nicht gefunden."); setButtonLoading(button, false, originalText); return; } const history = window.supportMessages[ticketId]; const prompt = `Du bist ein freundlicher Support-Mitarbeiter... Verlauf:\n${JSON.stringify(history, null, 2)}\n\nAntworte höflich auf LETZTE Anfrage (max. 4 Sätze). Anrede "Hallo", Gruß "Viele Grüße, Dein Hütten-Support-Team". Nur Text.`; try { const result = await model.generateContent(prompt); replyText.value = result.response.text(); replyText.dispatchEvent(new Event('input')); } catch (e) { console.error("Gemini Fehler (Reply):", e); alert("Fehler AI-Antwort: " + e.message); } finally { setButtonLoading(button, false, originalText); } };

  // --- KI-Funktion 2: Foto-Analyse ---
  async function fetchImageAsBase64(url) { const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`; try { const response = await fetch(proxyUrl); if (!response.ok) throw new Error(`Netzwerkfehler (${response.status})`); const blob = await response.blob(); return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: blob.type } }); reader.onerror = reject; reader.readAsDataURL(blob); }); } catch (error) { throw new Error(`Bildladen fehlgeschlagen (Proxy/CORS?): ${error.message}`); } }
  window.geminiAnalyzeImage = async (button, imageUrl) => { const originalText = button.innerHTML; setButtonLoading(button, true); let imagePart; try { imagePart = await fetchImageAsBase64(imageUrl); } catch (e) { console.error(e); alert("Fehler Bildanalyse: " + e.message + "\n\nHinweis: CORS blockiert oft. Funktion benötigt Server-Backend."); setButtonLoading(button, false, originalText); return; } const prompt = `Analysiere Bild. JSON: {"geeignet": "ja/nein/vielleicht", "inhalt": "...", "unangemessen": "ja/nein"}`; try { const result = await model.generateContent([prompt, imagePart]); let text = result.response.text().replace(/```json|```/g, "").trim(); const analysis = JSON.parse(text); alert(`🤖 AI-Foto-Check:\nGeeignet: ${analysis.geeignet}\nInhalt: ${analysis.inhalt}\nUnangemessen: ${analysis.unangemessen}`); } catch (e) { console.error("Gemini Fehler (Image):", e); alert("Fehler AI-Bildanalyse: " + e.message); } finally { setButtonLoading(button, false, originalText); } };

  // --- KI-Funktion 3: Hütten-Audit ---
  window.geminiAuditHut = async (button, hutId) => { const originalText = button.innerHTML; setButtonLoading(button, true); const hut = window.allHuts.find(h => h.id === hutId); if (!hut) { alert("Fehler: Hütte nicht gefunden."); setButtonLoading(button, false, originalText); return; } const prompt = `Audit für Hütte "${hut.name}". Beschreibung: "${hut.beschreibung || "Keine"}". Tags: [${(hut.tags || []).join(", ")}]. JSON: {"qualitaet": "...", "vorschlag": "...", "tags": ["...", "..."]}`; try { const result = await model.generateContent(prompt); let text = result.response.text().replace(/```json|```/g, "").trim(); const audit = JSON.parse(text); alert(`🤖 AI-Audit für "${hut.name}":\nQualität: ${audit.qualitaet}\nVorschlag: ${audit.vorschlag}\nTag-Vorschläge: ${audit.tags.join(", ")}`); } catch (e) { console.error("Gemini Fehler (Audit):", e); alert("Fehler beim AI-Audit: " + e.message); } finally { setButtonLoading(button, false, originalText); } };

  // --- KI-Funktion 4: Ticket-Tagging ---
  window.geminiTagTicket = async (button, ticketId) => { const originalText = button.innerHTML; setButtonLoading(button, true); if (!window.db) { alert("Fehler: DB nicht gefunden."); setButtonLoading(button, false, originalText); return; } let firstMessage = ""; try { const msgsSnap = await window.db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "asc").limit(1).get(); firstMessage = msgsSnap.docs[0]?.data().text; if (!firstMessage) { alert("Keine Nachricht zum Taggen."); setButtonLoading(button, false, originalText); return; } } catch (e) { alert("Fehler Laden der Nachricht: " + e.message); setButtonLoading(button, false, originalText); return; } const prompt = `Analysiere Support-Anfrage, gib 1-2 Tags zurück. Optionen: 'Abrechnung', 'Bug-Report', 'Foto-Problem', 'Hütten-Info', 'Spam', 'Allgemein'. NUR JSON Array. Text: "${firstMessage}"`; try { const result = await model.generateContent(prompt); let text = result.response.text().replace(/```json|```/g, "").trim(); const tags = JSON.parse(text); await window.db.collection("support").doc(ticketId).update({ aiTags: tags }); const tagCell = document.getElementById(`ai-tags-${ticketId}`); if(tagCell) { tagCell.innerHTML = tags.map(tag => `<span class="tag-ai">${tag}</span>`).join(' '); } } catch (e) { console.error("Gemini Fehler (Tagging):", e); alert("Fehler beim AI-Tagging: " + e.message); setButtonLoading(button, false, originalText); } };

  // --- KI-Funktion 5: Beschreibung generieren ---
  window.geminiGenerateDescription = async (button, hutId) => { const originalText = button.innerHTML; setButtonLoading(button, true); const keywordsInput = document.getElementById(`edit-kiStichpunkte-${hutId}`); const descriptionBox = document.getElementById(`edit-beschreibung-${hutId}`); const hut = window.allHuts.find(h => h.id === hutId); if (!hut || !keywordsInput || !descriptionBox) { alert("Fehler: Elemente nicht gefunden."); setButtonLoading(button, false, originalText); return; } const keywords = keywordsInput.value.trim(); if (!keywords) { alert("Bitte Stichpunkte eingeben."); setButtonLoading(button, false, originalText); return; } const prompt = `Werbetexter für Hütten-App. Generiere Beschreibung (2-3 Sätze) für "${hut.name}" aus Stichpunkten: "${keywords}". Nur Fließtext.`; try { const result = await model.generateContent(prompt); descriptionBox.value = result.response.text(); if (window.showNotification) { window.showNotification("🤖 Text generiert. Prüfen & Speichern."); } else { alert("Text generiert. Prüfen & Speichern."); } descriptionBox.classList.add('ring-2', 'ring-ai'); setTimeout(() => descriptionBox.classList.remove('ring-2', 'ring-ai'), 2000); } catch (e) { console.error("Gemini Fehler (Description):", e); alert("Fehler AI-Textgenerierung: " + e.message); } finally { setButtonLoading(button, false, originalText); } };
</script>

<script>
  // Globale Variablen & Firebase Setup
  window.firebase = firebase;
  let allHuts = []; window.allHuts = allHuts;
  window.supportMessages = {};
  const firebaseConfig = { apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", authDomain: "eierhuettentour.firebaseapp.com", projectId: "eierhuettentour", storageBucket: "eierhuettentour.appspot.com", messagingSenderId: "348272135205", appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc" };
  if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
  const auth = firebase.auth(); const db = firebase.firestore(); window.db = db;
  const storage = firebase.storage();
  const loginSection = document.getElementById('login-section'); const dashboard = document.getElementById('dashboard');
  const hutListContainer = document.getElementById('hut-list'); const searchInput = document.getElementById('search-input');
  const notification = document.getElementById('notification'); const hutListView = document.getElementById('hut-list-view');
  const editHutView = document.getElementById('edit-hut-view'); const editHutContent = document.getElementById('edit-hut-content');
  const editHutTitle = document.getElementById('edit-hut-title');
  let currentUser = null; let adminMarker, adminMap, adminLocation;
  let filteredHuts = []; let currentPage = 1; const hutsPerPage = 12;
  let statsChart; let currentEditingHutId = null;

  // --- Tier-Mapping ---
  const TIERE_EMOJI_TO_NAME = { "🦙": "Alpaka", "🐄": "Kuh", "🐖": "Schwein", "🐐": "Ziege", "🐑": "Schaf", "🐶": "Hund", "🐱": "Katze", "🐇": "Hase", "🐔": "Huhn", "🦆": "Ente", "🐴": "Pferd", "❌": "Keine Tiere" };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries(Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e]));
  function normalizeToEmojiArray(arr) { if (!Array.isArray(arr)) return []; return arr.map(v => { v = String(v || '').trim(); if (TIERE_EMOJI_TO_NAME[v]) return v; if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v]; return null; }).filter(Boolean); }

  // --- Initialisierung ---
  document.addEventListener('DOMContentLoaded', () => { try { adminMap = L.map('admin-map').setView([51.1657, 10.4515], 6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap); adminMarker = L.marker([51.1657, 10.4515], { draggable: true }).addTo(adminMap); adminMarker.on('dragend', e => { adminLocation = new firebase.firestore.GeoPoint(e.target.getLatLng().lat, e.target.getLatLng().lng); }); navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; adminMap.setView([latitude, longitude], 13); adminMarker.setLatLng([latitude, longitude]); adminLocation = new firebase.firestore.GeoPoint(latitude, longitude); }, () => console.warn("Geolocation nicht verfügbar.")); } catch (e) { console.error("Fehler Leaflet Init:", e); } document.getElementById("search-input")?.addEventListener("input", applySearchAndSort); document.getElementById("sortSelect")?.addEventListener("change", applySearchAndSort); });

  // --- UI-Helfer ---
  window.showNotification = function(message) { if (!notification) return; notification.textContent = message; notification.style.display = 'block'; setTimeout(() => { notification.style.display = 'none'; }, 4000); }

  // --- Authentifizierung ---
  document.getElementById('login-btn').onclick = () => { const btn = document.getElementById('login-btn'); btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Verbinde...'; auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(error => { const loginError = document.getElementById('login-error'); loginError.textContent = `Fehler Anmelden: ${error.message}`; loginError.classList.remove('hidden'); btn.disabled = false; btn.innerHTML = 'Mit Google Anmelden'; }); };
  auth.onAuthStateChanged(async user => { const loginError = document.getElementById('login-error'); const loginBtn = document.getElementById('login-btn'); if (user) { currentUser = user; try { const adminDoc = await db.collection('admins').doc(user.email).get(); if (!adminDoc.exists) { loginError.textContent = `Zugriff verweigert (${user.email}).`; loginError.classList.remove('hidden'); await auth.signOut(); return; } loginSection.classList.add('hidden'); dashboard.classList.remove('hidden'); dashboard.classList.add('flex'); db.collection('eierhuetten').onSnapshot(() => { console.log('Live-Update: Hütten.'); if(currentUser) loadHuts(); }, err => console.error("Snapshot-Fehler (Hütten):", err)); initLiveNewHuts(); initLivePendingFotos(); showSection('overview'); await loadHuts(); await ladeSupportTickets(); } catch (err) { console.error("Auth-Fehler:", err); loginError.textContent = `Fehler: ${err.message}`; loginError.classList.remove('hidden'); } } else { currentUser = null; loginSection.classList.remove('hidden'); dashboard.classList.add('hidden'); dashboard.classList.remove('flex'); loginBtn.disabled = false; loginBtn.innerHTML = 'Mit Google Anmelden'; } });

  // --- Datenladen & Statistik ---
  async function loadHuts() { try { const snapshot = await db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get(); allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); window.allHuts = allHuts; applySearchAndSort(); renderStats(allHuts); } catch (e) { console.error("Fehler Laden Hütten:", e); showNotification("❌ Fehler Laden Hütten."); } }
  function renderStats(list) { if (!list || typeof Chart === 'undefined') return; const total=list.length, withStrom=list.filter(h=>h.strom==='Ja').length, withFotos=list.filter(h=>Array.isArray(h.fotos)&&h.fotos.length>0).length, count247=list.filter(h=>h.oeffnungszeiten==='24/7').length, newEntries=list.filter(h=>h.status==='offen').length, pendingFotos=list.reduce((sum,h)=>sum+(Array.isArray(h.fotos)?h.fotos.filter(f=>f?.status==='wartet').length:0),0); const c=document.getElementById("statsContainer"); if(!c)return; c.innerHTML=`<div class="stat-card"><p class="stat-value text-primary">${total}</p><p class="stat-label">Gesamt</p></div> <div class="stat-card"><p class="stat-value text-yellow-600">${newEntries}</p><p class="stat-label">Neu</p></div> <div class="stat-card"><p class="stat-value text-blue-600">${withStrom}</p><p class="stat-label">Strom</p></div> <div class="stat-card"><p class="stat-value text-green-600">${withFotos}</p><p class="stat-label">Fotos</p></div> <div class="stat-card"><p class="stat-value text-red-600">${pendingFotos}</p><p class="stat-label">Wartend</p></div> <div class="stat-card"><p class="stat-value text-indigo-600">${count247}</p><p class="stat-label">24/7</p></div>`.replaceAll('stat-card', 'bg-white p-4 rounded-xl shadow-lg text-center').replaceAll('stat-value', 'text-3xl font-bold').replaceAll('stat-label', 'text-slate-500 text-sm'); const canvas = document.getElementById('statsChart'); const ctx = canvas?.getContext('2d'); if(!ctx) return; const data={labels:['Strom','Fotos','24/7','Neu'],datasets:[{data:[withStrom,withFotos,count247,newEntries],backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444']}]}; const options={responsive:true, maintainAspectRatio: false, plugins:{legend:{position:'bottom'},title:{display:true,text:'Merkmale'}}}; if(statsChart){statsChart.data=data;statsChart.update();}else{statsChart=new Chart(ctx,{type:'doughnut',data,options});} }

  // --- Foto-Management ---
  async function approveFoto(hutId, index) { try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); const fotos = [...(snap.data().fotos || [])]; const f = fotos[index]; if (!f || typeof f === 'string') { showNotification('ℹ️ Schon freigegeben.'); return; } fotos[index] = { ...f, status: 'freigegeben' }; await ref.update({ fotos }); await ref.collection('log').add({ admin: currentUser.email, feld: 'fotos', wert: `Foto ${index} freigegeben`, zeitpunkt: new Date() }); showNotification('✅ Bild freigegeben'); } catch (err) { console.error(err); showNotification('❌ Fehler Freigabe.'); } }
  async function rejectFoto(hutId, index) { try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); const fotos = [...(snap.data().fotos || [])]; const f = fotos[index]; if (!f) return; const deleteUrl = typeof f === 'object' ? f.delete_url : null; fotos.splice(index, 1); await ref.update({ fotos }); await ref.collection('log').add({ admin: currentUser.email, feld: 'fotos', wert: `Foto ${index} abgelehnt`, zeitpunkt: new Date() }); if (deleteUrl) { try { fetch(deleteUrl); } catch (e) { console.warn('imgbb delete failed', e); } } showNotification('🗑️ Bild entfernt'); } catch (err) { console.error(err); showNotification('❌ Fehler Entfernen.'); } }
  async function initImageUpload(input, hutId) { const files = Array.from(input.files); if (files.length === 0) return; showNotification(`⏳ Lade ${files.length} Bild(er)...`); const uploads = []; for (const file of files) { const base64 = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result.split(',')[1]); reader.onerror = rej; reader.readAsDataURL(file); }).catch(e => { showNotification('❌ Fehler Lesen Datei.'); console.error(e); return null; }); if (!base64) continue; try { const fd = new FormData(); fd.append('key', '5df04de9bfd2776f101329be4193e44c'); fd.append('image', base64); const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd }); const json = await res.json(); if (json?.data?.url) { uploads.push({ url: json.data.url, delete_url: json.data.delete_url, status: 'wartet' }); } else { throw new Error(json.error?.message || "ImgBB Fehler"); } } catch (err) { console.error(err); showNotification(`❌ Upload-Fehler: ${err.message}`); } } if (uploads.length > 0) { try { await db.collection('eierhuetten').doc(hutId).update({ fotos: firebase.firestore.FieldValue.arrayUnion(...uploads) }); showNotification('✅ Bilder hochgeladen (warten).'); } catch (err) { console.error(err); showNotification('❌ Fehler Speichern Bilder: ' + err.message); } } }
  window.deleteFoto = async function(hutId, index) { if (!confirm('Foto wirklich löschen?')) return; try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); if (!snap.exists) return showNotification("Hütte weg."); const fotos = [...(snap.data().fotos || [])]; const f = fotos[index]; if (!f) return showNotification("Foto weg."); const url = typeof f === 'string' ? f : f.url; const deleteUrl = typeof f === 'object' ? f.delete_url : null; fotos.splice(index, 1); await ref.update({ fotos }); await ref.collection('log').add({ admin: currentUser.email, feld: 'fotos', wert: `Foto ${index} gelöscht`, zeitpunkt: new Date() }); if (deleteUrl) { try { fetch(deleteUrl); } catch (e) { console.warn('imgbb delete failed', e); } } showNotification('🗑️ Foto gelöscht.'); } catch (e) { alert('Fehler Löschen Foto: ' + e.message); } }

  // --- Hütten-CRUD (angepasst für Detailansicht) ---
  async function saveHutDetails() { if (!currentEditingHutId) return; const hutId = currentEditingHutId; const content = document.getElementById('edit-hut-content'); if (!content) return; const updatedData = { name: content.querySelector(`#edit-name-${hutId}`)?.value.trim(), typ: content.querySelector(`#edit-typ-${hutId}`)?.value, beschreibung: content.querySelector(`#edit-beschreibung-${hutId}`)?.value.trim(), kiStichpunkte: content.querySelector(`#edit-kiStichpunkte-${hutId}`)?.value.trim(), sitzplaetze: content.querySelector(`#edit-sitzplaetze-${hutId}`)?.value, strom: content.querySelector(`#edit-strom-${hutId}`)?.value, status: content.querySelector(`#edit-status-${hutId}`)?.value, }; Object.keys(updatedData).forEach(key => (updatedData[key] === undefined || updatedData[key] === null) && delete updatedData[key]); if (!updatedData.name) { alert("Name darf nicht leer sein."); return; } try { await db.collection('eierhuetten').doc(hutId).update(updatedData); await db.collection('eierhuetten').doc(hutId).collection('log').add({ admin: currentUser.email, feld: 'Details', wert: 'Gespeichert', zeitpunkt: new Date() }); showNotification(`✅ "${updatedData.name}" gespeichert.`); showHutList(); } catch (e) { showNotification(`❌ Fehler Speichern: ${e.message}`); } }
  async function updateField(hutId, field, value) { if(field === 'status') { try { await db.collection('eierhuetten').doc(hutId).update({ [field]: value }); await db.collection('eierhuetten').doc(hutId).collection('log').add({ admin: currentUser.email, feld: field, wert: value, zeitpunkt: new Date() }); showNotification('✅ Status aktualisiert.'); } catch (e) { showNotification(`❌ Fehler: ${e.message}`); } } }

  // --- Navigation & Ansichtswechsel ---
  window.toggleMenu = function(forceOpen = null) { document.body.classList.toggle('sidebar-open', forceOpen === null ? undefined : forceOpen); }
  window.showSection = function(id) { if (id === 'huts') { showHutList(); } document.querySelectorAll('.dash-section').forEach(sec => sec.classList.add('hidden')); document.getElementById(id)?.classList.remove('hidden'); let title = "Übersicht"; document.querySelectorAll('.nav-btn').forEach(btn => { const btnOnClick = btn.getAttribute('onclick'); const isActive = btnOnClick?.includes(`showSection('${id}')`); btn.classList.toggle('active', isActive); if (isActive) title = btn.textContent.trim(); }); document.getElementById('header-title').textContent = title; toggleMenu(false); }
  function showHutList() { hutListView?.classList.remove('hidden'); editHutView?.classList.add('hidden'); if(editHutContent) editHutContent.innerHTML = ''; currentEditingHutId = null; applySearchAndSort(); }
  async function showEditHut(hutId) { currentEditingHutId = hutId; const hut = allHuts.find(h => h.id === hutId); if (!hut) { alert("Hütte nicht gefunden!"); return; } hutListView?.classList.add('hidden'); editHutView?.classList.remove('hidden'); if(editHutTitle) editHutTitle.textContent = `Bearbeiten: ${hut.name}`; await renderEditHutForm(hut); }

  // --- Hütten-Rendering ---
  function renderHuts(list) { if (!hutListContainer) return; hutListContainer.innerHTML = ''; if (!list || list.length === 0) { hutListContainer.innerHTML = `<p class="text-slate-500 italic text-center col-span-full">Keine Hütten gefunden.</p>`; return; } list.forEach(hut => { const el = document.createElement('div'); el.className = 'hut-card'; el.onclick = () => showEditHut(hut.id); const fotos = hut.fotos || []; const firstImage = fotos.find(f => f && (typeof f === 'string' || f.status === 'freigegeben')); const imageUrl = firstImage ? (typeof firstImage === 'string' ? firstImage : firstImage.url) : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; el.innerHTML = `<img src="${imageUrl}" alt="${hut.name || 'Hütte'}"><div class="hut-card-content"><h3 class="hut-card-title">${hut.name || 'Unbenannt'}</h3><div class="mt-1 space-x-1">${hut.typ ? `<span class="hut-card-type">${hut.typ}</span>` : ''} <span class="text-xs px-2 py-0.5 rounded-full ${hut.status === 'angenommen' ? 'bg-green-100 text-green-700' : hut.status === 'abgelehnt' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${hut.status || 'offen'}</span></div></div>`; hutListContainer.appendChild(el); }); }
  async function renderEditHutForm(hut) { if (!editHutContent) return; const hutId = hut.id; const fotos = hut.fotos || []; let logs = []; try { const logSnap = await db.collection('eierhuetten').doc(hutId).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get(); logs = logSnap.docs.map(doc => doc.data()); } catch (err) { console.error(`Fehler Logs ${hutId}:`, err); } const selectedEmojis = new Set(normalizeToEmojiArray(hut.tiere || [])); const tiereHTML = Object.entries(TIERE_EMOJI_TO_NAME).map(([emoji, name]) => `<button type="button" data-hut-id="${hutId}" data-emoji="${emoji}" class="admin-tiere-btn text-2xl ${selectedEmojis.has(emoji) ? 'bg-yellow-200' : 'bg-slate-100'} rounded-lg p-1 transition" title="${name}">${emoji}</button>`).join(''); const tagsHTML = `${(hut.tags || []).map(t => `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">${t} <button type="button" onclick="removeTag('${hutId}','${t}')" class="ml-1 font-bold text-red-500 hover:text-red-700">×</button></span>`).join('')}<input type="text" placeholder="+ Tag" onkeydown="if(event.key==='Enter'&&this.value.trim()){addTag('${hutId}',this.value); this.value=''; this.placeholder='✔️';setTimeout(()=>this.placeholder='+ Tag',1500)}" class="form-input text-sm w-24 ml-2">`; const fotosFreigegeben = fotos.map((f, i) => { if (!f || (typeof f === 'object' && f.status !== 'freigegeben')) return ''; const url = typeof f === 'string' ? f : f.url; return `<div class="relative w-24 h-24 rounded-lg overflow-hidden border border-slate-300"><img src="${url}" class="object-cover w-full h-full"/><button type="button" onclick="deleteFoto('${hutId}', ${i})" class="absolute top-0 right-0 bg-red-600 text-white rounded-bl-lg px-1 text-sm font-bold hover:bg-red-700" title="Löschen">×</button></div>`; }).join('') || '<p class="text-slate-500 text-sm">Keine freigegebenen Fotos.</p>'; const fotosWartend = fotos.map((f, i) => { if (typeof f === 'string' || !f || typeof f !== 'object' || f.status !== 'wartet') return ''; return `<div class="relative w-24 h-24 rounded-lg border-2 border-yellow-400 border-dashed group"><img src="${f.url}" class="object-cover w-full h-full opacity-50 grayscale"/><div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/60 p-1 text-center">⏳ Wartet<div class="flex gap-1 mt-1"><button type="button" onclick="approveFoto('${hutId}', ${i})" class="btn btn-xs bg-green-500 p-1" title="Ok">✔</button><button type="button" onclick="geminiAnalyzeImage(this, '${f.url}')" class="btn btn-xs btn-ai p-1" title="AI?">🤖</button><button type="button" onclick="rejectFoto('${hutId}', ${i})" class="btn btn-xs bg-red-600 p-1" title="X">✖</button></div></div></div>`; }).join(''); const hutTypes = ['Eierhütte', 'Hofladen', 'Selbstbedienungshäuschen', 'Spielplatz', 'Abenteuerhof', 'Automat', 'Andere']; const typOptions = hutTypes.map(t => `<option value="${t}" ${hut.typ === t ? 'selected' : ''}>${t}</option>`).join(''); editHutContent.innerHTML = `<div class="space-y-4"><div><label class="form-label">Name:</label><input id="edit-name-${hutId}" class="form-input text-xl font-bold mt-1" value="${hut.name || ''}"></div><div><label class="form-label">Typ:</label><select id="edit-typ-${hutId}" class="form-select mt-1"><option value="">-- Wählen --</option>${typOptions}</select></div><div class="form-section"><label class="form-label">KI-Stichpunkte:</label><input type="text" id="edit-kiStichpunkte-${hutId}" value="${hut.kiStichpunkte || ''}" placeholder="z.B. Eier, Honig, 24/7" class="form-input mt-1"><button onclick="geminiGenerateDescription(this, '${hutId}')" class="btn btn-secondary btn-sm w-full mt-2 flex items-center justify-center gap-1">🤖 Beschreibung generieren</button></div><div><label class="form-label">Beschreibung:</label><textarea id="edit-beschreibung-${hutId}" class="form-textarea mt-1">${hut.beschreibung || ''}</textarea></div><div><label class="form-label">Tiere:</label><div class="flex flex-wrap gap-2 mt-1">${tiereHTML}</div></div><div><label class="form-label">Tags:</label><div class="flex flex-wrap gap-2 items-center mt-1">${tagsHTML}</div></div><div><label class="form-label">Fotos (OK):</label><div class="flex flex-wrap gap-2 mt-1">${fotosFreigegeben}</div></div>${fotosWartend ? `<div><label class="form-label">Fotos (Warten):</label><div class="flex flex-wrap gap-2 mt-1">${fotosWartend}</div></div>` : ''}<div><label class="form-label">📷 Neues Bild:</label><input type="file" accept="image/*" multiple onchange="initImageUpload(this, '${hutId}')" class="form-file mt-1"/></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="form-label">Sitzplätze:</label><select id="edit-sitzplaetze-${hutId}" class="form-select mt-1">${['Ja','Nein',''].map(o=>`<option value="${o}" ${o===hut.sitzplaetze?'selected':''}>${o||'k.A.'}</option>`).join('')}</select></div><div><label class="form-label">Strom:</label><select id="edit-strom-${hutId}" class="form-select mt-1">${['Ja','Nein',''].map(o=>`<option value="${o}" ${o===hut.strom?'selected':''}>${o||'k.A.'}</option>`).join('')}</select></div><div><label class="form-label">Status:</label><select id="edit-status-${hutId}" class="form-select mt-1">${['offen','angenommen','abgelehnt'].map(s=>`<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}</select></div></div><div class="minimap" id="edit-map-${hutId}"></div><details class="mt-3"><summary class="log-summary">Log (${logs.length})</summary><ul class="log-list">${logs.map(log=>`<li class="log-item"><strong>${log.admin||'System'}</strong>: ${log.feld} -> ${log.wert}<span class="log-time">${new Date(log.zeitpunkt?.seconds*1000||Date.now()).toLocaleString('de-DE', {dateStyle: 'short', timeStyle: 'short'})}</span></li>`).join('')}</ul></details><div class="flex justify-between items-center pt-4 border-t border-slate-200 mt-4"><button type="button" onclick="saveHutDetails()" class="btn btn-primary">💾 Speichern</button><button type="button" onclick="deleteHut('${hutId}')" class="btn btn-danger">🗑️ Löschen</button></div></div>`; initEditMap(hut); }
  function initEditMap(hut) { const mapId = `edit-map-${hut.id}`; const mapContainer = document.getElementById(mapId); if (!mapContainer || mapContainer.classList.contains('leaflet-container')) return; const lat = hut.location?.latitude || 51.16; const lng = hut.location?.longitude || 10.45; let editMap; try { editMap = L.map(mapId).setView([lat, lng], 13); } catch(e) { console.error("Map init error:", e); return; } L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap); const marker = L.marker([lat, lng], { draggable: true }).addTo(editMap); setTimeout(() => editMap.invalidateSize(), 150); marker.on('dragend', async (e) => { const newPos = e.target.getLatLng(); const kommentar = prompt('Kommentar zur Standortänderung (optional):'); try { await db.collection('eierhuetten').doc(hut.id).update({ location: new firebase.firestore.GeoPoint(newPos.lat, newPos.lng) }); await db.collection('eierhuetten').doc(hut.id).collection('log').add({ admin: currentUser.email, feld: 'location', wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`, kommentar: kommentar || '', zeitpunkt: new Date() }); showNotification(`📍 Standort aktualisiert.`); } catch (err) { showNotification(`❌ Fehler Standort Speichern: ${err.message}`); marker.setLatLng([lat, lng]); } }); }

  // --- Interaktive Elemente (Tiere, Tags) ---
  document.addEventListener('click', async (e) => { const btn = e.target.closest('.admin-tiere-btn'); if (!btn) return; const hutId = btn.dataset.hutId; const emoji = btn.dataset.emoji; if (!hutId || !emoji) return; const willSelect = !btn.classList.contains('bg-yellow-200'); btn.classList.toggle('bg-yellow-200', willSelect); btn.classList.toggle('bg-slate-100', !willSelect); try { await toggleTier(hutId, emoji); } catch (err) { console.error('toggleTier Fehler:', err); btn.classList.toggle('bg-yellow-200', !willSelect); btn.classList.toggle('bg-slate-100', willSelect === false); showNotification('❌ Fehler Tier-Auswahl.'); } });
  async function toggleTier(hutId, emoji) { const ref = db.collection('eierhuetten').doc(hutId); let newArray = []; await db.runTransaction(async tx => { const doc = await tx.get(ref); if (!doc.exists) throw new Error('Hütte weg'); let tiere = normalizeToEmojiArray(doc.data().tiere); const idx = tiere.indexOf(emoji); if (idx >= 0) { tiere.splice(idx, 1); } else { tiere = tiere.filter(t => t !== '❌'); tiere.push(emoji); } if (emoji === '❌' && idx < 0) { tiere = ['❌']; } newArray = tiere; tx.update(ref, { tiere }); }); try { await db.collection('eierhuetten').doc(hutId).collection('log').add({ admin: currentUser.email, feld: 'tiere', wert: newArray.join(', '), zeitpunkt: new Date() }); } catch (e) { console.warn('Log error', e); } showNotification(`🐾 Tiere aktualisiert`); }
  window.addTag = async function(hutId, tag) { tag = tag.trim(); if (!tag) return; try { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayUnion(tag) }); showNotification(`#${tag} +`); } catch (e) { showNotification(`❌ Fehler Tag +: ${e.message}`); } }
  window.removeTag = async function(hutId, tag) { try { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayRemove(tag) }); showNotification(`#${tag} -`); } catch (e) { showNotification(`❌ Fehler Tag -: ${e.message}`); } }

  // --- Paginierung, Suche & Filterung ---
  function renderPage(page) { if (page) currentPage = page; const start = (currentPage - 1) * hutsPerPage; const end = start + hutsPerPage; const source = filteredHuts.length > 0 || searchInput?.value.trim() ? filteredHuts : allHuts; const hutsToRender = source.slice(start, end); renderHuts(hutsToRender); renderPagination(source.length); }
  function renderPagination(totalItems) { const totalPages = Math.ceil(totalItems / hutsPerPage); const pc = document.getElementById('pagination'); if(!pc) return; pc.innerHTML = ''; if (totalPages <= 1) return; const createBtn = (lbl, pg) => { const btn = document.createElement('button'); btn.textContent = lbl; btn.disabled = pg === currentPage; btn.className = 'btn btn-sm btn-outline disabled:bg-slate-200 disabled:text-slate-500'; btn.onclick = () => renderPage(pg); return btn; }; if (currentPage > 1) pc.appendChild(createBtn('«', currentPage - 1)); for (let i = 1; i <= totalPages; i++) { if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { pc.appendChild(createBtn(i, i)); } else if (i === currentPage - 3 || i === currentPage + 3) { const dots = document.createElement('span'); dots.textContent = '...'; dots.className = 'px-2 py-1'; pc.appendChild(dots); } } if (currentPage < totalPages) pc.appendChild(createBtn('»', currentPage + 1)); }
  function applySearchAndSort() { const search = searchInput?.value.toLowerCase() || ""; const sortBy = document.getElementById("sortSelect")?.value || "name"; if (search) { filteredHuts = allHuts.filter(hut => (hut.name?.toLowerCase() || "").includes(search) || (hut.status?.toLowerCase() || "").includes(search) || (hut.typ?.toLowerCase() || "").includes(search) || (hut.tags || []).join(' ').toLowerCase().includes(search)); } else { filteredHuts = [...allHuts]; } filteredHuts.sort((a, b) => { if (sortBy === "name") return (a.name || "").localeCompare(b.name || ""); if (sortBy === "createdAt") return (b.erstelltAm?.toMillis?.() || 0) - (a.erstelltAm?.toMillis?.() || 0); return 0; }); renderPage(1); }

  // --- Hütten löschen ---
  window.deleteHut = async function(id) { if (!confirm('Hütte wirklich löschen? Kann nicht rückgängig gemacht werden.')) return; try { const doc = await db.collection('eierhuetten').doc(id).get(); if (!doc.exists) return showNotification('❌ Hütte weg.', 'bot'); const hut = doc.data(); if (hut.paypalSubscriptionId) { showNotification('🔄 Kündige Abo...', 'bot'); try { const cancelFn = firebase.functions().httpsCallable('cancelPaypalSubscription'); const result = await cancelFn({ subscriptionId: hut.paypalSubscriptionId }); if (result.data.success) { showNotification('✅ Abo gekündigt.', 'bot'); } else { if (!confirm(`⚠️ Abo Kündigung fehlgeschlagen.\nTrotzdem löschen?`)) { showNotification('🚫 Abbruch.', 'bot'); return; } } } catch (err) { if (!confirm(`⚠️ Fehler Abo Kündigung: ${err.message}\nTrotzdem löschen?`)) { showNotification('🚫 Abbruch.', 'bot'); return; } } } if (Array.isArray(hut.fotos)) { hut.fotos.forEach(f => { if (f?.delete_url) fetch(f.delete_url).catch(e => console.warn(`ImgBB delete failed: ${e.message}`)); }); } await db.collection('eierhuetten').doc(id).delete(); showNotification('🗑️ Hütte gelöscht.', 'bot'); showHutList(); } catch (err) { console.error('❌ Fehler Löschen:', err); showNotification('❌ Fehler Löschen.', 'bot'); } }

  // --- Live-Updates für Dashboard ---
  function initLivePendingFotos() { db.collection('eierhuetten').where('fotos', '!=', []).onSnapshot(snapshot => { const pending = []; snapshot.forEach(doc => { const data = doc.data(); if (Array.isArray(data.fotos) && data.fotos.some(f => f?.status === "wartet")) { pending.push({ id: doc.id, ...data }); } }); renderPendingFotos(pending); }, err => console.error("❌ Fehler Live Pending Fotos:", err)); }
  function renderPendingFotos(list) { const container = document.getElementById("pending-fotos"); if(!container) return; container.innerHTML = ""; const huetten = list.filter(h => Array.isArray(h.fotos) && h.fotos.some(f => f?.status === 'wartet')); if (huetten.length === 0) { container.innerHTML = "<p class='italic text-slate-500'>Keine Fotos warten.</p>"; return; } huetten.forEach(hut => { const wartende = (hut.fotos || []).map((f, i) => ({ f, i })).filter(item => item.f?.status === 'wartet'); if (wartende.length === 0) return; const card = document.createElement('div'); card.className = "bg-white border border-slate-200 p-3 rounded-lg mb-4 shadow-sm"; card.innerHTML = `<div class="flex justify-between items-center mb-2"><label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" ${pendingSelected.has(hut.id)?'checked':''} onchange="if(this.checked) pendingSelected.add('${hut.id}'); else pendingSelected.delete('${hut.id}');"><span class="font-semibold">${hut.name} (${wartende.length})</span></label><button class="btn btn-secondary btn-xs" onclick="showSection('huts'); showEditHut('${hut.id}');">🔎</button></div><div class="flex flex-wrap gap-2">${wartende.map(item => `<div class="relative group"><img src="${item.f.url}" title="Klick zum Freigeben" class="w-24 h-24 object-cover rounded-lg border cursor-pointer hover:ring-4 hover:ring-green-400" onclick="this.style.opacity='0.6'; approveFoto('${hut.id}', ${item.i}).catch(e=>{console.error(e); showNotification('❌ Fehler'); this.style.opacity='1';}).finally(() => this.closest('.relative')?.remove())"></div>`).join('')}</div>`; container.appendChild(card); }); const massBtn = document.createElement('button'); massBtn.textContent = "✅ Ausgewählte freigeben"; massBtn.className = "btn btn-primary btn-sm mt-4"; massBtn.onclick = async () => { if (pendingSelected.size === 0) return showNotification('ℹ️ Keine gewählt.'); massBtn.disabled = true; for (const id of Array.from(pendingSelected)) { await approveAllFotosForHut(id); } pendingSelected.clear(); massBtn.disabled = false; showNotification('✅ Ausgewählte freigegeben.'); }; container.appendChild(massBtn); }
  async function approveAllFotosForHut(hutId) { try { const ref = db.collection('eierhuetten').doc(hutId); const snap = await ref.get(); if (!snap.exists) return; let fotos = [...(snap.data().fotos || [])]; const indices = fotos.reduce((acc, f, i) => { if (f?.status === 'wartet') acc.push(i); return acc; }, []); if (indices.length > 0) { indices.forEach(i => { fotos[i] = { ...fotos[i], status: 'freigegeben' }; }); await ref.update({ fotos }); await ref.collection('log').add({ admin: currentUser.email, feld: 'fotos', wert: `${indices.length} Fotos freigegeben`, zeitpunkt: new Date() }); } } catch (err) { console.error(`Fehler Massenfreigabe ${hutId}:`, err); showNotification(`❌ Fehler Massenfreigabe ${hutId}`); } }
  function initLiveNewHuts() { db.collection('eierhuetten').where('status', '==', 'offen').onSnapshot(snapshot => { const neue = []; snapshot.forEach(doc => neue.push({ id: doc.id, ...doc.data() })); renderNewEntries(neue); renderStats(allHuts); }, err => console.error("❌ Fehler Live Neue Hütten:", err)); }
  function renderNewEntries(list) { const nl = document.getElementById("neueListe"); if(!nl) return; const neue = list.filter(h => h.status === "offen"); if (neue.length === 0) { nl.innerHTML = "<p class='italic text-slate-500'>Keine neuen.</p>"; return; } nl.innerHTML = ""; neue.forEach(hut => { const row = document.createElement("div"); row.className = "flex items-center justify-between bg-white shadow-sm rounded-lg px-3 py-2"; row.innerHTML = `<a href="javascript:void(0)" onclick="showSection('huts'); showEditHut('${hut.id}');" class="font-medium text-blue-600 hover:underline truncate max-w-[50%] block" title="${hut.name}">${hut.name}</a><div class="flex space-x-2"><button onclick="updateField('${hut.id}', 'status', 'angenommen')" class="btn btn-xs bg-green-500 text-white">Annehmen</button><button onclick="updateField('${hut.id}', 'status', 'abgelehnt')" class="btn btn-xs bg-red-500 text-white">Ablehnen</button></div>`; nl.appendChild(row); }); }

  // --- Support-Ticket-Logik ---
  window.currentReplyTicketId = null; window.currentReplyEmail = null;
  async function ladeSupportTickets() { try { const snapshot = await db.collection('support').orderBy('createdAt', 'desc').limit(50).get(); const body = document.getElementById('support-tickets-body'); if(!body) return; body.innerHTML = ''; if (snapshot.empty) { body.innerHTML = '<tr><td colspan="6" class="p-4 text-center italic text-slate-500">Keine Tickets.</td></tr>'; return; } snapshot.forEach(doc => { const ticket = doc.data(); const id = doc.id; const datum = ticket.createdAt?.toDate().toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' }) || '-'; const email = ticket.mail || '-'; const status = ticket.status || 'offen'; let aiTagsHTML = (ticket.aiTags || []).map(tag => `<span class="tag-ai">${tag}</span>`).join(' ') || (status === 'offen' ? `<button onclick="geminiTagTicket(this, '${id}')" class="tag-button">🤖 Taggen</button>` : ''); const row = document.createElement('tr'); row.className = "align-top hover:bg-slate-50"; row.id = `ticket-row-${id}`; row.innerHTML = `<td class="support-table td whitespace-nowrap">${datum}</td><td class="support-table td"><span title="${email}">${email.substring(0,20)}${email.length>20?'...':''}</span><br><span class="text-[10px] text-slate-400">ID: ${id.substring(0,5)}...</span></td><td class="support-table td"><div id="msgs-${id}" class="max-w-xs space-y-1">⏳...</div></td><td class="support-table td"><div id="ai-tags-${id}" class="flex flex-col gap-1 items-start">${aiTagsHTML}</div></td><td class="support-table td"><select onchange="updateSupportStatus('${id}', this.value)" class="form-select !p-1 !text-xs">${['offen','bearbeitet','geschlossen','archiviert'].map(opt=>`<option value="${opt}" ${opt===status?'selected':''}>${opt}</option>`).join('')}</select></td><td class="support-table td space-x-1 whitespace-nowrap"><button onclick="openReplyModal('${id}','${email}')" class="btn btn-primary btn-xs">Antwort</button><button onclick="loescheSupportTicket('${id}')" class="btn btn-danger btn-xs">X</button></td>`; body.appendChild(row); ladeSupportNachrichten(id); }); } catch(e) { console.error("Fehler Laden Tickets:", e); showNotification("❌ Fehler Laden Tickets."); } }
  function ladeSupportNachrichten(ticketId) { const wrap = document.getElementById("msgs-" + ticketId); if (!wrap) return; db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "asc").limit(10).get().then(snap => { wrap.innerHTML = ""; const msgsForAI = []; window.supportMessages[ticketId] = msgsForAI; if (snap.empty) { wrap.innerHTML = "<div class='text-slate-500 text-xs'>(leer)</div>"; return; } snap.forEach(mdoc => { const d = mdoc.data(); const zeit = d.createdAt?.toDate?.().toLocaleString('de-DE', { hour: '2-digit', minute: '2-digit' }) || "-"; msgsForAI.push({ sender: d.sender || '?', text: d.text || '' }); wrap.innerHTML += `<div class="msg-bubble ${d.sender === 'Admin' ? 'bg-blue-50' : 'bg-white'}"><p class="msg-text">${d.text || ''}</p><p class="msg-meta">${d.sender || '?'} · ${zeit}</p></div>`; }); wrap.scrollTop = wrap.scrollHeight; }).catch(err => { console.error(`Fehler Laden Nachrichten ${ticketId}:`, err); wrap.innerHTML = "<div class='text-red-500 text-xs'>Fehler</div>"; }).finally(() => { wrap.style.maxHeight = '150px'; wrap.style.overflowY = 'auto'; }); wrap.closest('td')?.style.verticalAlign = 'top'; }
  window.openReplyModal = function(ticketId, email) { window.currentReplyTicketId = ticketId; window.currentReplyEmail = email; document.getElementById("modal-ticket-info").innerText = `Ticket: ${ticketId.substring(0,5)}... User: ${email}`; document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-reply-counter").innerText = "500 Zeichen übrig"; document.getElementById("support-reply-modal").classList.remove("hidden"); document.getElementById("support-reply-modal").classList.add("flex"); }
  window.closeReplyModal = function() { document.getElementById("support-reply-modal").classList.add("hidden"); document.getElementById("support-reply-modal").classList.remove("flex"); window.currentReplyTicketId = null; window.currentReplyEmail = null; }
  window.sendReply = async function() { const text = document.getElementById("modal-reply-text").value.trim(); if (!text || !window.currentReplyTicketId) return; try { await db.collection("support").doc(window.currentReplyTicketId).collection("messages").add({ text, sender: "Admin", createdAt: firebase.firestore.FieldValue.serverTimestamp() }); await db.collection("support").doc(window.currentReplyTicketId).update({ status: "geschlossen" }); showNotification("✅ Antwort gesendet & geschlossen"); closeReplyModal(); ladeSupportTickets(); } catch (err) { console.error("sendReply error", err); alert("Fehler: " + err.message); } }
  window.updateSupportStatus = async function(id, status) { try { await db.collection('support').doc(id).update({ status }); showNotification('✅ Status aktualisiert'); if(status === 'offen') ladeSupportTickets(); } catch (e) { showNotification(`❌ Fehler: ${e.message}`); } }
  window.loescheSupportTicket = async function(id) { if (!confirm('Ticket löschen? Nachrichten bleiben evtl. erhalten.')) return; try { await db.collection('support').doc(id).delete(); showNotification('🗑️ Ticket gelöscht'); ladeSupportTickets(); } catch (e) { showNotification(`❌ Fehler: ${e.message}`); } }
  document.getElementById("modal-reply-text")?.addEventListener("input", e => { const left = 500 - (e.target.value.length || 0); document.getElementById("modal-reply-counter").innerText = `${left} Zeichen übrig`; });

  // --- Profil-Sektion ---
  window.loadProfileAdmin = async function(id) { const queryId = id || document.getElementById("profile-selected-id").value; let snap; try { if (queryId) { currentProfileId = queryId; snap = await db.collection("profiles").doc(currentProfileId).get(); } else { const queryName = document.getElementById("profile-search").value.trim(); if (!queryName) return alert("ID/Name?"); const q = await db.collection("profiles").where("name","==",queryName).limit(1).get(); if (!q.empty) { snap = q.docs[0]; currentProfileId = snap.id; } else { snap = await db.collection("profiles").doc(queryName).get(); currentProfileId = snap.id; } } if (!snap.exists) return alert("Profil nicht gefunden!"); const data = snap.data(); document.getElementById("profile-admin-area").classList.remove("hidden"); document.getElementById("profile-pic-admin").src = data.pic || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; document.getElementById("profile-pic-url").value = data.pic || ""; document.getElementById("profile-name-admin").value = data.name || ""; document.getElementById("profile-bio-admin").value = data.bio || ""; document.getElementById("profile-role-admin").value = data.role || "user"; document.getElementById("profile-banned-admin").checked = data.banned || false; document.getElementById("profile-stats").textContent = `Fahrten: ${data.rides||0} | Km: ${data.km||0} | Login: ${data.lastLogin?.toDate()?.toLocaleString('de-DE')||"–"}`; const titleSel = document.getElementById("profile-title-admin"); titleSel.innerHTML = "<option value=''>Kein Titel</option>"; const titleSnap = await db.collection("titles").get(); titleSnap.forEach(doc => { const t = doc.data(); const opt = document.createElement("option"); opt.value = t.name; opt.textContent = t.name; titleSel.appendChild(opt); }); titleSel.value = data.title || ""; const badgeContainer = document.getElementById("profile-badges-admin"); badgeContainer.innerHTML = ""; const badgeSnap = await db.collection("badgesDefs").get(); badgeSnap.forEach(doc => { const b = doc.data(); const id = `badge-chk-${doc.id}`; const wrapper = document.createElement('div'); wrapper.className = 'flex items-center gap-1'; const chk = document.createElement("input"); chk.type = "checkbox"; chk.value = doc.id; chk.id = id; chk.checked = (data.badges || []).includes(doc.id); chk.className = "form-checkbox"; wrapper.appendChild(chk); const lbl = document.createElement("label"); lbl.setAttribute('for', id); lbl.className = 'cursor-pointer text-sm'; lbl.textContent = `${b.icon||"🏅"} ${b.name}`; wrapper.appendChild(lbl); badgeContainer.appendChild(wrapper); }); } catch(e){ alert("Fehler Profil laden: " + e.message); console.error(e);} }
  window.saveProfileAdmin = async function() { if (!currentProfileId) return; const badges = [...document.querySelectorAll("#profile-badges-admin input:checked")].map(i => i.value); try { await db.collection("profiles").doc(currentProfileId).update({ name: document.getElementById("profile-name-admin").value, pic: document.getElementById("profile-pic-url").value, bio: document.getElementById("profile-bio-admin").value, title: document.getElementById("profile-title-admin").value, role: document.getElementById("profile-role-admin").value, banned: document.getElementById("profile-banned-admin").checked, badges: badges }); alert("✔️ Profil gespeichert!"); } catch (e) { alert(`❌ Fehler: ${e.message}`); } }
  window.deleteProfileAdmin = async function() { if (!currentProfileId || !confirm(`Profil ${currentProfileId} löschen? Auth bleibt!`)) return; try { await db.collection("profiles").doc(currentProfileId).delete(); alert("🗑️ Profil gelöscht!"); document.getElementById("profile-admin-area").classList.add("hidden"); document.getElementById("profile-search").value = ""; currentProfileId = null; } catch (e) { alert(`❌ Fehler: ${e.message}`); } }
  window.openProfileLink = function() { if (currentProfileId) window.open(`https://eierhuettentour.web.app/profile.html?id=${currentProfileId}`, "_blank"); } // TODO: URL anpassen
  document.getElementById('profile-search')?.addEventListener('input', async e => { const q = e.target.value.trim(); const box = document.getElementById('profile-suggestions'); if (q.length < 3) { box.classList.add('hidden'); document.getElementById('profile-selected-id').value = ''; return; } try { const snap = await db.collection('profiles').where('name', '>=', q).where('name', '<=', q + '\uf8ff').limit(5).get(); box.innerHTML = snap.empty ? "<p class='p-2 text-slate-500 italic'>Nix</p>" : snap.docs.map(d => { const name = d.data().name; const safeName = name.replace(/'/g, "&apos;").replace(/"/g, "&quot;"); return `<div class="p-2 hover:bg-slate-100 cursor-pointer" onclick="selectProfile('${d.id}', '${safeName}')">${name}</div>`; }).join(''); box.classList.remove('hidden'); } catch (e) { console.error("Profilsuche Fehler:", e); } });
  window.selectProfile = (id, name) => { document.getElementById('profile-search').value = name; document.getElementById('profile-selected-id').value = id; document.getElementById('profile-suggestions').classList.add('hidden'); loadProfileAdmin(id); };
  document.getElementById('profile-search')?.addEventListener('keydown', e => { if(e.key === 'Enter') { document.getElementById('profile-suggestions').classList.add('hidden'); loadProfileAdmin(); } });

  // --- Titel & Abzeichen Sektionen (Self-Contained Module) ---
  (async () => { const titleList = document.getElementById("title-list"); const titleForm = document.getElementById("title-form"); const titleNameEl = document.getElementById("title-name"); const titleCondEl = document.getElementById("title-condition"); const titleValEl = document.getElementById("title-value"); let titleEditId = null; async function loadTitles() { if (!titleList) return; try { const snap = await db.collection("titles").orderBy("name").get(); titleList.innerHTML = snap.empty ? "<p class='italic text-slate-500'>Keine Titel.</p>" : ""; snap.forEach(doc => { const t = doc.data(); const row = document.createElement("div"); row.className = "p-2 border border-slate-200 rounded-lg flex justify-between items-center"; row.innerHTML = `<span><strong>${t.name}</strong> (${t.conditionType} ≥ ${t.conditionValue})</span><div class="space-x-1"><button type="button" class="btn btn-secondary btn-xs" onclick="editTitle('${doc.id}')">✏️</button><button type="button" class="btn btn-danger btn-xs" onclick="deleteTitle('${doc.id}')">🗑️</button></div>`; titleList.appendChild(row); }); } catch(e) { console.error("Fehler Laden Titel:", e); } } window.editTitle = async (id) => { try { const doc = await db.collection("titles").doc(id).get(); const t = doc.data(); titleEditId = id; if (titleNameEl) titleNameEl.value = t.name || ""; if (titleCondEl) titleCondEl.value = t.conditionType || "rides"; if (titleValEl) titleValEl.value = t.conditionValue ?? 0; } catch (e) { console.error("Fehler Edit Titel:", e); } }; window.deleteTitle = async (id) => { if (confirm("Titel löschen?")) { try { await db.collection("titles").doc(id).delete(); await loadTitles(); } catch (e) { console.error("Fehler Delete Titel:", e); alert("Fehler beim Löschen."); } } }; if (titleForm) { titleForm.addEventListener("submit", async (e) => { e.preventDefault(); const payload = { name: (titleNameEl?.value || "").trim(), conditionType: titleCondEl?.value || "rides", conditionValue: parseInt(titleValEl?.value || "0") || 0 }; if (!payload.name) { alert("Name?"); return; } try { if (titleEditId) { await db.collection("titles").doc(titleEditId).update(payload); titleEditId = null; } else { await db.collection("titles").add(payload); } if (titleForm) titleForm.reset(); await loadTitles(); } catch (e) { console.error("Fehler Save Titel:", e); alert("Fehler beim Speichern."); } }); } const badgeList = document.getElementById("badge-list-admin"); const badgeForm = document.getElementById("badge-form"); let badgeEditId = null; async function loadBadges() { if (!badgeList) return; try { const snap = await db.collection("badgesDefs").orderBy("name").get(); badgeList.innerHTML = snap.empty ? "<p class='italic text-slate-500'>Keine Abzeichen.</p>" : ""; snap.forEach(doc => { const b = doc.data(); const icon = b.iconUrl ? `<img src="${b.iconUrl}" class="w-6 h-6 inline-block rounded object-contain"/>` : (b.icon || "🏅"); badgeList.innerHTML += `<div class="p-2 border border-slate-200 rounded-lg flex justify-between items-center"><span>${icon} <strong>${b.name}</strong> (${b.conditionType} ≥ ${b.conditionValue})</span><div class="space-x-1"><button type="button" onclick="editBadge('${doc.id}')" class="btn btn-secondary btn-xs">✏️</button><button type="button" onclick="deleteBadge('${doc.id}')" class="btn btn-danger btn-xs">🗑️</button></div>`; }); } catch(e) { console.error("Fehler Laden Abzeichen:", e); } } window.editBadge = async (id) => { try { const doc = await db.collection("badgesDefs").doc(id).get(); const b = doc.data(); badgeEditId = id; ['badge-name', 'badge-icon', 'badge-condition', 'badge-value'].forEach(elId => { const el = document.getElementById(elId); if (el) { if (elId === 'badge-name') el.value = b.name || ''; else if (elId === 'badge-icon') el.value = b.icon || ''; else if (elId === 'badge-condition') el.value = b.conditionType || 'rides'; else if (elId === 'badge-value') el.value = b.conditionValue ?? 0; } }); document.getElementById('badge-icon-file').value = ''; // Reset file input } catch (e) { console.error("Fehler Edit Badge:", e); } }; window.deleteBadge = async (id) => { if (confirm("Abzeichen löschen?")) { try { await db.collection("badgesDefs").doc(id).delete(); await loadBadges(); } catch (e) { console.error("Fehler Delete Badge:", e); alert("Fehler beim Löschen."); } } }; if (badgeForm) { badgeForm.addEventListener("submit", async (e) => { e.preventDefault(); const name = document.getElementById("badge-name")?.value.trim(); if (!name) return alert("Name?"); let iconUrl = ""; const fileInput = document.getElementById("badge-icon-file"); if (fileInput.files.length > 0) { try { iconUrl = await badgeFormUploadToImgBB(fileInput.files[0]); } catch (err) { alert(`❌ Upload Fehler: ${err}`); return; } } const payload = { name, icon: document.getElementById("badge-icon")?.value.trim(), iconUrl, conditionType: document.getElementById("badge-condition")?.value, conditionValue: parseInt(document.getElementById("badge-value")?.value) || 0, createdAt: new Date() }; try { if (badgeEditId) { await db.collection("badgesDefs").doc(badgeEditId).update(payload); badgeEditId = null; } else { await db.collection("badgesDefs").add(payload); } alert("✅ Abzeichen gespeichert"); e.target.reset(); await loadBadges(); } catch (e) { console.error("Fehler Save Badge:", e); alert("Fehler beim Speichern."); } }); } async function badgeFormUploadToImgBB(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = async () => { const base64 = reader.result.split(",")[1]; const fd = new FormData(); fd.append("key", "5df04de9bfd2776f101329be4193e44c"); fd.append("image", base64); try { const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: fd }); const json = await res.json(); if (json?.data?.url) resolve(json.data.url); else reject(json.error?.message || 'ImgBB Fehler'); } catch (err) { reject(err); } }; reader.onerror = () => reject("❌ Datei lesen Fehler."); reader.readAsDataURL(file); }); } auth.onAuthStateChanged(user => { if(user) { loadTitles(); loadBadges(); } }); })();

</script>

</body>
</html>
