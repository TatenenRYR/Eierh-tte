<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin – Eierhütten</title>
  <style>
    body { font-family: Arial; padding: 1em; background: #f4f4f4; }
    h1 { text-align: center; }
    .search-bar { text-align: center; margin-bottom: 1em; }
    input[type="text"] { padding: 0.5em; width: 60%; font-size: 1em; }
    .hut { background: #fff; border: 1px solid #ccc; margin: 1em 0; padding: 1em; border-radius: 8px; }
    .hut.error { background-color: #ffe5e5; color: #a00; }
    .actions { margin-top: 0.5em; }
    button { padding: 0.4em 0.8em; margin-right: 0.5em; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
</head>
<body>
  <h1>🐣 Admin – Eierhütten</h1>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Suche nach Name, Ort oder Kategorie..." onkeyup="filterHuts()">
  </div>
  <div id="hutList">⏳ Lade Hütten...</div>

  <script>
    // 🔧 Deine Firebase Konfiguration einfügen
    const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const storage = firebase.storage();
    const db = firebase.firestore();
    const functions = firebase.app().functions("us-central1");

    let allHuts = [];

    function loadHuts() {
      db.collection("eierhuetten").get()
        .then(snapshot => {
          allHuts = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            allHuts.push(data);
          });
          renderHuts(allHuts);
        })
        .catch(err => {
          console.error("❌ Fehler beim Laden:", err);
          document.getElementById("hutList").innerHTML = "<p>❌ Fehler beim Laden.</p>";
        });
    }

    function renderHuts(huts) {
      const container = document.getElementById("hutList");
      container.innerHTML = "";

      if (huts.length === 0) {
        container.innerHTML = "<p>❌ Keine Hütten gefunden.</p>";
        return;
      }

      huts.forEach(hut => {
        const div = document.createElement("div");
        div.className = "hut";

        if (!hut.name || !hut.ort) {
          div.classList.add("error");
          div.innerHTML = `<strong>⚠️ Fehlerhafte Hütte (ID: ${hut.id})</strong><br>Unvollständige Daten.`;
          container.appendChild(div);
          return;
        }

        div.innerHTML = `
          <strong>${hut.name}</strong><br>
          📍 ${hut.ort}<br>
          🗂️ ${hut.kategorie || "-"}<br>
          💬 Status: ${hut.status || "?"}<br>
          ${hut.paypalSubscriptionId ? "💳 Abo vorhanden" : "– kein Abo –"}
          <div class="actions">
            <button onclick="deleteHut('${hut.id}', '${hut.paypalSubscriptionId || ''}')">🗑️ Löschen</button>
            <button onclick="toggleStatus('${hut.id}')">🔁 Status wechseln</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function deleteHut(id, subscriptionId) {
      if (!confirm("Diese Hütte wirklich löschen?")) return;

      if (subscriptionId) {
        console.log("➡️ Sende Abo-Kündigung für:", subscriptionId);
        const cancelFn = functions.httpsCallable("cancelPaypalSubscription");

        cancelFn({ subscriptionId })
          .then(res => {
            if (res.data && res.data.success) {
              console.log("✅ Abo gekündigt. Hütte wird gelöscht.");
              deleteHutFromFirestore(id);
            } else {
              console.warn("❌ Kündigung fehlgeschlagen:", res.data);
              alert("❌ Kündigung fehlgeschlagen.");
            }
          })
          .catch(err => {
            console.error("❌ Fehler bei Kündigung:", err.message || err);
            alert("Fehler beim Kündigen des Abos.");
          });
      } else {
        deleteHutFromFirestore(id);
      }
    }

    function deleteHutFromFirestore(id) {
      db.collection("eierhuetten").doc(id).delete()
        .then(() => {
          console.log("🗑️ Hütte gelöscht:", id);
          allHuts = allHuts.filter(h => h.id !== id);
          renderHuts(allHuts);
        })
        .catch(err => {
          console.error("❌ Fehler beim Löschen:", err);
          alert("Fehler beim Löschen.");
        });
    }

    function toggleStatus(id) {
      const hut = allHuts.find(h => h.id === id);
      if (!hut) return;

      const neuerStatus = hut.status === "aktiv" ? "offen" : "aktiv";
      db.collection("eierhuetten").doc(id).update({ status: neuerStatus })
        .then(() => {
          hut.status = neuerStatus;
          renderHuts(allHuts);
        })
        .catch(err => {
          console.error("❌ Fehler beim Ändern des Status:", err);
          alert("Fehler beim Statuswechsel.");
        });
    }

    function filterHuts() {
      const val = document.getElementById("searchInput").value.toLowerCase();
      const filtered = allHuts.filter(hut =>
        (hut.name || "").toLowerCase().includes(val) ||
        (hut.ort || "").toLowerCase().includes(val) ||
        (hut.kategorie || "").toLowerCase().includes(val)
      );
      renderHuts(filtered);
    }

    loadHuts();
  </script>
</body>
</html>
