<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .minimap { height: 200px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
    .progress-bar { width: 100%; background-color: #e5e7eb; border-radius: 0.5rem; margin-top: 5px; }
    .progress-fill { height: 8px; background-color: #10b981; border-radius: 0.5rem; width: 0%; transition: width 0.3s; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; }
    .nav-btn {
    @apply text-left px-3 py-2 rounded hover:bg-green-50 transition;
    }
    .nav-btn.active {
    @apply bg-green-100 text-green-800 font-semibold;
    }
    .section-title {
    @apply text-2xl font-bold mb-4 border-b pb-2;
    }
    .dash-section {
    @apply space-y-4;
    }
    /* ü§ñ NEU: Lade-Spinner f√ºr Buttons */
    .spinner {
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 2px solid #fff;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 4px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-gray-100">
  <div id="notification"></div>

  <div id="login-section" class="flex items-center justify-center h-screen">
    <button id="login-btn"
      class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded">
      Admin Login mit Google
    </button>
  </div>

  <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
    <button id="menu-toggle"
            class="md:hidden p-2 text-gray-700 border rounded">
      ‚ò∞ Men√º
    </button>
    <aside id="sidebar" class="w-full md:w-64 bg-white shadow-md md:block hidden md:flex-shrink-0">
      <div class="p-4 border-b">
        <h1 class="text-xl font-bold text-green-700">üèò H√ºtten Admin</h1>
      </div>
      <nav class="p-4 space-y-1">
        <button class="nav-btn w-full" onclick="showSection('overview')">üìä √úbersicht</button>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºttenliste</button>
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets</button>
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile</button>
        <button class="nav-btn w-full" onclick="showSection('titles')">üëë Titel</button>
        <button class="nav-btn w-full" onclick="showSection('badges')">üèÖ Abzeichen</button>
      </nav>
    </aside>

    <main class="flex-1 p-6 space-y-8 overflow-y-auto">
      <section id="overview" class="dash-section">
        <h2 class="section-title">üìä √úbersicht</h2>
        <div id="stats" class="text-gray-700"></div>
        <div id="statsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        <canvas id="statsChart" class="bg-white rounded shadow p-4 mt-6"></canvas>
        <h2 class="section-title">üÜï Neue Eintragungen</h2>
        <div id="neueListe" class="space-y-2 bg-gray-50 p-4 rounded shadow"></div>

       <h2 class="section-title">üì∑ Fotos warten auf Freigabe</h2>
        <div id="pending-fotos" class="space-y-2 bg-gray-50 p-4 rounded shadow"></div>
      </section>

      <section id="huts" class="dash-section hidden">
        <h2 class="section-title">üè† Alle H√ºtten</h2>
        <div class="flex items-center gap-2 mb-4">
          <select id="sortSelect" class="p-2 border rounded">
            <option value="name">üî§ Nach Name</option>
            <option value="createdAt">üïí Neueste zuerst</option>
          </select>
          <input id="search-input" placeholder="üîç Suchen..." class="p-2 border rounded w-full">
        </div>
        <div id="hut-list" class="space-y-4"></div>
        <div id="pagination" class="mt-4 flex flex-wrap justify-center gap-2"></div>
      </section>

      <section id="support" class="dash-section hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="overflow-auto bg-white rounded shadow">
          <table class="min-w-full text-sm">
            <thead class="bg-blue-100 text-left">
              <tr>
                <th class="px-4 py-2">Datum</th>
                <th class="px-4 py-2">User</th>
                <th class="px-4 py-2">Nachrichten</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Aktionen</th>
              </tr>
            </thead>
            <tbody id="support-tickets-body" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <div id="support-reply-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-4 rounded shadow max-w-lg w-full">
          <h3 class="text-lg font-bold mb-2">Antwort auf Ticket</h3>
          <div id="modal-ticket-info" class="text-xs text-gray-500 mb-2"></div>
          <textarea id="modal-reply-text" class="w-full border p-2 rounded mb-2" rows="5" maxlength="500"></textarea>
          
          <button id="gemini-suggest-btn" onclick="geminiSuggestReply(this)" class="bg-purple-600 text-white px-3 py-1 rounded text-sm mb-2 w-full">
            ü§ñ Antwort vorschlagen
          </button>
          
          <div class="text-xs text-gray-500 mb-3" id="modal-reply-counter">500 Zeichen √ºbrig</div>
          <div class="flex justify-end gap-2">
            <button onclick="closeReplyModal()" class="px-3 py-1 bg-gray-300 rounded">Abbrechen</button>
            <button onclick="sendReply()" class="px-3 py-1 bg-green-600 text-white rounded">Antworten & schlie√üen</button>
          </div>
        </div>
      </div>
      
      <section id="profiles" class="dash-section hidden">
        <h2 class="section-title">üë§ Profile Verwaltung</h2>
        <div class="bg-white p-4 rounded shadow space-y-3">
          <div class="relative">
            <input id="profile-search" type="text" class="w-full border p-2 rounded" placeholder="Profil suchen..." />
            <input type="hidden" id="profile-selected-id">
            <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded shadow hidden"></div>
          </div>
          <div id="profile-admin-area" class="hidden space-y-4">
            <div class="flex items-center space-x-4">
              <img id="profile-pic-admin" class="w-24 h-24 rounded-full border" />
              <input id="profile-pic-url" class="flex-1 border p-2 rounded" placeholder="Profilbild-URL √§ndern..." />
            </div>
            <input id="profile-name-admin" class="w-full border p-2 rounded" placeholder="Name" />
            <textarea id="profile-bio-admin" class="w-full border p-2 rounded" placeholder="Kurzbeschreibung / Bio"></textarea>
            <label class="block font-bold">Titel</label>
            <select id="profile-title-admin" class="w-full border p-2 rounded"></select>
            <label class="block font-bold">Abzeichen</label>
            <div id="profile-badges-admin" class="flex flex-wrap gap-2"></div>
            <label class="block font-bold">Rolle</label>
            <select id="profile-role-admin" class="w-full border p-2 rounded">
              <option value="user">üë§ User</option>
              <option value="admin">üëë Admin</option>
              <option value="mod">üõ°Ô∏è Moderator</option>
            </select>
            <label class="inline-flex items-center space-x-2">
              <input id="profile-banned-admin" type="checkbox" class="form-checkbox">
              <span>üö´ Account gesperrt</span>
            </label>
            <div class="text-sm text-gray-600" id="profile-stats"></div>
            <div class="flex space-x-2">
              <button onclick="saveProfileAdmin()" class="bg-green-600 text-white px-3 py-1 rounded">üíæ Speichern</button>
              <button onclick="deleteProfileAdmin()" class="bg-red-600 text-white px-3 py-1 rounded">üóëÔ∏è L√∂schen</button>
              <button onclick="openProfileLink()" class="bg-purple-600 text-white px-3 py-1 rounded">üîó √ñffnen</button>
            </div>
          </div>
        </div>
      </section>

      <section id="titles" class="dash-section hidden">
        <h2 class="text-2xl font-bold mt-10 mb-4 text-indigo-700">üëë Titel Verwaltung</h2>
        <div id="title-list" class="space-y-2 bg-white p-4 rounded shadow"></div>
        <form id="title-form" class="mt-4 space-y-2">
          <input id="title-name" placeholder="Titel-Name" class="border p-2 rounded w-full">
          <select id="title-condition" class="border p-2 rounded w-full">
            <option value="rides">Anzahl Fahrten</option>
            <option value="distance">Gesamtkilometer</option>
          </select>
          <input id="title-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full">
          <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">‚ûï Titel speichern</button>
        </form>
      </section>

      <section id="badges" class="dash-section hidden">
        <h2 class="section-title">üèÖ Abzeichen Verwaltung</h2>
        <div id="badge-list-admin" class="space-y-2 bg-white p-4 rounded shadow"></div>
        <form id="badge-form" class="mt-4 space-y-2">
          <input id="badge-name" placeholder="Abzeichen-Name" class="border p-2 rounded w-full">
          <label class="block font-bold">Icon hochladen</label>
          <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded">
          <small class="text-gray-500">Oder Emoji eintragen:</small>
          <input id="badge-icon" placeholder="Emoji/Icon (Fallback)" class="border p-2 rounded w-full">
          <select id="badge-condition" class="border p-2 rounded w-full">
            <option value="rides">Anzahl Fahrten</option>
            <option value="distance">Gesamtkilometer</option>
            <option value="night">Nachtfahrt</option>
          </select>
          <input id="badge-value" type="number" placeholder="Bedingung Wert" class="border p-2 rounded w-full">
          <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">‚ûï Abzeichen speichern</button>
        </form>
      </section>
    </main>
  </div>

<div id="admin-map" style="display:none;"></div>
<form id="admin-hut-form" style="display:none;">
  <input id="admin-hut-name" type="text">
  <input id="admin-hut-images" type="file">
</form>

<script type="module">
  // Importiere die Gemini AI-Bibliothek
  import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "https://sdk.gemini.ai/v1.5/gemini-ai.js";

  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è GEF√ÑHRLICH: API-Key ist hier √∂ffentlich sichtbar! NUR ZUM TESTEN! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
  const GEMINI_API_KEY = "AIzaSyB3FT8CdN9WkNjfQ5vutbjLCEibGSl3nnQ";

  // Globale Instanz und Sicherheitseinstellungen
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
  
  const safetySettings = [
    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
  ];

  // Das Gemini-Modell, das wir verwenden (Flash ist schnell und g√ºnstig)
  const model = genAI.getGenerativeModel({
    model: "gemini-1.5-flash",
    safetySettings,
  });

  console.log("ü§ñ Gemini AI (Frontend-Modus) initialisiert. Key ist sichtbar!");

  // --- Helper-Funktion f√ºr Lade-Buttons ---
  function setButtonLoading(button, isLoading) {
    if (isLoading) {
      button.disabled = true;
      button.innerHTML = `<span class="spinner"></span> Bitte warten...`;
    } else {
      button.disabled = false;
      // Text wird von der aufrufenden Funktion wiederhergestellt
    }
  }
  
  // --- 1. KI-FUNKTION: Support-Antwort vorschlagen ---
  
  // Mache die Funktion im globalen 'window'-Objekt verf√ºgbar,
  // damit der 'onclick'-Handler im HTML sie finden kann.
  window.geminiSuggestReply = async (button) => {
    const originalText = button.innerHTML;
    setButtonLoading(button, true);
    
    const replyText = document.getElementById("modal-reply-text");
    const ticketId = window.currentReplyTicketId; // Diese Variable wird in openReplyModal gesetzt
    
    if (!ticketId) {
      alert("Fehler: Keine Ticket-ID gefunden.");
      setButtonLoading(button, false);
      button.innerHTML = originalText;
      return;
    }

    // Hole den Nachrichtenverlauf (wird in ladeSupportNachrichten gespeichert)
    const history = window.supportMessages[ticketId];
    if (!history || history.length === 0) {
      alert("Fehler: Konnte Nachrichtenverlauf nicht laden.");
      setButtonLoading(button, false);
      button.innerHTML = originalText;
      return;
    }

    const prompt = `
      Du bist ein freundlicher und professioneller Support-Mitarbeiter f√ºr "H√ºtten Admin".
      Ein Nutzer hat ein Support-Ticket eingereicht.
      Hier ist der bisherige Nachrichtenverlauf:
      ${JSON.stringify(history, null, 2)}

      Bitte verfasse eine hilfreiche und h√∂fliche Antwort auf die LETZTE Nutzeranfrage.
      Fasse dich kurz (maximal 3-4 S√§tze).
      Sprich den Nutzer mit "Hallo" an und unterschreibe mit "Viele Gr√º√üe, Dein H√ºtten-Support-Team".
      Gib NUR den Text der Antwort zur√ºck, ohne zus√§tzliches Markup.
    `;

    try {
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      replyText.value = text;
      // Trigger input event, um den Zeichenz√§hler zu aktualisieren
      replyText.dispatchEvent(new Event('input')); 
      
    } catch (e) {
      console.error("Gemini Fehler (Reply):", e);
      alert("Fehler bei der AI-Anfrage: " + e.message);
    } finally {
      setButtonLoading(button, false);
      button.innerHTML = originalText;
    }
  };


  // --- 2. KI-FUNKTION: Foto analysieren ---
  
  // Helper-Funktion, um Bild-URL in Base64 umzuwandeln
  // ‚ö†Ô∏è HINWEIS: Dies wird sehr wahrscheinlich an CORS-Sperren von imgbb.com scheitern!
  // Ein Server-Backend (Firebase Function) hat dieses Problem nicht.
  async function fetchImageAsBase64(url) {
      // Wir verwenden einen √∂ffentlichen CORS-Proxy NUR ZUM TESTEN.
      // Das ist langsam und unzuverl√§ssig, aber umgeht CORS im Browser.
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      
      console.log("Versuche Bild √ºber Proxy zu laden:", proxyUrl);
      
      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error(`Netzwerkfehler: ${response.statusText}`);
        
        const blob = await response.blob();
        
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve({
              inlineData: {
                  data: reader.result.split(',')[1],
                  mimeType: blob.type
              }
          });
          reader.onerror = (error) => {
            console.error("FileReader Error:", error);
            reject("Fehler beim Lesen der Bilddatei.");
          };
          reader.readAsDataURL(blob);
        });
      } catch (error) {
         console.error('Fehler beim Laden oder Konvertieren des Bildes:', error);
         throw new Error("Fehler beim Laden des Bildes (evtl. CORS oder Proxy-Problem).");
      }
  }

  window.geminiAnalyzeImage = async (button, imageUrl) => {
    const originalText = button.innerHTML;
    setButtonLoading(button, true);

    let imagePart;
    try {
      imagePart = await fetchImageAsBase64(imageUrl);
    } catch (e) {
      console.error(e);
      alert("Fehler bei der Bildanalyse: " + e.message + "\n\nDies liegt wahrscheinlich an einer CORS-Sperre. Ein Backend (Firebase Function) l√∂st dieses Problem.");
      setButtonLoading(button, false);
      button.innerHTML = originalText;
      return;
    }

    const prompt = `
      Analysiere dieses Bild und antworte im JSON-Format.
      1. Ist dieses Bild f√ºr eine App √ºber Wanderh√ºtten/Hofl√§den geeignet? (ja/nein/vielleicht)
      2. Was ist auf dem Bild haupts√§chlich zu sehen? (z.B. "Eine Holzh√ºtte", "Ein Selfie", "Essen")
      3. Enth√§lt das Bild unangemessene Inhalte (Nacktheit, Gewalt)? (ja/nein)

      Beispiel-Antwort:
      {"geeignet": "ja", "inhalt": "Eine Holzh√ºtte im Wald", "unangemessen": "nein"}
    `;

    try {
      const result = await model.generateContent([prompt, imagePart]);
      const response = await result.response;
      let text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();
      
      console.log("AI-Foto-Analyse Roh-Antwort:", text);
      const analysis = JSON.parse(text);
      
      // Zeige das Ergebnis in einem Alert an
      alert(
        `ü§ñ AI-Foto-Check:\n\n` +
        `Geeignet: ${analysis.geeignet}\n` +
        `Inhalt: ${analysis.inhalt}\n` +
        `Unangemessen: ${analysis.unangemessen}`
      );

    } catch (e) {
      console.error("Gemini Fehler (Image):", e);
      alert("Fehler bei der AI-Bildanalyse: " + e.message);
    } finally {
      setButtonLoading(button, false);
      button.innerHTML = originalText;
    }
  };


  // --- 3. KI-FUNKTION: H√ºtten-Daten auditieren ---
  window.geminiAuditHut = async (button, hutId) => {
    const originalText = button.innerHTML;
    setButtonLoading(button, true);

    // Finde die H√ºtte in den globalen Daten
    const hut = window.allHuts.find(h => h.id === hutId);
    if (!hut) {
      alert("Fehler: H√ºtte nicht gefunden.");
      setButtonLoading(button, false);
      button.innerHTML = originalText;
      return;
    }

    const prompt = `
      F√ºhre ein kurzes Audit f√ºr folgenden Datensatz einer H√ºtte durch.
      Antworte als JSON-Objekt.
      - Name: "${hut.name}"
      - Beschreibung: "${hut.beschreibung || "Keine"}"
      - Aktuelle Tags: [${(hut.tags || []).join(", ")}]

      Dein JSON-Audit soll enthalten:
      1. "qualitaet": Eine Bewertung der Beschreibung (z.B. "Sehr gut", "Gut", "Zu kurz", "Fehlt").
      2. "vorschlag": Ein kurzer Satz, um die Beschreibung zu verbessern (oder "Perfekt", wenn gut).
      3. "tags": Ein Array mit 3-5 Tag-Vorschl√§gen (Strings), die zur Beschreibung passen.

      Beispiel-Antwort:
      {
        "qualitaet": "Zu kurz",
        "vorschlag": "Die Beschreibung sollte Details zu Produkten oder √ñffnungszeiten enthalten.",
        "tags": ["Hofladen", "Eier", "Regional"]
      }
    `;

    try {
      const result = await model.generateContent(prompt);
      const response = await result.response;
      let text = response.text().replace(/```json/g, "").replace(/```/g, "").trim();
      
      console.log("AI-Audit Roh-Antwort:", text);
      const audit = JSON.parse(text);

      alert(
        `ü§ñ AI-Audit f√ºr "${hut.name}":\n\n` +
        `Qualit√§t: ${audit.qualitaet}\n` +
        `Vorschlag: ${audit.vorschlag}\n` +
        `Tag-Vorschl√§ge: ${audit.tags.join(", ")}`
      );

    } catch (e) {
      console.error("Gemini Fehler (Audit):", e);
      alert("Fehler beim AI-Audit: " + e.message);
    } finally {
      setButtonLoading(button, false);
      button.innerHTML = originalText;
    }
  };

</script>


<script>
  // Wichtig: 'window.allHuts' wird f√ºr AI-Funktionen ben√∂tigt
  let allHuts = [];
  // Wichtig: 'window.supportMessages' wird f√ºr AI-Funktionen ben√∂tigt
  window.supportMessages = {}; // Speichert Nachrichtenverl√§ufe pro Ticket-ID

  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  const hutList = document.getElementById('hut-list');
  const searchInput = document.getElementById('search-input');
  const notification = document.getElementById('notification');
  const stats = document.getElementById('stats');
  let huts = [], currentUser = null;
  let adminMarker;
  let adminMap;
  let adminLocation;


  // === TIERE MAPPING / Normalisierung (global) ===
  const TIERE_EMOJI_TO_NAME = {
    "ü¶ô": "Alpaka", "üêÑ": "Kuh", "üêñ": "Schwein", "üêê": "Ziege", "üêë": "Schaf",
    "üê∂": "Hund", "üê±": "Katze", "üêá": "Hase", "üêî": "Huhn", "ü¶Ü": "Ente",
    "üê¥": "Pferd", "‚ùå": "Keine Tiere"
  };
  const TIERE_NAME_TO_EMOJI = Object.fromEntries(
    Object.entries(TIERE_EMOJI_TO_NAME).map(([e, n]) => [n, e])
  );

  function normalizeToEmojiArray(arr) {
    if (!Array.isArray(arr)) return [];
    return arr.map(v => {
      if (!v) return null;
      v = String(v).trim();
      if (TIERE_EMOJI_TO_NAME[v]) return v;
      if (TIERE_NAME_TO_EMOJI[v]) return TIERE_NAME_TO_EMOJI[v];
      return null;
    }).filter(Boolean);
  }
    
  document.addEventListener('DOMContentLoaded', () => {
    adminMap = L.map('admin-map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap);
    adminMarker = L.marker([51.1657, 10.4515], { draggable: true }).addTo(adminMap);
    adminMarker.on('dragend', e => {
      const pos = e.target.getLatLng();
      adminLocation = new firebase.firestore.GeoPoint(pos.lat, pos.lng);
    });
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      adminMap.setView([latitude, longitude], 13);
      adminMarker.setLatLng([latitude, longitude]);
      adminLocation = new firebase.firestore.GeoPoint(latitude, longitude);
    });
  });

  // Formular absenden
  document.getElementById('admin-hut-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!adminLocation) return alert('‚ùå Bitte w√§hle einen Standort auf der Karte.');
    editingData = {
      name: document.getElementById('admin-hut-name').value.trim(),
      location: adminLocation, fotos: []
    };
    const files = document.getElementById('admin-hut-images').files;
    if (files.length > 0) {
      addMessage(`‚è≥ Lade ${files.length} Bild(er) hoch...`, 'bot');
      const uploads = [];
      for (let file of files) {
        try {
          const img = await uploadToImgBB(file);
          uploads.push(img);
        } catch (err) {
          console.error('‚ùå Upload-Fehler:', err);
          addMessage('‚ùå Fehler beim Hochladen eines Bildes.', 'bot');
        }
      }
      editingData.fotos = uploads;
    }
    submitNewHutAdmin();
  });

  async function submitNewHutAdmin() {
    if (!editingData.name || !editingData.location) {
      addMessage('‚ùå Bitte gib alle Daten ein (mindestens Name und Standort).', 'bot');
      return;
    }
    const validFotos = (editingData.fotos || []).filter(f =>
      typeof f === 'object' && f.url && f.delete_url
    );
    const hut = {
      ...editingData,
      userId: currentUser.uid,
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'angenommen',
      fotos: validFotos,
      aboMonate: null,
      paypalSubscriptionId: null,
      datenschutzZustimmung: {
        best√§tigtAm: firebase.firestore.FieldValue.serverTimestamp(),
        durch: firebase.auth().currentUser?.email || "Admin"
      }
    };
    try {
      await db.collection('eierhuetten').add(hut);
      addMessage('‚úÖ H√ºtte ohne PayPal erfolgreich erstellt und freigeschaltet.', 'bot');
      step = 0; editingData = {}; showMyHuts();
    } catch (err) {
      addMessage('‚ùå Fehler beim Erstellen der H√ºtte: ' + err.message, 'bot');
    }
  }
    
  function showNotification(message) {
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 4000);
  }

  document.getElementById('login-btn').onclick = () => {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  };

  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user;
      const adminDoc = await db.collection('admins').doc(user.email).get();
      if (!adminDoc.exists) {
        alert('Zugriff verweigert: Du bist kein Admin.');
        return;
      }
      loginSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      db.collection('eierhuetten').onSnapshot(() => {
        showNotification('üîÑ Live-Update: H√ºttendaten wurden aktualisiert.');
        loadHuts();
      });
      showSection('overview');
      initLiveNewHuts();
      initLivePendingFotos();
      ladeSupportTickets();
    }
  });

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.trim().toLowerCase();
    if (!term) {
      filteredHuts = [];
    } else {
      filteredHuts = allHuts.filter(hut => {
        return [
          hut.name, hut.status, hut.paypalSubscriptionId,
          hut.strom, hut.sitzplaetze, hut.oeffnungszeiten
        ].some(field => (field || '').toLowerCase().includes(term));
      });
    }
    currentPage = 1;
    renderPage();
  });

  function normalizeHutId(hutId) {
    if (!hutId && hutId !== 0) return null;
    if (typeof hutId === 'object') return hutId.id || hutId?.toString?.() || null;
    return String(hutId);
  }

  async function loadHuts() {
    const snapshot = await db.collection('eierhuetten').orderBy('erstelltAm', 'desc').get();
    // ü§ñ Global 'allHuts' aktualisieren, damit AI-Funktionen darauf zugreifen k√∂nnen
    allHuts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    currentPage = 1;
    renderPage(currentPage);
    renderStats(allHuts);
  }

  let statsChart; 
  function renderStats(list) {
    const total = list.length;
    const withStrom = list.filter(h => h.strom === 'Ja').length;
    const withFotos = list.filter(h => Array.isArray(h.fotos) && h.fotos.length > 0).length;
    const count247 = list.filter(h => h.oeffnungszeiten === '24/7').length;
    const newEntries = list.filter(h => h.status === 'offen').length;
    const pendingFotos = list.reduce((sum, h) =>
        sum + (Array.isArray(h.fotos)
              ? h.fotos.filter(f => f.status === 'wartet').length
              : 0), 0);
    const c = document.getElementById("statsContainer");
    c.innerHTML = `
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${total}</p><p class="text-gray-500">Gesamt&nbsp;H√ºtten</p></div>
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${newEntries}</p><p class="text-gray-500">Neue&nbsp;Eintragungen</p></div>
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${withStrom}</p><p class="text-gray-500">mit&nbsp;Strom</p></div>
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${withFotos}</p><p class="text-gray-500">mit&nbsp;Fotos</p></div>
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${pendingFotos}</p><p class="text-gray-500">wartende&nbsp;Fotos</p></div>
      <div class="bg-white p-4 rounded shadow text-center"><p class="text-3xl font-bold">${count247}</p><p class="text-gray-500">24/7 ge√∂ffnet</p></div>
    `;
    const ctx = document.getElementById('statsChart').getContext('2d');
    const data = {
      labels: ['mit Strom','mit Fotos','24/7 ge√∂ffnet','Neue Eintragungen'],
      datasets: [{
        data: [withStrom, withFotos, count247, newEntries],
        backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444']
      }]
    };
    const options = {
      plugins: {
        legend: { position: 'bottom' },
        title: { display: true, text: 'Verteilung besonderer Merkmale' }
      }
    };
    if (statsChart) {
      statsChart.data = data;
      statsChart.update();
    } else {
      statsChart = new Chart(ctx, { type: 'doughnut', data, options });
    }
  }

  async function approveFoto(hutId, index) {
    try {
      const ref = db.collection('eierhuetten').doc(hutId);
      const snap = await ref.get();
      const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
      const f = fotos[index];
      if (!f || typeof f === 'string') {
        showNotification('‚ÑπÔ∏è Dieses Foto ist bereits freigegeben.');
        return;
      }
      fotos[index] = { ...f, status: 'freigegeben' };
      await ref.update({ fotos });
      await ref.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos',
        wert: `Foto freigegeben: ${f.url}`,
        zeitpunkt: new Date()
      });
      showNotification('‚úÖ Bild freigegeben');
      loadHuts();
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Freigeben.');
    }
  }

  async function rejectFoto(hutId, index) {
    try {
      const ref = db.collection('eierhuetten').doc(hutId);
      const snap = await ref.get();
      const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
      const f = fotos[index];
      if (!f) return;
      const deleteUrl = typeof f === 'object' ? f.delete_url : null;
      fotos.splice(index, 1);
      await ref.update({ fotos });
      await ref.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos',
        wert: `Foto abgelehnt/gel√∂scht: ${typeof f === 'string' ? f : f.url}`,
        zeitpunkt: new Date()
      });
      if (deleteUrl) {
        try { await fetch(deleteUrl); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
      }
      showNotification('üóëÔ∏è Bild entfernt');
      loadHuts();
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Entfernen.');
    }
  }

  async function initImageUpload(input, hutId) {
    const files = Array.from(input.files);
    if (files.length === 0) return;
    showNotification(`‚è≥ Lade ${files.length} Bild(er) hoch...`);
    const uploadedObjects = [];
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const reader = new FileReader();
      const base64 = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = () => reject('‚ùå Fehler beim Lesen der Datei.');
        reader.readAsDataURL(file);
      });
      try {
        const formData = new FormData();
        formData.append('key', '5df04de9bfd2776f101329be4193e44c'); // imgbb API Key
        formData.append('image', base64);
        const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
        const json = await res.json();
        if (json?.data?.url) {
          uploadedObjects.push({
            url: json.data.url,
            delete_url: json.data.delete_url || null,
            status: 'wartet'
          });
        } else {
          console.warn('‚ùå Upload unvollst√§ndig:', json);
          showNotification(`‚ùå Fehler beim Hochladen von Bild ${i + 1}`);
        }
      } catch (err) {
        console.error(err);
        showNotification(`‚ùå Upload-Fehler: ${err}`);
      }
    }
    if (uploadedObjects.length > 0) {
      try {
        await db.collection('eierhuetten').doc(hutId).update({
          fotos: firebase.firestore.FieldValue.arrayUnion(...uploadedObjects)
        });
        showNotification('‚úÖ Bilder hochgeladen (warten auf Freigabe).');
        loadHuts();
      } catch (err) {
        console.error(err);
        showNotification('‚ùå Fehler beim Speichern der Bilder: ' + err.message);
      }
    }
  }

  async function updateField(hutId, field, value) {
    if (field !== "tiere") {
      if (!confirm(`‚ö†Ô∏è Willst du wirklich das Feld "${field}" auf "${value}" √§ndern?`)) {
        return;
      }
      await db.collection('eierhuetten').doc(hutId).update({ [field]: value });
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: field,
        wert: value,
        zeitpunkt: new Date()
      });
      return;
    }
    const ref = db.collection("eierhuetten").doc(hutId);
    await db.runTransaction(async tx => {
      const doc = await tx.get(ref);
      if (!doc.exists) throw new Error("H√ºtte nicht gefunden");
      let tiere = Array.isArray(doc.data().tiere) ? doc.data().tiere : [];
      tiere = normalizeToEmojiArray(tiere);
      if (tiere.includes(value)) {
        tiere = tiere.filter(t => t !== value);
      } else {
        tiere = tiere.filter(t => t !== "‚ùå");
        tiere.push(value);
      }
      tx.update(ref, { tiere });
      await ref.collection("log").add({
        admin: currentUser.displayName || currentUser.email,
        feld: "tiere",
        wert: tiere.join(", "),
        zeitpunkt: new Date()
      });
    });
  }

  function showSection(id) {
    document.querySelectorAll('.dash-section').forEach(sec =>
      sec.classList.add('hidden')
    );
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn =>
      btn.classList.remove('active')
    );
    document
      .querySelector(`.nav-btn[onclick="showSection('${id}')"]`)
      .classList.add('active');
  }

  async function renderHuts(list) {
    hutList.innerHTML = '';
    for (const hut of list) {
      try {
        const el = document.createElement("div");
        el.className = "bg-white p-4 rounded shadow space-y-2";
        el.id = `hut-${hut.id}`;
        const fotos = Array.isArray(hut.fotos) ? hut.fotos : [];
        let logs = [];
        try {
          const logSnap = await db.collection('eierhuetten')
            .doc(hut.id).collection('log').orderBy('zeitpunkt', 'desc').limit(20).get();
          logs = logSnap.docs.map(doc => doc.data());
        } catch (err) {
          console.error(`‚ùå Fehler beim Laden der Logs f√ºr H√ºtte ${hut.id}:`, err);
        }
        
        const selectedEmojis = new Set(normalizeToEmojiArray(hut.tiere || []));
        let tiereHTML = `
          <div class="flex flex-wrap gap-2" data-hut-id="${hut.id}">
            ${Object.entries(TIERE_EMOJI_TO_NAME).map(([emoji, name]) => `
              <button type="button"
                data-hut-id="${hut.id}" data-emoji="${emoji}"
                class="admin-tiere-btn text-2xl ${selectedEmojis.has(emoji) ? 'bg-yellow-200' : 'bg-gray-100'} rounded p-1"
                title="${name}">
                ${emoji}
              </button>
            `).join('')}
          </div>
        `;
        
        let tagsHTML = `
          <div class="flex flex-wrap gap-2">
            ${(Array.isArray(hut.tags)?hut.tags:[]).map(t => `
              <span class="px-2 py-1 bg-blue-100 rounded-full">
                ${t} <button type="button" onclick="removeTag('${hut.id}','${t}')">‚úñ</button>
              </span>
            `).join('')}
            <input type="text" placeholder="Neuer Tag" 
              onkeydown="if(event.key==='Enter'){addTag('${hut.id}',this.value);this.value='';this.placeholder='‚úîÔ∏è gespeichert';setTimeout(()=>this.placeholder='Neuer Tag',1500)}"
              class="border rounded px-2 py-1">
          </div>
        `;
        
        let fotosFreigegeben = fotos
          .map((foto, i) => {
            const f = typeof foto === 'string' ? { url: foto, status: 'freigegeben' } : foto;
            if (f.status !== 'freigegeben') return '';
            return `
              <div class="relative w-24 h-24 rounded overflow-hidden border border-gray-300">
                <img src="${f.url}" alt="Foto" class="object-cover w-full h-full" />
                <button type="button" onclick="deleteFoto('${hut.id}', '${f.url}')" 
                  class="absolute top-0 right-0 bg-red-600 text-white rounded-bl px-1 text-sm font-bold hover:bg-red-700">√ó</button>
              </div>
            `;
          }).join('') || '<p class="text-gray-500">Keine Fotos</p>';
        
        let fotosWartend = fotos
          .map((f, i) => {
            if (typeof f === 'string' || f.status !== 'wartet') return '';
            return `
              <div class="relative w-24 h-24 rounded overflow-hidden border border-yellow-400 border-dashed group">
                <img src="${f.url}" alt="wartet" class="object-cover w-full h-full opacity-50 grayscale" />
                <div class="absolute inset-0 flex flex-col items-center justify-center text-xs text-white bg-black/50">
                  ‚è≥ Wartet
                  <div class="flex gap-1 mt-1">
                    <button type="button" onclick="approveFoto('${hut.id}', ${i})" class="bg-green-600 px-1 rounded">‚úî</button>
                    <button type="button" onclick="geminiAnalyzeImage(this, '${f.url}')" 
                            class="bg-purple-600 px-1 rounded" title="AI-Check">ü§ñ</button>
                    <button type="button" onclick="rejectFoto('${hut.id}', ${i})" class="bg-red-600 px-1 rounded">‚úñ</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');

        el.innerHTML = `
          <div class="flex justify-between items-start">
            <input class="text-xl font-bold w-full mb-2" 
              value="${hut.name || ''}" 
              onchange="updateField('${hut.id}', 'name', this.value)">
            <button onclick="geminiAuditHut(this, '${hut.id}')" class="bg-purple-500 text-white px-2 py-1 rounded text-sm whitespace-nowrap ml-2">
              ü§ñ Audit
            </button>
          </div>
          <label>Beschreibung:
            <textarea onchange="updateField('${hut.id}','beschreibung',this.value)" 
              class="w-full border rounded p-1">${hut.beschreibung || ''}</textarea>
          </label>
          <div>${tiereHTML}</div>
          <div><strong>Tags:</strong> ${tagsHTML}</div>
          <div><strong>Fotos (freigegeben):</strong><div class="flex flex-wrap gap-2 mb-2">${fotosFreigegeben}</div></div>
          ${fotosWartend ? `<div><strong>Fotos (warten auf Freigabe):</strong><div class="flex flex-wrap gap-2 mb-2">${fotosWartend}</div></div>` : ''}
          <label class="block mt-2 text-sm">üì∑ Neues Bild:
            <input type="file" accept="image/*" onchange="initImageUpload(this, '${hut.id}')" class="upload-image mt-1" />
          </label>
          <label>Sitzpl√§tze:
            <select onchange="updateField('${hut.id}', 'sitzplaetze', this.value)" class="w-full mb-2">
              ${['Ja','Nein'].map(o => `<option ${o===hut.sitzplaetze?'selected':''}>${o}</option>`).join('')}
            </select>
          </label>
          <label>Strom:
            <select onchange="updateField('${hut.id}', 'strom', this.value)" class="w-full mb-2">
              ${['Ja','Nein'].map(o => `<option ${o===hut.strom?'selected':''}>${o}</option>`).join('')}
            </select>
          </label>
          <label>Status:
            <select onchange="updateField('${hut.id}', 'status', this.value)" class="w-full mb-2">
              ${['offen','angenommen','abgelehnt'].map(s => `<option ${s===hut.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </label>
          <div class="minimap" id="map-${hut.id}"></div>
          <details class="mt-3">
            <summary>Bearbeitungs-Log (${logs.length})</summary>
            <ul class="text-xs max-h-48 overflow-auto">
              ${logs.map(log => `
                <li><strong>${log.admin}</strong> √§nderte <em>${log.feld}</em> auf <code>${log.wert}</code> 
                am ${new Date(log.zeitpunkt?.seconds * 1000 || Date.now()).toLocaleString()}</li>
              `).join('')}
            </ul>
          </details>
          <button type="button" onclick="deleteHut('${hut.id}')" 
            class="bg-red-600 text-white px-2 py-1 rounded mt-3 w-full">H√ºtte l√∂schen</button>
        `;
        hutList.appendChild(el);

        if (hut.location?.latitude && hut.location?.longitude) {
          const map = L.map(`map-${hut.id}`, {
            zoomControl: false, dragging: true, scrollWheelZoom: true,
            doubleClickZoom: true, boxZoom: true, keyboard: true
          }).setView([hut.location.latitude, hut.location.longitude], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
          const marker = L.marker([hut.location.latitude, hut.location.longitude], { draggable: true }).addTo(map);
          setTimeout(() => map.invalidateSize(), 200);
          marker.on('dragend', async (e) => {
            const newPos = e.target.getLatLng();
            const kommentar = prompt('Bitte Kommentar zur Standort√§nderung eingeben:');
            if (kommentar === null) {
              marker.setLatLng([hut.location.latitude, hut.location.longitude]);
              return;
            }
            await db.collection('eierhuetten').doc(hut.id).update({
              location: { latitude: newPos.lat, longitude: newPos.lng }
            });
            await db.collection('eierhuetten').doc(hut.id).collection('log').add({
              admin: currentUser.displayName || currentUser.email,
              feld: 'location',
              wert: `Lat: ${newPos.lat.toFixed(6)}, Lng: ${newPos.lng.toFixed(6)}`,
              kommentar: kommentar,
              zeitpunkt: new Date()
            });
            showNotification(`üìç Standort von "${hut.name}" wurde aktualisiert.`);
          });
        }
      } catch (err) {
        console.warn(`‚ùå H√ºtte konnte nicht gerendert werden: ${hut?.id || 'unbekannt'}`, err);
        const fallback = document.createElement('div');
        fallback.className = 'bg-red-100 text-red-800 p-2 rounded mb-2';
        fallback.textContent = `‚ö†Ô∏è H√ºtte konnte nicht geladen werden (ID: ${hut?.id || 'unbekannt'})`;
        hutList.appendChild(fallback);
      }
    }
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.admin-tiere-btn');
    if (!btn) return;
    const hutId = btn.dataset.hutId;
    const emoji = btn.dataset.emoji;
    if (!hutId || !emoji) return;
    const willSelect = !btn.classList.contains('bg-yellow-200');
    btn.classList.toggle('bg-yellow-200', willSelect);
    btn.classList.toggle('bg-gray-100', !willSelect);
    try {
      await toggleTier(hutId, emoji);
    } catch (err) {
      console.error('toggleTier Fehler:', err);
      btn.classList.toggle('bg-yellow-200', !willSelect);
      btn.classList.toggle('bg-gray-100', willSelect === false);
      showNotification('‚ùå Fehler beim Speichern der Tier-Auswahl');
    }
  });

  async function toggleTier(hutId, emoji) {
    const ref = db.collection('eierhuetten').doc(hutId);
    let newArray = [];
    await db.runTransaction(async tx => {
      const doc = await tx.get(ref);
      if (!doc.exists) throw new Error('H√ºtte nicht gefunden');
      let tiere = Array.isArray(doc.data().tiere) ? doc.data().tiere : [];
      tiere = normalizeToEmojiArray(tiere);
      const idx = tiere.indexOf(emoji);
      if (idx >= 0) {
        tiere.splice(idx, 1);
      } else {
        tiere = tiere.filter(t => t !== '‚ùå');
        tiere.push(emoji);
      }
      newArray = tiere;
      tx.update(ref, { tiere });
    });
    updateField(hutId, "tiere", emoji); // Note: This calls updateField but it will skip the confirm dialog
    try {
      await db.collection('eierhuetten').doc(hutId).collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'tiere',
        wert: newArray.join(', '),
        zeitpunkt: new Date()
      });
    } catch (e) {
      console.warn('Log konnte nicht geschrieben werden', e);
    }
    showNotification(`üêæ Tiere aktualisiert: ${newArray.map(e => TIERE_EMOJI_TO_NAME[e] || e).join(', ')}`);
    loadHuts();
  }

  function parseOeffnungszeiten(data) {
    if (!data) return { type: "none", days: [] };
    if (typeof data === "string") return { type: "string", value: data };
    if (Array.isArray(data)) return { type: "array", days: data };
    if (typeof data === "object") {
      const days = Object.keys(data).map(tag => ({
        tag,
        von: data[tag]?.start || "",
        bis: data[tag]?.ende || ""
      }));
      return { type: "object", days };
    }
    return { type: "none", days: [] };
  }
        
  async function updateOpening(hutId, tag, feld, value) {
    const docRef = db.collection('eierhuetten').doc(hutId);
    const hutDoc = await docRef.get();
    let data = hutDoc.data().oeffnungszeiten;
    if (typeof data === "string") data = [];
    if (Array.isArray(data)) {
      const idx = data.findIndex(d => d.tag === tag);
      if (idx >= 0) data[idx][feld] = value;
      else data.push({ tag, von: feld==='von'?value:"", bis: feld==='bis'?value:"" });
    } else if (typeof data === "object") {
      if (!data[tag]) data[tag] = {};
      data[tag][feld==='von'?'start':'ende'] = value;
    }
    await docRef.update({ oeffnungszeiten: data });
  }

  async function addOpeningDay(hutId, tag) {
    const docRef = db.collection('eierhuetten').doc(hutId);
    const hutDoc = await docRef.get();
    let data = hutDoc.data().oeffnungszeiten;
    if (!Array.isArray(data)) data = [];
    if (!data.find(d => d.tag === tag)) {
      data.push({ tag, von: "", bis: "" });
      await docRef.update({ oeffnungszeiten: data });
    }
  }

  async function addTag(hutId, tag) {
    if (!tag) return;
    const docRef = db.collection('eierhuetten').doc(hutId);
    const hutDoc = await docRef.get();
    let tags = Array.isArray(hutDoc.data().tags) ? hutDoc.data().tags : [];
    if (!tags.includes(tag)) {
      tags.push(tag);
      await docRef.update({ tags });
      showNotification(`#${tag} hinzugef√ºgt ‚úÖ`);
      loadHuts();
    } else {
      showNotification(`#${tag} existiert bereits ‚ö†Ô∏è`);
    }
  }

  async function removeTag(hutId, tag) {
    const docRef = db.collection('eierhuetten').doc(hutId);
    const hutDoc = await docRef.get();
    let tags = Array.isArray(hutDoc.data().tags) ? hutDoc.data().tags : [];
    tags = tags.filter(t => t !== tag);
    await docRef.update({ tags });
    showNotification(`#${tag} entfernt ‚ùå`);
    loadHuts();
  }

  async function deleteMessage(id) {
    try { await db.collection("hutMessages").doc(id).delete();
      alert("üóëÔ∏è Nachricht gel√∂scht"); location.reload();
    } catch (err) { console.error("‚ùå Fehler beim L√∂schen:", err); }
  }

  async function archiveMessage(id) {
    try { await db.collection("hutMessages").doc(id).update({ archived: true });
      alert("üì¶ Nachricht archiviert"); location.reload();
    } catch (err) { console.error("‚ùå Fehler beim Archivieren:", err); }
  }

  let filteredHuts = [];
  let currentPage = 1;
  const hutsPerPage = 15;

  function renderPage(page) {
    const start = (page - 1) * hutsPerPage;
    const end = start + hutsPerPage;
    const source = filteredHuts.length ? filteredHuts : allHuts;
    const hutsToRender = source.slice(start, end);
    renderHuts(hutsToRender);
    renderPagination(source.length);
  }

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / hutsPerPage);
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = '';
    if (totalPages <= 1) return;
    const createPageBtn = (label, pageNum) => {
      const btn = document.createElement('button');
      btn.textContent = label;
      btn.disabled = pageNum === currentPage;
      btn.className = 'px-2 py-1 border rounded mx-1';
      btn.onclick = () => { currentPage = pageNum; renderPage(currentPage); };
      return btn;
    };
    for (let i = 1; i <= totalPages; i++) {
      paginationContainer.appendChild(createPageBtn(i, i));
    }
  }

  function applySearchAndSort() {
    const search = document.getElementById("search-input")?.value.toLowerCase() || "";
    const sortBy = document.getElementById("sortSelect")?.value || "name";
    filteredHuts = allHuts.filter(hut => {
      const name = hut.name?.toLowerCase() || "";
      const status = hut.status?.toLowerCase() || "";
      const strom = hut.strom?.toLowerCase() || "";
      const sitz = hut.sitzplaetze?.toLowerCase() || "";
      return (name.includes(search) || status.includes(search) ||
              strom.includes(search) || sitz.includes(search));
    });
    filteredHuts.sort((a, b) => {
      if (sortBy === "name") return (a.name || "").localeCompare(b.name || "");
      if (sortBy === "createdAt") {
        const timeA = a.createdAt?.toMillis?.() || a.erstelltAm?.toMillis?.() || 0;
        const timeB = b.createdAt?.toMillis?.() || b.erstelltAm?.toMillis?.() || 0;
        return timeB - timeA;
      }
      return 0;
    });
    currentPage = 1;
    renderPage(currentPage);
    const source = filteredHuts.length ? filteredHuts : allHuts;
    renderStats(source);
  }

  function uploadFoto(input, hutId) {
    initImageUpload(input, hutId).then(uploads => console.log('Uploads:', uploads));
  }

  async function deleteFoto(hutId, index) {
    const a = Math.floor(Math.random() * 10) + 1, b = Math.floor(Math.random() * 10) + 1;
    const answer = a + b;
    const userAnswer = prompt(`Bitte rechne zur Best√§tigung: ${a} + ${b} = ?`);
    if (userAnswer === null) return;
    if (parseInt(userAnswer) !== answer) return alert('Falsche Antwort. Foto wird nicht gel√∂scht.');
    if (!confirm('Foto wirklich l√∂schen?')) return;
    try {
      const ref = db.collection('eierhuetten').doc(hutId);
      const snap = await ref.get();
      const fotos = Array.isArray(snap.data().fotos) ? [...snap.data().fotos] : [];
      const f = fotos[index];
      if (!f) return;
      const url = typeof f === 'string' ? f : f.url;
      const deleteUrl = typeof f === 'object' ? f.delete_url : null;
      fotos.splice(index, 1);
      await ref.update({ fotos });
      await ref.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos', wert: `Foto gel√∂scht: ${url}`, zeitpunkt: new Date()
      });
      if (deleteUrl) {
        try { await fetch(deleteUrl); } catch (e) { console.warn('imgbb delete fehlgeschlagen', e); }
      }
      showNotification('Foto wurde gel√∂scht.');
      loadHuts();
    } catch (e) {
      alert('Fehler beim L√∂schen des Fotos: ' + e.message);
    }
  }

  async function deleteHut(id) {
    if (!confirm('M√∂chtest du diese H√ºtte wirklich l√∂schen?')) return;
    db.collection('eierhuetten').doc(id).get().then(doc => {
      if (!doc.exists) return showNotification('‚ùå H√ºtte nicht gefunden.', 'bot');
      const hut = doc.data();
      if (hut.paypalSubscriptionId) {
        showNotification('üîÑ K√ºndige PayPal-Abo...', 'bot');
        console.log('‚û°Ô∏è Sende Abo-K√ºndigung f√ºr:', hut.paypalSubscriptionId);
        // HINWEIS: Dieser Cloud Function Call funktioniert weiterhin,
        // da er nicht die Gemini-API nutzt.
        fetch('https://us-central1-eierhuettentour.cloudfunctions.net/cancelPaypalSubscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscriptionId: hut.paypalSubscriptionId })
        })
        .then(async response => {
          if (!response.ok) {
            let errorText = await response.text();
            try { const errorJson = JSON.parse(errorText); throw new Error(errorJson.error || 'Unbekannter Fehler'); }
            catch { throw new Error(errorText); }
          }
          const result = await response.json();
          if (result.success) {
            showNotification('‚úÖ Abo erfolgreich gek√ºndigt.', 'bot');
            db.collection('eierhuetten').doc(id).delete().then(() => {
              showNotification('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
              loadHuts();
            });
          } else {
            console.error('‚ùå Fehler bei K√ºndigung:', result.error || result);
            if (confirm(`‚ö†Ô∏è Abo konnte nicht gek√ºndigt werden.\nTrotzdem l√∂schen?`)) {
              db.collection('eierhuetten').doc(id).delete().then(() => {
                showNotification('üóëÔ∏è H√ºtte gel√∂scht (Abo evtl. noch aktiv).', 'bot');
                loadHuts();
              });
            } else { showNotification('üö´ L√∂schvorgang abgebrochen.', 'bot'); }
          }
        })
        .catch(err => {
          console.error('‚ùå Fehler bei K√ºndigung:', err.message || err);
          if (confirm(`‚ö†Ô∏è Fehler bei PayPal-K√ºndigung: ${err.message || 'Unbekannt'}\nTrotzdem l√∂schen?`)) {
            db.collection('eierhuetten').doc(id).delete().then(() => {
              showNotification('üóëÔ∏è H√ºtte gel√∂scht (Abo evtl. noch aktiv).', 'bot');
              loadHuts();
            });
          } else { showNotification('üö´ L√∂schvorgang abgebrochen.', 'bot'); }
        });
      } else {
        db.collection('eierhuetten').doc(id).delete().then(() => {
          showNotification('üóëÔ∏è H√ºtte gel√∂scht.', 'bot');
          loadHuts();
        });
      }
    }).catch(err => {
      console.error('‚ùå Fehler beim Abrufen der H√ºtte:', err.message || err);
      showNotification('‚ùå Fehler beim L√∂schen der H√ºtte.', 'bot');
    });
  }

  function initLivePendingFotos() {
    db.collection('eierhuetten').onSnapshot(snapshot => {
      const pending = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (Array.isArray(data.fotos) &&
            data.fotos.some(f => f && typeof f === "object" && f.status === "wartet")) {
          pending.push({ id: doc.id, ...data });
        }
      });
      renderPendingFotos(pending);
      showNotification('üîÑ Live-Update: Wartende Fotos wurden aktualisiert.');
    }, err => console.error("‚ùå Fehler Live-Update wartende Fotos:", err));
  }

  let pendingSelected = new Set();
  function renderPendingFotos(list) {
    const container = document.getElementById("pending-fotos");
    container.innerHTML = "";
    if (!Array.isArray(list) || list.length === 0) {
      container.innerHTML = "<p class='italic text-gray-500'>Keine Fotos warten.</p>";
      return;
    }
    const huettenMitPending = list.filter(h =>
      Array.isArray(h.fotos) && h.fotos.some(f => f && typeof f === 'object' && f.status === 'wartet')
    );
    if (huettenMitPending.length === 0) {
      container.innerHTML = "<p class='italic text-gray-500'>Keine Fotos warten.</p>";
      return;
    }
    huettenMitPending.forEach(hut => {
      const wartende = (hut.fotos || [])
        .map((f, i) => ({ f, i }))
        .filter(item => item.f && typeof item.f === 'object' && item.f.status === 'wartet');
      if (wartende.length === 0) return;
      const card = document.createElement('div');
      card.className = "bg-blue-50 border p-3 rounded mb-4";
      const header = document.createElement('div');
      header.className = "flex justify-between items-center mb-2";
      const label = document.createElement('label');
      label.className = "flex items-center space-x-2";
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = pendingSelected.has(hut.id);
      checkbox.addEventListener('change', (ev) => {
        if (ev.target.checked) pendingSelected.add(hut.id);
        else pendingSelected.delete(hut.id);
      });
      const title = document.createElement('span');
      title.className = "font-semibold";
      title.textContent = `${hut.name} ‚Äì ${wartende.length} Foto(s)`;
      label.appendChild(checkbox);
      label.appendChild(title);
      header.appendChild(label);
      const btn = document.createElement('button');
      btn.className = "bg-blue-600 text-white px-2 py-1 rounded";
      btn.textContent = "üîé Anzeigen";
      btn.addEventListener('click', () => scrollToHut(hut.id));
      header.appendChild(btn);
      card.appendChild(header);
      const gallery = document.createElement('div');
      gallery.className = "flex flex-wrap gap-2";
      wartende.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = "relative group";
        const img = document.createElement('img');
        img.src = item.f.url;
        img.title = "Klicken zum Freigeben";
        img.className = "w-24 h-24 object-cover rounded border cursor-pointer hover:ring-4 hover:ring-green-400";
        img.addEventListener('click', async () => {
          img.style.opacity = '0.6';
          try {
            await approveSingleFoto(hut.id, item.i);
            wrapper.remove();
          } catch (e) {
            console.error(e);
            showNotification('‚ùå Fehler beim Freigeben des Fotos.');
            img.style.opacity = '1';
          }
        });
        const overlay = document.createElement('span');
        overlay.className = "absolute top-1 right-1 bg-black/50 text-white text-xs px-1 rounded hidden group-hover:block";
        overlay.textContent = "‚úÖ";
        wrapper.appendChild(img);
        wrapper.appendChild(overlay);
        gallery.appendChild(wrapper);
      });
      card.appendChild(gallery);
      container.appendChild(card);
    });
    const massBtn = document.createElement('button');
    massBtn.textContent = "‚úÖ Ausgew√§hlte H√ºtten freigeben";
    massBtn.className = "mt-4 bg-green-600 text-white px-4 py-2 rounded";
    massBtn.addEventListener('click', async () => {
      if (pendingSelected.size === 0) return showNotification('‚ÑπÔ∏è Keine H√ºtten ausgew√§hlt.');
      massBtn.disabled = true;
      for (const id of Array.from(pendingSelected)) {
        await approveAllFotosForHut(id);
      }
      pendingSelected.clear();
      massBtn.disabled = false;
      showNotification('‚úÖ Ausgew√§hlte Fotos freigegeben.');
    });
    container.appendChild(massBtn);
  }

  async function approveSingleFoto(hutId, fotoIndex) {
    try {
      const docRef = db.collection('eierhuetten').doc(hutId);
      const snap = await docRef.get();
      if (!snap.exists) return showNotification('‚ùå H√ºtte nicht gefunden.');
      const fotos = Array.isArray(snap.data().fotos) ? snap.data().fotos.slice() : [];
      const f = fotos[fotoIndex];
      if (!f || typeof f === 'string') return showNotification('‚ÑπÔ∏è Foto nicht gefunden oder bereits als String.');
      fotos[fotoIndex] = { ...f, status: 'freigegeben' };
      await docRef.update({ fotos });
      await docRef.collection('log').add({
        admin: currentUser.displayName || currentUser.email,
        feld: 'fotos', wert: `Foto freigegeben: ${f.url}`, zeitpunkt: new Date()
      });
      showNotification('‚úÖ Foto freigegeben');
    } catch (err) {
      console.error(err);
      showNotification('‚ùå Fehler beim Freigeben.');
      throw err;
    }
  }

  function scrollToHut(hutId) {
    showSection('huts');
    setTimeout(() => {
      const target = document.getElementById(`hut-${hutId}`);
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
        target.classList.add("ring-4", "ring-yellow-400");
        setTimeout(() => target.classList.remove("ring-4", "ring-yellow-400"), 2000);
      } else {
        console.warn("‚ùó H√ºtte mit ID", hutId, "nicht gefunden");
      }
    }, 300);
  }

  function initLiveNewHuts() {
    db.collection('eierhuetten')
      .where('status', '==', 'offen')
      .onSnapshot(snapshot => {
        const neue = [];
        snapshot.forEach(doc => neue.push({ id: doc.id, ...doc.data() }));
        renderNewEntries(neue);
        showNotification('üîÑ Live-Update: Neue Eintragungen wurden aktuallisiert.');
        const source = filteredHuts.length ? filteredHuts : allHuts;
        renderStats(source);
      }, err => console.error("‚ùå Fehler Live-Update neue H√ºtten:", err));
  }

  function renderNewEntries(list) {
    const neueListe = document.getElementById("neueListe");
    const neue = list.filter(h => h.status === "offen");
    if (neue.length === 0) {
      neueListe.innerHTML = "<p class='italic text-gray-500'>Keine neuen Eintragungen.</p>";
      return;
    }
    neueListe.innerHTML = "";
    neue.forEach(hut => {
      const row = document.createElement("div");
      row.className = "flex items-center justify-between bg-white shadow rounded px-3 py-2";
      row.innerHTML = `
        <a href="#hut-${hut.id}" class="font-medium text-blue-600 hover:underline truncate max-w-[60%] block"
          title="${hut.name}">${hut.name}</a>
        <p>${hut.id}</p>
        <div class="flex space-x-2 flex-shrink-0">
          <button onclick="updateField('${hut.id}', 'status', 'angenommen')"
                  class="px-2 py-1 bg-green-500 text-white rounded whitespace-nowrap">Annehmen</button>
          <button onclick="updateField('${hut.id}', 'status', 'abgelehnt')"
                  class="px-2 py-1 bg-red-500 text-white rounded whitespace-nowrap">Ablehnen</button>
        </div>
      `;
      neueListe.appendChild(row);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        ladeSupportTickets();
      }
    });
    document.getElementById("search-input").addEventListener("input", applySearchAndSort);
    document.getElementById("sortSelect").addEventListener("change", applySearchAndSort);
  });

  function logout() {
    firebase.auth().signOut().then(() => location.reload());
  }
  function goToMainPage() { window.location.href = '/'; }
  function refresh() { location.reload(); }

  // ü§ñ NEU: Globale Variablen f√ºr AI-Funktion
  window.currentReplyTicketId = null;
  window.currentReplyEmail = null;

  async function ladeSupportTickets() {
    const snapshot = await db.collection('support').orderBy('createdAt', 'desc').get();
    const body = document.getElementById('support-tickets-body');
    body.innerHTML = '';
    snapshot.forEach(doc => {
      const ticket = doc.data();
      const id = doc.id;
      const datum = ticket.createdAt?.toDate().toLocaleString('de-DE') || '-';
      const email = ticket.mail || '-';
      const status = ticket.status || 'offen';
      const row = document.createElement('tr');
      row.className = "align-top";
      row.innerHTML = `
        <td class="px-4 py-2 text-xs text-gray-600">${datum}</td>
        <td class="px-4 py-2 text-xs">
          ${email}<br><span class="text-[10px] text-gray-400">ID: ${id}</span>
        </td>
        <td class="px-4 py-2 text-xs">
          <div id="msgs-${id}" class="space-y-1">‚è≥ Lade Nachrichten‚Ä¶</div>
        </td>
        <td class="px-4 py-2">
          <select onchange="updateSupportStatus('${id}', this.value)" class="border rounded px-2 py-1 text-xs">
            ${['offen', 'bearbeitet', 'geschlossen', 'archiviert'].map(opt => `
              <option value="${opt}" ${opt === status ? 'selected' : ''}>${opt}</option>
            `).join('')}
          </select>
        </td>
        <td class="px-4 py-2 space-x-1">
          <button onclick="openReplyModal('${id}','${email}')" class="bg-green-600 text-white text-xs px-2 py-1 rounded">Antworten</button>
          <button onclick="loescheSupportTicket('${id}')" class="bg-red-600 text-white text-xs px-2 py-1 rounded">L√∂schen</button>
        </td>
      `;
      body.appendChild(row);
      ladeSupportNachrichten(id);
    });
  }

  function ladeSupportNachrichten(ticketId) {
    const wrap = document.getElementById("msgs-" + ticketId);
    if (!wrap) return;

    db.collection("support").doc(ticketId).collection("messages")
      .orderBy("createdAt", "asc")
      .onSnapshot(snap => {
        wrap.innerHTML = "";
        
        // ü§ñ NEU: Nachrichtenverlauf f√ºr AI-Funktion speichern
        const messagesForAI = [];
        window.supportMessages[ticketId] = messagesForAI;

        if (snap.empty) {
          wrap.innerHTML = "<div class='text-gray-500'>(keine Nachrichten)</div>";
          return;
        }
        snap.forEach(mdoc => {
          const d = mdoc.data();
          const zeit = d.createdAt?.toDate?.().toLocaleString('de-DE') || "-";
          
          // ü§ñ NEU: Nachricht zum AI-Verlauf hinzuf√ºgen
          messagesForAI.push({ sender: d.sender || 'Unbekannt', text: d.text || '' });
          
          wrap.innerHTML += `
            <div class="border rounded p-1 bg-white mb-1">
              <div class="text-xs">${d.text || ''}</div>
              <div class="text-[10px] text-gray-500">${d.sender || '-'} ¬∑ ${zeit}</div>
            </div>
          `;
        });
      });
  }

  function openReplyModal(ticketId, email) {
    // ü§ñ NEU: Globale Variablen f√ºr AI-Funktion setzen
    window.currentReplyTicketId = ticketId;
    window.currentReplyEmail = email;
    
    document.getElementById("modal-ticket-info").innerText = `Ticket-ID: ${ticketId} ¬∑ User: ${email}`;
    document.getElementById("modal-reply-text").value = "";
    document.getElementById("modal-reply-counter").innerText = "500 Zeichen √ºbrig";
    document.getElementById("support-reply-modal").classList.remove("hidden");
    document.getElementById("support-reply-modal").classList.add("flex");
  }

  function closeReplyModal() {
    document.getElementById("support-reply-modal").classList.add("hidden");
    document.getElementById("support-reply-modal").classList.remove("flex");
    // ü§ñ NEU: Globale Variablen zur√ºcksetzen
    window.currentReplyTicketId = null;
    window.currentReplyEmail = null;
  }

  async function sendReply() {
    const text = document.getElementById("modal-reply-text").value.trim();
    if (!text || !window.currentReplyTicketId) return;
    try {
      await db.collection("support").doc(window.currentReplyTicketId).collection("messages").add({
        text, sender: "Admin",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await db.collection("support").doc(window.currentReplyTicketId).update({
        status: "geschlossen"
      });
      showNotification("‚úÖ Antwort gesendet & Ticket geschlossen");
      closeReplyModal();
      ladeSupportTickets();
    } catch (err) {
      console.error("sendReply error", err);
      alert("Fehler: " + err.message);
    }
  }

  async function updateSupportStatus(id, neuerStatus) {
    await db.collection('support').doc(id).update({ status: neuerStatus });
    showNotification('‚úÖ Status aktualisiert');
  }

  async function loescheSupportTicket(id) {
    if (!confirm('Dieses Support-Ticket wirklich l√∂schen?')) return;
    await db.collection('support').doc(id).delete();
    showNotification('üóëÔ∏è Ticket gel√∂scht');
    ladeSupportTickets();
  }

  document.getElementById("modal-reply-text").addEventListener("input", e => {
    const left = 500 - e.target.value.length;
    document.getElementById("modal-reply-counter").innerText = `${left} Zeichen √ºbrig`;
  });

  async function adminReplySupport(ticketId) {
    const inp = document.getElementById("reply-" + ticketId);
    if (!inp) return;
    const text = inp.value.trim();
    if (!text) return;
    try {
      await db.collection("support").doc(ticketId).collection("messages").add({
        text, sender: "Admin",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await db.collection("support").doc(ticketId).update({ status: "bearbeitet" });
      inp.value = "";
      showNotification("‚úÖ Antwort gesendet (Status: bearbeitet)");
      ladeSupportTickets();
    } catch (err) {
      console.error("adminReplySupport error", err);
      showNotification("‚ùå Fehler beim Antworten");
    }
  }

  //Profil:
  let currentProfileId = null;
  async function loadProfileAdmin(id) { // Nimmt jetzt ID entgegen
    const queryId = id || document.getElementById("profile-selected-id").value;
    if (!queryId) {
      const queryName = document.getElementById("profile-search").value.trim();
      if (!queryName) return alert("Bitte ID oder Name eingeben.");
      
      let snap = await db.collection("profiles").doc(queryName).get();
      if (!snap.exists) {
        const q = await db.collection("profiles").where("name","==",queryName).get();
        if (q.empty) return alert("Kein Profil gefunden!");
        snap = q.docs[0];
      }
      currentProfileId = snap.id;
    } else {
      currentProfileId = queryId;
    }

    const snap = await db.collection("profiles").doc(currentProfileId).get();
    if (!snap.exists) return alert("Profil nicht gefunden!");
    
    const data = snap.data();
    
    document.getElementById("profile-admin-area").classList.remove("hidden");
    document.getElementById("profile-pic-admin").src = data.pic || "default.jpg";
    document.getElementById("profile-pic-url").value = data.pic || "";
    document.getElementById("profile-name-admin").value = data.name || "";
    document.getElementById("profile-bio-admin").value = data.bio || "";
    document.getElementById("profile-role-admin").value = data.role || "user";
    document.getElementById("profile-banned-admin").checked = data.banned || false;
    document.getElementById("profile-stats").textContent =
      `Fahrten: ${data.rides || 0} | Km: ${data.km || 0} | Letzter Login: ${data.lastLogin || "‚Äì"}`;
    
    const titleSel = document.getElementById("profile-title-admin");
    titleSel.innerHTML = "<option value=''>Kein Titel</option>";
    const titleSnap = await db.collection("titles").get();
    titleSnap.forEach(doc => {
      const t = doc.data();
      const opt = document.createElement("option");
      opt.value = t.name; opt.textContent = t.name;
      titleSel.appendChild(opt);
    });
    titleSel.value = data.title || "";
    
    const badgeContainer = document.getElementById("profile-badges-admin");
    badgeContainer.innerHTML = "";
    const badgeSnap = await db.collection("badgesDefs").get();
    badgeSnap.forEach(doc => {
      const b = doc.data();
      const chk = document.createElement("input");
      chk.type = "checkbox"; chk.value = doc.id;
      chk.checked = (data.badges || []).includes(doc.id);
      badgeContainer.appendChild(chk);
      const lbl = document.createElement("label");
      lbl.textContent = `${b.icon || "üèÖ"} ${b.name}`;
      badgeContainer.appendChild(lbl);
    });
  }

  async function saveProfileAdmin() {
    if (!currentProfileId) return;
    const badges = [...document.querySelectorAll("#profile-badges-admin input:checked")].map(i => i.value);
    await db.collection("profiles").doc(currentProfileId).update({
      name: document.getElementById("profile-name-admin").value,
      pic: document.getElementById("profile-pic-url").value,
      bio: document.getElementById("profile-bio-admin").value,
      title: document.getElementById("profile-title-admin").value,
      role: document.getElementById("profile-role-admin").value,
      banned: document.getElementById("profile-banned-admin").checked,
      badges: badges
    });
    alert("‚úîÔ∏è Profil gespeichert!");
  }

  async function deleteProfileAdmin() {
    if (!currentProfileId) return;
    if (!confirm("Soll dieses Profil wirklich gel√∂scht werden?")) return;
    await db.collection("profiles").doc(currentProfileId).delete();
    alert("üóëÔ∏è Profil gel√∂scht!");
    document.getElementById("profile-admin-area").classList.add("hidden");
  }

  function openProfileLink() {
    if (!currentProfileId) return;
    window.open(`https://deine-app.web.app/profile.html?id=${currentProfileId}`, "_blank");
  }

  // ---- TITEL Verwaltung ----
  (async () => {
    const titleList = document.getElementById("title-list");
    const titleForm = document.getElementById("title-form");
    const nameEl = document.getElementById("title-name");
    const condEl = document.getElementById("title-condition");
    const valEl = document.getElementById("title-value");
    let titleEditId = null;

    async function loadTitles() {
      if (!titleList) return;
      const snap = await db.collection("titles").get();
      titleList.innerHTML = "";
      snap.forEach(doc => {
        const t = doc.data();
        const row = document.createElement("div");
        row.className = "p-2 border rounded flex justify-between items-center";
        row.innerHTML = `
          <span><strong>${t.name}</strong> ‚Äî Regel: ${t.conditionType} ‚â• ${t.conditionValue}</span>
          <div class="space-x-2">
            <button class="px-2 py-1 bg-blue-600 text-white rounded" onclick="editTitle('${doc.id}')">‚úèÔ∏è</button>
            <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="deleteTitle('${doc.id}')">üóëÔ∏è</button>
          </div>`;
        titleList.appendChild(row);
      });
    }

    window.editTitle = async function(id) {
      const doc = await db.collection("titles").doc(id).get();
      const t = doc.data();
      titleEditId = id;
      if (nameEl) nameEl.value = t.name || "";
      if (condEl) condEl.value = t.conditionType || "rides";
      if (valEl) valEl.value = t.conditionValue ?? 0;
    };

    window.deleteTitle = async function(id) {
      if (!confirm("Diesen Titel wirklich l√∂schen?")) return;
      await db.collection("titles").doc(id).delete();
      await loadTitles();
    };

    if (titleForm) {
      titleForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
          name: (nameEl?.value || "").trim(),
          conditionType: condEl?.value || "rides",
          conditionValue: parseInt(valEl?.value || "0", 10) || 0
        };
        if (!payload.name) { alert("Bitte einen Titel-Namen angeben."); return; }
        if (titleEditId) {
          await db.collection("titles").doc(titleEditId).update(payload);
          titleEditId = null;
        } else {
          await db.collection("titles").add(payload);
        }
        if (titleForm) titleForm.reset();
        await loadTitles();
      });
    }
    document.addEventListener("DOMContentLoaded", loadTitles);
  })();

  // ---- ABZEICHEN Verwaltung ----
  (async () => {
    const badgeList = document.getElementById("badge-list-admin");
    const badgeForm = document.getElementById("badge-form");
    const nameEl = document.getElementById("badge-name");
    const iconEl = document.getElementById("badge-icon");
    const condEl = document.getElementById("badge-condition");
    const valEl = document.getElementById("badge-value");
    let badgeEditId = null;

    async function loadBadges() {
      const snap = await db.collection("badgesDefs").get();
      const list = document.getElementById("badge-list-admin");
      list.innerHTML = "";
      snap.forEach(doc => {
        const b = doc.data();
        const displayIcon = b.iconUrl
          ? `<img src="${b.iconUrl}" class="w-6 h-6 inline-block rounded" />`
          : (b.icon || "üèÖ");
        list.innerHTML += `
          <div class="p-2 border rounded flex justify-between items-center">
            <span>${displayIcon} <strong>${b.name}</strong> ‚Äî Regel: ${b.conditionType} ‚â• ${b.conditionValue}</span>
            <div class="space-x-2">
              <button onclick="editBadge('${doc.id}')" class="px-2 py-1 bg-blue-600 text-white rounded">‚úèÔ∏è</button>
              <button onclick="deleteBadge('${doc.id}')" class="px-2 py-1 bg-red-600 text-white rounded">üóëÔ∏è</button>
            </div>
          </div>`;
      });
    }

    window.editBadge = async function(id) {
      const doc = await db.collection("badgesDefs").doc(id).get();
      const b = doc.data();
      badgeEditId = id;
      if (nameEl) nameEl.value = b.name || "";
      if (iconEl) iconEl.value = b.icon || "";
      if (condEl) condEl.value = b.conditionType || "rides";
      if (valEl) valEl.value = b.conditionValue ?? 0;
    };

    window.deleteBadge = async function(id) {
      if (!confirm("Dieses Abzeichen wirklich l√∂schen?")) return;
      await db.collection("badgesDefs").doc(id).delete();
      await loadBadges();
    };

    if (badgeForm) {
      badgeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("badge-name").value.trim();
        const emojiFallback = document.getElementById("badge-icon").value.trim();
        const conditionType = document.getElementById("badge-condition").value;
        const conditionValue = parseInt(document.getElementById("badge-value").value) || 0;
        if (!name) return alert("Bitte Abzeichen-Namen eingeben!");
        let iconUrl = "";
        const fileInput = document.getElementById("badge-icon-file");
        if (fileInput.files.length > 0) {
          try {
            iconUrl = await badgeFormUploadToImgBB(fileInput.files[0]);
          } catch (err) {
            console.error(err);
            alert("‚ùå Fehler beim ImgBB-Upload");
          }
        }
        await db.collection("badgesDefs").add({
          name, icon: emojiFallback, iconUrl,
          conditionType, conditionValue,
          createdAt: new Date()
        });
        alert("‚úÖ Abzeichen gespeichert");
        e.target.reset();
        loadBadges();
      });
    }

    async function badgeFormUploadToImgBB(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async () => {
          const base64 = reader.result.split(",")[1];
          const formData = new FormData();
          formData.append("key", "5df04de9bfd2776f101329be4193e44c");
          formData.append("image", base64);
          try {
            const res = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData });
            const json = await res.json();
            if (json?.data?.url) resolve(json.data.url);
            else reject("‚ùå ImgBB Fehler");
          } catch (err) { reject(err); }
        };
        reader.onerror = () => reject("‚ùå Datei konnte nicht gelesen werden.");
        reader.readAsDataURL(file);
      });
    }
    document.addEventListener("DOMContentLoaded", loadBadges);
  })();

  document.getElementById('profile-search').addEventListener('input', async e => {
    const q = e.target.value.trim();
    const box = document.getElementById('profile-suggestions');
    if (q.length < 3) { box.classList.add('hidden'); return; }
    const snap = await db.collection('profiles')
      .where('name', '>=', q)
      .where('name', '<=', q + '\uf8ff')
      .limit(5).get();
    box.innerHTML = snap.empty
      ? "<p class='p-2 text-gray-500 italic'>Keine Treffer</p>"
      : snap.docs.map(d => {
          const name = d.data().name;
          return `
            <div class="p-2 hover:bg-gray-100 cursor-pointer"
                onclick="selectProfile('${d.id}', '${name.replace(/'/g,"\\'")}')">
              ${name}
            </div>`;
        }).join('');
    box.classList.remove('hidden');
  });

  window.selectProfile = (id, name) => {
    document.getElementById('profile-search').value = name;
    document.getElementById('profile-selected-id').value = id;
    document.getElementById('profile-suggestions').classList.add('hidden');
    loadProfileAdmin(id);
  };

  document.getElementById('menu-toggle').addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('hidden');
  });
</script>
</body>
  </html>
