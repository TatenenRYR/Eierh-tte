<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Admin-Dashboard V8 (Viele Features)</title>
  
  <!-- Bibliotheken -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Optional: Leaflet MarkerCluster for better map performance with many markers -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    /* Generelle Stile (wie V6/V7) */
    body { font-family: 'Inter', sans-serif; }
    .nav-group-title { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem; margin-top: 1rem; }
    .nav-btn { display: flex; align-items: center; gap: 0.75rem; text-align: left; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; color: #374151; }
    .nav-btn:hover { background-color: #f3f4f6; }
    .nav-btn.active { background-color: #10b981; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .minimap { height: 250px; width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; z-index: 1; }
    #dashboard-map { height: 400px; width: 100%; border-radius: 0.5rem; margin-top: 1rem; z-index: 1; } /* Map on dashboard */
    .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-backdrop.flex { display: flex; }
    .modal-content { background: white; border-radius: 0.75rem; padding: 0; width: 100%; max-width: 64rem; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb; }
    .modal-tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; padding: 0 1.5rem; overflow-x: auto; white-space: nowrap; }
    .modal-tab { padding: 1rem 0.5rem; margin-bottom: -1px; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280; flex-shrink: 0; }
    .modal-tab:hover { color: #111827; }
    .modal-tab.active { color: #10b981; border-color: #10b981; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .ql-container { min-height: 150px; font-size: 1rem; }
    .admin-table { width: 100%; text-align: left; border-collapse: collapse; table-layout: fixed; }
    .admin-table th, .admin-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; word-wrap: break-word; }
    .admin-table th { background-color: #f9fafb; font-weight: 600; color: #4b5563; }
    .admin-table tr:hover { background-color: #f9fafb; }
    /* Adjusted column widths for huts table */
    #hut-table-body td:nth-child(2), #hut-table-body th:nth-child(2) { width: 30%; } /* Name */
    #hut-table-body td:nth-child(3), #hut-table-body th:nth-child(3) { width: 15%; } /* Status */
    #hut-table-body td:nth-child(4), #hut-table-body th:nth-child(4) { width: 15%; } /* Erstellt */
    #hut-table-body td:nth-child(5), #hut-table-body th:nth-child(5) { width: 10%; text-align: center; } /* Fotos */
    #hut-table-body td:nth-child(6), #hut-table-body th:nth-child(6) { width: 15%; } /* Aktionen */
    /* Column widths for users table */
    #user-table-body td:nth-child(1), #user-table-body th:nth-child(1) { width: 30%; } /* Name/Email */
    #user-table-body td:nth-child(2), #user-table-body th:nth-child(2) { width: 15%; } /* Rolle */
    #user-table-body td:nth-child(3), #user-table-body th:nth-child(3) { width: 10%; text-align: center; } /* Eintr√§ge */
    #user-table-body td:nth-child(4), #user-table-body th:nth-child(4) { width: 15%; } /* Premium */
    #user-table-body td:nth-child(5), #user-table-body th:nth-child(5) { width: 15%; } /* Letzter Login */
    #user-table-body td:nth-child(6), #user-table-body th:nth-child(6) { width: 15%; } /* Aktionen */

    .inline-edit-input { border: 1px solid transparent; padding: 0.25rem 0.5rem; border-radius: 0.375rem; width: 100%; box-shadow: none; background-color: transparent; }
    .inline-edit-input:hover { border-color: #d1d5db; background-color: #f9fafb; }
    .inline-edit-input:focus { border-color: #10b981; background-color: white; ring: 1 ring-emerald-500; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }
    .inline-edit-select { border: 1px solid transparent; padding: 0.1rem 0.5rem; border-radius: 9999px; width: auto; background-color: transparent; font-size: 0.75rem; line-height: 1rem; appearance: none; cursor: pointer; }
    .inline-edit-select:hover { border-color: #d1d5db; }
    .inline-edit-select { padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1em 1em; }
    #notification { position: fixed; top: 1rem; right: 1rem; background: #38bdf8; color: white; padding: 1rem; border-radius: 0.5rem; display: none; z-index: 9999; max-width: 300px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .button-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    .priority-Hoch { border-left: 4px solid #ef4444; } .priority-Normal { border-left: 4px solid #f97316; } .priority-Niedrig { border-left: 4px solid #84cc16; }
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5 !important; border-color: #10b981 !important; transform: scale(1.01); }
    #smartUploadPreview .image-card { transition: all 0.25s ease; }
    #smartUploadPreview .image-card:hover { transform: scale(1.03); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #smartUploadProgress { transition: opacity 0.3s; }
    .info-icon { display: inline-block; width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; vertical-align: middle; fill: currentColor; }
    #ai-reply-suggestion-area, #ai-ticket-analysis-area { background-color: #eff6ff; border: 1px solid #93c5fd; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; font-size: 0.875rem; color: #1e40af; } /* Blue for Gemini Analysis */
     /* Admin Flags */
    .admin-flag { display: inline-block; margin-right: 0.25rem; padding: 0.1rem 0.4rem; font-size: 0.7rem; font-weight: 600; border-radius: 9999px; }
    .flag-standort { background-color: #fef3c7; color: #92400e; } /* amber */
    .flag-beschreibung { background-color: #fee2e2; color: #991b1b; } /* red */
    .flag-top { background-color: #d1fae5; color: #065f46; } /* green */
  </style>
</head>

<body class="bg-gray-50">
  <div id="notification"></div>

  <!-- Login Sektion -->
  <div id="login-section" class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-sm w-full">
      <h1 class="text-2xl font-bold text-emerald-600 mb-2">üèò H√ºtten Admin-Dashboard</h1>
      <p class="text-gray-600 mb-6">Bitte melden Sie sich an.</p>
      <button id="login-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full mb-4">Mit Google Anmelden</button>
      <div id="authError" class="mt-2 text-center text-red-500 text-sm"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden min-h-screen md:grid md:grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 flex flex-col">
      <div class="p-4 border-b border-gray-200 mb-4"> <h1 class="text-2xl font-bold text-emerald-700">üèò H√ºtten Admin</h1> </div>
      <nav class="flex-1 space-y-1">
        <button class="nav-btn w-full active" onclick="showSection('overview')">üìä Dashboard</button>
        <div class="nav-group-title">Inhalte</div>
        <button class="nav-btn w-full" onclick="showSection('huts')">üè† H√ºtten verwalten</button>
        <button class="nav-btn w-full" onclick="showSection('moderation')">üõ°Ô∏è Moderation <span id="mod-queue-badge" class="ml-auto bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">Benutzer</div>
        <button class="nav-btn w-full" onclick="showSection('users')">üë• Benutzer verwalten</button> {/* NEU */}
        <button class="nav-btn w-full" onclick="showSection('profiles')">üë§ Profile bearbeiten</button> {/* Umbenannt */}
        <button class="nav-btn w-full" onclick="showSection('support')">üì® Support-Tickets <span id="support-queue-badge" class="ml-auto bg-blue-400 text-blue-900 text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span> </button>
        <div class="nav-group-title">System</div>
        <button class="nav-btn w-full" onclick="showSection('gamification')">üèÜ Gamification</button>
        <button class="nav-btn w-full" onclick="showSection('system-logs')">üìú System-Protokoll</button>
        <button class="nav-btn w-full" onclick="showSection('my-account')">‚öôÔ∏è Mein Account</button> {/* NEU */}
      </nav>
      <div class="mt-4 pt-4 border-t border-gray-200"> <div id="admin-user-info" class="p-2 mb-2 text-center text-sm text-gray-600"></div> <button id="logout-btn" class="nav-btn w-full">üö™ Abmelden</button> </div>
    </aside>

    <!-- Hauptbereich -->
    <main class="flex-1 p-8 space-y-8 overflow-y-auto bg-gray-50">
      <section id="overview" class="space-y-8">
         <div> <h2 class="section-title">Willkommen zur√ºck!</h2> <p class="text-gray-600">√úberblick.</p> </div>
         <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">L√§dt...</div>
         <!-- NEU: Dashboard Map -->
         <div class="card"><h3 class="font-bold mb-2 text-lg">H√ºtten-Standorte</h3><div id="dashboard-map">Karte l√§dt...</div></div>
         <div class="grid grid-cols-1 lg:grid-cols-5 gap-8"> <div class="lg:col-span-3 card"> <h3 class="font-bold mb-4">Registrierungen (30T)</h3> <canvas id="registrationsChart"></canvas> </div> <div class="lg:col-span-2 card"> <h3 class="font-bold mb-4">Letzte Admin-Aktionen</h3> <div id="admin-log-widget" class="space-y-3 max-h-96 overflow-y-auto text-sm divide-y">L√§dt...</div> </div> </div>
      </section>
      <section id="huts" class="hidden">
        <div class="flex justify-between items-center mb-4"> <h2 class="section-title">üè† H√ºtten verwalten</h2> <button onclick="openHutModal(null)" class="bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-emerald-700">+ H√ºtte</button> </div>
        <div class="card">
            <div class="flex justify-between items-center gap-4 mb-4">
                <div class="flex gap-4"> <input id="search-input" placeholder="üîç Suchen..." class="p-2 border rounded-md w-full"> <select id="status-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Status</option> <option value="angenommen">Angenommen</option> <option value="offen">Offen</option> <option value="abgelehnt">Abgelehnt</option> </select> <select id="flag-filter" class="p-2 border rounded-md bg-white"> <option value="">Alle Flags</option> <option value="standort">Standort pr√ºfen</option> <option value="beschreibung">Beschreibung pr√ºfen</option> <option value="top">Top Eintrag</option> </select> {/* NEU: Flag Filter */} </div>
                <div id="bulk-action-container" class="hidden"> <select id="bulk-action-select" class="p-2 border rounded-md bg-white"> <option value="">Aktion...</option> <option value="approve">Freigeben</option> <option value="reject">Ablehnen</option> <option value="delete">L√ñSCHEN</option> <option value="add_tag">Tag hinzuf√ºgen</option> <option value="remove_tag">Tag entfernen</option> </select> <button id="bulk-action-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg ml-2 hover:bg-blue-700">OK</button> </div>
            </div>
            <div class="overflow-x-auto"> <table class="admin-table"> <thead> <tr> <th><input type="checkbox" id="select-all-checkbox"></th> <th>Name & Flags</th> <th>Status</th> <th>Erstellt</th> <th>Fotos offen</th> <th>Aktionen</th> </tr> </thead> <tbody id="hut-table-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody> </table> </div>
            <div id="pagination" class="mt-6 flex flex-wrap justify-center gap-2"></div>
        </div>
      </section>
      <section id="moderation" class="hidden">
        <h2 class="section-title">üõ°Ô∏è Moderation</h2>
        <div class="card"> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"> <div> <div class="flex justify-between mb-4"> <h3 class="font-bold">üÜï Neue Eintr√§ge</h3> <button id="bulk-approve-huts" onclick="bulkApproveHuts()" class="bg-green-500 text-white px-3 py-1 rounded text-sm">Alle freigeben</button> </div> <div id="neueListe-page" class="space-y-2 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 border">L√§dt...</div> </div> <div> <h3 class="font-bold mb-4">üì∑ Fotos offen</h3> <div id="pending-fotos-page" class="space-y-3 max-h-[60vh] overflow-y-auto p-2 bg-gray-50 border">L√§dt...</div> </div> </div> </div>
      </section>
       {/* NEU: User Management Page */}
      <section id="users" class="hidden">
          <h2 class="section-title">üë• Benutzer verwalten</h2>
          <div class="card">
              <input id="user-search-input" placeholder="üîç Nach Name oder E-Mail suchen..." class="p-2 border rounded-md w-full mb-4">
              <div class="overflow-x-auto">
                  <table class="admin-table">
                      <thead> <tr> <th>Name / E-Mail</th> <th>Rolle</th> <th class="text-center">Eintr√§ge</th> <th>Premium</th> <th>Letzter Login</th> <th>Aktionen</th> </tr> </thead>
                      <tbody id="user-table-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody>
                  </table>
              </div>
              {/* Optional: Pagination f√ºr User */}
          </div>
      </section>
      <section id="profiles" class="hidden">
        <h2 class="section-title">üë§ Profile bearbeiten</h2>
        <div class="card"> <div class="relative max-w-md mb-6"> <input id="profile-search" type="text" class="w-full border p-2 rounded" placeholder="Profil suchen..." /> <input type="hidden" id="profile-selected-id"> <div id="profile-suggestions" class="absolute bg-white border w-full mt-1 rounded shadow-lg hidden z-10"></div> </div> <div id="profile-admin-area" class="hidden space-y-4 border-t pt-6"> <!-- Profil Details --> </div> </div>
      </section>
      <section id="support" class="hidden">
        <h2 class="section-title">üì® Support-Tickets</h2>
        <div class="card overflow-x-auto">
          <div class="mb-4 flex gap-4"> <input id="support-search" class="p-2 border rounded flex-grow" placeholder="Suche..."> <select id="support-status-filter" class="p-2 border rounded bg-white"> <option value="">Status</option> <option value="offen">Offen</option> <option value="bearbeitet">In Bearb.</option> <option value="geschlossen">Geschl.</option> <option value="archiviert">Archiv</option> </select> <select id="support-priority-filter" class="p-2 border rounded bg-white"> <option value="">Prio</option> <option value="Hoch">Hoch</option> <option value="Normal">Normal</option> <option value="Niedrig">Niedrig</option> </select> </div>
          <table class="admin-table"> <thead> <tr> <th>Prio</th> <th>Datum</th> <th>User</th> <th>Nachrichten</th> <th>Status</th> <th>Aktionen</th> </tr> </thead> <tbody id="support-tickets-body"><tr><td colspan="6" class="text-center p-4">L√§dt...</td></tr></tbody> </table>
        </div>
      </section>
      <section id="gamification" class="hidden">
          <h2 class="section-title">üèÜ Gamification</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="card"> <h3 class="text-xl font-bold mb-4 text-indigo-700">üëë Titel</h3> <div id="title-list" class="space-y-2">L√§dt...</div> <form id="title-form" class="mt-4 space-y-2 border-t pt-4"> <input id="title-name" placeholder="Name" class="border p-2 rounded w-full"> <select id="title-condition" class="border p-2 rounded w-full"> <option value="rides">Fahrten</option> <option value="distance">KM</option> </select> <input id="title-value" type="number" placeholder="Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded w-full">Speichern</button> </form> </div>
              <div class="card"> <h3 class="text-xl font-bold text-amber-700">üèÖ Abzeichen</h3> <div id="badge-list-admin" class="space-y-2">L√§dt...</div> <form id="badge-form" class="mt-4 space-y-2 border-t pt-4"> <input id="badge-name" placeholder="Name" class="border p-2 rounded w-full"> <input id="badge-icon-file" type="file" accept="image/*" class="w-full border p-2 rounded file:..."> <input id="badge-icon" placeholder="Emoji Fallback" class="border p-2 rounded w-full"> <select id="badge-condition" class="border p-2 rounded w-full"> <option value="rides">Fahrten</option> <option value="distance">KM</option> <option value="night">Nacht</option> </select> <input id="badge-value" type="number" placeholder="Wert" class="border p-2 rounded w-full"> <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded w-full">Speichern</button> </form> </div>
          </div>
      </section>
      <section id="system-logs" class="hidden">
        <h2 class="section-title">üìú Protokoll & Export</h2>
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                 <input id="log-search-input" class="w-1/2 border p-2 rounded" placeholder="Logs durchsuchen...">
                 <button onclick="exportHutsToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Aktuelle Liste als CSV exportieren</button>
            </div>
            <div id="admin-log-full-list" class="space-y-3 max-h-[60vh] overflow-y-auto text-sm divide-y">L√§dt...</div>
        </div>
      </section>
       {/* NEU: My Account Page */}
      <section id="my-account" class="hidden">
          <h2 class="section-title">‚öôÔ∏è Mein Admin-Account</h2>
          <div class="card max-w-lg mx-auto" id="my-account-details"> L√§dt Account-Infos... </div>
      </section>
    </main>
  </div>
  
  <!-- Modals -->
   <div id="support-reply-modal" class="modal-backdrop">
       <div class="modal-content max-w-2xl">
         <div class="modal-header"> <h3 class="text-lg font-bold">Ticket bearbeiten</h3> <button onclick="closeReplyModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button> </div>
         <div class="modal-body grid grid-cols-1 md:grid-cols-2 gap-6">
             <div>
                 <div id="modal-ticket-info" class="text-sm text-gray-500 mb-2"></div>
                 {/* NEU: AI Ticket Analysis */}
                 <div id="ai-ticket-analysis-area" class="mb-4 hidden">
                     <p class="font-medium text-sm">KI Analyse:</p>
                     <p id="ai-ticket-summary" class="text-sm my-1"></p>
                     <p id="ai-ticket-category" class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full inline-block"></p>
                 </div>
                 <div id="modal-message-history" class="space-y-3 max-h-60 overflow-y-auto border rounded p-3 mb-4 bg-gray-50">L√§dt...</div>
                 <h4 class="font-semibold mb-2">Antworten:</h4>
                 <textarea id="modal-reply-text" rows="4" maxlength="500" placeholder="Antwort..." class="w-full border p-2 rounded mb-2"></textarea>
                 <div id="modal-reply-counter" class="text-xs text-right">500 Zeichen</div>
                 {/* NEU: Canned Responses */}
                 <div class="flex items-center gap-2 mt-2 mb-2">
                     <select id="canned-response-select" class="flex-grow border p-1 rounded text-sm bg-white"><option value="">Vordefinierte Antwort...</option></select>
                     <button onclick="insertCannedResponse()" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Einf√ºgen</button>
                 </div>
                 <button id="ai-reply-btn" onclick="generateSupportReplySuggestion()" class="w-full px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">‚ú® KI-Antwort</button>
                 <div id="ai-reply-suggestion-area" class="hidden mt-2 p-2 bg-green-50 border rounded text-sm"> <p class="font-medium">Vorschlag:</p> <p id="ai-reply-suggestion-text"></p> <button onclick="useAISuggestion()" class="text-xs bg-gray-200 px-2 py-0.5 rounded mt-1">√úbernehmen</button> </div>
             </div>
             <div class="space-y-4"> <div> <label>Status</label> <select id="modal-ticket-status" class="w-full border p-2 rounded"></select> </div> <div> <label>Prio</label> <select id="modal-ticket-priority" class="w-full border p-2 rounded"> <option value="Niedrig">Niedrig</option> <option value="Normal">Normal</option> <option value="Hoch">Hoch</option> </select> </div> <div> <h4>Interne Notizen</h4> <div id="modal-internal-notes-history" class="max-h-40 overflow-y-auto border rounded p-2 mb-2 bg-gray-50 text-xs"></div> <textarea id="modal-internal-note" rows="3" placeholder="Notiz..." class="w-full border p-2 rounded"></textarea> </div> </div>
         </div>
         <div class="modal-footer flex justify-between"> <button onclick="deleteSupportTicketFromModal()" class="bg-red-600 text-white px-4 py-2 rounded">L√∂schen</button> <div class="flex gap-2"> <button onclick="closeReplyModal()">Abbrechen</button> <button id="saveSupportBtn" onclick="saveSupportTicketChanges()">Speichern</button> </div> </div>
       </div>
  </div>
  <div id="hut-edit-modal" class="modal-backdrop"> <div id="hut-edit-modal-content" class="modal-content"> <div class="flex justify-center items-center h-64"><div class="spinner"></div></div> </div> </div>
   {/* NEU: Modal for bulk tag action */}
   <div id="bulk-tag-modal" class="modal-backdrop">
       <div class="modal-content max-w-md">
           <div class="modal-header"><h3 class="text-lg font-bold">Tag f√ºr Auswahl bearbeiten</h3><button onclick="closeBulkTagModal()">X</button></div>
           <div class="modal-body space-y-4">
               <p id="bulk-tag-modal-info"></p>
               <input id="bulk-tag-name" class="w-full border p-2 rounded" placeholder="Tag Name...">
           </div>
           <div class="modal-footer flex justify-end gap-3">
               <button onclick="closeBulkTagModal()" class="bg-gray-300 px-4 py-2 rounded">Abbrechen</button>
               <button id="bulk-tag-confirm-btn" onclick="confirmBulkTagAction()" class="bg-blue-600 text-white px-4 py-2 rounded">Best√§tigen</button>
           </div>
       </div>
   </div>

  <div id="admin-map-container" style="display:none;"></div>

  <!-- SVG Icons -->
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="icon-user" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></symbol>
  <symbol id="icon-tag" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm11.293 1.293a1 1 0 011.414 0l2 2a1 1 0 010 1.414l-8 8a1 1 0 01-.707.293H7a1 1 0 01-1-1v-4.586a1 1 0 01.293-.707l8-8zM9 8a1 1 0 100-2 1 1 0 000 2z" /></symbol>
</svg>


<script>
  // === FIREBASE KONFIGURATION ===
  const firebaseConfig = { apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", authDomain: "eierhuettentour.firebaseapp.com", projectId: "eierhuettentour", storageBucket: "eierhuettentour.appspot.com", messagingSenderId: "348272135205", appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc" };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // === GLOBALE VARIABLEN ===
  let currentUser = null; let allHuts = []; let filteredHuts = []; let currentPage = 1; const hutsPerPage = 15; let currentEditingHutId = null; let currentEditingSupportTicketId = null; let registrationsChartInstance; let adminModalMap; let adminModalMarker; let adminModalLocation; let quillInstance = null; const _supportMessageUnsubs = new Map(); let dashboardMap; let dashboardMarkers = L.layerGroup(); // Layer group for dashboard map markers
  let currentBulkAction = null; // For bulk tag modal

  // === DOM-ELEMENTE === (Gek√ºrzt)
  const notification = document.getElementById('notification'); const hutEditModal = document.getElementById('hut-edit-modal'); const hutEditModalContent = document.getElementById('hut-edit-modal-content'); const supportReplyModal = document.getElementById('support-reply-modal'); const hutTableBody = document.getElementById('hut-table-body'); const selectAllCheckbox = document.getElementById('select-all-checkbox'); const bulkActionContainer = document.getElementById('bulk-action-container'); const bulkActionBtn = document.getElementById('bulk-action-btn'); const supportTicketsBody = document.getElementById('support-tickets-body'); const bulkTagModal = document.getElementById('bulk-tag-modal');

  // === TIERE MAPPING ===
  const TIERE_EMOJI_TO_NAME = { /*...*/ }; const TIERE_NAME_TO_EMOJI = { /*...*/ }; function normalizeToEmojiArray(arr) { /*...*/ }
  
  // === AUTHENTICATION & ERROR HANDLING ===
  document.getElementById('login-btn').onclick = async () => { /*...*/ }; document.getElementById('logout-btn').onclick = () => auth.signOut();
  auth.onAuthStateChanged(async user => {
      const loginSection = document.getElementById('login-section'); const dashboard = document.getElementById('dashboard'); const adminUserInfo = document.getElementById('admin-user-info');
      if (user) {
          currentUser = user; const adminDoc = await db.collection('admins').doc(user.email).get(); if (!adminDoc.exists) { alert('Zugriff verweigert'); auth.signOut(); return; }
          adminUserInfo.textContent = `Angemeldet: ${user.displayName || user.email}`; loginSection.classList.add('hidden'); dashboard.style.display = 'grid';
          // Event Listeners
          document.getElementById('search-input')?.addEventListener('input', applySearchAndSort); document.getElementById('status-filter')?.addEventListener('change', applySearchAndSort); document.getElementById('flag-filter')?.addEventListener('change', applySearchAndSort); // Flag filter listener
          document.getElementById('select-all-checkbox')?.addEventListener('change', toggleAllCheckboxes); document.getElementById('bulk-action-btn')?.addEventListener('click', handleBulkAction); document.getElementById('hut-table-body')?.addEventListener('change', updateBulkActionUI); document.getElementById('support-search')?.addEventListener('input', applySupportFilters); document.getElementById('support-status-filter')?.addEventListener('change', applySupportFilters); document.getElementById('support-priority-filter')?.addEventListener('change', applySupportFilters); document.getElementById('log-search-input')?.addEventListener('input', loadAdminLogs); document.getElementById('user-search-input')?.addEventListener('input', applyUserSearchFilter); // User search listener
          // Initial Load
          initHutsListener(); initLiveModerationQueues(); initLiveSupportQueue(); loadAdminLogs(); loadUsers(); showMyAccount(); initDashboardMap(); showSection('overview');
      } else { currentUser = null; loginSection.classList.remove('hidden'); dashboard.style.display = 'none'; adminUserInfo.textContent = ''; _supportMessageUnsubs.forEach(unsub => unsub()); _supportMessageUnsubs.clear(); if(dashboardMap) dashboardMap.remove(); dashboardMap = null; }
  });
  function handleAuthError(error) { /* V7 code */ }

  // === ADMIN LOGGING ===
  async function logAdminAction(action, details = {}) { /* V7 code */ }
  let fullLogDataCache = []; function loadAdminLogs() { /* V7 code */ } loadAdminLogs.listenerAttached = false;

  // === DATENLADEN & STATISTIKEN & DASHBOARD MAP ===
  function initHutsListener() { db.collection('eierhuetten').orderBy('erstelltAm', 'desc').onSnapshot(snap => { allHuts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); applySearchAndSort(); renderStats(allHuts); renderRegistrationsChart(allHuts); updateDashboardMapMarkers(); if (currentEditingHutId && hutEditModal.classList.contains('flex')) { openHutModal(currentEditingHutId); } }, err => console.error("Huts Listener:", err)); }
  function renderStats(list) { /* V7 code */ }
  function renderRegistrationsChart(list) { /* V7 code */ }
  function initDashboardMap() { if (dashboardMap) return; try { dashboardMap = L.map('dashboard-map').setView([51.16, 10.45], 6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(dashboardMap); dashboardMarkers.addTo(dashboardMap); } catch(e) { console.error("Dashboard Map Error:", e); document.getElementById('dashboard-map').textContent = 'Fehler beim Laden der Karte.'; } }
  function updateDashboardMapMarkers() { if (!dashboardMap) return; dashboardMarkers.clearLayers(); const statusColors = { 'angenommen': 'green', 'offen': 'orange', 'abgelehnt': 'red' }; const hutsWithLocation = allHuts.filter(h => h.location?.latitude && h.location?.longitude); // Limit markers for performance if needed: .slice(0, 200);
      hutsWithLocation.forEach(hut => {
          const color = statusColors[hut.status] || 'grey';
          const icon = L.divIcon({ className: `bg-${color}-500 w-3 h-3 rounded-full border border-white shadow`, iconSize: [12, 12] });
          L.marker([hut.location.latitude, hut.location.longitude], { icon })
           .bindPopup(`<b>${escapeHtml(hut.name)}</b><br>${hut.status}<br><button onclick="openHutModal('${hut.id}')" class='text-blue-600 underline text-xs'>Details</button>`)
           .addTo(dashboardMarkers);
      });
      // Optional: Fit bounds if desired, might be jerky with many markers
      // if (hutsWithLocation.length > 0) dashboardMap.fitBounds(dashboardMarkers.getBounds());
  }


  // === H√úTTEN-TABELLE & INLINE EDIT & BULK ACTIONS ===
  function applySearchAndSort() { const s=document.getElementById('search-input').value.toLowerCase(); const st=document.getElementById('status-filter').value; const fl=document.getElementById('flag-filter').value; filteredHuts = allHuts.filter(h => (h.name?.toLowerCase().includes(s)||h.id.includes(s)) && (st===""||h.status===st) && (fl==="" || (h.adminFlags && h.adminFlags[fl])) ); currentPage = 1; renderPage(currentPage); updateBulkActionUI(); } // Added flag filter
  function renderPage(page) { /* V7 code */ }
  function renderHutsTable(list) {
      hutTableBody.innerHTML = ''; if (list.length === 0) { hutTableBody.innerHTML = `<tr><td colspan="6" class="text-center italic py-4">Keine H√ºtten gefunden.</td></tr>`; return; }
      list.forEach(hut => {
          let sC = 'bg-gray-100'; if (hut.status === 'angenommen') sC = 'bg-green-100 text-green-700'; else if (hut.status === 'offen') sC = 'bg-yellow-100 text-yellow-700'; else if (hut.status === 'abgelehnt') sC = 'bg-red-100 text-red-700';
          const pFc = (hut.fotos || []).filter(f => f && typeof f === 'object' && f.status === 'wartet').length;
          // NEU: Flags anzeigen
          const flagsHtml = hut.adminFlags ? Object.entries(hut.adminFlags).filter(([key, value]) => value).map(([key]) => {
              let flagClass = ''; let flagText = key.charAt(0).toUpperCase() + key.slice(1);
              if (key === 'standort') { flagClass = 'flag-standort'; flagText = 'üìç Ort?'; }
              else if (key === 'beschreibung') { flagClass = 'flag-beschreibung'; flagText = 'üìù Text?'; }
              else if (key === 'top') { flagClass = 'flag-top'; flagText = '‚≠ê Top'; }
              return `<span class="admin-flag ${flagClass}" title="${flagText}">${flagText}</span>`;
          }).join(' ') : '';

          const row = document.createElement('tr'); row.className = 'hover:bg-gray-50';
          row.innerHTML = `
              <td><input type="checkbox" class="hut-checkbox" data-id="${hut.id}"></td>
              <td>
                  <input type="text" value="${escapeAttr(hut.name||'')}" data-id="${hut.id}" class="inline-edit-input font-semibold text-emerald-700" onchange="inlineUpdateField('${hut.id}', 'name', this.value)">
                  <div class="mt-1">${flagsHtml}</div> {/* Flags unter dem Namen */}
                  <p class="text-xs text-gray-400 mt-1">${hut.id}</p>
              </td>
              <td>
                  <select class="inline-edit-select text-xs font-medium px-2 py-1 ${sC}" onchange="inlineUpdateField('${hut.id}', 'status', this.value)">
                      ${['offen','angenommen','abgelehnt'].map(s => `<option value="${s}" ${s===hut.status?'selected':''}>${s}</option>`).join('')}
                  </select>
              </td>
              <td class="text-sm">${hut.erstelltAm?.toDate().toLocaleDateString('de-DE')||'-'}</td>
              <td class="text-sm text-center ${pFc>0?'font-semibold':''}">${pFc}</td>
              <td><button onclick="openHutModal('${hut.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Details</button></td>
          `;
          hutTableBody.appendChild(row);
      });
  }
  function renderPagination(totalItems) { /* V7 code */ }
  function toggleAllCheckboxes() { /* V7 code */ }
  function updateBulkActionUI() { /* V7 code */ }
  async function handleBulkAction() {
      currentBulkAction = document.getElementById('bulk-action-select').value; // Store action globally
      const selectedIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id);
      if (!currentBulkAction || selectedIds.length === 0) { showNotification('‚ö†Ô∏è Aktion & H√ºtten w√§hlen.'); return; }
      
      if (currentBulkAction === 'add_tag' || currentBulkAction === 'remove_tag') {
          // Open tag modal
          document.getElementById('bulk-tag-modal-info').textContent = `Tag ${currentBulkAction === 'add_tag' ? 'hinzuf√ºgen zu' : 'entfernen von'} ${selectedIds.length} H√ºtten:`;
          document.getElementById('bulk-tag-name').value = '';
          bulkTagModal.classList.add('flex');
      } else {
          // Standard actions (approve, reject, delete)
          let cM = `Aktion '${currentBulkAction}' f√ºr ${selectedIds.length} H√ºtten?`; if (currentBulkAction === 'delete') cM = `‚ùó ${selectedIds.length} H√ºtten L√ñSCHEN?`;
          if (!confirm(cM)) return;
          executeBulkAction(selectedIds, currentBulkAction);
      }
  }
  function closeBulkTagModal() { bulkTagModal.classList.remove('flex'); currentBulkAction = null; }
  async function confirmBulkTagAction() {
      const tagName = document.getElementById('bulk-tag-name').value.trim();
      if (!tagName) { showNotification("‚ùå Bitte Tag-Namen eingeben."); return; }
      const selectedIds = Array.from(hutTableBody.querySelectorAll('.hut-checkbox:checked')).map(cb => cb.dataset.id);
      closeBulkTagModal(); // Close modal first
      executeBulkAction(selectedIds, currentBulkAction, tagName); // Pass tag name
  }
  async function executeBulkAction(selectedIds, action, tagName = null) {
      bulkActionBtn.disabled = true; bulkActionBtn.classList.add('button-loading');
      let successCount = 0; let actionDesc = action; if(tagName) actionDesc += ` '${tagName}'`;
      for (const id of selectedIds) {
          try {
              if (action === 'approve') await quickUpdateStatus(id, 'angenommen');
              else if (action === 'reject') await quickUpdateStatus(id, 'abgelehnt');
              else if (action === 'delete') await deleteHut(id, true);
              else if (action === 'add_tag' && tagName) await addTagToHut(id, tagName);
              else if (action === 'remove_tag' && tagName) await removeTagFromHut(id, tagName);
              successCount++;
          } catch (e) { console.error(`Bulk Error ${action} for ${id}:`, e); }
      }
      logAdminAction(`Bulk Action: ${actionDesc}`, { count: selectedIds.length, success: successCount });
      bulkActionBtn.disabled = false; bulkActionBtn.classList.remove('button-loading');
      showNotification(`‚úÖ ${successCount}/${selectedIds.length} verarbeitet.`);
      applySearchAndSort(); // Reload list
      document.getElementById('bulk-action-select').value = ''; // Reset select
  }
  async function addTagToHut(hutId, tag) { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayUnion(tag) }); }
  async function removeTagFromHut(hutId, tag) { await db.collection('eierhuetten').doc(hutId).update({ tags: firebase.firestore.FieldValue.arrayRemove(tag) }); }
  async function inlineUpdateField(hutId, field, value) { /* V7 code */ }

  // === H√úTTEN-MODAL ===
  function closeHutModal() { /* V7 code */ }
  async function openHutModal(hutId) { /* V7 code - Already loads logs, events, messages */
       // ... existing code to fetch hut, logs, events, messages ...
       // Ensure hut object exists before proceeding
       if (!hut) { /* Handle error */ return; }

       // NEU: Add internal notes and flags section to Stammdaten
       const adminNotesHtml = `
           <div class="mt-6 pt-6 border-t">
               <h4 class="font-semibold mb-2 text-gray-700">Interne Admin Infos</h4>
               <div class="mb-3">
                   <label class="block text-sm font-medium text-gray-600 mb-1">Flags:</label>
                   <div class="flex flex-wrap gap-x-4 gap-y-1">
                       <label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb form-checkbox h-4 w-4" data-flag="standort" ${hut.adminFlags?.standort ? 'checked' : ''}> <span class="ml-2 text-sm">üìç Standort pr√ºfen</span></label>
                       <label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb form-checkbox h-4 w-4" data-flag="beschreibung" ${hut.adminFlags?.beschreibung ? 'checked' : ''}> <span class="ml-2 text-sm">üìù Beschreibung pr√ºfen</span></label>
                       <label class="inline-flex items-center"><input type="checkbox" class="admin-flag-cb form-checkbox h-4 w-4" data-flag="top" ${hut.adminFlags?.top ? 'checked' : ''}> <span class="ml-2 text-sm">‚≠ê Top Eintrag</span></label>
                       {/* Weitere Flags hier */}
                   </div>
               </div>
               <div>
                   <label class="block text-sm font-medium text-gray-600 mb-1">Notizen:</label>
                   <textarea id="modal-hut-admin-notes" class="w-full border p-2 rounded text-sm" rows="3" placeholder="Nur f√ºr Admins sichtbar...">${escapeHtml(hut.adminNotes || '')}</textarea>
               </div>
           </div>`;

       // Append adminNotesHtml to tabStammdaten HTML string before setting innerHTML
       const tabStammdaten = `<div class="space-y-6">... (Felder f√ºr Name etc.) ... ${adminNotesHtml} </div>`;

       // ... rest of openHutModal code from V7 ...
  }
  async function generateDescriptionForModal() { /* V7 code */ }
  async function suggestTagsForEditModal(hutId) { /* V7 code */ }
  function collectCurrentModalData() { /* V7 code */ }
  function showModalTab(tabId) { /* V7 code */ }
  function initModalMap(location) { /* V7 code */ }
  function handleMarkerDrag(e) { /* V7 code */ }

  // === H√úTTEN-CRUD ===
  async function saveHutFromModal() {
      // ... (Get values for n, st, typ, b, sr, si, ex, tg, oe) ...
      const adminNotes = document.getElementById('modal-hut-admin-notes')?.value || '';
      const adminFlags = {};
      document.querySelectorAll('#hut-edit-modal .admin-flag-cb').forEach(cb => {
          adminFlags[cb.dataset.flag] = cb.checked;
      });

      const data={name:n, status:st, typ:typ, beschreibung:b, strom:sr, sitzplaetze:si, location:adminModalLocation, extras:ex, tags:tg, oeffnungszeiten:normalizeOpeningHours(oe), adminNotes, adminFlags }; // Add admin fields
      // ... (rest of save logic from V7) ...
  }
  async function quickUpdateStatus(hutId, status) { /* V7 code */ }
  async function deleteHut(id, skipConfirm = false) { /* V7 code */ }

  // === FOTO-VERWALTUNG ===
  async function approveFoto(hutId, index) { /* V7 code */ }
  async function rejectFoto(hutId, index) { /* V7 code */ }
  async function renderSmartImageUploader(container, docRef, existingImages = [], entryId) { /* V7 code */ }
  function debounce(func, wait) { /* V7 code */ }
  async function generateSingleImageTitle(btnEl) { /* V7 code */ }
  async function generateSmartImageTitle(url, filename = "") { /* V7 code */ }

  // === TIERE-VERWALTUNG ===
  async function toggleTier(hutId, emoji) { /* V7 code */ }
  
  // === √ñFFNUNGSZEITEN EDITOR ===
  const DAY_LABELS = [ /* V7 code */ ]; function renderOpeningHoursEditor(elemId, data = {}) { /* V7 code */ } function attachOpeningHoursListeners(elemId) { /* V7 code */ } function collectOpeningHours(elemId) { /* V7 code */ } function normalizeOpeningHours(oeff) { /* V7 code */ }

  // === EVENT MANAGEMENT === (wie V7)
  function renderEventCard(hutId, ev) { /* V7 code */ } async function openEventModal(hutId, eventId = null) { /* V7 code */ } function closeEventModal() { /* V7 code */ } async function saveEventFromModal() { /* V7 code */ } async function deleteEvent(hutId, eventId) { /* V7 code */ }

  // === H√úTTEN NACHRICHTEN === (wie V7)
   function renderMessageCard(msg) { /* V7 code */ } async function deleteHutMessage(hutId, msgId) { /* V7 code */ }

  // === USER MANAGEMENT ===
  let allUsers = []; // Cache for user data
  let filteredUsers = [];
  async function loadUsers() {
      const usersSection = document.getElementById('users');
      if (!usersSection || usersSection.classList.contains('hidden')) return; // Only load if section is visible

      const userTableBody = document.getElementById('user-table-body');
      userTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">Lade Benutzer...</td></tr>`;
      try {
          // Fetch profiles and betreiber data in parallel
          const [profilesSnap, betreiberSnap] = await Promise.all([
              db.collection('profiles').get(),
              db.collection('betreiber').get() // For premium status
          ]);
          const betreiberMap = new Map(betreiberSnap.docs.map(doc => [doc.id, doc.data()]));

          allUsers = profilesSnap.docs.map(doc => {
              const profile = doc.data();
              const betreiber = betreiberMap.get(doc.id) || {};
              return {
                  id: doc.id,
                  name: profile.name || 'N/A',
                  email: profile.email || doc.id, // Use ID as fallback if email missing
                  role: profile.role || 'user',
                  hutCount: allHuts.filter(h => h.userId === doc.id).length, // Requires allHuts to be loaded
                  isPremium: betreiber.premium || false,
                  premiumUntil: betreiber.premium_until || null,
                  lastLogin: profile.lastLogin ? new Date(profile.lastLogin.seconds * 1000).toLocaleDateString('de-DE') : '-',
                  banned: profile.banned || false
              };
          });
          applyUserSearchFilter(); // Render the table
      } catch (e) {
          userTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-500 p-4">Fehler beim Laden der Benutzer: ${e.message}</td></tr>`;
          console.error("Error loading users:", e);
      }
  }
  function applyUserSearchFilter() {
      const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
      filteredUsers = searchTerm
          ? allUsers.filter(u => u.name.toLowerCase().includes(searchTerm) || u.email.toLowerCase().includes(searchTerm))
          : allUsers;
      renderUsersTable();
  }
  function renderUsersTable() {
      const userTableBody = document.getElementById('user-table-body');
      userTableBody.innerHTML = '';
      if (filteredUsers.length === 0) { userTableBody.innerHTML = `<tr><td colspan="6" class="text-center italic py-4">Keine Benutzer gefunden.</td></tr>`; return; }
      filteredUsers.forEach(user => {
          const row = document.createElement('tr'); row.className = `hover:bg-gray-50 ${user.banned ? 'opacity-50 bg-red-50' : ''}`;
          const premiumText = user.isPremium ? `Ja (${user.premiumUntil ? 'bis '+new Date(user.premiumUntil).toLocaleDateString() : 'Unbegrenzt'})` : 'Nein';
          row.innerHTML = `
              <td><p class="font-semibold">${escapeHtml(user.name)}</p><p class="text-xs text-gray-500">${escapeHtml(user.email)}</p></td>
              <td><select class="inline-edit-select text-xs" onchange="updateUserRole('${user.id}', this.value)">${['user', 'mod', 'admin'].map(r => `<option value="${r}" ${user.role===r?'selected':''}>${r}</option>`).join('')}</select></td>
              <td class="text-center">${user.hutCount}</td>
              <td class="text-sm">${premiumText}</td>
              <td class="text-sm">${user.lastLogin}</td>
              <td> <button onclick="toggleUserBan('${user.id}', ${user.banned})" class="text-xs px-2 py-1 rounded ${user.banned ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${user.banned ? 'Entsperren' : 'Sperren'}</button> <button onclick="openUserProfileForEditing('${user.id}')" class="text-xs ml-1 px-2 py-1 rounded bg-blue-500 text-white">Bearbeiten</button> </td>
          `;
          userTableBody.appendChild(row);
      });
  }
  async function updateUserRole(userId, newRole) { try { await db.collection('profiles').doc(userId).update({ role: newRole }); logAdminAction(`User Rolle ge√§ndert: ${newRole}`, { userId }); showNotification("Rolle aktualisiert."); loadUsers(); } catch(e) { showNotification("Fehler Rolle."); } }
  async function toggleUserBan(userId, isCurrentlyBanned) { try { await db.collection('profiles').doc(userId).update({ banned: !isCurrentlyBanned }); logAdminAction(`User ${isCurrentlyBanned ? 'entsperrt' : 'gesperrt'}`, { userId }); showNotification(`User ${isCurrentlyBanned ? 'entsperrt' : 'gesperrt'}.`); loadUsers(); } catch(e) { showNotification("Fehler Sperren."); } }
  function openUserProfileForEditing(userId) { // Opens the existing profile editing section
      showSection('profiles');
      document.getElementById('profile-search').value = userId; // Fill search bar
      loadProfileAdmin(userId); // Load the profile
  }
  // Make sure to call loadUsers when the 'users' section becomes visible
  document.querySelector('.nav-btn[onclick="showSection(\'users\')"]')?.addEventListener('click', loadUsers);


  // === NAVIGATION ===
  function showSection(id) { document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden')); document.getElementById(id)?.classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.nav-btn[onclick="showSection('${id}')"]`)?.classList.add('active'); if(id === 'users') loadUsers(); if(id === 'overview') setTimeout(initDashboardMap, 50); /* Init/Refresh map */ }
  function showNotification(message) { /* V7 code */ }

  // === MODERATIONS-SEITE ===
  function initLiveModerationQueues() { /* V7 code */ }
  async function bulkApproveHuts() { /* V7 code */ }

  // === SUPPORT-SYSTEM ===
  let currentSupportTickets = []; let allSupportTickets = []; const SUPPORT_MSG_MAX = 500;
  const CANNED_RESPONSES = [ // Vordefinierte Antworten - K√∂nnten aus Firestore geladen werden
      { title: "Standard Begr√º√üung", text: "Hallo,\n\nvielen Dank f√ºr Ihre Nachricht. Wir k√ºmmern uns darum.\n\nViele Gr√º√üe,\nIhr RadlMap Team" },
      { title: "Standort Korrektur", text: "Hallo,\n\nvielen Dank f√ºr den Hinweis zum Standort. Wir haben das gepr√ºft und korrigiert.\n\nViele Gr√º√üe" },
      { title: "√ñffnungszeiten Frage", text: "Hallo,\n\ndie √ñffnungszeiten werden vom Betreiber selbst gepflegt. Am besten schauen Sie kurz vor dem Besuch nochmal auf der Detailseite nach.\n\nViele Gr√º√üe" }
  ];
  function initLiveSupportQueue() { db.collection('support').orderBy('createdAt','desc').onSnapshot(snap=>{ allSupportTickets=snap.docs.map(d=>({id:d.id,...d.data()})); applySupportFilters(); const oC=allSupportTickets.filter(t=>t.status==='offen').length; const b=document.getElementById('support-queue-badge'); b.textContent=oC; b.classList.toggle('hidden',oC===0); if(currentEditingSupportTicketId&&supportReplyModal.classList.contains('flex')){openReplyModal(currentEditingSupportTicketId);} }, err=>console.error("Support Listener:", err)); }
  function applySupportFilters() { const sT=document.getElementById('support-search').value.toLowerCase(); const sF=document.getElementById('support-status-filter').value; const pF=document.getElementById('support-priority-filter').value; currentSupportTickets=allSupportTickets.filter(t=>{ const sM=(t.mail?.toLowerCase().includes(sT)||t.internalNotes?.some(n=>n.text?.toLowerCase().includes(sT)) || t.msg?.toLowerCase().includes(sT)); /* Search msg field */ const stM=(sF==="")||(t.status===sF); const pM=(pF==="")||((t.priority||'Normal')===pF); return sM&&stM&&pM; }); renderSupportTable(); }
  function renderSupportTable() { /* V7 code */ }
  async function loadSupportMessagePreview(tId) { /* V7 code */ }
  async function openReplyModal(tId) {
      currentEditingSupportTicketId=tId; const t=allSupportTickets.find(t=>t.id===tId); if(!t){showNotification("Ticket nicht da"); return;}
      const modalContent = supportReplyModal.querySelector('.modal-content');
      modalContent.innerHTML = `... (Modal Structure from V7) ...`; // Keep existing structure

      // Populate elements
      document.getElementById("modal-ticket-info").innerText=`ID: ${tId} ¬∑ User: ${escapeHtml(t.mail||'-')}`;
      const statusSelect = document.getElementById("modal-ticket-status"); statusSelect.innerHTML = ['offen','bearbeitet','geschlossen','archiviert'].map(o=>`<option value="${o}" ${o===(t.status||'offen')?'selected':''}>${o}</option>`).join('');
      const prioritySelect = document.getElementById("modal-ticket-priority"); prioritySelect.value = t.priority || 'Normal';
      document.getElementById("modal-reply-text").value = ""; document.getElementById("modal-reply-counter").innerText=`${SUPPORT_MSG_MAX} Z.`; document.getElementById("modal-internal-note").value = "";
      document.getElementById('ai-reply-suggestion-area').classList.add('hidden'); // Hide AI suggestion initially

       // Populate Canned Responses
       const cannedSelect = document.getElementById('canned-response-select');
       if(cannedSelect) { cannedSelect.innerHTML = '<option value="">Vordefinierte Antwort...</option>' + CANNED_RESPONSES.map((r, i) => `<option value="${i}">${r.title}</option>`).join(''); }

      const msgHistEl=document.getElementById("modal-message-history"); msgHistEl.innerHTML='‚è≥...';
       const notesHistEl=document.getElementById("modal-internal-notes-history"); notesHistEl.innerHTML='‚è≥...'; notesHistEl.scrollTop = notesHistEl.scrollHeight;

      // Start Gemini Analysis
      analyzeTicketWithGemini(tId, t);

      _supportMessageUnsubs.get(tId)?.();
      const unsub = db.collection("support").doc(tId).collection("messages").orderBy("createdAt","asc").onSnapshot(snap=>{ /* Render messages V7 */ }, err=>{/* Error V7 */});
      _supportMessageUnsubs.set(tId,unsub);

       // Render notes (no listener needed here)
       notesHistEl.innerHTML=(t.internalNotes||[]).map(n=>`<div class="border-b pb-1 mb-1"><p>${escapeHtml(n.text||'')}</p><p class="text-xs text-right">${escapeHtml(n.adminName||'A')} - ${n.timestamp?.toDate().toLocaleString()||''}</p></div>`).join('')||'<p>Keine Notizen.</p>';

      supportReplyModal.classList.add('flex');
  }
  function closeReplyModal() { /* V7 code */ }
  async function saveSupportTicketChanges() { /* V7 code */ }
  function deleteSupportTicketFromModal() { /* V7 code */ }
  async function deleteSupport(tId) { /* V7 code */ }
  document.getElementById("modal-reply-text")?.addEventListener("input", e=>{ /* V7 code */ });
  // NEU: Canned response insertion
  function insertCannedResponse() { const select = document.getElementById('canned-response-select'); const index = select.value; const replyArea = document.getElementById('modal-reply-text'); if (index !== "" && replyArea && CANNED_RESPONSES[index]) { replyArea.value += (replyArea.value ? '\n\n' : '') + CANNED_RESPONSES[index].text; replyArea.dispatchEvent(new Event('input', { bubbles: true })); select.value = ""; } }

   // === GEMINI API CALL ===
   async function callGeminiAPI(systemPrompt, userQuery) { /* V7 code */ }

   // === GEMINI INTEGRATION FUNCTIONS ===
   async function generateSupportReplySuggestion() { /* V7 code */ }
   function useAISuggestion() { /* V7 code */ }
   async function callGeminiGenerateDescription(d) { /* V7 code */ }
   async function callGeminiGenerateTags(data) { /* V7 code */ }
   // NEU: Gemini Ticket Analysis
   async function analyzeTicketWithGemini(ticketId, ticketData) {
       const analysisArea = document.getElementById('ai-ticket-analysis-area');
       const summaryEl = document.getElementById('ai-ticket-summary');
       const categoryEl = document.getElementById('ai-ticket-category');
       if (!analysisArea || !summaryEl || !categoryEl) return;

       analysisArea.classList.remove('hidden');
       summaryEl.textContent = 'Analysiere...'; categoryEl.textContent = '';

       try {
           // Get messages (limit to last few?)
           const msgSnap = await db.collection("support").doc(ticketId).collection("messages").orderBy("createdAt", "desc").limit(5).get();
           let historyText = "Konversation:\n";
           msgSnap.docs.reverse().forEach(doc => { // Chronological order
                const d = doc.data();
               historyText += `${d.sender === 'Admin' ? 'Support' : 'User'}: ${d.text}\n`;
           });
           if (!msgSnap.docs.length && ticketData.msg) { // Use initial message if no replies
               historyText += `User: ${ticketData.msg}\n`;
           }

           const systemPrompt = "Analysiere das folgende Support-Ticket. Erstelle eine sehr kurze Zusammenfassung (max. 1 Satz) des Hauptproblems. Schlage dann EINE der folgenden Kategorien vor: Standortproblem, √ñffnungszeiten, Feedback, Technisches Problem, Foto-Problem, Sonstiges.";
           const userQuery = `${historyText}\n---\nZusammenfassung und Kategorie:`;

           const result = await callGeminiAPI(systemPrompt, userQuery);

           // Try to parse summary and category (simple split)
           const lines = result.split('\n');
           const summary = lines[0] || result;
           let category = "Sonstiges";
           const categoryLine = lines.find(line => line.toLowerCase().includes("kategorie:"));
           if (categoryLine) {
               category = categoryLine.split(':')[1]?.trim() || category;
               // Optional: Validate against allowed categories
               const allowedCategories = ["Standortproblem", "√ñffnungszeiten", "Feedback", "Technisches Problem", "Foto-Problem", "Sonstiges"];
               if (!allowedCategories.includes(category)) category = "Sonstiges";
           }

           summaryEl.textContent = `Zfg: ${summary}`;
           categoryEl.textContent = `Kat: ${category}`;

       } catch (error) {
           summaryEl.textContent = 'Fehler bei Analyse.';
           console.error("AI Ticket Analysis Error:", error);
       }
   }


  // === PROFIL-VERWALTUNG === (wie V7)
  let currentProfileId = null; async function loadProfileAdmin(id) { /* V7 code */ } async function saveProfileAdmin() { /* V7 code */ } async function deleteProfileAdmin() { /* V7 code */ } document.getElementById('profile-search')?.addEventListener('input', async e=>{ /* V7 code */ }); window.selectProfile=(id, name)=>{ /* V7 code */ };

  // === TITEL & ABZEICHEN === (wie V7)
  let titleEditId = null; let badgeEditId = null; async function loadTitles() { /* V7 code */ } window.editTitle = (id, name, type, value) => { /* V7 code */ }; window.deleteTitle = async (id, name) => { /* V7 code */ }; document.getElementById("title-form")?.addEventListener("submit", async (e) => { /* V7 code */ }); async function loadBadges() { /* V7 code */ } window.editBadge = (id, name, icon, type, value) => { /* V7 code */ }; window.deleteBadge = async (id, name) => { /* V7 code */ }; document.getElementById("badge-form")?.addEventListener("submit", async (e) => { /* V7 code */ }); async function badgeFormUploadToImgBB(file) { /* V7 code */ } document.querySelector('.nav-btn[onclick="showSection(\'gamification\')"]')?.addEventListener('click', () => { loadTitles(); loadBadges(); });
   
   // === MEIN ADMIN ACCOUNT === (wie V7)
   function showMyAccount() { /* V7 code */ }

  // === DATA EXPORT ===
   function exportHutsToCSV() {
       if (filteredHuts.length === 0) { showNotification("Keine Daten zum Exportieren in der aktuellen Ansicht."); return; }
       const headers = ["ID", "Name", "Typ", "Status", "ErstelltAm", "UserID", "UserMail", "Lat", "Lng", "Strom", "Sitzpl√§tze", "Extras", "Tags", "Tiere", "Views", "RouteStarts"];
       const rows = filteredHuts.map(hut => [
           hut.id, hut.name, hut.typ, hut.status, hut.erstelltAm?.toDate().toISOString(), hut.userId, hut.userMail,
           hut.location?.latitude, hut.location?.longitude, hut.strom, hut.sitzplaetze, hut.extras,
           (hut.tags || []).join(';'), (hut.tiere || []).join(';'), hut.views || 0, hut.routeStarts || 0
       ]);

       let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(",")).join("\n");

       const encodedUri = encodeURI(csvContent);
       const link = document.createElement("a");
       link.setAttribute("href", encodedUri);
       link.setAttribute("download", "huetten_export.csv");
       document.body.appendChild(link);
       link.click();
       document.body.removeChild(link);
       logAdminAction("H√ºtten exportiert (CSV)", { count: filteredHuts.length });
   }


  // === HILFSFUNKTIONEN ===
  function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function escapeAttr(s) { if (!s && s !== 0) return ''; return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
  function stripHtml(html){ if(!html) return ''; let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }
  

</script>
</body>
</html>
