<!DOCTYPE html>
<html lang="de">
<head>
  <meta name="google-adsense-account" content="ca-pub-2577915567428766">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H√ºtten Assistent Chat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
 <style>
    body { background: #f3f4f6; font-family: Arial, sans-serif; }
    #chat-window { height: 500px; overflow-y: auto; padding: 1rem; background: #fff; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message { clear: both; margin-bottom: 1rem; max-width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; }
    .bot { float: left; background: #e0f2fe; color: #0369a1; }
    .user { float: right; background: #dcfce7; color: #166534; text-align: right; }
    #input-area { margin-top: 1rem; display: flex; gap: 0.5rem; }
    #chat-input { flex-grow: 1; padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
    #send-btn { background: #0284c7; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
    #send-btn:hover { background: #0369a1; }
    .choice-btn, .edit-btn, .delete-btn {
      margin-top: 0.5rem; background: #fbbf24; color: #92400e;
      padding: 0.3rem 0.6rem; border-radius: 0.5rem; cursor: pointer;
      display: inline-block; margin-right: 0.5rem;
    }
    .delete-btn { background: #dc2626; color: white; }
    #map { width: 100%; height: 300px; border-radius: 0.5rem; margin-top: 1rem; }
    .minimap { width: 100%; height: 200px; margin-top: 0.5rem; border-radius: 0.5rem; }
    .time-picker { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .time-picker input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 0.5rem; width: 45%; }
 
.stats-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #d1fae5;
  color: #065f46;
  padding: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: sans-serif;
  border: 1px solid #065f46;
}




    /* Hover-Effekte f√ºr Links */
  #consent-modal a:hover {
    color: #0056b3 !important;
    border-color: #0056b3 !important;
  }

  /* Button Hover-Effekt */
  #consent-accept:hover {
    background: linear-gradient(135deg, #45A049, #3e8e41);
    transform: translateY(-1px);
  }

  /* Button Klick-Effekt */
  #consent-accept:active {
    transform: translateY(0);
  }
   .hidden {
  display: none !important;
   }
 </style>
</head>
  <body class="bg-gray-50">
  <!-- Login -->
  <div id="login-section" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow max-w-sm w-full text-center space-y-4">
      <h1 class="text-2xl font-bold">Login</h1>
      <p class="text-gray-500">Bitte mit Google anmelden.</p>
      <button id="google-login" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded w-full">
        Mit Google anmelden
      </button>
    </div>
  </div>

<!-- Werbung oberhalb vom Chat -->
<div id="adsense-container" style="margin:20px auto; text-align:center; display:none;">
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-2577915567428766"
       data-ad-slot="3060614235"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
</div>
  <section id="main-section" class="max-w-md mx-auto mt-6 bg-white p-4 rounded-lg shadow hidden">

    
    
    <!-- Navigation -->
<div id="topbar" style="display:none; justify-content:space-between; align-items:center;
     background:#f0fdf4; padding:10px 20px; border-bottom:1px solid #ccc; font-family:sans-serif;">
  
  <div id="user-info" style="font-weight:bold; font-size:14px;">
    üë§ <span id="user-name">L√§dt...</span>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="refresh()" style="background:#34d399; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîÑ
    </button>
    
    <button onclick="goToMainPage()" style="background:#34d399; color:white; border:none;
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üè†
    </button>

    <button onclick="logout()" style="background:#f87171; color:white; border:none; 
            padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer;">
      üîì
    </button>
  </div>
</div>


    
    <div class="text-center font-bold text-2xl text-green-700 mb-4">H√ºtten Assistent Chat</div>
    <div id="chat-window" aria-live="polite" role="log"></div>
   <input type="file" id="image-upload" accept="image/*" multiple hidden />
    <div id="input-area">
      <input id="chat-input" type="text" placeholder="Antwort hier..." autocomplete="off" class="border border-gray-300 rounded px-3 py-2"/>
      <button id="send-btn">Senden</button>
    </div>
  </section>


<!-- Consent Modal -->

<div id="consent-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;">    <div style="background:white; padding:25px 30px; max-width:520px; width:100%; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); font-family:sans-serif; line-height:1.6; color:#333;">  
    
    <h2 style="margin-top:0; font-size:1.6rem; font-weight:600; color:#222; margin-bottom:15px;">Datenschutz & Cookies</h2>  
    
    <p style="margin-bottom:15px; font-size:1rem;">  
      Wir verwenden Cookies und √§hnliche Technologien, um unsere Dienste bereitzustellen und zu verbessern.  
      Mehr dazu in unserer   
      <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">  
        Datenschutzerkl√§rung  
      </a>.  
    </p>  
    
    <label style="display:flex; align-items:center; margin-top:15px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-privacy" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der <a href="/datenschutz.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Datenschutzerkl√§rung</a> zu</span>  
    </label>  
    
    <label style="display:flex; align-items:center; margin-top:10px; cursor:pointer; font-size:0.95rem;">  
      <input type="checkbox" id="consent-cookies" style="margin-right:10px; transform:scale(1.2);">  
      <span>Ich stimme der Verwendung von Cookies gem√§√ü der <a href="/cookies.html" target="_blank" style="color:#007BFF; font-weight:500; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s, color 0.2s;">Cookie-Richtlinie</a> zu</span>  
    </label>  

    <div style="margin-top:25px; text-align:right;">  
<button id="consent-accept" onclick="acceptConsent()" style="padding:10px 20px; background:linear-gradient(135deg, #4CAF50, #45A049); color:white; border:none; border-radius:6px; font-size:1rem; font-weight:500; cursor:pointer; transition:background 0.3s, transform 0.1s;">
  Zustimmen
</button>
    </div>  
  </div>  
</div>  


<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.firebasestorage.app",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
    measurementId: "G-16V6K5GXDT"
  };

  if (window.firebase && (!firebase.apps || firebase.apps.length === 0)) {
    firebase.initializeApp(firebaseConfig);
  } else if (window.firebase) {
    try { firebase.app(); } catch(e) { firebase.initializeApp(firebaseConfig); }
  }

  if (window.firebase) {
    window.db = firebase.firestore();
    window.auth = firebase.auth();
    window.storage = firebase.storage();
    window.functions = firebase.functions();
  }
</script>


<script>
/* Consolidated Release Script */
let editingData = {};
let step = null;
const chatWindow = document.getElementById("{{CHAT_ID}}") || document.body;
const inputField = document.getElementById("{{INPUT_ID}}");

function addMessage(htmlContent, who='bot') {
  const wrapper = document.createElement('div');
  wrapper.className = who === 'bot' ? 'message bot' : 'message user';
  wrapper.innerHTML = htmlContent;
  chatWindow.appendChild(wrapper);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return wrapper;
}

function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

async function saveDraft(id, partial) { if (!id) return; try { await db.collection('eierhuetten').doc(id).set(Object.assign({}, partial, { updatedAt: firebase.firestore.FieldValue.serverTimestamp() }), { merge: true }); } catch(e){} }

async function geocodeAddress(address) {
  try {
    const url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&q=" + encodeURIComponent(address);
    const res = await fetch(url, { headers: { 'User-Agent': 'EierhuettenApp/1.0' } });
    const data = await res.json();
    if (!data || !data.length) return null;
    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), display_name: data[0].display_name };
  } catch(e) { return null; }
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; const toRad = x => x * Math.PI / 180;
  const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
  const ŒîœÜ = toRad(lat2 - lat1), ŒîŒª = toRad(lon2 - lon1);
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function locationExistsNearby(lat, lng, radius) {
  radius = radius || 20;
  const delta = 0.00018;
  const minLat = lat - delta, maxLat = lat + delta;
  try {
    const snapshot = await db.collection('eierhuetten').where('location.latitude', '>=', minLat).where('location.latitude', '<=', maxLat).get();
    if (snapshot.empty) return false;
    for (const doc of snapshot.docs) {
      const d = doc.data();
      if (!d.location || d.status === 'archiviert') continue;
      const dist = haversineDistance(lat, lng, d.location.latitude, d.location.longitude);
      if (dist <= radius) return true;
    }
    return false;
  } catch(e) { return false; }
}

function showLocationConfirmation(lat, lng, displayName) {
  addMessage('üìç Gefundene Adresse: <strong>' + escapeHtml(displayName) + '</strong>', 'bot');
  const mapId = 'confirm-map-' + Date.now();
  const mapBubble = document.createElement('div');
  mapBubble.className = 'message bot';
  mapBubble.innerHTML = '<div id="' + mapId + '" style="height:320px;border:1px solid #ddd;border-radius:6px;margin-top:6px;"></div>';
  chatWindow.appendChild(mapBubble);
  const btnBubble = document.createElement('div');
  btnBubble.className = 'message bot';
  btnBubble.innerHTML = '<button class="choice-btn" id="confirm-yes">‚úÖ Ja, passt</button> <button class="choice-btn" id="confirm-retry">üîÑ Neu w√§hlen</button>';
  chatWindow.appendChild(btnBubble);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  setTimeout(function(){
    try {
      var map = L.map(mapId).setView([lat, lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      var marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', function(e){ var pos = e.target.getLatLng(); editingData.location = new firebase.firestore.GeoPoint(pos.lat, pos.lng); });
      editingData.location = new firebase.firestore.GeoPoint(lat, lng);
    } catch(err) {
      addMessage('‚ö†Ô∏è Karte konnte nicht geladen werden.', 'bot');
    }
  }, 200);

  setTimeout(function(){
    var yes = document.getElementById('confirm-yes');
    var retry = document.getElementById('confirm-retry');
    if (yes) yes.onclick = function(){ addMessage('‚úÖ Standort gespeichert.', 'bot'); addMessage('‚è≥ Dein Vorschlag wird nun vom Team gepr√ºft und nach Freigabe sichtbar.', 'bot'); submitNewHut(); };
    if (retry) retry.onclick = function(){ addMessage('üîÑ Bitte gib eine neue Adresse ein:', 'bot'); step = 'address_input'; };
  }, 300);
}

async function showTagSuggestions(query) {
  if (!query || query.length < 1) return;
  try {
    const snap = await db.collection('tag_counts').orderBy('count','desc').limit(20).get();
    const tags = snap.docs.map(function(d){ return { tag: d.id, count: d.data().count || 0 }; }).filter(function(t){ return t.tag.indexOf(query.toLowerCase()) === 0; });
    if (!tags.length) return;
    var container = document.createElement('div'); container.className = 'message bot';
    tags.slice(0,8).forEach(function(t){
      var btn = document.createElement('button'); btn.className = 'choice-btn'; btn.textContent = t.tag + ' (' + t.count + ')';
      btn.onclick = function(){ if (inputField) inputField.value = t.tag; container.remove(); if (inputField) inputField.focus(); };
      container.appendChild(btn);
    });
    chatWindow.appendChild(container);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  } catch(e) {}
}

async function incrementTagCounts(tags) {
  if (!Array.isArray(tags) || !tags.length) return;
  try {
    if (firebase.functions) {
      try { var fn = firebase.app().functions('us-central1').httpsCallable('incrementTagCounts'); await fn({ tags: tags }); return; } catch(e) {}
    }
    var batch = db.batch();
    tags.forEach(function(tag){
      var id = tag.toLowerCase().trim();
      if (!id) return;
      batch.set(db.collection('tag_counts').doc(id), { count: firebase.firestore.FieldValue.increment(1) }, { merge: true });
    });
    await batch.commit();
  } catch(e) {}
}

async function submitNewHut() {
  if (!editingData) editingData = {};
  if (!editingData.id) editingData.id = db.collection('eierhuetten').doc().id;
  if (!editingData.location) { addMessage('‚ö†Ô∏è Es wurde noch kein Standort gespeichert. Bitte Adresse eingeben oder GPS w√§hlen.', 'bot'); return; }
  var lat = editingData.location.latitude, lng = editingData.location.longitude;
  if (await locationExistsNearby(lat, lng, 20)) { addMessage('‚ö†Ô∏è An der ausgew√§hlten Stelle existiert bereits eine H√ºtte.', 'bot'); return; }
  try {
    var docRef = db.collection('eierhuetten').doc(editingData.id);
    var final = Object.assign({}, editingData, { fotos: (editingData.fotos || []).filter(function(f){ return f && f.url; }), userId: (currentUser && currentUser.uid) || null, status: 'offen', erstelltAm: editingData.createdAt || firebase.firestore.FieldValue.serverTimestamp() });
    await docRef.set(final, { merge: true });
    if (final.tags && final.tags.length) await incrementTagCounts(final.tags);
    addMessage('‚úÖ Vielen Dank ‚Äî deine H√ºtte wurde eingereicht!', 'bot');
    addMessage('üîé Wir pr√ºfen deinen Vorschlag nun. Du kannst deine Eintr√§ge unter ‚ÄûMeine H√ºtten‚Äú sehen, sobald sie freigegeben sind.', 'bot');
    var btn = document.createElement('div'); btn.className = 'message bot'; btn.innerHTML = '<button class="choice-btn" onclick="showMyHuts()">‚û°Ô∏è Meine H√ºtten anzeigen</button>';
    chatWindow.appendChild(btn);
    step = null; editingData = {};
  } catch(e) { addMessage('‚ùå Fehler beim Abschicken: ' + (e.message || e), 'bot'); }
}

async function handleAddressInput(txt) {
  var coords = await geocodeAddress(txt.trim());
  if (!coords) { addMessage('‚ùå Adresse konnte nicht gefunden werden. Bitte erneut eingeben.', 'bot'); return; }
  editingData.address = coords.display_name;
  editingData.location = new firebase.firestore.GeoPoint(coords.lat, coords.lng);
  showLocationConfirmation(coords.lat, coords.lng, editingData.address);
}
function handleGPSLocation(lat, lng) { editingData.location = new firebase.firestore.GeoPoint(lat, lng); showLocationConfirmation(lat, lng, 'GPS-Standort'); }

function askForAnimals() {
  addMessage('üêæ Welche Tiere gibt es an der H√ºtte? (Mehrfachauswahl m√∂glich)', 'bot');
  var tiere = ['üêê Ziege','üêÑ Kuh','üêì Huhn','üêï Hund','üêá Hase','‚ùå Keine'];
  editingData.tiere = editingData.tiere || [];
  var container = document.createElement('div'); container.className = 'message bot';
  tiere.forEach(function(tier){
    var btn = document.createElement('button'); btn.className = 'choice-btn'; btn.textContent = tier;
    btn.onclick = function(){
      if (tier === '‚ùå Keine') { editingData.tiere = []; addMessage('‚ùå Keine Tiere ausgew√§hlt', 'bot'); }
      else { if (editingData.tiere.indexOf(tier) === -1) editingData.tiere.push(tier); addMessage('‚úÖ Aktuell gew√§hlt: ' + editingData.tiere.join(', '), 'bot'); }
    };
    container.appendChild(btn);
  });
  var weiter = document.createElement('button'); weiter.className = 'choice-btn mt-2'; weiter.textContent = '‚û°Ô∏è Weiter';
  weiter.onclick = async function(){ await saveDraft(editingData.id, { tiere: editingData.tiere }); step = 'beschreibung_input'; addMessage('üìù Bitte gib eine kurze Beschreibung deiner H√ºtte ein:', 'bot'); };
  container.appendChild(weiter); chatWindow.appendChild(container); chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function showMyHuts() {
  chatWindow.innerHTML = '';
  var snapshot = await db.collection('eierhuetten').where('userId','==', currentUser.uid).get();
  if (snapshot.empty) { addMessage('Du hast noch keine H√ºtten.', 'bot'); return; }
  var wrapper = document.createElement('div'); wrapper.className = 'message bot'; wrapper.style.padding = '12px'; wrapper.style.borderRadius = '8px'; wrapper.style.background = '#f7f7f9';
  wrapper.innerHTML = '<strong>Meine H√ºtten</strong><div id="hut-list" style="margin-top:8px;"></div>'; chatWindow.appendChild(wrapper);
  var list = wrapper.querySelector('#hut-list');
  snapshot.docs.forEach(function(doc){
    var d = doc.data(), id = doc.id;
    var item = document.createElement('div'); item.style.borderTop = '1px solid #e5e7eb'; item.style.padding = '8px 0';
    item.innerHTML = '<div style="font-weight:600">üè° ' + escapeHtml(d.name || '(ohne Namen)') + '</div><div>üìå Status: ' + escapeHtml(d.status || 'offen') + '</div>';
    var actions = document.createElement('div'); actions.style.marginTop = '6px';
    var editBtn = document.createElement('button'); editBtn.className = 'choice-btn'; editBtn.textContent = '‚úèÔ∏è Bearbeiten'; editBtn.onclick = function(){ alert('Edit: nicht implementiert in dieser Version'); };
    var delBtn = document.createElement('button'); delBtn.className = 'choice-btn'; delBtn.textContent = 'üóëÔ∏è L√∂schen'; delBtn.onclick = async function(){ if (!confirm('H√ºtte l√∂schen?')) return; await db.collection('eierhuetten').doc(id).delete(); addMessage('üóëÔ∏è H√ºtte gel√∂scht.', 'bot'); showMyHuts(); };
    actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions);
    if (d.status === 'angenommen') {
      var chatArea = document.createElement('div'); chatArea.id = 'chat-messages-' + id; chatArea.style.marginTop = '6px'; chatArea.innerText = 'Lade Nachrichten...'; item.appendChild(chatArea);
      ladeHutNachrichtenListe(id).catch(function(e){ chatArea.innerHTML = '<em>Fehler beim Laden</em>'; });
    } else {
      var info = document.createElement('div'); info.style.fontStyle = 'italic'; info.textContent = 'üí¨ Nachrichten erst nach Freigabe'; item.appendChild(info);
    }
    list.appendChild(item);
  });
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// expose functions
window.handleAddressInput = handleAddressInput;
window.handleGPSLocation = handleGPSLocation;
window.showLocationConfirmation = showLocationConfirmation;
window.submitNewHut = submitNewHut;
window.showMyHuts = showMyHuts;
</script>

</body>
  </html>
