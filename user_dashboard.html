<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hütte einreichen</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f4f8; }
    header, main { padding: 20px; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    #map { height: 300px; border-radius: 12px; margin-bottom: 10px; }
    label { display: block; margin-top: 10px; }
    input, textarea, button, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px; }
    button { background: #4caf50; color: white; cursor: pointer; margin-top: 15px; }
    #userHuts .card { border-left: 5px solid #4caf50; }
  </style>
</head>
<body>
<header>
  <h2>Willkommen! Hütte einreichen</h2>
  <button id="logoutBtn">Logout</button>
</header>
<main>
  <div class="card">
    <h3>Neue Hütte einreichen</h3>
    <label for="hutName">Name der Hütte</label>
    <input id="hutName" type="text"><label for="description">Beschreibung</label>
<textarea id="description" rows="4"></textarea>

<label for="locationSearch">Ort suchen</label>
<input id="locationSearch" type="text" placeholder="Ort eingeben...">

<div id="map"></div>

<button id="submitHut">Einreichen</button>

  </div>  <div class="card">
    <h3>Meine eingereichten Hütten</h3>
    <div id="userHuts"></div>
  </div>
</main><script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.firebasestorage.app",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
    measurementId: "G-16V6K5GXDT"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser;

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loadUserHuts();
    } else {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }
  });

  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  const map = L.map('map').setView([51.96, 7.62], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  let marker;
  map.on('click', e => {
    if (marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng).addTo(map);
  });

  document.getElementById('submitHut').onclick = async () => {
    const name = document.getElementById('hutName').value;
    const desc = document.getElementById('description').value;
    const location = marker ? marker.getLatLng() : null;
    if (!name || !desc || !location) return alert('Bitte alle Felder ausfüllen.');
    await db.collection('eierhuetten').add({
      name,
      beschreibung: desc,
      standort: new firebase.firestore.GeoPoint(location.lat, location.lng),
      userId: currentUser.uid,
      userName: currentUser.displayName,
      status: 'offen',
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert('Hütte eingereicht!');
    loadUserHuts();
  };

  async function loadUserHuts() {
    const snapshot = await db.collection('eierhuetten').where('userId', '==', currentUser.uid).get();
    const container = document.getElementById('userHuts');
    container.innerHTML = '';
    snapshot.forEach(doc => {
      const d = doc.data();
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <strong>${d.name}</strong><br>
        <small>Status: ${d.status}</small><br>
        <em>${d.beschreibung || ''}</em><br>
        <button onclick="editHut('${doc.id}', '${d.name}', \`${d.beschreibung || ''}\`)" >Bearbeiten</button>
      `;
      container.appendChild(div);
    });
  }

  function editHut(id, name, desc) {
    const newName = prompt('Neuer Name:', name);
    const newDesc = prompt('Neue Beschreibung:', desc);
    if (newName && newDesc) {
      db.collection('eierhuetten').doc(id).update({
        name: newName,
        beschreibung: newDesc,
        status: 'überarbeitet'
      });
      alert('Bearbeitung gespeichert. Ein Administrator muss sie erneut freigeben.');
      loadUserHuts();
    }
  }
</script></body>
</html>
