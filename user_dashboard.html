<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eierhütten Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; background: #f7f7f7; }
    header { background: #4CAF50; padding: 1em; color: white; text-align: center; }
    #dashboard { display: none; padding: 1em; }
    .card { background: white; padding: 1em; border-radius: 8px; margin-bottom: 1em; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    #map { height: 300px; margin: 1em 0; }
    .suggestion { background: #eee; padding: 0.5em; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Eierhütten Benutzer-Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </header>  <div id="loginBox" class="card">
    <p>Bitte melde dich mit Google an:</p>
    <button onclick="login()">Mit Google anmelden</button>
  </div>  <div id="dashboard">
    <div class="card">
      <h2>Neue Hütte einreichen</h2>
      <input type="text" id="huettenName" placeholder="Name der Hütte"><br><br>
      <textarea id="beschreibung" placeholder="Beschreibung"></textarea><br><br>
      <input type="text" id="sucheOrt" placeholder="Ort suchen...">
      <div id="ortVorschlaege"></div>
      <div id="map"></div>
      <button onclick="speichereHuette()">Einreichen</button>
    </div><div class="card">
  <h2>Meine Hütten</h2>
  <div id="meineHuetten"></div>
</div>

  </div>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let user = null;
    let map, marker;

    auth.onAuthStateChanged(u => {
      if (u) {
        user = u;
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        ladeHuetten();
        initMap();
      } else {
        document.getElementById('loginBox').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
      }
    });

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    function logout() {
      auth.signOut();
    }

    function initMap() {
      map = L.map('map').setView([51, 10], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      map.on('click', e => {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
      });
      navigator.geolocation.getCurrentPosition(pos => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        map.setView(latlng, 13);
        marker = L.marker(latlng).addTo(map);
      });
    }

    function speichereHuette() {
      const name = document.getElementById('huettenName').value;
      const beschreibung = document.getElementById('beschreibung').value;
      const pos = marker ? marker.getLatLng() : null;
      if (!name || !beschreibung || !pos) return alert("Bitte alle Felder ausfüllen und Ort wählen.");

      db.collection("eierhuetten").add({
        name,
        beschreibung,
        position: new firebase.firestore.GeoPoint(pos.lat, pos.lng),
        uid: user.uid,
        status: "offen",
        erstellt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("Antrag gespeichert.");
        ladeHuetten();
      });
    }

    function ladeHuetten() {
      const ziel = document.getElementById("meineHuetten");
      ziel.innerHTML = "Lade...";
      db.collection("eierhuetten").where("uid", "==", user.uid)
        .get().then(qs => {
          ziel.innerHTML = "";
          qs.forEach(doc => {
            const d = doc.data();
            ziel.innerHTML += `<div class="card">
              <strong>${d.name}</strong><br>
              ${d.beschreibung}<br>
              Status: <b>${d.status}</b>
            </div>`;
          });
        });
    }

    document.getElementById('sucheOrt').addEventListener('input', async function () {
      const query = this.value.toLowerCase();
      const container = document.getElementById('ortVorschlaege');
      container.innerHTML = "";
      if (query.length < 2) return;

      const ergebnisse = await db.collection("orte")
        .where("name_lower", ">=", query)
        .where("name_lower", "<=", query + '\uf8ff')
        .limit(5).get();

      ergebnisse.forEach(doc => {
        const ort = doc.data();
        const div = document.createElement('div');
        div.textContent = ort.name;
        div.className = 'suggestion';
        div.onclick = () => {
          document.getElementById('sucheOrt').value = ort.name;
          map.setView([ort.lat, ort.lng], 13);
          if (marker) map.removeLayer(marker);
          marker = L.marker([ort.lat, ort.lng]).addTo(map);
          container.innerHTML = "";
        };
        container.appendChild(div);
      });
    });
  </script></body>
</html>
