<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard – Eierhütten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
    header { background: #28a745; color: white; padding: 1rem; text-align: center; }
    #logoutBtn { float: right; background: white; color: #28a745; border: none; padding: 0.5rem; cursor: pointer; }
    #dashboard { padding: 1rem; display: none; }
    .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
    #map { height: 300px; margin-top: 1rem; border-radius: 8px; }
    input, textarea, button, select {
      display: block; width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ccc; border-radius: 4px;
    }
  </style>
</head>
<body>

<header>
  Eierhütten – Benutzer-Dashboard
  <button id="logoutBtn">Logout</button>
</header>

<div id="loginPrompt" style="padding:2rem; text-align:center;">
  <button onclick="signInWithGoogle()">Mit Google anmelden</button>
</div>

<div id="dashboard">
  <div class="card">
    <h3>Neue Hütte einreichen</h3>
    <input id="hName" placeholder="Name der Hütte">
    <textarea id="hDescription" placeholder="Beschreibung"></textarea>
    <input id="hLat" placeholder="Latitude">
    <input id="hLng" placeholder="Longitude">
    <button onclick="submitHut()">Einreichen</button>
  </div>

  <div class="card">
    <h3>Aktueller Standort & Karte</h3>
    <div id="map"></div>
    <input id="search" placeholder="Ort suchen..." oninput="searchPlaces(this.value)">
    <div id="suggestions"></div>
  </div>

  <div class="card">
    <h3>Meine Hütten</h3>
    <div id="myHuts"></div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.firebasestorage.app",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
    measurementId: "G-16V6K5GXDT"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let map;
  let user;

  auth.onAuthStateChanged(u => {
    if (u) {
      user = u;
      document.getElementById('loginPrompt').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      initMap();
      loadUserHuts();
    } else {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginPrompt').style.display = 'block';
    }
  });

  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut();
  });

  function initMap() {
    map = L.map('map').setView([51.5, 10], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      L.marker([latitude, longitude]).addTo(map).bindPopup("Dein Standort").openPopup();
      map.setView([latitude, longitude], 13);
    });
  }

  function submitHut() {
    const name = document.getElementById("hName").value;
    const desc = document.getElementById("hDescription").value;
    const lat = parseFloat(document.getElementById("hLat").value);
    const lng = parseFloat(document.getElementById("hLng").value);

    if (!name || isNaN(lat) || isNaN(lng)) return alert("Bitte gültige Daten eingeben.");

    db.collection("eierhuetten").add({
      name,
      description: desc,
      lat,
      lng,
      status: "offen",
      user: user.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("Eingereicht! Nach Admin-Freigabe sichtbar.");
      loadUserHuts();
    });
  }

  function loadUserHuts() {
    db.collection("eierhuetten").where("user", "==", user.uid).get().then(snapshot => {
      const container = document.getElementById("myHuts");
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const card = document.createElement("div");
        card.innerHTML = `<b>${data.name}</b> – Status: ${data.status} <br><small>${data.description || ''}</small>`;
        container.appendChild(card);
      });
    });
  }

  function searchPlaces(query) {
    if (query.length < 2) return document.getElementById("suggestions").innerHTML = "";
    db.collection("eierhuetten").orderBy("name").startAt(query).endAt(query + "\uf8ff").get().then(snapshot => {
      const suggestions = document.getElementById("suggestions");
      suggestions.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.textContent = d.name;
        div.style.cursor = "pointer";
        div.onclick = () => {
          document.getElementById("hName").value = d.name;
          document.getElementById("hLat").value = d.lat;
          document.getElementById("hLng").value = d.lng;
          map.setView([d.lat, d.lng], 15);
        };
        suggestions.appendChild(div);
      });
    });
  }
</script>

</body>
</html>
