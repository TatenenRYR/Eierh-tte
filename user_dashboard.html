<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mein Hüttendashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100">
  <nav class="bg-white shadow p-4 flex justify-between">
    <span class="font-bold">Mein Dashboard</span>
    <div id="user-section"></div>
  </nav>  <main class="p-4 max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Meine Eierhütten</h1>
    <div id="huetten-list" class="space-y-4"></div><h2 class="text-xl font-semibold mt-8">Neue Hütte beantragen</h2>
<form id="new-huette-form" class="bg-white p-4 rounded shadow space-y-4">
  <input type="text" id="beschreibung" placeholder="Beschreibung" class="w-full border p-2 rounded" required>
  <input type="text" id="strom" placeholder="Stromversorgung (Ja/Nein)" class="w-full border p-2 rounded">
  <input type="file" id="foto" class="w-full">
  <button class="bg-blue-500 text-white px-4 py-2 rounded" type="submit">Antrag stellen</button>
</form>

<div class="mt-10">
  <label class="inline-flex items-center">
    <input type="checkbox" id="debugToggle" class="form-checkbox">
    <span class="ml-2">Konsole anzeigen (Debug-Modus)</span>
  </label>
</div>

  </main>  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
      measurementId: "G-16V6K5GXDT"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const userSection = document.getElementById("user-section");
    const huettenList = document.getElementById("huetten-list");
    const form = document.getElementById("new-huette-form");
    const debugToggle = document.getElementById("debugToggle");

    let currentUser = null;

    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        userSection.innerHTML = `
          <span>${user.displayName}</span>
          <button class="ml-4 text-red-500" onclick="logout()">Logout</button>`;
        loadHuetten();
        loadDebugSetting();
      } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(console.error);
      }
    });

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    async function loadHuetten() {
      const snapshot = await db.collection("eierhuetten").where("owner", "==", currentUser.uid).get();
      huettenList.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        huettenList.innerHTML += `
          <div class="bg-white p-4 rounded shadow">
            <p><strong>Beschreibung:</strong> ${d.beschreibung}</p>
            <p><strong>Strom:</strong> ${d.strom}</p>
            <p><strong>Status:</strong> ${d.status}</p>
            <button class="text-red-500 mt-2" onclick="deleteHuette('${doc.id}')">Löschen</button>
          </div>`;
      });
    }

    async function deleteHuette(id) {
      if (confirm("Hütte wirklich löschen?")) {
        await db.collection("eierhuetten").doc(id).delete();
        loadHuetten();
      }
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const beschreibung = document.getElementById("beschreibung").value;
      const strom = document.getElementById("strom").value;
      const fotoFile = document.getElementById("foto").files[0];
      let fotoUrl = "";

      if (fotoFile) {
        const ref = storage.ref(`huetten/${currentUser.uid}_${Date.now()}`);
        await ref.put(fotoFile);
        fotoUrl = await ref.getDownloadURL();
      }

      await db.collection("eierhuetten").add({
        beschreibung,
        strom,
        status: "offen",
        owner: currentUser.uid,
        foto: fotoUrl,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      form.reset();
      loadHuetten();
      alert("Antrag eingereicht. Wird von Admin geprüft.");
    };

    async function loadDebugSetting() {
      const doc = await db.collection("settings").doc(currentUser.uid).get();
      if (doc.exists && doc.data().debug) {
        debugToggle.checked = true;
        console.log("Debug-Modus aktiv");
      }
    }

    debugToggle.onchange = async () => {
      await db.collection("settings").doc(currentUser.uid).set({
        debug: debugToggle.checked
      }, { merge: true });
    }
  </script></body>
</html>
