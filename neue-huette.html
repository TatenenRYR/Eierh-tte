<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EierhÃ¼tten-Antrag</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background-color: #f4f4f4;
    }
    #menu {
      background: #333;
      color: white;
      padding: 1rem;
      margin-bottom: 2rem;
      display: none;
    }
    form {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #map {
      height: 300px;
      margin-top: 1rem;
    }
    #betragAnzeigen {
      font-weight: bold;
      margin-bottom: 1rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.7rem 1.5rem;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <nav id="menu">
    <p>ðŸŽ‰ Willkommen zurÃ¼ck! (Nur sichtbar bei Login)</p>
    <button onclick="logout()">Logout</button>
  </nav>

  <p id="betragAnzeigen">Monatlicher Betrag wird geladen...</p>

  <form id="antragsformular">
    <label>
      Dein Name:
      <input type="text" name="name" required />
    </label>
    <label>
      Ort der HÃ¼tte:
      <input type="text" name="ort" required />
    </label>
    <label>
      Beschreibung:
      <textarea name="beschreibung" required></textarea>
    </label>
    <label>
      Stromversorgung:
      <select name="strom" required>
        <option value="">Bitte wÃ¤hlen</option>
        <option value="ja">Ja</option>
        <option value="nein">Nein</option>
      </select>
    </label>
    <label>
      Standort auf der Karte auswÃ¤hlen:
      <div id="map"></div>
      <p id="koordInfo">Keine Koordinaten gewÃ¤hlt</p>
    </label>
    <button type="submit">Antrag absenden</button>
  </form>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
      measurementId: "G-16V6K5GXDT"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const menu = document.getElementById('menu');
    const form = document.getElementById('antragsformular');
    const betragAnzeigen = document.getElementById('betragAnzeigen');
    const koordInfo = document.getElementById('koordInfo');
    let aktuelleCoords = null;
    let marker = null;
    let aktuellerBetrag = null;

    // Auth-Status und MenÃ¼
    auth.onAuthStateChanged(user => {
      menu.style.display = user ? 'block' : 'none';
    });

    function logout() {
      auth.signOut();
    }

    // Live-Betrag aus Firestore
    const einstellungenRef = db.collection('settings').doc('gebuehren');
    einstellungenRef.onSnapshot(docSnap => {
      if (docSnap.exists) {
        const data = docSnap.data();
        aktuellerBetrag = data.betrag ?? null;
        betragAnzeigen.textContent = aktuellerBetrag !== null ?
          `Monatlicher Betrag: ${aktuellerBetrag.toFixed(2)} â‚¬` :
          'Monatlicher Betrag nicht festgelegt.';
      } else {
        betragAnzeigen.textContent = 'Betragsdaten nicht gefunden.';
      }
    }, error => {
      console.error("Fehler beim Laden:", error);
      betragAnzeigen.textContent = 'Fehler beim Laden des Betrags.';
    });

    // Leaflet: Karte anlegen
    const map = L.map('map').setView([51.1657,10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    map.on('click', e => {
      aktuelleCoords = e.latlng;
      if (marker) marker.setLatLng(aktuelleCoords);
      else marker = L.marker(aktuelleCoords).addTo(map);
      koordInfo.textContent = `Koordinaten: ${aktuelleCoords.lat.toFixed(6)}, ${aktuelleCoords.lng.toFixed(6)}`;
    });

    navigator.geolocation.getCurrentPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      map.setView(latlng, 13);
      marker = L.marker(latlng).addTo(map);
      aktuelleCoords = L.latLng(latlng);
      koordInfo.textContent = `Koordinaten: ${latlng[0].toFixed(6)}, ${latlng[1].toFixed(6)}`;
    });

    // Formular-Submit
    form.addEventListener('submit', async e => {
      e.preventDefault();

      if (aktuellerBetrag === null) {
        alert("Bitte warten, bis der Preis geladen wurde.");
        return;
      }
      if (!aktuelleCoords) {
        alert("Bitte wÃ¤hle den Standort auf der Karte.");
        return;
      }
      if (!auth.currentUser) {
        alert("Bitte melde dich zuerst an.");
        return;
      }

      const confirmSend = confirm(`Antrag einreichen zu ${aktuellerBetrag.toFixed(2)}â€¯â‚¬/Monat?`);
      if (!confirmSend) return;

      const data = {
        name: form.name.value.trim(),
        ort: form.ort.value.trim(),
        beschreibung: form.beschreibung.value.trim(),
        strom: form.strom.value,
        location: new firebase.firestore.GeoPoint(aktuelleCoords.lat, aktuelleCoords.lng),
        betrag: aktuellerBetrag,
        status: 'ausstehend',
        erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
        userId: auth.currentUser.uid,
        userName: auth.currentUser.displayName || '',
      };

      try {
        await db.collection('eierhuetten_antraege').add(data);
        form.innerHTML = "<h2>ðŸŽ‰ Vielen Dank! Dein Antrag wurde Ã¼bermittelt.</h2><p>Wir melden uns bald.</p>";
      } catch (err) {
        console.error("Fehler beim Einreichen:", err);
        alert('Fehler beim Einreichen: ' + err.message);
      }
    });
  </script>
</body>
</html>
