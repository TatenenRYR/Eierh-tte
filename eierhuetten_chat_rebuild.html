<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eierh√ºtten Chat & Verwaltung</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  #chat-window { height: 400px; overflow-y: auto; background: #ffffff; border-radius: .5rem; padding: 1rem; }
  .message { margin-bottom: 1rem; }
  .bot { color: #0369a1; }
  .user { color: #166534; text-align: right; }
  .minimap { width: 100%; height: 150px; margin-top: .5rem; border-radius: .5rem; }
  .edit-input { width: 100%; padding: .3rem; margin-top: .3rem; border: 1px solid #ccc; border-radius: .3rem; }
  button { cursor: pointer; }
</style>
</head>
<body class="bg-gray-100 p-6">

<div id="login-section" class="text-center mb-6">
  <button id="google-login" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded text-lg">
    Mit Google anmelden
  </button>
</div>

<div id="chat-area" class="max-w-3xl mx-auto hidden">
  <h1 class="text-2xl font-bold text-green-700 mb-4">ü•ö Eierh√ºtten Assistent & Verwaltung</h1>
  <div id="chat-window" aria-live="polite" role="log"></div>
  <div class="flex gap-2 mt-4">
    <input id="chat-input" type="text" placeholder="Antwort eingeben..." class="flex-grow p-2 border border-gray-300 rounded" />
    <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Senden</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
  authDomain: "eierhuettentour.firebaseapp.com",
  projectId: "eierhuettentour",
  storageBucket: "eierhuettentour.appspot.com",
  messagingSenderId: "348272135205",
  appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(), auth = firebase.auth();

let currentUser, step = 0, formData = {};

const chatWindow = document.getElementById('chat-window'),
      chatInput  = document.getElementById('chat-input'),
      sendBtn    = document.getElementById('send-btn');

function escapeHtml(text) {
  return text.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function addMessage(html, sender='bot') {
  const div = document.createElement('div');
  div.className = 'message ' + sender;
  div.innerHTML = html;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function startDialog() {
  chatWindow.innerHTML = '';
  step = 0; formData = {};
  addMessage('ü§ñ Wie hei√üt deine neue Eierh√ºtte?');
}

function sendInput() {
  const txt = chatInput.value.trim();
  if (!txt) return;
  addMessage('üßë ' + escapeHtml(txt), 'user');
  processInput(txt);
  chatInput.value = '';
}

function processInput(txt) {
  if (step===0) {
    formData.name=txt; step=1;
    addMessage('ü§ñ Hat die H√ºtte Sitzpl√§tze? (Ja/Nein)');
  } else if (step===1) {
    formData.sitzplaetze=txt; step=2;
    addMessage('ü§ñ Gibt es Strom? (Ja/Nein)');
  } else if (step===2) {
    formData.strom=txt; step=3;
    addMessage('ü§ñ Extras? (Weiter f√ºr keine)');
  } else if (step===3) {
    formData.extras= txt.toLowerCase()==='weiter'?'':txt; step=4;
    addMessage('ü§ñ Standort w√§hlen: Klicke auf Karte');
    const md=document.createElement('div'); md.id='map-select'; md.className='minimap'; chatWindow.appendChild(md);
    const map = L.map('map-select').setView([51.1657,10.4515],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let mk;
    map.on('click', e => {
      if(mk) mk.setLatLng(e.latlng); else mk=L.marker(e.latlng,{draggable:true}).addTo(map);
      formData.location=e.latlng;
      addMessage('ü§ñ Standort gespeichert: '+e.latlng.lat.toFixed(5)+', '+e.latlng.lng.toFixed(5));
      addMessage('ü§ñ Soll eingereicht werden? (Ja/Nein)');
    });
  } else if (step===4 && txt.toLowerCase()==='ja') {
    submitHut();
  } else if (txt.toLowerCase()==='meine h√ºtten') {
    loadMyHuts();
  } else {
    startDialog();
  }
}

function submitHut() {
  const doc={...formData,
    location:new firebase.firestore.GeoPoint(formData.location.lat,formData.location.lng),
    userId:currentUser.uid,
    erstelltAm:firebase.firestore.FieldValue.serverTimestamp(),
    status:'offen'
  };
  db.collection('eierhuetten').add(doc).then(()=>{
    addMessage('ü§ñ H√ºtte erfolgreich eingereicht!');
    startDialog();
  });
}

function loadMyHuts() {
  chatWindow.innerHTML='';
  addMessage('ü§ñ Lade deine H√ºtten...');
  db.collection('eierhuetten').where('userId','==',currentUser.uid).orderBy('erstelltAm','desc').get().then(snap=>{
    chatWindow.innerHTML='';
    if(snap.empty){ addMessage('ü§ñ Keine H√ºtten gefunden.'); startDialog(); return; }
    snap.forEach(doc=>{
      const d=doc.data(), id=doc.id;
      addMessage(
        '<div><strong>üìç '+escapeHtml(d.name)+'</strong> ('+escapeHtml(d.status)+')</div>'
        +'<div>ü™ë '+escapeHtml(d.sitzplaetze)+'</div>'
        +'<div>üîå '+escapeHtml(d.strom)+'</div>'
        +'<div>‚ú® '+escapeHtml(d.extras)+'</div>'
        +'<div id="mini-'+id+'" class="minimap"></div>'
        +'<button onclick="editHut(\\''+id+'\\')" class="bg-yellow-400 text-white px-2 py-1 rounded mt-1">Bearbeiten</button>'
        +' <button onclick="deleteHut(\\''+id+'\\')" class="bg-red-500 text-white px-2 py-1 rounded mt-1">L√∂schen</button>'
      );
      setTimeout(()=>{
        const m=L.map('mini-'+id,{zoomControl:false,dragging:false}).setView([d.location.latitude,d.location.longitude],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
        L.marker([d.location.latitude,d.location.longitude]).addTo(m);
        m.invalidateSize();
      },100);
    });
  });
}

function editHut(id) {
  db.collection('eierhuetten').doc(id).get().then(doc=>{
    const d=doc.data();
    chatWindow.innerHTML='';
    addMessage('ü§ñ Bearbeite: '+escapeHtml(d.name));
    const fw=document.createElement('div'); fw.className='message bot';
    fw.innerHTML=`
      <label>Name:<input id="e-name" class="edit-input" value="${escapeHtml(d.name)}"/></label>
      <label>Sitzpl√§tze:<select id="e-sitz" class="edit-input"><option>Ja</option><option>Nein</option></select></label>
      <label>Strom:<select id="e-strom" class="edit-input"><option>Ja</option><option>Nein</option></select></label>
      <label>Extras:<input id="e-extras" class="edit-input" value="${escapeHtml(d.extras)}"/></label>
      <label>Standort:<div id="e-map" class="minimap"></div></label>
      <div class="mt-2">
        <button id="save" class="bg-green-600 text-white px-3 py-1 rounded">Speichern</button>
        <button id="cancel" class="bg-gray-400 text-black px-3 py-1 rounded">Abbrechen</button>
      </div>`;
    chatWindow.appendChild(fw);
    document.getElementById('e-sitz').value=d.sitzplaetze;
    document.getElementById('e-strom').value=d.strom;
    setTimeout(()=>{
      const m2=L.map('e-map').setView([d.location.latitude,d.location.longitude],13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m2);
      const mk=L.marker([d.location.latitude,d.location.longitude],{draggable:true}).addTo(m2);
      mk.on('dragend',()=>{ d.location=mk.getLatLng(); });
    },100);
    document.getElementById('save').onclick=()=>{
      db.collection('eierhuetten').doc(id).update({
        name:document.getElementById('e-name').value,
        sitzplaetze:document.getElementById('e-sitz').value,
        strom:document.getElementById('e-strom').value,
        extras:document.getElementById('e-extras').value,
        location:new firebase.firestore.GeoPoint(d.location.lat,d.location.lng)
      }).then(()=>{ addMessage('‚úÖ Gespeichert'); loadMyHuts(); });
    };
    document.getElementById('cancel').onclick=()=> loadMyHuts();
  });
}

function deleteHut(id) {
  if(confirm('H√ºtte wirklich l√∂schen?')) {
    db.collection('eierhuetten').doc(id).delete().then(()=>{ addMessage('üóëÔ∏è Gel√∂scht'); loadMyHuts(); });
  }
}

auth.onAuthStateChanged(user=>{
  if(user){ currentUser=user; document.getElementById('login-section').classList.add('hidden'); document.getElementById('chat-area').classList.remove('hidden'); startDialog(); }
});
document.getElementById('google-login').onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
sendBtn.onclick=sendInput;
chatInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendInput();});
</script>
</body>
</html>
