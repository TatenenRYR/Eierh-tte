<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap { height: 200px; z-index: 0; }
    .leaflet-container { z-index: 0 !important; }
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; }
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    .sidebar-btn.active, .sidebar-btn.font-semibold {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5; border-color: #10b981; transform: scale(1.01); }
    #smartUploadPreview img { transition: all 0.25s ease; }
    #smartUploadPreview img:hover { transform: scale(1.05); filter: brightness(1.1); }
    @keyframes pulseUpload {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    .uploading::after {
      content: "â«";
      position: absolute;
      top: 4px; right: 4px;
      font-size: 0.8rem;
      animation: pulseUpload 1s infinite;
      color: #16a34a;
    }
  </style>
</head>
<body class="bg-gray-100">
<script>window.stepInfos = window.stepInfos || [];</script>

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" 
           class="w-64 h-64 drop-shadow-lg" 
           alt="Funny Hut" />
    </div>

    <h1 class="text-3xl font-extrabold text-green-700 mb-3">
      Assistent-Dashboard
    </h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>

    <button onclick="doGoogleLogin()" 
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" 
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>

    <p class="text-xs text-gray-400 mt-6">
      ğŸ”’ Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.
    </p>
  </div>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

  <div class="flex flex-col items-center mb-8">
    <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
      <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
      <span id="avatarInitials"></span>
    </div>
    <p class="text-sm text-gray-600">Angemeldet als:</p>
    <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
    <button class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform" onclick="logout()">Logout</button>
  </div>

  <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
    ğŸŒ¿ Assistent
  </div>

  <nav class="flex flex-col gap-2 text-[15px]">
    <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      ğŸš² Startseite
    </a>
    <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      ğŸš´â€â™‚ï¸ zur RadlMap
    </a>

    <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">
      ğŸ“Š Betreiber-Dashboard
    </button>
    <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">
      ğŸ“‹ Meine Eintragungen
    </button>
    <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">
      â• Neue Eintragung
    </button>

    <div class="mt-4">
      <div class="flex items-center justify-between px-3 mb-1">
        <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
      </div>

      <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
        <button id="btnMyEvents"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnMyEvents'); showMyEvents()">
          ğŸ“… <span>Meine Events</span>
        </button>
        <button id="btnCreateEvent"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnCreateEvent'); showCreateEvent()">
          â• <span>Neues Event</span>
        </button>
      </div>
    </div>

    <hr class="my-3 border-gray-200">

    <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSupport'); openSupport()">
      ğŸ’¬ Support
    </button>
    <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
      ğŸ’Œ HÃ¼tten-Nachrichten
      <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
    </button>
  </nav>

  <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
    v2.1 &middot; RadlMap Assistent
  </div>
</aside>
    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
  <div class="sticky top-4">
    <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
    <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
    <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">âœ•</button>
    <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
    <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg" onclick="toggleInfoSidebar()">
  â„¹ï¸
</button>

<script>
  // Entfernt vorherige aktive Buttons und markiert den aktuellen
  function setActive(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('bg-green-100', 'font-semibold'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) {
      activeBtn.classList.add('bg-green-100', 'font-semibold');
    }
  }

  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('-translate-x-full');
  }

  function toggleInfoSidebar() {
    document.getElementById('infoOverlay').classList.toggle('hidden');
    // Inhalt kopieren, da mobile Box getrennt ist
    document.getElementById('infoBoxMobile').innerHTML = document.getElementById('infoBox').innerHTML;
  }
  document.getElementById('closeInfo')?.addEventListener('click', toggleInfoSidebar);
</script>

    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">â˜°</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">â¬…ï¸ ZurÃ¼ck</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter â¡ï¸</button>
      </div>
    </main>
  </div>

  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  // imgbb API key (wie in Admin-Code verwendet)
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c"; // Platzhalter-Key (bitte durch Ihren echten Key ersetzen)

  // Init firebase
    
  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">âŒ Firebase konnte nicht initialisiert werden. PrÃ¼fe die Konfiguration in der Datei.</div>`;
  }

  // Demo user: in deinem Produktivbetrieb sollte hier auth.onAuthStateChanged triggern
  let currentUser = { uid: "demo", email: "demo@example.com", displayName: "Demo" };
firebase.auth().onAuthStateChanged(u => {
  if (u) {
    currentUser = u;
    setGoogleProfile(u); // Profilbild / Initialen setzen
    document.getElementById("accountMail").textContent = u.email;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainApp").classList.remove("hidden");

    // Sidebar geschlossen halten
    document.getElementById('sidebar').classList.add('-translate-x-full');

    mode = "list";
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
    
    // Tutorial-Startseite zeigen
    showTutorial();
initHutMessagesBadge();
  } else {
    // nicht eingeloggt
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("question-area").innerHTML = "";
  }
});
    async function doGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await firebase.auth().signInWithPopup(provider);
    showToast("âœ… Eingeloggt mit Google");
    
  } catch (e) {
    console.error("Google Login error", e);
    alert("Fehler beim Google-Login: " + e.message);
  }
    }

function logout() {
  firebase.auth().signOut();
}
    let mode = "entry"; // "entry" oder "list"
  /***********************
   * State & steps
   ***********************/
  let editingData = {};
  let step = 0;
  const stepsCount = 11; // 0..10
  

  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }
    // ==========================================================
// ğŸ•’ Ã–ffnungszeiten Editor (RadlMap-Style)
// ==========================================================

// helper for localized day names
const DAY_LABELS = [
  { key: "mo", label: "Montag" },
  { key: "di", label: "Dienstag" },
  { key: "mi", label: "Mittwoch" },
  { key: "do", label: "Donnerstag" },
  { key: "fr", label: "Freitag" },
  { key: "sa", label: "Samstag" },
  { key: "so", label: "Sonntag" }
];

// Rendering des Editors
function renderOpeningHoursEditor(hutId, data = {}) {
  // Wenn es sich um das Array-Format handelt, in Objekt-Format umwandeln (fÃ¼r UI)
  if (Array.isArray(data)) {
    const obj = {};
    data.forEach(d => {
      obj[d.tag] = { open: true, from: d.von, to: d.bis };
    });
    data = obj;
  }
  
  let html = `
    <div id="openhours-${hutId}" class="space-y-2 mt-2">
      <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
        <thead class="bg-green-100 text-green-800">
          <tr>
            <th class="py-2 px-3 text-left">Tag</th>
            <th class="py-2 px-3 text-center">GeÃ¶ffnet</th>
            <th class="py-2 px-3 text-center">Von</th>
            <th class="py-2 px-3 text-center">Bis</th>
          </tr>
        </thead>
        <tbody class="divide-y">
  `;

  DAY_LABELS.forEach(day => {
    const d = data[day.key] || {};
    // PrÃ¼fe, ob "open" gesetzt ist, oder ob "from"/"to" Werte haben
    const open = !!d.open || (!!d.from && !!d.to); 
    const from = d.from || "";
    const to = d.to || "";
    html += `
      <tr>
        <td class="py-2 px-3">${day.label}</td>
        <td class="text-center">
          <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
      <p class="text-xs text-gray-500">Tipp: Wenn du das KÃ¤stchen leer lÃ¤sst, wird "geschlossen" angezeigt.</p>
    </div>
  `;
  return html;
}

// Daten auslesen (wird vom neuen step 5 verwendet)
function collectOpeningHours(hutId) {
  const wrapper = document.getElementById(`openhours-${hutId}`);
  if (!wrapper) return {};
  const result = {};
  DAY_LABELS.forEach(day => {
    const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
    const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
    const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
    const open = openCheckbox.checked;
    result[day.key] = {
      open,
      from: open ? fromInput.value : "",
      to: open ? toInput.value : ""
    };
  });
  return result;
}

// Dynamische Aktivierung / Deaktivierung
document.addEventListener("change", (e) => {
  if (e.target.classList.contains("oh-open")) {
    const day = e.target.dataset.day;
    const row = e.target.closest("tr");
    const from = row.querySelector(".oh-from");
    const to = row.querySelector(".oh-to");
    const isOpen = e.target.checked;
    from.disabled = !isOpen;
    to.disabled = !isOpen;
    if (!isOpen) {
      from.value = "";
      to.value = "";
    }
  }
});
  /***********************
   * Render Flow (Questions)
   ***********************/
          // Texte fÃ¼r Step 2 je nach Typ
const typeTexts = {
  EierhÃ¼tte: {
    title: "ğŸ·ï¸ Name der EierhÃ¼tte",
    question: "Wie soll deine EierhÃ¼tte heiÃŸen?"
  },
  Hofladen: {
    title: "ğŸ·ï¸ Name des Hofladens",
    question: "Wie soll dein Hofladen heiÃŸen?"
  },
  Selbstbedienung: {
    title: "ğŸ·ï¸ Name des SelbstbedienungshÃ¤uschens",
    question: "Wie soll dein SelbstbedienungshÃ¤uschen heiÃŸen?"
  },
  Spielplatz: {
    title: "ğŸ·ï¸ Name des Spielplatzes",
    question: "Wie soll der Spielplatz heiÃŸen?"
  },
  Abenteuerhof: {
    title: "ğŸ·ï¸ Name des Abenteuerhofs",
    question: "Wie soll dein Abenteuerhof heiÃŸen?"
  },
  Automat: {
    title: "ğŸ·ï¸ Name des Automaten",
    question: "Wie soll dein Automat heiÃŸen?"
  }
};
  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
      
    try {
      if (step === 0) {
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">ğŸ›¡ï¸ DatenschutzerklÃ¤rung</h2>

      <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200">
        <iframe 
          src="https://radlmap.net/datenschutz.html" 
          class="w-full h-[500px] border-0 bg-white"
          style="display:block; min-width:100%; overflow:auto;">
        </iframe>
      </div>

      <label class="inline-flex items-center gap-2 text-sm text-gray-700">
        <input id="dsCheck" type="checkbox" class="w-4 h-4" disabled /> 
        Ich akzeptiere die DatenschutzerklÃ¤rung
      </label>
      <div id="dsHint" class="text-xs text-red-500 mt-1">
        â¬‡ï¸ Bitte bis ganz nach unten scrollen
      </div>
    </div>`;

  // Scroll-Ãœberwachung
  const scrollBox = document.getElementById("dsScrollBox");
  const check = document.getElementById("dsCheck");
  const hint = document.getElementById("dsHint");

  scrollBox.addEventListener("scroll", () => {
    if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
      check.disabled = false;
      hint.textContent = "âœ… Du kannst nun die DatenschutzerklÃ¤rung akzeptieren.";
      hint.classList.remove("text-red-500");
      hint.classList.add("text-green-600");
    }
  });
  return;
}
      if (step === 1) {
        // Typ-Auswahl
        const opts = [
          { emoji: 'ğŸ¥š', label: 'EierhÃ¼tte', key: 'EierhÃ¼tte' },
          { emoji: 'ğŸª', label: 'Hofladen', key: 'Hofladen' },
          { emoji: 'ğŸ ', label: 'SelbstbedienungshÃ¤uschen', key: 'Selbstbedienung' },
          { emoji: 'ğŸ›', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: 'ğŸŒ„', label: 'Abenteuerhof', key: 'Abenteuerhof' },
          { emoji: 'ğŸ¶', label: 'Automat', key: 'Automat' }
        ];
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto';
        opts.forEach(o => {
          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer';
          if (editingData.typ === o.key) card.classList.add('selected'); // Zustand beibehalten
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key;
          };
          wrap.appendChild(card);
        });
        qa.appendChild(wrap);
        return;
      }



if (step === 2) {
  const currentType = editingData.typ; // <-- statt eintragung.type
  const { title, question } = typeTexts[currentType] || {
    title: "ğŸ·ï¸ Name",
    question: "Wie soll dein Eintrag heiÃŸen?"
  };

  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-lg font-bold mb-2">${title}</h2>
      <p class="text-sm text-gray-600 mb-2">${question}</p>
      <input id="nameInput"
             class="w-full border p-2 rounded"
             placeholder="Name eingeben"
             value="${editingData.name || ''}">
    </div>`;
  return;
}

      if (step === 3) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸª‘ Gibt es SitzplÃ¤tze?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">âœ… Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Nein' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">âŒ Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 4) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ”Œ Gibt es Strom?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">âš¡ Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Nein' ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">âŒ Nein</button>
            </div>
          </div>`;
        return;
      }
      
      // KORREKTUR: Robuster Ã–ffnungszeiten-Editor
      if (step === 5) {
        const immer = editingData.oeffnungszeiten === "Immer geÃ¶ffnet";

        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-3">ğŸ•’ Ã–ffnungszeiten</h2>

            <label class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="immerCheck" ${immer ? "checked" : ""}>
              Immer geÃ¶ffnet (z.B. 24/7)
            </label>

            <div id="dayInputsContainer" class="${immer ? "hidden" : ""}">
              ${renderOpeningHoursEditor('newEntry', editingData.oeffnungszeiten || {})}
            </div>

            <div id="additionalHours" class="mt-4">
              <h4 class="font-semibold mb-2">Saisonale oder abweichende Zeiten (optional)</h4>
              <textarea id="abweichendeZeiten" class="w-full border p-2 rounded text-sm" rows="3" placeholder="z.B. Nur April bis Oktober geÃ¶ffnet oder Feiertags geschlossen.">${editingData.abweichendeZeiten || ''}</textarea>
            </div>
          </div>
        `;

        document.getElementById("immerCheck").addEventListener("change", (e) => {
          const isChecked = e.target.checked;
          document.getElementById("dayInputsContainer").classList.toggle("hidden", isChecked);
          // Vormerken des Zustands
          editingData.oeffnungszeiten = isChecked ? "Immer geÃ¶ffnet" : editingData.oeffnungszeiten;
        });

        return;
      }
      

      if (step === 6) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">âœ¨ Extras (optional)</h2>
            <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. GetrÃ¤nke, KÃ¼hlschrank" value="${editingData.extras || ''}">
          </div>`;
        return;
      }

      if (step === 7) {
        // Tiere toggle buttons (markieren, don't auto-next)
        const animals = ["ğŸ Ziege","ğŸ„ Kuh","ğŸ“ Huhn","ğŸ• Hund","ğŸ‡ Hase","ğŸˆ Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">ğŸ¾ Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const btn = document.createElement('button');
          const isSel = editingData.tiere.includes(t);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            // toggle
            if (t === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              // remove selected from others
              holder.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              return;
            }
            // if 'Keine Tiere' present -> remove it
            editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
            const idx = (editingData.tiere || []).indexOf(t);
            if (idx >= 0) {
              editingData.tiere.splice(idx, 1);
              btn.classList.remove('selected');
            } else {
              editingData.tiere.push(t);
              btn.classList.add('selected');
            }
          };
          holder.appendChild(btn);
        });
        return;
      }

      // ERWEITERUNG: Quill Editor mit KI-Button
      if (step === 8) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ“ Beschreibung</h2>
            
            <button id="generateDescBtn" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm mb-3 hover:bg-blue-600 transition">
              ğŸ§  KI-Beschreibung generieren
            </button>
            
            <div id="quillContainer" class="bg-white"></div>
          </div>`;
        setTimeout(() => {
          initEnhancedEditor("quillContainer", editingData);
        }, 120);
        return;
      }

      if (step === 9) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ·ï¸ SchlagwÃ¶rter (Komma getrennt)</h2>
            <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. FrÃ¼hstÃ¼ck,Schattig" value="${(editingData.tags||[]).join(', ')}">
          </div>`;
        return;
      }

      if (step === 10) {
        mode = "list";
         
         document.getElementById("navBottom").style.display =
         (mode === "entry") ? "flex" : "none";
     
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">ğŸ“‹ Ãœbersicht</h2>
      
      <h3 class="text-lg font-bold mt-4 mb-2">ğŸ“ Standort</h3>
      <div class="relative mb-2">
        <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchenâ€¦" />
        <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
      </div>
      <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded" onclick="locateGPS()">ğŸ“¡ Mein Standort</button>

      <div id="overview-map" class="h-64 rounded border mb-4"></div>

      <div class="flex gap-2">
        <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">âœ… Einreichen</button>
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">âœ– Abbrechen</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprÃ¼ft und erst nach Freigabe sichtbar.</p>
    </div>`;

  // Jetzt nur noch Map initialisieren
  setTimeout(() => {
  initOverviewMap();

  // GPS-Button aktivieren (wurde schon im HTML verlinkt)
  // const gpsBtn = document.getElementById("gpsBtn");
  // if (gpsBtn) gpsBtn.addEventListener("click", locateGPS); // Redundant, da onclick im HTML

  // Adress-Suche mit VorschlÃ¤gen
  const addr = document.getElementById("addressSearch");
  const suggestionBox = document.getElementById("addressSuggestions");
  if (addr) {
    addr.addEventListener("input", async e => {
      const query = e.target.value.trim();
      if (query.length < 3) {
        suggestionBox.innerHTML = "";
        suggestionBox.classList.add("hidden");
        return;
      }
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.length) {
          suggestionBox.innerHTML = "<div class='p-2 text-gray-500'>Keine Treffer</div>";
          suggestionBox.classList.remove("hidden");
          return;
        }

        suggestionBox.innerHTML = data.map(item => `
          <div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="${item.lat}" data-lon="${item.lon}">
            ${item.display_name}
          </div>`).join("");
        suggestionBox.classList.remove("hidden");

        suggestionBox.querySelectorAll("div").forEach(div => {
          div.addEventListener("click", () => {
            const lat = parseFloat(div.dataset.lat);
            const lon = parseFloat(div.dataset.lon);
            addr.value = div.textContent;
            suggestionBox.classList.add("hidden");
            initOverviewMap(lat, lon, 15);
          });
        });
      } catch (err) {
        console.error("Fehler bei Nominatim:", err);
      }
    });
  }
}, 200);
  return;
      }
      
    } catch (err) {
      console.error("renderQuestion error", err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler: ${err.message}</div>`;
    }
  }
    
const stripe = Stripe("pk_test_51SFLgEBghOTdsn6RBYuZr6x4R2BC6lhq4NFWmcKTtyNahatWHMVHAq3posYIhsXKRl598qHOzMzyymuV6DgKWYly006AaME4Wr");


async function showDashboard() {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <section class="bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl shadow-xl max-w-5xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-extrabold text-green-800 mb-6">ğŸ“Š Mein Dashboard</h2>

      <div id="statsArea" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="col-span-3 text-center text-gray-500">Lade Daten...</div>
      </div>

      <div id="limitsArea" class="mb-10"></div>

      <div id="premiumArea" class="mb-10"></div>
      
    </section>
  `;

  const user = firebase.auth().currentUser;
  if (!user) {
    document.getElementById("statsArea").innerHTML =
      `<div class="col-span-3 text-center text-red-600 font-semibold">Bitte zuerst einloggen.</div>`;
    return;
  }

  // ğŸ“ˆ Statistik (Summe)
  db.collection("eierhuetten").where("userId", "==", user.uid).onSnapshot(snapshot => {
    let totalViews = 0, totalRoutes = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      totalViews += data.views || 0;
      totalRoutes += data.routeStarts || 0;
    });
    const avgPerDay = Math.round(totalViews / Math.max(1, snapshot.size));

    document.getElementById("statsArea").innerHTML = `
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ‘ï¸</div>
        <h3 class="font-semibold">Aufrufe</h3>
        <p class="text-2xl font-bold text-green-700">${totalViews}</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ“</div>
        <h3 class="font-semibold">Routenstarts</h3>
        <p class="text-2xl font-bold text-green-700">${totalRoutes}</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ“Š</div>
        <h3 class="font-semibold">Ã˜ Aufrufe pro HÃ¼tte</h3>
        <p class="text-2xl font-bold text-green-700">${avgPerDay}</p>
      </div>
    `;
  });

  // ğŸŒŸ Premium-Bereich & Limits (Logik aus Snippets hinzugefÃ¼gt)
  const betreiberDoc = await db.collection("betreiber").doc(user.uid).get();
  const data = betreiberDoc.data() || {};
  const isPremium = !!data.premium;
  const premiumArea = document.getElementById("premiumArea");
  const limitsArea = document.getElementById("limitsArea");

  // Limits Section
  await showLimitsSection(user, isPremium);
  
  // Premium Section
  if (isPremium) {
    premiumArea.innerHTML = `
      <div class="bg-green-100 p-6 rounded-xl shadow-inner text-center">
        <h3 class="text-lg font-bold text-green-800 mb-2">ğŸŒŸ UnterstÃ¼tzer werden</h3>
        <p class="text-gray-700 mb-3">
          GÃ¼ltig bis <b>${data.premium_until ? new Date(data.premium_until.toDate()).toLocaleDateString("de-DE") : "unbekannt"}</b>
        </p>
        <div class="flex gap-3 justify-center">
          <span class="px-4 py-1 bg-green-600 text-white rounded-full text-sm">UnterstÃ¼tzer</span>
          <button 
            class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition"
            onclick="cancelPremium()"
          >
            âŒ Ich mÃ¶chte bitte kein UnterstÃ¼tzer mehr sein 
          </button>
        </div>
      </div>
    `;
    // Premium-only Features laden
    await showPremiumStatsChart(user);
  } else {
    premiumArea.innerHTML = `
      <div class="bg-white border border-dashed border-gray-300 p-6 rounded-xl text-center">
        <h3 class="text-lg font-semibold mb-2">ğŸš€ Werde UnterstÃ¼tzer!</h3>
        <p class="text-sm text-gray-500 mb-4">
          Erhalte erweiterte Statistiken, mehr Fotos und Live-Events.
        </p>
        <button 
          class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
          onclick="showPremiumUpgrade()"
        >
          ğŸŒŸ Premium freischalten (2 â‚¬/Monat)
        </button>
      </div>
    `;
  }
}
//...
// (Code fÃ¼r showHutMessages, initHutMessagesBadge, ladeHutMessagesLive, deleteHutMessage)
//...
function selectOption(field, value, el) { 
    // Entferne 'selected' von allen Geschwistern
    Array.from(el.parentNode.children).forEach(child => child.classList.remove('selected'));
    // FÃ¼ge 'selected' zum geklickten Element hinzu
    el.classList.add('selected');
    // Speichere den Wert
    editingData[field] = value;
    // Gehe zum nÃ¤chsten Schritt (wenn nicht Schritt 7/Tiere)
    if (step !== 7) {
        nextStep();
    }
}

function nextStep() { 
  // validation for some steps 
  if (step === 0) {
    const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked;
    if (!ok) {
      alert('Bitte DatenschutzerklÃ¤rung akzeptieren');
      return;
    }
    editingData.datenschutz = true;
  }
  // Typ auswÃ¤hlen 
  if (step === 1) {
    if (!editingData.typ) {
      alert("Bitte einen Typ auswÃ¤hlen.");
      return false;
    }
  }
  // Name
  if (step === 2) {
    const v = document.getElementById('nameInput')?.value?.trim();
    if (!v) {
      alert('Bitte Namen eingeben');
      return;
    }
    editingData.name = v;
  }
  // SitzplÃ¤tze
  if (step === 3) {
      if (!editingData.sitzplaetze) {
          alert('Bitte auswÃ¤hlen, ob es SitzplÃ¤tze gibt.');
          return false;
      }
  }
  // Strom
  if (step === 4) {
      if (!editingData.strom) {
          alert('Bitte auswÃ¤hlen, ob es Strom gibt.');
          return false;
      }
  }
  // Ã–ffnungszeiten (KORREKTUR: Neue Logik)
  if (step === 5) {
    const immer = document.getElementById("immerCheck")?.checked;
    // Der Editor nutzt "newEntry" als ID
    const rawOeff = immer ? "Immer geÃ¶ffnet" : collectOpeningHours('newEntry'); 
    const normalized = normalizeOpeningHours(rawOeff); // Neue Normalisierungsfunktion

    // PrÃ¼fung, ob Ã–ffnungszeiten entweder "Immer geÃ¶ffnet" sind oder mindestens ein Tag definiert wurde
    if (normalized !== "Immer geÃ¶ffnet" && Array.isArray(normalized) && normalized.length === 0) {
      alert("Bitte Ã–ffnungszeiten angeben oder 'Immer geÃ¶ffnet' auswÃ¤hlen.");
      return false;
    }
    editingData.oeffnungszeiten = normalized;
    // Neues Feld speichern
    editingData.abweichendeZeiten = document.getElementById('abweichendeZeiten')?.value?.trim(); 
  }
  // Extras
  if (step === 6) {
    editingData.extras = document.getElementById('extrasInput')?.value?.trim();
  } 
  // Tiere (wird on-click gespeichert, hier nur Leerzeichen prÃ¼fen)
  if (step === 7) { 
      if (!editingData.tiere || editingData.tiere.length === 0) {
          alert("Bitte wÃ¤hle mindestens eine Tierart aus oder wÃ¤hle 'Keine Tiere'.");
          return false;
      }
  } 
  // Tags
  if (step === 9) {
    const raw = document.getElementById('tagsInput')?.value || '';
    editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
  }
  
  // Navigation
  if (step < stepsCount - 1) step++;
  renderQuestion();
  updateProgress();
} 

function prevStep() { if (step > 0) step--; renderQuestion(); updateProgress(); }
function startNewEntry() {
  if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
  editingData = {}; step = 0; mode = "entry";
  document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";
  setActive('btnNewEntry'); // Sidebar-Button hervorheben
  renderQuestion(); toggleSidebar(); updateProgress();
}


// ==========================================================
// ğŸ”§ Korrektur: normalizeOpeningHours fÃ¼r saubere Firestore-Daten
// ==========================================================
function normalizeOpeningHours(rawOeff) {
  if (typeof rawOeff === "string" && rawOeff.includes("Immer")) {
    return "Immer geÃ¶ffnet";
  }
  // Wenn es aus dem dynamischen Editor (object) kommt, in Array umwandeln
  if (typeof rawOeff === "object" && rawOeff !== null && !Array.isArray(rawOeff)) {
    const arr = [];
    // DAY_LABELS ist global definiert
    DAY_LABELS.forEach(day => {
      const d = rawOeff[day.key] || {};
      if (d.open && d.from && d.to) {
        // Beispiel: { tag: "mo", von: "09:00", bis: "18:00" }
        arr.push({
          tag: day.key, 
          von: d.from,
          bis: d.to
        });
      }
    });
    return arr;
  }
  // Fall: Es ist bereits ein Array (z.B. beim Bearbeiten alter Daten)
  if (Array.isArray(rawOeff)) {
      return rawOeff.filter(o => o.von && o.bis);
  }
  return [];
}


// ==========================================================
// ğŸª„ KI-Beschreibung und Quill Editor (Schritt 8)
// ==========================================================
let quillInstance;

function initEnhancedEditor(containerId, data) {
    quillInstance = new Quill(`#${containerId}`, {
        // Vereinfachte Toolbar fÃ¼r Fokus auf Text
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link']
            ]
        },
        theme: 'snow',
        placeholder: 'Beschreibe deine Eintragung hier...'
    });

    // Vorhandenen Inhalt laden
    if (data.beschreibung) {
        // Quill erwartet HTML
        quillInstance.root.innerHTML = data.beschreibung;
    }
    
    // Inhalt bei Ã„nderung in editingData speichern
    quillInstance.on('text-change', () => {
        // Speichere den HTML-Inhalt
        data.beschreibung = quillInstance.root.innerHTML;
    });

    // KI-Button binden
    const kiBtn = document.getElementById('generateDescBtn');
    if (kiBtn) {
        kiBtn.onclick = () => generateKiDescription(data);
    }
}

/**
 * Simuliert einen KI-Aufruf zur Generierung einer Beschreibung.
 */
async function generateKiDescription(data) {
    if (!data.name || !data.typ) {
        alert("Bitte gib zuerst den Typ und den Namen deiner Eintragung an.");
        return;
    }
    showToast("ğŸ§  KI generiert Beschreibung... (Moment)");
    
    // --- DEMO / PLACEHOLDER: Generiere Text basierend auf den Eingaben ---
    await new Promise(resolve => setTimeout(resolve, 2000)); 
    
    const sitzText = data.sitzplaetze === 'Ja' ? 'Mit bequemen SitzplÃ¤tzen ist dies der ideale Ort fÃ¼r eine genÃ¼ssliche Rast.' : 'Ein schneller und unkomplizierter Stopp fÃ¼r Radfahrer.';
    const extrasText = data.extras ? `Besonders hervorzuheben sind unsere tollen Extras wie: ${data.extras}.` : '';
    const tiereText = Array.isArray(data.tiere) && data.tiere.length && data.tiere[0] !== 'Keine Tiere' ? `Auf unserem Hof triffst du auch auf freundliche Tiere, darunter: ${data.tiere.join(', ')}.` : '';

    const kiText = `<p>Herzlich willkommen bei <strong>${data.name}</strong>! Unsere charmante ${data.typ} liegt direkt am beliebten Radweg und lÃ¤dt zum Verweilen ein. ${sitzText} ${extrasText}</p><p>${tiereText}</p><p>Wir freuen uns auf deinen Besuch!</p>`;

    // Setze den Text in Quill
    if (quillInstance) {
        quillInstance.root.innerHTML = kiText.trim();
        data.beschreibung = kiText.trim();
    }
    showToast("âœ… KI-Beschreibung geladen!");
}

// ==========================================================
// ğŸ’³ Premium / Stripe Checkout Funktion (Frontend-Teil)
// ==========================================================
async function showPremiumUpgrade() {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <section class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-extrabold text-green-700 mb-4">ğŸŒŸ Premium freischalten</h2>
      <p class="text-gray-600 mb-6">
        UnterstÃ¼tze die RadlMap-Entwicklung und schalte erweiterte Funktionen frei (Statistiken, Live-Events, mehr Fotos).
      </p>

      <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
        <p class="font-semibold text-yellow-800">Abonnement: 2,00 â‚¬ pro Monat</p>
        <p class="text-sm text-gray-700">Wird jÃ¤hrlich abgerechnet (24,00 â‚¬).</p>
      </div>
      
      <button 
        id="checkoutBtn"
        class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition active:scale-[0.98]"
      >
        Bezahlen mit Stripe (Demo)
      </button>

      <p class="text-xs text-gray-400 mt-4 text-center">
        Sichere Zahlung Ã¼ber Stripe. Du kannst jederzeit kÃ¼ndigen.
      </p>
    </section>
  `;
    
  // Checkout-Logik an den Button binden
  document.getElementById("checkoutBtn").addEventListener("click", async () => {
    showToast("â³ Weiterleitung zu Stripe (Demo-Modus)...");

    // In einer echten Anwendung mÃ¼sste dies ein Backend-Aufruf sein:
    // const response = await fetch('/create-checkout-session', { method: 'POST' });
    // const session = await response.json();
    const sessionId = "cs_test_b15p7n...etc"; // Placeholder-ID

    if (window.stripe) {
        const { error } = await stripe.redirectToCheckout({
            sessionId: sessionId,
        });

        if (error) {
            console.error("Stripe Error:", error);
            alert("Fehler beim Checkout: " + error.message);
        }
    } else {
        alert("Stripe-Skript nicht geladen. Bitte prÃ¼fen Sie die <script>-Tags im Head.");
    }
  });

  updateInfoBox();
}

async function cancelPremium() {
    const user = firebase.auth().currentUser;
    if (!user) return alert("Bitte einloggen.");
    if (!confirm("MÃ¶chtest du dein Premium wirklich kÃ¼ndigen?")) return;
    try {
        // Aktualisiere das Betreiber-Dokument
        await db.collection("betreiber").doc(user.uid).update({ 
            premium: false, 
            premium_until: null,
            // Hier mÃ¼ssten auch alle Stripe-Subscription-Endpunkte aufgerufen werden
        });
        showToast("âŒ Premium wurde beendet. (Demo-Update)");
        showDashboard(); // Dashboard neu laden
    } catch(e) {
        alert("Fehler beim KÃ¼ndigen des Premiums: " + e.message);
    }
}

// Erweiterte Premium-Statistik (Diagramm)
async function showPremiumStatsChart(user) { 
    const container = document.getElementById("premiumArea");
    if (!container) return;

    // Diagramm-Container
    const chartBox = document.createElement("div");
    chartBox.className = "bg-white p-4 rounded-xl shadow mt-6";
    chartBox.innerHTML = `
        <h3 class="text-lg font-bold mb-2 text-green-700">ğŸ“ˆ Aufrufe der letzten 7 Tage</h3>
        <canvas id="viewsChart" height="150"></canvas>
    `;
    container.appendChild(chartBox);

    const statsMap = new Map();
    const now = new Date();
    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        statsMap.set(d.toLocaleDateString("de-DE"), 0);
    }

    // Simulierte Daten
    const labels = Array.from(statsMap.keys());
    const values = labels.map((_, i) => Math.floor(Math.random() * 50) + (i * 10)); // Simulierter Anstieg

    const ctx = document.getElementById("viewsChart")?.getContext("2d");
    if (!ctx) return;
    
    new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Seitenaufrufe",
                data: values,
                fill: true,
                borderColor: "#10b981",
                backgroundColor: "rgba(16,185,129,0.2)",
                tension: 0.3
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false } },
                y: { beginAtZero: true, ticks: { stepSize: 20 } }
            }
        }
    });
}

// Foto/Eintrag Limits anzeigen
async function showLimitsSection(user, isPremium) {
    const limitsArea = document.getElementById("limitsArea");
    if (!limitsArea) return;
    
    const entriesSnap = await db.collection("eierhuetten")
        .where("userId", "==", user.uid)
        .get();
    const count = entriesSnap.size;
    const limit = isPremium ? 999 : 1; // Free: 1 Eintrag, Premium: praktisch unbegrenzt
    const pct = Math.min((count / limit) * 100, 100).toFixed(0);

    // Section erstellen
    limitsArea.innerHTML = ""; // Clear existing content
    const box = document.createElement("div");
    box.className = "bg-white p-4 rounded-xl shadow mb-6";
    
    if (isPremium) {
        box.innerHTML = `
            <h3 class="text-lg font-bold text-green-700 mb-2">ğŸ”“ Premium-Vorteile</h3>
            <p class="text-gray-600 mb-3">Du kannst unbegrenzt HÃ¼tten hinzufÃ¼gen und bis zu 10 Fotos pro HÃ¼tte hochladen.</p>
            <div class="w-full bg-green-100 h-3 rounded"><div class="h-3 bg-green-500 rounded w-full"></div></div>
            <p class="text-sm text-green-700 mt-2 font-semibold">âœ”ï¸ Keine Limits aktiv</p>
        `;
    } else {
        box.innerHTML = `
            <h3 class="text-lg font-bold text-gray-800 mb-2">âš™ï¸ Dein aktueller Fortschritt</h3>
            <p class="text-gray-600 mb-3">Du hast <b>${count}</b> von <b>${limit}</b> mÃ¶glichen EintrÃ¤gen erstellt.</p>
            <div class="w-full bg-gray-200 h-3 rounded"><div class="h-3 bg-green-500 rounded" style="width:${pct}%;"></div></div>
            <p class="text-sm text-gray-600 mt-2">${pct}% deines Limits erreicht</p>
            ${count >= limit ? `
            <div class="mt-4 text-center">
                <p class="text-red-600 text-sm mb-2">ğŸš« Du hast dein Limit erreicht.</p>
                <button class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition" onclick="showPremiumUpgrade()">ğŸŒŸ Jetzt auf Premium upgraden</button>
            </div>` : ""}
        `;
    }
    limitsArea.appendChild(box);
}

// ==========================================================
// ğŸ’¬ Support-Center mit Ticket-Funktion
// ==========================================================
async function openSupport() {
  if (!currentUser || !currentUser.uid) {
    showToast("Bitte zuerst einloggen");
    return;
  }
  
  const qa = document.getElementById("question-area");
  mode = "support";
  
  qa.innerHTML = `
    <section class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-extrabold text-green-700 mb-4">ğŸ’¬ Support-Center</h2>
      <p class="text-gray-600 mb-6">
        Melde ein Problem oder stelle eine Frage. Dein Ticket wird direkt an unser Team gesendet.
      </p>

      <div class="space-y-4">
        <label class="block">
          <span class="text-gray-700">Betreff</span>
          <input id="supportSubject" class="w-full border rounded p-2 mt-1" placeholder="z.B. Problem beim Foto-Upload">
        </label>
        
        <label class="block">
          <span class="text-gray-700">Nachricht</span>
          <textarea id="supportMessage" class="w-full border rounded p-2 mt-1" rows="5" placeholder="Beschreibe dein Anliegen so detailliert wie mÃ¶glich."></textarea>
        </label>
        
        <button 
          id="sendSupportBtn"
          class="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition"
          onclick="sendSupportTicket()"
        >
          Ticket senden
        </button>
      </div>

      <div id="myTicketsArea" class="mt-8 border-t pt-4">
        <h3 class="font-bold text-lg mb-3">Deine letzten Tickets</h3>
        <div id="ticketList" class="text-sm text-gray-500">
          â³ Lade Tickets...
        </div>
      </div>

    </section>
  `;
  
  updateInfoBox();
  loadMySupportTickets();
}

async function sendSupportTicket() {
    const subject = document.getElementById("supportSubject")?.value.trim();
    const message = document.getElementById("supportMessage")?.value.trim();
    
    if (!subject || !message) {
        alert("Bitte Betreff und Nachricht ausfÃ¼llen.");
        return;
    }
    
    try {
        await db.collection("supportTickets").add({
            userId: currentUser.uid,
            email: currentUser.email,
            subject: subject,
            message: message,
            status: "offen",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast("âœ… Support-Ticket gesendet!");
        document.getElementById("supportSubject").value = "";
        document.getElementById("supportMessage").value = "";
        loadMySupportTickets(); // Liste aktualisieren
    } catch (e) {
        console.error("Support Ticket Error", e);
        alert("âŒ Fehler beim Senden des Tickets: " + e.message);
    }
}

async function loadMySupportTickets() {
    const listEl = document.getElementById("ticketList");
    if (!listEl) return;
    
    try {
        const snap = await db.collection("supportTickets")
            .where("userId", "==", currentUser.uid)
            .orderBy("createdAt", "desc")
            .limit(5)
            .get();
        
        if (snap.empty) {
            listEl.innerHTML = "<p>Du hast noch keine Tickets gesendet.</p>";
            return;
        }
        
        listEl.innerHTML = snap.docs.map(doc => {
            const data = doc.data();
            const date = data.createdAt?.toDate().toLocaleDateString("de-DE") || "Datum unbekannt";
            let statusBadge = "bg-yellow-100 text-yellow-800";
            if (data.status === "beantwortet") statusBadge = "bg-green-100 text-green-800";
            
            return `
                <div class="flex justify-between items-center py-2 border-b">
                    <div>
                        <p class="font-semibold">${data.subject}</p>
                        <p class="text-xs text-gray-400">Erstellt am: ${date}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${statusBadge}">${data.status}</span>
                </div>
            `;
        }).join("");
        
    } catch (e) {
        listEl.innerHTML = "<p class='text-red-500'>Fehler beim Laden der Tickets.</p>";
    }
}

// ==========================================================
// ğŸ—“ï¸ Events-Funktionen (einfache Version)
// ==========================================================

async function showMyEvents() {
    if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
    const qa = document.getElementById("question-area");
    mode = "events";
    qa.innerHTML = `
        <section class="bg-white p-8 rounded-2xl shadow-xl max-w-3xl mx-auto animate-fadeIn">
            <h2 class="text-2xl font-extrabold text-green-700 mb-4">ğŸ“… Meine Events</h2>
            <p class="text-gray-600 mb-6">
                Verwalte deine geplanten Events. Nur Premium-Nutzer kÃ¶nnen Events anlegen.
            </p>
            <div id="eventList" class="space-y-4">
                <div class="text-gray-500">â³ Lade Events...</div>
            </div>
            <button class="mt-6 px-4 py-2 bg-green-600 text-white rounded-lg" onclick="showCreateEvent()">
                â• Neues Event erstellen
            </button>
        </section>
    `;
    updateInfoBox();
    
    // Einfache Ladelogik
    try {
        const huettenSnap = await db.collection("eierhuetten").where("userId", "==", currentUser.uid).get();
        const hutIds = huettenSnap.docs.map(d => d.id);
        
        let allEvents = [];
        for (const hutId of hutIds) {
            // Firestore Sub-Collection Abfrage
            const eventSnap = await db.collection("eierhuetten").doc(hutId).collection("events").get();
            eventSnap.forEach(doc => {
                const hut = huettenSnap.docs.find(d => d.id === hutId);
                allEvents.push({ 
                    id: doc.id, 
                    hutId, 
                    hutName: hut?.data().name || 'Unbekannte HÃ¼tte', 
                    ...doc.data() 
                });
            });
        }
        
        allEvents.sort((a, b) => (b.startDate?.toMillis() || 0) - (a.startDate?.toMillis() || 0));
        
        const listEl = document.getElementById("eventList");
        if (allEvents.length === 0) {
            listEl.innerHTML = "<p>Du hast noch keine Events erstellt.</p>";
            return;
        }
        
        listEl.innerHTML = allEvents.map(e => {
            const start = e.startDate?.toDate()?.toLocaleDateString("de-DE") || "Datum unbekannt";
            const end = e.endDate?.toDate()?.toLocaleDateString("de-DE") || "Datum unbekannt";
            return `
                <div class="border p-4 rounded-lg bg-gray-50">
                    <p class="font-bold text-lg">${e.title}</p>
                    <p class="text-sm text-green-700">ğŸ“ ${e.hutName}</p>
                    <p class="text-sm text-gray-500 mb-2">ğŸ—“ï¸ ${start} bis ${end}</p>
                    <p class="text-sm">${e.desc.substring(0, 100)}...</p>
                    <button class="text-red-500 text-xs mt-2 hover:underline" onclick="deleteEvent('${e.hutId}', '${e.id}')">LÃ¶schen</button>
                </div>
            `;
        }).join("");
        
    } catch(e) {
        document.getElementById("eventList").innerHTML = `<p class="text-red-500">Fehler beim Laden der Events: ${e.message}</p>`;
    }
}

async function showCreateEvent() {
    if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
    
    // Premium-Check (Demo)
    const betreiberDoc = await db.collection("betreiber").doc(currentUser.uid).get();
    if (!(betreiberDoc.data()?.premium)) {
        alert("Event-Erstellung ist eine Premium-Funktion. Bitte schalten Sie Premium frei.");
        showPremiumUpgrade();
        return;
    }

    const qa = document.getElementById("question-area");
    mode = "createEvent";
    
    // Lade HÃ¼tten-Namen fÃ¼r die Auswahl
    let hutOptions = '<option value="">--- HÃ¼tte auswÃ¤hlen ---</option>';
    try {
        const huettenSnap = await db.collection("eierhuetten")
            .where("userId", "==", currentUser.uid)
            .get();
        
        hutOptions += huettenSnap.docs.map(doc => {
            const data = doc.data();
            return `<option value="${doc.id}">${data.name} (${data.typ})</option>`;
        }).join("");
    } catch (e) {
        hutOptions = '<option value="">Fehler beim Laden der HÃ¼tten</option>';
    }

    qa.innerHTML = `
        <section class="bg-white p-8 rounded-2xl shadow-xl max-w-2xl mx-auto animate-fadeIn">
            <h2 class="text-2xl font-extrabold text-green-700 mb-4">â• Neues Event erstellen</h2>
            
            <form id="eventForm" class="space-y-4">
                <label class="block">
                    <span class="text-gray-700">Event-HÃ¼tte</span>
                    <select id="eventHut" class="w-full p-2 border rounded mt-1" required>
                        ${hutOptions}
                    </select>
                </label>
                
                <label class="block">
                    <span class="text-gray-700">Titel</span>
                    <input id="eventTitle" class="w-full p-2 border rounded mt-1" placeholder="z.B. Hoffest mit Live-Musik" required>
                </label>
                
                <label class="block">
                    <span class="text-gray-700">Beschreibung (max. 200 Zeichen)</span>
                    <textarea id="eventDesc" class="w-full p-2 border rounded mt-1" rows="3" placeholder="z.B. Leckeres Essen, Musik, Grill & GetrÃ¤nken" maxlength="200" required></textarea>
                </label>
                
                <div class="grid grid-cols-2 gap-3">
                    <label>
                        <span class="text-sm text-gray-600">Startdatum</span>
                        <input id="eventStart" type="date" class="w-full p-2 border rounded" required>
                    </label>
                    <label>
                        <span class="text-sm text-gray-600">Enddatum</span>
                        <input id="eventEnd" type="date" class="w-full p-2 border rounded" required>
                    </label>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700 transition font-semibold">
                    âœ… Event speichern
                </button>
            </form>
            
            <button class="mt-4 text-sm text-gray-500 hover:text-gray-700" onclick="showMyEvents()">
                â¬…ï¸ Zur Event-Liste
            </button>
        </section>
    `;

    document.getElementById("eventForm").addEventListener("submit", submitEvent);
    updateInfoBox();
}

async function submitEvent(e) {
    e.preventDefault();
    const hutId = document.getElementById("eventHut").value;
    const title = document.getElementById("eventTitle").value.trim();
    const desc = document.getElementById("eventDesc").value.trim();
    const startValue = document.getElementById("eventStart").value;
    const endValue = document.getElementById("eventEnd").value;
    
    if (!hutId) { showToast("âŒ Bitte eine HÃ¼tte auswÃ¤hlen!"); return; }
    if (!startValue || !endValue) { showToast("âŒ Bitte Start- und Enddatum festlegen!"); return; }
    
    const start = new Date(startValue);
    const end = new Date(endValue);
    
    if (end < start) {
        showToast("âŒ Enddatum muss am oder nach dem Startdatum liegen!");
        return;
    }
    
    try {
        await db.collection("eierhuetten").doc(hutId).collection("events").add({
            title, 
            desc, 
            startDate: firebase.firestore.Timestamp.fromDate(start),
            endDate: firebase.firestore.Timestamp.fromDate(end),
            ownerUid: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast("âœ… Event erfolgreich gespeichert!");
        showMyEvents(); // ZurÃ¼ck zur Liste
    } catch (error) {
        console.error("Event save error:", error);
        showToast("âŒ Fehler beim Speichern des Events: " + error.message);
    }
}

async function deleteEvent(hutId, eventId) {
    if (!confirm("Soll dieses Event wirklich gelÃ¶scht werden?")) return;
    try {
        await db.collection("eierhuetten").doc(hutId).collection("events").doc(eventId).delete();
        showToast("âœ… Event gelÃ¶scht.");
        showMyEvents();
    } catch (e) {
        console.error("Delete event error:", e);
        showToast("âŒ Fehler beim LÃ¶schen.");
    }
}

// ==========================================================
// â„¹ï¸ Info-Box und Tutorial
// ==========================================================
function updateInfoBox() {
    let content = '';
    const isEditing = mode === 'entry';
    const isList = mode === 'list';
    
    if (mode === 'dashboard') {
        content = `
            <p class="font-bold">Dashboard-Ansicht</p>
            <p>Hier siehst du Statistiken und deinen aktuellen Premium-Status. Als UnterstÃ¼tzer (Premium) schaltest du alle Limits frei und erhÃ¤ltst erweiterte Analysen.</p>
        `;
    } else if (mode === 'events') {
         content = `
            <p class="font-bold">Event-Verwaltung</p>
            <p>Erstelle Events (z.B. Hoffeste, Grillabende), die auf deiner HÃ¼tte auf der RadlMap angezeigt werden. Das ist eine Premium-Funktion.</p>
        `;
    } else if (mode === 'support') {
         content = `
            <p class="font-bold">Support</p>
            <p>Wenn du Fragen hast oder ein Problem melden mÃ¶chtest, kannst du hier ein Ticket an das RadlMap-Team senden.</p>
        `;
    } else if (isList) {
        content = `
            <p class="font-bold">Meine Eintragungen</p>
            <p>Eine Ãœbersicht deiner bestehenden HÃ¼tten und LÃ¤den. Klicke auf "Bearbeiten", um Ã„nderungen vorzunehmen, oder "Status", um die Freigabe zu prÃ¼fen.</p>
        `;
    } else if (isEditing) {
        if (step === 0) content = `<p class="font-bold">Datenschutz</p><p>Bitte lies die DatenschutzerklÃ¤rung vollstÃ¤ndig durch. Das ist notwendig, um die Ãœbertragung deiner Daten an unsere Datenbank zu ermÃ¶glichen.</p>`;
        else if (step === 1) content = `<p class="font-bold">Typ wÃ¤hlen</p><p>WÃ¤hle den Typ deiner Eintragung. Dies bestimmt, welches Icon auf der Karte angezeigt wird.</p>`;
        else if (step === 2) content = `<p class="font-bold">Name</p><p>Ein aussagekrÃ¤ftiger Name hilft Radlern, deine HÃ¼tte oder deinen Laden schnell zu finden.</p>`;
        else if (step === 5) content = `<p class="font-bold">Ã–ffnungszeiten korrigieren</p><p>Definiere prÃ¤zise Zeiten fÃ¼r jeden Wochentag oder wÃ¤hle "Immer geÃ¶ffnet". Dies ist wichtig fÃ¼r die Filterfunktion der Karte.</p>`;
        else if (step === 8) content = `<p class="font-bold">Beschreibung</p><p>Hier kannst du eine ausfÃ¼hrliche Beschreibung deiner Angebote, Besonderheiten und des Ambientes geben. Nutze den <span class="text-blue-600 font-semibold">KI-Button</span>, um schnell einen Entwurf zu generieren!</p>`;
        else if (step === 10) content = `<p class="font-bold">Standort & Einreichen</p><p>Setze den Pin an die exakte Position deiner HÃ¼tte/deines Ladens. Nach dem Einreichen wird deine Eintragung von uns geprÃ¼ft, bevor sie auf der Karte erscheint.</p>`;
        else content = `<p class="font-bold">Hinweis (Schritt ${step})</p><p>FÃ¼lle das Feld so genau wie mÃ¶glich aus. UnvollstÃ¤ndige EintrÃ¤ge werden langsamer freigegeben.</p>`;
    } else {
        content = `<p class="font-bold">Willkommen!</p><p>WÃ¤hle im MenÃ¼ links eine Option, um zu starten.</p>`;
    }
    
    document.getElementById('infoBox').innerHTML = content;
    document.getElementById('infoBoxMobile').innerHTML = content;
}

function showTutorial() {
    mode = 'tutorial';
    document.getElementById("navBottom").style.display = 'none';
    const qa = document.getElementById("question-area");
    qa.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-green-700">Willkommen beim Assistenten!</h2>
            <p class="mb-4 text-gray-700">Dieser Assistent hilft dir, deine <span class="font-semibold">EierhÃ¼tte, Hofladen oder Attraktion</span> schnell und korrekt auf der RadlMap einzutragen.</p>
            
            <h3 class="text-xl font-bold mt-6 mb-2">So funktioniert's:</h3>
            <ul class="list-disc list-inside space-y-2 text-gray-600 ml-4">
                <li><span class="font-semibold">1. Anmeldung:</span> Du bist erfolgreich mit deinem Google-Konto eingeloggt.</li>
                <li><span class="font-semibold">2. Daten eingeben:</span> Ãœber den Punkt "â• Neue Eintragung" im MenÃ¼ startest du den 11-Schritte-Prozess.</li>
                <li><span class="font-semibold">3. Dashboard:</span> Im "ğŸ“Š Betreiber-Dashboard" siehst du deine Statistiken und deinen Premium-Status.</li>
                <li><span class="font-semibold">4. Wichtig:</span> Alle neuen EintrÃ¤ge werden vor der VerÃ¶ffentlichung geprÃ¼ft.</li>
            </ul>
            
            <button class="mt-8 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition" onclick="showDashboard(); setActive('btnDashboard');">
                Zum Dashboard starten
            </button>
        </div>
    `;
    updateInfoBox();
}

// ==========================================================
// ğŸ“‹ Meine Eintragungen / Bearbeiten
// ==========================================================

async function showMyEntries() {
    if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
    mode = 'list';
    document.getElementById("navBottom").style.display = 'none';
    const qa = document.getElementById("question-area");
    qa.innerHTML = `
        <section class="bg-white p-6 rounded-xl shadow-xl max-w-4xl mx-auto animate-fadeIn">
            <h2 class="text-2xl font-bold text-green-700 mb-6">ğŸ“‹ Deine Eintragungen</h2>
            <div id="entriesList" class="space-y-4">
                <p class="text-gray-500">â³ Lade Eintragungen...</p>
            </div>
        </section>
    `;
    updateInfoBox();

    try {
        const snapshot = await db.collection("eierhuetten")
            .where("userId", "==", currentUser.uid)
            .orderBy("createdAt", "desc")
            .get();

        const listEl = document.getElementById('entriesList');
        if (snapshot.empty) {
            listEl.innerHTML = `
                <div class="p-4 bg-gray-50 rounded text-center">
                    <p class="font-semibold">Du hast noch keine Eintragungen erstellt.</p>
                    <button class="mt-3 px-4 py-2 bg-blue-500 text-white rounded" onclick="startNewEntry()">Jetzt starten!</button>
                </div>
            `;
            return;
        }

        listEl.innerHTML = snapshot.docs.map(doc => {
            const data = doc.data();
            const status = data.active ? 'âœ… Aktiv' : 'â³ In PrÃ¼fung';
            const statusColor = data.active ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            const views = data.views || 0;

            return `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-4 border rounded-lg bg-gray-50 hover:bg-white transition">
                    <div class="mb-3 md:mb-0">
                        <p class="font-bold text-lg">${data.name} (${data.typ})</p>
                        <p class="text-sm text-gray-500">${data.plz}, ${data.city}</p>
                        <p class="text-xs mt-1">ğŸ‘ï¸ ${views} Aufrufe</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 text-sm rounded-full ${statusColor}">${status}</span>
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600" onclick="showEditPage('${doc.id}')">Bearbeiten</button>
                    </div>
                </div>
            `;
        }).join('');

    } catch (e) {
        document.getElementById('entriesList').innerHTML = `<p class="text-red-500">Fehler beim Laden: ${e.message}</p>`;
    }
}

// Platzhalter-Funktionen (wie in deiner Originaldatei angenommen)
function showEditPage(id) {
    alert("Bearbeiten-Funktion fÃ¼r ID " + id + " wird gestartet. (Muss noch implementiert werden, nutzt aber die vorhandenen Eingabeschritte)");
    // Normalerweise wÃ¼rde hier die Funktion die Daten fÃ¼r die ID laden und step=1 rendern
    // const doc = await db.collection("eierhuetten").doc(id).get();
    // editingData = doc.data();
    // startNewEntry();
}
function showHutMessages() { 
    alert("HÃ¼tten-Nachrichten sind noch nicht implementiert.");
}
function initHutMessagesBadge() { /* ... */ }

// ==========================================================
// ğŸ—ºï¸ Kartenfunktionen (Leaflet)
// ==========================================================

let mapInstance;
let markerInstance;

function initOverviewMap(lat = 48.0, lon = 10.0, zoom = 7) {
    const mapContainer = document.getElementById('overview-map');
    if (!mapContainer) return;
    
    // Zuerst bestehende Karte entfernen
    if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
    }
    
    // Standard-Center verwenden, falls keine Daten vorhanden
    const startLat = editingData.lat || lat;
    const startLon = editingData.lon || lon;

    mapInstance = L.map(mapContainer).setView([startLat, startLon], zoom);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mapInstance);

    markerInstance = L.marker([startLat, startLon], { draggable: true }).addTo(mapInstance);
    
    markerInstance.on('dragend', function(e) {
        const newPos = markerInstance.getLatLng();
        editingData.lat = newPos.lat;
        editingData.lon = newPos.lng;
        // Optionale Reverse-Geocoding (zu aufwÃ¤ndig fÃ¼r Demo)
        // updateAddressFromCoordinates(newPos.lat, newPos.lng);
    });

    // Karte bei Bedarf neu zentrieren (wichtig, falls ContainergrÃ¶ÃŸe Ã¤ndert)
    setTimeout(() => { mapInstance.invalidateSize(); }, 300);
    
    // Initialdaten speichern
    editingData.lat = startLat;
    editingData.lon = startLon;
}

function locateGPS() {
    if (!navigator.geolocation) {
        alert("Geolocation wird von deinem Browser nicht unterstÃ¼tzt.");
        return;
    }
    
    showToast("ğŸ“¡ Suche Standort...");
    
    navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        editingData.lat = lat;
        editingData.lon = lon;
        
        if (mapInstance) {
            mapInstance.setView([lat, lon], 16);
            markerInstance.setLatLng([lat, lon]);
            showToast("âœ… Standort gefunden!");
        } else {
             // Initialisiere die Karte mit dem gefundenen Standort
            initOverviewMap(lat, lon, 16);
        }
        
    }, error => {
        console.error("Geolocation error:", error);
        alert("Standortbestimmung fehlgeschlagen. Bitte manuell eingeben.");
    });
}


// ==========================================================
// ğŸ’¾ Einreichung (submitEntry)
// ==========================================================

async function submitEntry() {
  if (!editingData.lat || !editingData.lon) {
    alert("Bitte wÃ¤hle zuerst einen Standort auf der Karte.");
    return;
  }
  
  showToast("â³ Eintrag wird eingereicht...");

  // Geocoding fÃ¼r Stadt & PLZ anhand der Koordinaten (Nominatim)
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${editingData.lat}&lon=${editingData.lon}&addressdetails=1`;
    const res = await fetch(url);
    const data = await res.json();
    
    editingData.plz = data.address.postcode || 'Unbekannt';
    editingData.city = data.address.city || data.address.town || data.address.village || 'Unbekannt';
  } catch (e) {
    console.warn("Reverse Geocoding fehlgeschlagen, setze PLZ/Stadt auf Unbekannt.", e);
    editingData.plz = '00000';
    editingData.city = 'Unbekannt';
  }
  
  // Finales Objekt fÃ¼r Firestore vorbereiten
  const finalEntry = {
    ...editingData,
    userId: currentUser.uid,
    userEmail: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    active: false, // Immer auf false setzen fÃ¼r manuelle Freigabe
    views: 0,
    routeStarts: 0,
    // LÃ¶sche temporÃ¤re Felder, die nicht in die DB sollen
    lat: new firebase.firestore.GeoPoint(editingData.lat, editingData.lon),
    lon: undefined, // GeoPoint nutzt nur lat/lon, wir lÃ¶schen lon
  };

  try {
    // Speichern in Firestore
    await db.collection("eierhuetten").add(finalEntry);
    
    showToast("ğŸ‰ Eintrag erfolgreich eingereicht! Er wird nun geprÃ¼ft.");
    editingData = {}; // Zustand zurÃ¼cksetzen
    showMyEntries(); // Zur Ãœbersicht wechseln
  } catch (e) {
    console.error("Firestore Save Error", e);
    alert("âŒ Fehler beim Speichern des Eintrags: " + e.message);
  }
}

// ==========================================================
// ğŸ–¼ï¸ Profil und Hilfsfunktionen
// ==========================================================

function setGoogleProfile(user) {
    const picEl = document.getElementById('profilePic');
    const initEl = document.getElementById('avatarInitials');
    if (user.photoURL) {
        picEl.src = user.photoURL;
        picEl.classList.remove('hidden');
        initEl.classList.add('hidden');
    } else if (user.displayName) {
        const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    }
}


// Initialer Aufruf
showTutorial();
// showDashboard(); // Kann man auch direkt starten

</script>
</body>
  </html>
