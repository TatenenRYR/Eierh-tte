<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent | Smarter Final</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap { height: 200px; z-index: 0; }
    .leaflet-container { z-index: 0 !important; }
    @media (max-width: 767px) { #question-area { padding-bottom: 92px; } }
    @media (min-width: 768px) { #question-area { padding-bottom: 92px; } }
    .sidebar-btn.active, .sidebar-btn.bg-green-100 {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }
    /* === Smarter Upload Style === */
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5; border-color: #10b981; transform: scale(1.01); }
    #smartUploadPreview img { transition: all 0.25s ease; }
    #smartUploadPreview img:hover { transform: scale(1.05); filter: brightness(1.1); }
    
    /* Statusfarben für MyEntries */
    .status-angenommen { background-color: #d1fae5; color: #065f46; border-left: 5px solid #10b981; }
    .status-offen { background-color: #fffbeb; color: #a16207; border-left: 5px solid #f59e0b; }
    .status-pausiert { background-color: #f3f4f6; color: #4b5563; border-left: 5px solid #9ca3af; }
    .status-abgelehnt { background-color: #fee2e2; color: #991b1b; border-left: 5px solid #ef4444; }
    
    /* KI Button Style */
    .ki-button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #4f46e5;
      color: white;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .ki-button:hover {
      background-color: #4338ca;
      transform: translateY(-1px);
    }
    .ki-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body class="bg-gray-100">
<script>window.stepInfos = window.stepInfos || [];</script>

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" 
           class="w-64 h-64 drop-shadow-lg" 
           alt="Funny Hut" />
    </div>

    <h1 class="text-3xl font-extrabold text-green-700 mb-3">
      Assistent-Dashboard
    </h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>

    <button onclick="doGoogleLogin()" 
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" 
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>

    <p class="text-xs text-gray-400 mt-6">
      🔒 Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.
    </p>
  </div>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

  <div class="flex flex-col items-center mb-8">
    <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
      <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
      <span id="avatarInitials"></span>
    </div>
    <p class="text-sm text-gray-600">Angemeldet als:</p>
    <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
    <button class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform text-sm" onclick="logout()">Logout</button>
  </div>

  <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
    🌿 Assistent
  </div>

  <nav class="flex flex-col gap-2 text-[15px]">
    <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      🚲 Startseite
    </a>
    <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      🚴‍♂️ zur RadlMap
    </a>

    <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">
      📊 Betreiber-Dashboard
    </button>
    <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">
      📋 Meine Eintragungen
    </button>
    <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">
      ➕ Neue Eintragung
    </button>

    <div class="mt-4">
      <div class="flex items-center justify-between px-3 mb-1">
        <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
      </div>

      <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
        <button id="btnMyEvents"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnMyEvents'); showToast('Funktion nicht implementiert')">
          📅 <span>Meine Events</span>
        </button>
        <button id="btnCreateEvent"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnCreateEvent'); showToast('Funktion nicht implementiert')">
          ➕ <span>Neues Event</span>
        </button>
      </div>
    </div>

    <hr class="my-3 border-gray-200">

    <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
      💌 Hütten-Nachrichten
      <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
    </button>
    <button id="btnSettings" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSettings'); showSettings()">
      ⚙️ Einstellungen
    </button>
  </nav>

  <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
    v2.3 &middot; Smarter Assistent
  </div>
</aside>
    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
  <div class="sticky top-4">
    <h3 class="text-lg font-bold mb-3">ℹ️ Hilfe & Beispiele</h3>
    <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
    <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">✕</button>
    <h3 class="text-lg font-bold mb-3">ℹ️ Hilfe & Beispiele</h3>
    <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg" onclick="document.getElementById('infoOverlay').classList.remove('hidden')">
  ℹ️
</button>
<script>
  document.getElementById('closeInfo')?.addEventListener('click', () => {
    document.getElementById('infoOverlay').classList.add('hidden');
  });
  function setActive(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('bg-green-100', 'font-semibold'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) {
      activeBtn.classList.add('bg-green-100', 'font-semibold');
    }
  }
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }
</script>

    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">☰</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">⬅️ Zurück</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter ➡️</button>
      </div>
    </main>
  </div>

  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c"; // Dummy Key

  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">❌ Firebase konnte nicht initialisiert werden. Prüfe die Konfiguration in der Datei.</div>`;
  }

  // Aktueller Nutzer
  let currentUser = null; 
  firebase.auth().onAuthStateChanged(u => {
    if (u) {
      currentUser = u;
      document.getElementById("accountMail").textContent = u.email;
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      document.getElementById('sidebar').classList.add('-translate-x-full'); // Sidebar geschlossen halten (Mobile)
      mode = "list";
      document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";
      showTutorial();
      // initHutMessagesBadge(); // Nicht implementiert, aber Teil des Designs
      setGoogleProfile(u);
    } else {
      document.getElementById("mainApp").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
    }
  });

  async function doGoogleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await firebase.auth().signInWithPopup(provider);
      showToast("✅ Eingeloggt mit Google");
    } catch (e) {
      console.error("Google Login error", e);
      alert("Fehler beim Google-Login: " + e.message);
    }
  }

  function logout() {
    firebase.auth().signOut();
  }
  
  function setGoogleProfile(user) {
    const picEl = document.getElementById('profilePic');
    const initEl = document.getElementById('avatarInitials');
    if (user.photoURL) {
        picEl.src = user.photoURL;
        picEl.classList.remove('hidden');
        initEl.classList.add('hidden');
    } else if (user.displayName) {
        const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    } else {
        const initials = user.email ? user.email[0].toUpperCase() : '?';
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    }
  }
    
  let mode = "entry"; 
  let editingData = { photos: [] }; 
  let step = 0;
  const stepsCount = 12; // 0..11 (12 Schritte)
  
  // Quill Editor Instanz
  let quill;
  function initQuill(containerId, initialContent = '') {
      quill = new Quill('#' + containerId, {
          theme: 'snow',
          placeholder: 'Beschreibe deine Hütte, deinen Hof oder deinen Spielplatz...',
          modules: {
              toolbar: [
                  ['bold', 'italic', 'underline', 'strike'],
                  [{ 'header': 1 }, { 'header': 2 }],
                  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                  [{ 'indent': '-1'}, { 'indent': '+1' }],
                  [{ 'size': ['small', false, 'large', 'huge'] }],
                  [{ 'color': [] }, { 'background': [] }],
                  ['link', 'clean']
              ]
          }
      });
      quill.root.innerHTML = initialContent;
  }

  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden', 'bg-red-600', 'bg-blue-600');
    t.classList.add(text.startsWith("❌") ? "bg-red-600" : "bg-blue-600");
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  // Hilfsfunktion zum Hochladen von Dateien
  async function uploadFileWithProgress(file, onProgress) {
      if (window.imageProvider === 'firebase') {
          // Firebase Storage Upload
          const storageRef = firebase.storage().ref();
          const fileRef = storageRef.child(`uploads/${currentUser.uid}/${Date.now()}-${file.name}`);
          const uploadTask = fileRef.put(file);

          return new Promise((resolve, reject) => {
              uploadTask.on('state_changed', 
                  (snapshot) => {
                      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                      onProgress(Math.round(progress));
                  }, 
                  (error) => {
                      reject(error);
                  }, 
                  () => {
                      uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                          resolve(downloadURL);
                      });
                  }
              );
          });
      } else {
          // ImgBB Upload (als Standard)
          const formData = new FormData();
          formData.append("image", file);

          const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
              method: "POST",
              body: formData,
          });
          const data = await res.json();
          if (data.success) {
              return data.data.url;
          } else {
              throw new Error("ImgBB Upload failed: " + data.error.message);
          }
      }
  }
  
  // ==========================================================
  // 🕒 Öffnungszeiten Editor (RadlMap-Style)
  // ==========================================================
  const DAY_LABELS = [
    { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" }, { key: "mi", label: "Mittwoch" },
    { key: "do", label: "Donnerstag" }, { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" }, { key: "so", label: "Sonntag" }
  ];

  function renderOpeningHoursEditor(hutId, data = {}) {
    let initialData = {};
    let immerGeoffnet = false;
    
    if (typeof data === "string" && data.includes("Immer geöffnet")) {
      immerGeoffnet = true;
    } else if (Array.isArray(data)) {
      data.forEach(d => {
        initialData[d.tag.toLowerCase()] = { open: true, from: d.von, to: d.bis };
      });
    } else if (typeof data === "object") {
      initialData = data;
    }
    
    let html = `
      <div id="openhours-editor-wrapper" class="space-y-2 mt-2">
        <label class="flex items-center gap-2 mb-4">
          <input type="checkbox" id="immerCheck" ${immerGeoffnet ? "checked" : ""}>
          Immer geöffnet (24/7)
        </label>

        <div id="dayInputs" class="${immerGeoffnet ? "hidden" : ""}">
          <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
            <thead class="bg-green-100 text-green-800">
              <tr>
                <th class="py-2 px-3 text-left">Tag</th>
                <th class="py-2 px-3 text-center">Geöffnet</th>
                <th class="py-2 px-3 text-center">Von</th>
                <th class="py-2 px-3 text-center">Bis</th>
              </tr>
            </thead>
            <tbody class="divide-y">
      `;

    DAY_LABELS.forEach(day => {
      const d = initialData[day.key] || {};
      const open = !!d.open || (!!d.from && !!d.to);
      const from = d.from || "";
      const to = d.to || "";
      html += `
          <tr>
            <td class="py-2 px-3">${day.label}</td>
            <td class="text-center">
              <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
            </td>
            <td class="text-center">
              <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
            </td>
            <td class="text-center">
              <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
            </td>
          </tr>
      `;
    });
    html += `</tbody></table></div><p class="text-xs text-gray-500">Tipp: Wenn du nichts einträgst, wird "geschlossen" angezeigt.</p></div>`;
    return html;
  }

  function collectOpeningHours() {
    const immer = document.getElementById("immerCheck")?.checked;
    if (immer) { return "Immer geöffnet"; }
    
    const wrapper = document.getElementById(`openhours-editor-wrapper`);
    if (!wrapper) return [];

    const result = [];
    DAY_LABELS.forEach(day => {
      const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
      const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
      const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
      
      const open = openCheckbox?.checked;
      const from = open ? fromInput?.value : "";
      const to = open ? toInput?.value : "";
      
      if (open && from && to) {
        result.push({ tag: day.key.toUpperCase(), von: from, bis: to });
      }
    });
    return result;
  }

  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("oh-open")) {
      const row = e.target.closest("tr");
      const from = row.querySelector(".oh-from");
      const to = row.querySelector(".oh-to");
      const isOpen = e.target.checked;
      if(from) from.disabled = !isOpen;
      if(to) to.disabled = !isOpen;
      if (!isOpen) { if(from) from.value = ""; if(to) to.value = ""; }
    } else if (e.target.id === "immerCheck") {
        document.getElementById("dayInputs")?.classList.toggle("hidden", e.target.checked);
    }
  });

  // ==========================================================
  // 🧠 KI-Logik (Dummy-Implementierung)
  // ==========================================================
  let isAIGenerating = false;
  
  /**
   * Generiert eine Beschreibung basierend auf den bisherigen Daten.
   */
  async function generateAIPrompt() {
    if (isAIGenerating) return;
    
    // Daten sammeln
    const name = editingData.name || 'unserer Hütte';
    const type = editingData.typ || 'Eierhütte';
    const extras = editingData.extras || 'frische Eier, Marmelade';
    const tiere = (editingData.tiere && editingData.tiere.length > 0) ? `Tiere vor Ort: ${editingData.tiere.join(', ')}.` : 'Keine Tiere.';
    
    // Einfacher Prompt
    const prompt = `Schreibe eine einladende, kurze Beschreibung für unsere ${type} mit dem Namen "${name}" für eine App, die sich an Radfahrer richtet. Erwähne, dass wir ${extras} anbieten. Füge eine Info über die ${tiere} hinzu. Der Text soll maximal 50 Wörter haben.`;
    
    showToast("⏳ KI generiert Beschreibung...", 5000);
    isAIGenerating = true;
    document.getElementById('aiButton')?.setAttribute('disabled', 'true');
    document.getElementById('aiButton').innerHTML = 'Generiere...';
    
    // Hier würde die eigentliche API-Anfrage (z.B. Gemini, ChatGPT) erfolgen.
    // DUMMY-Antwort nach 3 Sekunden:
    await new Promise(r => setTimeout(r, 3000));
    
    const dummyDescription = `Willkommen bei "${name}"! Unsere gemütliche ${type} liegt perfekt am Radweg. Wir bieten ${extras} an, ideal für eine Pause. ${tiere.replace('Tiere vor Ort: ', '')}. Schau vorbei und stärke dich für die Weiterfahrt!`;
    
    // Text in Quill einfügen
    quill.root.innerHTML = dummyDescription;
    
    isAIGenerating = false;
    document.getElementById('aiButton')?.removeAttribute('disabled');
    document.getElementById('aiButton').innerHTML = '✨ KI-Text generieren';
    showToast("✅ KI-Text erfolgreich generiert!");
  }

  /**
   * Generiert automatische Tags basierend auf der Beschreibung.
   */
  async function generateAITags() {
    if (isAIGenerating) return;

    const currentDesc = quill ? quill.getText().trim() : '';
    if (!currentDesc || currentDesc.length < 20) {
        return showToast("❌ Bitte erst eine Beschreibung von mindestens 20 Zeichen eingeben.");
    }
    
    showToast("⏳ KI generiert Tags...", 3000);
    isAIGenerating = true;
    document.getElementById('aiTagButton')?.setAttribute('disabled', 'true');
    document.getElementById('aiTagButton').innerHTML = 'Generiere...';
    
    // Hier würde die eigentliche API-Anfrage erfolgen.
    // DUMMY-Antwort nach 2 Sekunden:
    await new Promise(r => setTimeout(r, 2000));
    
    // Dummy-Tags basierend auf Type/Extras
    const defaultTags = ["Radfahrer", "Pause", "Regional"];
    let generatedTags = [...defaultTags];

    if (editingData.typ === 'Spielplatz') generatedTags.push('Kinderfreundlich', 'Familie');
    if (editingData.typ === 'Automat') generatedTags.push('24/7', 'Automat');
    if (editingData.extras?.includes('Kaffee')) generatedTags.push('Kaffee');
    if (editingData.tiere?.includes('Huhn')) generatedTags.push('Hühner');

    const uniqueTags = [...new Set(generatedTags)].join(', ');

    // Tags in das Input-Feld einfügen
    document.getElementById('tagsInput').value = uniqueTags;
    
    isAIGenerating = false;
    document.getElementById('aiTagButton')?.removeAttribute('disabled');
    document.getElementById('aiTagButton').innerHTML = '🤖 Auto-Tags generieren';
    showToast("✅ Automatische Tags erstellt.");
  }


  function updateProgress() {
    const activeSteps = getActiveSteps();
    const currentStepIndex = activeSteps.indexOf(step);
    
    if (currentStepIndex === -1 || activeSteps.length <= 1) {
        document.getElementById('progress').style.width = '0%';
        return;
    }
    
    const pct = (currentStepIndex / (activeSteps.length - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }
    
  const typeTexts = {
    Eierhütte: { title: "🏷️ Name der Eierhütte", question: "Wie soll deine Eierhütte heißen?" },
    Hofladen: { title: "🏷️ Name des Hofladens", question: "Wie soll dein Hofladen heißen?" },
    Selbstbedienung: { title: "🏷️ Name des Selbstbedienungshäuschens", question: "Wie soll dein Selbstbedienungshäuschen heißen?" },
    Spielplatz: { title: "🏷️ Name des Spielplatzes", question: "Wie soll der Spielplatz heißen?" },
    Abenteuerhof: { title: "🏷️ Name des Abenteuerhofs", question: "Wie soll dein Abenteuerhof heißen?" },
    Automat: { title: "🏷️ Name des Automaten", question: "Wie soll dein Automat heißen?" }
  };

  /**
   * Filtert die Schritte basierend auf dem gewählten Typ (Smarte Logik).
   */
  function getActiveSteps() {
    const allSteps = Array.from({ length: stepsCount }, (_, i) => i);
    const type = editingData.typ;
    if (!type) return allSteps; 

    const skippedSteps = [];

    // Logik: Schritte, die für den Typ nicht zwingend relevant sind, werden übersprungen.
    if (type === 'Spielplatz' || type === 'Abenteuerhof') {
        // Öffnungszeiten (Schritt 5) oft 24/7 oder irrelevant, aber lassen wir drin für Flexibilität.
        skippedSteps.push(4); // Strom: Oft nicht primär relevant
    }
    if (type === 'Automat') {
        // Automaten haben keine Sitzplätze, Strom, Tiere oder Öffnungszeiten (implizit 24/7)
        skippedSteps.push(3, 4, 5, 7); 
    }
    if (type === 'Hofladen' || type === 'Selbstbedienung' || type === 'Eierhütte') {
        // Hier ist fast alles relevant
    }

    // Schritte 0, 1, 2, 6, 8, 9, 10, 11 sind immer aktiv (Datenschutz, Typ, Name, Extras, Beschreibung, Tags, Fotos, Standort)
    return allSteps.filter(s => !skippedSteps.includes(s));
  }


  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; 
    updateProgress();
    updateInfoBox();
    document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";
      
    // Prüfe, ob der aktuelle Schritt übersprungen werden soll
    const activeSteps = getActiveSteps();
    if (!activeSteps.includes(step)) {
        return nextStep(true); 
    }
      
    try {
      if (step === 0) {
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-xl font-bold mb-3">🛡️ Datenschutzerklärung</h2><div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200"><iframe src="https://radlmap.net/datenschutz.html" class="w-full h-[500px] border-0 bg-white" style="display:block; min-width:100%; overflow:auto;"></iframe></div><label class="inline-flex items-center gap-2 text-sm text-gray-700"><input id="dsCheck" type="checkbox" class="w-4 h-4" ${editingData.datenschutz ? 'checked' : ''} disabled /> Ich akzeptiere die Datenschutzerklärung</label><div id="dsHint" class="text-xs text-red-500 mt-1">⬇️ Bitte bis ganz nach unten scrollen</div></div>`;
        const scrollBox = document.getElementById("dsScrollBox");
        const check = document.getElementById("dsCheck");
        const hint = document.getElementById("dsHint");
        scrollBox.addEventListener("scroll", () => {
          if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
            check.disabled = false;
            hint.textContent = "✅ Du kannst nun die Datenschutzerklärung akzeptieren.";
            hint.classList.remove("text-red-500");
            hint.classList.add("text-green-600");
          }
        });
        return;
      }
      if (step === 1) {
        const opts = [
          { emoji: '🥚', label: 'Eierhütte', key: 'Eierhütte' }, { emoji: '🏪', label: 'Hofladen', key: 'Hofladen' },
          { emoji: '🏠', label: 'Selbstbedienungshäuschen', key: 'Selbstbedienung' }, { emoji: '🛝', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: '🌄', label: 'Abenteuerhof', key: 'Abenteuerhof' }, { emoji: '🍶', label: 'Automat', key: 'Automat' }
        ];
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-4xl mx-auto"><h2 class="text-xl font-bold mb-4">📍 Was möchtest du eintragen?</h2><div id="typeOptions" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div></div>`;
        const holder = document.getElementById('typeOptions');
        opts.forEach(o => {
          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer';
          if (editingData.typ === o.key) card.classList.add('selected');
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key; 
            // Gehe zum nächsten aktiven Schritt, falls sich die aktiven Schritte geändert haben
            updateProgress();
          };
          holder.appendChild(card);
        });
        return;
      }

      if (step === 2) {
        const { title, question } = typeTexts[editingData.typ] || typeTexts['Eierhütte'];
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-2">${title}</h2><p class="text-sm text-gray-600 mb-2">${question}</p><input id="nameInput" class="w-full border p-2 rounded" placeholder="Name eingeben" value="${editingData.name || ''}"></div>`;
        return;
      }

      if (step === 3) { // Sitzplätze
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-2">🪑 Gibt es Sitzplätze?</h2><div class="flex gap-4"><button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">✅ Ja</button><button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Nein' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">❌ Nein</button></div></div>`;
        return;
      }

      if (step === 4) { // Strom
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-2">🔌 Gibt es Strom?</h2><div class="flex gap-4"><button class="flex-1 p-3 border rounded ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">⚡ Ja (z.B. Ladesäule)</button><button class="flex-1 p-3 border rounded ${editingData.strom === 'Nein' ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">❌ Nein</button></div></div>`;
        return;
      }
      
      if (step === 5) { // Öffnungszeiten
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-3">🕒 Öffnungszeiten</h2><div id="openhours-editor-wrapper">${renderOpeningHoursEditor("currentHutId", editingData.oeffnungszeiten)}</div><p class="text-xs text-gray-500 mt-4">Wichtig: Wenn du keine Zeiten einträgst, wird 'Geschlossen' angezeigt.</p></div>`;
        return;
      }

      if (step === 6) { // Extras
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-2">✨ Extras (optional)</h2><input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. Getränke, Kühlschrank, Selbstbedienungs-Kaffee" value="${editingData.extras || ''}"></div>`;
        return;
      }

      if (step === 7) { // Tiere
        const animals = ["🐐 Ziege","🐄 Kuh","🐓 Huhn","🐕 Hund","🐇 Hase","🐈 Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">🐾 Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const btn = document.createElement('button');
          const isSel = editingData.tiere.includes(t);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            if (t === 'Keine Tiere') { editingData.tiere = ['Keine Tiere']; holder.querySelectorAll('button').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); return; }
            editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
            const idx = (editingData.tiere || []).indexOf(t);
            if (idx >= 0) { editingData.tiere.splice(idx, 1); btn.classList.remove('selected'); } else { editingData.tiere.push(t); btn.classList.add('selected'); }
          };
          holder.appendChild(btn);
        });
        return;
      }

      if (step === 8) { // Beschreibung mit KI
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-4xl mx-auto">
            <h2 class="text-lg font-bold mb-3">📝 Beschreibung (KI-gestützt)</h2>
            <div id="quillContainer" class="bg-white border rounded"></div>
            <div class="mt-4 flex justify-end">
                <button id="aiButton" class="ki-button" onclick="generateAIPrompt()">
                    ✨ KI-Text generieren
                </button>
            </div>
          </div>`;
        setTimeout(() => {
          initQuill("quillContainer", editingData.beschreibung || '');
        }, 120);
        return;
      }

      if (step === 9) { // Tags mit KI
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-3">🏷️ Schlagwörter (Komma getrennt)</h2>
            <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. Frühstück,Schattig" value="${(editingData.tags||[]).join(', ')}">
            <div class="mt-4 flex justify-end">
                <button id="aiTagButton" class="ki-button" onclick="generateAITags()">
                    🤖 Auto-Tags generieren
                </button>
            </div>
          </div>`;
        return;
      }

      if (step === 10) { // Foto-Upload (Unverändert)
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-4">📸 Fotos (Max. 10)</h2><div id="smartUploadZone" class="border-2 border-dashed border-gray-300 p-8 rounded-xl text-center cursor-pointer bg-gray-50 hover:bg-green-50 transition" onclick="document.getElementById('fileInput').click()"><p class="text-xl font-semibold text-gray-700">Fotos hochladen oder hierher ziehen</p><p class="text-sm text-gray-500 mt-1">Das erste Foto wird das Hauptbild</p><input type="file" id="fileInput" multiple accept="image/*" class="hidden"></div><div id="smartUploadPreview" class="grid grid-cols-3 gap-3 mt-4"></div><div class="mt-4 flex items-center gap-4 text-xs text-gray-500"><span class="font-semibold">Speicheranbieter:</span> <span id="imageProviderLabel">ImgBB</span><button onclick="setImageProvider('imgbb')" class="px-2 py-1 border rounded hover:bg-gray-100">ImgBB</button><button onclick="setImageProvider('firebase')" class="px-2 py-1 border rounded hover:bg-gray-100">Firebase</button></div><p id="uploadLimit" class="text-sm text-red-500 mt-2 ${editingData.photos.length >= 10 ? '' : 'hidden'}">⚠️ Maximale Anzahl von Fotos (10) erreicht!</p></div>`;
        setTimeout(() => {
          initSmartUpload();
          showGalleryFromEditingData(); 
          updateProviderUI(); 
        }, 100);
        return;
      }

      if (step === 11) { // Übersicht & Standort (Unverändert)
         qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-xl font-bold mb-3">📋 Übersicht & Standort</h2><h3 class="text-lg font-bold mt-4 mb-2">📍 Standort</h3><div class="relative mb-2"><input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchen…" /><div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div></div><button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded">📡 Mein Standort</button><div id="overview-map" class="h-64 rounded border mb-4"></div><div class="mt-3 flex items-center gap-2"><label class="inline-flex items-center gap-2"><input type="checkbox" id="instantActive" class="w-4 h-4"> <span class="font-semibold text-green-700">Sofort aktiv</span> (ohne Prüfung)</label></div><div class="flex gap-2 mt-4"><button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">✅ Einreichen</button><button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">✖ Abbrechen</button></div><p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprüft und erst nach Freigabe sichtbar, es sei denn, du wählst 'Sofort aktiv'.</p></div>`;
        setTimeout(() => { initOverviewMap(); const gpsBtn = document.getElementById("gpsBtn"); if (gpsBtn) gpsBtn.addEventListener("click", locateGPS);
          const addr = document.getElementById("addressSearch");
          const suggestionBox = document.getElementById("addressSuggestions");
          if (addr) {
            addr.addEventListener("input", async e => {
              const query = e.target.value.trim();
              if (query.length < 3) { suggestionBox.innerHTML = ""; suggestionBox.classList.add("hidden"); return; }
              try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.length) { suggestionBox.innerHTML = "<div class='p-2 text-gray-500'>Keine Treffer</div>"; suggestionBox.classList.remove("hidden"); return; }
                suggestionBox.innerHTML = data.map(item => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="${item.lat}" data-lon="${item.lon}">${item.display_name}</div>`).join("");
                suggestionBox.classList.remove("hidden");
                suggestionBox.querySelectorAll("div").forEach(div => {
                  div.addEventListener("click", () => {
                    const lat = parseFloat(div.dataset.lat);
                    const lon = parseFloat(div.dataset.lon);
                    addr.value = div.textContent;
                    suggestionBox.classList.add("hidden");
                    initOverviewMap(lat, lon, 15);
                  });
                });
              } catch (err) { console.error("Fehler bei Nominatim:", err); }
            });
          }
        }, 200);
        return;
      }
      
    } catch (err) {
      console.error("renderQuestion error", err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler: ${err.message}</div>`;
    }
  }
    
  function selectOption(field, value, el) { 
    if (el && el.parentNode) { 
      el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected')); 
      el.classList.add('selected'); 
    } 
    editingData[field] = value; 
  } 

  function nextStep(skipValidation = false) { 
    if (!skipValidation) {
      // Speichern der Beschreibung/Tags bei Weiter
      if (step === 8 && quill) { 
        editingData.beschreibung = quill.root.innerHTML; 
      }
      if (step === 9) { 
        const raw = document.getElementById('tagsInput')?.value || ''; 
        editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10); 
      }

      // Validation
      if (step === 0) { 
        const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked; 
        if (!ok) { alert('Bitte Datenschutzerklärung akzeptieren'); return; } 
        editingData.datenschutz = true; 
      } 
      if (step === 1) { 
        if (!editingData.typ) { alert("Bitte einen Typ auswählen."); return; } 
      } 
      if (step === 2) { 
        const v = document.getElementById('nameInput')?.value?.trim(); 
        if (!v) { alert('Bitte Namen eingeben'); return; } 
        editingData.name = v; 
      }
      if (step === 5) { // Öffnungszeiten (falls aktiv)
        const normalizedOeff = collectOpeningHours();
        if (!normalizedOeff || (Array.isArray(normalizedOeff) && normalizedOeff.length === 0 && !document.getElementById("immerCheck")?.checked)) { 
          // Muss keine Zeiten haben, wenn es 24/7 ist, ansonsten muss etwas gesetzt sein
        }
        editingData.oeffnungszeiten = normalizedOeff; 
      } 
      if (step === 6) { 
        editingData.extras = document.getElementById('extrasInput')?.value?.trim(); 
      }
    }
    
    const activeSteps = getActiveSteps();
    const currentStepIndex = activeSteps.indexOf(step);

    if (currentStepIndex !== -1 && currentStepIndex < activeSteps.length - 1) {
      step = activeSteps[currentStepIndex + 1];
      renderQuestion();
    } else if (currentStepIndex === activeSteps.length - 1) {
      // Am Ende der aktiven Schritte (Schritt 11)
      step = activeSteps[activeSteps.length - 1]; // Bleibe auf dem letzten Schritt
      renderQuestion();
    } else {
      // Wenn der aktuelle Schritt übersprungen wurde, suche den nächsten
      step++;
      renderQuestion();
    }
    updateProgress();
  } 

  function prevStep() { 
    const activeSteps = getActiveSteps();
    const currentStepIndex = activeSteps.indexOf(step);

    if (currentStepIndex > 0) {
      step = activeSteps[currentStepIndex - 1];
    } else if (currentStepIndex === -1 && step > 0) {
      // Falls der aktuelle Schritt übersprungen wurde, suche den vorherigen
      step--;
    }
    
    if (step < 0) step = 0; 
    
    renderQuestion(); 
    updateProgress(); 
  } 

  function startNewEntry() { 
    if (!currentUser || !currentUser.uid) { 
      showToast("Bitte zuerst einloggen"); 
      return; 
    } 
    editingData = { photos: [] }; 
    step = 0; 
    mode = "entry"; 
    document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none"; 
    renderQuestion(); 
    document.getElementById('sidebar').classList.add('-translate-x-full'); 
    updateProgress(); 
  } 

  async function submitEntry() { 
    if (!editingData.name || !editingData.typ) { alert('Bitte Typ und Name ausfüllen.'); return; } 
    if (!editingData.location?.lat) { alert('Bitte den Standort auf der Karte festlegen.'); return; }
    
    showToast("⏳ Fotos werden hochgeladen...");
    const uploadedPhotoUrls = [];
    const filesToUpload = editingData.photos.filter(p => p instanceof File);

    for (const f of filesToUpload) {
      try {
        const url = await uploadFileWithProgress(f, (pct) => { showToast(`⏳ Upload von ${f.name}: ${pct}%`); });
        uploadedPhotoUrls.push({ url, status: 'ok' });
      } catch(err) {
        console.error("Foto-Upload-Fehler", err);
        showToast(`❌ Fehler beim Upload von ${f.name}.`);
      }
    }
    
    const finalPhotos = uploadedPhotoUrls.concat(editingData.photos.filter(p => typeof p === 'object' && p.url));
    
    const payload = { 
      userId: currentUser.uid, name: editingData.name, typ: editingData.typ, 
      sitzplaetze: editingData.sitzplaetze || 'Nein', strom: editingData.strom || 'Nein', 
      extras: editingData.extras || '', tiere: editingData.tiere || [], 
      beschreibung: editingData.beschreibung || '', tags: editingData.tags || [], 
      oeffnungszeiten: editingData.oeffnungszeiten || null, fotos: finalPhotos,
      status: 'offen', erstelltAm: firebase.firestore.FieldValue.serverTimestamp(), 
      datenschutzZustimmung: { bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(), durch: currentUser.email || null } ,
      location: new firebase.firestore.GeoPoint( editingData.location.lat, editingData.location.lng )
    }; 
    
    try { 
      const docRef = await db.collection('eierhuetten').add(payload); 

      const instant = document.getElementById('instantActive')?.checked;
      if (instant) {
          await db.collection('eierhuetten').doc(docRef.id).update({ status: 'angenommen', active: true });
          showToast('✅ Eintrag sofort aktiv und sichtbar!');
      } else {
          showToast('✅ Eintragung gesendet. Wird geprüft.'); 
      }
      
      showMyEntries(); 
    } catch (err) { 
      console.error('submitEntry error', err); 
      alert('Fehler beim Senden: ' + (err.message || err)); 
    } 
  } 

  // ... Map-Funktionen (initOverviewMap, locateGPS) - Unverändert ...
  let overviewMap; 
  let overviewMarker; 
  function initOverviewMap(lat = 51.1657, lng = 10.4515, zoom = 6) { 
    if (!overviewMap) { 
      overviewMap = L.map("overview-map").setView([lat, lng], zoom); 
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(overviewMap); 
    } else { 
      overviewMap.setView([lat, lng], zoom); 
    } 
    if (!overviewMarker) { 
      overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap); 
      overviewMarker.on("dragend", ev => { 
        const p = ev.target.getLatLng(); 
        editingData.location = { lat: p.lat, lng: p.lng }; 
      }); 
    } else { 
      overviewMarker.setLatLng([lat, lng]); 
    } 
    editingData.location = { lat, lng }; 
  } 
  function locateGPS() { 
    if (!navigator.geolocation) return alert("❌ GPS nicht verfügbar"); 
    navigator.geolocation.getCurrentPosition( 
      pos => { 
        const { latitude, longitude } = pos.coords; 
        initOverviewMap(latitude, longitude, 15); 
      }, 
      err => { 
        alert("❌ GPS-Fehler: " + err.message); 
      } 
    ); 
  } 
  
  const stepInfos = { 
    0: { title: "Datenschutz", text: "Bitte lies die Datenschutzerklärung aufmerksam und bestätige sie. Ohne Zustimmung können wir keine Daten annehmen." }, 
    1: { title: "Art der Eintragung (Smart)", text: "Wähle den Typ. Die folgenden Schritte werden automatisch an deine Auswahl angepasst, um dir Zeit zu sparen." }, 
    2: { title: "Name der Hütte", text: "Verwende einen kurzen, prägnanten Namen." }, 
    3: { title: "Sitzplätze", text: "Gibt es Sitzgelegenheiten? (Wird ggf. übersprungen)" }, 
    4: { title: "Strom", text: "Ist Strom (Lademöglichkeit) vorhanden? (Wird ggf. übersprungen)" }, 
    5: { title: "Öffnungszeiten", text: "Trage deine Zeiten ein oder wähle 'Immer geöffnet'. (Wird ggf. übersprungen)" }, 
    6: { title: "Extras", text: "Gib weitere Merkmale an, z. B. Getränke, Kühlschrank, Grillmöglichkeiten." }, 
    7: { title: "Tiere", text: "Wähle alle vorhandenen Tiere. (Wird ggf. übersprungen)" }, 
    8: { title: "Beschreibung (KI)", text: "Beschreibe deinen Eintrag ausführlich. Nutze den KI-Button, um automatisch einen optimierten Text basierend auf deinen Eingaben zu generieren!" }, 
    9: { title: "Tags (KI)", text: "Gib Schlagwörter ein (max. 10). Nutze den KI-Button, um automatische, relevante Tags basierend auf deiner Beschreibung zu generieren." },
    10: { title: "Fotos", text: "Lade deine besten Fotos hoch (max. 10). Das erste ist das Hauptbild." }, 
    11: { title: "Übersicht & Standort", text: "Lege den Standort fest (Karte/GPS). Aktiviere 'Sofort aktiv' für sofortige Veröffentlichung." } 
  }; 

  function updateInfoBox() { 
    const boxDesktop = document.getElementById("infoBox"); 
    const boxMobile = document.getElementById("infoBoxMobile"); 
    let html = ""; 
    const currentInfo = stepInfos[step];

    if (mode === "entry" && currentInfo) { 
      html = `<h4 class="font-semibold text-lg text-green-700">${currentInfo.title}</h4><p>${currentInfo.text}</p>`; 
    } else if (mode === "list") { 
      html = `<h4 class="font-semibold text-lg text-green-700">📋 Meine Eintragungen (Pausieren)</h4><p>Übersicht all deiner Einträge. Nutze Pausieren/Aktivieren, um die Sichtbarkeit temporär zu steuern.</p>`; 
    } else if (mode === "settings") { 
      html = `<h4 class="font-semibold text-lg text-green-700">⚙️ Account-Einstellungen</h4><p>Verwalte deine Account-Details, kündige dein Unterstützer-Abo oder lösche deinen Account.</p>`; 
    } else if (mode === "tutorial") { 
      html = `<h4 class="font-semibold text-lg text-green-700">👋 Willkommen</h4><p>Starte mit ➕ Neue Eintragung oder überprüfe deine bestehenden Einträge unter 📋 Meine Eintragungen.</p>`; 
    } else if (mode === "hutMessages") { 
      html = `<h4 class="font-semibold text-lg text-green-700">💌 Hütten-Nachrichten</h4><p> Hier siehst du alle Nachrichten, die Besucher zu deinen Hütten geschickt haben.</p>`; 
    } else { 
      html = "<p>ℹ️ Wähle links eine Funktion aus.</p>"; 
    } 
    
    if (boxDesktop) boxDesktop.innerHTML = html; 
    if (boxMobile) boxMobile.innerHTML = html;
  } 

  async function showMyEntries() { 
    if (!firebase.auth().currentUser) { showToast("Bitte zuerst einloggen"); return; } 
    const uid = firebase.auth().currentUser.uid; 
    const container = document.getElementById("question-area"); 
    container.innerHTML = `<div class="max-w-6xl mx-auto"><h2 class="text-2xl font-bold mb-6 text-green-700">📋 Meine Eintragungen</h2><div id="entriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`; 
    const grid = document.getElementById("entriesGrid"); 
    grid.innerHTML = `<div class="col-span-3 text-gray-500 text-center">⏳ Lade Eintragungen…</div>`; 
    mode = "list";
    document.getElementById("navBottom").style.display = "none";
    updateInfoBox();
    
    try { 
      const snap = await db.collection("eierhuetten") 
        .where("userId", "==", uid) 
        .orderBy("erstelltAm", "desc") 
        .get(); 
      
      const docs = snap.docs.filter(d => { const st = d.data().status; return st !== 'archiviert' && st !== 'deleted'; }); 
      
      if (docs.length === 0) { 
        grid.innerHTML = `<div class="col-span-3 bg-white p-6 rounded shadow text-center text-gray-500">Du hast noch keine Eintragungen. Starte mit ➕ Neue Eintragung.</div>`; 
        return; 
      } 
      
      grid.innerHTML = ''; 
      
      for (const doc of docs) { 
        const d = doc.data(); 
        const id = doc.id; 
        const statusKey = d.status || 'unbekannt';
        
        const statusMap = {
            'angenommen': { label: 'Aktiv', class: 'status-angenommen', icon: '✅' },
            'offen': { label: 'Wartet auf Freigabe', class: 'status-offen', icon: '⏳' },
            'pausiert': { label: 'Pausiert', class: 'status-pausiert', icon: '⏸️' },
            'abgelehnt': { label: 'Abgelehnt', class: 'status-abgelehnt', icon: '❌' },
        };
        const status = statusMap[statusKey] || statusMap['abgelehnt'];
        
        const img = Array.isArray(d.fotos) && d.fotos.length ? (typeof d.fotos[0] === 'string' ? d.fotos[0] : d.fotos[0].url) : 'https://placehold.co/600x400/CCCCCC/444444/jpg'; 
        const isActive = statusKey === 'angenommen';

        const card = document.createElement('div'); 
        card.className = `bg-white rounded-xl shadow-lg overflow-hidden relative ${status.class}`; 
        card.innerHTML = ` 
          <div class="p-4 flex items-start gap-4">
            <div class="flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border border-gray-200">
               <img src="${img}" alt="${d.name||''}" class="w-full h-full object-cover"> 
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-extrabold text-xl mb-1 truncate">${d.name||'Unbenannt'}</h3> 
              <p class="text-sm font-semibold mb-2 text-gray-500">${d.typ || 'Typ unbekannt'}</p>
              <div class="flex items-center gap-2 text-sm ${status.class.split(' ')[1]}">
                  ${status.icon} <span class="font-bold">${status.label}</span>
              </div>
              
              <div class="mt-3 flex flex-wrap gap-2 text-xs"> 
                <button class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200" title="Bearbeiten" onclick="openEditPage('${id}')">✏️ Bearbeiten</button> 
                ${isActive ? `
                  <button class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full hover:bg-yellow-200" title="Pausieren" onclick="toggleEntryPause('${id}', '${d.name||''}', true)">⏸️ Pausieren</button>
                ` : (statusKey === 'pausiert' ? `
                  <button class="px-3 py-1 bg-green-100 text-green-800 rounded-full hover:bg-green-200" title="Aktivieren" onclick="toggleEntryPause('${id}', '${d.name||''}', false)">▶️ Aktivieren</button>
                ` : `
                  <button class="px-3 py-1 bg-red-100 text-red-800 rounded-full hover:bg-red-200" title="Löschen" onclick="confirmDeleteEntry('${id}', '${d.name||''}')">🗑️ Löschen</button>
                `)}
              </div>
            </div> 
          </div> 
        `; 
        grid.appendChild(card); 
      } 
    } catch (err) { 
      console.error('showMyEntries error', err); 
      grid.innerHTML = `<div class="col-span-3 bg-red-100 p-4 rounded">Fehler beim Laden: ${err.message}</div>`; 
    } 
  } 

  async function toggleEntryPause(id, name, pause) {
      const newStatus = pause ? 'pausiert' : 'angenommen';
      const action = pause ? 'pausiert' : 'aktiviert';
      
      if (pause && !confirm(`Soll die Eintragung "${name}" wirklich pausiert werden? Sie ist dann nicht mehr auf der Karte sichtbar.`)) return;

      try {
          await db.collection('eierhuetten').doc(id).update({ 
              status: newStatus,
              active: !pause, 
              pausiertAm: pause ? firebase.firestore.FieldValue.serverTimestamp() : null
          });
          showToast(`✅ Eintrag "${name}" wurde ${action}.`);
          showMyEntries(); 
      } catch (err) {
          console.error('Pause/Activate error', err);
          showToast(`❌ Fehler beim ${action}: ${err.message}`);
      }
  }

  function confirmDeleteEntry(id, name) { 
    const proceed = confirm(`⚠️ Möchtest du die Eintragung "${name}" wirklich löschen? Dieser Schritt kann nicht rückgängig gemacht werden.`);
    if(proceed) {
      db.collection('eierhuetten').doc(id).update({ status: 'deleted' })
        .then(() => {
          showToast(`🗑️ Eintrag "${name}" gelöscht.`);
          showMyEntries();
        })
        .catch(err => {
          console.error('Delete error', err);
          alert('❌ Fehler beim Löschen: ' + err.message);
        });
    }
  }

  function openEditPage(id) {
      // Dummy - hier müsste die Lade-Logik implementiert werden
      showToast(`Bearbeitungs-Seite für ${id} wird geladen... (Funktion nur als Platzhalter)`);
  }

  // ===========================================
  // ⚙️ Account-Einstellungen (Mit Infos)
  // ===========================================

  function showSettings() {
      if (!currentUser) return showToast("Bitte zuerst einloggen.");
      const qa = document.getElementById("question-area");
      mode = "settings";

      // Firebase User Metadata auslesen und formatieren
      const creationDate = currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleString('de-DE') : 'N/A';
      const lastSignInDate = currentUser.metadata.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleString('de-DE') : 'N/A';

      qa.innerHTML = `
          <section class="bg-white p-6 rounded-2xl shadow-lg max-w-xl mx-auto animate-fadeIn">
              <h2 class="text-2xl font-bold mb-6 text-green-600">⚙️ Account-Einstellungen</h2>
              
              <div class="p-4 border border-gray-200 rounded-lg mb-6 bg-gray-50">
                  <h3 class="font-bold text-lg mb-3 text-gray-800">👤 Mein Account</h3>
                  <div class="space-y-2 text-sm">
                      <div class="flex justify-between items-center border-b pb-1">
                          <span class="font-semibold text-gray-600">E-Mail:</span>
                          <span class="truncate">${currentUser.email || 'N/A'}</span>
                      </div>
                      <div class="flex justify-between items-center border-b pb-1">
                          <span class="font-semibold text-gray-600">User ID (UID):</span>
                          <span class="text-xs font-mono bg-gray-200 px-2 py-0.5 rounded">${currentUser.uid || 'N/A'}</span>
                      </div>
                      <div class="flex justify-between items-center border-b pb-1">
                          <span class="font-semibold text-gray-600">Account erstellt am:</span>
                          <span>${creationDate}</span>
                      </div>
                      <div class="flex justify-between items-center">
                          <span class="font-semibold text-gray-600">Letzter Login:</span>
                          <span>${lastSignInDate}</span>
                      </div>
                  </div>
              </div>

              <div class="p-4 border rounded-lg mb-4 bg-yellow-50">
                  <h3 class="font-bold text-lg mb-2 text-yellow-800">🌟 Unterstützer-Abo kündigen</h3>
                  <p class="text-gray-700 mb-4 text-sm">
                      Du bist aktuell Unterstützer von RadlMap. Hier kannst du dein Abo beenden.
                  </p>
                  <button onclick="cancelSupporterSubscription()" class="w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold hover:bg-yellow-700 transition">
                      Abo kündigen (Dummy)
                  </button>
                  <p class="text-xs text-gray-500 mt-2">Hinweis: Die Kündigung im echten System erfolgt über den Zahlungsanbieter (Stripe/PayPal).</p>
              </div>

              <div class="p-4 border border-red-300 rounded-lg mb-4 bg-red-50">
                  <h3 class="font-bold text-lg mb-2 text-red-700">⚠️ Account löschen</h3>
                  <p class="text-gray-700 mb-4 text-sm">
                      Das Löschen deines Accounts entfernt alle deine persönlichen Daten und alle deine Eintragungen.
                  </p>
                  <button onclick="deleteAccountAndData()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                      Account endgültig löschen
                  </button>
              </div>
          </section>
      `;
      updateInfoBox();
      document.getElementById("navBottom").style.display = "none";
  }

  function cancelSupporterSubscription() {
      if (!currentUser) return showToast("❌ Nicht angemeldet.");
      if (confirm("Bist du sicher, dass du dein Unterstützer-Abo kündigen möchtest?")) {
          db.collection('betreiber').doc(currentUser.uid).update({ premium: false, premium_cancelled: true })
          .then(() => {
              showToast("✅ Kündigung registriert (Dummy).");
              showSettings();
          })
          .catch(e => showToast("❌ Fehler beim Kündigen: " + e.message));
      }
  }

  async function deleteAccountAndData() {
      if (!currentUser) return showToast("❌ Nicht angemeldet.");
      const confirmation = prompt(`⚠️ ACHTUNG: Bitte gib deine E-Mail-Adresse (${currentUser.email}) ein, um die Löschung deines Accounts und aller deiner Daten zu bestätigen.`);

      if (confirmation !== currentUser.email) {
          return showToast("❌ E-Mail-Adresse stimmt nicht überein. Abbruch der Löschung.");
      }

      try {
          showToast("⏳ Lösche alle deine Eintragungen...");
          const entriesSnap = await db.collection("eierhuetten").where("userId", "==", currentUser.uid).get();
          const batch = db.batch();
          entriesSnap.forEach(doc => { batch.update(doc.ref, { status: 'deleted', reason: 'Account deleted' }); });
          await batch.commit();

          showToast("⏳ Lösche Benutzerdaten (Betreiber-Eintrag)...");
          await db.collection("betreiber").doc(currentUser.uid).delete();

          showToast("⏳ Lösche Firebase Account...");
          await currentUser.delete();
          
          showToast("🎉 Account erfolgreich gelöscht. Du wirst ausgeloggt.", 5000);
          logout();

      } catch (e) {
          console.error("Account Delete Error", e);
          showToast("❌ Fehler beim Löschen. Melde dich erneut an und versuche es. Fehler: " + (e.code || e.message), 8000);
      }
  }
  
  // ===========================================
  // 📸 Upload Logik
  // ===========================================
  window.imageProvider = 'imgbb'; // Default
  function updateProviderUI() {
    const label = document.getElementById('imageProviderLabel');
    if (label) label.textContent = window.imageProvider === 'firebase' ? 'Firebase Storage' : 'ImgBB';
  }
  function setImageProvider(provider) {
    if (provider === 'firebase' && !firebase.storage().ref) {
      return showToast("❌ Firebase Storage ist nicht richtig konfiguriert.");
    }
    window.imageProvider = provider;
    updateProviderUI();
    showToast(`Speicheranbieter gewechselt zu ${provider === 'firebase' ? 'Firebase Storage' : 'ImgBB'}`);
  }
  
  function initSmartUpload() {
      const fileInput = document.getElementById('fileInput');
      const uploadZone = document.getElementById('smartUploadZone');
      
      const handleFiles = (files) => {
          const validFiles = Array.from(files).filter(file => file.type.startsWith('image/') && editingData.photos.length < 10);
          if (validFiles.length > 0) {
              validFiles.forEach(file => {
                  editingData.photos.push(file);
              });
              showGalleryFromEditingData();
              document.getElementById('uploadLimit')?.classList.toggle('hidden', editingData.photos.length < 10);
          }
      };

      fileInput.onchange = (e) => handleFiles(e.target.files);

      uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('border-green-500'); });
      uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('border-green-500'));
      uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.classList.remove('border-green-500');
          handleFiles(e.dataTransfer.files);
      });
  }
  
  function showGalleryFromEditingData() {
      const preview = document.getElementById('smartUploadPreview');
      if (!preview) return;

      preview.innerHTML = '';
      editingData.photos.forEach((photo, index) => {
          const url = photo instanceof File ? URL.createObjectURL(photo) : photo.url;
          const isMain = index === 0;

          const container = document.createElement('div');
          container.className = `photo-preview relative rounded-lg overflow-hidden shadow-md ${isMain ? 'border-2 border-green-500' : ''}`;
          container.draggable = true;
          container.dataset.index = index;

          container.innerHTML = `
              <img src="${url}" alt="Vorschau" class="w-full h-24 object-cover" />
              ${isMain ? '<span class="absolute top-1 left-1 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full">Hauptbild</span>' : ''}
              <div class="photo-preview-overlay">
                  <button onclick="removePhoto(${index})" title="Entfernen">🗑️</button>
                  <button onclick="setAsMain(${index})" title="Als Hauptbild setzen">⭐</button>
              </div>
          `;
          preview.appendChild(container);
      });
      // Cleanup URLs
      editingData.photos.filter(p => p instanceof File).forEach(file => URL.revokeObjectURL(file));

      // Drag and Drop Logik
      setupDragDrop(preview);
  }

  function removePhoto(index) {
      editingData.photos.splice(index, 1);
      showGalleryFromEditingData();
  }

  function setAsMain(index) {
      if (index === 0) return;
      const photo = editingData.photos.splice(index, 1)[0];
      editingData.photos.unshift(photo);
      showGalleryFromEditingData();
  }
  
  function setupDragDrop(container) {
    let draggedItem = null;

    container.querySelectorAll('.photo-preview').forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => e.target.style.opacity = '0.5', 0);
        });

        item.addEventListener('dragend', (e) => {
            e.target.style.opacity = '1';
            draggedItem = null;
        });

        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });

        item.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedItem && draggedItem !== e.target) {
                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(e.target.dataset.index);
                
                // Array-Elemente umsortieren
                const itemToMove = editingData.photos.splice(fromIndex, 1)[0];
                editingData.photos.splice(toIndex, 0, itemToMove);
                
                showGalleryFromEditingData();
            }
        });
    });
  }

  // ===========================================
  // 📚 Tutorial (Unverändert)
  // ===========================================
  function showTutorial() {
      const qa = document.getElementById('question-area');
      mode = "tutorial";
      qa.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold mb-4 text-green-700">Willkommen im RadlMap Assistent! 👋</h2>
            <p class="text-gray-600 mb-6">
                Dies ist dein zentrales Dashboard, um deine Hütten, Höfe oder Spielplätze auf der RadlMap zu verwalten.
            </p>
            <div class="space-y-4">
                <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-lg text-green-700">➕ Neue Eintragung</h3>
                    <p class="text-sm text-gray-700">Nutze den intelligenten Assistenten, um einen neuen Ort in nur 12 smarten Schritten hinzuzufügen.</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                    <h3 class="font-bold text-lg text-blue-700">📋 Meine Eintragungen</h3>
                    <p class="text-sm text-gray-700">Hier verwaltest du deine aktiven, offenen und pausierten Einträge. Du kannst sie bearbeiten oder temporär von der Karte nehmen.</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border-l-4 border-gray-500">
                    <h3 class="font-bold text-lg text-gray-700">⚙️ Einstellungen</h3>
                    <p class="text-sm text-gray-700">Hier findest du deine Account-Informationen und kannst wichtige Einstellungen wie die Kündigung des Unterstützer-Abos oder die Account-Löschung vornehmen.</p>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-6 text-center">
                Viel Erfolg beim Eintragen!
            </p>
        </div>
      `;
      updateInfoBox();
      document.getElementById("navBottom").style.display = "none";
  }

  // ===========================================
  // 💌 Nachrichten (Unverändert)
  // ===========================================
  function showHutMessages() {
      const qa = document.getElementById('question-area');
      mode = "hutMessages";
      qa.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">💌 Hütten-Nachrichten</h2>
            <div class="p-4 bg-blue-50 rounded-lg text-blue-800">
                <p class="font-semibold">Diese Funktion ist aktuell nur ein Platzhalter.</p>
                <p class="text-sm mt-1">Hier würden alle Nachrichten und Feedback-Meldungen zu deinen eingetragenen Orten angezeigt werden.</p>
            </div>
            <div class="mt-4 space-y-3">
              <div class="p-3 border rounded">
                <p class="font-semibold">Feedback zu "Eierhütte am See"</p>
                <p class="text-sm text-gray-600">"Tolle Auswahl, aber das GPS hat mich 50m daneben geführt."</p>
                <span class="text-xs text-gray-400">gesendet: 2025-10-20</span>
              </div>
              <div class="p-3 border rounded">
                <p class="font-semibold">Frage zu "Abenteuerhof Sonne"</p>
                <p class="text-sm text-gray-600">"Können wir am Wochenende dort grillen?"</p>
                <span class="text-xs text-gray-400">gesendet: 2025-10-18</span>
              </div>
            </div>
        </div>
      `;
      updateInfoBox();
      document.getElementById("navBottom").style.display = "none";
  }
  
  // Start the app with the tutorial/dashboard view
  if (firebase.auth().currentUser) {
    showTutorial();
  }
  </script>
</body>
</html>
