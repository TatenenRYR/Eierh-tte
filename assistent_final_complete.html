<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent | Smarter V3</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 3px solid #10b981; background-color: #ecfdf5; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
    .minimap { height: 200px; z-index: 0; }
    .leaflet-container { z-index: 0 !important; }
    /* Small helper for fixed bottom nav on small screens */
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; } /* space for fixed nav */
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    .sidebar-btn.active {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }

    /* === Smarter Upload Style === */
    #smartUploadZone {
      transition: all 0.25s ease;
      min-height: 150px;
    }
    #smartUploadZone:hover {
      background-color: #ecfdf5;
      border-color: #10b981;
      transform: scale(1.01);
    }
    .uploading::after {
      content: "⏫";
      position: absolute;
      top: 4px; right: 4px;
      font-size: 0.8rem;
      animation: pulseUpload 1s infinite;
      color: #16a34a;
    }
    @keyframes pulseUpload {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
  </style>
</head>
<body class="bg-gray-100">
<script>window.stepInfos = window.stepInfos || [];</script>

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" class="w-64 h-64 drop-shadow-lg" alt="Funny Hut" />
    </div>
    <h1 class="text-3xl font-extrabold text-green-700 mb-3">Assistent-Dashboard</h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>
    <button onclick="doGoogleLogin()"
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg"
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>
    <p class="text-xs text-gray-400 mt-6">🔒 Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.</p>
  </div>
</div>

<div id="mainApp" class="flex min-h-screen hidden">

    <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

      <div class="flex flex-col items-center mb-8">
        <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
          <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
          <span id="avatarInitials"></span>
        </div>
        <p class="text-sm text-gray-600">Angemeldet als:</p>
        <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
        <button onclick="logout()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform">Logout</button>
      </div>

      <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
        🌿 Assistent
      </div>

      <nav class="flex flex-col gap-2 text-[15px]">
        <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
          🚲 Startseite
        </a>
        <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
          🚴‍♂️ zur RadlMap
        </a>

        <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">
          📊 Betreiber-Dashboard
        </button>
        <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">
          📋 Meine Eintragungen
        </button>
        <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">
          ➕ Neue Eintragung
        </button>

        <div class="mt-4">
          <div class="flex items-center justify-between px-3 mb-1">
            <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
            <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
          </div>

          <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
            <button id="btnMyEvents"
              class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
              onclick="setActive('btnMyEvents'); showMyEvents()">
              📅 <span>Meine Events</span>
            </button>
            <button id="btnCreateEvent"
              class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
              onclick="setActive('btnCreateEvent'); showCreateEvent()">
              ➕ <span>Neues Event</span>
            </button>
          </div>
        </div>

        <hr class="my-3 border-gray-200">

        <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSupport'); openSupport()">
          💬 Support
        </button>
        <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
          💌 Hütten-Nachrichten
          <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
        </button>
      </nav>

      <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
        v3.0 Smarter &middot; RadlMap Assistent
      </div>
    </aside>

    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
      <div class="sticky top-4">
        <h3 class="text-lg font-bold mb-3">ℹ️ Hilfe & Beispiele</h3>
        <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
      </div>
    </div>

    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">☰</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40 hidden">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">⬅️ Zurück</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter ➡️</button>
      </div>
    </main>
</div>

<div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

<script>
(function() {
  'use strict';

  /***********************
   * Config & Init
   ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c"; // Used for image uploads
  const FALLBACK_LOCATION = [51.1657, 10.4515]; // Center Germany

  let app, db, storage;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    storage = firebase.storage();
  } catch (e) {
    console.error("Firebase init error", e);
    // Error handling ...
  }

  let currentUser = null; // Will be set on auth state change
  let editingData = {};
  let step = 0;
  const stepsCount = 12; // 0..11
  let mode = "tutorial"; // "entry", "list", "tutorial", "support", "hutMessages"
  let overviewMap;
  let overviewMarker;
  let quillEditor;

  // Texts for Step 2
  const typeTexts = {
    Eierhütte: { title: "🏷️ Name der Eierhütte", question: "Wie soll deine Eierhütte heißen?" },
    Hofladen: { title: "🏷️ Name des Hofladens", question: "Wie soll dein Hofladen heißen?" },
    Selbstbedienung: { title: "🏷️ Name des SB-Hauses", question: "Wie soll dein Selbstbedienungshäuschen heißen?" },
    Spielplatz: { title: "🏷️ Name des Spielplatzes", question: "Wie soll der Spielplatz heißen?" },
    Abenteuerhof: { title: "🏷️ Name des Abenteuerhofs", question: "Wie soll dein Abenteuerhof heißen?" },
    Automat: { title: "🏷️ Name des Automaten", question: "Wie soll dein Automat heißen?" }
  };
  
  // Texts for Info Box
  const stepInfos = {
    0: { title: "Datenschutz", text: "Bitte lies die Datenschutzerklärung aufmerksam und bestätige sie." },
    1: { title: "Art der Eintragung", text: "Wähle den Typ (Eierhütte, Hofladen etc.)." },
    2: { title: "Name der Hütte", text: "Kurz, prägnant, z. B. „Eierhütte am Dorfplatz“." },
    3: { title: "Sitzplätze", text: "Gibt es Sitzgelegenheiten vor Ort?" },
    4: { title: "Strom", text: "Ist Strom für E-Bikes oder Handys verfügbar?" },
    5: { title: "Öffnungszeiten (SMART)", text: "Gib deine Öffnungszeiten pro Tag an oder wähle 'Immer geöffnet'." },
    6: { title: "Extras", text: "Besonderheiten angeben, z. B. Getränke, Kühlschrank, Grillmöglichkeiten." },
    7: { title: "Bilder / Fotos (NEU)", text: "Lade deine Fotos hier hoch. Bis zu 10 Bilder sind erlaubt." },
    8: { title: "Tiere", text: "Wähle alle Tiere aus, die es vor Ort gibt." },
    9: { title: "Beschreibung", text: "Beschreibe deinen Ort möglichst ausführlich. Der Text wird im Eintrag angezeigt." },
    10: { title: "Schlagwörter", text: "Gib Schlagwörter ein, damit andere die Hütte besser finden können (max. 10)." },
    11: { title: "Standort & Übersicht", text: "Wähle den Standort per Klick auf die Karte oder GPS. Du kannst den Marker verschieben." }
  };
    
  /***********************
   * Authentication
   ***********************/
  window.doGoogleLogin = async function() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await firebase.auth().signInWithPopup(provider);
      showToast("✅ Eingeloggt mit Google");
    } catch (e) {
      console.error("Google Login error", e);
      alert("Fehler beim Google-Login: " + e.message);
    }
  }

  window.logout = function() {
    firebase.auth().signOut();
  }

  firebase.auth().onAuthStateChanged(u => {
    if (u) {
      currentUser = u;
      document.getElementById("accountMail").textContent = u.email;
      setGoogleProfile(u);
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      // Sidebar mobil standardmäßig geschlossen halten
      document.getElementById('sidebar').classList.add('-translate-x-full');
      showTutorial();
      initHutMessagesBadge();
    } else {
      currentUser = null;
      document.getElementById("mainApp").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
      document.getElementById("question-area").innerHTML = "";
    }
  });

  function setGoogleProfile(user) {
    const picEl = document.getElementById('profilePic');
    const initEl = document.getElementById('avatarInitials');
    if (user.photoURL) {
        picEl.src = user.photoURL;
        picEl.classList.remove('hidden');
        initEl.classList.add('hidden');
    } else if (user.displayName) {
        const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    } else {
        const initials = user.email ? user.email[0].toUpperCase() : '?';
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    }
  }

  /***********************
   * Navigation & State
   ***********************/
  window.setActive = function(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) activeBtn.classList.add('active');
  }

  window.toggleSidebar = function() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }

  window.showToast = function(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }

  window.startNewEntry = function() {
    if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
    editingData = {};
    step = 0;
    mode = "entry";
    setActive('btnNewEntry');
    document.getElementById("navBottom").classList.remove("hidden");
    renderQuestion();
    toggleSidebar(); // schließt Sidebar auf Mobile
  }

  window.selectOption = function(field, value, el) {
    // deselect siblings if (el && el.parentNode) {
    el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    editingData[field] = value;
  }

  /***********************
   * Form Logic (Steps)
   ***********************/

  // --- SMARTER Öffnungszeiten Editor (aus deiner Datei übernommen) ---
  const DAY_LABELS = [
    { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" },
    { key: "mi", label: "Mittwoch" }, { key: "do", label: "Donnerstag" },
    { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" },
    { key: "so", label: "Sonntag" }
  ];

  function renderOpeningHoursEditor(data = {}) {
    let html = `<div id="openhours-editor" class="space-y-2 mt-2">
      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="immerCheck" ${data === "Immer geöffnet" ? "checked" : ""}>
        <label for="immerCheck" class="font-semibold text-green-700">Immer geöffnet (24/7)</label>
      </div>
      <table id="ohTable" class="w-full text-sm border border-gray-200 rounded overflow-hidden ${data === "Immer geöffnet" ? "hidden" : ""}">
        <thead class="bg-green-100 text-green-800"><tr>
          <th class="py-2 px-3 text-left">Tag</th>
          <th class="py-2 px-3 text-center">Geöffnet</th>
          <th class="py-2 px-3 text-center">Von</th>
          <th class="py-2 px-3 text-center">Bis</th>
        </tr></thead>
        <tbody class="divide-y">`;

    DAY_LABELS.forEach(day => {
      const d = (typeof data === 'object' && data !== null) ? (data[day.key] || {}) : {};
      const open = !!d.open;
      const from = d.from || "";
      const to = d.to || "";
      html += `<tr><td class="py-2 px-3">${day.label}</td>
        <td class="text-center">
          <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
        </td></tr>`;
    });

    html += `</tbody></table>
      <p class="text-xs text-gray-500 mt-2">Tipp: Ungewählte Tage oder leere Zeiten werden als "geschlossen" angezeigt.</p>
    </div>`;
    return html;
  }
  
  // Event Listener für Öffnungszeiten (wird nach renderQuestion() hinzugefügt)
  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("oh-open")) {
      const row = e.target.closest("tr");
      const from = row.querySelector(".oh-from");
      const to = row.querySelector(".oh-to");
      const isOpen = e.target.checked;
      from.disabled = !isOpen;
      to.disabled = !isOpen;
      if (!isOpen) { from.value = ""; to.value = ""; }
    } else if (e.target.id === "immerCheck") {
      document.getElementById("ohTable")?.classList.toggle("hidden", e.target.checked);
    }
  });

  function collectOpeningHours() {
    const immer = document.getElementById("immerCheck")?.checked;
    if (immer) { return "Immer geöffnet"; }

    const wrapper = document.getElementById(`openhours-editor`);
    if (!wrapper) return {};
    const result = {};
    DAY_LABELS.forEach(day => {
      const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
      const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
      const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
      const open = openCheckbox?.checked;
      result[day.key] = {
        open,
        from: open ? fromInput.value : "",
        to: open ? toInput.value : ""
      };
    });
    return result; // Gibt ein sauberes Objekt zurück (besser für Firestore)
  }

  // --- NEW Smarter Photo Upload Logic ---
  window.addPhotoFiles = function(files) {
    editingData.photos = editingData.photos || [];
    for(const file of files) {
      if (editingData.photos.length >= 10) {
        showToast("⚠️ Maximal 10 Fotos erlaubt.");
        break;
      }
      editingData.photos.push(file);
    }
    showGalleryFromEditingData();
  }

  function showGalleryFromEditingData() {
    const preview = document.getElementById('smartUploadPreview');
    if (!preview) return;
    preview.innerHTML = '';
    (editingData.photos || []).forEach((photo, index) => {
      const url = photo instanceof File ? URL.createObjectURL(photo) : photo.url || photo;
      const item = document.createElement('div');
      item.className = 'relative group';
      item.innerHTML = `
        <img src="${url}" class="w-24 h-24 object-cover rounded-lg shadow cursor-pointer transition" />
        <button onclick="removePhoto(${index})" class="absolute top-0 right-0 p-1 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition">✕</button>
      `;
      preview.appendChild(item);
    });
  }

  window.removePhoto = function(index) {
    if (editingData.photos && editingData.photos[index]) {
      const photo = editingData.photos[index];
      if (photo instanceof File) URL.revokeObjectURL(photo);
      editingData.photos.splice(index, 1);
      showGalleryFromEditingData();
      showToast("Foto entfernt", 1500);
    }
  }
  
  // --- Enhanced Editor Init ---
  function initEnhancedEditor(containerId, data) {
    if (quillEditor) quillEditor.destroy(); // Destroy previous instance
    quillEditor = new Quill(`#${containerId}`, {
      theme: 'snow',
      placeholder: 'Eine ausführliche Beschreibung deines Angebots...',
      modules: { toolbar: [['bold', 'italic', 'link'], [{ 'list': 'bullet' }]] }
    });
    // Set initial content
    if (data.beschreibung) {
        quillEditor.root.innerHTML = data.beschreibung;
    }
    // Update data on change
    quillEditor.on('text-change', () => {
      editingData.beschreibung = quillEditor.root.innerHTML;
    });
    editingData.beschreibung = editingData.beschreibung || quillEditor.root.innerHTML;
  }

  // --- Step Renderer ---
  window.renderQuestion = function() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
    document.getElementById("navBottom").classList.toggle("hidden", mode !== "entry");

    try {
      if (step === 0) { // Datenschutzerklärung
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-xl font-bold mb-3">🛡️ Datenschutzerklärung</h2>
          <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200">
            <iframe src="https://radlmap.net/datenschutz.html" class="w-full h-[500px] border-0 bg-white" style="display:block; min-width:100%; overflow:auto;"></iframe>
          </div>
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input id="dsCheck" type="checkbox" class="w-4 h-4" ${editingData.datenschutz ? "checked" : ""} disabled />
            Ich akzeptiere die Datenschutzerklärung
          </label>
          <div id="dsHint" class="text-xs text-red-500 mt-1">⬇️ Bitte bis ganz nach unten scrollen</div>
        </div>`;
        const scrollBox = document.getElementById("dsScrollBox");
        const check = document.getElementById("dsCheck");
        const hint = document.getElementById("dsHint");
        scrollBox.addEventListener("scroll", () => {
          if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
            check.disabled = false;
            hint.textContent = "✅ Du kannst nun die Datenschutzerklärung akzeptieren.";
            hint.classList.remove("text-red-500");
            hint.classList.add("text-green-600");
          }
        });
        return;
      }
      if (step === 1) { // Typ-Auswahl
        const opts = [
          { emoji: '🥚', label: 'Eierhütte', key: 'Eierhütte' }, { emoji: '🏪', label: 'Hofladen', key: 'Hofladen' },
          { emoji: '🏠', label: 'Selbstbedienungshäuschen', key: 'Selbstbedienung' }, { emoji: '🛝', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: '🌄', label: 'Abenteuerhof', key: 'Abenteuerhof' }, { emoji: '🍶', label: 'Automat', key: 'Automat' }
        ];
        qa.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
          ${opts.map(o => `<div class="bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer ${editingData.typ === o.key ? 'selected' : ''}" onclick="selectOption('typ','${o.key}',this)">
            <div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>
          </div>`).join('')}
        </div>`;
        return;
      }
      if (step === 2) { // Name
        const { title, question } = typeTexts[editingData.typ] || { title: "🏷️ Name", question: "Wie soll dein Eintrag heißen?" };
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">${title}</h2>
          <p class="text-sm text-gray-600 mb-2">${question}</p>
          <input id="nameInput" class="w-full border p-2 rounded" placeholder="Name eingeben" value="${editingData.name || ''}">
        </div>`;
        return;
      }
      if (step === 3) { // Sitzplätze
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">🪑 Gibt es Sitzplätze?</h2>
          <div class="flex gap-4">
            <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">✅ Ja</button>
            <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Nein' || !editingData.sitzplaetze ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">❌ Nein</button>
          </div>
        </div>`;
        return;
      }
      if (step === 4) { // Strom
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">🔌 Gibt es Strom?</h2>
          <div class="flex gap-4">
            <button class="flex-1 p-3 border rounded ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">⚡ Ja</button>
            <button class="flex-1 p-3 border rounded ${editingData.strom === 'Nein' || !editingData.strom ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">❌ Nein</button>
          </div>
        </div>`;
        return;
      }
      if (step === 5) { // Öffnungszeiten (SMART Editor)
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-3">🕒 Öffnungszeiten (Wochenplan)</h2>
          ${renderOpeningHoursEditor(editingData.oeffnungszeiten)}
        </div>`;
        return;
      }
      if (step === 6) { // Extras
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">✨ Extras (optional)</h2>
          <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. Getränke, Kühlschrank" value="${editingData.extras || ''}">
        </div>`;
        return;
      }
      if (step === 7) { // Bilder (NEW SMARTER STEP)
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-3">📸 Fotos hochladen (Max. 10)</h2>
          <div id="smartUploadZone" 
               class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center text-gray-500 cursor-pointer flex flex-col items-center justify-center"
               onclick="document.getElementById('fileInput').click()"
               ondragover="event.preventDefault(); this.style.borderColor='#10b981';"
               ondragleave="this.style.borderColor='';"
               ondrop="event.preventDefault(); this.style.borderColor=''; addPhotoFiles(event.dataTransfer.files);">
            <p class="font-semibold text-lg mb-1">Dateien hierher ziehen oder klicken</p>
            <p class="text-sm">JPEG oder PNG. Max. 10 Bilder.</p>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="addPhotoFiles(this.files)">
          </div>
          <div id="smartUploadPreview" class="mt-4 flex flex-wrap gap-3">
            </div>
        </div>`;
        showGalleryFromEditingData(); // Lade vorhandene Fotos (URLs oder File-Objekte)
        return;
      }
      if (step === 8) { // Tiere
        const animals = ["🐐 Ziege","🐄 Kuh","🐓 Huhn","🐕 Hund","🐇 Hase","🐈 Katze","Keine Tiere"];
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-3">🐾 Welche Tiere gibt es?</h2>
          <div id="tiereGrid" class="grid grid-cols-3 gap-2">
            ${animals.map(t => {
              const isSel = (editingData.tiere || []).includes(t);
              return `<button type="button" class="p-2 border rounded text-sm ${isSel ? 'selected' : ''}" data-animal="${t}">${t}</button>`;
            }).join('')}
          </div>
        </div>`;
        // Event Listener für Tiere
        document.querySelectorAll('#tiereGrid button').forEach(btn => {
          btn.onclick = () => {
            const t = btn.dataset.animal;
            editingData.tiere = editingData.tiere || [];
            if (t === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              document.querySelectorAll('#tiereGrid button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              return;
            }
            // Alle außer 'Keine Tiere'
            editingData.tiere = editingData.tiere.filter(x => x !== 'Keine Tiere');
            const idx = editingData.tiere.indexOf(t);
            if (idx >= 0) {
              editingData.tiere.splice(idx, 1);
              btn.classList.remove('selected');
            } else {
              editingData.tiere.push(t);
              btn.classList.add('selected');
            }
          };
        });
        return;
      }
      if (step === 9) { // Beschreibung
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">📝 Beschreibung</h2>
          <div id="quillContainer" class="bg-white h-48"></div>
        </div>`;
        setTimeout(() => { initEnhancedEditor("quillContainer", editingData); }, 120);
        return;
      }
      if (step === 10) { // Schlagwörter
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-2">🏷️ Schlagwörter (Komma getrennt)</h2>
          <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. Frühstück,Schattig" value="${(editingData.tags||[]).join(', ')}">
        </div>`;
        return;
      }
      if (step === 11) { // Übersicht & Standort
        mode = "list"; // Nav-Buttons ausblenden nach der Anzeige
        document.getElementById("navBottom").classList.add("hidden");

        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-xl font-bold mb-3">📋 Übersicht</h2>

          <div class="mt-3 flex items-center gap-2">
            <input type="checkbox" id="instantActive" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
            <label for="instantActive" class="text-sm font-medium text-gray-700">Sofort aktiv setzen (ohne Prüfung)</label>
          </div>
          <p class="text-xs text-red-500 mb-4">Nur für Betreiber/Admins: Eintrag wird sofort auf der Karte sichtbar.</p>

          <h3 class="text-lg font-bold mt-4 mb-2">📍 Standort</h3>
          <div class="relative mb-2">
            <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchen…" />
            <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
          </div>
          <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded">📡 Mein Standort</button>
          <div id="overview-map" class="h-64 rounded border mb-4"></div>

          <div class="flex gap-2">
            <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">✅ Einreichen</button>
            <button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">✖ Abbrechen</button>
          </div>
          <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprüft und erst nach Freigabe sichtbar.</p>
        </div>`;
        
        setTimeout(() => {
          initOverviewMap();
          document.getElementById("gpsBtn").addEventListener("click", locateGPS);
          // Hier müsste die Logik für die Adresssuche mit Nominatim/Photon implementiert werden
          // Die Adresssuche-Logik (addressSearch, suggestions etc.) ist aus Platzgründen hier weggelassen,
          // muss aber aus deiner Originaldatei in separaten Funktionen implementiert werden.
          // Beispiel: L.marker().on('click', e => overviewMarker.setLatLng(e.latlng))
        }, 120);
        return;
      }

    } catch (error) {
      console.error("Render error at step " + step, error);
      qa.innerHTML = `<div class="bg-red-100 p-4 rounded">❌ Fehler beim Laden des Schritts: ${error.message}</div>`;
    }
  }

  // --- Navigation Controls ---
  function validateAndCollectStepData(stepToValidate) {
    if (stepToValidate === 0) {
      const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked;
      if (!ok) { showToast('Bitte Datenschutzerklärung akzeptieren'); return false; }
      editingData.datenschutz = true;
    } else if (stepToValidate === 1) {
      if (!editingData.typ) { showToast("Bitte einen Typ auswählen."); return false; }
    } else if (stepToValidate === 2) {
      const v = document.getElementById('nameInput')?.value?.trim();
      if (!v) { showToast('Bitte Namen eingeben'); return false; }
      editingData.name = v;
    } else if (stepToValidate === 5) {
      const rawOeff = collectOpeningHours();
      if (rawOeff !== "Immer geöffnet" && Object.values(rawOeff).every(d => !d.open)) {
          showToast("Bitte Öffnungszeiten angeben oder 'Immer geöffnet' auswählen."); return false;
      }
      editingData.oeffnungszeiten = rawOeff;
    } else if (stepToValidate === 6) {
      editingData.extras = document.getElementById('extrasInput')?.value?.trim();
    } else if (stepToValidate === 7) {
      if ((editingData.photos || []).length === 0) { showToast("Bitte mindestens ein Foto hochladen."); return false; }
    } else if (stepToValidate === 10) {
      const raw = document.getElementById('tagsInput')?.value || '';
      editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
    }
    return true;
  }

  window.nextStep = function() {
    if (validateAndCollectStepData(step)) {
      if (step < stepsCount - 1) step++;
      renderQuestion();
    }
  }

  window.prevStep = function() {
    if (step > 0) step--;
    renderQuestion();
  }

  /***********************
   * Map & Submission
   ***********************/
  function initOverviewMap(lat = FALLBACK_LOCATION[0], lng = FALLBACK_LOCATION[1], zoom = 6) {
    if (overviewMap) overviewMap.remove(); // Vorhandene Karte entfernen
    overviewMap = L.map("overview-map").setView([lat, lng], zoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(overviewMap);

    overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap);
    overviewMarker.on("dragend", ev => {
      const p = ev.target.getLatLng();
      editingData.location = { lat: p.lat, lng: p.lng };
    });
    // Klick auf Karte setzt Marker
    overviewMap.on("click", (e) => {
        overviewMarker.setLatLng(e.latlng);
        editingData.location = { lat: e.latlng.lat, lng: e.latlng.lng };
    });

    editingData.location = { lat, lng };
  }

  window.locateGPS = function() {
    if (!navigator.geolocation) return showToast("❌ GPS nicht verfügbar");
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        initOverviewMap(latitude, longitude, 15);
        showToast("📍 Standort gefunden!", 1500);
      },
      err => { showToast("❌ GPS-Fehler: " + err.message); }
    );
  }

  // --- Image Upload Helper (Simplified for example) ---
  // In der Live-Anwendung müsste hier die Logik mit IMGBB_KEY oder Firebase Storage stehen
  async function uploadFileWithProgress(file, onProgress) {
    if (file.url) return file.url; // Already uploaded URL
    
    // Simplifizierte Mock-Antwort / Platzhalter für Firebase Storage Upload
    const storageRef = storage.ref(`uploads/${currentUser.uid}/${Date.now()}_${file.name}`);
    const snapshot = await storageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    return url;
    // return new Promise(resolve => {
    //    // Hier wäre die echte Upload-Logik
    //    console.log(`Mock-Upload: ${file.name}`);
    //    setTimeout(() => resolve(`https://placeholder.com/img/${file.name}`), 1000);
    // });
  }

  window.submitEntry = async function() {
    document.getElementById('submitBtn').disabled = true;
    showToast("📤 Sende Eintragung...");

    // 1. Fotos hochladen (wenn File-Objekte vorhanden)
    try {
      if (editingData.photos && editingData.photos.some(p => p instanceof File)) {
        const filesToUpload = editingData.photos.filter(p => p instanceof File);
        const uploadedUrls = editingData.photos.filter(p => typeof p === 'string'); // bereits hochgeladene URLs behalten
        
        for (const file of filesToUpload) {
          // Im echten Code muss hier eine Progress-Anzeige für jedes Bild
          const url = await uploadFileWithProgress(file, (pct) => { /* Update UI */ });
          uploadedUrls.push({ url: url }); // Speichere als Objekt {url: ...}
        }
        editingData.photos = uploadedUrls;
      }
    } catch(err){ 
      console.error("Foto-Upload Fehler", err); 
      showToast("❌ Fehler beim Foto-Upload");
      document.getElementById('submitBtn').disabled = false;
      return; 
    }

    // 2. Payload erstellen
    const payload = {
      userId: currentUser.uid,
      name: editingData.name,
      typ: editingData.typ,
      sitzplaetze: editingData.sitzplaetze || 'Nein',
      strom: editingData.strom || 'Nein',
      extras: editingData.extras || '',
      tiere: editingData.tiere || [],
      beschreibung: editingData.beschreibung || '',
      tags: editingData.tags || [],
      oeffnungszeiten: editingData.oeffnungszeiten,
      fotos: editingData.photos || [], // Array von { url: ... } oder strings
      status: 'offen', // Standard-Status
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      datenschutzZustimmung: { bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(), durch: currentUser.email || null }
    };

    if (editingData.location?.lat && editingData.location?.lng) {
      payload.location = new firebase.firestore.GeoPoint(editingData.location.lat, editingData.location.lng);
    }

    // 3. Admin/Instant Feature prüfen
    const instant = document.getElementById('instantActive')?.checked;
    if (instant) {
      payload.status = 'angenommen';
      payload.active = true;
      payload.pruefung = 'automatisch_aktiviert';
    }


    // 4. In Firestore speichern
    try {
      const docRef = await db.collection('eierhuetten').add(payload);
      showToast('✅ Eintragung gesendet. Wird geprüft.');
      
      // Bei Instant-Aktivierung keine weitere Aktion notwendig, da im Payload gesetzt.
      showMyEntries();
    } catch (err) {
      console.error('submitEntry error', err);
      showToast('❌ Fehler beim Senden: ' + (err.message || "Unbekannt"));
    } finally {
      document.getElementById('submitBtn').disabled = false;
    }
  }

  /***********************
   * Other Dashboard Functions (Stubs for full reconstruction)
   ***********************/
  window.showTutorial = function() {
    const qa = document.getElementById("question-area"); mode = "tutorial";
    qa.innerHTML = `<section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">...</section>`; // Original HTML hier einfügen
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }

  window.showDashboard = function() {
    const qa = document.getElementById("question-area"); mode = "dashboard";
    qa.innerHTML = `<section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">📊 Hier kommt das Dashboard hin...</section>`;
    setActive('btnDashboard');
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }

  window.showMyEntries = async function() {
    if (!currentUser) { showToast("Bitte zuerst einloggen"); return; }
    const container = document.getElementById("question-area");
    container.innerHTML = `<div class="max-w-6xl mx-auto"><h2 class="text-2xl font-bold mb-6 text-green-700">📋 Meine Eintragungen</h2><div id="entriesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`;
    const grid = document.getElementById("entriesGrid");
    grid.innerHTML = `<div class="col-span-3 text-gray-500">⏳ Lade Eintragungen…</div>`;
    // Die gesamte Lade- und Render-Logik (wie in deinem Originalcode) müsste hier rein.
    setActive('btnEntries');
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
    // ... Lade-Logik (await db.collection("eierhuetten").where("userId", "==", uid).get();)
    grid.innerHTML = `<div class="col-span-3 text-gray-500">Hier werden deine Eintragungen als Cards angezeigt.</div>`;
  }
  
  window.openSupport = function() {
    const qa = document.getElementById("question-area"); mode = "support";
    qa.innerHTML = `<section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">💬 Support-Formular...</section>`;
    setActive('btnSupport');
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }

  window.showHutMessages = function() {
    const qa = document.getElementById("question-area"); mode = "hutMessages";
    qa.innerHTML = `<section class="bg-white p-6 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">🏡 Nachrichten-Liste...</section>`;
    setActive('btnHutMessages');
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
    // Die Lade-Logik (ladeHutMessagesLive) müsste hier rein.
  }
  
  // Funktion zum Aktualisieren der Info-Box (aus deinem Originalcode übernommen)
  window.updateInfoBox = function() {
    const boxDesktop = document.getElementById("infoBox");
    const boxMobile = document.getElementById("infoBoxMobile");
    let html = "";
    const info = stepInfos[step];
    if (mode === "entry" && info) {
      html = `<h4 class="font-semibold">${info.title}</h4><p>${info.text}</p>`;
    } else if (mode === "list") { html = `<h4 class="font-semibold">📋 Meine Eintragungen</h4><p>Übersicht über deine Einträge.</p>`; }
    // ... weitere Modes ...
    else { html = `<p>ℹ️ Wähle links eine Funktion aus.</p>`; }

    if (boxDesktop) boxDesktop.innerHTML = html;
    // Der Mobile Overlay / Toggle ist im HTML vorhanden, aber die Logik hier weggelassen.
  }

  // Stubs für Events
  window.showMyEvents = () => { showToast("Events-Funktion noch nicht implementiert"); setActive('btnMyEvents'); };
  window.showCreateEvent = () => { showToast("Event erstellen noch nicht implementiert"); setActive('btnCreateEvent'); };
  
  // Stubs für Badge Logik
  window.initHutMessagesBadge = () => { /* Listener aus Originaldatei hier einfügen */ };
  
  // Start the application after all functions are defined
  if (!currentUser) {
    document.getElementById("loginScreen").classList.remove("hidden");
  } else {
     showTutorial();
  }

})();
</script>
</body>
</html>
