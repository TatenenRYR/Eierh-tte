<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap {
  height: 200px;
  z-index: 0;
}
.leaflet-container {
  z-index: 0 !important;
}
    /* Small helper for fixed bottom nav on small screens */
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; } /* space for fixed nav */
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    .sidebar-btn.active {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }
    
/* === Smarter Upload Style === */
#smartUploadZone {
  transition: all 0.25s ease;
}
#smartUploadZone:hover {
  background-color: #ecfdf5;
  border-color: #10b981;
  transform: scale(1.01);
}
#smartUploadPreview img {
  transition: all 0.25s ease;
}
#smartUploadPreview img:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}
@keyframes pulseUpload {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
.uploading::after {
  content: "‚è´";
  position: absolute;
  top: 4px; right: 4px;
  font-size: 0.8rem;
  animation: pulseUpload 1s infinite;
  color: #16a34a;
}
/* Style f√ºr das neue Dashboard */
.rounded-xl-design {
    border-radius: 1.5rem; /* 24px */
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
  </style>
</head>
<body class="bg-gray-100">
<script>window.stepInfos = window.stepInfos || [];</script>

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" 
           class="w-64 h-64 drop-shadow-lg" 
           alt="Funny Hut" />
    </div>

    <h1 class="text-3xl font-extrabold text-green-700 mb-3">
      Assistent-Dashboard
    </h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>

    <button onclick="doGoogleLogin()" 
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" 
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>

    <p class="text-xs text-gray-400 mt-6">
      üîí Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.
    </p>
  </div>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

  <div class="flex flex-col items-center mb-8">
    <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
      <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
      <span id="avatarInitials"></span>
    </div>
    <p class="text-sm text-gray-600">Angemeldet als:</p>
    <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
    <button class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform" onclick="logout()">Logout</button>
  </div>

  <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
    üåø Assistent
  </div>

  <nav class="flex flex-col gap-2 text-[15px]">
    <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      üö≤ Startseite
    </a>
    <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      üö¥‚Äç‚ôÇÔ∏è zur RadlMap
    </a>

    <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="showDashboard()">
      üìä Betreiber-Dashboard
    </button>
    <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="showMyEntries()">
      üìã Meine Eintragungen
    </button>
    <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="startNewEntry()">
      ‚ûï Neue Eintragung
    </button>

    <div class="mt-4">
      <div class="flex items-center justify-between px-3 mb-1">
        <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
      </div>

      <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
        <button id="btnMyEvents"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="showMyEvents()">
          üìÖ <span>Meine Events</span>
        </button>
        <button id="btnCreateEvent"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="showCreateEvent()">
          ‚ûï <span>Neues Event</span>
        </button>
      </div>
    </div>

    <hr class="my-3 border-gray-200">

    <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="openSupport()">
      üí¨ Support
    </button>
    <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="showHutMessages()">
      üíå H√ºtten-Nachrichten
      <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
    </button>
  </nav>

  <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
    v2.1 &middot; RadlMap Assistent
  </div>
</aside>
    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
  <div class="sticky top-4">
    <h3 class="text-lg font-bold mb-3">‚ÑπÔ∏è Hilfe & Beispiele</h3>
    <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
    <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">‚úï</button>
    <h3 class="text-lg font-bold mb-3">‚ÑπÔ∏è Hilfe & Beispiele</h3>
    <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg">
  ‚ÑπÔ∏è
</button>

<script>
  // ==========================================================
  // üíæ NAVIGATION & FLOW CONTROL HELPER (wird unten neu definiert)
  // ==========================================================
  
  function setActive(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) {
      activeBtn.classList.add('active');
    }
  }

  // Mobile Sidebar Toggle
  function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('-translate-x-full');
  }

  document.getElementById('toggleInfo').onclick = () => {
    document.getElementById('infoOverlay').classList.remove('hidden');
    // Stelle sicher, dass die InfoBoxMobile aktualisiert wird
    updateInfoBox();
  };
  document.getElementById('closeInfo').onclick = () => {
    document.getElementById('infoOverlay').classList.add('hidden');
  };
</script>


    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">‚ò∞</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">‚¨ÖÔ∏è Zur√ºck</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter ‚û°Ô∏è</button>
      </div>
    </main>
  </div>

  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  // imgbb API key (wie in Admin-Code verwendet)
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";

  // Init firebase
  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">‚ùå Firebase konnte nicht initialisiert werden. Pr√ºfe die Konfiguration in der Datei.</div>`;
  }

  let currentUser = { uid: "demo", email: "demo@example.com", displayName: "Demo" };
  firebase.auth().onAuthStateChanged(u => {
    if (u) {
      currentUser = u;
      document.getElementById("accountMail").textContent = u.email;
      
      const initials = u.email[0].toUpperCase()
      document.getElementById('avatarInitials').textContent = initials;
      if (u.photoURL) {
        document.getElementById('profilePic').src = u.photoURL;
        document.getElementById('profilePic').classList.remove('hidden');
        document.getElementById('avatarInitials').classList.add('hidden');
      } else {
        document.getElementById('profilePic').classList.add('hidden');
        document.getElementById('avatarInitials').classList.remove('hidden');
      }

      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");

      // Sidebar geschlossen halten
      document.getElementById('sidebar').classList.add('-translate-x-full');

      // Standard-Ansicht nach Login: Dashboard
      showDashboard(); 
      initHutMessagesBadge();
    } else {
      // nicht eingeloggt
      document.getElementById("mainApp").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
      document.getElementById("question-area").innerHTML = "";
    }
  });

  async function doGoogleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await firebase.auth().signInWithPopup(provider);
      showToast("‚úÖ Eingeloggt mit Google");
    } catch (e) {
      console.error("Google Login error", e);
      alert("Fehler beim Google-Login: " + e.message);
    }
  }

  function logout() {
    firebase.auth().signOut();
  }
  
  let mode = "dashboard"; // "entry" oder "list" oder "dashboard"
  /***********************
   * State & steps
   ***********************/
  let editingData = {};
  let step = 0;
  const stepsCount = 11; // 0..10

  // Quill Editor Instanz (muss global sein)
  let quill;
  
  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }
  
  // ==========================================================
  // üïí √ñffnungszeiten Editor
  // ==========================================================

  const DAY_LABELS = [
    { key: "mo", label: "Montag" },
    { key: "di", label: "Dienstag" },
    { key: "mi", label: "Mittwoch" },
    { key: "do", label: "Donnerstag" },
    { key: "fr", label: "Freitag" },
    { key: "sa", label: "Samstag" },
    { key: "so", label: "Sonntag" }
  ];

  function renderOpeningHoursEditor(hutId, data = {}) {
    let html = `
      <div id="openhours-${hutId}" class="space-y-2 mt-2">
        <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
          <thead class="bg-green-100 text-green-800">
            <tr>
              <th class="py-2 px-3 text-left">Tag</th>
              <th class="py-2 px-3 text-center">Ge√∂ffnet</th>
              <th class="py-2 px-3 text-center">Von</th>
              <th class="py-2 px-3 text-center">Bis</th>
            </tr>
          </thead>
          <tbody class="divide-y">
    `;

    DAY_LABELS.forEach(day => {
      const d = data[day.key] || {};
      const open = !!d.open;
      const from = d.from || "";
      const to = d.to || "";
      html += `
        <tr>
          <td class="py-2 px-3">${day.label}</td>
          <td class="text-center">
            <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
          </td>
          <td class="text-center">
            <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
          </td>
          <td class="text-center">
            <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
          </td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
        <p class="text-xs text-gray-500">Tipp: Wenn du keine Zeiten f√ºr einen ge√∂ffneten Tag eintr√§gst, wird "geschlossen" angezeigt.</p>
      </div>
    `;
    return html;
  }

  function collectOpeningHours(hutId) {
    const wrapper = document.getElementById(`openhours-${hutId}`);
    if (!wrapper) return {};
    const result = {};
    DAY_LABELS.forEach(day => {
      const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
      const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
      const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
      const open = openCheckbox.checked;
      result[day.key] = {
        open,
        from: open ? fromInput.value : "",
        to: open ? toInput.value : ""
      };
    });
    return result;
  }

  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("oh-open")) {
      const row = e.target.closest("tr");
      const from = row.querySelector(".oh-from");
      const to = row.querySelector(".oh-to");
      const isOpen = e.target.checked;
      from.disabled = !isOpen;
      to.disabled = !isOpen;
      // Bei Deaktivierung Felder leeren
      if (!isOpen) {
        from.value = "";
        to.value = "";
      }
    }
  });


  // ==========================================================
  // üìä BETREIBER-DASHBOARD & ABO K√úNDIGEN 
  // ==========================================================

  async function showDashboard() {
    setActive('btnDashboard');
    mode = "dashboard";
    const qa = document.getElementById("question-area");
    qa.innerHTML = `<div class="text-center text-gray-500 mt-10">‚è≥ Lade Dashboard...</div>`;
    document.getElementById("navBottom").style.display = "none";
    document.getElementById("infoBox").innerHTML = `
      <p>Das Dashboard bietet dir einen schnellen √úberblick √ºber deine Eintragungen und Events.</p>
      <p class="mt-3 font-semibold">Premium-Status verwalten</p>
      <p>Hier kannst du deinen aktuellen Premium-Status sehen und dein Abonnement k√ºndigen, falls du es nicht mehr ben√∂tigst.</p>
      `;

    const user = firebase.auth().currentUser;
    if (!user) {
      qa.innerHTML = `<div class="text-center bg-red-100 p-4 rounded-xl max-w-lg mx-auto mt-10">‚ö†Ô∏è Bitte melde dich an, um das Dashboard zu sehen.</div>`;
      return;
    }

    const doc = await db.collection("betreiber").doc(user.uid).get();
    const data = doc.data() || {};
    const isPremium = !!data.premium;

    let premiumStatusHtml = '';
    if (isPremium) {
      const untilDate = data.premium_until ? new Date(data.premium_until).toLocaleDateString("de-DE") : 'unbegrenzt';
      premiumStatusHtml = `
        <div class="bg-green-50 border border-green-300 p-4 rounded-xl-design">
          <h3 class="text-xl font-bold text-green-700 mb-2">‚ú® Premium Aktiv</h3>
          <p class="text-sm text-gray-600">Dein Premium-Status ist aktiv ${data.premium_until ? `bis zum ${untilDate}` : ''}.</p>
          <button onclick="cancelPremium()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition">
            ‚ùå Abo k√ºndigen
          </button>
        </div>
      `;
    } else {
      premiumStatusHtml = `
        <div class="bg-yellow-50 border border-yellow-300 p-4 rounded-xl-design">
          <h3 class="text-xl font-bold text-yellow-700 mb-2">‚≠ê Kostenlos</h3>
          <p class="text-sm text-gray-600">Upgrade auf Premium, um alle Funktionen freizuschalten.</p>
          <button onclick="showPremiumUpgrade()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
            Premium aktivieren
          </button>
        </div>
      `;
    }

    qa.innerHTML = `
      <section class="max-w-4xl mx-auto space-y-6 animate-fadeIn">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6">üìä Betreiber-Dashboard</h2>
        
        ${premiumStatusHtml}

        <div id="statsArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          <div class="bg-white p-5 rounded-xl-design">
            <p class="text-xs font-semibold text-gray-500">Meine Eintragungen</p>
            <p id="stat-entries" class="text-3xl font-bold text-green-600 mt-1">...</p>
          </div>
          <div class="bg-white p-5 rounded-xl-design">
            <p class="text-xs font-semibold text-gray-500">Aktive Events</p>
            <p id="stat-events" class="text-3xl font-bold text-green-600 mt-1">...</p>
          </div>
          <div class="bg-white p-5 rounded-xl-design">
            <p class="text-xs font-semibold text-gray-500">Ungelesene Nachrichten</p>
            <p id="stat-messages" class="text-3xl font-bold text-green-600 mt-1">...</p>
          </div>
        </div>

        <div id="quickLinks" class="pt-4 border-t">
          <h3 class="text-xl font-bold text-gray-700 mb-3">Schnellzugriff</h3>
          <div class="flex flex-wrap gap-4">
            <button onclick="showMyEntries()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">üìã Eintragungen verwalten</button>
            <button onclick="startNewEntry()" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition">‚ûï Neue Eintragung</button>
            <button onclick="showMyEvents()" class="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-xl hover:bg-purple-600 transition">üìÖ Events</button>
          </div>
        </div>
      </section>
    `;

    // Daten laden (Statistiken)
    const entriesSnap = await db.collection("eierhuetten").where("userId", "==", user.uid).get();
    document.getElementById('stat-entries').textContent = entriesSnap.size;
    
    // Nachrichten und Events m√ºssen separat geladen werden
    document.getElementById('stat-messages').textContent = '0'; // Platzhalter
    document.getElementById('stat-events').textContent = '0'; // Platzhalter
  }

  // ABO K√úNDIGEN Funktion (FIX)
  async function cancelPremium() {
    const user = firebase.auth().currentUser;
    if (!user) return alert("Bitte einloggen.");
    if (!confirm("M√∂chtest du dein Premium wirklich k√ºndigen? Du verlierst dann die Premium-Vorteile!")) return;
    
    // Setzt Premium-Status in Firestore zur√ºck
    await db.collection("betreiber").doc(user.uid).update({ 
      premium: false, 
      premium_until: null 
    }); 
    
    showToast("‚ùå Dein Premium wurde erfolgreich gek√ºndigt.");
    showDashboard(); // Dashboard neu laden
  }

  // Premium Upgrade Screen (rekonstruiert)
  function showPremiumUpgrade() { 
    const qa = document.getElementById("question-area"); 
    qa.innerHTML = ` 
      <section class="bg-white p-6 rounded-xl shadow max-w-xl mx-auto animate-fadeIn"> 
        <h2 class="text-2xl font-bold mb-4">üåü Unterst√ºtzer werden</h2> 
        <p class="text-gray-700 mb-4">Mit RadlMap Premium erh√§ltst du:</p> 
        <ul class="list-disc list-inside mb-6 text-gray-700"> 
          <li>üîù Hervorgehobene Anzeige auf der Karte</li> 
          <li>üì∏ Bis zu 10 Fotos hochladen</li> 
          <li>üìà Erweiterte Statistiken</li> 
          <li>üí¨ Kontaktm√∂glichkeiten in deinem Eintrag</li> 
        </ul> 
        <p class="font-semibold mb-4">Preis: <span class="text-green-700">2,00 ‚Ç¨/Monat</span></p> 
        <button id="activatePremiumBtn" onclick="activatePremium()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"> ‚úÖ Jetzt Premium aktivieren (Test) </button> 
        <button class="w-full mt-4 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition" onclick="showDashboard()" > üîô Zur√ºck </button> 
      </section> `; 
  }
  
  // Dummy-Funktion f√ºr activatePremium (muss f√ºr Live-Betrieb Stripe-Anbindung erhalten)
  async function activatePremium() {
    const user = firebase.auth().currentUser;
    if (!user) return alert("Bitte einloggen.");
    alert("‚úÖ Test: Premium wurde aktiviert (ohne Stripe). Bitte im Live-Betrieb Stripe integrieren.");
    const until = new Date(Date.now() + 30*24*60*60*1000); // +30 Tage
    await db.collection("betreiber").doc(user.uid).set({ 
      premium: true, 
      premium_until: until.toISOString() 
    }, { merge: true }); 
    showDashboard();
  }


  // ==========================================================
  // üß† KI-Logik f√ºr Smartere Eintragung 
  // ==========================================================
  
  // KI Text Generator (aus Snippet √ºbernommen)
  async function generateSmartDescription(hutName, extras = [], animals = [], photos = []) { 
    const name = hutName || "Der Hofladen";
    const kiExtras = extras.length ? `Hier gibt es zus√§tzlich: ${extras.join(", ")}.` : "";
    const tiere = animals.length ? `Begegnungen mit Tieren wie ${animals.join(" und ")} runden den Besuch ab.` : "";

    let fotosTxt = "";
    // Sicherstellen, dass photos ein Array von Objekten mit title ist, oder leere titles
    const photoTitles = photos.map(p => typeof p === 'object' && p.title ? p.title : null).filter(t => t); 
    if (photoTitles.length === 1) fotosTxt = `Ein Bild zeigt ${photoTitles[0]}.`;
    else if (photoTitles.length === 2) fotosTxt = `Die Fotos zeigen ${photoTitles[0]} und ${photoTitles[1]}.`;
    else if (photoTitles.length > 2) { 
        const last = photoTitles.pop(); 
        fotosTxt = `Die Bilder fangen die Stimmung ein ‚Äì ${photoTitles.join(", ")} und ${last}.`; 
    }
    
    const tone = ["idyllisch", "einladend", "authentisch", "malerisch"][ Math.floor(Math.random() * 4) ];
    const landschaft = ["gr√ºnen Wiesen", "alten Obstb√§umen", "sanften H√ºgeln", "weiten Feldern"][ Math.floor(Math.random() * 4) ];
    const endungen = [
      "Ein Ort, der Ruhe und Natur vereint.", 
      "Perfekt f√ºr eine kleine Auszeit vom Alltag.", 
      "Hier sp√ºrt man die l√§ndliche Gelassenheit.",
    ];
    
    const text = `
      ${name} ist ein ${tone}er Ort, eingebettet zwischen ${landschaft}. 
      ${kiExtras} 
      ${tiere} 
      ${fotosTxt} 
      ${endungen[Math.floor(Math.random() * endungen.length)]}
    `;
    
    await new Promise((res) => setTimeout(res, 300 + Math.random() * 300)); // Simuliere Wartezeit
    return text.trim().replace(/\s+/g, " ");
  }
  
  // ==========================================================
  // üìã ENTRY MANAGEMENT (NEU)
  // ==========================================================

  async function showMyEntries() {
    setActive('btnEntries');
    mode = "list";
    const qa = document.getElementById("question-area");
    qa.innerHTML = `<div class="text-center text-gray-500 mt-10">‚è≥ Lade deine Eintragungen...</div>`;
    document.getElementById("navBottom").style.display = "none";
    document.getElementById("infoBox").innerHTML = `
        <p>Hier siehst du alle von dir erstellten Eintr√§ge. Du kannst sie bearbeiten oder l√∂schen.</p>
        <p class="mt-3">Status-Erkl√§rung:</p>
        <ul class="list-disc list-inside ml-4">
            <li><span class="text-yellow-600">Offen</span>: Eintrag wurde eingereicht und wartet auf die Freischaltung durch das Admin-Team.</li>
            <li><span class="text-green-600">Aktiv</span>: Eintrag ist auf der Karte sichtbar.</li>
            <li><span class="text-red-600">Abgelehnt</span>: Eintrag wurde nicht freigeschaltet (ggf. Support kontaktieren).</li>
        </ul>
    `;
    
    const user = firebase.auth().currentUser;
    if (!user) {
        qa.innerHTML = `<div class="text-center bg-red-100 p-4 rounded-xl max-w-lg mx-auto mt-10">‚ö†Ô∏è Bitte melde dich an.</div>`;
        return;
    }

    try {
        const snapshot = await db.collection("eierhuetten")
            .where("userId", "==", user.uid)
            .orderBy("erstelltAm", "desc")
            .get();

        if (snapshot.empty) {
            qa.innerHTML = `
                <section class="max-w-4xl mx-auto space-y-6 mt-10 p-6 bg-white rounded-xl-design text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Du hast noch keine Eintr√§ge</h2>
                    <p class="text-gray-600">Klicke auf "Neue Eintragung", um loszulegen.</p>
                    <button onclick="startNewEntry()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
                        ‚ûï Neue Eintragung
                    </button>
                </section>
            `;
            return;
        }

        let listHtml = `
            <section class="max-w-5xl mx-auto space-y-6 mt-6">
                <h2 class="text-3xl font-extrabold text-gray-800">üìã Meine Eintragungen</h2>
                <div class="bg-white p-6 rounded-xl-design shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Typ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="entriesTableBody" class="bg-white divide-y divide-gray-200">
        `;
        
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            const id = doc.id;
            const statusColor = data.status === 'aktiv' ? 'text-green-600' : (data.status === 'offen' ? 'text-yellow-600' : 'text-red-600');
            const statusText = data.status === 'aktiv' ? 'Aktiv' : (data.status === 'offen' ? 'Offen (Wartet)' : 'Abgelehnt');

            listHtml += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name || 'Ohne Name'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.typ || 'Unbekannt'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor} font-semibold">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editEntry('${id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Bearbeiten</button>
                        <button onclick="deleteEntry('${id}', '${data.name}')" class="text-red-600 hover:text-red-900">L√∂schen</button>
                    </td>
                </tr>
            `;
        });

        listHtml += `
                        </tbody>
                    </table>
                </div>
            </section>
        `;
        qa.innerHTML = listHtml;

    } catch (e) {
        console.error("Fehler beim Laden der Eintr√§ge:", e);
        qa.innerHTML = `<div class="text-center bg-red-100 p-4 rounded-xl max-w-lg mx-auto mt-10">‚ùå Fehler beim Laden der Eintr√§ge.</div>`;
    }
}

async function editEntry(hutId) {
    showToast(`‚è≥ Lade Eintrag ${hutId}...`);
    try {
        const doc = await db.collection("eierhuetten").doc(hutId).get();
        if (!doc.exists) {
            showToast("‚ùå Eintrag nicht gefunden.");
            showMyEntries();
            return;
        }

        // Lade Daten in den Bearbeitungszustand
        editingData = doc.data();
        editingData.docId = hutId; // Speichere die ID f√ºr das Speichern
        
        // √ñffnungszeiten-Array in Map umwandeln, falls Array vorhanden (f√ºr Bearbeitungs-Editor)
        if (Array.isArray(editingData.oeffnungszeiten)) {
            const ohMap = {};
            DAY_LABELS.forEach(day => {
                const found = editingData.oeffnungszeiten.find(d => d.tag === day.label);
                ohMap[day.key] = {
                    open: !!found,
                    from: found ? found.von : "",
                    to: found ? found.bis : ""
                };
            });
            editingData.oeffnungszeiten = ohMap;
        }

        mode = "entry";
        step = 1; // Starte bei Typ-Auswahl (Datenschutz gilt als akzeptiert)
        showToast(`‚úèÔ∏è Bearbeite: ${editingData.name}`);
        renderQuestion();
        
    } catch (e) {
        console.error("Fehler beim Bearbeiten:", e);
        showToast("‚ùå Fehler beim Laden des Eintrags.");
    }
}

async function deleteEntry(hutId, hutName) {
    if (!confirm(`M√∂chtest du den Eintrag "${hutName}" wirklich unwiderruflich l√∂schen?`)) {
        return;
    }

    try {
        // Firestore l√∂schen
        await db.collection("eierhuetten").doc(hutId).delete();
        showToast(`üóëÔ∏è Eintrag "${hutName}" erfolgreich gel√∂scht.`);
        showMyEntries(); // Liste neu laden
    } catch (e) {
        console.error("Fehler beim L√∂schen:", e);
        showToast("‚ùå Fehler beim L√∂schen des Eintrags.");
    }
}
  
  // ==========================================================
  // üìù NAVIGATION & FLOW CONTROL 
  // ==========================================================

  function nextStep() {
    if (saveStepData()) {
      if (step < stepsCount - 1) {
        step++;
        renderQuestion();
      } else {
        // Letzter Schritt
        if (step === stepsCount - 1) {
             // Der "Einreichen" Button in Step 10 ruft submitEntry() auf, 
             // der hier nicht von nextStep() √ºbersprungen werden soll.
        }
      }
    }
  }

  function prevStep() {
    if (step > 0) {
      step--;
      renderQuestion();
    }
  }

  function startNewEntry() {
    setActive('btnNewEntry');
    mode = "entry";
    editingData = {}; // Neuen Eintrag starten
    step = 0;
    renderQuestion();
  }

  // Platzhalter f√ºr Funktionen
  function showTutorial() { showDashboard(); } 
  function showMyEvents() { 
      setActive('btnMyEvents'); 
      mode = "events"; 
      document.getElementById("question-area").innerHTML = `<div class="p-6 text-center">üìÖ √úbersicht deiner Events (Premium-Funktion/Platzhalter).</div>`; 
      updateInfoBox();
  }
  function showCreateEvent() { 
      setActive('btnCreateEvent'); 
      mode = "createEvent"; 
      document.getElementById("question-area").innerHTML = `<div class="p-6 text-center">‚ûï Event erstellen (Premium-Funktion/Platzhalter).</div>`; 
      updateInfoBox();
  }
  function openSupport() {
      setActive('btnSupport');
      mode = "support";
      document.getElementById("question-area").innerHTML = `<div class="p-6 text-center">üí¨ Support-Formular (Platzhalter).</div>`; 
      updateInfoBox();
  }
  function initHutMessagesBadge() {
    // Dummy-Funktion
  }
  function showHutMessages() {
      setActive('btnHutMessages');
      mode = "hutMessages";
      document.getElementById("question-area").innerHTML = `<div class="p-6 text-center">üíå H√ºtten-Nachrichten (Platzhalter).</div>`;
      updateInfoBox();
  }
  
  // ==========================================================
  // üíæ SAVE DATA LOGIC 
  // ==========================================================

  function saveStepData() {
    const nextBtn = document.getElementById('nextBtn');
    if(nextBtn) nextBtn.disabled = false; // Reset

    // Datenschutzerkl√§rung
    if (step === 0) {
      const check = document.getElementById('dsCheck');
      if (!check || !check.checked) {
        showToast("‚ö†Ô∏è Bitte akzeptiere zuerst die Datenschutzerkl√§rung.");
        return false;
      }
      return true; // OK
    }

    // Typ-Auswahl
    if (step === 1) {
      if (!editingData.typ) {
        showToast("‚ö†Ô∏è Bitte w√§hle einen Typ aus.");
        return false;
      }
      return true;
    }
    
    // Name
    if (step === 2) {
      const name = document.getElementById('nameInput')?.value.trim();
      if (!name) {
        showToast("‚ö†Ô∏è Bitte gib einen Namen ein.");
        return false;
      }
      editingData.name = name;
      return true;
    }

    // Sitzpl√§tze
    if (step === 3) {
      // Pr√ºft, ob Sitzpl√§tze gesetzt sind, entweder √ºber Button-Klick oder bereits in editingData (beim Editieren)
      if (!editingData.sitzplaetze) {
        showToast("‚ö†Ô∏è Bitte w√§hle eine Option aus.");
        return false;
      }
      return true;
    }

    // Strom
    if (step === 4) {
      if (!editingData.strom) {
        showToast("‚ö†Ô∏è Bitte w√§hle eine Option aus.");
        return false;
      }
      return true;
    }

    // √ñffnungszeiten
    if (step === 5) {
        const oh = collectOpeningHours('current');
        const hasOpenDayWithMissingTime = Object.values(oh).some(d => d.open && (!d.from || !d.to));
        const allClosed = Object.values(oh).every(d => !d.open);
        
        if (allClosed) {
            if (!confirm("Du hast alle Tage als geschlossen markiert. Fortfahren?")) {
                return false;
            }
        } else if (hasOpenDayWithMissingTime) {
             showToast("‚ö†Ô∏è Unvollst√§ndige √ñffnungszeiten. Bitte trage alle Von-/Bis-Zeiten f√ºr ge√∂ffnete Tage ein.");
             return false;
        }
        editingData.oeffnungszeiten = oh;
        return true;
    }

    // Extras
    if (step === 6) {
      const extras = document.getElementById('extrasInput')?.value.trim();
      editingData.extras = extras ? extras.split(',').map(s => s.trim()).filter(Boolean) : [];
      return true;
    }

    // Tiere
    if (step === 7) {
      if (!editingData.tiere || editingData.tiere.length === 0) {
         // Erlaubt das Weitergehen, wenn keine Tiere ausgew√§hlt sind
         // Optional: showToast("‚ö†Ô∏è Bitte w√§hle mindestens eine Option f√ºr Tiere aus."); return false;
         editingData.tiere = ['Keine Tiere']; // Standardm√§√üig "Keine Tiere" speichern, wenn nichts gew√§hlt.
      }
      return true;
    }

    // Beschreibung (Quill)
    if (step === 8) {
      if (quill) {
        const html = quill.root.innerHTML;
        editingData.beschreibung = html;
        if (quill.getText().trim().length < 10) {
          showToast("‚ö†Ô∏è Bitte gib eine aussagekr√§ftige Beschreibung (mind. 10 Zeichen) ein.");
          return false;
        }
      }
      return true;
    }

    // Tags
    if (step === 9) {
      const tags = document.getElementById('tagsInput')?.value.trim();
      editingData.tags = tags ? tags.split(',').map(s => s.trim()).filter(Boolean) : [];
      return true;
    }

    // Standort
    if (step === 10) {
      if (!editingData.lat || !editingData.lng) {
        showToast("‚ö†Ô∏è Bitte w√§hle den Standort auf der Karte aus.");
        return false;
      }
      // Daten sind bereits in editingData.lat/lng gespeichert
      return true;
    }

    return true; // Default
  }

  function selectOption(key, value, element) {
    editingData[key] = value;
    document.querySelectorAll(`button`).forEach(btn => {
      if (btn.parentNode === element.parentNode) {
        btn.classList.remove('selected');
      }
    });
    element.classList.add('selected');
  }

  // ==========================================================
  // üñºÔ∏è HELPER FUNKTIONEN (Info Box / Map)
  // ==========================================================
  
  function updateInfoBox() {
    const stepInfos = {
        0: { title: "Datenschutzerkl√§rung", text: "Bitte lies dir die Datenschutzerkl√§rung aufmerksam durch, scrolle bis zum Ende und akzeptiere sie, um fortzufahren." },
        1: { title: "Typ ausw√§hlen", text: "W√§hle den Typ deiner Eintragung (z.B. Eierh√ºtte oder Hofladen)." },
        2: { title: "Name", text: "Gib einen aussagekr√§ftigen Namen f√ºr deine Eintragung ein." },
        3: { title: "Sitzpl√§tze", text: "Gibt es Sitzm√∂glichkeiten, z.B. eine Bank oder eine kleine Sitzgruppe?" },
        4: { title: "Strom", text: "Ist vor Ort Strom f√ºr Besucher verf√ºgbar? (z.B. Ladem√∂glichkeit f√ºr E-Bikes)" },
        5: { title: "√ñffnungszeiten", text: "W√§hle 'Immer ge√∂ffnet' oder gib die √ñffnungszeiten f√ºr jeden Wochentag an." },
        6: { title: "Extras", text: "Was macht deinen Ort besonders? (z.B. Spielplatz, Kaffee, Grillplatz) Gib sie mit Kommas getrennt ein." },
        7: { title: "Tiere", text: "Welche Tiere k√∂nnen Besucher auf deinem Hof sehen? Mehrfachauswahl m√∂glich." },
        8: { title: "Beschreibung (NEU: KI-Text)", text: "Erstelle eine einladende Beschreibung. Nutze den 'ü™Ñ KI-Text generieren' Button, um automatisch einen Text zu erstellen." },
        9: { title: "Schlagw√∂rter", text: "Gib Schlagw√∂rter ein, damit deine Eintragung besser gefunden wird (z.B. #regional, #Bio) ‚Äì Komma-getrennt." },
        10: { title: "Standort & Einreichen", text: "W√§hle den genauen Standort auf der Karte. Du kannst den Marker verschieben oder die Adresse suchen. Danach kannst du den Eintrag einreichen." }
    };
    const boxDesktop = document.getElementById("infoBox");
    const boxMobile = document.getElementById("infoBoxMobile");
    const info = stepInfos[step]; 
    if (info && boxDesktop) { 
        const html = `<h4 class="font-semibold">${info.title}</h4> <p>${info.text}</p>`; 
        boxDesktop.innerHTML = html; 
        if(boxMobile) boxMobile.innerHTML = html;
    }
  }

  let map, marker;
  function initOverviewMap(lat = editingData.lat || 51.5, lng = editingData.lng || 10.5, zoom = editingData.lat ? 16 : 6) {
    if (map) map.remove();

    map = L.map("overview-map", { attributionControl: false, zoomControl: true })
      .setView([lat, lng], zoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    marker = L.marker([lat, lng], { draggable: true }).addTo(map)
      .bindPopup(editingData.name || "Standort")
      .openPopup();

    editingData.lat = lat;
    editingData.lng = lng;

    marker.on('dragend', (e) => {
      const { lat, lng } = e.target.getLatLng();
      editingData.lat = lat;
      editingData.lng = lng;
      showToast(`üìç Neuer Standort: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
    });
  }

  function locateGPS() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        initOverviewMap(latitude, longitude, 16);
        showToast("üìç Standort gefunden!");
      }, error => {
        showToast("‚ùå GPS Fehler: " + error.message);
      });
    } else {
      showToast("‚ùå Dein Browser unterst√ºtzt kein GPS.");
    }
  }
  
  async function submitEntry() {
    if (!saveStepData()) return;
    
    // Konvertiere die √ñffnungszeiten-Map in ein Array f√ºr Firestore
    let finalOeffnungszeiten = [];
    if (editingData.oeffnungszeiten) {
      for (const key in editingData.oeffnungszeiten) {
        const day = DAY_LABELS.find(d => d.key === key);
        if (day && editingData.oeffnungszeiten[key].open && editingData.oeffnungszeiten[key].from && editingData.oeffnungszeiten[key].to) {
          finalOeffnungszeiten.push({
            tag: day.label,
            von: editingData.oeffnungszeiten[key].from,
            bis: editingData.oeffnungszeiten[key].to
          });
        }
      }
    }
    
    const docId = editingData.docId; // Hole die ID, falls vorhanden
    
    const finalEntry = {
      ...editingData,
      oeffnungszeiten: finalOeffnungszeiten.length > 0 ? finalOeffnungszeiten : "Geschlossen", // Firestore-Format
      userId: firebase.auth().currentUser.uid,
      userName: firebase.auth().currentUser.displayName,
      
      // Nur erstellen/updaten, wenn es ein neuer Eintrag ist
      ...(docId ? { 
          aktualisiertAm: firebase.firestore.FieldValue.serverTimestamp() 
      } : { 
          erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'offen', // Neuer Eintrag beginnt immer mit 'offen'
      }),
    };
    
    delete finalEntry.docId; // docId nicht in die DB speichern

    try {
      if (docId) {
        // Eintrag aktualisieren
        // Der Status soll beim Bearbeiten nicht √ºberschrieben werden, wenn er bereits 'aktiv' war.
        await db.collection("eierhuetten").doc(docId).update(finalEntry);
        showToast(`‚úÖ Eintrag "${finalEntry.name}" erfolgreich aktualisiert!`);
      } else {
        // Neuen Eintrag speichern
        await db.collection("eierhuetten").add(finalEntry);
        showToast("üéâ Eintrag erfolgreich eingereicht! Er wird nun gepr√ºft.");
      }
      
      editingData = {}; // Zustand zur√ºcksetzen
      showMyEntries(); // Zur √úbersicht wechseln
    } catch (e) {
      console.error("Firestore Save/Update Error", e);
      alert("‚ùå Fehler beim Speichern des Eintrags: " + e.message);
    }
  }

  // ==========================================================
  // üìù Render Flow (Fragen / Schritte) - UPDATED
  // ==========================================================
  
  // Texte f√ºr Step 2 je nach Typ
  const typeTexts = {
    Eierh√ºtte: { title: "üè∑Ô∏è Name der Eierh√ºtte", question: "Wie soll deine Eierh√ºtte hei√üen?" },
    Hofladen: { title: "üè∑Ô∏è Name des Hofladens", question: "Wie soll dein Hofladen hei√üen?" },
    Selbstbedienung: { title: "üè∑Ô∏è Name des Selbstbedienungsh√§uschens", question: "Wie soll dein Selbstbedienungsh√§uschen hei√üen?" },
    Spielplatz: { title: "üè∑Ô∏è Name des Spielplatzes", question: "Wie soll der Spielplatz hei√üen?" },
    Abenteuerhof: { title: "üè∑Ô∏è Name des Abenteuerhofs", question: "Wie soll dein Abenteuerhof hei√üen?" },
    Automat: { title: "üè∑Ô∏è Name des Automaten", question: "Wie soll dein Automat hei√üen?" }
  };
  
  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
    
    // Navigationsleiste nur im 'entry' Modus anzeigen
    document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";
    
    // Den "Weiter" Button beschriften, falls es der letzte Schritt ist
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
        nextBtn.textContent = (step === stepsCount - 1) ? '√úbersicht anzeigen' : 'Weiter ‚û°Ô∏è';
    }
        
    try {
      if (step === 0) {
        // Bessere Datenschutzerkl√§rung
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl-design max-w-2xl mx-auto">
            <h2 class="text-3xl font-extrabold text-green-700 mb-4">üõ°Ô∏è Datenschutzerkl√§rung</h2>

            <p class="mb-4 text-gray-700">Bitte lies die folgenden Bestimmungen aufmerksam durch und scrolle bis zum Ende, um sie zu akzeptieren.</p>
            
            <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-y-scroll border-2 border-green-200 bg-gray-50 p-4 text-sm text-gray-700 shadow-inner">
              <p class="font-bold text-red-600 mb-3">ACHTUNG: PLATZHALTER!</p>
              <p>Dieser Mustertext MUSS durch Ihren vollst√§ndigen und rechtsg√ºltigen Datenschutztext ersetzt werden. Bitte konsultieren Sie einen Anwalt, um sicherzustellen, dass Ihr Text den aktuellen Datenschutzbestimmungen (insbesondere der DSGVO) entspricht.</p>
              
              <h4 class="font-bold mt-4">1. Grunds√§tzliches</h4>
              <p>Wir erheben und verarbeiten personenbezogene Daten ausschlie√ülich gem√§√ü den gesetzlichen Bestimmungen. Bei der Nutzung des Assistenten werden zur Identifikation Ihre E-Mail-Adresse und ggf. Ihr Name von Google (Firebase Auth) √ºbermittelt.</p>
              
              <h4 class="font-bold mt-4">2. Datenverwendung</h4>
              <p>Die von Ihnen erstellten Eintragungen (Name der H√ºtte, Standort, Fotos) werden auf der RadlMap-Webseite ver√∂ffentlicht. Ihre pers√∂nlichen Kontaktdaten (E-Mail) werden nicht ver√∂ffentlicht, sondern dienen nur der Verwaltung und der Kontaktaufnahme durch das RadlMap-Team.</p>

              <h4 class="font-bold mt-4">3. L√∂schung</h4>
              <p>Sie k√∂nnen jederzeit die L√∂schung Ihres Kontos und aller damit verbundenen Eintragungen beim Support beantragen.</p>

              <p class="mt-8 font-bold text-green-600">ENDE DES MUSTERTEXTES. BITTE VOR NUTZUNG ANPASSEN!</p>
            </div>
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input id="dsCheck" type="checkbox" class="w-4 h-4 text-green-600" ${document.getElementById('dsCheck')?.checked || editingData.docId ? 'checked' : ''} disabled /> 
              Ich akzeptiere die Datenschutzerkl√§rung
            </label>
            <div id="dsHint" class="text-xs text-red-500 mt-1">
              ‚¨áÔ∏è Bitte bis ganz nach unten scrollen und das K√§stchen aktivieren
            </div>
          </div>`;

        // Scroll-√úberwachung (Nur wenn nicht bereits akzeptiert)
        const scrollBox = document.getElementById("dsScrollBox");
        const check = document.getElementById("dsCheck");
        const hint = document.getElementById("dsHint");

        if (!editingData.docId) { // Bei neuer Eintragung scrollen lassen
            scrollBox.addEventListener("scroll", () => {
              if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
                check.disabled = false;
                hint.textContent = "‚úÖ Du kannst nun die Datenschutzerkl√§rung akzeptieren und fortfahren.";
                hint.classList.remove("text-red-500");
                hint.classList.add("text-green-600");
              }
            });
        } else { // Beim Editieren automatisch als akzeptiert markieren
             check.disabled = false;
             hint.textContent = "‚úÖ Datenschutzerkl√§rung ist bereits akzeptiert.";
             hint.classList.remove("text-red-500");
             hint.classList.add("text-green-600");
        }
        return;
      }

      if (step === 1) {
        // Typ-Auswahl
        const opts = [
          { emoji: 'ü•ö', label: 'Eierh√ºtte', key: 'Eierh√ºtte' },
          { emoji: 'üè™', label: 'Hofladen', key: 'Hofladen' },
          { emoji: 'üè†', label: 'Selbstbedienungsh√§uschen', key: 'Selbstbedienung' },
          { emoji: 'üõù', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: 'üåÑ', label: 'Abenteuerhof', key: 'Abenteuerhof' },
          { emoji: 'üç∂', label: 'Automat', key: 'Automat' }
        ];
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto';
        
        qa.innerHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto"><h2 class="text-lg font-bold mb-3">Typ ausw√§hlen</h2><div id="typeOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>`;
        const holder = document.getElementById('typeOptions');

        opts.forEach(o => {
          const card = document.createElement('div');
          const isSelected = editingData.typ === o.key;
          card.className = `bg-gray-50 p-6 rounded-xl shadow card-option text-center cursor-pointer ${isSelected ? 'selected' : ''}`;
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key;
          };
          holder.appendChild(card);
        });
        return;
      }


      if (step === 2) {
        const currentType = editingData.typ;
        const { title, question } = typeTexts[currentType] || {
          title: "üè∑Ô∏è Name",
          question: "Wie soll dein Eintrag hei√üen?"
        };

        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">${title}</h2>
            <p class="text-sm text-gray-600 mb-2">${question}</p>
            <input id="nameInput"
                   class="w-full border p-2 rounded"
                   placeholder="Name eingeben"
                   value="${editingData.name || ''}">
          </div>`;
        return;
      }

      if (step === 3) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ü™ë Gibt es Sitzpl√§tze?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">‚úÖ Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Nein' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">‚ùå Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 4) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üîå Gibt es Strom?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">‚ö° Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Nein' ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">‚ùå Nein</button>
            </div>
          </div>`;
        return;
      }
      
      if (step === 5) { // √ñffnungszeiten
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-3">üïí √ñffnungszeiten</h2>

            <div id="openHoursEditor">
                ${renderOpeningHoursEditor('current', editingData.oeffnungszeiten || {})}
            </div>
          </div>
        `;
        return;
      }

      if (step === 6) {
        const extrasString = Array.isArray(editingData.extras) ? editingData.extras.join(', ') : '';
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">‚ú® Extras (optional)</h2>
            <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. Getr√§nke, K√ºhlschrank" value="${extrasString}">
          </div>`;
        return;
      }

      if (step === 7) {
        const animals = ["üêê Ziege","üêÑ Kuh","üêì Huhn","üêï Hund","üêá Hase","üêà Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">üêæ Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const nameOnly = t.replace(/^[^\s]+\s*/, "").trim();
          const btn = document.createElement('button');
          const isSel = (editingData.tiere || []).includes(nameOnly);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            if (nameOnly === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              holder.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            } else {
              editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
              const idx = (editingData.tiere || []).indexOf(nameOnly);
              if (idx >= 0) {
                editingData.tiere.splice(idx, 1);
                btn.classList.remove('selected');
              } else {
                editingData.tiere.push(nameOnly);
                btn.classList.add('selected');
              }
              // 'Keine Tiere' Knopf muss visuell zur√ºckgesetzt werden
              holder.querySelector('button[data-name="Keine Tiere"]')?.classList.remove('selected');
            }
          };
          btn.setAttribute('data-name', nameOnly);
          holder.appendChild(btn);
        });
        return;
      }

      if (step === 8) {
        // KI-Text-Generierung im Beschreibungs-Schritt (Step 8)
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl-design max-w-4xl mx-auto">
            <h2 class="text-3xl font-extrabold text-green-700 mb-4">üí¨ Beschreibung</h2>
            <p class="text-gray-600 mb-4">Beschreibe deine Eintragung. Dies erscheint sp√§ter auf der Karte.</p>

            <button id="kiDescBtn" class="mb-3 px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition disabled:opacity-50" onclick="generateAndInsertDescription()">
              ü™Ñ KI-Text generieren
            </button>

            <div id="editor" class="h-64 border rounded"></div>
            <p class="text-xs text-gray-500 mt-2">Max. 500 Zeichen empfohlen.</p>
          </div>
        `;
        setTimeout(() => {
          quill = new Quill('#editor', {
            modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link']] },
            placeholder: 'Schreibe eine einladende Beschreibung...',
            theme: 'snow'
          });
          if (editingData.beschreibung) {
            // Quill ben√∂tigt nur den HTML-Inhalt des Beschreibungsfeldes
            quill.root.innerHTML = editingData.beschreibung; 
          }
        }, 120);

        // Logik f√ºr den Button im Beschreibungs-Schritt
        window.generateAndInsertDescription = async () => {
          const btn = document.getElementById('kiDescBtn');
          btn.disabled = true;
          btn.textContent = 'üß† KI generiert...';

          const name = editingData.name || "Deine neue Eintragung";
          const extras = editingData.extras || [];
          const animals = (editingData.tiere || []).filter(t => t !== 'Keine Tiere');
          
          try {
            const desc = await generateSmartDescription(name, extras, animals);
            quill.root.innerHTML = `<p>${desc}</p>`;
            showToast("‚úÖ KI-Text erfolgreich generiert.");
          } catch(e) {
            showToast("‚ùå Fehler bei der KI-Generierung: " + e.message);
          } finally {
            btn.disabled = false;
            btn.textContent = 'ü™Ñ KI-Text generieren';
          }
        };
        return;
      }

      if (step === 9) {
        const tagsString = Array.isArray(editingData.tags) ? editingData.tags.join(', ') : '';
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">üè∑Ô∏è Schlagw√∂rter (Komma getrennt)</h2>
            <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. Fr√ºhst√ºck,Schattig" value="${tagsString}">
          </div>`;
        return;
      }

      if (step === 10) {
        // Standort und √úbersicht
        mode = "list"; // Stellt sicher, dass die untere Navigationsleiste ausgeblendet wird
         
         document.getElementById("navBottom").style.display = "none"; // Blendet Navigaton aus

         let submitBtnText = editingData.docId ? '‚úÖ Aktualisieren' : '‚úÖ Einreichen';

          qa.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
              <h2 class="text-xl font-bold mb-3">üìç Standort & √úbersicht</h2>
              <p class="text-sm text-gray-600 mb-4">√úberpr√ºfe alle Daten und w√§hle den genauen Standort auf der Karte aus.</p>

              <h3 class="text-lg font-bold mt-4 mb-2">üìç Standort</h3>
              <div class="relative mb-2">
                <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchen‚Ä¶" />
                <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
              </div>
              <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition">üì° Mein Standort</button>

              <div id="overview-map" class="h-64 rounded border mb-4"></div>

              <div class="flex gap-2 justify-between">
                <button class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition" onclick="prevStep()">‚¨ÖÔ∏è Zur√ºck</button>
                <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition" onclick="submitEntry()">${submitBtnText}</button>
              </div>
              <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird gepr√ºft und erst nach Freigabe sichtbar.</p>
            </div>`;

        // Map initialisieren
        setTimeout(() => {
          initOverviewMap();

          // GPS-Button aktivieren
          const gpsBtn = document.getElementById("gpsBtn");
          if (gpsBtn) gpsBtn.addEventListener("click", locateGPS);

          // Adress-Suche mit Vorschl√§gen (Simulierter Nominatim-Teil)
          const addr = document.getElementById("addressSearch");
          const suggestionBox = document.getElementById("addressSuggestions");
          if (addr) {
            addr.addEventListener("input", async e => {
              const query = e.target.value.trim();
              if (query.length < 3) {
                suggestionBox.innerHTML = "";
                suggestionBox.classList.add("hidden");
                return;
              }
              
              // Simuliere Suche 
              suggestionBox.innerHTML = `
                <div class="p-2 text-gray-500">Suche wird in der Live-Version mit Nominatim durchgef√ºhrt.</div>
                <div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="52.375" data-lon="9.732">Hannover Hauptbahnhof (Test)</div>
              `;
              suggestionBox.classList.remove("hidden");

              suggestionBox.querySelectorAll("div[data-lat]").forEach(div => {
                div.addEventListener("click", () => {
                  const lat = parseFloat(div.dataset.lat);
                  const lon = parseFloat(div.dataset.lon);
                  addr.value = div.textContent;
                  suggestionBox.classList.add("hidden");
                  initOverviewMap(lat, lon, 15);
                });
              });
            });
          }
        }, 200);
          return;
      }
      
    } catch (err) {
      qa.innerHTML = `<div class="bg-red-100 p-4 rounded-xl max-w-2xl mx-auto mt-10">‚ùå Fehler beim Rendern des Schritts ${step}: ${err.message}</div>`;
      console.error(err);
    }
  }
  </script>
</body>
</html>
