<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap {
  height: 200px;
  z-index: 0;
}
.leaflet-container {
  z-index: 0 !important;
}
    /* Small helper for fixed bottom nav on small screens */
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; } /* space for fixed nav */
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    .sidebar-btn.active {
  background-color: #e8f8ee;
  color: #166534;
  font-weight: 600;
    }
    
/* === Smarter Upload Style === */
#smartUploadZone {
  transition: all 0.25s ease;
}
#smartUploadZone:hover {
  background-color: #ecfdf5;
  border-color: #10b981;
  transform: scale(1.01);
}
#smartUploadPreview img {
  transition: all 0.25s ease;
}
#smartUploadPreview img:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}
@keyframes pulseUpload {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
.uploading::after {
  content: "⏫";
  position: absolute;
  top: 4px; right: 4px;
  font-size: 0.8rem;
  animation: pulseUpload 1s infinite;
  color: #16a34a;
}
  </style>
</head>
<body class="bg-gray-100">
<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full transform transition hover:scale-[1.01]">
    
    <div class="text-center mb-6">
        <h1 class="text-3xl font-extrabold text-green-700">Willkommen!</h1>
        <p class="text-gray-500 mt-2">Bitte melde dich an, um fortzufahren.</p>
    </div>

    <div id="authFormContainer">
        <form id="loginForm" class="space-y-4">
            <input id="loginEmail" type="email" placeholder="E-Mail" class="w-full border p-3 rounded-lg" required>
            <input id="loginPassword" type="password" placeholder="Passwort" class="w-full border p-3 rounded-lg" required>
            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Anmelden</button>
            <p class="text-xs text-center text-gray-500">
                <a href="#" onclick="showPasswordReset()" class="text-green-600 hover:underline">Passwort vergessen?</a>
            </p>
        </form>
        
        <form id="registerForm" class="hidden space-y-4">
            <input id="registerName" type="text" placeholder="Dein Name" class="w-full border p-3 rounded-lg" required>
            <input id="registerEmail" type="email" placeholder="E-Mail" class="w-full border p-3 rounded-lg" required>
            <input id="registerPassword" type="password" placeholder="Passwort" class="w-full border p-3 rounded-lg" required>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Registrieren</button>
        </form>

        <p class="text-center text-sm mt-4">
            <a href="#" id="authToggle" class="text-green-600 hover:underline">Noch kein Account? Jetzt registrieren</a>
        </p>
    </div>
    
    <div class="flex items-center my-6">
        <hr class="flex-grow border-t border-gray-300">
        <span class="px-3 text-gray-500 text-sm">oder</span>
        <hr class="flex-grow border-t border-gray-300">
    </div>

    <button onclick="doGoogleLogin()" 
      class="flex items-center gap-3 px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-xl shadow-sm transition w-full justify-center font-medium hover:bg-gray-50">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" 
           class="w-6 h-6" />
      <span>Mit Google anmelden</span>
    </button>
    
    <div id="authError" class="mt-4 text-center text-red-500 text-sm"></div>
  </div>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

  <div class="flex flex-col items-center mb-8">
    <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
      <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
      <span id="avatarInitials"></span>
    </div>
    <p class="text-sm text-gray-600">Angemeldet als:</p>
    <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
    <button onclick="logout()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform">Logout</button>
  </div>

  <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
    🌿 Assistent
  </div>

  <nav class="flex flex-col gap-2 text-[15px]">
    <a href="https://radlmap.net" target="_blank" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      🚲 Startseite
    </a>
    <a href="navi.html" target="_blank" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      🚴‍♂️ zur RadlMap
    </a>

    <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="navigateTo('btnDashboard', showDashboard)">
      📊 Betreiber-Dashboard
    </button>
    <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="navigateTo('btnEntries', showMyEntries)">
      📋 Meine Eintragungen
    </button>
    <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="navigateTo('btnNewEntry', startNewEntry)">
      ➕ Neue Eintragung
    </button>

    <div class="mt-4">
      <div class="flex items-center justify-between px-3 mb-1">
        <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
      </div>

      <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
        <button id="btnMyEvents"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="navigateTo('btnMyEvents', () => showMyEvents(firebase.auth().currentUser))">
          📅 <span>Meine Events</span>
        </button>
        <button id="btnCreateEvent"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="navigateTo('btnCreateEvent', () => showCreateEvent(firebase.auth().currentUser))">
          ➕ <span>Neues Event</span>
        </button>
      </div>
    </div>

    <hr class="my-3 border-gray-200">
    
    <button id="btnSettings" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="navigateTo('btnSettings', showAccountSettings)">
      ⚙️ Account-Einstellungen
    </button>
    <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="navigateTo('btnSupport', openSupport)">
      💬 Support
    </button>
    <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="navigateTo('btnHutMessages', showHutMessages)">
      💌 Hütten-Nachrichten
      <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
    </button>
  </nav>

  <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
    v2.2 &middot; RadlMap Assistent
  </div>
</aside>
    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
  <div class="sticky top-4">
    <h3 class="text-lg font-bold mb-3">ℹ️ Hilfe & Beispiele</h3>
    <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
    <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">✕</button>
    <h3 class="text-lg font-bold mb-3">ℹ️ Hilfe & Beispiele</h3>
    <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg">
  ℹ️
</button>

<script>
    // Setzt den aktiven Button und schließt optional die Sidebar
    function navigateTo(buttonId, pageFunction) {
        setActive(buttonId);
        pageFunction();
        // Auf kleinen Bildschirmen die Sidebar nach der Auswahl schließen
        if (window.innerWidth < 768) {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        }
    }

    // Markiert nur den aktiven Button
    function setActive(buttonId) {
        document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('active', 'bg-green-100', 'font-semibold'));
        const activeBtn = document.getElementById(buttonId);
        if(activeBtn) {
            activeBtn.classList.add('active', 'bg-green-100', 'font-semibold');
        }
    }
</script>


    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">☰</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto bg-green-50/50">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">⬅️ Zurück</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter ➡️</button>
      </div>
    </main>
  </div>

  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  // imgbb API key (wie in Admin-Code verwendet)
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";

  // Init firebase
    
  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">❌ Firebase konnte nicht initialisiert werden. Prüfe die Konfiguration in der Datei.</div>`;
  }

  let currentUser = null;
firebase.auth().onAuthStateChanged(u => {
  if (u) {
    currentUser = u;
    setGoogleProfile(u);
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainApp").classList.remove("hidden");

    mode = "dashboard";
    document.getElementById("navBottom").style.display = "none";
    
    navigateTo('btnDashboard', showDashboard);
    initHutMessagesBadge();
  } else {
    currentUser = null;
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("question-area").innerHTML = "";
  }
});
    /***********************
     * AUTHENTICATION
     ***********************/

    async function doGoogleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            await firebase.auth().signInWithPopup(provider);
            showToast("✅ Erfolgreich mit Google angemeldet");
        } catch (e) {
            handleAuthError(e);
        }
    }

    async function handleRegistration(event) {
        event.preventDefault();
        const name = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            await userCredential.user.updateProfile({ displayName: name });
            showToast("✅ Registrierung erfolgreich!");
        } catch (e) {
            handleAuthError(e);
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await firebase.auth().signInWithEmailAndPassword(email, password);
            showToast("✅ Anmeldung erfolgreich!");
        } catch (e) {
            handleAuthError(e);
        }
    }

    function showPasswordReset() {
        const email = prompt("Bitte gib deine E-Mail-Adresse ein, um dein Passwort zurückzusetzen:");
        if (email) {
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => alert("E-Mail zum Zurücksetzen des Passworts wurde gesendet."))
                .catch(handleAuthError);
        }
    }

    function handleAuthError(error) {
        const errorElement = document.getElementById('authError');
        let message = "Ein unbekannter Fehler ist aufgetreten.";
        switch (error.code) {
            case 'auth/email-already-in-use': message = "Diese E-Mail-Adresse wird bereits verwendet."; break;
            case 'auth/weak-password': message = "Das Passwort ist zu schwach (mind. 6 Zeichen)."; break;
            case 'auth/user-not-found': message = "Kein Account mit dieser E-Mail-Adresse gefunden."; break;
            case 'auth/wrong-password': message = "Falsches Passwort."; break;
            case 'auth/invalid-email': message = "Ungültige E-Mail-Adresse."; break;
        }
        errorElement.textContent = message;
    }
    
    function setupAuthForms() {
        document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
        document.getElementById('registerForm')?.addEventListener('submit', handleRegistration);
        
        const authToggle = document.getElementById('authToggle');
        authToggle?.addEventListener('click', (e) => {
            e.preventDefault();
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authToggle.textContent = 'Noch kein Account? Jetzt registrieren';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authToggle.textContent = 'Bereits einen Account? Anmelden';
            }
        });
    }
    // Call setup function once the DOM is ready
    document.addEventListener('DOMContentLoaded', setupAuthForms);


    function logout() {
        firebase.auth().signOut();
    }
    let mode = "entry"; // "entry" oder "list"
  /***********************
   * State & steps
   ***********************/
  let editingData = {};
  let step = 0;
  const stepsCount = 11; // 0..10
  

  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }
    // ==========================================================
// 🕒 Öffnungszeiten Editor (RadlMap-Style)
// ==========================================================

// helper for localized day names
const DAY_LABELS = [
  { key: "mo", label: "Montag" },
  { key: "di", label: "Dienstag" },
  { key: "mi", label: "Mittwoch" },
  { key: "do", label: "Donnerstag" },
  { key: "fr", label: "Freitag" },
  { key: "sa", label: "Samstag" },
  { key: "so", label: "Sonntag" }
];

// Rendering des Editors
function renderOpeningHoursEditor(hutId, data = {}) {
  let html = `
    <div id="openhours-${hutId}" class="space-y-2 mt-2">
      <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
        <thead class="bg-green-100 text-green-800">
          <tr>
            <th class="py-2 px-3 text-left">Tag</th>
            <th class="py-2 px-3 text-center">Geöffnet</th>
            <th class="py-2 px-3 text-center">Von</th>
            <th class="py-2 px-3 text-center">Bis</th>
          </tr>
        </thead>
        <tbody class="divide-y">
  `;

  DAY_LABELS.forEach(day => {
    const d = data[day.key] || {};
    const open = !!d.open;
    const from = d.from || "";
    const to = d.to || "";
    html += `
      <tr>
        <td class="py-2 px-3">${day.label}</td>
        <td class="text-center">
          <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
      <p class="text-xs text-gray-500">Tipp: Wenn du nichts einträgst, wird "geschlossen" angezeigt.</p>
    </div>
  `;
  return html;
}

// Daten auslesen
function collectOpeningHours(hutId) {
  const wrapper = document.getElementById(`openhours-${hutId}`);
  if (!wrapper) return {};
  const result = {};
  DAY_LABELS.forEach(day => {
    const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
    const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
    const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
    const open = openCheckbox.checked;
    result[day.key] = {
      open,
      from: open ? fromInput.value : "",
      to: open ? toInput.value : ""
    };
  });
  return result;
}

// Dynamische Aktivierung / Deaktivierung
document.addEventListener("change", (e) => {
  if (e.target.classList.contains("oh-open")) {
    const day = e.target.dataset.day;
    const row = e.target.closest("tr");
    const from = row.querySelector(".oh-from");
    const to = row.querySelector(".oh-to");
    const isOpen = e.target.checked;
    from.disabled = !isOpen;
    to.disabled = !isOpen;
    if (!isOpen) {
      from.value = "";
      to.value = "";
    }
  }
});
  /***********************
   * Render Flow (Questions)
   ***********************/
          // Texte für Step 2 je nach Typ
const typeTexts = {
  Eierhütte: {
    title: "🏷️ Name der Eierhütte",
    question: "Wie soll deine Eierhütte heißen?"
  },
  Hofladen: {
    title: "🏷️ Name des Hofladens",
    question: "Wie soll dein Hofladen heißen?"
  },
  Selbstbedienung: {
    title: "🏷️ Name des Selbstbedienungshäuschens",
    question: "Wie soll dein Selbstbedienungshäuschen heißen?"
  },
  Spielplatz: {
    title: "🏷️ Name des Spielplatzes",
    question: "Wie soll der Spielplatz heißen?"
  },
  Abenteuerhof: {
    title: "🏷️ Name des Abenteuerhofs",
    question: "Wie soll dein Abenteuerhof heißen?"
  },
  Automat: {
    title: "🏷️ Name des Automaten",
    question: "Wie soll dein Automat heißen?"
  }
};
  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
      
    try {
      if (step === 0) {
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">🛡️ Datenschutzerklärung</h2>

      <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200">
        <iframe 
          src="https://radlmap.net/datenschutz.html" 
          class="w-full h-[500px] border-0 bg-white"
          style="display:block; min-width:100%; overflow:auto;">
        </iframe>
      </div>

      <label class="inline-flex items-center gap-2 text-sm text-gray-700">
        <input id="dsCheck" type="checkbox" class="w-4 h-4" disabled /> 
        Ich akzeptiere die Datenschutzerklärung
      </label>
      <div id="dsHint" class="text-xs text-red-500 mt-1">
        ⬇️ Bitte bis ganz nach unten scrollen
      </div>
    </div>`;

  // Scroll-Überwachung
  const scrollBox = document.getElementById("dsScrollBox");
  const check = document.getElementById("dsCheck");
  const hint = document.getElementById("dsHint");

  scrollBox.addEventListener("scroll", () => {
    if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
      check.disabled = false;
      hint.textContent = "✅ Du kannst nun die Datenschutzerklärung akzeptieren.";
      hint.classList.remove("text-red-500");
      hint.classList.add("text-green-600");
    }
  });
  return;
}
      if (step === 1) {
        // Typ-Auswahl
        const opts = [
          { emoji: '🥚', label: 'Eierhütte', key: 'Eierhütte' },
          { emoji: '🏪', label: 'Hofladen', key: 'Hofladen' },
          { emoji: '🏠', label: 'Selbstbedienungshäuschen', key: 'Selbstbedienung' },
          { emoji: '🛝', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: '🌄', label: 'Abenteuerhof', key: 'Abenteuerhof' },
          { emoji: '🍶', label: 'Automat', key: 'Automat' }
        ];
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto';
        opts.forEach(o => {
          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer';
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key;
          };
          wrap.appendChild(card);
        });
        qa.appendChild(wrap);
        return;
      }



if (step === 2) {
  const currentType = editingData.typ; // <-- statt eintragung.type
  const { title, question } = typeTexts[currentType] || {
    title: "🏷️ Name",
    question: "Wie soll dein Eintrag heißen?"
  };

  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-lg font-bold mb-2">${title}</h2>
      <p class="text-sm text-gray-600 mb-2">${question}</p>
      <input id="nameInput"
             class="w-full border p-2 rounded"
             placeholder="Name eingeben"
             value="${editingData.name || ''}">
    </div>`;
  return;
}

      if (step === 3) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">🪑 Gibt es Sitzplätze?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded" onclick="selectOption('sitzplaetze','Ja',this)">✅ Ja</button>
              <button class="flex-1 p-3 border rounded" onclick="selectOption('sitzplaetze','Nein',this)">❌ Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 4) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">🔌 Gibt es Strom?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded" onclick="selectOption('strom','Ja',this)">⚡ Ja</button>
              <button class="flex-1 p-3 border rounded" onclick="selectOption('strom','Nein',this)">❌ Nein</button>
            </div>
          </div>`;
        return;
      }
      if (step === 5) {
  const immer = editingData.oeffnungszeiten === "Immer geöffnet";

  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-lg font-bold mb-3">🕒 Öffnungszeiten</h2>

      <label class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="immerCheck" ${immer ? "checked" : ""}>
        Immer geöffnet
      </label>

      <div id="dayInputs" class="${immer ? "hidden" : ""}">
        ${["Mo","Di","Mi","Do","Fr","Sa","So"].map(day => {
          // vorhandene Werte beim Bearbeiten einsetzen
          let von = "", bis = "";
          if (Array.isArray(editingData.oeffnungszeiten)) {
            const found = editingData.oeffnungszeiten.find(x => x.tag === day);
            if (found) { von = found.von; bis = found.bis; }
          }
          return `
            <div class="flex items-center gap-2 mb-1">
              <span class="w-10">${day}</span>
              <input id="open-${day}-von" type="time" value="${von}" class="border p-1 rounded text-sm">
              <span>-</span>
              <input id="open-${day}-bis" type="time" value="${bis}" class="border p-1 rounded text-sm">
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;

  document.getElementById("immerCheck").addEventListener("change", (e) => {
    document.getElementById("dayInputs").classList.toggle("hidden", e.target.checked);
  });

  return;
      }
      

      if (step === 6) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">✨ Extras (optional)</h2>
            <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. Getränke, Kühlschrank" value="${editingData.extras || ''}">
          </div>`;
        return;
      }

      if (step === 7) {
        // Tiere toggle buttons (markieren, don't auto-next)
        const animals = ["🐐 Ziege","🐄 Kuh","🐓 Huhn","🐕 Hund","🐇 Hase","🐈 Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">🐾 Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const btn = document.createElement('button');
          const isSel = editingData.tiere.includes(t);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            // toggle
            if (t === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              // remove selected from others
              holder.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              return;
            }
            // if 'Keine Tiere' present -> remove it
            editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
            const idx = (editingData.tiere || []).indexOf(t);
            if (idx >= 0) {
              editingData.tiere.splice(idx, 1);
              btn.classList.remove('selected');
            } else {
              editingData.tiere.push(t);
              btn.classList.add('selected');
            }
          };
          holder.appendChild(btn);
        });
        return;
      }

      if (step === 8) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">📝 Beschreibung</h2>
            <div id="quillContainer" class="bg-white"></div>
          </div>`;
        setTimeout(() => {
            initEnhancedEditor("quillContainer", editingData);
        }, 120);
        return;
      }

      if (step === 9) {
        qa.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                <h2 class="text-lg font-bold mb-2">🏷️ Schlagwörter (Komma getrennt)</h2>
                <div class="relative">
                    <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. Frühstück,Schattig" value="${(editingData.tags||[]).join(', ')}">
                    <button onclick="suggestTagsForWizard()" class="absolute top-1/2 right-2 -translate-y-1/2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">🪄 KI-Vorschlag</button>
                </div>
            </div>`;
        return;
      }

      if (step === 10) {
        mode = "list";
         
         document.getElementById("navBottom").style.display =
         (mode === "entry") ? "flex" : "none";
     
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">📋 Übersicht</h2>
      
      <h3 class="text-lg font-bold mt-4 mb-2">📍 Standort</h3>
      <div class="relative mb-2">
        <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchen…" />
        <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
      </div>
      <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded">📡 Mein Standort</button>

      <div id="overview-map" class="h-64 rounded border mb-4"></div>

      <div class="flex gap-2">
        <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">✅ Einreichen</button>
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">✖ Abbrechen</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprüft und erst nach Freigabe sichtbar.</p>
    </div>`;

  // Jetzt nur noch Map initialisieren
  setTimeout(() => {
  initOverviewMap();

  // GPS-Button aktivieren
  const gpsBtn = document.getElementById("gpsBtn");
  if (gpsBtn) gpsBtn.addEventListener("click", locateGPS);

  // Adress-Suche mit Vorschlägen
  const addr = document.getElementById("addressSearch");
  const suggestionBox = document.getElementById("addressSuggestions");
  if (addr) {
    addr.addEventListener("input", async e => {
      const query = e.target.value.trim();
      if (query.length < 3) {
        suggestionBox.innerHTML = "";
        suggestionBox.classList.add("hidden");
        return;
      }
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.length) {
          suggestionBox.innerHTML = "<div class='p-2 text-gray-500'>Keine Treffer</div>";
          suggestionBox.classList.remove("hidden");
          return;
        }

        suggestionBox.innerHTML = data.map(item => `
          <div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="${item.lat}" data-lon="${item.lon}">
            ${item.display_name}
          </div>`).join("");
        suggestionBox.classList.remove("hidden");

        suggestionBox.querySelectorAll("div").forEach(div => {
          div.addEventListener("click", () => {
            const lat = parseFloat(div.dataset.lat);
            const lon = parseFloat(div.dataset.lon);
            addr.value = div.textContent;
            suggestionBox.classList.add("hidden");
            initOverviewMap(lat, lon, 15);
          });
        });
      } catch (err) {
        console.error("Fehler bei Nominatim:", err);
      }
    });
  }
}, 200);
  return;
      }
      
    } catch (err) {
      console.error("renderQuestion error", err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler: ${err.message}</div>`;
    }
  }
    
const stripe = Stripe("pk_test_51SFLgEBghOTdsn6RBYuZr6x4R2BC6lhq4NFWmcKTtyNahatWHMVHAq3posYIhsXKRl598qHOzMzyymuV6DgKWYly006AaME4Wr");

/***********************
 * DASHBOARD
 ***********************/
async function showDashboard() {
    const qa = document.getElementById("question-area");
    qa.innerHTML = `<div class="max-w-6xl mx-auto animate-fadeIn">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Mein Dashboard</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div id="statsArea" class="grid grid-cols-1 md:grid-cols-3 gap-6">Lade Statistiken...</div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">Aufrufe der letzten 7 Tage</h3>
                    <canvas id="viewsChart" height="120"></canvas>
                </div>
                <div id="smartTips" class="bg-white p-6 rounded-xl shadow-md"></div>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">Schnellzugriff</h3>
                    <div class="space-y-3">
                        <button onclick="navigateTo('btnNewEntry', startNewEntry)" class="w-full text-left flex items-center gap-3 p-3 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 transition">➕ Neue Eintragung</button>
                        <button onclick="navigateTo('btnEntries', showMyEntries)" class="w-full text-left flex items-center gap-3 p-3 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition">📋 Meine Eintragungen</button>
                        <button onclick="navigateTo('btnHutMessages', showHutMessages)" class="w-full text-left flex items-center gap-3 p-3 bg-yellow-100 text-yellow-800 rounded-lg hover:bg-yellow-200 transition">💌 Hütten-Nachrichten</button>
                    </div>
                </div>
                <div id="eventsArea"></div>
            </div>
        </div>
    </div>`;

    const user = firebase.auth().currentUser;
    if (!user) {
        qa.innerHTML = `<div class="text-center text-red-600 font-semibold">Bitte zuerst einloggen.</div>`;
        return;
    }

    // Load all data in parallel
    await Promise.all([
        renderDashboardStats(user.uid),
        renderViewsChart(user.uid),
        generateDashboardTips(user.uid),
        showEventsSection(user) // For Premium users
    ]);
}

async function renderDashboardStats(uid) {
    const statsArea = document.getElementById("statsArea");
    const snapshot = await db.collection("eierhuetten").where("userId", "==", uid).get();
    let totalViews = 0, totalRoutes = 0;
    snapshot.forEach(doc => {
        const data = doc.data();
        totalViews += data.views || 0;
        totalRoutes += data.routeStarts || 0;
    });

    statsArea.innerHTML = `
      <div class="bg-white p-5 rounded-xl shadow-md text-center">
        <div class="text-3xl mb-2">👁️</div>
        <h3 class="font-semibold text-gray-600">Aufrufe</h3>
        <p class="text-3xl font-bold text-green-700">${totalViews}</p>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-md text-center">
        <div class="text-3xl mb-2">📍</div>
        <h3 class="font-semibold text-gray-600">Routenstarts</h3>
        <p class="text-3xl font-bold text-green-700">${totalRoutes}</p>
      </div>
      <div class="bg-white p-5 rounded-xl shadow-md text-center">
        <div class="text-3xl mb-2">🏡</div>
        <h3 class="font-semibold text-gray-600">Einträge</h3>
        <p class="text-3xl font-bold text-green-700">${snapshot.size}</p>
      </div>`;
}

async function renderViewsChart(uid) {
    const statsMap = new Map();
    const now = new Date();
    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);
        statsMap.set(d.toLocaleDateString("de-DE", { weekday: 'short' }), 0);
    }

    const snapshot = await db.collection("eierhuetten").where("userId", "==", uid).get();
    snapshot.forEach(doc => {
        const data = doc.data();
        if (Array.isArray(data.dailyViews)) {
            data.dailyViews.forEach(v => {
                const day = new Date(v.date).toLocaleDateString("de-DE", { weekday: 'short' });
                if (statsMap.has(day)) {
                    statsMap.set(day, statsMap.get(day) + (v.count || 0));
                }
            });
        }
    });

    const labels = Array.from(statsMap.keys());
    const values = Array.from(statsMap.values());
    const ctx = document.getElementById("viewsChart")?.getContext("2d");
    if (!ctx) return;
    new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Seitenaufrufe",
                data: values,
                fill: true,
                borderColor: "#10b981",
                backgroundColor: "rgba(16,185,129,0.1)",
                tension: 0.3,
                pointBackgroundColor: "#10b981",
                pointRadius: 4
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
}

async function generateDashboardTips(uid) {
    const tipsContainer = document.getElementById("smartTips");
    tipsContainer.innerHTML = `<h3 class="font-bold text-lg mb-4 text-gray-700">💡 Smarte Tipps</h3><div id="tipsList" class="space-y-3">Lade Tipps...</div>`;
    const tipsList = document.getElementById("tipsList");

    const entriesSnap = await db.collection("eierhuetten").where("userId", "==", uid).get();
    const tips = [];

    if (entriesSnap.empty) {
        tips.push({
            emoji: '➕',
            text: `Du hast noch keinen Eintrag. <strong class="text-green-600">Erstelle jetzt deinen ersten!</strong>`,
            action: () => navigateTo('btnNewEntry', startNewEntry)
        });
    }

    entriesSnap.forEach(doc => {
        const data = doc.data();
        if (!data.beschreibung || stripHtml(data.beschreibung).length < 50) {
            tips.push({
                emoji: '📝',
                text: `Die Beschreibung für <strong class="text-green-600">${data.name}</strong> ist sehr kurz. Verbessere sie mit unserer KI!`,
                action: () => openEditPage(doc.id)
            });
        }
        if (!data.fotos || data.fotos.length === 0) {
            tips.push({
                emoji: '📸',
                text: `Für <strong class="text-green-600">${data.name}</strong> fehlen noch Bilder. Lade jetzt welche hoch!`,
                action: () => openEditPage(doc.id)
            });
        }
    });

    if (tips.length === 0) {
        tipsList.innerHTML = `<div class="text-center text-gray-500 p-4">Sieht gut aus! Aktuell keine direkten Vorschläge.</div>`;
        return;
    }

    tipsList.innerHTML = '';
    tips.slice(0, 3).forEach(tip => { // Show max 3 tips
        const tipEl = document.createElement('div');
        tipEl.className = 'flex items-center gap-3 p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200';
        tipEl.innerHTML = `<div class="text-xl">${tip.emoji}</div><p class="text-sm">${tip.text}</p>`;
        tipEl.onclick = tip.action;
        tipsList.appendChild(tipEl);
    });
}

    async function editEvent(hutId, eventId) {
  const evDoc = await db.collection("eierhuetten").doc(hutId).collection("events").doc(eventId).get();
  const ev = evDoc.data();

  showCreateEvent(firebase.auth().currentUser);

  setTimeout(() => {
    document.getElementById("eventHut").value = hutId;
    document.getElementById("eventTitle").value = ev.title;
    document.getElementById("eventDesc").value = ev.desc || "";
    document.getElementById("eventStart").value = ev.startDate.toDate().toISOString().slice(0, 10);
    document.getElementById("eventEnd").value = ev.endDate.toDate().toISOString().slice(0, 10);

    const form = document.getElementById("eventForm");
    form.onsubmit = async (e) => {
      e.preventDefault();
      await db.collection("eierhuetten").doc(hutId).collection("events").doc(eventId).update({
        title: document.getElementById("eventTitle").value,
        desc: document.getElementById("eventDesc").value,
        startDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById("eventStart").value)),
        endDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById("eventEnd").value))
      });
      showToast("✅ Event aktualisiert!");
      showMyEvents(firebase.auth().currentUser);
    };
  }, 400);
}

async function deleteEvent(hutId, eventId) {
  if (!confirm("Möchtest du dieses Event wirklich löschen?")) return;
  await db.collection("eierhuetten").doc(hutId).collection("events").doc(eventId).delete();
  showToast("🗑️ Event gelöscht!");
  showMyEvents(firebase.auth().currentUser);
}
async function showEventsSection(user) {
  const eventsArea = document.getElementById("eventsArea");
  if (!eventsArea) return;
  
  const betreiberDoc = await db.collection("betreiber").doc(user.uid).get();
  if (!betreiberDoc.exists || !betreiberDoc.data().premium) {
      eventsArea.innerHTML = ''; // Hide for non-premium
      return;
  }

  // Lade Hütten des Betreibers
  const hutsSnapshot = await db.collection("eierhuetten").where("userId", "==", user.uid).get();
  let options = "";
  hutsSnapshot.forEach(doc => {
    const hut = doc.data();
    options += `<option value="${doc.id}">${hut.name}</option>`;
  });

  eventsArea.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-md">
      <h3 class="text-lg font-bold mb-4 text-gray-700">🗓️ Live-Events</h3>
       <button onclick="navigateTo('btnCreateEvent', () => showCreateEvent(firebase.auth().currentUser))" class="w-full text-center p-3 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 transition font-semibold">➕ Neues Event erstellen</button>
      <div id="eventList" class="mt-4 space-y-3"></div>
    </div>
  `;
    const eventList = document.getElementById('eventList');
    let hasEvents = false;
  // Events anzeigen
  for (const doc of hutsSnapshot.docs) {
    const eventsSnap = await db.collection("eierhuetten").doc(doc.id).collection("events").orderBy("startDate", "desc").limit(3).get();
    eventsSnap.forEach(evDoc => {
        hasEvents = true;
      const ev = evDoc.data();
      const now = new Date();
      let statusClass = "bg-gray-200 text-gray-700";
      if (ev.endDate.toDate() < now) statusClass = "bg-red-100 text-red-700";
      else if (ev.startDate.toDate() <= now) statusClass = "bg-green-100 text-green-700 animate-pulse";
      else statusClass = "bg-yellow-100 text-yellow-700";

      eventList.innerHTML += `
        <div class="border p-3 rounded-lg bg-gray-50 text-sm">
          <div class="flex justify-between items-center">
            <b class="truncate">${ev.title}</b>
            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">
              ${ev.startDate.toDate().toLocaleDateString("de-DE")}
            </span>
          </div>
        </div>
      `;
    });
  }
  if (!hasEvents) {
      eventList.innerHTML = `<p class="text-center text-sm text-gray-500 mt-4">Keine Events geplant.</p>`;
  }
    }




async function showCreateEvent(user) {
  const betreiberDoc = await db.collection("betreiber").doc(user.uid).get();
  const data = betreiberDoc.data() || {};
  
  if (data.premium) {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `<div class="text-gray-500">⏳ Lade deine Hütten...</div>`;

  const hutsSnapshot = await db.collection("eierhuetten").where("userId", "==", user.uid).get();
  if (hutsSnapshot.empty) {
    qa.innerHTML = `<div class="p-6 bg-white rounded shadow text-center">
      🚫 Du hast noch keine Hütte. <br>
      <button class="mt-4 px-3 py-2 bg-green-600 text-white rounded" onclick="showMyEntries()">➕ Jetzt eine Hütte anlegen</button>
    </div>`;
    return;
  }

  let options = "";
  hutsSnapshot.forEach(doc => {
    const hut = doc.data();
    options += `<option value="${doc.id}">${hut.name}</option>`;
  });

  qa.innerHTML = `
    <section class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4">🗓️ Neues Event erstellen</h2>
      <form id="eventForm" class="grid gap-3">
        <label>
          <span class="text-sm text-gray-600">Hütte wählen</span>
          <select id="eventHut" class="w-full p-2 border rounded">${options}</select>
        </label>

        <label>
          <span class="text-sm text-gray-600">Titel</span>
          <input id="eventTitle" type="text" class="w-full p-2 border rounded" required placeholder="z.B. Sommerfest">
        </label>

        <label>
          <span class="text-sm text-gray-600">Beschreibung</span>
          <textarea id="eventDesc" class="w-full p-2 border rounded" rows="2" placeholder="z.B. mit Musik, Grill & Getränken"></textarea>
        </label>

        <div class="grid grid-cols-2 gap-3">
          <label>
            <span class="text-sm text-gray-600">Startdatum</span>
            <input id="eventStart" type="date" class="w-full p-2 border rounded" required>
          </label>
          <label>
            <span class="text-sm text-gray-600">Enddatum</span>
            <input id="eventEnd" type="date" class="w-full p-2 border rounded" required>
          </label>
        </div>

        <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
          ✅ Event speichern
        </button>
      </form>
    </section>
  `;

  document.getElementById("eventForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const hutId = document.getElementById("eventHut").value;
    const title = document.getElementById("eventTitle").value;
    const desc = document.getElementById("eventDesc").value;
    const start = new Date(document.getElementById("eventStart").value);
    const end = new Date(document.getElementById("eventEnd").value);

    if (end <= start) {
      showToast("❌ Enddatum muss nach dem Startdatum liegen!");
      return;
    }

    await db.collection("eierhuetten").doc(hutId).collection("events").add({
  title,
  desc,
  startDate: firebase.firestore.Timestamp.fromDate(new Date(start)),
  endDate: firebase.firestore.Timestamp.fromDate(new Date(end)),
  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  active: true,
});

    showToast("✅ Event erfolgreich gespeichert!");
    showMyEvents(user);
  });
  }
}




    
function showPremiumUpgrade() {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <section class="bg-white p-6 rounded-xl shadow max-w-xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4">🌟 Unterstützer werden</h2>
      <p class="text-gray-700 mb-4">Mit RadlMap Premium erhältst du:</p>
      <ul class="list-disc list-inside mb-6 text-gray-700">
        <li>🔝 Hervorgehobene Anzeige auf der Karte</li>
        <li>📸 Bis zu 10 Fotos hochladen</li>
        <li>📈 Erweiterte Statistiken</li>
        <li>💬 Kontaktmöglichkeiten in deinem Eintrag</li>
      </ul>

      <p class="font-semibold mb-4">Preis: <span class="text-green-700">2,00 €/Monat</span></p>

      <button id="activatePremiumBtn"
  class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
  ✅ Jetzt Premium aktivieren
</button>

      <button 
        class="w-full mt-4 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition"
        onclick="showDashboard()"
      >
        🔙 Zurück
      </button>
    </section>
  `;
}


async function showMyEvents(user) {
  const betreiberDoc = await db.collection("betreiber").doc(user.uid).get();
  const data = betreiberDoc.data() || {};
  
  if (data.premium) {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `<div class="text-gray-500">⏳ Lade deine Events...</div>`;

  const hutsSnapshot = await db.collection("eierhuetten").where("userId", "==", user.uid).get();
  let html = `
    <section class="bg-white p-6 rounded-xl shadow max-w-3xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4">📅 Meine Events</h2>
      <div id="eventList"></div>
    </section>
  `;
  qa.innerHTML = html;

  const list = document.getElementById("eventList");
  let found = false;

  for (const hutDoc of hutsSnapshot.docs) {
    const hut = hutDoc.data();
    const eventsSnap = await db.collection("eierhuetten").doc(hutDoc.id).collection("events").get();

    eventsSnap.forEach(evDoc => {
      found = true;
      const ev = evDoc.data();
      const now = new Date();

      let status;
      if (ev.startDate.toDate() > now) {
        status = `<span class="text-yellow-600 font-semibold">🕓 Geplant</span>`;
      } else if (ev.endDate.toDate() < now) {
        status = `<span class="text-gray-500 font-semibold">⏹️ Abgelaufen</span>`;
      } else {
        status = `<span class="text-green-700 font-semibold animate-pulse">🟢 Aktiv</span>`;
      }

      list.innerHTML += `
        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-lg font-bold text-green-800">${ev.title}</h3>
              <p class="text-sm text-gray-600">${ev.desc || ""}</p>
              <p class="text-xs mt-1">${status} | ${hut.name}</p>
              <p class="text-xs text-gray-500">
                ${ev.startDate.toDate().toLocaleDateString("de-DE")} – ${ev.endDate.toDate().toLocaleDateString("de-DE")}
              </p>
            </div>
            <div class="flex gap-2">
              <button class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600"
                onclick="editEvent('${hutDoc.id}', '${evDoc.id}')">✏️ Bearbeiten</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600"
                onclick="deleteEvent('${hutDoc.id}', '${evDoc.id}')">🗑️ Löschen</button>
            </div>
          </div>
        </div>
      `;
    });
  }

  if (!found) {
    list.innerHTML = `<p class="text-center text-gray-500">Keine Events gefunden.</p>`;
  }
  }
}




    


// robustes activatePremium
    async function activatePremium() {
  const user = firebase.auth().currentUser;
  if (!user) return alert("Bitte einloggen.");

  // Simuliere Bezahlung
  alert("✅ Test: Premium wurde aktiviert (ohne Stripe)");

  // Schreibe direkt ins Firestore
  const until = new Date(Date.now() + 30*24*60*60*1000); // +30 Tage
  await db.collection("betreiber").doc(user.uid).set({
    premium: true,
    premium_until: until.toISOString()
  }, { merge: true });

  // Danach zurück ins Dashboard
  showDashboard();
    }
/*async function activatePremium() {
  const user = firebase.auth().currentUser;
  if (!user) return alert("Bitte einloggen.");

  const btn = document.getElementById("activatePremiumBtn");
  if (btn) { btn.disabled = true; btn.textContent = "Leite weiter..."; }

  try {
    // 1) request an backend
    const res = await fetch("/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid: user.uid })
    });

    if (!res.ok) {
      // hilfreiche Fehlermeldung für Debug
      const txt = await res.text().catch(()=>"");
      throw new Error(`Server antwortete mit ${res.status}: ${txt}`);
    }

    const session = await res.json();
    if (!session || !session.id) throw new Error("Keine session.id vom Server erhalten.");

    // 2) bereitstellen / prüfen ob Stripe geladen ist
    if (typeof Stripe === "undefined" && typeof window.stripe === "undefined") {
      throw new Error("Stripe.js nicht geladen. Bitte src='https://js.stripe.com/v3/'> einbinden.");
    }

    // Verwende vorhandene globale public key-Variable oder setze sie hier:
    // (besser: public key in config, nicht hardcoden)
    const PUBLISHABLE_KEY = window.RADLMAP_STRIPE_PUBKEY || "pk_live_51SFLg0PfD3BVBNRdvVxf0hegWHOzKrAF7OqCHeMRqZtGtzCTtvbIaVIf0ChrAZss5XJ4Mafdh9z4HUa90J4IacsU00FnIAB2xk";

    const stripeInstance = (typeof window._stripeInstance !== "undefined")
      ? window._stripeInstance
      : Stripe(PUBLISHABLE_KEY);

    window._stripeInstance = stripeInstance;

    // 3) Redirect
    const result = await stripeInstance.redirectToCheckout({ sessionId: session.id });
    if (result && result.error) throw new Error(result.error.message);

  } catch (err) {
    console.error("activatePremium error:", err);
    alert("Fehler beim Starten der Bezahlung: " + (err.message || err));
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = "✅ Jetzt Premium aktivieren"; }
  }
}*/
async function cancelPremium() {
  const user = firebase.auth().currentUser;
  if (!user) return alert("Bitte einloggen.");

  if (!confirm("Möchtest du dein Premium wirklich kündigen? Dein Status wird am Ende des bezahlten Zeitraums auf 'Kostenlos' zurückgesetzt.")) return;

  await db.collection("betreiber").doc(user.uid).update({
    premium: false,
    // premium_until bleibt bestehen, um den Status bis zum Ablauf zu gewähren
  });

  alert("❌ Dein Premium-Abo wurde gekündigt. Du kannst es bis zum Ablauf weiter nutzen.");
  showAccountSettings(); // Ansicht neu laden
}
// Wenn du inline onclick nutzt: sorgt dafür, dass die Funktion existiert
document.addEventListener("click", (e) => {
  if (e.target && e.target.id === "activatePremiumBtn") {
    activatePremium();
  }
});

// ⏱️ Ablauf prüfen
/*function checkPremiumExpiration() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection("betreiber").doc(user.uid).get().then(doc => {
    const data = doc.data();
    if (data?.premium_until) {
      const today = new Date();
      const until = new Date(data.premium_until);
      if (today > until) {
        db.collection("betreiber").doc(user.uid).update({ premium: false });
      }
    }
  });
}*/
    function checkPremiumExpiration() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection("betreiber").doc(user.uid).get().then(doc => {
    const data = doc.data();
    if (data?.premium_until) {
      const today = new Date();
      const until = new Date(data.premium_until);
      if (today > until) {
        db.collection("betreiber").doc(user.uid).update({ premium: false });
      }
    }
  });
    }

async function showLimitsSection(user, isPremium) {
  const qa = document.getElementById("statsArea");
  if (!qa) return;

  const entriesSnap = await db.collection("eierhuetten")
    .where("ownerUid", "==", user.uid)
    .get();

  const count = entriesSnap.size;
  const limit = isPremium ? 999 : 1; // Free: 1 Eintrag, Premium: praktisch unbegrenzt
  const pct = Math.min((count / limit) * 100, 100).toFixed(0);

  // Section erstellen
  const box = document.createElement("div");
  box.className = "bg-white p-4 rounded-xl shadow mb-6";

  if (isPremium) {
    box.innerHTML = `
      <h3 class="text-lg font-bold text-green-700 mb-2">🔓 Premium-Vorteile</h3>
      <p class="text-gray-600 mb-3">Du kannst unbegrenzt Hütten hinzufügen und bis zu 10 Fotos pro Hütte hochladen.</p>
      <div class="w-full bg-green-100 h-3 rounded"><div class="h-3 bg-green-500 rounded w-full"></div></div>
      <p class="text-sm text-green-700 mt-2 font-semibold">✔️ Keine Limits aktiv</p>
    `;
  } else {
    box.innerHTML = `
      <h3 class="text-lg font-bold text-gray-800 mb-2">⚙️ Dein aktueller Fortschritt</h3>
      <p class="text-gray-600 mb-3">Du hast <b>${count}</b> von <b>${limit}</b> möglichen Einträgen erstellt.</p>
      <div class="w-full bg-gray-200 h-3 rounded"><div class="h-3 bg-green-500 rounded" style="width:${pct}%;"></div></div>
      <p class="text-sm text-gray-600 mt-2">${pct}% deines Limits erreicht</p>
      ${count >= limit ? `
        <div class="mt-4 text-center">
          <p class="text-red-600 text-sm mb-2">🚫 Du hast dein Limit erreicht.</p>
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition"
            onclick="showPremiumUpgrade()">🌟 Jetzt auf Premium upgraden</button>
        </div>` : ""}
    `;
  }

  qa.insertAdjacentElement("afterend", box);
}

  
function showTutorial() {
  const qa = document.getElementById("question-area");
  mode = "tutorial";

  const tutorialHTML = `
    <section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">
      <header class="mb-6 text-center">
        <h2 class="text-3xl font-extrabold text-green-600 mb-2">👋 Willkommen!</h2>
        <p class="text-gray-600 text-lg">
          Schön, dass du den <span class="font-semibold text-green-600">Hütten-Assistent</span> benutzt.
          Hier ein kurzer Überblick über die wichtigsten Funktionen:
        </p>
      </header>

      <ul class="space-y-5 text-gray-700">
        <li class="flex items-start">
          <span class="text-green-500 mr-3 text-xl">➕</span>
          <p>
            <strong>„Neue Eintragung“</strong> – Erstelle eine neue Hütten-/Hofladen-Eintragung mit Fotos und Informationen.
          </p>
        </li>

        <li class="flex items-start">
          <span class="text-green-500 mr-3 text-xl">📋</span>
          <p>
            <strong>„Meine Eintragungen“</strong> – Übersicht über deine Einträge: Status, Fotos, Standort und Bearbeitungsmöglichkeiten.
          </p>
        </li>

        <li class="flex items-start">
          <span class="text-green-500 mr-3 text-xl">💬</span>
          <p>
            <strong>„Hütten-Nachrichten“</strong> – Hier sammeln sich Nachrichten von Besuchern zu deinen Hütten.
            Neue Nachrichten erscheinen durch das rote Badge in der Seitenleiste. Du kannst Nachrichten öffnen, lesen und (als Hütten-Besitzer) einzelne Nachrichten löschen.
          </p>
        </li>

        <li class="flex items-start">
          <span class="text-green-500 mr-3 text-xl">🆘</span>
          <p>
            <strong>„Support“</strong> – Melde Probleme oder stelle Fragen an das Team. Support-Tickets werden gespeichert.
          </p>
        </li>
      </ul>

      <footer class="mt-8 text-center">
        <p class="text-sm text-gray-500">
          💡 Tipp: Das System aktualisiert Nachrichten live — das Badge zeigt neue, ungelesene Nachrichten an.
        </p>
      </footer>
    </section>
  `;

  qa.innerHTML = tutorialHTML;
  updateInfoBox();
}
let hutMessagesUnsub = null;       // Listener für die Liste
let hutMessagesBadgeUnsub = null;  // Listener für die Sidebar-Badge

// -------------------
// Seite "Hütten-Nachrichten" öffnen
// -------------------
function showHutMessages() {
  const qa = document.getElementById("question-area");
  mode = "hutMessages";

  const hutMessagesHTML = `
    <section class="bg-white p-6 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">
      <header class="mb-4 text-center">
        <h2 class="text-2xl font-extrabold text-green-600 mb-2">🏡 Hütten-Nachrichten</h2>
        <p class="text-gray-600 text-sm">Hier findest du Nachrichten, die Besucher zu deinen Hütten geschrieben haben.</p>
      </header>
      <div id="hutMessagesList" class="divide-y divide-gray-200 text-sm">
        <div class="text-gray-400 p-4">⏳ Lade Nachrichten...</div>
      </div>
      <footer class="mt-4 text-center">
        <div id="hutMessagesBadge" class="hidden text-red-600 font-semibold">🔔 Neue Nachrichten!</div>
      </footer>
    </section>
  `;

  qa.innerHTML = hutMessagesHTML;
  ladeHutMessagesLive();  // Nachrichten live laden
  updateInfoBox();
}

// -------------------
// Sidebar-Badge immer aktuell halten
// -------------------
async function initHutMessagesBadge() {
  if (hutMessagesBadgeUnsub) { hutMessagesBadgeUnsub(); hutMessagesBadgeUnsub = null; }
  if(!currentUser) return;

  const huettenSnap = await db.collection("eierhuetten")
    .where("userId", "==", currentUser.uid)
    .get();

  if (huettenSnap.empty) {
    const counter = document.getElementById("hutMessagesCount");
    if (counter) counter.classList.add("hidden");
    return;
  }

  const hutIds = huettenSnap.docs.map(d => d.id);

  // in Batches von 10 IDs splitten
  const batches = [];
  for (let i = 0; i < hutIds.length; i += 10) {
    const batchIds = hutIds.slice(i, i + 10);
    batches.push(
      db.collection("hutMessages")
        .where("hutId", "in", batchIds)
    );
  }

  // mehrere Listener kombinieren
  const counters = [];
  hutMessagesBadgeUnsub = () => counters.forEach(unsub => unsub());

  batches.forEach(batchQuery => {
    const unsub = batchQuery.onSnapshot(snap => {
      let neuCount = 0;
      snap.forEach(doc => {
        if (doc.data().answered === false) neuCount++;
      });

      const counter = document.getElementById("hutMessagesCount");
      if (counter) {
        if (neuCount > 0) {
          counter.textContent = neuCount;
          counter.classList.remove("hidden");
        } else {
          counter.classList.add("hidden");
        }
      }
    });
    counters.push(unsub);
  });
}

// -------------------
// Nachrichten-Liste für die Seite
// -------------------
async function ladeHutMessagesLive() {
  const list = document.getElementById("hutMessagesList");
  const counter = document.getElementById("hutMessagesCount");

  if (!currentUser || !currentUser.uid) {
    if (list) list.innerHTML = `<div class="p-4 text-gray-500">Bitte anmelden, um Nachrichten zu sehen.</div>`;
    if (counter) counter.classList.add("hidden");
    return;
  }

  if (hutMessagesUnsub) { hutMessagesUnsub(); hutMessagesUnsub = null; }

  const huettenSnap = await db.collection("eierhuetten")
    .where("userId", "==", currentUser.uid)
    .get();

  if (huettenSnap.empty) {
    if (list) list.innerHTML = `<div class="p-4 text-gray-500">Keine eigenen Hütten gefunden.</div>`;
    if (counter) counter.classList.add("hidden");
    return;
  }

  const hutIds = huettenSnap.docs.map(d => d.id);

  // split into batches
  const batches = [];
  for (let i = 0; i < hutIds.length; i += 10) {
    batches.push(
      db.collection("hutMessages")
        .where("hutId", "in", hutIds.slice(i, i + 10))
        .orderBy("createdAt", "desc")
    );
  }

  const unsubs = [];
  hutMessagesUnsub = () => unsubs.forEach(u => u());

  list.innerHTML = "⏳ Lade Nachrichten...";

  // wir sammeln alle Messages aus allen Batches
  batches.forEach(query => {
    const unsub = query.onSnapshot(snap => {
      const allMessages = [];

      // alle Batches abfragen
      Promise.all(batches.map(b => b.get())).then(results => {
        results.forEach(batchSnap => {
          batchSnap.forEach(doc => {
            allMessages.push({ id: doc.id, ...doc.data() });
          });
        });

        // sortieren nach Datum
        allMessages.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());

        // rendern
        if (allMessages.length === 0) {
          list.innerHTML = `<div class="p-4 text-gray-500">Keine Nachrichten vorhanden.</div>`;
          if (counter) counter.classList.add("hidden");
          return;
        }

        let neuCount = 0;
        list.innerHTML = "";
        allMessages.forEach(d => {
          if (d.answered === false) neuCount++;
          const datum = d.createdAt?.toDate?.().toLocaleString("de-DE") || "-";
          list.innerHTML += `
            <div class="p-4 border-b">
              <div class="text-xs text-gray-500">${datum}</div>
              <div class="font-semibold">${d.hutName || "-"}</div>
              <div class="mt-1">${d.message || ""}</div>
              <div class="text-xs text-gray-400 mt-1">von ${d.senderName || "Gast"}</div>
                 <button 
        class="text-red-500 text-sm hover:underline"
        onclick="deleteHutMessage('${d.id}')"
      >Löschen</button>
            </div>
          `;
        });

        // Badge aktualisieren
        if (counter) {
          counter.textContent = `${neuCount}/${allMessages.length}`;
          counter.classList.remove("hidden");
        }
      });
    });

    unsubs.push(unsub);
  });
}
    async function deleteHutMessage(id) {
  if (!confirm("Willst du diese Nachricht wirklich löschen?")) return;
  try {
    await db.collection("hutMessages").doc(id).delete();
    console.log("Nachricht gelöscht:", id);
  } catch (err) {
    console.error("Fehler beim Löschen:", err);
    alert("❌ Konnte Nachricht nicht löschen");
  }
  }
  function selectOption(field, value, el) {
    // deselect siblings
    if (el && el.parentNode) {
      el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
      el.classList.add('selected');
    }
    editingData[field] = value;
  }

  function nextStep() {
    // validation for some steps
    if (step === 0) {
      const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked;
      if (!ok) { alert('Bitte Datenschutzerklärung akzeptieren'); return; }
      editingData.datenschutz = true;
    }
    if (step === 1) {
        if (!editingData.typ) { alert("Bitte einen Typ auswählen."); return; }
    }
    if (step === 2) {
      const v = document.getElementById('nameInput')?.value?.trim();
      if (!v) { alert('Bitte Namen eingeben'); return; }
      editingData.name = v;
    }
    if (step === 5) {
        const oeff = collectOpeningHours();
        editingData.oeffnungszeiten = oeff;
    }
    if (step === 6) {
      editingData.extras = document.getElementById('extrasInput')?.value?.trim();
    }
    if (step === 8) {
        // Die Beschreibung wird live über den Quill-Editor in `editingData.beschreibung` gespeichert
    }
    if (step === 9) {
      const raw = document.getElementById('tagsInput')?.value || '';
      editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
    }

    if (step < stepsCount - 1) {
      step++;
      renderQuestion();
      updateProgress();
    } else {
        // Letzter Schritt -> zur Übersicht
        renderQuestion();
    }
  }

  function prevStep() {
    if (step > 0) step--;
    renderQuestion();
    updateProgress();
  }

  function startNewEntry() {
    if (!currentUser || !currentUser.uid) {
        showToast("Bitte zuerst einloggen");
        return;
    }
    editingData = {};
    step = 0;
    mode = "entry";
    document.getElementById("navBottom").style.display = "flex";
    renderQuestion();
    if(window.innerWidth < 768) toggleSidebar();
    updateProgress();
  }

function collectOpeningHoursFromUI() {
  const immer = document.getElementById("immerCheck")?.checked;
  if (immer) {
    return "Immer geöffnet";
  }

  const days = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  const arr = [];
  days.forEach(d => {
    const vonEl = document.getElementById(`open-${d}-von`);
    const bisEl = document.getElementById(`open-${d}-bis`);
    const von = vonEl?.value.trim();
    const bis = bisEl?.value.trim();

    if (von && bis) {
      arr.push({ tag: d, von, bis });
    }
  });
  return arr;
}
    function renderOpeningHours(oeff) {
  if (!oeff) return "–";

  // Fall 1: String
  if (typeof oeff === "string") {
    if (oeff.toLowerCase().includes("immer")) {
      return "Immer geöffnet ✅";
    }
    return oeff; // z.B. "09:00 – 18:00"
  }

  // Fall 2: Map mit immer:true
  if (typeof oeff === "object" && !Array.isArray(oeff)) {
    if (oeff.immer === true) return "Immer geöffnet ✅";

    // Falls in Zukunft auch andere Felder im Objekt gespeichert
    let keys = Object.keys(oeff);
    return keys.map(k => `${k}: ${oeff[k]}`).join("<br>");
  }

  // Fall 3: Array [{tag, von, bis}, …]
  if (Array.isArray(oeff)) {
    if (oeff.length === 0) return "–";
    return oeff.map(o => `${o.tag}: ${o.von} – ${o.bis}`).join("<br>");
  }

  return "–";
    }
  
  async function submitEntry() {
  if (!editingData.name || !editingData.typ) {
    alert('Bitte Typ und Name ausfüllen.');
    return;
  }

  // Öffnungszeiten normalisieren bevor sie gespeichert werden
  const rawOeff = collectOpeningHoursFromUI();
  const normalizedOeff = normalizeOpeningHours(rawOeff);

  const payload = {
    userId: currentUser.uid,
    userMail: currentUser.email,
    name: editingData.name,
    typ: editingData.typ,
    sitzplaetze: editingData.sitzplaetze || 'Nein',
    strom: editingData.strom || 'Nein',
    extras: editingData.extras || '',
    tiere: editingData.tiere || [],
    beschreibung: editingData.beschreibung || '',
    tags: editingData.tags || [],
    oeffnungszeiten: normalizedOeff,
    status: 'offen',
    views: 0,
    routeStarts: 0,
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
    datenschutzZustimmung: {
      bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(),
      durch: currentUser.email || null
    }
  };

  if (editingData.location?.lat && editingData.location?.lng) {
    payload.location = new firebase.firestore.GeoPoint(
      editingData.location.lat,
      editingData.location.lng
    );
  }

  try {
    await db.collection('eierhuetten').add(payload);
    showToast('✅ Eintragung gesendet. Wird geprüft.');
    navigateTo('btnEntries', showMyEntries);
  } catch (err) {
    console.error('submitEntry error', err);
    alert('Fehler beim Senden: ' + (err.message || err));
  }
               }

let overviewMap;
let overviewMarker;

function initOverviewMap(lat = 51.1657, lng = 10.4515, zoom = 6) {
  if (overviewMap) {
      overviewMap.remove();
      overviewMap = null;
  }
  
  overviewMap = L.map("overview-map").setView([lat, lng], zoom);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(overviewMap);
  
  overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap);
  overviewMarker.on("dragend", ev => {
      const p = ev.target.getLatLng();
      editingData.location = { lat: p.lat, lng: p.lng };
  });

  editingData.location = { lat, lng };
}


function locateGPS() {
  if (!navigator.geolocation) return alert("❌ GPS nicht verfügbar");
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      initOverviewMap(latitude, longitude, 15);
    },
    err => {
      alert("❌ GPS-Fehler: " + err.message);
    }
  );
}


    const stepInfos = {
  0: {
    title: "Datenschutz",
    text: "Bitte lies die Datenschutzerklärung aufmerksam und bestätige sie. Ohne Zustimmung können wir keine Daten annehmen."
  },
  1: {
    title: "Art der Eintragung",
    text: "Wähle, ob du eine Eierhütte, Hofladen, Selbstbedienungshäuschen, Spielplatz oder Abenteuerhof eintragen möchtest."
  },
  2: {
    title: "Name der Hütte",
    text: "Verwende einen kurzen, prägnanten Namen, z. B. „Eierhütte am Dorfplatz“."
  },
  3: {
    title: "Sitzplätze",
    text: "Falls es Sitzgelegenheiten gibt, wähle Ja. Sonst Nein."
  },
  4: {
    title: "Strom",
    text: "Angabe, ob Strom verfügbar ist. (z.B. zum Aufladen des E-Bikes oder für das Handy)."
  },
  5: {
    title: "Öffnungszeiten",
    text: "Trage hier die Zeiten ein, zu denen dein Angebot verfügbar ist, oder wähle 'Immer geöffnet'."
  },
  6: {
    title: "Extras",
    text: "Hier kannst du Besonderheiten angeben, z. B. Getränke, Kühlschrank, Grillmöglichkeiten."
  },
  7: {
    title: "Tiere",
    text: "Wähle alle Tiere aus, die es vor Ort gibt. Falls keine Tiere da sind, bitte „Keine Tiere“ auswählen."
  },
  8: {
    title: "Beschreibung",
    text: "Beschreibe deine Hütte, den Hof oder den Ort möglichst ausführlich. Nutze den KI-Button für einen automatischen Vorschlag!"
  },
  9: {
    title: "Tags",
    text: "Gib Schlagwörter ein, damit andere die Hütte besser finden können (max. 10). Z. B. „regional, Bio, Frühstück“. Auch hier hilft dir die KI."
  },
  10: {
    title: "Übersicht & Standort",
    text: "Hier siehst du alle Angaben zusammen. Wähle den Standort per Klick auf die Karte oder GPS. Du kannst den Marker mit Drag & Drop verschieben."
  }
};
    function updateInfoBox() {
  const boxDesktop = document.getElementById("infoBox");
  const boxMobile = document.getElementById("infoBoxMobile");

  let html = "";

  if (mode === "entry") {
    const info = stepInfos[step];
    if (info) {
      html = `
        <h4 class="font-semibold">${info.title}</h4>
        <p>${info.text}</p>
      `;
    } else {
      html = "<p>Keine weiteren Informationen verfügbar.</p>";
    }
  } else if (mode === "list") {
    html = `
      <h4 class="font-semibold">📋 Meine Eintragungen</h4>
      <p>Hier siehst du deine bereits eingereichten Hütten.<br>
      Bearbeiten ist nur möglich, sobald die Hütte freigegeben wurde.</p>
    `;
  } else if (mode === "tutorial") {
    html = `
      <h4 class="font-semibold">👋 Willkommen</h4>
      <p>Du befindest dich hier im Tutorial, <br>
      hier wird Dir alles erklärt. </p>
    `;
  }  else if (mode === "support") {
    html = `
      <h4 class="font-semibold">💬 Support</h4>
      <p>Stelle hier deine Fragen oder melde Probleme.<br>
      Deine Tickets werden gespeichert und können später eingesehen oder gelöscht werden.</p>
    `;
  } else if (mode === "hutMessages") {
  html = `
    <h4 class="font-semibold">🏡 Hütten-Nachrichten</h4>
    <p>
      Hier siehst du alle Nachrichten, die Besucher zu deinen Hütten geschickt haben.<br>
      Diese Übersicht aktualisiert sich automatisch, sobald neue Nachrichten eintreffen.
    </p>
    <p class="mt-1 text-sm text-gray-500">
      Tipp: Neue Nachrichten erkennst du am roten 🔔 Badge in der Seitenleiste.
    </p>
  `;
  } else {
    html = "<p>ℹ️ Wähle links eine Funktion aus.</p>";
  }

  // ✨ Desktop-Bereich befüllen
  if (boxDesktop) boxDesktop.innerHTML = html;
  // ✨ Mobile Overlay befüllen
  if (boxMobile) boxMobile.innerHTML = html;
    }
  /***********************
   * Sidebar actions: Meine Eintragungen (mit Bearbeitung)
   ***********************/
// ================================
// 🔁 MyEntries 3.0 - Neues Design
// ================================
async function showMyEntries() {
  if (!firebase.auth().currentUser) {
    showToast("Bitte zuerst einloggen");
    return;
  }
  const uid = firebase.auth().currentUser.uid;
  mode = 'list';
  document.getElementById("navBottom").style.display = 'none';

  const container = document.getElementById("question-area");
  container.innerHTML = `
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <span class="w-12 h-12 bg-green-200 text-green-700 flex items-center justify-center rounded-full text-2xl">📋</span>
            Meine Eintragungen
        </h2>
        <button onclick="navigateTo('btnNewEntry', startNewEntry)" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
            Neue Eintragung
        </button>
      </div>
      <div id="entriesList" class="space-y-6"></div>
    </div>
  `;
  const list = document.getElementById("entriesList");
  list.innerHTML = `<div class="col-span-3 text-gray-500 text-center py-10">⏳ Lade Eintragungen…</div>`;

  try {
    const snap = await db.collection("eierhuetten")
      .where("userId", "==", uid)
      .orderBy("erstelltAm", "desc")
      .get();

    const docs = snap.docs.filter(d => {
      const st = d.data().status;
      return st !== 'archiviert' && st !== 'deleted';
    });

    if (docs.length === 0) {
      list.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-md text-center text-gray-600">
        <h3 class="text-xl font-semibold mb-2">Noch keine Einträge vorhanden</h3>
        <p>Klicke auf "Neue Eintragung", um loszulegen!</p>
      </div>`;
      return;
    }
    
    list.innerHTML = ''; // Clear loader

    for (const doc of docs) {
      const d = doc.data();
      const id = doc.id;
      const img = Array.isArray(d.fotos) && d.fotos.length ? (typeof d.fotos[0] === 'string' ? d.fotos[0] : d.fotos[0].url) : 'https://radlmap.net/img/noimg/1.jpg';
      
      const statusBadges = {
          'offen': '<span class="text-yellow-600 bg-yellow-100 px-2 py-1 text-xs font-semibold rounded-full">Wird geprüft</span>',
          'angenommen': '<span class="text-green-600 bg-green-100 px-2 py-1 text-xs font-semibold rounded-full">Sichtbar</span>',
          'abgelehnt': '<span class="text-red-600 bg-red-100 px-2 py-1 text-xs font-semibold rounded-full">Abgelehnt</span>'
      };

      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300';
      
      let tagsHTML = (d.tags || []).slice(0, 4).map(t => `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${escapeHtml(t)}</span>`).join('');
      if ((d.tags || []).length > 4) {
          tagsHTML += `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">+${(d.tags || []).length - 4}</span>`;
      }

      card.innerHTML = `
        <div class="p-5">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center">
                        <img src="${escapeAttr(img)}" class="w-full h-full object-cover rounded-lg">
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">${escapeHtml(d.name || 'Unbenannt')}</h3>
                        <p class="text-sm text-gray-500">${escapeHtml(d.typ || '')}</p>
                    </div>
                </div>
                ${statusBadges[d.status] || d.status}
            </div>

            <img src="${escapeAttr(img)}" alt="${escapeAttr(d.name||'')}" class="w-full h-48 object-cover rounded-lg mb-4">
            
            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${stripHtml(d.beschreibung || 'Keine Beschreibung vorhanden.')}</p>

            <div class="flex flex-wrap gap-2 mb-4">
                ${tagsHTML}
            </div>
            
            <div class="border-t border-gray-200 pt-4 flex justify-between items-center">
                <div class="flex gap-4 text-sm text-gray-500">
                    <span class="flex items-center gap-1">👁️ ${d.views || 0}</span>
                    <span class="flex items-center gap-1">📍 ${d.routeStarts || 0}</span>
                    <span>📅 ${d.erstelltAm ? d.erstelltAm.toDate().toLocaleDateString('de-DE') : '-'}</span>
                </div>
                <div class="flex gap-3">
                    <button class="view-btn px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition text-sm" data-id="${id}">Ansehen</button>
                    <button class="edit-btn px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition text-sm" data-id="${id}">Bearbeiten</button>
                    <button class="delete-btn p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" data-id="${id}" data-name="${escapeAttr(d.name||'')}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
      `;
      list.appendChild(card);
    }

    // event delegation for buttons
    list.querySelectorAll('.edit-btn, .view-btn').forEach(btn => {
      btn.addEventListener('click', (e) => openEditPage(btn.dataset.id));
    });
    list.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => confirmDeleteEntry(btn.dataset.id, btn.dataset.name));
    });

  } catch (err) {
    console.error('showMyEntries error', err);
    list.innerHTML = `<div class="bg-red-100 p-4 rounded text-center">Fehler beim Laden: ${err.message}</div>`;
  }
}

// ================================
// Löschen mit Nachfrage (übersicht + detail)
// ================================
function confirmDeleteEntry(id, name) {
  const proceed = confirm(`⚠️ Möchtest du die Eintragung "${name || id}" wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.`);
  if (!proceed) return;
  db.collection('eierhuetten').doc(id).delete()
    .then(() => {
      showToast('✅ Eintragung gelöscht');
      showMyEntries();
    })
    .catch(err => {
      console.error('delete error', err);
      showToast('❌ Fehler beim Löschen: ' + (err.message || err));
    });
}

// ================================
// Detailseite: Statistik + Bearbeitungsformular
// ================================
 
async function openEditPage(id) {
  if (!id) return;
  try {
    const docRef = db.collection("eierhuetten").doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) return showToast("❌ Eintrag nicht gefunden");
    const d = docSnap.data();

    const container = document.getElementById("question-area");
    container.innerHTML = `
      <div class="max-w-5xl mx-auto">
        <button id="backToList" class="mb-4 text-sm text-blue-600 hover:underline">⬅️ Zurück zur Übersicht</button>

        <div class="flex flex-col md:flex-row gap-6">

          <div id="photoUploaderContainer" class="w-full md:w-1/3 bg-white rounded-xl p-4 shadow"></div>

          <div class="w-full md:w-2/3">
            <div class="bg-white rounded-xl p-6 shadow space-y-4">
              <h4 class="font-semibold text-lg mb-2">Bearbeitungsformular</h4>

              <label class="block">
                <span class="text-gray-700">Name</span>
                <input id="editName" value="${escapeAttr(d.name || "")}" class="w-full border rounded p-2 mt-1">
              </label>

              <label class="block">
                <span class="text-gray-700">Beschreibung</span>
                <div id="quillContainer" class="bg-white border rounded p-2 min-h-[150px]">${d.beschreibung || ""}</div>
                <button id="generateDescBtn" class="mt-3 px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition">🪄 Automatische KI-Beschreibung erstellen</button>
              </label>
              
              <div class="grid grid-cols-2 gap-3">
                <label>
                  <span class="text-gray-700">Sitzplätze</span>
                  <select id="editSitz" class="w-full border rounded p-2">
                    <option ${d.sitzplaetze === "Ja" ? "selected" : ""}>Ja</option>
                    <option ${d.sitzplaetze === "Nein" ? "selected" : ""}>Nein</option>
                  </select>
                </label>
                <label>
                  <span class="text-gray-700">Strom</span>
                  <select id="editStrom" class="w-full border rounded p-2">
                    <option ${d.strom === "Ja" ? "selected" : ""}>Ja</option>
                    <option ${d.strom === "Nein" ? "selected" : ""}>Nein</option>
                  </select>
                </label>
              </div>

              <label class="block">
                <span class="text-gray-700">Extras</span>
                <input id="editExtras" value="${escapeAttr(d.extras || "")}" class="w-full border rounded p-2 mt-1">
              </label>

              <label class="block">
                <span class="text-gray-700">Tiere</span>
                <div id="tiereButtons" class="flex flex-wrap gap-2 mt-2"></div>
              </label>

              <label class="block">
                <span class="text-gray-700">Tags</span>
                 <div class="relative">
                    <input id="editTags" value="${Array.isArray(d.tags) ? escapeAttr(d.tags.join(", ")) : ""}" class="w-full border rounded p-2 mt-1">
                    <button onclick="suggestTagsForEdit('${id}')" class="absolute top-1/2 right-2 -translate-y-1/2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">🪄 KI</button>
                </div>
              </label>

              <div id="openingEditorWrapper" class="mt-3">
                ${typeof renderOpeningHoursEditor === "function"
                  ? renderOpeningHoursEditor(id, d.oeffnungszeiten)
                  : `<label><span class="text-gray-700">Öffnungszeiten</span>
                      <textarea id="editOpening" class="w-full border rounded p-2 mt-1">${escapeAttr(
                        JSON.stringify(d.oeffnungszeiten || {})
                      )}</textarea></label>`}
              </div>

              <div class="flex justify-end gap-3 pt-4">
                <button id="deleteEntryBtn" class="px-4 py-2 bg-red-600 text-white rounded">🗑️ Löschen</button>
                <button id="saveEntryBtn" class="px-4 py-2 bg-green-600 text-white rounded">💾 Speichern</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // === Navigation zurück
    document.getElementById("backToList").onclick = () => showMyEntries();

    // === Tiere-Buttons
    const animals = ["🐐 Ziege", "🐄 Kuh", "🐓 Huhn", "🐕 Hund", "🐇 Hase", "🐈 Katze", "Keine Tiere"];
    const tiereContainer = document.getElementById("tiereButtons");
    const selected = d.tiere || [];
    animals.forEach((t) => {
      const b = document.createElement("button");
      b.className = `px-2 py-1 border rounded text-sm transition ${selected.includes(t) ? "bg-green-200" : "bg-gray-100"}`;
      b.textContent = t;
      b.onclick = (e) => {
        e.stopPropagation();
        if (t === "Keine Tiere") selected.splice(0, selected.length, "Keine Tiere");
        else {
          const idx = selected.indexOf(t);
          idx >= 0 ? selected.splice(idx, 1) : selected.push(t);
          const none = selected.indexOf("Keine Tiere");
          if (none >= 0) selected.splice(none, 1);
        }
        tiereContainer.querySelectorAll("button").forEach((btn) =>
          btn.classList.toggle("bg-green-200", selected.includes(btn.textContent))
        );
      };
      tiereContainer.appendChild(b);
    });

    // === Quill Editor mit Undo/Redo
    let quill;
    setTimeout(() => {
      quill = new Quill("#quillContainer", {
        theme: "snow",
        modules: { history: { delay: 1000, maxStack: 50 } },
      });
      if (d.beschreibung) quill.root.innerHTML = d.beschreibung;
    }, 120);

    // === KI-Beschreibung mit Vorschau
    document.getElementById("generateDescBtn").onclick = async () => {
      const previewText = await generateProfessionalDescription(d);
      const confirmAdd = confirm("Vorschlag der KI-Beschreibung:\n\n" + previewText + "\n\n➡️ Möchtest du sie übernehmen?");
      if (confirmAdd && quill) {
        quill.root.innerHTML = `<p>${previewText.replace(/\n/g, '</p><p>')}</p>`;
      }
    };

    // === Speichern
    document.getElementById("saveEntryBtn").onclick = async () => {
      const beschreibung = quill?.root.innerHTML || "";
      const updated = {
        name: document.getElementById("editName").value.trim(),
        sitzplaetze: document.getElementById("editSitz").value,
        strom: document.getElementById("editStrom").value,
        extras: document.getElementById("editExtras").value,
        tags: document.getElementById("editTags").value.split(",").map((s) => s.trim()).filter(Boolean),
        tiere: selected,
        beschreibung,
        oeffnungszeiten: typeof collectOpeningHours === "function" ? collectOpeningHours(id) : d.oeffnungszeiten,
      };
      await docRef.update(updated);
      showToast("✅ Gespeichert");
      openEditPage(id);
    };

    // === Löschen
    document.getElementById("deleteEntryBtn").onclick = () => confirmDeleteEntry(id, d.name);

    // === 📸 Image-Upload mit smarter Integration
    renderSmartImageUploader(
      document.getElementById("photoUploaderContainer"),
      docRef,
      d.fotos || [],
      id,
      d.name || ""
    );

  } catch (err) {
    console.error("openEditPage error", err);
    showToast("❌ Fehler: " + err.message);
  }
}



/* === 💫 Vorschau mit Stil-Auswahl & Neu-Generieren === */
function showAIDescriptionPreview(generateFn, data, photos, onConfirm) {
  const old = document.getElementById("aiModal");
  if (old) old.remove();

  const modal = document.createElement("div");
  modal.id = "aiModal";
  modal.className = "fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm";

  const box = document.createElement("div");
  box.className = "bg-white rounded-xl shadow-xl max-w-lg w-full p-6 space-y-4";
  modal.appendChild(box);

  box.innerHTML = `
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-green-700">Vorgeschlagene Beschreibung</h3>
      <button id="closeAiModal" class="text-gray-400 hover:text-gray-600">✖</button>
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-600">Stil:</label>
      <select id="aiStyleSelect" class="border rounded p-1 text-sm">
        <option value="romantisch">🌸 Romantisch</option>
        <option value="sachlich">📘 Sachlich</option>
        <option value="kurz">⚡ Kurz & Prägnant</option>
      </select>
    </div>
    <div id="aiPreviewText" class="text-gray-700 text-sm leading-relaxed max-h-60 overflow-y-auto border rounded p-3 bg-gray-50"></div>
    <div class="flex justify-end gap-3">
      <button id="regenAiBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">🔁 Neu generieren</button>
      <button id="applyAiBtn" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">✅ Übernehmen</button>
      <button id="cancelAiBtn" class="px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm hover:bg-gray-400">❌ Abbrechen</button>
    </div>
  `;

  document.body.appendChild(modal);

  const preview = box.querySelector("#aiPreviewText");
  const styleSel = box.querySelector("#aiStyleSelect");
  const regen = box.querySelector("#regenAiBtn");
  const apply = box.querySelector("#applyAiBtn");
  const cancel = box.querySelector("#cancelAiBtn");
  const close = box.querySelector("#closeAiModal");

  async function refresh() {
    const style = styleSel.value;
    const txt = generateFn(data, photos, style);
    preview.innerHTML = txt.replace(/\n/g, "<br>");
  }

  regen.onclick = refresh;
  styleSel.onchange = refresh;
  cancel.onclick = () => modal.remove();
  close.onclick = () => modal.remove();
  apply.onclick = () => {
    onConfirm(preview.innerText);
    modal.remove();
  };

  refresh();
}
/* === Vorschau-Dialog für automatisch generierte Beschreibung === */
function showDescriptionPreview(generateFn, data, images, onConfirm) {
  // Falls schon ein Modal existiert, entfernen
  const old = document.getElementById('descModal');
  if (old) old.remove();

  const modal = document.createElement('div');
  modal.id = 'descModal';
  modal.className =
    'fixed inset-0 bg-black/50 flex items-center justify-center z-50';

  const box = document.createElement('div');
  box.className =
    'bg-white rounded-xl shadow-xl max-w-lg w-full p-6 space-y-4';
  modal.appendChild(box);

  const header = document.createElement('div');
  header.innerHTML =
    '<h3 class="text-lg font-semibold mb-2">Vorgeschlagene Beschreibung</h3>';
  box.appendChild(header);

  const content = document.createElement('div');
  content.id = 'descPreviewText';
  content.className = 'text-gray-700 text-sm leading-relaxed max-h-60 overflow-y-auto border rounded p-3 bg-gray-50';
  box.appendChild(content);

  const buttonRow = document.createElement('div');
  buttonRow.className = 'flex justify-end gap-3 pt-4';
  box.appendChild(buttonRow);

  const regenBtn = document.createElement('button');
  regenBtn.textContent = '🔁 Neu generieren';
  regenBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700';
  buttonRow.appendChild(regenBtn);

  const okBtn = document.createElement('button');
  okBtn.textContent = '✅ Übernehmen';
  okBtn.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
  buttonRow.appendChild(okBtn);

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '❌ Abbrechen';
  cancelBtn.className = 'px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm hover:bg-gray-400';
  buttonRow.appendChild(cancelBtn);

  // Funktionen
  async function refreshText() {
    const txt = await generateFn(data, images);
    content.innerHTML = txt.replace(/\n/g, '<br>');
  }
  regenBtn.onclick = refreshText;
  cancelBtn.onclick = () => modal.remove();
  okBtn.onclick = () => {
    onConfirm(content.innerText);
    modal.remove();
  };

  document.body.appendChild(modal);
  refreshText();
}

/* === Beispiel-Einbindung in openEditPage === */
// document.getElementById('generateDescBtn').onclick = () => {
//   const q = document.querySelector('#quillContainer .ql-editor');
//   showDescriptionPreview(generateSmartDescription, d, d.fotos || [], (newText) => {
//     q.innerHTML = `<p>${newText}</p>`;
//   });
// };

// === Erweiterung für Beschreibung-Editor mit Undo/Redo + KI-Vorschlag ===
function initEnhancedEditor(containerId, data) {
  const editorContainer = document.getElementById(containerId);
  if (!editorContainer) return;
  
  // KI-Button
  const aiButton = document.createElement('button');
  aiButton.id = 'aiGenBtn';
  aiButton.className = "mt-3 px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition";
  aiButton.innerHTML = '🪄 Automatische KI-Beschreibung erstellen';
  editorContainer.insertAdjacentElement('afterend', aiButton);

  // Quill initialisieren
  const quill = new Quill(`#${containerId}`, { theme: "snow" });
  if (data.beschreibung) quill.root.innerHTML = data.beschreibung;

  // Live speichern
  quill.on("text-change", () => {
    data.beschreibung = quill.root.innerHTML;
  });

  // KI-Beschreibung-Button
  aiButton.addEventListener("click", async () => {
    showToast("🧠 Erzeuge KI-Beschreibung...");
    const kiText = await generateProfessionalDescription(data);
    const confirmAdd = confirm("Neue KI-Beschreibung:\n\n" + kiText + "\n\n➡️ Möchtest du sie einfügen?");
    if (confirmAdd) {
      quill.root.innerHTML = `<p>${kiText.replace(/\n/g, '</p><p>')}</p>`;
      data.beschreibung = quill.root.innerHTML;
    }
  });
}


// === KI-Beschreibungslogik ===
async function generateSmartDescription(data, imageNames = []) {
  const name = data.name || "dieser Ort";
  const typ = data.typ || "Ort";
  const extras = data.extras ? `Hier findest du ${data.extras}.` : "";
  const tiere = Array.isArray(data.tiere) && data.tiere.length && !data.tiere.includes("Keine Tiere")
    ? `Rund um ${name} begegnen dir ${data.tiere.join(", ")}.`
    : "";
  const bilder = imageNames.length ? `Die Fotos zeigen ${imageNames.join(", ")}.` : "";
  const zeit = new Date();
  const stimmung = ["sonnig", "ruhig", "idyllisch", "lebendig", "gemütlich"][Math.floor(Math.random() * 5)];
  const natur = ["grüne Wiesen", "duftende Blumen", "zwitschernde Vögel", "freundliche Tiere", "sanfte Hügel"][Math.floor(Math.random() * 5)];
  const ende = ["Ein Ort zum Verweilen.", "Perfekt für eine kleine Pause.", "Hier spürt man die Nähe zur Natur.", "Ein Geheimtipp für Genießer.", "Ein Stück ländliche Idylle."];
  
  const text = `
    ${name} ist ein ${stimmung}er ${typ} inmitten von ${natur}.
    ${extras} ${tiere} ${bilder}
    Wer hier vorbeikommt, erlebt einen Moment der Entschleunigung und Authentizität.
    ${ende[Math.floor(Math.random() * ende.length)]}
  `;
  await new Promise(res => setTimeout(res, 300 + Math.random() * 300)); // kleine KI-Simulation
  return text.trim().replace(/\s+/g, " ");
}

/* === 🧠 Smarter Tag-Generator === */
async function generateAITags(data) {
    const tags = new Set();
    const textCorpus = [data.name, data.beschreibung, data.extras, data.typ].join(' ').toLowerCase();

    const keywordMap = {
        'regional': ['regional', 'bauernhof', 'direktvermarktung'],
        'bio': ['bio', 'ökologisch'],
        'frühstück': ['frühstück', 'eier', 'brötchen'],
        'familienfreundlich': ['familie', 'kinder', 'spielplatz'],
        'getränke': ['getränke', 'kühlschrank', 'kaffee', 'wasser'],
        'radweg': ['radweg', 'fahrrad', 'radtour'],
        'natur': ['natur', 'wiese', 'wald', 'ruhe'],
        'tiere': ['tiere', 'ziege', 'huhn', 'kuh', 'pferd'],
        'hofladen': ['hofladen', 'laden'],
        'automat': ['automat', '24/7'],
        'selbstbedienung': ['selbstbedienung', 'hütte', 'häuschen']
    };

    Object.keys(keywordMap).forEach(tag => {
        keywordMap[tag].forEach(keyword => {
            if (textCorpus.includes(keyword)) {
                tags.add(tag);
            }
        });
    });

    if (data.tiere && !data.tiere.includes('Keine Tiere')) tags.add('tiere');
    if (data.sitzplaetze === 'Ja') tags.add('sitzmöglichkeit');

    return Array.from(tags);
}
// KI-Tags für den Bearbeitungsmodus
async function suggestTagsForEdit(id) {
    const doc = await db.collection('eierhuetten').doc(id).get();
    if (!doc.exists) return;
    const data = doc.data();
    // Temporäre Daten aus dem Formular hinzufügen für Genauigkeit
    data.beschreibung = document.querySelector('#quillContainer .ql-editor')?.innerHTML || data.beschreibung;
    data.extras = document.querySelector('#editExtras')?.value || data.extras;
    
    const suggestedTags = await generateAITags(data);
    const tagsInput = document.getElementById('editTags');
    if (tagsInput) {
        tagsInput.value = suggestedTags.join(', ');
        showToast('🪄 KI-Tags vorgeschlagen!');
    }
}
// KI-Tags für den Erstellungs-Wizard
async function suggestTagsForWizard() {
    // Daten aus dem `editingData` Objekt sammeln
    const data = { ...editingData };
    data.beschreibung = data.beschreibung || '';
    const suggestedTags = await generateAITags(data);
    const tagsInput = document.getElementById('tagsInput');
    if (tagsInput) {
        tagsInput.value = suggestedTags.join(', ');
        showToast('🪄 KI-Tags vorgeschlagen!');
    }
}
/* === 💫 KI-Vorschau mit Stil-Auswahl, Neu-Generieren & Übernehmen === */
function attachAIDescriptionButton(quill, data, photos) {
  const container = document.querySelector("#quillContainer");
  if (!container || document.getElementById("aiDescBtn")) return;

  const btn = document.createElement("button");
  btn.id = "aiDescBtn";
  btn.textContent = "✨ KI-Beschreibung vorschlagen";
  btn.className = "mt-4 bg-gradient-to-r from-green-600 to-lime-600 text-white px-4 py-2 rounded-lg hover:from-green-700 transition shadow-md";
  container.insertAdjacentElement("afterend", btn);

  const previewBox = document.createElement("div");
  previewBox.id = "aiPreviewBox";
  previewBox.className = "hidden bg-white border rounded-lg p-5 mt-4 shadow-lg space-y-3";
  container.parentElement.appendChild(previewBox);

  btn.addEventListener("click", () => {
    renderAIPreview(previewBox, quill, data, photos);
  });
}

function renderAIPreview(previewBox, quill, data, photos) {
  const styleOptions = `
    <select id="aiStyleSelect" class="border rounded p-1 text-sm">
      <option value="romantisch">🌸 Romantisch</option>
      <option value="sachlich">📘 Sachlich</option>
      <option value="kurz">⚡ Kurz & Prägnant</option>
    </select>
  `;

  const html = generateSmartDescription(data, photos, "romantisch");
  previewBox.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-semibold text-lg text-green-700">Vorschlag für Beschreibung</h3>
      ${styleOptions}
    </div>
    <div class="prose max-w-none mb-3 text-gray-700">${html}</div>
    <div class="flex gap-3">
      <button id="applyAIDesc" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700">✅ Übernehmen</button>
      <button id="regenAIDesc" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">🔁 Neu generieren</button>
      <button id="closeAIPrev" class="px-3 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">❌ Schließen</button>
    </div>
  `;
  previewBox.classList.remove("hidden");

  const textContainer = previewBox.querySelector(".prose");
  const select = previewBox.querySelector("#aiStyleSelect");

  previewBox.querySelector("#regenAIDesc").onclick = () => {
    const style = select.value;
    textContainer.innerHTML = generateSmartDescription(data, photos, style);
  };

  previewBox.querySelector("#applyAIDesc").onclick = () => {
    quill.root.innerHTML = textContainer.innerHTML;
    showToast("✅ Beschreibung übernommen");
  };

  previewBox.querySelector("#closeAIPrev").onclick = () => {
    previewBox.classList.add("hidden");
  };
}
/* === Kostenloser, smarter Image-Uploader mit automatischer Titel-Generierung ===
   - Speichert images als { url, title } in Firestore
   - Erzeugt Titel aus Dateiname + einfacher Bildanalyse (Farben/Helligkeit/Aspect)
   - Titel sind editierbar nach Upload
   - Keine externe KI erforderlich
*/
    /* === Professionelle Beschreibung, die Bildtitel nutzt === */
async function generateProfessionalDescription(d) {
  const name = (d.name || 'dieser Ort').trim();
  const extras = d.extras ? `Hier gibt es ${d.extras}.` : '';
  const tiere = Array.isArray(d.tiere) && d.tiere.length && !d.tiere.includes('Keine Tiere')
    ? `Rund um ${name} kannst du ${d.tiere.join(', ')} entdecken.` : '';

  // fotos kann array von {url, title} oder strings sein
  const photoTitles = (d.fotos || []).map(f => typeof f === 'string' ? (decodeURIComponent(f.split('/').pop().split('.')[0]) || '') : (f.title || f.name || decodeURIComponent((f.url||'').split('/').pop().split('.')[0]) || '')).filter(Boolean);

  let fotosTxt = '';
  if (photoTitles.length === 1) fotosTxt = `Auf einem Foto sieht man ${photoTitles[0]}.`;
  else if (photoTitles.length === 2) fotosTxt = `Die Fotos zeigen ${photoTitles[0]} und ${photoTitles[1]}.`;
  else if (photoTitles.length > 2) {
    const last = photoTitles[photoTitles.length-1];
    const rest = photoTitles.slice(0,-1).join(', ');
    fotosTxt = `Die Bilder fangen die Stimmung ein – ${rest} und ${last}.`;
  }

  const tone = ['idyllisch', 'einladend', 'malerisch', 'authentisch'][Math.floor(Math.random()*4)];
  const landscape = ['weiten Wiesen', 'alten Obstbäumen', 'sanften Hügeln', 'duftenden Feldern'][Math.floor(Math.random()*4)];
  const ending = ['Ein Ort zum Verweilen.', 'Hier spürt man die Liebe zur Natur.', 'Ein Platz, der Ruhe und Genuss vereint.'];

  // build multi-paragraph, professional text
  const paragraphs = [];
  paragraphs.push(`${name} ist ein ${tone}er Ort, eingebettet zwischen ${landscape}.`);
  if (extras) paragraphs.push(extras);
  if (tiere) paragraphs.push(tiere);
  if (fotosTxt) paragraphs.push(fotosTxt);
  paragraphs.push(ending[Math.floor(Math.random()*ending.length)]);

  // join with double newline for clarity (Quill will handle HTML)
  return paragraphs.join('\n');
                                          
}
    
/* === 📸 Smarter Image-Uploader mit KI-Button pro Bild === */
async function renderSmartImageUploader(container, docRef, existingImages = [], entryId) {
  container.innerHTML = `
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="text-sm font-semibold mb-3">📸 Fotos verwalten</h3>
      <div id="smartUploadZone" class="relative border-2 border-dashed border-green-300 bg-green-50 hover:bg-green-100 transition rounded-xl p-6 text-center cursor-pointer">
        <p class="text-gray-600 text-sm">Ziehe Bilder hierher oder klicke zum Hochladen</p>
        <input id="smartUploadInput" type="file" accept="image/*" multiple class="hidden">
        <div id="smartUploadPreview" class="flex flex-wrap gap-3 justify-center mt-3"></div>
        <div id="smartUploadProgress" class="hidden absolute bottom-2 left-2 right-2 h-1 bg-gray-200 rounded">
          <div id="smartUploadBar" class="h-1 bg-green-500 rounded transition-all" style="width:0%"></div>
        </div>
      </div>
    </div>
  `;

  const zone = container.querySelector("#smartUploadZone");
  const input = container.querySelector("#smartUploadInput");
  const preview = container.querySelector("#smartUploadPreview");
  const bar = container.querySelector("#smartUploadBar");
  const barContainer = container.querySelector("#smartUploadProgress");

  existingImages = (existingImages || []).map((img) =>
    typeof img === "string" ? { url: img, title: "" } : img
  );

  function renderExisting() {
    preview.innerHTML = "";
    if (!existingImages.length) {
      preview.innerHTML = `<div class="text-gray-400 text-sm">Noch keine Bilder hochgeladen.</div>`;
      return;
    }
    existingImages.forEach((img, idx) => {
      const card = document.createElement("div");
      card.className =
        "relative group w-32 h-40 border rounded overflow-hidden bg-gray-50 p-2 flex flex-col items-center shadow-sm";
      card.innerHTML = `
        <img src="${img.url}" class="object-cover w-full h-24 rounded mb-2">
        <input data-idx="${idx}" class="imageTitleInput w-full text-xs border rounded p-1 text-center" value="${img.title || ""}" placeholder="Titel...">
        <div class="flex justify-between gap-1 mt-1">
          <button class="kiBtn text-xs bg-blue-600 text-white rounded px-2 py-0.5 hover:bg-blue-700">🪄 KI</button>
          <button class="removeBtn text-xs bg-red-600 text-white rounded px-2 py-0.5 hover:bg-red-700">✕</button>
        </div>
      `;

      // Stop Click auf KI-Button → kein Upload-Trigger
      card.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", (e) => e.stopPropagation());
      });

      // Titeländerung
      card.querySelector(".imageTitleInput").addEventListener("input", (e) => {
        existingImages[idx].title = e.target.value.trim();
        docRef.update({ fotos: existingImages });
      });

      // KI-Button → neuen Titel generieren
      card.querySelector(".kiBtn").onclick = async () => {
        const suggestion = await generateSmartImageTitle(img.url);
        existingImages[idx].title = suggestion;
        card.querySelector(".imageTitleInput").value = suggestion;
        await docRef.update({ fotos: existingImages });
        showToast("🧠 KI-Titel aktualisiert");
      };

      // Entfernen
      card.querySelector(".removeBtn").onclick = async () => {
        if (!confirm("Bild wirklich entfernen?")) return;
        existingImages.splice(idx, 1);
        await docRef.update({ fotos: existingImages });
        renderExisting();
      };

      preview.appendChild(card);
    });
  }

  // Upload
  zone.addEventListener("click", (e) => {
    if (e.target.tagName === "BUTTON" || e.target.closest("button")) return;
    input.click();
  });
  zone.addEventListener("dragover", (e) => {
    e.preventDefault();
    zone.classList.add("bg-green-100");
  });
  zone.addEventListener("dragleave", () => zone.classList.remove("bg-green-100"));
  zone.addEventListener("drop", (e) => {
    e.preventDefault();
    zone.classList.remove("bg-green-100");
    handleFiles(e.dataTransfer.files);
  });
  input.addEventListener("change", (e) => handleFiles(e.target.files));

  renderExisting();

  async function handleFiles(files) {
    const list = Array.from(files);
    if (!list.length) return;

    barContainer.classList.remove("hidden");

    for (let i = 0; i < list.length; i++) {
        const file = list[i];
        bar.style.width = `${((i + 1) / list.length) * 100}%`;
        const formData = new FormData();
        formData.append("image", file);
        
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                method: "POST",
                body: formData,
            });
            const data = await res.json();
            if(!data.success) throw new Error(data.error.message);
            
            const url = data.data.url;
            const title = await generateSmartImageTitle(url, file.name);

            existingImages.push({ url, title });
            await docRef.update({ fotos: firebase.firestore.FieldValue.arrayUnion({url, title}) });
            showToast(`✅ ${title} hinzugefügt`);
        } catch(e) {
            showToast(`❌ Fehler bei Upload: ${e.message}`, 5000);
        }
    }

    barContainer.classList.add("hidden");
    bar.style.width = '0%';
    renderExisting();
  }
}

/* === 🧠 Kostenlose KI-Titelerkennung (heuristisch) === */
async function generateSmartImageTitle(url, filename = "") {
  const cleanName = filename.replace(/\.[^/.]+$/, "").toLowerCase();
  if (cleanName.includes("automat")) return "Verkaufsautomat mit frischen Produkten";
  if (cleanName.includes("huhn")) return "Hühner am Hof";
  if (cleanName.includes("kuh")) return "Kuh auf der Weide";
  if (cleanName.includes("hütte") || cleanName.includes("huette"))
    return "Selbstbedienungshütte im Grünen";
  if (cleanName.includes("hof")) return "Idyllischer Bauernhof";
  if (cleanName.includes("landschaft")) return "Landschaftspanorama";
  if (cleanName.includes("markt")) return "Kleiner Hofladen";
  // einfache Farb-/Licht-Analyse für Stimmung
  return "Ein stimmungsvolles Bild vom Ort";
}

    function normalizeOpeningHours(oeff) {
      if (!oeff) return {}; // Default zu geschlossen

      // Fall 1: String "Immer geöffnet"
      if (typeof oeff === "string" && oeff.toLowerCase().includes("immer")) {
          const result = {};
          DAY_LABELS.forEach(day => {
              result[day.key] = { open: true, from: "00:00", to: "23:59" };
          });
          return result;
      }

      // Fall 2: Array [{tag, von, bis}, …]
      if (Array.isArray(oeff)) {
          const result = {};
          const dayMap = new Map(oeff.map(item => [item.tag.toLowerCase(), item]));
          
          DAY_LABELS.forEach(day => {
              const key = day.key.toLowerCase().substring(0,2);
              const entry = oeff.find(o => o.tag.toLowerCase().startsWith(key));
              if (entry && entry.von && entry.bis) {
                  result[day.key] = { open: true, from: entry.von, to: entry.bis };
              } else {
                  result[day.key] = { open: false, from: "", to: "" };
              }
          });
          return result;
      }
      // Fall 3: Bereits im neuen Format
      if (typeof oeff === 'object' && oeff.mo) {
          return oeff;
      }

      return {}; // Fallback
    }
  /***********************
   * ACCOUNT SETTINGS & DELETION
   ***********************/

async function showAccountSettings() {
    if (!currentUser) return;
    mode = 'settings';
    document.getElementById("navBottom").style.display = 'none';

    const qa = document.getElementById("question-area");
    const betreiberDoc = await db.collection("betreiber").doc(currentUser.uid).get();
    const betreiberData = betreiberDoc.data() || {};
    const isPremium = betreiberData.premium === true;
    const status = isPremium ? "Premium" : "Kostenlos";

    let aboSection = '';
    if (isPremium) {
        aboSection = `
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Abonnement verwalten</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Dein Premium-Status ist aktiv bis zum <b>${betreiberData.premium_until ? new Date(betreiberData.premium_until).toLocaleDateString("de-DE") : "unbekannt"}</b>.
                </p>
                <button onclick="cancelPremium()" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition">
                    Unterstützer-Status kündigen
                </button>
            </div>
        `;
    } else {
        aboSection = `
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Abonnement</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Werde Unterstützer, um mehr Fotos, erweiterte Statistiken und Events freizuschalten.
                </p>
                <button onclick="showPremiumUpgrade()" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">
                    🌟 Jetzt Unterstützer werden
                </button>
            </div>
        `;
    }

    qa.innerHTML = `
    <div class="max-w-2xl mx-auto space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Account-Information</h2>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-500">Name:</span>
                    <span class="font-semibold text-gray-700">${escapeHtml(currentUser.displayName || '-')}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">E-Mail:</span>
                    <span class="font-semibold text-gray-700">${escapeHtml(currentUser.email)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500">Status:</span>
                    <span class="px-2 py-1 ${isPremium ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'} rounded-full font-semibold">${status}</span>
                </div>
            </div>
        </div>
        
        ${aboSection}

        <div class="bg-white p-6 rounded-xl shadow-md border-2 border-red-200">
            <h2 class="text-xl font-bold text-red-700 mb-2">Gefahrenzone</h2>
            <p class="text-sm text-gray-600 mb-4">
                Wenn du deinen Account löschst, werden alle deine Daten unwiderruflich gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.
            </p>
            <ul class="list-disc list-inside text-sm text-gray-600 mb-5 space-y-1">
                <li>Alle deine Einträge und Bilder</li>
                <li>Alle Events</li>
                <li>Dein Profil und Statistiken</li>
                <li>Premium-Status (falls vorhanden)</li>
            </ul>
            <button onclick="deleteUserAccount()" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                Account endgültig löschen
            </button>
        </div>
    </div>
    `;
}

async function deleteUserAccount() {
    if (!currentUser) return;

    const confirmation = prompt(`Bist du absolut sicher? Dies löscht deinen Account und alle deine Einträge permanent. Tippe "löschen", um fortzufahren.`);
    if (confirmation !== 'löschen') {
        showToast("Löschvorgang abgebrochen.", 3000);
        return;
    }

    try {
        showToast("Lösche Daten...", 10000);
        const uid = currentUser.uid;

        // 1. Alle Einträge des Nutzers löschen
        const entriesQuery = await db.collection('eierhuetten').where('userId', '==', uid).get();
        const deletePromises = [];
        entriesQuery.forEach(doc => {
            deletePromises.push(doc.ref.delete());
        });
        await Promise.all(deletePromises);

        // 2. Betreiber-Dokument löschen
        await db.collection('betreiber').doc(uid).delete();

        // 3. Firebase Auth User löschen
        await firebase.auth().currentUser.delete();

        alert("Dein Account wurde erfolgreich und endgültig gelöscht.");
        // Die onAuthStateChanged Logik wird den Logout-Prozess abschließen.

    } catch (error) {
        console.error("Fehler beim Löschen des Accounts: ", error);
        alert(`Ein Fehler ist aufgetreten: ${error.message}. Bitte logge dich erneut ein und versuche es wieder.`);
        if (error.code === 'auth/requires-recent-login') {
            logout(); // Zwingt zum erneuten Login
        }
    }
}
  /***********************
   * Support form
   ***********************/

    // ------- Support: Formular + Laden der Tickets -------
function openSupport() {
  if (!currentUser || !currentUser.uid) {
    showToast("Bitte zuerst einloggen");
    return;
  }

  mode = "support";
  document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";

  const qa = document.getElementById('question-area');
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">📨 Support</h2>

      <label class="block mb-2">
        <div class="text-sm text-gray-600">Name</div>
        <input id="supName" class="w-full border p-2 rounded" placeholder="Dein Name" value="${escapeAttr(currentUser.displayName || '')}" />
      </label>

      <label class="block mb-2">
        <div class="text-sm text-gray-600">E-Mail</div>
        <input id="supMail" class="w-full border p-2 rounded" placeholder="E-Mail" value="${escapeAttr(currentUser.email || '')}" />
      </label>

      <label class="block mb-4">
        <div class="text-sm text-gray-600">Nachricht</div>
        <textarea id="supMsg" class="w-full border p-2 rounded" rows="4" placeholder="Nachricht..."></textarea>
      </label>

      <div class="flex gap-2 mb-4">
        <button class="px-4 py-2 bg-green-600 text-white rounded" onclick="sendSupport()">Absenden</button>
      </div>

      <hr class="my-4" />

      <h3 class="text-lg font-bold mb-2">📂 Deine bisherigen Support-Tickets</h3>
      <div id="supportList" class="space-y-2 text-sm text-gray-700">⏳ Lade Support-Tickets…</div>
    </div>
  `;

  updateInfoBox();
  loadSupportTickets(); // befüllt #supportList
}



  
/**
 * Optional: showSupportTickets() belassen oder neu anpassen, damit
 * sie die Liste (ohne Formular) zeigt. Beispiel:
 */
async function showSupportTickets() {
  if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
  mode = "list";
  document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none";
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">📂 Meine Support-Tickets</h2>
      <div id="supportList" class="space-y-2 text-sm text-gray-700">⏳ Lade Support-Tickets…</div>
    </div>
  `;
  updateInfoBox();
  loadSupportTickets();
}
/* -------------------------
   Robuste Support-Implementierung
   - zeigt support id an
   - individuelle message-listener pro ticket (mit unsubscribe map)
   - fallback: erste Nachricht aus ticket doc (wenn messages empty)
   - Zeichenbegrenzung + Counter pro Eingabefeld
   - sichere DOM-Erstellung (keine großen innerHTML-Klumpen)
   ------------------------- */

const SUPPORT_MSG_MAX = 250;
// Map ticketId -> unsubscribe function for messages onSnapshot
const _supportUnsubs = new Map();

async function loadSupportTickets() {
  const list = document.getElementById("supportList");
  if (!list) return;
  if (!currentUser || !currentUser.email) {
    list.innerHTML = "<div class='text-gray-500'>Bitte anmelden, um deine Tickets zu sehen.</div>";
    return;
  }

  // unsubscribe all previous listeners to avoid duplicates
  _supportUnsubs.forEach(u => { try { u(); } catch(e){} });
  _supportUnsubs.clear();

  list.innerHTML = "⏳ Lade Support-Tickets…";

  try {
    let query = db.collection("support").where("mail", "==", currentUser.email);
    let snap;
    try {
      snap = await query.orderBy("createdAt", "desc").get();
    } catch (errOrder) {
      console.warn("OrderBy failed (maybe index required) - fallback without orderBy:", errOrder);
      snap = await query.get();
    }

    if (!snap || snap.empty) {
      list.innerHTML = "<div class='text-gray-500'>Keine Support-Anfragen gefunden.</div>";
      return;
    }

    // build DOM with document fragment for performance
    const frag = document.createDocumentFragment();
    snap.forEach(doc => {
      const d = doc.data();
      const id = doc.id;

      // outer card
      const card = document.createElement("div");
      card.className = "bg-gray-100 p-3 rounded mb-3";

      // header row: title + support id
      const hdr = document.createElement("div");
      hdr.className = "flex justify-between items-start gap-2";
      const title = document.createElement("div");
      title.className = "font-semibold";
      title.textContent = "📨 Support Ticket";
      const idEl = document.createElement("div");
      idEl.className = "text-xs text-gray-500";
      idEl.innerHTML = `<span class="font-mono">ID: ${escapeHtml(id)}</span>`; // safe: id is escaped
      hdr.appendChild(title);
      hdr.appendChild(idEl);
      card.appendChild(hdr);

      // meta: created + status
      const created = document.createElement("div");
      created.className = "text-xs text-gray-500 mt-1";
      let createdStr = "-";
      try {
        if (d.createdAt && typeof d.createdAt.toDate === "function") createdStr = d.createdAt.toDate().toLocaleString();
        else if (d.createdAt) createdStr = new Date(d.createdAt).toLocaleString();
      } catch(e){}
      created.innerHTML = `Gesendet: ${escapeHtml(createdStr)}<br>Status: ${escapeHtml(d.status || "offen")}`;
      card.appendChild(created);

      // messages container
      const msgsWrap = document.createElement("div");
      msgsWrap.id = `msgs-${id}`;
      msgsWrap.className = "space-y-2 my-2 text-sm";
      msgsWrap.textContent = "⏳ Lade Nachrichten…";
      card.appendChild(msgsWrap);

      // controls container
      const controls = document.createElement("div");
      controls.className = "mt-2";

      if (d.status !== "geschlossen") {
        // input
        const input = document.createElement("input");
        input.type = "text";
        input.id = `msgInput-${id}`;
        input.maxLength = SUPPORT_MSG_MAX;
        input.placeholder = `Antwort schreiben (max ${SUPPORT_MSG_MAX} Zeichen)...`;
        input.className = "w-full border p-2 rounded text-sm mb-1";

        // counter
        const counter = document.createElement("div");
        counter.id = `msgCounter-${id}`;
        counter.className = "text-xs text-gray-500 mb-2";
        counter.textContent = `${SUPPORT_MSG_MAX} Zeichen übrig`;

        // buttons row
        const btnRow = document.createElement("div");
        btnRow.className = "flex gap-2";

        const sendBtn = document.createElement("button");
        sendBtn.className = "px-3 py-2 bg-green-600 text-white rounded text-sm flex-1";
        sendBtn.textContent = "Senden";

        const closeBtn = document.createElement("button");
        closeBtn.className = "px-3 py-2 bg-gray-600 text-white rounded text-sm";
        closeBtn.textContent = "✅ Ticket schließen";

        btnRow.appendChild(sendBtn);
        btnRow.appendChild(closeBtn);

        controls.appendChild(input);
        controls.appendChild(counter);
        controls.appendChild(btnRow);

        // attach event listeners (closure captures id)
        input.addEventListener("input", () => {
          const left = SUPPORT_MSG_MAX - input.value.length;
          counter.textContent = `${left} Zeichen übrig`;
        });
        sendBtn.addEventListener("click", () => replySupport(id));
        closeBtn.addEventListener("click", () => closeSupportTicket(id));

      } else {
        // closed ticket -> show notice and allow delete only
        const closedNotice = document.createElement("div");
        closedNotice.className = "text-sm text-red-600";
        closedNotice.textContent = "Ticket ist geschlossen";
        controls.appendChild(closedNotice);
      }

      // small action row: show path + delete button
      const actionRow = document.createElement("div");
      actionRow.className = "mt-2 flex items-center justify-between gap-2";
      const pathInfo = document.createElement("div");
      pathInfo.className = "text-xs text-gray-400";
      pathInfo.innerHTML = `Gespeichert in: <code>support/${escapeHtml(id)}</code>`;
      const delBtn = document.createElement("button");
      delBtn.className = "px-2 py-1 text-xs bg-red-600 text-white rounded";
      delBtn.textContent = "🗑️ Löschen";
      delBtn.addEventListener("click", () => deleteSupport(id));
      actionRow.appendChild(pathInfo);
      actionRow.appendChild(delBtn);

      card.appendChild(controls);
      card.appendChild(actionRow);

      frag.appendChild(card);

      // start messages listener for this ticket (store unsubscribe)
      const ticketDocMsg = d.msg ?? null; // first msg stored in doc field (legacy)
      const ticketDocMail = d.mail ?? null;
      const ticketDocCreatedAt = d.createdAt ?? null;

      // create onSnapshot listener and store unsubscribe
      const unsub = db.collection("support").doc(id).collection("messages")
        .orderBy("createdAt", "asc")
        .onSnapshot((msnap) => {
          // render messages for this ticket
          const wrap = document.getElementById(`msgs-${id}`);
          if (!wrap) return;
          // build html
          let html = "";
          if (!msnap.empty) {
            msnap.forEach(mdoc => {
              const md = mdoc.data();
              let time = "-";
              try { if (md.createdAt && md.createdAt.toDate) time = md.createdAt.toDate().toLocaleString(); } catch(e){}
              html += `
                <div class="bg-white border rounded p-2">
                  <div class="text-sm">${escapeHtml(md.text)}</div>
                  <div class="text-xs text-gray-500">${escapeHtml(md.sender || "-")} · ${escapeHtml(time)}</div>
                </div>`;
            });
          } else if (ticketDocMsg) {
            // fallback: show doc.msg if no subcollection messages
            let t = "-";
            try { if (ticketDocCreatedAt && ticketDocCreatedAt.toDate) t = ticketDocCreatedAt.toDate().toLocaleString(); } catch(e){}
            html += `
              <div class="bg-white border rounded p-2">
                <div class="text-sm">${escapeHtml(ticketDocMsg)}</div>
                <div class="text-xs text-gray-500">${escapeHtml(ticketDocMail || "-")} · ${escapeHtml(t)}</div>
              </div>`;
          } else {
            html = "<div class='text-gray-500'>Keine Nachrichten</div>";
          }
          wrap.innerHTML = html;
        }, err => {
          console.error("messages onSnapshot error for", id, err);
          const wrap = document.getElementById(`msgs-${id}`);
          if (wrap) wrap.innerHTML = `<div class="text-red-600">Fehler beim Laden der Nachrichten: ${escapeHtml(err.message || String(err))}</div>`;
        });

      // store unsubscribe
      _supportUnsubs.set(id, unsub);
    });

    // replace list content
    list.innerHTML = "";
    list.appendChild(frag);

  } catch (err) {
    console.error("loadSupportTickets error:", err);
    list.innerHTML = `<div class="text-red-600">❌ Fehler beim Laden: ${escapeHtml(err.message || String(err))}</div>`;
  }
}

// Antwort schreiben (replies gehen in support/{id}/messages)
async function replySupport(ticketId) {
  // read input for this ticket
  const inp = document.getElementById(`msgInput-${ticketId}`);
  if (!inp) return;
  const text = inp.value.trim();
  if (!text) return;

  // check ticket status before sending (optional read)
  try {
    const doc = await db.collection("support").doc(ticketId).get();
    const data = doc.exists ? doc.data() : null;
    if (data && data.status === "geschlossen") {
      alert("Dieses Ticket ist geschlossen. Keine Antworten möglich.");
      return;
    }
  } catch (err) {
    console.warn("Could not read ticket status:", err);
  }

  try {
    await db.collection("support").doc(ticketId).collection("messages").add({
      text,
      sender: currentUser.email || currentUser.uid || "web",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    inp.value = "";
    const counter = document.getElementById(`msgCounter-${ticketId}`);
    if (counter) counter.textContent = `${SUPPORT_MSG_MAX} Zeichen übrig`;
  } catch (err) {
    console.error("replySupport error:", err);
    alert("Fehler beim Senden: " + (err.message || String(err)));
  }
}

// Ticket erstellen + erste Nachricht in subcollection schreiben
async function sendSupport() {
  const name = document.getElementById('supName')?.value.trim() || '';
  const mail = document.getElementById('supMail')?.value.trim() || (currentUser?.email || '');
  const msg = document.getElementById('supMsg')?.value.trim() || '';
  if (!msg || !mail) { alert('Bitte Nachricht und E-Mail ausfüllen'); return; }

  try {
    // create ticket doc first (without msg field or keep legacy)
    const ticketRef = await db.collection('support').add({
      name,
      mail,
      status: 'offen',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // add first message in subcollection
    await ticketRef.collection('messages').add({
      text: msg,
      sender: mail,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast('✅ Ticket erstellt');
    // clear form
    if (document.getElementById('supMsg')) document.getElementById('supMsg').value = '';
    // reload tickets
    await loadSupportTickets();
  } catch (err) {
    console.error("sendSupport error:", err);
    alert("Fehler: " + (err.message || String(err)));
  }
}

// Ticket schließen
async function closeSupportTicket(ticketId) {
  if (!confirm("Ticket wirklich schließen?")) return;
  try {
    await db.collection('support').doc(ticketId).update({ status: "geschlossen" });
    showToast("Ticket geschlossen");
    // reload tickets (will unsubscribe and re-subscribe)
    await loadSupportTickets();
  } catch (err) {
    console.error("closeSupportTicket error:", err);
    alert("Fehler beim Schließen: " + (err.message || String(err)));
  }
}

// Ticket löschen
async function deleteSupport(ticketId) {
  if (!confirm("Ticket wirklich löschen?")) return;
  try {
    // unsubscribe listener if present
    const unsub = _supportUnsubs.get(ticketId);
    if (unsub) { try { unsub(); } catch(e){}; _supportUnsubs.delete(ticketId); }

    await db.collection('support').doc(ticketId).delete();
    showToast("Support-Ticket gelöscht");
    // reload list
    await loadSupportTickets();
  } catch (err) {
    console.error("deleteSupport error:", err);
    alert("Fehler beim Löschen: " + (err.message || String(err)));
  }
}
  /***********************
   * Utility, escape helpers
   ***********************/
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));
  }
  function escapeAttr(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }
function stripHtml(html) {
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}
  /***********************
   * Sidebar toggle + init
   ***********************/
  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }

  /**
   * Setzt Google Profil oder generiertes Avatar mit Initialen und Farbverlauf.
   * @param {Object} user - { email: string, photoURL: string|null, displayName: string|null }
   */
  function setGoogleProfile(user) {
    const email = user.email || '-';
    const picture = user.photoURL;
    const name = user.displayName;

    const profilePic = document.getElementById('profilePic');
    const avatarWrapper = document.getElementById('avatarWrapper');
    const avatarInitials = document.getElementById('avatarInitials');

    if(picture) {
      profilePic.src = picture;
      profilePic.classList.remove('hidden');
      avatarInitials.textContent = '';
      avatarWrapper.style.background = '';
    } else {
      profilePic.classList.add('hidden');
      const initial = (name || email).charAt(0).toUpperCase() || 'U';
      avatarInitials.textContent = initial;

      const hash = Array.from(email).reduce((acc, char) => acc + char.charCodeAt(0), 0);
      const colors = [
        ['#34D399','#10B981'], ['#60A5FA','#3B82F6'], ['#FBBF24','#F59E0B'],
        ['#F87171','#EF4444'], ['#A78BFA','#8B5CF6'], ['#F472B6','#EC4899']
      ];
      const chosen = colors[hash % colors.length];
      avatarWrapper.style.background = `linear-gradient(135deg, ${chosen[0]}, ${chosen[1]})`;
    }
    document.getElementById('accountMail').textContent = name || email;
  }

window.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("toggleInfo");
  const overlay = document.getElementById("infoOverlay");
  const close = document.getElementById("closeInfo");

  if (btn && overlay && close) {
    btn.addEventListener("click", () => overlay.classList.remove("hidden"));
    close.addEventListener("click", () => overlay.classList.add("hidden"));
  }
  setupAuthForms();
});
    

async function deleteSupport(id) {
  if (!confirm("Ticket wirklich löschen?")) return;
  await db.collection("support").doc(id).delete();
  showToast("Support-Ticket gelöscht");
  showSupportTickets();
}
  
  // Expose helpful functions to window for inline handlers
  window.selectOption = selectOption;
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  window.startNewEntry = startNewEntry;
  window.showMyEntries = showMyEntries;
  window.openSupport = openSupport;
  window.toggleSidebar = toggleSidebar;
  window.submitEntry = submitEntry;
  window.deleteUserAccount = deleteUserAccount;
  window.suggestTagsForEdit = suggestTagsForEdit;
  window.suggestTagsForWizard = suggestTagsForWizard;
  window.navigateTo = navigateTo;
  window.showPasswordReset = showPasswordReset;
  window.doGoogleLogin = doGoogleLogin;
  window.cancelPremium = cancelPremium;
  window.showPremiumUpgrade = showPremiumUpgrade;

  </script>
</body>
</html>
