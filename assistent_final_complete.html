<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap { height: 200px; z-index: 0; }
    .leaflet-container { z-index: 0 !important; }
    
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; }
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    
    .sidebar-btn.active {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }
    
    #smartUploadZone { transition: all 0.25s ease; }
    #smartUploadZone:hover { background-color: #ecfdf5; border-color: #10b981; transform: scale(1.01); }
    #smartUploadPreview img { transition: all 0.25s ease; }
    #smartUploadPreview img:hover { transform: scale(1.05); filter: brightness(1.1); }
    
    @keyframes pulseUpload {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    .uploading::after {
      content: "â«";
      position: absolute;
      top: 4px; right: 4px;
      font-size: 0.8rem;
      animation: pulseUpload 1s infinite;
      color: #16a34a;
    }
  </style>
</head>
<body class="bg-gray-100">

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" class="w-64 h-64 drop-shadow-lg" alt="Illustration" />
    </div>
    <h1 class="text-3xl font-extrabold text-green-700 mb-3">Assistent-Dashboard</h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>
    <button onclick="doGoogleLogin()" class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 bg-white rounded-full p-1" alt="Google Logo"/>
      <span>Mit Google anmelden</span>
    </button>
    <p class="text-xs text-gray-400 mt-6">ğŸ”’ Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.</p>
  </div>
</div>

<div id="mainApp" class="flex min-h-screen hidden">

  <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">
    <div class="flex flex-col items-center mb-8">
      <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
        <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
        <span id="avatarInitials"></span>
      </div>
      <p class="text-sm text-gray-600">Angemeldet als:</p>
      <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
      <button onclick="logout()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform">Logout</button>
    </div>

    <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">ğŸŒ¿ Assistent</div>

    <nav class="flex flex-col gap-2 text-[15px]">
      <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">ğŸš² Startseite</a>
      <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">ğŸš´â€â™‚ï¸ zur RadlMap</a>
      <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">ğŸ“Š Betreiber-Dashboard</button>
      <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">ğŸ“‹ Meine Eintragungen</button>
      <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">â• Neue Eintragung</button>

      <div class="mt-4">
        <div class="flex items-center justify-between px-3 mb-1">
          <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
          <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
        </div>
        <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
          <button id="btnMyEvents" class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition" onclick="setActive('btnMyEvents'); showMyEvents(firebase.auth().currentUser)">ğŸ“… <span>Meine Events</span></button>
          <button id="btnCreateEvent" class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition" onclick="setActive('btnCreateEvent'); showCreateEvent(firebase.auth().currentUser)">â• <span>Neues Event</span></button>
        </div>
      </div>

      <hr class="my-3 border-gray-200">
      <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSupport'); openSupport()">ğŸ’¬ Support</button>
      <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
        ğŸ’Œ HÃ¼tten-Nachrichten
        <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
      </button>
    </nav>

    <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">v2.1 &middot; RadlMap Assistent</div>
  </aside>

  <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
    <div class="sticky top-4">
      <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
      <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
    </div>
  </div>

  <div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
      <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">âœ•</button>
      <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
      <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
    </div>
  </div>
  <button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg">â„¹ï¸</button>

  <main class="flex-1 flex flex-col">
    <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
      <div class="font-bold text-green-700">Assistent</div>
      <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">â˜°</button>
    </div>

    <div class="w-full h-2 bg-gray-200">
      <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
    </div>

    <section id="question-area" class="flex-1 p-6 overflow-y-auto"></section>

    <nav id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
      <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">â¬…ï¸ ZurÃ¼ck</button>
      <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter â¡ï¸</button>
    </nav>
  </main>
</div>

<div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

<div id="editConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow p-6 max-w-lg w-full">
    <h3 class="text-lg font-bold mb-3">Ã„nderungen bestÃ¤tigen</h3>
    <div id="editChangesList" class="text-sm bg-gray-50 border p-3 rounded mb-4 max-h-60 overflow-y-auto"></div>
    <div class="flex justify-end gap-2">
      <button onclick="cancelEdit()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">âŒ Abbrechen</button>
      <button onclick="confirmEdit()" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">âœ… Speichern</button>
    </div>
  </div>
</div>

<script>
// =================================================================================
// SCRIPT START
// =================================================================================
(function() {
  /***********************
   * Config & Init
   ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";
  const STRIPE_PUBLISHABLE_KEY = "pk_test_51SFLgEBghOTdsn6RBYuZr6x4R2BC6lhq4NFWmcKTtyNahatWHMVHAq3posYIhsXKRl598qHOzMzyymuV6DgKWYly006AaME4Wr";

  let app, db, auth, storage, stripe;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    storage = firebase.storage();
    stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">âŒ Firebase konnte nicht initialisiert werden.</div>`;
  }

  /***********************
   * State Management
   ***********************/
  let currentUser = null;
  let editingData = {};
  let step = 0;
  const stepsCount = 11;
  let mode = "entry"; // "entry", "list", "dashboard", etc.
  let pendingEdit = null;
  
  /***********************
   * Authentication
   ***********************/
  auth.onAuthStateChanged(user => {
    const loginScreen = document.getElementById("loginScreen");
    const mainApp = document.getElementById("mainApp");
    
    if (user) {
      currentUser = user;
      mainApp.classList.remove("hidden");
      loginScreen.classList.add("hidden");
      document.getElementById('sidebar').classList.add('-translate-x-full');
      updateUserProfile(user);
      showTutorial();
      initHutMessagesBadge();
    } else {
      currentUser = null;
      mainApp.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    }
  });

  async function doGoogleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
      showToast("âœ… Erfolgreich eingeloggt!");
    } catch (e) {
      console.error("Google Login error", e);
      showToast("Fehler beim Google-Login: " + e.message, 5000, true);
    }
  }

  function logout() {
    auth.signOut();
  }
  
  function updateUserProfile(user) {
      document.getElementById("accountMail").textContent = user.email;
      const profilePic = document.getElementById('profilePic');
      const avatarWrapper = document.getElementById('avatarWrapper');
      const avatarInitials = document.getElementById('avatarInitials');

      if (user.photoURL) {
          profilePic.src = user.photoURL;
          profilePic.classList.remove('hidden');
          avatarInitials.textContent = '';
      } else {
          profilePic.classList.add('hidden');
          const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
          avatarInitials.textContent = initial;
          const hash = Array.from(user.email).reduce((acc, char) => acc + char.charCodeAt(0), 0);
          const colors = [
              ['#34D399','#10B981'], ['#60A5FA','#3B82F6'], ['#FBBF24','#F59E0B'],
              ['#F87171','#EF4444'], ['#A78BFA','#8B5CF6'], ['#F472B6','#EC4899']
          ];
          const chosen = colors[hash % colors.length];
          avatarWrapper.style.background = `linear-gradient(135deg, ${chosen[0]}, ${chosen[1]})`;
      }
  }

  /***********************
   * UI Helpers & Utilities
   ***********************/
  function showToast(text, time = 3000, isError = false) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.className = `fixed top-6 right-6 p-3 rounded shadow text-white z-50 ${isError ? 'bg-red-600' : 'bg-blue-600'}`;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }

  function setActive(buttonId) {
    document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(buttonId);
    if (activeBtn) activeBtn.classList.add('active');
  }

  function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }
  
  function escapeAttr(s) {
    return (s === undefined || s === null) ? '' : String(s).replace(/"/g, '&quot;');
  }
  
  /***********************
   * Main Navigation / Views
   ***********************/
   function setMode(newMode) {
     mode = newMode;
     const isEntryMode = (mode === "entry");
     document.getElementById("navBottom").style.display = isEntryMode ? "flex" : "none";
     updateInfoBox();
   }

  function showTutorial() {
    setMode("tutorial");
    const qa = document.getElementById("question-area");
    qa.innerHTML = `
      <section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto">
        <header class="mb-6 text-center">
          <h2 class="text-3xl font-extrabold text-green-600 mb-2">ğŸ‘‹ Willkommen!</h2>
          <p class="text-gray-600 text-lg">Dies ist der HÃ¼tten-Assistent. Hier ein kurzer Ãœberblick:</p>
        </header>
        <ul class="space-y-5 text-gray-700">
          <li class="flex items-start"><span class="text-green-500 mr-3 text-xl">â•</span><p><strong>Neue Eintragung:</strong> Erstelle eine neue HÃ¼tte, einen Hofladen oder einen anderen Ort.</p></li>
          <li class="flex items-start"><span class="text-green-500 mr-3 text-xl">ğŸ“‹</span><p><strong>Meine Eintragungen:</strong> Verwalte deine bestehenden EintrÃ¤ge, bearbeite Details und lade Fotos hoch.</p></li>
          <li class="flex items-start"><span class="text-green-500 mr-3 text-xl">ğŸ’Œ</span><p><strong>HÃ¼tten-Nachrichten:</strong> Lies und verwalte Nachrichten, die Besucher an deinen HÃ¼tten hinterlassen.</p></li>
          <li class="flex items-start"><span class="text-green-500 mr-3 text-xl">ğŸ’¬</span><p><strong>Support:</strong> Kontaktiere uns bei Problemen oder Fragen.</p></li>
        </ul>
      </section>
    `;
  }

  /***********************
   * New Entry Flow (Steps 0-10)
   ***********************/
  function startNewEntry() {
    if (!currentUser) return showToast("Bitte zuerst einloggen.", 3000, true);
    editingData = {};
    step = 0;
    setMode("entry");
    renderQuestion();
    toggleSidebar();
  }

  function nextStep() {
    // Validation checks for current step
    let isValid = true;
    switch (step) {
      case 0:
        if (!document.getElementById('dsCheck')?.checked) {
          showToast('Bitte die DatenschutzerklÃ¤rung akzeptieren.', 3000, true);
          isValid = false;
        } else {
            editingData.datenschutz = true;
        }
        break;
      case 1:
        if (!editingData.typ) {
          showToast('Bitte einen Typ auswÃ¤hlen.', 3000, true);
          isValid = false;
        }
        break;
      case 2:
        const name = document.getElementById('nameInput')?.value.trim();
        if (!name) {
          showToast('Bitte einen Namen eingeben.', 3000, true);
          isValid = false;
        } else {
            editingData.name = name;
        }
        break;
      case 5:
        editingData.oeffnungszeiten = collectOpeningHours('new-entry');
        break;
      case 6:
        editingData.extras = document.getElementById('extrasInput')?.value.trim();
        break;
      case 8: // Quill editor data is saved on text-change
        break;
      case 9:
        const rawTags = document.getElementById('tagsInput')?.value || '';
        editingData.tags = rawTags.split(',').map(s => s.trim()).filter(Boolean).slice(0, 10);
        break;
    }
    
    if (isValid && step < stepsCount - 1) {
      step++;
      renderQuestion();
    }
  }

  function prevStep() {
    if (step > 0) {
      step--;
      renderQuestion();
    }
  }
  
  const typeTexts = {
      EierhÃ¼tte: { title: "ğŸ·ï¸ Name der EierhÃ¼tte", question: "Wie soll deine EierhÃ¼tte heiÃŸen?" },
      Hofladen: { title: "ğŸ·ï¸ Name des Hofladens", question: "Wie soll dein Hofladen heiÃŸen?" },
      Selbstbedienung: { title: "ğŸ·ï¸ Name des SelbstbedienungshÃ¤uschens", question: "Wie soll dein SelbstbedienungshÃ¤uschen heiÃŸen?" },
      Spielplatz: { title: "ğŸ·ï¸ Name des Spielplatzes", question: "Wie soll der Spielplatz heiÃŸen?" },
      Abenteuerhof: { title: "ğŸ·ï¸ Name des Abenteuerhofs", question: "Wie soll dein Abenteuerhof heiÃŸen?" },
      Automat: { title: "ğŸ·ï¸ Name des Automaten", question: "Wie soll dein Automat heiÃŸen?" }
  };

  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // Clear previous content
    updateProgress();
    
    let content = '';
    
    try {
      switch (step) {
        case 0: // Privacy Policy
          content = `
            <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
              <h2 class="text-xl font-bold mb-3">ğŸ›¡ï¸ DatenschutzerklÃ¤rung</h2>
              <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200">
                <iframe src="https://radlmap.net/datenschutz.html" class="w-full h-[500px] border-0 bg-white"></iframe>
              </div>
              <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                <input id="dsCheck" type="checkbox" class="w-4 h-4" disabled /> Ich akzeptiere die DatenschutzerklÃ¤rung
              </label>
              <div id="dsHint" class="text-xs text-red-500 mt-1">â¬‡ï¸ Bitte bis ganz nach unten scrollen</div>
            </div>`;
          qa.innerHTML = content;
          const scrollBox = document.getElementById("dsScrollBox");
          scrollBox.addEventListener("scroll", () => {
            if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 10) {
              document.getElementById("dsCheck").disabled = false;
              const hint = document.getElementById("dsHint");
              hint.textContent = "âœ… Du kannst nun akzeptieren.";
              hint.classList.remove("text-red-500");
              hint.classList.add("text-green-600");
            }
          });
          break;
          
        case 1: // Type Selection
            const opts = [
              { emoji: 'ğŸ¥š', label: 'EierhÃ¼tte', key: 'EierhÃ¼tte' }, { emoji: 'ğŸª', label: 'Hofladen', key: 'Hofladen' },
              { emoji: 'ğŸ ', label: 'SelbstbedienungshÃ¤uschen', key: 'Selbstbedienung' }, { emoji: 'ğŸ›', label: 'Spielplatz', key: 'Spielplatz' },
              { emoji: 'ğŸŒ„', label: 'Abenteuerhof', key: 'Abenteuerhof' }, { emoji: 'ğŸ¶', label: 'Automat', key: 'Automat' }
            ];
            let cardsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">';
            opts.forEach(o => {
                const isSelected = editingData.typ === o.key ? 'selected' : '';
                cardsHTML += `<div class="bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer ${isSelected}" onclick="window.selectCardOption(this, 'typ', '${o.key}')">
                                <div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>
                              </div>`;
            });
            cardsHTML += '</div>';
            qa.innerHTML = cardsHTML;
            break;
        
        case 2: // Name
          const { title, question } = typeTexts[editingData.typ] || { title: "ğŸ·ï¸ Name", question: "Wie soll dein Eintrag heiÃŸen?" };
          qa.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
              <h2 class="text-lg font-bold mb-2">${title}</h2>
              <p class="text-sm text-gray-600 mb-2">${question}</p>
              <input id="nameInput" class="w-full border p-2 rounded" placeholder="Name eingeben" value="${editingData.name || ''}">
            </div>`;
          break;
          
        case 3: // Seating
        case 4: // Power
            const field = step === 3 ? 'sitzplaetze' : 'strom';
            const details = step === 3 ? {title: 'ğŸª‘ SitzplÃ¤tze', yes: 'âœ… Ja', no: 'âŒ Nein'} : {title: 'ğŸ”Œ Strom', yes: 'âš¡ Ja', no: 'âŒ Nein'};
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                    <h2 class="text-lg font-bold mb-2">Gibt es ${details.title}?</h2>
                    <div class="flex gap-4">
                        <button class="flex-1 p-3 border rounded ${editingData[field] === 'Ja' ? 'selected' : ''}" onclick="selectOption('${field}','Ja', this)">${details.yes}</button>
                        <button class="flex-1 p-3 border rounded ${editingData[field] === 'Nein' ? 'selected' : ''}" onclick="selectOption('${field}','Nein', this)">${details.no}</button>
                    </div>
                </div>`;
            break;

        case 5: // Opening Hours
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                  <h2 class="text-lg font-bold mb-3">ğŸ•’ Ã–ffnungszeiten</h2>
                  ${renderOpeningHoursEditor('new-entry', editingData.oeffnungszeiten)}
                </div>`;
            break;
            
        case 6: // Extras
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                    <h2 class="text-lg font-bold mb-2">âœ¨ Extras (optional)</h2>
                    <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. GetrÃ¤nke, KÃ¼hlschrank" value="${editingData.extras || ''}">
                </div>`;
            break;

        case 7: // Animals
            const animals = ["ğŸ Ziege","ğŸ„ Kuh","ğŸ“ Huhn","ğŸ• Hund","ğŸ‡ Hase","ğŸˆ Katze","Keine Tiere"];
            let animalsHTML = `<div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                                <h2 class="text-lg font-bold mb-3">ğŸ¾ Welche Tiere gibt es?</h2>
                                <div id="tiereGrid" class="grid grid-cols-3 gap-2">`;
            editingData.tiere = editingData.tiere || [];
            animals.forEach(t => {
                const isSel = editingData.tiere.includes(t) ? 'selected' : '';
                animalsHTML += `<button class="p-2 border rounded text-sm ${isSel}" onclick="toggleAnimal(this, '${t}')">${t}</button>`;
            });
            animalsHTML += `</div></div>`;
            qa.innerHTML = animalsHTML;
            break;

        case 8: // Description
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                    <h2 class="text-lg font-bold mb-2">ğŸ“ Beschreibung</h2>
                    <div id="quillContainer" class="bg-white h-40"></div>
                </div>`;
            setTimeout(() => {
                const quill = new Quill('#quillContainer', { theme: 'snow' });
                if (editingData.beschreibung) {
                    quill.root.innerHTML = editingData.beschreibung;
                }
                quill.on('text-change', () => {
                    editingData.beschreibung = quill.root.innerHTML;
                });
            }, 100);
            break;

        case 9: // Tags
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                    <h2 class="text-lg font-bold mb-2">ğŸ·ï¸ SchlagwÃ¶rter (Komma-getrennt)</h2>
                    <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. FrÃ¼hstÃ¼ck, Schattig" value="${(editingData.tags || []).join(', ')}">
                </div>`;
            break;

        case 10: // Overview & Location
            qa.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
                  <h2 class="text-xl font-bold mb-3">ğŸ“‹ Ãœbersicht & Standort</h2>
                  <h3 class="text-lg font-bold mt-4 mb-2">ğŸ“ Standort</h3>
                  <div class="relative mb-2">
                    <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchenâ€¦" />
                    <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
                  </div>
                  <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded">ğŸ“¡ Mein Standort</button>
                  <div id="overview-map" class="h-64 rounded border mb-4"></div>
                  <div class="flex gap-2">
                    <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">âœ… Einreichen</button>
                    <button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">âœ– Abbrechen</button>
                  </div>
                  <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprÃ¼ft und erst nach Freigabe sichtbar.</p>
                </div>`;
            setTimeout(() => initOverviewMap(), 200);
            break;
            
        default:
          qa.innerHTML = `<div class="text-center p-4">Schritt ${step} nicht definiert.</div>`;
      }
    } catch (err) {
      console.error("renderQuestion error", err);
      qa.innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler beim Rendern: ${err.message}</div>`;
    }
  }
  
  // Helpers for step rendering
  window.selectCardOption = (el, field, value) => {
    document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    editingData[field] = value;
  };
  
  window.selectOption = (field, value, el) => {
    if (el && el.parentNode) {
      el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
      el.classList.add('selected');
    }
    editingData[field] = value;
  };
  
  window.toggleAnimal = (btn, animal) => {
    const isSelected = btn.classList.toggle('selected');
    editingData.tiere = editingData.tiere || [];
    
    if (animal === 'Keine Tiere' && isSelected) {
        editingData.tiere = ['Keine Tiere'];
        document.querySelectorAll('#tiereGrid button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    } else {
        editingData.tiere = editingData.tiere.filter(t => t !== 'Keine Tiere');
        document.querySelector('#tiereGrid button[onclick*="Keine Tiere"]').classList.remove('selected');
        
        const index = editingData.tiere.indexOf(animal);
        if (isSelected && index === -1) {
            editingData.tiere.push(animal);
        } else if (!isSelected && index !== -1) {
            editingData.tiere.splice(index, 1);
        }
    }
  };

  /***********************
   * Opening Hours Editor
   ***********************/
  const DAY_LABELS = [
    { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" },
    { key: "mi", label: "Mittwoch" }, { key: "do", label: "Donnerstag" },
    { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" },
    { key: "so", label: "Sonntag" }
  ];

  function renderOpeningHoursEditor(id, data = {}) {
    let html = `
      <div id="openhours-${id}" class="space-y-2 mt-2">
        <label class="flex items-center gap-2 mb-4">
            <input type="checkbox" id="immerCheck-${id}" onchange="toggleOpeningDays('${id}')" ${data === 'Immer geÃ¶ffnet' ? 'checked' : ''}> Immer geÃ¶ffnet
        </label>
        <table id="days-table-${id}" class="w-full text-sm border border-gray-200 rounded overflow-hidden ${data === 'Immer geÃ¶ffnet' ? 'hidden' : ''}">
          <thead class="bg-green-100 text-green-800">
            <tr>
              <th class="py-2 px-3 text-left">Tag</th><th class="py-2 px-3 text-center">GeÃ¶ffnet</th>
              <th class="py-2 px-3 text-center">Von</th><th class="py-2 px-3 text-center">Bis</th>
            </tr>
          </thead>
          <tbody class="divide-y">`;
    DAY_LABELS.forEach(day => {
      const dayData = Array.isArray(data) ? data.find(d => d.tag?.toLowerCase() === day.key) || {} : {};
      const open = !!dayData.von;
      html += `
        <tr>
          <td class="py-2 px-3">${day.label}</td>
          <td class="text-center"><input type="checkbox" class="oh-open" data-day="${day.key}" onchange="toggleTimeInputs(this)" ${open ? "checked" : ""}/></td>
          <td class="text-center"><input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${dayData.von || ''}" ${!open ? "disabled" : ""}/></td>
          <td class="text-center"><input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${dayData.bis || ''}" ${!open ? "disabled" : ""}/></td>
        </tr>`;
    });
    html += `</tbody></table></div>`;
    return html;
  }
  
  window.toggleOpeningDays = (id) => {
      const isChecked = document.getElementById(`immerCheck-${id}`).checked;
      document.getElementById(`days-table-${id}`).classList.toggle('hidden', isChecked);
  };

  window.toggleTimeInputs = (checkbox) => {
      const row = checkbox.closest("tr");
      const fromInput = row.querySelector(".oh-from");
      const toInput = row.querySelector(".oh-to");
      fromInput.disabled = !checkbox.checked;
      toInput.disabled = !checkbox.checked;
      if (!checkbox.checked) {
          fromInput.value = "";
          toInput.value = "";
      }
  };

  function collectOpeningHours(id) {
    if (document.getElementById(`immerCheck-${id}`)?.checked) {
      return "Immer geÃ¶ffnet";
    }
    const result = [];
    const wrapper = document.getElementById(`openhours-${id}`);
    if (!wrapper) return [];
    
    DAY_LABELS.forEach(day => {
      const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
      if (openCheckbox && openCheckbox.checked) {
          const from = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`).value;
          const to = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`).value;
          if (from && to) {
              result.push({ tag: day.label.substring(0,2), von: from, bis: to });
          }
      }
    });
    return result;
  }
  
  /***********************
   * Map & Geolocation
   ***********************/
  let overviewMap, overviewMarker;
  function initOverviewMap(lat = 51.16, lng = 10.45, zoom = 6) {
    if (!document.getElementById("overview-map")) return;
    
    if (overviewMap) overviewMap.remove();
    overviewMap = L.map("overview-map").setView([lat, lng], zoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(overviewMap);
    
    overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap);
    overviewMarker.on("dragend", ev => {
      const p = ev.target.getLatLng();
      editingData.location = { lat: p.lat, lng: p.lng };
    });
    editingData.location = { lat, lng };

    document.getElementById("gpsBtn")?.addEventListener("click", locateGPS);
    document.getElementById("addressSearch")?.addEventListener("input", handleAddressSearch);
  }

  function locateGPS() {
    if (!navigator.geolocation) return showToast("GPS nicht verfÃ¼gbar", 3000, true);
    navigator.geolocation.getCurrentPosition(
      pos => initOverviewMap(pos.coords.latitude, pos.coords.longitude, 15),
      err => showToast("GPS-Fehler: " + err.message, 3000, true)
    );
  }

  async function handleAddressSearch(e) {
      const query = e.target.value.trim();
      const suggestionBox = document.getElementById("addressSuggestions");
      if (query.length < 3) {
          suggestionBox.innerHTML = "";
          suggestionBox.classList.add("hidden");
          return;
      }
      try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
          const data = await res.json();
          suggestionBox.innerHTML = data.map(item => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="${item.lat}" data-lon="${item.lon}">${item.display_name}</div>`).join("");
          suggestionBox.classList.remove("hidden");
          suggestionBox.querySelectorAll("div").forEach(div => {
              div.addEventListener("click", () => {
                  e.target.value = div.textContent;
                  suggestionBox.classList.add("hidden");
                  initOverviewMap(parseFloat(div.dataset.lat), parseFloat(div.dataset.lon), 15);
              });
          });
      } catch (err) {
          console.error("Nominatim search error:", err);
      }
  }

  /***********************
   * Data Submission
   ***********************/
  async function submitEntry() {
    if (!editingData.name || !editingData.typ || !editingData.location) {
      return showToast('Bitte Name, Typ und Standort ausfÃ¼llen.', 3000, true);
    }

    const payload = {
      userId: currentUser.uid,
      name: editingData.name,
      typ: editingData.typ,
      sitzplaetze: editingData.sitzplaetze || 'Nein',
      strom: editingData.strom || 'Nein',
      extras: editingData.extras || '',
      tiere: editingData.tiere || [],
      beschreibung: editingData.beschreibung || '',
      tags: editingData.tags || [],
      oeffnungszeiten: editingData.oeffnungszeiten || [],
      status: 'offen',
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      location: new firebase.firestore.GeoPoint(editingData.location.lat, editingData.location.lng)
    };
    
    try {
      await db.collection('eierhuetten').add(payload);
      showToast('âœ… Eintragung gesendet und wird nun geprÃ¼ft.');
      showMyEntries();
    } catch (err) {
      console.error('submitEntry error', err);
      showToast('Fehler beim Senden: ' + err.message, 5000, true);
    }
  }

  /***********************
   * "My Entries" View
   ***********************/
  async function showMyEntries() {
    if (!currentUser) return showToast("Bitte zuerst einloggen.", 3000, true);
    setMode("list");
    const qa = document.getElementById("question-area");
    qa.innerHTML = `<div class="max-w-6xl mx-auto">
                      <h2 class="text-2xl font-bold mb-6 text-green-700">ğŸ“‹ Meine Eintragungen</h2>
                      <div id="entriesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-3 text-gray-500">â³ Lade Eintragungenâ€¦</div>
                      </div>
                    </div>`;
    
    try {
        const snap = await db.collection("eierhuetten")
          .where("userId", "==", currentUser.uid)
          .orderBy("erstelltAm", "desc")
          .get();

        const grid = document.getElementById("entriesGrid");
        if (snap.empty) {
            grid.innerHTML = `<div class="bg-white p-6 rounded shadow text-center col-span-3">Du hast noch keine Eintragungen.</div>`;
            return;
        }

        grid.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data();
            const id = doc.id;
            if (d.status === 'archiviert' || d.status === 'deleted') return;
            
            const img = (Array.isArray(d.fotos) && d.fotos.length > 0) ? (d.fotos[0].url || d.fotos[0]) : 'https://radlmap.net/img/noimg/1.jpg';
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl transition cursor-pointer';
            card.innerHTML = `
                <div class="relative"><img src="${escapeAttr(img)}" alt="${escapeAttr(d.name)}" class="w-full h-48 object-cover"></div>
                <div class="p-4 flex justify-between items-center">
                  <div>
                    <h3 class="font-bold text-lg text-gray-800 truncate">${d.name || 'Unbenannt'}</h3>
                    <p class="text-xs text-gray-500 capitalize">${d.status || 'Unbekannt'}</p>
                  </div>
                  <div class="flex gap-3 text-lg">
                    <button class="edit-btn text-blue-600 hover:text-blue-800" title="Bearbeiten" data-id="${id}">âœï¸</button>
                    <button class="delete-btn text-red-600 hover:text-red-800" title="LÃ¶schen" data-id="${id}" data-name="${escapeAttr(d.name)}">âŒ</button>
                  </div>
                </div>`;
                
            card.addEventListener('click', (ev) => {
                if (ev.target.closest('.edit-btn') || ev.target.closest('.delete-btn')) return;
                openEditPage(id);
            });
            grid.appendChild(card);
        });

        grid.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); openEditPage(e.currentTarget.dataset.id); }));
        grid.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); confirmDeleteEntry(e.currentTarget.dataset.id, e.currentTarget.dataset.name); }));

    } catch (err) {
        console.error('showMyEntries error', err);
        document.getElementById("entriesGrid").innerHTML = `<div class="bg-red-100 p-4 rounded col-span-3">Fehler beim Laden: ${err.message}</div>`;
    }
  }

  function confirmDeleteEntry(id, name) {
    if (!confirm(`âš ï¸ MÃ¶chtest du "${name || id}" wirklich lÃ¶schen?`)) return;
    db.collection('eierhuetten').doc(id).delete()
      .then(() => {
        showToast('âœ… Eintragung gelÃ¶scht');
        showMyEntries();
      })
      .catch(err => showToast('âŒ Fehler beim LÃ¶schen: ' + err.message, 5000, true));
  }
  
 /***********************
   * Edit Page
   ***********************/
  async function openEditPage(id) {
    setMode("edit");
    const docRef = db.collection("eierhuetten").doc(id);
    const docSnap = await docRef.get();
    if (!docSnap.exists) return showToast("âŒ Eintrag nicht gefunden", 3000, true);
    
    const d = docSnap.data();
    const qa = document.getElementById("question-area");
    
    qa.innerHTML = `
      <div class="max-w-5xl mx-auto">
        <button onclick="showMyEntries()" class="mb-4 text-sm text-blue-600 hover:underline">â¬…ï¸ ZurÃ¼ck zur Ãœbersicht</button>
        <div class="flex flex-col md:flex-row gap-6">
          <div id="photoUploaderContainer" class="w-full md:w-1/3"></div>
          <div class="w-full md:w-2/3 bg-white rounded-xl p-6 shadow space-y-4">
              <h4 class="font-semibold text-lg mb-2">Eintrag bearbeiten</h4>
              
              <label class="block"><span class="text-gray-700 text-sm">Name</span>
                <input id="editName" value="${escapeAttr(d.name)}" class="w-full border rounded p-2 mt-1">
              </label>

              <label class="block"><span class="text-gray-700 text-sm">Beschreibung</span>
                <div id="editQuill" class="bg-white border rounded mt-1 min-h-[150px]"></div>
              </label>

              <div id="openingEditorWrapper" class="mt-3">
                 <span class="text-gray-700 text-sm">Ã–ffnungszeiten</span>
                 ${renderOpeningHoursEditor(id, d.oeffnungszeiten)}
              </div>

              <div class="grid grid-cols-2 gap-4">
                <label><span class="text-gray-700 text-sm">SitzplÃ¤tze</span>
                  <select id="editSitz" class="w-full border rounded p-2 mt-1">
                    <option ${d.sitzplaetze === 'Ja' ? 'selected' : ''}>Ja</option>
                    <option ${d.sitzplaetze !== 'Ja' ? 'selected' : ''}>Nein</option>
                  </select>
                </label>
                <label><span class="text-gray-700 text-sm">Strom</span>
                  <select id="editStrom" class="w-full border rounded p-2 mt-1">
                    <option ${d.strom === 'Ja' ? 'selected' : ''}>Ja</option>
                    <option ${d.strom !== 'Ja' ? 'selected' : ''}>Nein</option>
                  </select>
                </label>
              </div>

              <label class="block"><span class="text-gray-700 text-sm">Extras</span>
                <input id="editExtras" value="${escapeAttr(d.extras)}" class="w-full border rounded p-2 mt-1">
              </label>

              <label class="block"><span class="text-gray-700 text-sm">Tiere</span>
                 <div id="tiereButtons" class="flex flex-wrap gap-2 mt-2"></div>
              </label>
              
              <label class="block"><span class="text-gray-700 text-sm">Tags</span>
                <input id="editTags" value="${(d.tags || []).join(', ')}" class="w-full border rounded p-2 mt-1">
              </label>

              <div class="flex justify-end gap-3 pt-4">
                <button onclick="confirmDeleteEntry('${id}', '${escapeAttr(d.name)}')" class="px-4 py-2 bg-red-600 text-white rounded">ğŸ—‘ï¸ LÃ¶schen</button>
                <button onclick="saveEdit('${id}')" class="px-4 py-2 bg-green-600 text-white rounded">ğŸ’¾ Speichern</button>
              </div>
          </div>
        </div>
      </div>
    `;

    // Initialize Quill
    const quill = new Quill('#editQuill', { theme: 'snow' });
    quill.root.innerHTML = d.beschreibung || "";
    
    // Initialize Animal Buttons
    const animals = ["ğŸ Ziege","ğŸ„ Kuh","ğŸ“ Huhn","ğŸ• Hund","ğŸ‡ Hase","ğŸˆ Katze","Keine Tiere"];
    const tiereContainer = document.getElementById("tiereButtons");
    let selectedTiere = d.tiere || [];
    animals.forEach(t => {
        const btn = document.createElement("button");
        btn.className = `p-2 border rounded text-sm ${selectedTiere.includes(t) ? 'selected' : ''}`;
        btn.textContent = t;
        btn.onclick = () => {
            btn.classList.toggle('selected');
            // This is a simplified toggle; for full logic see new entry animal toggle
            if (btn.classList.contains('selected')) {
                if (!selectedTiere.includes(t)) selectedTiere.push(t);
            } else {
                selectedTiere = selectedTiere.filter(animal => animal !== t);
            }
        };
        tiereContainer.appendChild(btn);
    });

    // Initialize Smart Image Uploader
    renderSmartImageUploader(document.getElementById("photoUploaderContainer"), docRef, d.fotos || []);
    
    // Attach save function
    window.saveEdit = async (hutId) => {
        const payload = {
            name: document.getElementById('editName').value.trim(),
            beschreibung: quill.root.innerHTML,
            oeffnungszeiten: collectOpeningHours(hutId),
            sitzplaetze: document.getElementById('editSitz').value,
            strom: document.getElementById('editStrom').value,
            extras: document.getElementById('editExtras').value,
            tiere: selectedTiere,
            tags: document.getElementById('editTags').value.split(',').map(s=>s.trim()).filter(Boolean)
        };
        try {
            await docRef.update(payload);
            showToast('âœ… Gespeichert!');
        } catch (err) {
            showToast('âŒ Fehler beim Speichern: ' + err.message, 5000, true);
        }
    };
  }
  
  /***********************
   * Smart Image Uploader
   ***********************/
  async function renderSmartImageUploader(container, docRef, existingImages = []) {
      container.innerHTML = `
        <div class="bg-white rounded-xl shadow p-4">
          <h3 class="text-sm font-semibold mb-3">ğŸ“¸ Fotos verwalten</h3>
          <div id="smartUploadZone" class="relative border-2 border-dashed border-green-300 bg-green-50 hover:bg-green-100 transition rounded-xl p-6 text-center cursor-pointer">
            <p class="text-gray-600 text-sm">Bilder hierher ziehen oder klicken</p>
            <input id="smartUploadInput" type="file" accept="image/*" multiple class="hidden">
            <div id="smartUploadPreview" class="flex flex-wrap gap-3 justify-center mt-3"></div>
          </div>
        </div>`;
        
      const zone = container.querySelector("#smartUploadZone");
      const input = container.querySelector("#smartUploadInput");
      const preview = container.querySelector("#smartUploadPreview");
      let currentImages = existingImages.map(img => typeof img === 'string' ? { url: img, title: '' } : img);

      function renderPreview() {
          preview.innerHTML = '';
          if (!currentImages.length) {
              preview.innerHTML = `<div class="text-gray-400 text-xs">Noch keine Bilder hochgeladen.</div>`;
              return;
          }
          currentImages.forEach((img, idx) => {
              const card = document.createElement('div');
              card.className = "relative group w-32 h-32 border rounded overflow-hidden shadow-sm";
              card.innerHTML = `
                  <img src="${img.url}" class="object-cover w-full h-full">
                  <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 p-1">
                    <input class="imageTitleInput w-full bg-transparent text-white text-xs text-center outline-none" value="${img.title || ''}" placeholder="Titel..." data-idx="${idx}">
                  </div>
                  <button class="removeBtn absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition">&times;</button>`;
              
              card.querySelector('.imageTitleInput').addEventListener('change', (e) => {
                  currentImages[idx].title = e.target.value.trim();
                  docRef.update({ fotos: currentImages });
              });
              
              card.querySelector('.removeBtn').addEventListener('click', () => {
                  if (!confirm("Bild wirklich entfernen?")) return;
                  currentImages.splice(idx, 1);
                  docRef.update({ fotos: currentImages }).then(renderPreview);
              });
              
              preview.appendChild(card);
          });
      }

      async function handleFiles(files) {
          for (const file of Array.from(files)) {
              try {
                  const formData = new FormData();
                  formData.append("image", file);
                  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
                  const data = await res.json();
                  if (data.success) {
                      currentImages.push({ url: data.data.url, title: file.name.split('.')[0] });
                  } else {
                      throw new Error('ImgBB API error');
                  }
              } catch (err) {
                  showToast('Bild-Upload fehlgeschlagen.', 3000, true);
                  console.error(err);
              }
          }
          await docRef.update({ fotos: currentImages });
          renderPreview();
      }

      zone.onclick = () => input.click();
      input.onchange = (e) => handleFiles(e.target.files);
      // Drag and drop listeners
      zone.ondragover = (e) => { e.preventDefault(); zone.classList.add("bg-green-100"); };
      zone.ondragleave = () => zone.classList.remove("bg-green-100");
      zone.ondrop = (e) => { e.preventDefault(); zone.classList.remove("bg-green-100"); handleFiles(e.dataTransfer.files); };
      
      renderPreview();
  }

  /***********************
   * Support System
   ***********************/
  function openSupport() {
    if (!currentUser) return showToast("Bitte einloggen.", 3000, true);
    setMode("support");
    const qa = document.getElementById('question-area');
    qa.innerHTML = `
      <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
        <h2 class="text-xl font-bold mb-3">ğŸ“¨ Support</h2>
        <form id="supportForm" class="space-y-4">
            <textarea id="supMsg" class="w-full border p-2 rounded" rows="4" placeholder="Deine Nachricht an uns..." required></textarea>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Absenden</button>
        </form>
        <hr class="my-6" />
        <h3 class="text-lg font-bold mb-2">ğŸ“‚ Deine bisherigen Support-Tickets</h3>
        <div id="supportList" class="space-y-2 text-sm text-gray-700">â³ Lade Ticketsâ€¦</div>
      </div>
    `;
    
    document.getElementById('supportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('supMsg').value.trim();
        if (!msg) return;
        await db.collection('support').add({
            msg,
            mail: currentUser.email,
            uid: currentUser.uid,
            status: 'offen',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('âœ… Ticket gesendet!');
        document.getElementById('supMsg').value = '';
        loadSupportTickets();
    });
    
    loadSupportTickets();
  }

  async function loadSupportTickets() {
      const list = document.getElementById("supportList");
      if (!list || !currentUser) return;
      
      const snap = await db.collection("support").where("uid", "==", currentUser.uid).orderBy("createdAt", "desc").get();
      if (snap.empty) {
          list.innerHTML = "<p>Keine Support-Anfragen gefunden.</p>";
          return;
      }
      list.innerHTML = snap.docs.map(doc => {
          const d = doc.data();
          const date = d.createdAt?.toDate().toLocaleString('de-DE') || '-';
          return `<div class="bg-gray-50 p-3 rounded-lg">
                    <p class="font-semibold">${d.msg}</p>
                    <p class="text-xs text-gray-500">Status: <span class="capitalize">${d.status}</span> | ${date}</p>
                  </div>`;
      }).join('');
  }
  
    /***********************
     * Info Box Content
     ***********************/
    const stepInfos = {
        0: { title: "Datenschutz", text: "Bitte lies die DatenschutzerklÃ¤rung und bestÃ¤tige sie, um fortzufahren." },
        1: { title: "Art der Eintragung", text: "WÃ¤hle die passende Kategorie fÃ¼r deinen Ort aus." },
        2: { title: "Name", text: "Verwende einen kurzen, prÃ¤gnanten Namen, z.B. â€Hofladen am MÃ¼hlenbachâ€œ." },
        3: { title: "SitzplÃ¤tze", text: "Gibt es BÃ¤nke, Tische oder andere Gelegenheiten zum Verweilen?" },
        4: { title: "Strom", text: "Ist eine Steckdose verfÃ¼gbar, z.B. zum Laden von E-Bikes?" },
        5: { title: "Ã–ffnungszeiten", text: "Gib an, wann dein Angebot verfÃ¼gbar ist. WÃ¤hle 'Immer geÃ¶ffnet' fÃ¼r 24/7." },
        6: { title: "Extras", text: "Besonderheiten wie GetrÃ¤nke, ein KÃ¼hlschrank oder ein Grill." },
        7: { title: "Tiere", text: "WÃ¤hle alle Tiere aus, die Besucher vor Ort antreffen kÃ¶nnen." },
        8: { title: "Beschreibung", text: "Beschreibe deinen Ort ausfÃ¼hrlich. Was macht ihn besonders?" },
        9: { title: "SchlagwÃ¶rter", text: "Hilf anderen, deinen Ort zu finden. Z.B. 'regional, Bio, kinderfreundlich'." },
        10: { title: "Standort", text: "Setze den Pin exakt auf der Karte. Nutze die Suche oder deinen GPS-Standort." },
    };

    function updateInfoBox() {
        const boxDesktop = document.getElementById("infoBox");
        const boxMobile = document.getElementById("infoBoxMobile");
        let html = "";

        if (mode === "entry") {
            const info = stepInfos[step];
            html = info ? `<h4 class="font-semibold">${info.title}</h4><p>${info.text}</p>` : "<p>Keine Info verfÃ¼gbar.</p>";
        } else if (mode === "list" || mode === "edit") {
            html = `<h4 class="font-semibold">ğŸ“‹ Meine Eintragungen</h4><p>Hier siehst du deine EintrÃ¤ge. Klicke auf einen Eintrag, um ihn zu bearbeiten.</p>`;
        } else if (mode === "tutorial") {
            html = `<h4 class="font-semibold">ğŸ‘‹ Willkommen</h4><p>Dies ist dein zentrales Dashboard. WÃ¤hle eine Aktion aus der Seitenleiste.</p>`;
        } else if (mode === "support") {
            html = `<h4 class="font-semibold">ğŸ’¬ Support</h4><p>Stelle hier deine Fragen oder melde Probleme. Deine Tickets werden gespeichert.</p>`;
        } else if (mode === "hutMessages") {
            html = `<h4 class="font-semibold">ğŸ’Œ HÃ¼tten-Nachrichten</h4><p>Hier siehst du Nachrichten von Besuchern. Die Ansicht aktualisiert sich automatisch.</p>`;
        } else {
            html = "<p>â„¹ï¸ WÃ¤hle links eine Funktion aus.</p>";
        }

        if (boxDesktop) boxDesktop.innerHTML = html;
        if (boxMobile) boxMobile.innerHTML = html;
    }
  
  // Expose functions to global scope for onclick handlers
  window.doGoogleLogin = doGoogleLogin;
  window.logout = logout;
  window.showMyEntries = showMyEntries;
  window.startNewEntry = startNewEntry;
  window.openSupport = openSupport;
  window.nextStep = nextStep;
  window.prevStep = prevStep;
  window.toggleSidebar = toggleSidebar;
  window.submitEntry = submitEntry;
  
  // Initial call
  updateInfoBox();
  
  // Mobile info overlay logic
  const toggleInfoBtn = document.getElementById("toggleInfo");
  const infoOverlay = document.getElementById("infoOverlay");
  const closeInfoBtn = document.getElementById("closeInfo");
  if (toggleInfoBtn) toggleInfoBtn.addEventListener("click", () => infoOverlay.classList.remove("hidden"));
  if (closeInfoBtn) closeInfoBtn.addEventListener("click", () => infoOverlay.classList.add("hidden"));

})();
// =================================================================================
// SCRIPT END
// =================================================================================
</script>

</body>
</html>
