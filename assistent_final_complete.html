<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent | Smarter V3 Complete</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    /* ---------------------------------------------------- */
    /* Basis & Schriftart */
    /* ---------------------------------------------------- */
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    
    /* ---------------------------------------------------- */
    /* Interaktive Elemente */
    /* ---------------------------------------------------- */
    .card-option { transition: transform .16s, box-shadow .16s, border-color .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 3px solid #10b981; background-color: #ecfdf5; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
    .sidebar-btn.active {
      background-color: #e8f8ee;
      color: #166534;
      font-weight: 600;
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ---------------------------------------------------- */
    /* Karten- und Editor-Fixes */
    /* ---------------------------------------------------- */
    .minimap { height: 250px; z-index: 0; border-radius: 0.5rem; }
    .leaflet-container { z-index: 0 !important; }
    .ql-toolbar.ql-snow { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; border-color: #e5e7eb !important; }
    .ql-container.ql-snow { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; border-color: #e5e7eb !important; height: 100%; }

    /* ---------------------------------------------------- */
    /* Smarter Upload Style */
    /* ---------------------------------------------------- */
    #smartUploadZone {
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      min-height: 180px;
    }
    #smartUploadZone:hover {
      background-color: #f0fdf4; /* green-50 */
      border-color: #10b981; /* green-500 */
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
    .uploading { position: relative; }
    .uploading::after {
      content: "‚è´";
      position: absolute;
      top: 8px; right: 8px;
      font-size: 1rem;
      animation: pulseUpload 1s infinite;
      color: #16a34a;
    }
    @keyframes pulseUpload {
      0% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.1); }
      100% { opacity: 0.6; transform: scale(1); }
    }

    /* ---------------------------------------------------- */
    /* Responsive Layout */
    /* ---------------------------------------------------- */
    @media (max-width: 767px) {
      /* Platz f√ºr die fixed Nav-Leiste am Ende */
      #question-area { padding-bottom: 92px; }
      #sidebar { box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    }
    @media (min-width: 768px) {
      /* Auf Desktop: Kein Padding f√ºr die Nav, da sie nicht fixed ist */
      #question-area { padding-bottom: 32px; }
      #navBottom { left: 16rem; } /* Anpassung an die feste Sidebar-Breite */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01] animate-fadeIn">
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" class="w-24 h-24 drop-shadow-lg" alt="App-Icon" />
    </div>
    <h1 class="text-3xl font-extrabold text-green-700 mb-3">Assistent-Dashboard</h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an, um fortzufahren.
    </p>
    <button onclick="doGoogleLogin()"
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-lg hover:shadow-xl transition w-full justify-center font-medium active:scale-[0.98]">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg"
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>
    <p class="text-xs text-gray-400 mt-6">üîí Wir verwenden Firebase f√ºr sichere Authentifizierung.</p>
  </div>
</div>

<div id="mainApp" class="flex min-h-screen hidden">

    <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 shadow-2xl md:shadow-none">

      <div class="flex flex-col items-center mb-8 pb-4 border-b border-gray-100">
        <div id="avatarWrapper" class="w-16 h-16 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xl font-bold shadow-md">
          <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
          <span id="avatarInitials">?</span>
        </div>
        <p class="text-sm text-gray-600">Angemeldet als:</p>
        <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center text-sm">-</p>
        <button onclick="logout()" class="mt-3 px-4 py-1.5 text-xs bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform">Logout</button>
      </div>

      <nav class="flex flex-col gap-2 text-[15px] flex-1">
        <a href="https://radlmap.net" target="_blank" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
          üö≤ Zur RadlMap
        </a>
        <hr class="my-1 border-gray-100">

        <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">
          üìä Betreiber-Dashboard
        </button>
        <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">
          üìã Meine Eintragungen
        </button>
        <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">
          ‚ûï Neue Eintragung
        </button>

        <div class="mt-4">
          <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider px-4 mb-1">Kommunikation</p>
          <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
            üíå H√ºtten-Nachrichten
            <span id="hutMessagesCount" class="ml-auto bg-red-600 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
          </button>
          <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSupport'); openSupport()">
            üí¨ Support & FAQ
          </button>
        </div>
        
        <div class="mt-4">
          <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider px-4 mb-1">Event-Verwaltung</p>
          <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
            <button id="btnMyEvents" class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition" onclick="setActive('btnMyEvents'); showMyEvents()">
              üìÖ Meine Events
            </button>
            <button id="btnCreateEvent" class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition" onclick="setActive('btnCreateEvent'); showCreateEvent()">
              ‚ûï Neues Event
            </button>
          </div>
        </div>

      </nav>

      <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
        v3.0 Smarter &middot; Assistent
      </div>
    </aside>

    <div id="infoSidebar" class="hidden lg:block w-80 p-6 bg-white border-l shadow-inner">
      <div class="sticky top-6">
        <h3 class="text-xl font-extrabold mb-4 text-green-700">‚ÑπÔ∏è Smarte Hilfe</h3>
        <div id="infoBox" class="space-y-4 p-4 bg-green-50 border border-green-200 rounded-xl text-sm text-gray-700 transition-all">
          <p>W√§hle links eine Funktion aus, oder starte eine **Neue Eintragung**.</p>
        </div>
        <div class="mt-6 p-4 border rounded-xl text-xs text-gray-500">
          <p class="font-bold mb-2">Technischer Hinweis:</p>
          <p>Dieses System arbeitet mit Firebase Firestore (Daten) und Storage (Bilder), um eine schnelle und sichere Verwaltung zu gew√§hrleisten.</p>
        </div>
      </div>
    </div>

    <main class="flex-1 flex flex-col overflow-hidden">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3 shadow-sm z-30">
        <div class="font-bold text-lg text-green-700">üåø Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="toggleSidebar()">‚ò∞</button>
      </div>

      <div class="w-full h-2 bg-gray-200 z-20">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all duration-500 ease-in-out"></div>
      </div>

      <section id="question-area" class="flex-1 p-4 md:p-8 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40 shadow-2xl hidden">
        <button id="prevBtn" class="px-5 py-2 bg-gray-200 text-gray-800 font-medium rounded-xl hover:bg-gray-300 transition active:scale-95" onclick="prevStep()">‚¨ÖÔ∏è Zur√ºck</button>
        <button id="nextBtn" class="px-5 py-2 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition active:scale-95" onclick="nextStep()">Weiter ‚û°Ô∏è</button>
      </div>
    </main>
</div>

<div id="toast" class="fixed top-6 right-6 hidden p-3 rounded-lg shadow-xl bg-blue-600 text-white z-[60] transition-opacity"></div>

<script>
(function() {
  'use strict';

  /***********************
   * Config & Init
   ***********************/
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro", // Ersetze dies mit deinem echten Schl√ºssel
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };
  const FALLBACK_LOCATION = [51.1657, 10.4515]; // Mitte Deutschland
  const NOMINATIM_SEARCH_URL = "https://nominatim.openstreetmap.org/search?format=json&q="; // F√ºr Adresssuche

  let app, db, storage;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    storage = firebase.storage();
    db.settings({ timestampsInSnapshots: true });
  } catch (e) {
    console.error("Firebase init error", e);
  }

  let currentUser = null;
  let editingData = {};
  let step = 0;
  const stepsCount = 12; // 0..11
  let mode = "tutorial"; // "entry", "list", "dashboard", "support", "hutMessages"
  let overviewMap;
  let overviewMarker;
  let quillEditor;
  let dashboardChart;

  // Texts for Step 2
  const typeTexts = {
    Eierh√ºtte: { title: "üè∑Ô∏è Name der Eierh√ºtte", question: "Wie soll deine Eierh√ºtte hei√üen?" },
    Hofladen: { title: "üè∑Ô∏è Name des Hofladens", question: "Wie soll dein Hofladen hei√üen?" },
    Selbstbedienung: { title: "üè∑Ô∏è Name des SB-Hauses", question: "Wie soll dein Selbstbedienungsh√§uschen hei√üen?" },
    Spielplatz: { title: "üè∑Ô∏è Name des Spielplatzes", question: "Wie soll der Spielplatz hei√üen?" },
    Abenteuerhof: { title: "üè∑Ô∏è Name des Abenteuerhofs", question: "Wie soll dein Abenteuerhof hei√üen?" },
    Automat: { title: "üè∑Ô∏è Name des Automaten", question: "Wie soll dein Automat hei√üen?" }
  };
  
  // Texts for Info Box
  const stepInfos = {
    0: { title: "Datenschutz (Wichtig!)", text: "Bitte lies die Datenschutzerkl√§rung aufmerksam und best√§tige sie. Dies ist rechtlich notwendig, um den Vorgang zu starten." },
    1: { title: "Art der Eintragung", text: "W√§hle den Typ, der dein Angebot am besten beschreibt. Dies beeinflusst die Darstellung auf der Karte." },
    2: { title: "Name", text: "Kurz, pr√§gnant, z. B. ‚ÄûEierh√ºtte am Dorfplatz‚Äú oder ‚ÄûHofladen Huber‚Äú. Ein guter Name ist leicht zu merken." },
    3: { title: "Sitzpl√§tze", text: "Gibt es Sitzgelegenheiten (Bank, Tisch) f√ºr Radfahrer und Wanderer? Ein wichtiges Kriterium f√ºr Besucher!" },
    4: { title: "Strom (E-Bikes)", text: "Ist Strom (z.B. eine Steckdose) f√ºr E-Bikes oder Handys verf√ºgbar? Sehr beliebt bei Radtouristen." },
    5: { title: "√ñffnungszeiten (SMART)", text: "Gib deine √ñffnungszeiten pro Tag an. W√§hle 'Immer ge√∂ffnet', wenn dein Angebot 24/7 zug√§nglich ist." },
    6: { title: "Extras/Angebot", text: "Was gibt es Besonderes? Beschreibe zus√§tzliche Angebote wie Getr√§nke, K√ºhlschrank, Grillm√∂glichkeiten oder sonstige Produkte." },
    7: { title: "Bilder / Fotos (Max. 10)", text: "Lade deine besten Fotos hoch. Gute Bilder steigern die Klicks und die Attraktivit√§t deines Eintrags. Bitte nur eigene Bilder verwenden!" },
    8: { title: "Tiere", text: "Welche Tiere k√∂nnen Besucher vor Ort sehen (z.B. Ziegen, H√ºhner)? Das ist besonders f√ºr Familien interessant." },
    9: { title: "Beschreibung (Detailliert)", text: "Beschreibe deinen Ort m√∂glichst ausf√ºhrlich. Erw√§hne Produkte, die Atmosph√§re und Besonderheiten. Du kannst Text formatieren." },
    10: { title: "Schlagw√∂rter", text: "Gib Schlagw√∂rter ein (Komma getrennt), damit andere deinen Eintrag besser finden k√∂nnen (z.B. 'Honig', 'Kaffeemaschine', 'Schattig'). Max. 10." },
    11: { title: "Standort & √úbersicht", text: "W√§hle den genauen Standort per Klick auf die Karte oder per GPS. Du kannst den Marker anschlie√üend verschieben. √úberpr√ºfe alle Daten, bevor du sie einreichst." }
  };
    
  /***********************
   * Authentication
   ***********************/
  window.doGoogleLogin = async function() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await firebase.auth().signInWithPopup(provider);
      showToast("‚úÖ Erfolgreich mit Google eingeloggt");
    } catch (e) {
      console.error("Google Login error", e);
      alert("Fehler beim Google-Login: " + e.message);
    }
  }

  window.logout = function() {
    firebase.auth().signOut();
    showToast("üëã Abgemeldet");
  }

  firebase.auth().onAuthStateChanged(u => {
    if (u) {
      currentUser = u;
      document.getElementById("accountMail").textContent = u.email;
      setGoogleProfile(u);
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("mainApp").classList.remove("hidden");
      // Sidebar mobil standardm√§√üig geschlossen halten
      document.getElementById('sidebar').classList.add('-translate-x-full');
      showTutorial();
      initHutMessagesBadge(); // Badge-Logik starten
    } else {
      currentUser = null;
      document.getElementById("mainApp").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");
      document.getElementById("question-area").innerHTML = "";
    }
  });

  function setGoogleProfile(user) {
    const picEl = document.getElementById('profilePic');
    const initEl = document.getElementById('avatarInitials');
    if (user.photoURL) {
        picEl.src = user.photoURL;
        picEl.classList.remove('hidden');
        initEl.classList.add('hidden');
    } else if (user.displayName) {
        const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    } else {
        const initials = user.email ? user.email[0].toUpperCase() : '?';
        initEl.textContent = initials;
        initEl.classList.remove('hidden');
        picEl.classList.add('hidden');
    }
  }

  /***********************
   * Navigation & State
   ***********************/
  window.setActive = function(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) activeBtn.classList.add('active');
  }

  window.toggleSidebar = function() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
  }

  window.showToast = function(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    t.style.opacity = '1';
    setTimeout(()=>{ t.style.opacity = '0'; }, time - 300);
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }

  window.startNewEntry = function() {
    if (!currentUser || !currentUser.uid) { showToast("Bitte zuerst einloggen"); return; }
    editingData = {};
    step = 0;
    mode = "entry";
    setActive('btnNewEntry');
    document.getElementById("navBottom").classList.remove("hidden");
    renderQuestion();
    if(document.getElementById('sidebar').classList.contains('translate-x-0')) toggleSidebar(); // schlie√üt Sidebar auf Mobile
  }

  window.selectOption = function(field, value, el) {
    el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
    editingData[field] = value;
  }
  
  window.nextStep = function() {
    if (validateAndCollectStepData(step)) {
      if (step < stepsCount - 1) step++;
      renderQuestion();
    }
  }

  window.prevStep = function() {
    if (step > 0) step--;
    renderQuestion();
  }

  /***********************
   * Form Logic (Steps)
   ***********************/

  // --- SMARTER √ñffnungszeiten Editor ---
  const DAY_LABELS = [
    { key: "mo", label: "Montag" }, { key: "di", label: "Dienstag" },
    { key: "mi", label: "Mittwoch" }, { key: "do", label: "Donnerstag" },
    { key: "fr", label: "Freitag" }, { key: "sa", label: "Samstag" },
    { key: "so", label: "Sonntag" }
  ];

  function renderOpeningHoursEditor(data = {}) {
    let html = `<div id="openhours-editor" class="space-y-4 mt-2">
      <div class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
        <input type="checkbox" id="immerCheck" onchange="document.getElementById('ohTable').classList.toggle('hidden', this.checked)"
               class="w-5 h-5 text-green-600 bg-white border-gray-300 rounded focus:ring-green-500" ${data === "Immer ge√∂ffnet" ? "checked" : ""}>
        <label for="immerCheck" class="font-semibold text-green-700 text-lg">Immer ge√∂ffnet (24/7)</label>
      </div>
      <table id="ohTable" class="w-full text-sm border border-gray-200 rounded-xl overflow-hidden shadow-inner ${data === "Immer ge√∂ffnet" ? "hidden" : ""}">
        <thead class="bg-green-100 text-green-800 uppercase text-xs"><tr>
          <th class="py-3 px-3 text-left">Tag</th>
          <th class="py-3 px-3 text-center">Ge√∂ffnet</th>
          <th class="py-3 px-3 text-center">Von</th>
          <th class="py-3 px-3 text-center">Bis</th>
        </tr></thead>
        <tbody class="divide-y divide-gray-100">`;

    DAY_LABELS.forEach(day => {
      const d = (typeof data === 'object' && data !== null) ? (data[day.key] || {}) : {};
      const open = !!d.open;
      const from = d.from || "08:00";
      const to = d.to || "20:00";
      html += `<tr><td class="py-2 px-3 font-medium">${day.label}</td>
        <td class="text-center">
          <input type="checkbox" class="oh-open w-4 h-4 text-green-600" data-day="${day.key}" ${open ? "checked" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-from border rounded px-2 py-1 text-sm bg-gray-50 disabled:bg-gray-200" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
        </td>
        <td class="text-center">
          <input type="time" class="oh-to border rounded px-2 py-1 text-sm bg-gray-50 disabled:bg-gray-200" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
        </td></tr>`;
    });

    html += `</tbody></table>
      <p class="text-xs text-gray-500 mt-2">Tipp: Ungew√§hlte Tage oder leere Zeiten werden als "geschlossen" behandelt.</p>
    </div>`;
    return html;
  }
  
  document.addEventListener("change", (e) => {
    if (e.target.classList.contains("oh-open")) {
      const row = e.target.closest("tr");
      const from = row.querySelector(".oh-from");
      const to = row.querySelector(".oh-to");
      const isOpen = e.target.checked;
      from.disabled = !isOpen;
      to.disabled = !isOpen;
      // Setzt Standardwerte, wenn ge√∂ffnet wird, falls leer
      if (isOpen) { 
        if (!from.value) from.value = "08:00";
        if (!to.value) to.value = "20:00";
      } else {
        // Optional: Zeiten beim Schlie√üen leeren, um sie nicht zu speichern
        // from.value = ""; to.value = "";
      }
    }
  });

  function collectOpeningHours() {
    const immer = document.getElementById("immerCheck")?.checked;
    if (immer) { return "Immer ge√∂ffnet"; }

    const wrapper = document.getElementById(`openhours-editor`);
    if (!wrapper) return {};
    const result = {};
    let allClosed = true;
    DAY_LABELS.forEach(day => {
      const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
      const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
      const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
      const open = openCheckbox?.checked;
      
      if (open && fromInput.value && toInput.value) {
        allClosed = false;
        result[day.key] = {
          open: true,
          from: fromInput.value,
          to: toInput.value
        };
      } else {
         result[day.key] = { open: false, from: "", to: "" };
      }
    });
    return allClosed ? null : result; // Null, wenn alles geschlossen
  }

  // --- Smarter Photo Upload Logic ---
  window.addPhotoFiles = function(files) {
    editingData.photos = editingData.photos || [];
    for(const file of files) {
      if (editingData.photos.length >= 10) {
        showToast("‚ö†Ô∏è Maximal 10 Fotos erlaubt. Datei: " + file.name + " ignoriert.");
        break;
      }
      if (file instanceof File) {
         editingData.photos.push(file);
      } else {
         // Sollte nur bei initial geladenen URLs passieren
         editingData.photos.push(file);
      }
    }
    showGalleryFromEditingData();
  }

  function showGalleryFromEditingData() {
    const preview = document.getElementById('smartUploadPreview');
    if (!preview) return;
    preview.innerHTML = '';
    (editingData.photos || []).forEach((photo, index) => {
      const url = photo instanceof File ? URL.createObjectURL(photo) : photo.url || photo;
      const fileName = photo.name || (photo.url || 'bild').split('/').pop();
      const item = document.createElement('div');
      item.className = `relative group rounded-xl shadow-md overflow-hidden transition hover:shadow-lg ${photo instanceof File ? 'uploading' : ''}`;
      item.innerHTML = `
        <img src="${url}" class="w-28 h-28 object-cover cursor-pointer" title="${fileName}" />
        <button onclick="removePhoto(${index})" title="Entfernen" 
            class="absolute top-1 right-1 p-1 bg-red-600 text-white rounded-full text-xs opacity-80 hover:opacity-100 transition shadow">‚úï</button>
      `;
      preview.appendChild(item);
    });
    // Platzhalter f√ºr leere Galerie
    if ((editingData.photos || []).length === 0) {
      preview.innerHTML = `<p class="text-sm text-gray-400 p-4 border rounded-lg bg-gray-50 w-full text-center">Noch keine Fotos ausgew√§hlt.</p>`;
    }
  }

  window.removePhoto = function(index) {
    if (editingData.photos && editingData.photos[index]) {
      const photo = editingData.photos[index];
      if (photo instanceof File) URL.revokeObjectURL(photo);
      editingData.photos.splice(index, 1);
      showGalleryFromEditingData();
      showToast("Foto entfernt", 1500);
    }
  }
  
  // --- Enhanced Editor Init ---
  function initEnhancedEditor(containerId, data) {
    if (quillEditor) quillEditor.destroy(); 
    quillEditor = new Quill(`#${containerId}`, {
      theme: 'snow',
      placeholder: 'Eine ausf√ºhrliche Beschreibung deines Angebots...',
      modules: { toolbar: [['bold', 'italic', 'link'], [{ 'list': 'bullet' }, { 'list': 'ordered' }]] }
    });
    if (data.beschreibung) {
        quillEditor.root.innerHTML = data.beschreibung;
    }
    quillEditor.on('text-change', () => {
      editingData.beschreibung = quillEditor.root.innerHTML;
    });
    // Setze den initialen Wert (wichtig f√ºr leere Editoren)
    editingData.beschreibung = editingData.beschreibung || quillEditor.root.innerHTML;
  }

  // --- Step Renderer ---
  window.renderQuestion = function() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
    document.getElementById("prevBtn").disabled = (step === 0);

    // Hilfsfunktion zum Erstellen des Wrappers
    const createWrapper = (content) => `<div class="bg-white p-6 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">${content}</div>`;

    if (step === 0) { // Datenschutzerkl√§rung
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üõ°Ô∏è 1. Zustimmung zur Datenschutzerkl√§rung</h2>
        <div id="dsScrollBox" class="h-60 mb-4 rounded-xl overflow-y-scroll border-2 border-gray-200">
          <iframe src="https://radlmap.net/datenschutz.html" class="w-full h-[500px] border-0 bg-white" title="Datenschutz"></iframe>
        </div>
        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
          <input id="dsCheck" type="checkbox" class="w-5 h-5 text-green-600" ${editingData.datenschutz ? "checked" : ""} disabled />
          Ich akzeptiere die Datenschutzerkl√§rung und habe sie vollst√§ndig gelesen.
        </label>
        <div id="dsHint" class="text-xs text-red-500 mt-2">‚¨áÔ∏è Bitte scrolle bis zum Ende der Erkl√§rung, um die Checkbox zu aktivieren.</div>
      `);
      const scrollBox = document.getElementById("dsScrollBox");
      const check = document.getElementById("dsCheck");
      const hint = document.getElementById("dsHint");
      scrollBox.addEventListener("scroll", () => {
        if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
          check.disabled = false;
          hint.textContent = "‚úÖ Du kannst nun die Datenschutzerkl√§rung akzeptieren.";
          hint.classList.remove("text-red-500");
          hint.classList.add("text-green-600");
        }
      });
      return;
    }
    if (step === 1) { // Typ-Auswahl
      const opts = [
        { emoji: 'ü•ö', label: 'Eierh√ºtte', key: 'Eierh√ºtte' }, { emoji: 'üè™', label: 'Hofladen', key: 'Hofladen' },
        { emoji: 'üè†', label: 'Selbstbedienungsh√§uschen', key: 'Selbstbedienung' }, { emoji: 'üõù', label: 'Spielplatz', key: 'Spielplatz' },
        { emoji: 'üåÑ', label: 'Abenteuerhof', key: 'Abenteuerhof' }, { emoji: 'üç∂', label: 'Automat', key: 'Automat' }
      ];
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üìå 2. Art der Eintragung</h2>
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
          ${opts.map(o => `<button class="bg-gray-50 border-2 border-gray-200 p-6 rounded-xl shadow-sm card-option text-center cursor-pointer ${editingData.typ === o.key ? 'selected' : ''}" 
            onclick="selectOption('typ','${o.key}',this)">
            <div class="text-4xl mb-2">${o.emoji}</div><div class="font-semibold text-gray-700">${o.label}</div>
          </button>`).join('')}
        </div>
      `);
      return;
    }
    if (step === 2) { // Name
      const { title, question } = typeTexts[editingData.typ] || { title: "üè∑Ô∏è Name", question: "Wie soll dein Eintrag hei√üen?" };
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üè∑Ô∏è 3. ${title}</h2>
        <p class="text-sm text-gray-600 mb-4">${question}</p>
        <input id="nameInput" class="w-full border-2 border-gray-300 p-3 rounded-lg focus:border-green-500 focus:ring focus:ring-green-500/20 transition" placeholder="Namen eingeben (z.B. Eierh√ºtte am Dorfplatz)" value="${editingData.name || ''}">
      `);
      return;
    }
    if (step === 3) { // Sitzpl√§tze
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">ü™ë 4. Sitzpl√§tze vorhanden?</h2>
        <div class="flex gap-4">
          <button class="flex-1 p-4 border-2 border-gray-200 rounded-xl ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">‚úÖ Ja, es gibt Sitzgelegenheiten</button>
          <button class="flex-1 p-4 border-2 border-gray-200 rounded-xl ${editingData.sitzplaetze === 'Nein' || !editingData.sitzplaetze ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">‚ùå Nein, keine Sitzpl√§tze</button>
        </div>
      `);
      return;
    }
    if (step === 4) { // Strom
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üîå 5. Ladem√∂glichkeit f√ºr E-Bikes/Handys (Strom)?</h2>
        <div class="flex gap-4">
          <button class="flex-1 p-4 border-2 border-gray-200 rounded-xl ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">‚ö° Ja, Strom ist verf√ºgbar</button>
          <button class="flex-1 p-4 border-2 border-gray-200 rounded-xl ${editingData.strom === 'Nein' || !editingData.strom ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">‚ùå Nein, kein Strom</button>
        </div>
      `);
      return;
    }
    if (step === 5) { // √ñffnungszeiten (SMART Editor)
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üïí 6. √ñffnungszeiten (Wochenplan)</h2>
        ${renderOpeningHoursEditor(editingData.oeffnungszeiten)}
      `);
      return;
    }
    if (step === 6) { // Extras
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">‚ú® 7. Extras / Zus√§tzliches Angebot (optional)</h2>
        <textarea id="extrasInput" rows="3" class="w-full border-2 border-gray-300 p-3 rounded-lg focus:border-green-500 focus:ring focus:ring-green-500/20 transition" placeholder="z.B. Kalte Getr√§nke, Kaffee-Maschine, Grillm√∂glichkeiten, WC-Nutzung (Komma getrennt)">${editingData.extras || ''}</textarea>
      `);
      return;
    }
    if (step === 7) { // Bilder (NEW SMARTER STEP)
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üì∏ 8. Fotos hochladen (Max. 10)</h2>
        <div id="smartUploadZone" 
             class="border-4 border-dashed border-gray-300 rounded-2xl p-8 text-center text-gray-500 cursor-pointer flex flex-col items-center justify-center transition"
             onclick="document.getElementById('fileInput').click()"
             ondragover="event.preventDefault(); this.style.borderColor='#10b981'; this.style.backgroundColor='#f0fdf4';"
             ondragleave="this.style.borderColor='#d1d5db'; this.style.backgroundColor=''; "
             ondrop="event.preventDefault(); this.style.borderColor='#d1d5db'; this.style.backgroundColor=''; addPhotoFiles(event.dataTransfer.files);">
          <svg class="w-10 h-10 mb-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
          <p class="font-semibold text-lg mb-1 text-gray-700">Dateien hierher ziehen oder klicken zum Hochladen</p>
          <p class="text-sm">JPEG oder PNG. Max. 10 Bilder. Gute Fotos sind entscheidend!</p>
          <input type="file" id="fileInput" multiple accept="image/jpeg,image/png" class="hidden" onchange="addPhotoFiles(this.files)">
        </div>
        <div id="smartUploadPreview" class="mt-6 flex flex-wrap gap-3">
          </div>
      `);
      showGalleryFromEditingData(); 
      return;
    }
    if (step === 8) { // Tiere
      const animals = ["üêê Ziege","üêÑ Kuh","üêì Huhn","üêï Hund","üêá Hase","üêà Katze","Keine Tiere"];
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üêæ 9. Welche Tiere gibt es zu sehen?</h2>
        <p class="text-sm text-gray-600 mb-4">W√§hle alle zutreffenden Tiere aus.</p>
        <div id="tiereGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
          ${animals.map(t => {
            const isSel = (editingData.tiere || []).includes(t);
            return `<button type="button" class="p-3 border-2 border-gray-200 rounded-xl text-sm ${isSel ? 'selected' : ''}" data-animal="${t}">${t}</button>`;
          }).join('')}
        </div>
      `);
      // Event Listener f√ºr Tiere
      document.querySelectorAll('#tiereGrid button').forEach(btn => {
        btn.onclick = () => {
          const t = btn.dataset.animal;
          editingData.tiere = editingData.tiere || [];
          if (t === 'Keine Tiere') {
            editingData.tiere = ['Keine Tiere'];
            document.querySelectorAll('#tiereGrid button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            return;
          }
          editingData.tiere = editingData.tiere.filter(x => x !== 'Keine Tiere');
          document.querySelector('button[data-animal="Keine Tiere"]')?.classList.remove('selected');

          const idx = editingData.tiere.indexOf(t);
          if (idx >= 0) {
            editingData.tiere.splice(idx, 1);
            btn.classList.remove('selected');
          } else {
            editingData.tiere.push(t);
            btn.classList.add('selected');
          }
        };
      });
      return;
    }
    if (step === 9) { // Beschreibung (Quill)
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üìù 10. Detaillierte Beschreibung</h2>
        <div id="quillContainer" class="bg-white h-64 border border-gray-200 rounded-xl"></div>
      `);
      setTimeout(() => { initEnhancedEditor("quillContainer", editingData); }, 120);
      return;
    }
    if (step === 10) { // Schlagw√∂rter
      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üè∑Ô∏è 11. Schlagw√∂rter / Tags (Max. 10)</h2>
        <p class="text-sm text-gray-600 mb-4">Gib bis zu 10 n√ºtzliche Begriffe ein, getrennt durch ein Komma.</p>
        <input id="tagsInput" class="w-full border-2 border-gray-300 p-3 rounded-lg focus:border-green-500 focus:ring focus:ring-green-500/20 transition" placeholder="z.B. Fr√ºhst√ºck,Schattig,Milch" value="${(editingData.tags||[]).join(', ')}">
      `);
      return;
    }
    if (step === 11) { // √úbersicht & Standort
      mode = "list"; 
      document.getElementById("navBottom").classList.add("hidden");

      qa.innerHTML = createWrapper(`
        <h2 class="text-xl font-bold mb-4 text-green-700">üìç 12. Standort w√§hlen & Einreichen</h2>

        <h3 class="text-lg font-bold mt-4 mb-2">üìç Standort auf Karte setzen</h3>
        <div class="relative mb-3">
          <input id="addressSearch" class="w-full border p-2 rounded-lg" placeholder="Adresse suchen (z.B. Musterstra√üe 1, 12345 Ort)" onkeyup="searchAddress(this.value)" />
          <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded-lg mt-1 hidden shadow-lg z-10 max-h-48 overflow-y-auto"></div>
        </div>
        <button id="gpsBtn" class="px-3 py-2 mb-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" onclick="locateGPS()">üì° Mein Standort per GPS</button>
        <div id="overview-map" class="minimap mb-4"></div>

        <h3 class="text-lg font-bold mt-4 mb-2">Daten-Check & Fertigstellen</h3>
        <div class="p-3 border border-red-300 bg-red-50 rounded-lg text-sm mb-4">
            <input type="checkbox" id="instantActive" class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
            <label for="instantActive" class="text-sm font-medium text-red-700 ml-2">‚ö†Ô∏è Sofort aktiv setzen (Nur f√ºr Admins/Betreiber: Eintrag wird ohne Pr√ºfung sichtbar)</label>
        </div>

        <div class="flex gap-3 pt-4 border-t">
          <button id="submitBtn" class="flex-1 px-4 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition active:scale-95" onclick="submitEntry()">‚úÖ Eintragung einreichen</button>
          <button class="px-4 py-3 bg-gray-200 text-gray-800 rounded-xl hover:bg-gray-300 transition" onclick="showMyEntries()">‚úñ Abbrechen</button>
        </div>
        <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird nach erfolgreicher Pr√ºfung auf der Karte ver√∂ffentlicht.</p>
      `);
      
      setTimeout(() => {
        // Initialisiere Karte mit gespeicherter oder Fallback-Position
        const lat = editingData.location?.lat || FALLBACK_LOCATION[0];
        const lng = editingData.location?.lng || FALLBACK_LOCATION[1];
        initOverviewMap(lat, lng, editingData.location ? 14 : 6);
      }, 120);
      return;
    }
  }

  // --- Validation and Data Collection ---
  function validateAndCollectStepData(stepToValidate) {
    if (stepToValidate === 0) {
      const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked;
      if (!ok) { showToast('‚ùå Bitte Datenschutzerkl√§rung akzeptieren'); return false; }
      editingData.datenschutz = true;
    } else if (stepToValidate === 1) {
      if (!editingData.typ) { showToast("‚ùå Bitte einen Typ ausw√§hlen."); return false; }
    } else if (stepToValidate === 2) {
      const v = document.getElementById('nameInput')?.value?.trim();
      if (!v || v.length < 3) { showToast('‚ùå Bitte einen aussagekr√§ftigen Namen eingeben (mind. 3 Zeichen).'); return false; }
      editingData.name = v;
    } else if (stepToValidate === 5) {
      const rawOeff = collectOpeningHours();
      if (rawOeff === null) {
          showToast("‚ùå Bitte √ñffnungszeiten angeben oder 'Immer ge√∂ffnet' ausw√§hlen."); return false;
      }
      editingData.oeffnungszeiten = rawOeff;
    } else if (stepToValidate === 7) {
      if ((editingData.photos || []).length === 0) { showToast("‚ùå Bitte mindestens ein Foto hochladen."); return false; }
    } else if (stepToValidate === 9) {
      if (!quillEditor || quillEditor.getLength() < 20) { showToast("‚ùå Bitte eine ausf√ºhrliche Beschreibung eingeben (mind. 20 Zeichen)."); return false; }
      editingData.beschreibung = quillEditor.root.innerHTML;
    } else if (stepToValidate === 10) {
      const raw = document.getElementById('tagsInput')?.value || '';
      editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
      editingData.extras = document.getElementById('extrasInput')?.value?.trim(); // Extras speichern, falls √ºbersprungen
    }
    return true;
  }
  
  /***********************
   * Map, GPS & Location
   ***********************/
  function initOverviewMap(lat, lng, zoom) {
    if (overviewMap) overviewMap.remove(); 
    overviewMap = L.map("overview-map").setView([lat, lng], zoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(overviewMap);

    overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap);
    overviewMarker.on("dragend", ev => {
      const p = ev.target.getLatLng();
      editingData.location = { lat: p.lat, lng: p.lng };
      showToast(`üìç Standort aktualisiert: Lat ${p.lat.toFixed(4)}, Lng ${p.lng.toFixed(4)}`, 1500);
    });

    overviewMap.on("click", (e) => {
        overviewMarker.setLatLng(e.latlng);
        overviewMap.setView(e.latlng, overviewMap.getZoom() < 14 ? 14 : overviewMap.getZoom());
        editingData.location = { lat: e.latlng.lat, lng: e.latlng.lng };
        showToast(`üìç Standort gesetzt`, 1500);
    });

    editingData.location = editingData.location || { lat, lng };
  }

  window.locateGPS = function() {
    if (!navigator.geolocation) return showToast("‚ùå GPS nicht verf√ºgbar");
    showToast("Suche Standort...", 1000);
    navigator.geolocation.getCurrentPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        initOverviewMap(latitude, longitude, 15);
        showToast("üìç Standort gefunden!", 1500);
      },
      err => { showToast("‚ùå GPS-Fehler: " + err.message); }
    );
  }

  window.searchAddress = async function(query) {
    const suggestionsEl = document.getElementById("addressSuggestions");
    if (query.length < 4) { suggestionsEl.classList.add('hidden'); return; }
    
    // Nominatim API Call (Public, rate limit beachten!)
    try {
      const res = await fetch(`${NOMINATIM_SEARCH_URL}${encodeURIComponent(query)}&limit=5`);
      const json = await res.json();
      
      suggestionsEl.innerHTML = '';
      if (json.length > 0) {
        json.forEach(item => {
          const div = document.createElement('div');
          div.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b text-sm';
          div.textContent = item.display_name;
          div.onclick = () => {
            document.getElementById('addressSearch').value = item.display_name;
            const latlng = [parseFloat(item.lat), parseFloat(item.lon)];
            initOverviewMap(latlng[0], latlng[1], 15);
            suggestionsEl.classList.add('hidden');
          };
          suggestionsEl.appendChild(div);
        });
        suggestionsEl.classList.remove('hidden');
      } else {
        suggestionsEl.innerHTML = '<div class="p-3 text-sm text-gray-500">Keine Ergebnisse gefunden.</div>';
        suggestionsEl.classList.remove('hidden');
      }
    } catch(e) {
      console.error("Address search error", e);
      suggestionsEl.innerHTML = '<div class="p-3 text-sm text-red-500">Fehler bei der Suche.</div>';
      suggestionsEl.classList.remove('hidden');
    }
  }

  /***********************
   * Submission & Storage
   ***********************/
  async function uploadFileWithProgress(file) {
    if (typeof file === 'string' || (typeof file === 'object' && file.url)) return file; // Ist bereits eine URL oder ein URL-Objekt

    showToast(`üì§ Lade Foto ${file.name} hoch...`);
    const storageRef = storage.ref(`uploads/${currentUser.uid}/${Date.now()}_${file.name}`);
    const snapshot = await storageRef.put(file);
    const url = await snapshot.ref.getDownloadURL();
    return { url, name: file.name, size: file.size };
  }

  window.submitEntry = async function() {
    if (!validateAndCollectStepData(10) || !editingData.location) { 
      showToast("‚ùå Bitte Standort und alle vorherigen Schritte abschlie√üen."); 
      return; 
    }
    
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = "‚è≥ Eintr√§ge werden hochgeladen...";

    // 1. Fotos hochladen
    let finalPhotoUrls = [];
    try {
      for (const photo of (editingData.photos || [])) {
        const uploadedPhoto = await uploadFileWithProgress(photo);
        finalPhotoUrls.push(uploadedPhoto);
      }
      editingData.photos = finalPhotoUrls;
    } catch(err){ 
      console.error("Foto-Upload Fehler", err); 
      showToast("‚ùå Fehler beim Foto-Upload: Bitte versuche es erneut.");
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtn').textContent = "‚úÖ Eintragung einreichen";
      return; 
    }

    // 2. Payload erstellen
    const payload = {
      userId: currentUser.uid,
      name: editingData.name,
      typ: editingData.typ,
      sitzplaetze: editingData.sitzplaetze || 'Nein',
      strom: editingData.strom || 'Nein',
      extras: editingData.extras || '',
      tiere: editingData.tiere || [],
      beschreibung: editingData.beschreibung || '',
      tags: editingData.tags || [],
      oeffnungszeiten: editingData.oeffnungszeiten,
      fotos: editingData.photos || [], 
      active: false, // Standard: Muss erst gepr√ºft werden
      status: 'offen', 
      erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
      location: new firebase.firestore.GeoPoint(editingData.location.lat, editingData.location.lng),
      datenschutzZustimmung: { bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(), durch: currentUser.email }
    };

    // 3. Admin/Instant Feature pr√ºfen
    const instant = document.getElementById('instantActive')?.checked;
    if (instant) {
      payload.status = 'angenommen';
      payload.active = true;
      payload.pruefung = 'automatisch_aktiviert';
      showToast("‚ú® Eintrag wird sofort aktiv gesetzt...", 1500);
    } else {
      showToast("üéâ Eintrag erfolgreich eingereicht! Er wird nun gepr√ºft.", 3000);
    }

    // 4. In Firestore speichern
    try {
      await db.collection('eierhuetten').add(payload);
      
      editingData = {}; // Zustand zur√ºcksetzen
      showMyEntries();
    } catch (err) {
      console.error('submitEntry error', err);
      showToast('‚ùå Fehler beim Speichern: ' + (err.message || "Unbekannt"));
    } finally {
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtn').textContent = "‚úÖ Eintragung einreichen";
    }
  }

  /***********************
   * Dashboard & Listings (Komplett ausgebaute Stubs)
   ***********************/
  window.showTutorial = function() {
    const qa = document.getElementById("question-area"); mode = "tutorial"; setActive('');
    qa.innerHTML = `<section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">
      <h1 class="text-3xl font-extrabold text-green-700 mb-4">Willkommen im Smarter Assistent v3!</h1>
      <p class="text-gray-600 mb-6">Mit diesem Assistenten kannst du neue Eintragungen f√ºr Hofl√§den, Eierh√ºtten oder andere RadlMap-Punkte schnell und einfach anlegen und deine bestehenden Eintr√§ge verwalten.</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 bg-green-50 rounded-xl border border-green-200">
          <h3 class="font-bold text-lg text-green-700 mb-2">‚ûï Neue Eintragung starten</h3>
          <p class="text-sm text-gray-700">Starte den 12-Schritte-Assistenten. Du wirst durch alle notwendigen Informationen gef√ºhrt.</p>
          <button onclick="startNewEntry()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">Jetzt starten</button>
        </div>
        <div class="p-4 bg-gray-50 rounded-xl border">
          <h3 class="font-bold text-lg mb-2">üìã Bestehende Eintr√§ge</h3>
          <p class="text-sm text-gray-700">Verwalte deine aktiven, in Pr√ºfung befindlichen oder abgelehnten Eintragungen.</p>
          <button onclick="showMyEntries()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">Zur √úbersicht</button>
        </div>
      </div>

      <h3 class="font-bold text-xl text-green-700 mt-8 mb-4">Neuerungen in v3:</h3>
      <ul class="list-disc list-inside space-y-2 text-gray-600">
        <li>**Smarter √ñffnungszeiten-Editor:** Einfache Eingabe der Wochenzeiten.</li>
        <li>**Dedizierter Foto-Upload:** Bis zu 10 Bilder mit Drag-and-Drop.</li>
        <li>**WYSIWYG Beschreibung:** Verbesserte Textformatierung dank Quill-Editor.</li>
        <li>**Vollst√§ndige mobile Optimierung.**</li>
      </ul>
    </section>`;
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }

  window.showDashboard = function() {
    const qa = document.getElementById("question-area"); mode = "dashboard";
    setActive('btnDashboard');
    qa.innerHTML = `<section class="max-w-6xl mx-auto animate-fadeIn">
      <h2 class="text-3xl font-extrabold mb-6 text-green-700">üìä Betreiber-Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <p class="text-sm text-gray-500">Aktive Eintr√§ge</p>
          <p id="dashboardActive" class="text-4xl font-bold text-green-600 mt-1">3</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <p class="text-sm text-gray-500">Nachrichten Ungelesen</p>
          <p id="dashboardMessages" class="text-4xl font-bold text-red-600 mt-1">7</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <p class="text-sm text-gray-500">Letzte Freigabe</p>
          <p id="dashboardLast" class="text-xl font-bold text-gray-700 mt-2">Vor 3 Tagen</p>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="font-bold text-xl mb-4">Statistik (Platzhalter)</h3>
        <div style="height: 350px;"><canvas id="myChart"></canvas></div>
      </div>
    </section>`;
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");

    // Chart.js Initialisierung
    setTimeout(() => {
        if (dashboardChart) dashboardChart.destroy();
        const ctx = document.getElementById('myChart').getContext('2d');
        dashboardChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Neue Nachrichten',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: 'rgba(16, 185, 129, 0.8)', // green-500
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }, 200);
  }

  window.showMyEntries = async function() {
    if (!currentUser) { showToast("Bitte zuerst einloggen"); return; }
    const container = document.getElementById("question-area");
    mode = "list"; setActive('btnEntries');
    
    container.innerHTML = `<section class="max-w-6xl mx-auto animate-fadeIn">
      <h2 class="text-3xl font-extrabold mb-6 text-green-700">üìã Meine Eintragungen</h2>
      <div id="entriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full text-gray-500 p-4 rounded-xl bg-white shadow">
          <div class="flex items-center gap-3">
            <svg class="animate-spin h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p>Lade Eintragungen von Firebase...</p>
          </div>
        </div>
      </div>
    </section>`;
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");

    const grid = document.getElementById("entriesGrid");
    
    // Echte Firebase-Lade-Logik (als Stub)
    try {
        const snap = await db.collection("eierhuetten").where("userId", "==", currentUser.uid).orderBy("erstelltAm", "desc").get();
        if (snap.empty) {
            grid.innerHTML = `<div class="col-span-full p-6 text-center bg-white rounded-xl shadow border border-dashed border-gray-300">
                <p class="text-lg font-semibold mb-2">Keine eigenen Eintr√§ge gefunden.</p>
                <p class="text-gray-500">Starte jetzt eine <button onclick="startNewEntry()" class="text-green-600 font-medium hover:underline">Neue Eintragung</button>.</p>
            </div>`;
            return;
        }

        grid.innerHTML = snap.docs.map(doc => {
            const data = doc.data();
            const statusColor = data.status === 'angenommen' ? 'bg-green-100 text-green-800' : 
                                data.status === 'offen' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
            const statusText = data.status === 'angenommen' ? 'Aktiv / Angenommen' : 
                               data.status === 'offen' ? 'In Pr√ºfung' : 'Abgelehnt';
            const date = data.erstelltAm ? new Date(data.erstelltAm.toDate()).toLocaleDateString() : 'Datum unbekannt';
            
            return `<div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-green-500 flex flex-col justify-between h-full">
                <div>
                    <span class="text-xl font-bold block mb-1 truncate">${data.name || 'Ohne Namen'}</span>
                    <span class="text-sm ${statusColor} px-2 py-0.5 rounded-full font-medium">${statusText}</span>
                    <p class="text-xs text-gray-400 mt-2">Typ: ${data.typ || 'Unbekannt'} | Erstellt: ${date}</p>
                    <p class="text-gray-600 mt-3 text-sm line-clamp-3">${data.beschreibung ? data.beschreibung.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : 'Keine Beschreibung vorhanden.'}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100 flex gap-2">
                    <button class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition">Details / Bearbeiten</button>
                    <button class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition">L√∂schen</button>
                </div>
            </div>`;
        }).join('');
    } catch(e) {
        console.error("Firebase entries fetch error", e);
        grid.innerHTML = `<div class="col-span-full p-6 text-red-700 bg-red-100 rounded-xl shadow">
            ‚ùå Fehler beim Laden der Eintr√§ge: ${e.message}
        </div>`;
    }
  }

  window.openSupport = function() {
    const qa = document.getElementById("question-area"); mode = "support";
    setActive('btnSupport');
    qa.innerHTML = `<section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4 text-green-700">üí¨ Support & Hilfe</h2>
      <p class="text-gray-600 mb-6">F√ºlle das Formular aus, um uns zu kontaktieren. Wir werden uns so schnell wie m√∂glich bei dir melden.</p>
      
      <div class="space-y-4">
        <input type="text" placeholder="Dein Name" value="${currentUser.displayName || ''}" class="w-full border p-3 rounded-lg">
        <input type="email" placeholder="Deine E-Mail" value="${currentUser.email || ''}" class="w-full border p-3 rounded-lg" disabled>
        <textarea rows="5" placeholder="Deine Nachricht / Problembeschreibung" class="w-full border p-3 rounded-lg"></textarea>
        <button class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition">Nachricht senden</button>
      </div>
    </section>`;
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }

  window.showHutMessages = function() {
    const qa = document.getElementById("question-area"); mode = "hutMessages";
    setActive('btnHutMessages');
    qa.innerHTML = `<section class="max-w-4xl mx-auto animate-fadeIn">
      <h2 class="text-3xl font-extrabold mb-6 text-green-700">üíå H√ºtten-Nachrichten</h2>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <p class="text-lg font-semibold mb-4">Posteingang (Platzhalter)</p>
        <div class="space-y-3">
            <div class="p-3 bg-red-50 border-l-4 border-red-500 rounded-lg">
                <p class="font-semibold">‚ùóÔ∏è Neue Nachricht von Max Mustermann</p>
                <p class="text-sm text-gray-600">Betreff: Fehlende Eier, Datum: 21.10.2025</p>
            </div>
            <div class="p-3 bg-gray-50 border-l-4 border-gray-300 rounded-lg">
                <p class="font-semibold">‚úÖ Gelesene Nachricht von Lisa Schmidt</p>
                <p class="text-sm text-gray-600">Betreff: Lob und Gru√ü, Datum: 15.10.2025</p>
            </div>
        </div>
      </div>
    </section>`;
    updateInfoBox();
    document.getElementById("navBottom").classList.add("hidden");
  }
  
  // Stubs f√ºr Events
  window.showMyEvents = () => { showToast("Events-Funktion noch nicht implementiert."); setActive('btnMyEvents'); };
  window.showCreateEvent = () => { showToast("Event erstellen noch nicht implementiert."); setActive('btnCreateEvent'); };
  
  // Stubs f√ºr Badge Logik
  window.initHutMessagesBadge = async () => { 
    // Echte Logik w√ºrde hier auf Firestore lauschen und das Badge aktualisieren
    try {
        const count = 7; // Mock-Wert
        const badge = document.getElementById('hutMessagesCount');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    } catch(e) { /* silent fail */ }
  };
  
  // Funktion zum Aktualisieren der Info-Box
  window.updateInfoBox = function() {
    const boxDesktop = document.getElementById("infoBox");
    let html = "";
    if (mode === "entry") {
      const info = stepInfos[step];
      html = `<h4 class="font-bold text-lg text-green-800 mb-2">Schritt ${step + 1}: ${info.title}</h4><p class="text-gray-700">${info.text}</p>`;
    } else if (mode === "list") { html = `<h4 class="font-bold text-lg text-green-800 mb-2">üìã √úbersicht</h4><p>Verwalte deine bestehenden Eintr√§ge. Du kannst sie bearbeiten, l√∂schen oder den Status einsehen.</p>`; }
    else if (mode === "dashboard") { html = `<h4 class="font-bold text-lg text-green-800 mb-2">üìä Dashboard</h4><p>Erhalte einen schnellen √úberblick √ºber die Performance deiner Eintr√§ge, ungelesene Nachrichten und Statistiken.</p>`; }
    else if (mode === "support") { html = `<h4 class="font-bold text-lg text-green-800 mb-2">üí¨ Support</h4><p>Hast du Fragen oder Probleme? Nutze dieses Formular, um uns direkt zu erreichen.</p>`; }
    else if (mode === "tutorial") { html = `<h4 class="font-bold text-lg text-green-800 mb-2">üåø Startbildschirm</h4><p>W√§hle eine Aktion in der linken Navigation.</p>`; }
    else { html = `<p>‚ÑπÔ∏è W√§hle links eine Funktion aus.</p>`; }

    if (boxDesktop) boxDesktop.innerHTML = html;
  }

  // Start the application only if not already authenticated (handled by onAuthStateChanged)
  if (!currentUser && document.getElementById("loginScreen").classList.contains("hidden")) {
    document.getElementById("loginScreen").classList.remove("hidden");
  }

})();
</script>
</body>
</html>
