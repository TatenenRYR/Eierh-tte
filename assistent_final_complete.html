<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistent</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card-option { transition: transform .16s, box-shadow .16s; }
    .card-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .selected { border: 2px solid #10b981; background-color: #ecfdf5; }
    .minimap {
  height: 200px;
  z-index: 0;
}
.leaflet-container {
  z-index: 0 !important;
}
    /* Small helper for fixed bottom nav on small screens */
    @media (max-width: 767px) {
      #question-area { padding-bottom: 92px; } /* space for fixed nav */
    }
    @media (min-width: 768px) {
      #question-area { padding-bottom: 92px; }
    }
    .sidebar-btn.active {
  background-color: #e8f8ee;
  color: #166534;
  font-weight: 600;
    }
    
/* === Smarter Upload Style === */
#smartUploadZone {
  transition: all 0.25s ease;
}
#smartUploadZone:hover {
  background-color: #ecfdf5;
  border-color: #10b981;
  transform: scale(1.01);
}
#smartUploadPreview img {
  transition: all 0.25s ease;
}
#smartUploadPreview img:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}
@keyframes pulseUpload {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
.uploading::after {
  content: "â«";
  position: absolute;
  top: 4px; right: 4px;
  font-size: 0.8rem;
  animation: pulseUpload 1s infinite;
  color: #16a34a;
}
.photo-preview {
  position: relative;
  overflow: hidden;
  cursor: grab;
}
.photo-preview-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0,0,0,0.5);
  color: white;
  opacity: 0;
  transition: opacity 0.2s;
}
.photo-preview:hover .photo-preview-overlay {
  opacity: 1;
}
.photo-preview-overlay button {
  padding: 0.5rem;
  border-radius: 50%;
  background-color: rgba(255,255,255,0.2);
  margin: 0 0.5rem;
}

  </style>
</head>
<body class="bg-gray-100">
<script>window.stepInfos = window.stepInfos || [];</script>

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-green-50 to-green-100 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-10 max-w-md w-full text-center transform transition hover:scale-[1.01]">
    
    <div class="flex justify-center mb-6">
      <img src="https://radlmap.net/img/login.png" 
           class="w-64 h-64 drop-shadow-lg" 
           alt="Funny Hut" />
    </div>

    <h1 class="text-3xl font-extrabold text-green-700 mb-3">
      Assistent-Dashboard
    </h1>
    <p class="text-gray-500 mb-8">
      Verwalte deine <span class="font-semibold text-green-600">Eintragungen</span> ganz einfach online.<br>
      Bitte melde dich mit deinem Google-Konto an.
    </p>

    <button onclick="doGoogleLogin()" 
      class="flex items-center gap-3 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow-md transition w-full justify-center font-medium">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" 
           class="w-6 h-6 bg-white rounded-full p-1" />
      <span>Mit Google anmelden</span>
    </button>

    <p class="text-xs text-gray-400 mt-6">
      ğŸ”’ Deine Daten bleiben sicher und werden nicht ohne Zustimmung geteilt.
    </p>
  </div>
</div>


  <div id="mainApp" class="flex min-h-screen hidden">

    
<aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-64 bg-white border-r p-6 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform z-50 shadow-lg">

  <div class="flex flex-col items-center mb-8">
    <div id="avatarWrapper" class="w-20 h-20 rounded-full overflow-hidden border-2 border-green-500 mb-3 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-2xl font-bold shadow-md">
      <img id="profilePic" src="" alt="Profilbild" class="w-full h-full object-cover hidden">
      <span id="avatarInitials"></span>
    </div>
    <p class="text-sm text-gray-600">Angemeldet als:</p>
    <p id="accountMail" class="text-green-700 font-semibold truncate max-w-[180px] text-center">-</p>
    <button class="mt-3 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 active:scale-95 transition transform" onclick="logout()">Logout</button>
  </div>

  <div class="text-2xl font-extrabold text-green-700 mb-6 text-center tracking-tight">
    ğŸŒ¿ Assistent
  </div>

  <nav class="flex flex-col gap-2 text-[15px]">
    <a href="https://radlmap.net" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      ğŸš² Startseite
    </a>
    <a href="navi.html" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition">
      ğŸš´â€â™‚ï¸ zur RadlMap
    </a>

    <button id="btnDashboard" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnDashboard'); showDashboard()">
      ğŸ“Š Betreiber-Dashboard
    </button>
    <button id="btnEntries" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnEntries'); showMyEntries()">
      ğŸ“‹ Meine Eintragungen
    </button>
    <button id="btnNewEntry" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnNewEntry'); startNewEntry()">
      â• Neue Eintragung
    </button>

    <div class="mt-4">
      <div class="flex items-center justify-between px-3 mb-1">
        <p class="text-xs uppercase font-semibold text-gray-400 tracking-wider">Events</p>
        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">neu</span>
      </div>

      <div class="ml-2 border-l-2 border-green-100 pl-3 flex flex-col gap-1">
        <button id="btnMyEvents"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnMyEvents'); showMyEvents(firebase.auth().currentUser)">
          ğŸ“… <span>Meine Events</span>
        </button>
        <button id="btnCreateEvent"
          class="sidebar-btn px-3 py-1.5 rounded-lg hover:bg-green-50 flex items-center gap-2 text-sm transition"
          onclick="setActive('btnCreateEvent'); showCreateEvent(firebase.auth().currentUser)">
          â• <span>Neues Event</span>
        </button>
      </div>
    </div>

    <hr class="my-3 border-gray-200">

    <button id="btnSupport" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition" onclick="setActive('btnSupport'); openSupport()">
      ğŸ’¬ Support
    </button>
    <button id="btnHutMessages" class="sidebar-btn px-4 py-2 rounded-lg hover:bg-green-50 flex items-center gap-2 transition relative" onclick="setActive('btnHutMessages'); showHutMessages()">
      ğŸ’Œ HÃ¼tten-Nachrichten
      <span id="hutMessagesCount" class="absolute right-4 hidden bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
    </button>
  </nav>

  <div class="mt-auto text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
    v2.1 &middot; RadlMap Assistent
  </div>
</aside>
    <div id="infoSidebar" class="hidden lg:block w-72 p-4 bg-gray-50 border-l">
  <div class="sticky top-4">
    <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
    <div id="infoBox" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<div id="infoOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="absolute bottom-0 w-full bg-white p-4 rounded-t-2xl shadow-lg max-h-[80vh] overflow-y-auto">
    <button id="closeInfo" class="absolute top-2 right-2 text-gray-600">âœ•</button>
    <h3 class="text-lg font-bold mb-3">â„¹ï¸ Hilfe & Beispiele</h3>
    <div id="infoBoxMobile" class="space-y-3 text-sm text-gray-700"></div>
  </div>
</div>

<button id="toggleInfo" class="lg:hidden fixed bottom-20 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg" onclick="document.getElementById('infoOverlay').classList.remove('hidden')">
  â„¹ï¸
</button>
<script>
  document.getElementById('closeInfo')?.addEventListener('click', () => {
    document.getElementById('infoOverlay').classList.add('hidden');
  });
</script>

<script>
  // Entfernt vorherige aktive Buttons und markiert den aktuellen
  function setActive(buttonId) {
    const buttons = document.querySelectorAll('.sidebar-btn');
    buttons.forEach(btn => btn.classList.remove('bg-green-100', 'font-semibold'));
    const activeBtn = document.getElementById(buttonId);
    if(activeBtn) {
      activeBtn.classList.add('bg-green-100', 'font-semibold');
    }
  }
</script>

    <main class="flex-1 flex flex-col">
      <div class="md:hidden flex items-center justify-between bg-white border-b p-3">
        <div class="font-bold text-green-700">Assistent</div>
        <button class="p-2 bg-green-600 text-white rounded" onclick="toggleSidebar()">â˜°</button>
      </div>

      <div class="w-full h-2 bg-gray-200">
        <div id="progress" class="h-2 bg-green-500 w-0 transition-all"></div>
      </div>

      <section id="question-area" class="flex-1 p-6 overflow-y-auto">
        </section>

      <div id="navBottom" class="fixed bottom-0 left-0 md:left-64 right-0 flex justify-between p-4 border-t bg-white z-40">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded" onclick="prevStep()">â¬…ï¸ ZurÃ¼ck</button>
        <button id="nextBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="nextStep()">Weiter â¡ï¸</button>
      </div>
    </main>
  </div>

  <div id="toast" class="fixed top-6 right-6 hidden p-3 rounded shadow bg-blue-600 text-white z-50"></div>

  <script>
  /***********************
   * Config & Init
   ***********************/
  // Firebase config (aus deinem Admin-File)
  const firebaseConfig = {
    apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
    authDomain: "eierhuettentour.firebaseapp.com",
    projectId: "eierhuettentour",
    storageBucket: "eierhuettentour.appspot.com",
    messagingSenderId: "348272135205",
    appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc"
  };

  // imgbb API key (wie in Admin-Code verwendet)
  const IMGBB_KEY = "5df04de9bfd2776f101329be4193e44c";

  // Init firebase
    
  let app, db;
  try {
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
  } catch (e) {
    console.error("Firebase init error", e);
    document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">âŒ Firebase konnte nicht initialisiert werden. PrÃ¼fe die Konfiguration in der Datei.</div>`;
  }

  // Demo user: in deinem Produktivbetrieb sollte hier auth.onAuthStateChanged triggern
  let currentUser = { uid: "demo", email: "demo@example.com", displayName: "Demo" };
firebase.auth().onAuthStateChanged(u => {
  if (u) {
    currentUser = u;
    document.getElementById("accountMail").textContent = u.email;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainApp").classList.remove("hidden");

    // Sidebar geschlossen halten
    document.getElementById('sidebar').classList.add('-translate-x-full');

    mode = "list";
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
    
    // Tutorial-Startseite zeigen
    showTutorial();
initHutMessagesBadge();
  } else {
    // nicht eingeloggt
    document.getElementById("mainApp").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("question-area").innerHTML = "";
  }
});
    async function doGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await firebase.auth().signInWithPopup(provider);
    showToast("âœ… Eingeloggt mit Google");
    
  } catch (e) {
    console.error("Google Login error", e);
    alert("Fehler beim Google-Login: " + e.message);
  }
    }

function logout() {
  firebase.auth().signOut();
}
    let mode = "entry"; // "entry" oder "list"
  /***********************
   * State & steps
   ***********************/
  let editingData = { photos: [] }; // Initialisiere photos
  let step = 0;
  const stepsCount = 12; // 0..11 (12 Schritte)
  

  function showToast(text, time = 3000) {
    const t = document.getElementById('toast');
    t.textContent = text;
    t.classList.remove('hidden');
    setTimeout(()=>{ t.classList.add('hidden'); }, time);
  }

  function updateProgress() {
    const pct = (step / (stepsCount - 1)) * 100;
    document.getElementById('progress').style.width = pct + '%';
  }
    // ==========================================================
// ğŸ•’ Ã–ffnungszeiten Editor (RadlMap-Style)
// ==========================================================

// helper for localized day names
const DAY_LABELS = [
  { key: "mo", label: "Montag" },
  { key: "di", label: "Dienstag" },
  { key: "mi", label: "Mittwoch" },
  { key: "do", label: "Donnerstag" },
  { key: "fr", label: "Freitag" },
  { key: "sa", label: "Samstag" },
  { key: "so", label: "Sonntag" }
];

// Rendering des Editors
function renderOpeningHoursEditor(hutId, data = {}) {
  // data kann "Immer geÃ¶ffnet" sein oder ein Array/Objekt
  let initialData = {};
  let immerGeoffnet = false;
  
  if (typeof data === "string" && data.includes("Immer geÃ¶ffnet")) {
    immerGeoffnet = true;
  } else if (Array.isArray(data)) {
    // Array [{tag: 'mo', von: '08:00', bis: '18:00'}, ...] in ein SchlÃ¼ssel-Objekt umwandeln
    data.forEach(d => {
      initialData[d.tag] = { open: true, from: d.von, to: d.bis };
    });
  } else if (typeof data === "object") {
    initialData = data;
  }
  
  let html = `
    <div id="openhours-${hutId}" class="space-y-2 mt-2">
      <label class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="immerCheck" ${immerGeoffnet ? "checked" : ""}>
        Immer geÃ¶ffnet
      </label>

      <div id="dayInputs" class="${immerGeoffnet ? "hidden" : ""}">
        <table class="w-full text-sm border border-gray-200 rounded overflow-hidden">
          <thead class="bg-green-100 text-green-800">
            <tr>
              <th class="py-2 px-3 text-left">Tag</th>
              <th class="py-2 px-3 text-center">GeÃ¶ffnet</th>
              <th class="py-2 px-3 text-center">Von</th>
              <th class="py-2 px-3 text-center">Bis</th>
            </tr>
          </thead>
          <tbody class="divide-y">
    `;

  DAY_LABELS.forEach(day => {
    const d = initialData[day.key] || {};
    const open = !!d.open;
    const from = d.from || "";
    const to = d.to || "";
    html += `
        <tr>
          <td class="py-2 px-3">${day.label}</td>
          <td class="text-center">
            <input type="checkbox" class="oh-open" data-day="${day.key}" ${open ? "checked" : ""}/>
          </td>
          <td class="text-center">
            <input type="time" class="oh-from border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${from}" ${!open ? "disabled" : ""}/>
          </td>
          <td class="text-center">
            <input type="time" class="oh-to border rounded px-2 py-1 text-sm" data-day="${day.key}" value="${to}" ${!open ? "disabled" : ""}/>
          </td>
        </tr>
    `;
  });

  html += `
          </tbody>
        </table>
      </div>
      <p class="text-xs text-gray-500">Tipp: Wenn du nichts eintrÃ¤gst, wird "geschlossen" angezeigt.</p>
    </div>
  `;
  return html;
}

// Daten auslesen (fÃ¼r den robusten Editor)
function collectOpeningHours() {
  const immer = document.getElementById("immerCheck")?.checked;
  if (immer) { return "Immer geÃ¶ffnet"; }
  
  const wrapper = document.getElementById(`openhours-editor-wrapper`);
  if (!wrapper) return [];

  const result = [];
  DAY_LABELS.forEach(day => {
    const openCheckbox = wrapper.querySelector(`.oh-open[data-day="${day.key}"]`);
    const fromInput = wrapper.querySelector(`.oh-from[data-day="${day.key}"]`);
    const toInput = wrapper.querySelector(`.oh-to[data-day="${day.key}"]`);
    
    const open = openCheckbox.checked;
    const from = open ? fromInput.value : "";
    const to = open ? toInput.value : "";
    
    if (open && from && to) {
      result.push({ tag: day.key.toUpperCase(), von: from, bis: to });
    }
  });
  // Gib nur das Array der geÃ¶ffneten Tage zurÃ¼ck
  return result;
}

// Dynamische Aktivierung / Deaktivierung
document.addEventListener("change", (e) => {
  if (e.target.classList.contains("oh-open")) {
    const day = e.target.dataset.day;
    const row = e.target.closest("tr");
    const from = row.querySelector(".oh-from");
    const to = row.querySelector(".oh-to");
    const isOpen = e.target.checked;
    from.disabled = !isOpen;
    to.disabled = !isOpen;
    if (!isOpen) {
      from.value = "";
      to.value = "";
    }
  } else if (e.target.id === "immerCheck") {
      document.getElementById("dayInputs").classList.toggle("hidden", e.target.checked);
  }
});

  /***********************
   * Render Flow (Questions)
   ***********************/
          // Texte fÃ¼r Step 2 je nach Typ
const typeTexts = {
  EierhÃ¼tte: {
    title: "ğŸ·ï¸ Name der EierhÃ¼tte",
    question: "Wie soll deine EierhÃ¼tte heiÃŸen?"
  },
  Hofladen: {
    title: "ğŸ·ï¸ Name des Hofladens",
    question: "Wie soll dein Hofladen heiÃŸen?"
  },
  Selbstbedienung: {
    title: "ğŸ·ï¸ Name des SelbstbedienungshÃ¤uschens",
    question: "Wie soll dein SelbstbedienungshÃ¤uschen heiÃŸen?"
  },
  Spielplatz: {
    title: "ğŸ·ï¸ Name des Spielplatzes",
    question: "Wie soll der Spielplatz heiÃŸen?"
  },
  Abenteuerhof: {
    title: "ğŸ·ï¸ Name des Abenteuerhofs",
    question: "Wie soll dein Abenteuerhof heiÃŸen?"
  },
  Automat: {
    title: "ğŸ·ï¸ Name des Automaten",
    question: "Wie soll dein Automat heiÃŸen?"
  }
};
  function renderQuestion() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; // reset
    updateProgress();
    updateInfoBox();
document.getElementById("navBottom").style.display =
  (mode === "entry") ? "flex" : "none";
      
    try {
      if (step === 0) {
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">ğŸ›¡ï¸ DatenschutzerklÃ¤rung</h2>

      <div id="dsScrollBox" class="h-60 mb-3 rounded-lg overflow-auto border border-gray-200">
        <iframe 
          src="https://radlmap.net/datenschutz.html" 
          class="w-full h-[500px] border-0 bg-white"
          style="display:block; min-width:100%; overflow:auto;">
        </iframe>
      </div>

      <label class="inline-flex items-center gap-2 text-sm text-gray-700">
        <input id="dsCheck" type="checkbox" class="w-4 h-4" disabled /> 
        Ich akzeptiere die DatenschutzerklÃ¤rung
      </label>
      <div id="dsHint" class="text-xs text-red-500 mt-1">
        â¬‡ï¸ Bitte bis ganz nach unten scrollen
      </div>
    </div>`;

  // Scroll-Ãœberwachung
  const scrollBox = document.getElementById("dsScrollBox");
  const check = document.getElementById("dsCheck");
  const hint = document.getElementById("dsHint");

  scrollBox.addEventListener("scroll", () => {
    if (scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 5) {
      check.disabled = false;
      hint.textContent = "âœ… Du kannst nun die DatenschutzerklÃ¤rung akzeptieren.";
      hint.classList.remove("text-red-500");
      hint.classList.add("text-green-600");
    }
  });
  return;
}
      if (step === 1) {
        // Typ-Auswahl
        const opts = [
          { emoji: 'ğŸ¥š', label: 'EierhÃ¼tte', key: 'EierhÃ¼tte' },
          { emoji: 'ğŸª', label: 'Hofladen', key: 'Hofladen' },
          { emoji: 'ğŸ ', label: 'SelbstbedienungshÃ¤uschen', key: 'Selbstbedienung' },
          { emoji: 'ğŸ›', label: 'Spielplatz', key: 'Spielplatz' },
          { emoji: 'ğŸŒ„', label: 'Abenteuerhof', key: 'Abenteuerhof' },
          { emoji: 'ğŸ¶', label: 'Automat', key: 'Automat' }
        ];
        const wrap = document.createElement('div');
        wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto';
        opts.forEach(o => {
          const card = document.createElement('div');
          card.className = 'bg-white p-6 rounded-xl shadow card-option text-center cursor-pointer';
          if (editingData.typ === o.key) card.classList.add('selected');
          card.innerHTML = `<div class="text-3xl">${o.emoji}</div><div class="font-semibold mt-2">${o.label}</div>`;
          card.onclick = () => {
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            editingData.typ = o.key;
          };
          wrap.appendChild(card);
        });
        qa.appendChild(wrap);
        return;
      }



if (step === 2) {
  const currentType = editingData.typ; 
  const { title, question } = typeTexts[currentType] || {
    title: "ğŸ·ï¸ Name",
    question: "Wie soll dein Eintrag heiÃŸen?"
  };

  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-lg font-bold mb-2">${title}</h2>
      <p class="text-sm text-gray-600 mb-2">${question}</p>
      <input id="nameInput"
             class="w-full border p-2 rounded"
             placeholder="Name eingeben"
             value="${editingData.name || ''}">
    </div>`;
  return;
}

      if (step === 3) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸª‘ Gibt es SitzplÃ¤tze?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Ja' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Ja',this)">âœ… Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.sitzplaetze === 'Nein' ? 'selected' : ''}" onclick="selectOption('sitzplaetze','Nein',this)">âŒ Nein</button>
            </div>
          </div>`;
        return;
      }

      if (step === 4) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ”Œ Gibt es Strom?</h2>
            <div class="flex gap-4">
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Ja' ? 'selected' : ''}" onclick="selectOption('strom','Ja',this)">âš¡ Ja</button>
              <button class="flex-1 p-3 border rounded ${editingData.strom === 'Nein' ? 'selected' : ''}" onclick="selectOption('strom','Nein',this)">âŒ Nein</button>
            </div>
          </div>`;
        return;
      }
      
    // Korrigierter Step 5: Ã–ffnungszeiten (mit robustem Editor)
    if (step === 5) {
      qa.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
          <h2 class="text-lg font-bold mb-3">ğŸ•’ Ã–ffnungszeiten</h2>
          <div id="openhours-editor-wrapper">
            ${renderOpeningHoursEditor("currentHutId", editingData.oeffnungszeiten)}
          </div>
          <p class="text-xs text-gray-500 mt-4">Wichtig: Wenn du keine Zeiten eintrÃ¤gst, wird 'Geschlossen' angezeigt.</p>
        </div>
      `;
      return;
    }

      if (step === 6) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">âœ¨ Extras (optional)</h2>
            <input id="extrasInput" class="w-full border p-2 rounded" placeholder="z.B. GetrÃ¤nke, KÃ¼hlschrank" value="${editingData.extras || ''}">
          </div>`;
        return;
      }

      if (step === 7) {
        // Tiere toggle buttons (markieren, don't auto-next)
        const animals = ["ğŸ Ziege","ğŸ„ Kuh","ğŸ“ Huhn","ğŸ• Hund","ğŸ‡ Hase","ğŸˆ Katze","Keine Tiere"];
        const grid = document.createElement('div');
        grid.className = 'bg-white p-6 rounded-xl shadow max-w-2xl mx-auto';
        grid.innerHTML = `<h2 class="text-lg font-bold mb-3">ğŸ¾ Welche Tiere gibt es?</h2><div id="tiereGrid" class="grid grid-cols-3 gap-2"></div>`;
        qa.appendChild(grid);
        const holder = document.getElementById('tiereGrid');
        editingData.tiere = editingData.tiere || [];
        animals.forEach(t => {
          const btn = document.createElement('button');
          const isSel = editingData.tiere.includes(t);
          btn.className = `p-2 border rounded text-sm ${isSel ? 'selected' : ''}`;
          btn.textContent = t;
          btn.onclick = () => {
            // toggle
            if (t === 'Keine Tiere') {
              editingData.tiere = ['Keine Tiere'];
              // remove selected from others
              holder.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
              return;
            }
            // if 'Keine Tiere' present -> remove it
            editingData.tiere = (editingData.tiere || []).filter(x => x !== 'Keine Tiere');
            const idx = (editingData.tiere || []).indexOf(t);
            if (idx >= 0) {
              editingData.tiere.splice(idx, 1);
              btn.classList.remove('selected');
            } else {
              editingData.tiere.push(t);
              btn.classList.add('selected');
            }
          };
          holder.appendChild(btn);
        });
        return;
      }

      if (step === 8) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ“ Beschreibung</h2>
            <div id="quillContainer" class="bg-white"></div>
          </div>`;
        setTimeout(() => {
          initEnhancedEditor("quillContainer", editingData);
        }, 120);
        return;
      }

      if (step === 9) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-2">ğŸ·ï¸ SchlagwÃ¶rter (Komma getrennt)</h2>
            <input id="tagsInput" class="w-full border p-2 rounded" placeholder="z.B. FrÃ¼hstÃ¼ck,Schattig" value="${(editingData.tags||[]).join(', ')}">
          </div>`;
        return;
      }

      // Neuer Step 10: Foto-Upload
      if (step === 10) {
        qa.innerHTML = `
          <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
            <h2 class="text-lg font-bold mb-4">ğŸ“¸ Fotos (Max. 10)</h2>
            <div id="smartUploadZone" class="border-2 border-dashed border-gray-300 p-8 rounded-xl text-center cursor-pointer bg-gray-50 hover:bg-green-50 transition" onclick="document.getElementById('fileInput').click()">
              <p class="text-xl font-semibold text-gray-700">Fotos hochladen oder hierher ziehen</p>
              <p class="text-sm text-gray-500 mt-1">Das erste Foto wird das Hauptbild</p>
              <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
            </div>
            <div id="smartUploadPreview" class="grid grid-cols-3 gap-3 mt-4">
              </div>
            <div class="mt-4 flex items-center gap-4 text-xs text-gray-500">
              <span class="font-semibold">Speicheranbieter:</span> <span id="imageProviderLabel">ImgBB</span>
              <button onclick="setImageProvider('imgbb')" class="px-2 py-1 border rounded hover:bg-gray-100">ImgBB</button>
              <button onclick="setImageProvider('firebase')" class="px-2 py-1 border rounded hover:bg-gray-100">Firebase</button>
            </div>
            <p id="uploadLimit" class="text-sm text-red-500 mt-2 ${editingData.photos.length >= 10 ? '' : 'hidden'}">âš ï¸ Maximale Anzahl von Fotos (10) erreicht!</p>
          </div>
        `;
        // Init upload listeners
        setTimeout(() => {
          initSmartUpload();
          showGalleryFromEditingData(); // Show already uploaded/selected images
          updateProviderUI(); // Update provider label
        }, 100);
        return;
      }

      // Alter Step 10 wird neuer Step 11
      if (step === 11) {
         
  qa.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow max-w-2xl mx-auto">
      <h2 class="text-xl font-bold mb-3">ğŸ“‹ Ãœbersicht & Standort</h2>
      
      <h3 class="text-lg font-bold mt-4 mb-2">ğŸ“ Standort</h3>
      <div class="relative mb-2">
        <input id="addressSearch" class="w-full border p-2 rounded" placeholder="Adresse suchenâ€¦" />
        <div id="addressSuggestions" class="absolute left-0 right-0 bg-white border rounded mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
      </div>
      <button id="gpsBtn" class="px-3 py-2 mb-3 bg-blue-600 text-white rounded">ğŸ“¡ Mein Standort</button>

      <div id="overview-map" class="h-64 rounded border mb-4"></div>

      <div class="mt-3 flex items-center gap-2">
          <label class="inline-flex items-center gap-2">
              <input type="checkbox" id="instantActive" class="w-4 h-4"> 
              <span class="font-semibold text-green-700">Sofort aktiv</span> (ohne PrÃ¼fung)
          </label>
      </div>
      <div class="flex gap-2 mt-4">
        <button id="submitBtn" class="px-4 py-2 bg-green-600 text-white rounded" onclick="submitEntry()">âœ… Einreichen</button>
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="showMyEntries()">âœ– Abbrechen</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Deine Eintragung wird geprÃ¼ft und erst nach Freigabe sichtbar, es sei denn, du wÃ¤hlst 'Sofort aktiv'.</p>
    </div>`;

  // Jetzt nur noch Map initialisieren
  setTimeout(() => {
  initOverviewMap();

  // GPS-Button aktivieren
  const gpsBtn = document.getElementById("gpsBtn");
  if (gpsBtn) gpsBtn.addEventListener("click", locateGPS);

  // Adress-Suche mit VorschlÃ¤gen
  const addr = document.getElementById("addressSearch");
  const suggestionBox = document.getElementById("addressSuggestions");
  if (addr) {
    addr.addEventListener("input", async e => {
      const query = e.target.value.trim();
      if (query.length < 3) {
        suggestionBox.innerHTML = "";
        suggestionBox.classList.add("hidden");
        return;
      }
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.length) {
          suggestionBox.innerHTML = "<div class='p-2 text-gray-500'>Keine Treffer</div>";
          suggestionBox.classList.remove("hidden");
          return;
        }

        suggestionBox.innerHTML = data.map(item => `
          <div class="p-2 hover:bg-gray-100 cursor-pointer" data-lat="${item.lat}" data-lon="${item.lon}">
            ${item.display_name}
          </div>`).join("");
        suggestionBox.classList.remove("hidden");

        suggestionBox.querySelectorAll("div").forEach(div => {
          div.addEventListener("click", () => {
            const lat = parseFloat(div.dataset.lat);
            const lon = parseFloat(div.dataset.lon);
            addr.value = div.textContent;
            suggestionBox.classList.add("hidden");
            initOverviewMap(lat, lon, 15);
          });
        });
      } catch (err) {
        console.error("Fehler bei Nominatim:", err);
      }
    });
  }
}, 200);
  return;
      }
      
    } catch (err) {
      console.error("renderQuestion error", err);
      document.getElementById('question-area').innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler: ${err.message}</div>`;
    }
  }
    
const stripe = Stripe("pk_test_51SFLgEBghOTdsn6RBYuZr6x4R2BC6lhq4NFWmcKTtyNahatWHMVHAq3posYIhsXKRl598qHOzMzyymuV6DgKWYly006AaME4Wr");


async function showDashboard() {
  const qa = document.getElementById("question-area");
  qa.innerHTML = `
    <section class="bg-gradient-to-br from-green-50 to-white p-6 rounded-2xl shadow-xl max-w-5xl mx-auto animate-fadeIn">
      <h2 class="text-2xl font-extrabold text-green-800 mb-6">ğŸ“Š Mein Dashboard</h2>

      <div id="statsArea" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="col-span-3 text-center text-gray-500">Lade Daten...</div>
      </div>

      <div id="limitsArea" class="mb-10"></div>

      <div id="premiumArea" class="mb-10"></div>

      <div id="eventsArea" class="mb-4"></div>
    </section>
  `;

  const user = firebase.auth().currentUser;
  if (!user) {
    document.getElementById("statsArea").innerHTML =
      `<div class="col-span-3 text-center text-red-600 font-semibold">Bitte zuerst einloggen.</div>`;
    return;
  }

  // ğŸ“ˆ Statistik (Summe)
  db.collection("eierhuetten").where("userId", "==", user.uid).onSnapshot(snapshot => {
    let totalViews = 0, totalRoutes = 0;
    snapshot.forEach(doc => {
      const data = doc.data();
      totalViews += data.views || 0;
      totalRoutes += data.routeStarts || 0;
    });
    const avgPerDay = Math.round(totalViews / Math.max(1, snapshot.size));

    document.getElementById("statsArea").innerHTML = `
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ‘ï¸</div>
        <h3 class="font-semibold">Aufrufe</h3>
        <p class="text-2xl font-bold text-green-700">${totalViews}</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ“</div>
        <h3 class="font-semibold">Routenstarts</h3>
        <p class="text-2xl font-bold text-green-700">${totalRoutes}</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow text-center">
        <div class="text-3xl mb-2">ğŸ“…</div>
        <h3 class="font-semibold">Ã˜ Aufrufe/Tag</h3>
        <p class="text-2xl font-bold text-green-700">${avgPerDay}</p>
      </div>
    `;
  });
  
  // ğŸŒŸ Premium Status
  db.collection("betreiber").doc(user.uid).onSnapshot(doc => {
    const data = doc.data() || {};
    const premiumArea = document.getElementById("premiumArea");
    const isPremium = data.premium === true;
    
    if (isPremium) {
      premiumArea.innerHTML = `
        <div class="p-4 bg-green-50 rounded-lg shadow text-center">
          ğŸŒŸ <b>Premium aktiv</b><br>
          <span class="text-sm text-gray-600">bis ${data.premium_until || "unbekannt"}</span>
        </div>
      `;
      // Nur wenn Premium aktiv: Diagramm anzeigen
      // showPremiumStatsChart(user); // Funktion muss implementiert werden
    } else {
      premiumArea.innerHTML = `
        <button class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition" onclick="showPremiumUpgrade()" >
          ğŸŒŸ Premium freischalten (2 â‚¬/Monat)
        </button>
      `;
    }
    showLimitsSection(user, isPremium);
  });
  
}

// Dummy-Funktion fÃ¼r Premium Stats Chart (muss implementiert werden)
function showPremiumStatsChart(user) {
    const eventsArea = document.getElementById("eventsArea");
    eventsArea.innerHTML = `
        <h3 class="text-lg font-bold mb-2">ğŸ“ˆ Premium Statistiken (Dummy)</h3>
        <div class="p-4 bg-gray-100 rounded">
            <p class="text-sm text-gray-600">Hier wÃ¼rde ein Chart mit detaillierten Aufrufzahlen erscheinen.</p>
            <canvas id="premiumChart" height="150"></canvas>
        </div>
    `;
    // Dummy Chart init
    const ctx = document.getElementById('premiumChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Okt', 'Nov', 'Dez', 'Jan', 'Feb', 'MÃ¤r'],
            datasets: [{
                label: 'Monatliche Aufrufe',
                data: [120, 190, 300, 500, 450, 600],
                borderColor: '#10B981',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
}


async function showLimitsSection(user, isPremium) { 
  const limitsArea = document.getElementById("limitsArea");
  if (!limitsArea) return;
  const entriesSnap = await db.collection("eierhuetten")
    .where("userId", "==", user.uid)
    .get();
  const count = entriesSnap.size;
  const limit = isPremium ? 999 : 1; // Free: 1 Eintrag, Premium: praktisch unbegrenzt
  const pct = Math.min((count / limit) * 100, 100).toFixed(0); 

  limitsArea.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-xl font-bold text-gray-800 mb-3">âš™ï¸ Deine Limits</h3>
      
      <div class="mb-4">
        <h4 class="font-semibold text-gray-700">Anzahl der EintrÃ¤ge:</h4>
        <p class="text-gray-600 mb-2">Du hast <b>${count}</b> von <b>${limit}</b> mÃ¶glichen EintrÃ¤gen erstellt.</p>
        <div class="w-full bg-gray-200 h-3 rounded"><div class="h-3 bg-green-500 rounded" style="width:${pct}%;"></div></div>
        <p class="text-sm text-gray-600 mt-2">${pct}% deines Limits erreicht</p>
      </div>

      <div class="mt-4 pt-4 border-t border-gray-200">
        <h4 class="font-semibold text-gray-700">Fotos pro HÃ¼tte:</h4>
        <p class="text-gray-600 mb-2">${isPremium ? 'Bis zu 10 Fotos' : 'Max. 3 Fotos'}</p>
      </div>

      ${!isPremium && count >= limit ? ` 
        <div class="mt-4 text-center p-4 bg-red-50 rounded-lg"> 
          <p class="text-red-600 text-sm mb-2 font-bold">ğŸš« Du hast dein Limit erreicht.</p> 
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition" onclick="showPremiumUpgrade()">ğŸŒŸ Jetzt auf Premium upgraden</button> 
        </div>` : ""}
    </div>
  `;
} 

function showPremiumUpgrade() {
    const qa = document.getElementById("question-area");
    qa.innerHTML = `
      <section class="bg-white p-6 rounded-xl shadow max-w-xl mx-auto animate-fadeIn">
        <h2 class="text-2xl font-bold mb-4">ğŸŒŸ UnterstÃ¼tzer werden</h2>
        <p class="text-gray-700 mb-4">Mit RadlMap Premium erhÃ¤ltst du:</p>
        <ul class="list-disc list-inside mb-6 text-gray-700">
          <li>ğŸ” Hervorgehobene Anzeige auf der Karte</li>
          <li>ğŸ“¸ Bis zu 10 Fotos hochladen</li>
          <li>ğŸ“ˆ Erweiterte Statistiken</li>
          <li>ğŸ’¬ KontaktmÃ¶glichkeiten in deinem Eintrag</li>
          <li>â• Unbegrenzte EintrÃ¤ge (HÃ¼tten, HoflÃ¤den, Events)</li>
        </ul>
        <p class="text-xl font-bold text-green-700 mb-4">Nur 2 â‚¬ pro Monat</p>
        <button id="checkoutButton" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
          Jetzt Premium abonnieren
        </button>
        <p class="text-xs text-gray-500 mt-4 text-center">Abonnement Ã¼ber Stripe. Jederzeit kÃ¼ndbar.</p>
      </section>
    `;
    // Dummy Stripe Checkout
    document.getElementById('checkoutButton').addEventListener('click', () => {
        showToast("ğŸ’³ Weiterleitung zum Dummy-Checkout von Stripe...");
        // In einer realen App: Ruf eine Cloud Function auf, die eine Checkout Session erstellt.
        alert("Simulierter Kauf erfolgreich. Jetzt bist du Premium!");
        // Aktualisiere den Status
        const user = firebase.auth().currentUser;
        if (user) {
            db.collection('betreiber').doc(user.uid).set({
                premium: true,
                premium_until: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString("de-DE"),
                unterstuetzer: true
            }, { merge: true });
        }
        showDashboard();
    });
}
// ... (Weitere Dashboard/Event-Funktionen) ...

function selectOption(field, value, el) { 
// deselect siblings 
if (el && el.parentNode) { 
  el.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected')); 
  el.classList.add('selected'); 
} 
editingData[field] = value; 
} 

// ===========================================
// Logik fÃ¼r nextStep / prevStep
// ===========================================
function nextStep() { 
  // validation for some steps 
  if (step === 0) { 
    const ok = document.getElementById('dsCheck') && document.getElementById('dsCheck').checked; 
    if (!ok) { alert('Bitte DatenschutzerklÃ¤rung akzeptieren'); return; } 
    editingData.datenschutz = true; 
  } 
  
  // Typ auswÃ¤hlen 
  if (step === 1) { 
    if (!editingData.typ) { alert("Bitte einen Typ auswÃ¤hlen."); return; } 
  } 
  
  // Name
  if (step === 2) { 
    const v = document.getElementById('nameInput')?.value?.trim(); 
    if (!v) { alert('Bitte Namen eingeben'); return; } 
    editingData.name = v; 
  }

  // Ã–ffnungszeiten 
  if (step === 5) { 
    const normalizedOeff = collectOpeningHours();
    if (!normalizedOeff || (Array.isArray(normalizedOeff) && normalizedOeff.length === 0 && !document.getElementById("immerCheck")?.checked)) { 
      alert("Bitte Ã–ffnungszeiten angeben oder 'Immer geÃ¶ffnet' auswÃ¤hlen."); 
      return; 
    }
    editingData.oeffnungszeiten = normalizedOeff; 
  } 
  
  // Extras
  if (step === 6) { 
    editingData.extras = document.getElementById('extrasInput')?.value?.trim(); 
  }
  
  // Tiere (PrÃ¼fung optional)

  // Beschreibung
  // (wird im enhancedEditor erfasst, aber hier optional prÃ¼fbar)

  // Tags
  if (step === 9) { 
    const raw = document.getElementById('tagsInput')?.value || ''; 
    editingData.tags = raw.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10); 
  } 

  // Fotos (PrÃ¼fung optional)
  
  if (step < stepsCount - 1) step++; 
  renderQuestion(); 
  updateProgress(); 
} 
function prevStep() { 
  if (step > 0) step--; 
  renderQuestion(); 
  updateProgress(); 
} 
function startNewEntry() { 
  if (!currentUser || !currentUser.uid) { 
    showToast("Bitte zuerst einloggen"); 
    return; 
  } 
  editingData = { photos: [] }; // Reset und photos initialisieren
  step = 0; 
  mode = "entry"; 
  document.getElementById("navBottom").style.display = (mode === "entry") ? "flex" : "none"; 
  renderQuestion(); 
  document.getElementById('sidebar').classList.add('-translate-x-full'); // Sidebar schlieÃŸen
  updateProgress(); 
} 

function renderOpeningHours(oeff) { 
  if (!oeff) return "â€“"; 
  // Fall 1: String 
  if (typeof oeff === "string") { 
    if (oeff.toLowerCase().includes("immer")) { return "Immer geÃ¶ffnet âœ…"; } 
    return oeff; // z.B. "09:00 â€“ 18:00" 
  } 
  // Fall 2: Map mit immer:true 
  if (typeof oeff === "object" && !Array.isArray(oeff)) { 
    if (oeff.immer === true) return "Immer geÃ¶ffnet âœ…"; 
    // Falls in Zukunft auch andere Felder im Objekt gespeichert 
    let keys = Object.keys(oeff); 
    return keys.map(k => `${k}: ${oeff[k]}`).join("<br>"); 
  } 
  // Fall 3: Array [{tag, von, bis}, â€¦] 
  if (Array.isArray(oeff)) { 
    if (oeff.length === 0) return "â€“"; 
    return oeff.map(o => `${o.tag}: ${o.von} â€“ ${o.bis}`).join("<br>"); 
  } 
  return "â€“"; 
} 

async function submitEntry() { 
  if (!editingData.name || !editingData.typ) { 
    alert('Bitte Typ und Name ausfÃ¼llen.'); 
    return; 
  } 
  if (!editingData.location?.lat) {
    alert('Bitte den Standort auf der Karte festlegen.');
    return;
  }
  
  // Vor-Upload der Fotos (falls vorhanden)
  showToast("â³ Fotos werden hochgeladen...");
  const uploadedPhotoUrls = [];
  const filesToUpload = editingData.photos.filter(p => p instanceof File);

  for (const f of filesToUpload) {
    try {
      const url = await uploadFileWithProgress(f, (pct) => {
        showToast(`â³ Upload von ${f.name}: ${pct}%`);
      });
      uploadedPhotoUrls.push({ url, status: 'ok' });
    } catch(err) {
      console.error("Foto-Upload-Fehler", err);
      showToast(`âŒ Fehler beim Upload von ${f.name}.`);
    }
  }
  
  // Kombiniere hochgeladene und bereits vorhandene URLs
  const finalPhotos = uploadedPhotoUrls.concat(editingData.photos.filter(p => typeof p === 'object' && p.url));
  
  const payload = { 
    userId: currentUser.uid, 
    name: editingData.name, 
    typ: editingData.typ, 
    sitzplaetze: editingData.sitzplaetze || 'Nein', 
    strom: editingData.strom || 'Nein', 
    extras: editingData.extras || '', 
    tiere: editingData.tiere || [], 
    beschreibung: editingData.beschreibung || '', 
    tags: editingData.tags || [], 
    oeffnungszeiten: editingData.oeffnungszeiten || null,
    fotos: finalPhotos,
    status: 'offen', 
    erstelltAm: firebase.firestore.FieldValue.serverTimestamp(), 
    datenschutzZustimmung: { 
      bestaetigtAm: firebase.firestore.FieldValue.serverTimestamp(), 
      durch: currentUser.email || null 
    } 
  }; 
  
  if (editingData.location?.lat && editingData.location?.lng) { 
    payload.location = new firebase.firestore.GeoPoint( 
      editingData.location.lat, 
      editingData.location.lng 
    ); 
  } 
  
  try { 
    const docRef = await db.collection('eierhuetten').add(payload); 

    // Sofort-Aktivierung
    const instant = document.getElementById('instantActive')?.checked;
    if (instant) {
        await db.collection('eierhuetten').doc(docRef.id).update({ status: 'angenommen', active: true });
        showToast('âœ… Eintrag sofort aktiv und sichtbar!');
    } else {
        showToast('âœ… Eintragung gesendet. Wird geprÃ¼ft.'); 
    }
    
    showMyEntries(); 
  } catch (err) { 
    console.error('submitEntry error', err); 
    alert('Fehler beim Senden: ' + (err.message || err)); 
  } 
} 

let overviewMap; 
let overviewMarker; 
function initOverviewMap(lat = 51.1657, lng = 10.4515, zoom = 6) { 
  if (!overviewMap) { 
    overviewMap = L.map("overview-map").setView([lat, lng], zoom); 
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(overviewMap); 
  } else { 
    overviewMap.setView([lat, lng], zoom); 
  } 
  if (!overviewMarker) { 
    overviewMarker = L.marker([lat, lng], { draggable: true }).addTo(overviewMap); 
    overviewMarker.on("dragend", ev => { 
      const p = ev.target.getLatLng(); 
      editingData.location = { lat: p.lat, lng: p.lng }; 
    }); 
  } else { 
    overviewMarker.setLatLng([lat, lng]); 
  } 
  editingData.location = { lat, lng }; 
} 
function locateGPS() { 
  if (!navigator.geolocation) return alert("âŒ GPS nicht verfÃ¼gbar"); 
  navigator.geolocation.getCurrentPosition( 
    pos => { 
      const { latitude, longitude } = pos.coords; 
      initOverviewMap(latitude, longitude, 15); 
    }, 
    err => { 
      alert("âŒ GPS-Fehler: " + err.message); 
    } 
  ); 
} 
const stepInfos = { 
  0: { title: "Datenschutz", text: "Bitte lies die DatenschutzerklÃ¤rung aufmerksam und bestÃ¤tige sie. Ohne Zustimmung kÃ¶nnen wir keine Daten annehmen." }, 
  1: { title: "Art der Eintragung", text: "WÃ¤hle, ob du eine EierhÃ¼tte, Hofladen, SelbstbedienungshÃ¤uschen, Spielplatz oder Abenteuerhof eintragen mÃ¶chtest." }, 
  2: { title: "Name der HÃ¼tte", text: "Verwende einen kurzen, prÃ¤gnanten Namen, z. B. â€EierhÃ¼tte am Dorfplatzâ€œ." }, 
  3: { title: "SitzplÃ¤tze", text: "Falls es Sitzgelegenheiten gibt, wÃ¤hle Ja. Sonst Nein." }, 
  4: { title: "Strom", text: "Angabe, ob Strom verfÃ¼gbar ist. (z.B. zum Aufladen des E-Bikes oder fÃ¼r das Handy)." }, 
  5: { title: "Ã–ffnungszeiten", text: "Trage hier deine Ã–ffnungszeiten ein. Nutze 'Immer geÃ¶ffnet' fÃ¼r 24/7-Angebote." }, 
  6: { title: "Extras", text: "Hier kannst du Besonderheiten angeben, z. B. GetrÃ¤nke, KÃ¼hlschrank, GrillmÃ¶glichkeiten." }, 
  7: { title: "Tiere", text: "WÃ¤hle alle Tiere aus, die es vor Ort gibt. Falls keine Tiere da sind, bitte â€Keine Tiereâ€œ auswÃ¤hlen." }, 
  8: { title: "Beschreibung", text: "Beschreibe deine HÃ¼tte, den Hof oder den Ort mÃ¶glichst ausfÃ¼hrlich. Z. B. â€Unsere HÃ¼tte liegt direkt am Radweg und bietet frische Eier aus Freilandhaltung.â€œ" }, 
  9: { title: "Tags", text: "Gib SchlagwÃ¶rter ein, damit andere die HÃ¼tte besser finden kÃ¶nnen (max. 10). Z. B. â€regional, Bio, FrÃ¼hstÃ¼ckâ€œ." },
  10: { title: "Fotos", text: "Lade deine besten Fotos hoch (max. 10). Das erste Foto wird das Hauptbild. Du kannst die Fotos per Drag & Drop sortieren." }, // Neuer Schritt 10
  11: { title: "Ãœbersicht & Standort", text: "Hier siehst du alle Angaben zusammen. WÃ¤hle den Standort per Klick auf die Karte oder GPS. Du kannst den Marker mit Drag & Drop verschieben. Mit 'Sofort aktiv' wird dein Eintrag ohne manuelle PrÃ¼fung online gestellt." } // Neuer Schritt 11
}; 

function updateInfoBox() { 
  const boxDesktop = document.getElementById("infoBox"); 
  const boxMobile = document.getElementById("infoBoxMobile"); 
  let html = ""; 
  if (mode === "entry") { 
    const info = stepInfos[step]; 
    if (info) { 
      html = ` 
        <h4 class="font-semibold">${info.title}</h4> 
        <p>${info.text}</p> 
      `; 
    } else { 
      html = "<p>Keine weiteren Informationen verfÃ¼gbar.</p>"; 
    } 
  } else if (mode === "list") { 
    html = ` 
      <h4 class="font-semibold">ğŸ“‹ Meine Eintragungen</h4> 
      <p>Hier siehst du deine bereits eingereichten HÃ¼tten.<br> Bearbeiten ist nur mÃ¶glich, sobald die HÃ¼tte freigegeben wurde.</p> 
    `; 
  } else if (mode === "tutorial") { 
    html = ` 
      <h4 class="font-semibold">ğŸ‘‹ Willkommen</h4> 
      <p>Du befindest dich hier im Tutorial, <br> hier wird Dir alles erklÃ¤rt. </p> 
    `; 
  } else if (mode === "support") { 
    html = ` 
      <h4 class="font-semibold">ğŸ’¬ Support</h4> 
      <p>Stelle hier deine Fragen oder melde Probleme.<br> Deine Tickets werden gespeichert und kÃ¶nnen spÃ¤ter eingesehen oder gelÃ¶scht werden.</p> 
    `; 
  } else if (mode === "hutMessages") { 
    html = ` 
      <h4 class="font-semibold">ğŸ¡ HÃ¼tten-Nachrichten</h4> 
      <p> Hier siehst du alle Nachrichten, die Besucher zu deinen HÃ¼tten geschickt haben.<br> Diese Ãœbersicht aktualisiert sich automatisch, sobald neue Nachrichten eintreffen. </p> 
      <p class="mt-1 text-sm text-gray-500"> Tipp: Neue Nachrichten erkennst du am roten ğŸ”” Badge in der Seitenleiste. </p> 
    `; 
  } else { 
    html = "<p>â„¹ï¸ WÃ¤hle links eine Funktion aus.</p>"; 
  } 
  // âœ¨ Desktop-Bereich befÃ¼llen 
  if (boxDesktop) boxDesktop.innerHTML = html; 
  // âœ¨ Mobile Overlay befÃ¼llen 
  if (boxMobile) boxMobile.innerHTML = html; 
} 
/*********************** * Sidebar actions: Meine Eintragungen (mit Bearbeitung) ***********************/ 
// ================================ 
// ğŸ” MyEntries 2.0 - Ãœbersicht + Detailseite // ================================ 
// Hilfsfunktion: safe escape fÃ¼r attributes (falls noch nicht vorhanden) 
function escapeAttr(s) { 
  return (s === undefined || s === null) ? '' : String(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); 
} 
// ================================ 
// Ãœbersicht: Karten mit Bild + Edit/Delete // ================================ 
async function showMyEntries() { 
  if (!firebase.auth().currentUser) { 
    showToast("Bitte zuerst einloggen"); 
    return; 
  } 
  const uid = firebase.auth().currentUser.uid; 
  // Lade betreiber-doc fÃ¼r UnterstÃ¼tzer-Status global (falls benÃ¶tigt) 
  const betreiberDoc = await db.collection("betreiber").doc(uid).get(); 
  const isGlobalSupporter = betreiberDoc.exists && (betreiberDoc.data().premium === true || betreiberDoc.data().unterstuetzer === true); 
  const container = document.getElementById("question-area"); 
  container.innerHTML = ` 
    <div class="max-w-6xl mx-auto"> 
      <h2 class="text-2xl font-bold mb-6 text-green-700">ğŸ“‹ Meine Eintragungen</h2> 
      <div id="entriesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div> 
    </div> 
  `; 
  const grid = document.getElementById("entriesGrid"); 
  grid.innerHTML = `<div class="col-span-3 text-gray-500">â³ Lade Eintragungenâ€¦</div>`; 
  try { 
    const snap = await db.collection("eierhuetten") 
      .where("userId", "==", uid) 
      .orderBy("erstelltAm", "desc") 
      .get(); 
    const docs = snap.docs.filter(d => { 
      const st = d.data().status; 
      return st !== 'archiviert' && st !== 'deleted'; 
    }); 
    if (docs.length === 0) { 
      grid.innerHTML = `<div class="bg-white p-6 rounded shadow text-center">Du hast noch keine Eintragungen.</div>`; 
      return; 
    } 
    // optional: aggregate top stats for header (sum) 
    let total = docs.length; 
    let angenommen = docs.filter(d => ['angenommen','accepted'].includes(d.data().status)).length; 
    let offen = docs.filter(d => d.data().status === 'offen').length; 
    // optional header 
    const headerBar = document.createElement('div'); 
    headerBar.className = 'col-span-3 bg-green-50 p-3 rounded-lg text-sm text-green-800 flex gap-6 justify-center items-center'; 
    headerBar.innerHTML = `ğŸ¥š <strong>${total}</strong> Eintragungen â€¢ âœ… <strong>${angenommen}</strong> angenommen â€¢ â³ <strong>${offen}</strong> offen`; 
    grid.innerHTML = ''; 
    grid.appendChild(headerBar); 
    // render each card 
    for (const doc of docs) { 
      const d = doc.data(); 
      const id = doc.id; 
      const img = Array.isArray(d.fotos) && d.fotos.length ? (typeof d.fotos[0] === 'string' ? d.fotos[0] : d.fotos[0].url) : 'https://radlmap.net/img/noimg/1.jpg'; 
      const isSupporter = d.unterstuetzer === true || isGlobalSupporter === true; 
      const card = document.createElement('div'); 
      card.className = 'bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl transition relative'; 
      card.style.cursor = 'pointer'; 
      card.innerHTML = ` 
        <div class="relative"> 
          <img src="${escapeAttr(img)}" alt="${escapeAttr(d.name||'')}" class="w-full h-48 object-cover"> 
          ${isSupporter ? `<span class="absolute top-3 right-3 bg-green-600 text-white text-xs font-semibold px-3 py-1 rounded-full shadow">ğŸ’š UnterstÃ¼tzer</span>` : ''} 
        </div> 
        <div class="p-4 flex justify-between items-center"> 
          <div class="truncate"> 
            <h3 class="font-bold text-lg text-gray-800 truncate">${escapeAttr(d.name||'Unbenannt')}</h3> 
            <p class="text-xs text-gray-500 truncate">${(d.status || 'Unbekannt')}</p> 
          </div> 
          <div class="flex gap-3 text-lg"> 
            <button class="edit-btn text-blue-600 hover:text-blue-800" title="Bearbeiten" data-id="${id}">âœï¸</button> 
            <button class="delete-btn text-red-600 hover:text-red-800" title="LÃ¶schen" data-id="${id}" data-name="${escapeAttr(d.name||'')}">âŒ</button> 
          </div> 
        </div> 
      `; 
      // click on card opens edit page 
      card.addEventListener('click', (ev) => { 
        // avoid card-click if edit or delete button clicked 
        if (ev.target.closest('.edit-btn') || ev.target.closest('.delete-btn')) return; 
        openEditPage(id); 
      }); 
      grid.appendChild(card); 
    } 
    // event delegation for edit / delete 
    grid.querySelectorAll('.edit-btn').forEach(btn => { 
      btn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        // openEditPage(btn.dataset.id); // Muss noch implementiert werden
        showToast("Bearbeiten noch nicht implementiert");
      }); 
    }); 
    grid.querySelectorAll('.delete-btn').forEach(btn => { 
      btn.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        confirmDeleteEntry(btn.dataset.id, btn.dataset.name); 
      }); 
    }); 
  } catch (err) { 
    console.error('showMyEntries error', err); 
    grid.innerHTML = `<div class="bg-red-100 p-4 rounded">Fehler beim Laden: ${err.message}</div>`; 
  } 
} 
// ================================ 
// LÃ¶schen mit Nachfrage (Ã¼bersicht + detail) 
// ================================ 
function confirmDeleteEntry(id, name) { 
  const proceed = confirm(`âš ï¸ MÃ¶chtest du die Eintragung "${name}" wirklich lÃ¶schen? Dieser Schritt kann nicht rÃ¼ckgÃ¤ngig gemacht werden.`);
  if(proceed) {
    db.collection('eierhuetten').doc(id).update({ status: 'deleted' })
      .then(() => {
        showToast(`ğŸ—‘ï¸ Eintrag "${name}" gelÃ¶scht.`);
        showMyEntries();
      })
      .catch(err => {
        console.error('Delete error', err);
        alert('âŒ Fehler beim LÃ¶schen: ' + err.message);
      });
  }
}
// ... (Hut Messages, Support, Events mÃ¼ssen noch implementiert oder erweitert werden) ...

// ===========================================
// Quill Editor Init
// ===========================================
let quill;
function initEnhancedEditor(containerId, data) {
  const container = document.getElementById(containerId);
  if (!container) return;

  // Editor-Toolbar
  const toolbarOptions = [
    ['bold', 'italic', 'underline', 'strike'], 
    ['blockquote', 'code-block'],
    [{ 'header': 1 }, { 'header': 2 }],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    [{ 'indent': '-1'}, { 'indent': '+1' }],
    [{ 'direction': 'rtl' }],
    [{ 'size': ['small', false, 'large', 'huge'] }],
    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
    [{ 'color': [] }, { 'background': [] }],
    [{ 'font': [] }],
    [{ 'align': [] }],
    ['clean']
  ];

  quill = new Quill(container, {
    modules: {
      toolbar: toolbarOptions
    },
    theme: 'snow',
    placeholder: 'FÃ¼ge eine ausfÃ¼hrliche Beschreibung hinzu...'
  });

  // Vorhandenen Inhalt setzen
  if (data.beschreibung) {
    quill.root.innerHTML = data.beschreibung;
  }

  // Inhalt bei jeder Ã„nderung in editingData speichern
  quill.on('text-change', () => {
    data.beschreibung = quill.root.innerHTML;
  });
}

// ===========================================
// Image Upload Funktionen (ImgBB & Firebase Storage)
// ===========================================

let imageStorageProvider = localStorage.getItem('radl_img_provider') || 'imgbb';

function setImageProvider(p) { 
  imageStorageProvider = p; 
  localStorage.setItem('radl_img_provider', p); 
  showToast('Speicheranbieter: '+p); 
  updateProviderUI(); 
} 

function updateProviderUI() { 
  const el = document.getElementById('imageProviderLabel'); 
  if (el) el.textContent = imageStorageProvider === 'firebase' ? 'Firebase Storage' : 'ImgBB'; 
} 

function uploadToFirebaseStorage(file, onProgress) { 
  return new Promise((resolve, reject) => { 
    try { 
      const user = firebase.auth().currentUser || currentUser || { uid: 'anon' }; 
      const path = `eierhuetten/${user.uid}/${Date.now()}_${file.name}`; 
      const storageRef = firebase.storage().ref().child(path); 
      const uploadTask = storageRef.put(file); 
      uploadTask.on('state_changed', snapshot => { 
        if (onProgress && snapshot.totalBytes) { 
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100); 
          onProgress(pct); 
        } 
      }, err => { 
        console.error("Firebase upload error", err); 
        reject(err); 
      }, async () => { 
        const url = await uploadTask.snapshot.ref.getDownloadURL(); 
        resolve(url); 
      }); 
    } catch (err) { 
      reject(err); 
    } 
  }); 
}

function uploadToImgbbWithProgress(file, onProgress) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append("image", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`);

        xhr.upload.onprogress = (event) => {
            if (event.lengthComputable && onProgress) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                onProgress(percentComplete);
            }
        };

        xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.data && response.data.url) {
                        resolve(response.data.url);
                    } else {
                        reject(new Error("ImgBB response was invalid"));
                    }
                } catch (e) {
                    reject(new Error("Failed to parse ImgBB response"));
                }
            } else {
                reject(new Error(`ImgBB upload failed with status ${xhr.status}`));
            }
        };

        xhr.onerror = () => {
            reject(new Error("ImgBB upload failed due to a network error"));
        };

        xhr.send(formData);
    });
}

function uploadFileWithProgress(file, progressCallback) { 
  if (imageStorageProvider === 'firebase' && typeof firebase !== 'undefined' && firebase.storage) { 
    return uploadToFirebaseStorage(file, progressCallback); 
  } else { 
    return uploadToImgbbWithProgress(file, progressCallback); 
  } 
}

function removePhoto(index) {
  if (confirm("Foto wirklich entfernen?")) {
    editingData.photos.splice(index, 1);
    showGalleryFromEditingData();
  }
}

function showGalleryFromEditingData() {
  const preview = document.getElementById('smartUploadPreview');
  const limitMsg = document.getElementById('uploadLimit');
  if (!preview) return;

  preview.innerHTML = ''; // Clear previous images
  limitMsg.classList.toggle('hidden', editingData.photos.length < 10);
  document.getElementById('smartUploadZone')?.classList.toggle('hidden', editingData.photos.length >= 10);


  editingData.photos.forEach((photo, index) => {
    // Ermittle die URL: entweder eine Zeichenkette oder ein File-Objekt (temporÃ¤re URL)
    const url = photo instanceof File ? URL.createObjectURL(photo) : photo.url;
    const isFile = photo instanceof File;
    const item = document.createElement('div');
    item.className = `photo-preview rounded-xl overflow-hidden shadow-lg relative ${isFile ? 'uploading' : ''}`;
    item.dataset.index = index;
    item.draggable = true;
    
    // Status-Text
    const statusText = isFile ? 'Wartet auf Upload' : (index === 0 ? 'HAUPTBILD' : 'OK');
    const badgeClass = isFile ? 'bg-yellow-500' : (index === 0 ? 'bg-green-600' : 'bg-blue-500');

    item.innerHTML = `
      <img src="${url}" alt="Foto ${index + 1}" class="w-full h-32 object-cover">
      <div class="absolute top-2 left-2 text-xs font-bold text-white px-2 py-0.5 rounded ${badgeClass}">
        ${statusText}
      </div>
      <div class="photo-preview-overlay">
        <button onclick="removePhoto(${index})" title="Entfernen">âŒ</button>
      </div>
    `;
    preview.appendChild(item);
  });

  // Drag & Drop FunktionalitÃ¤t
  const items = preview.querySelectorAll('.photo-preview');
  items.forEach(item => {
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', item.dataset.index);
      item.classList.add('opacity-50');
    });
    item.addEventListener('dragend', (e) => {
      item.classList.remove('opacity-50');
    });
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      item.classList.add('ring-2', 'ring-green-500');
    });
    item.addEventListener('dragleave', (e) => {
      item.classList.remove('ring-2', 'ring-green-500');
    });
    item.addEventListener('drop', (e) => {
      e.preventDefault();
      item.classList.remove('ring-2', 'ring-green-500');
      const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
      const droppedIndex = parseInt(item.dataset.index);
      
      if (draggedIndex !== droppedIndex) {
        // Elemente im Array tauschen
        const [draggedItem] = editingData.photos.splice(draggedIndex, 1);
        editingData.photos.splice(droppedIndex, 0, draggedItem);
        showGalleryFromEditingData(); // Galerie neu rendern
      }
    });
  });
}


function initSmartUpload() {
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('smartUploadZone');

  const handleFiles = (files) => {
    const photoCount = editingData.photos.length;
    const remaining = 10 - photoCount;
    
    Array.from(files).slice(0, remaining).forEach(file => {
      if (file.type.startsWith('image/')) {
        // Speichere das File-Objekt im State
        editingData.photos.push(file); 
      }
    });
    showGalleryFromEditingData();
  };

  if (fileInput) {
    fileInput.onchange = (e) => handleFiles(e.target.files);
  }

  // Drop-Zone Events
  if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('border-green-500'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-green-500'), false);
    });

    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }, false);
  }
}

// ===========================================
// Sonstige Funktionen
// ===========================================

function showTutorial() { 
  const qa = document.getElementById("question-area"); 
  mode = "tutorial"; 
  const tutorialHTML = ` 
    <section class="bg-white p-8 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn"> 
      <header class="mb-6 text-center"> 
        <h2 class="text-3xl font-extrabold text-green-600 mb-2">ğŸ‘‹ Willkommen!</h2> 
        <p class="text-gray-600 text-lg"> SchÃ¶n, dass du den <span class="font-semibold text-green-600">HÃ¼tten-Assistent</span> benutzt. Hier ein kurzer Ãœberblick Ã¼ber die wichtigsten Funktionen: </p> 
      </header> 
      <ul class="space-y-5 text-gray-700"> 
        <li class="flex items-start"> 
          <span class="text-green-500 mr-3 text-xl">â•</span> 
          <p> <strong>â€Neue Eintragungâ€œ</strong> â€“ Erstelle eine neue HÃ¼tten-/Hofladen-Eintragung mit Fotos und Informationen. </p> 
        </li> 
        <li class="flex items-start"> 
          <span class="text-green-500 mr-3 text-xl">ğŸ“‹</span> 
          <p> <strong>â€Meine Eintragungenâ€œ</strong> â€“ Ãœbersicht Ã¼ber deine EintrÃ¤ge: Status, Fotos, Standort und BearbeitungsmÃ¶glichkeiten. </p> 
        </li> 
        <li class="flex items-start"> 
          <span class="text-green-500 mr-3 text-xl">ğŸ’¬</span> 
          <p> <strong>â€HÃ¼tten-Nachrichtenâ€œ</strong> â€“ Hier sammeln sich Nachrichten von Besuchern zu deinen HÃ¼tten. Neue Nachrichten erscheinen durch das rote Badge in der Seitenleiste. Du kannst Nachrichten Ã¶ffnen, lesen und (als HÃ¼tten-Besitzer) einzelne Nachrichten lÃ¶schen. </p> 
        </li> 
        <li class="flex items-start"> 
          <span class="text-green-500 mr-3 text-xl">ğŸ†˜</span> 
          <p> <strong>â€Supportâ€œ</strong> â€“ Melde Probleme oder stelle Fragen an das Team. Support-Tickets werden gespeichert. </p> 
        </li> 
      </ul> 
      <footer class="mt-8 text-center"> 
        <p class="text-sm text-gray-500"> ğŸ’¡ Tipp: Das System aktualisiert Nachrichten live â€” das Badge zeigt neue, ungelesene Nachrichten an. </p> 
      </footer> 
    </section> 
  `; 
  qa.innerHTML = tutorialHTML; 
  updateInfoBox(); 
  document.getElementById("navBottom").style.display = "none";
}

function openSupport() {
    const qa = document.getElementById("question-area");
    mode = "support";
    qa.innerHTML = `
        <section class="bg-white p-6 rounded-2xl shadow-lg max-w-xl mx-auto animate-fadeIn">
            <h2 class="text-2xl font-bold mb-4 text-green-600">ğŸ’¬ Support</h2>
            <form id="supportForm" class="space-y-4">
                <label class="block">
                    <span class="text-gray-700">Betreff</span>
                    <input id="supportSubject" type="text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                </label>
                <label class="block">
                    <span class="text-gray-700">Nachricht</span>
                    <textarea id="supportMessage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" rows="4" required></textarea>
                </label>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                    Ticket senden
                </button>
            </form>
            <div id="ticketsList" class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="font-bold text-lg mb-2">Deine Tickets</h3>
                <div class="text-gray-500 text-sm">â³ Lade Tickets...</div>
            </div>
        </section>
    `;
    updateInfoBox();
    document.getElementById("navBottom").style.display = "none";
    // Implementiere Ticket-Laden/Senden/LÃ¶schen hier (nicht im Scope, aber als Platzhalter)
    document.getElementById('supportForm').addEventListener('submit', (e) => {
        e.preventDefault();
        showToast("Ticket gesendet (Dummy).");
    });
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('-translate-x-full');
}

// ... (Hut Messages logic) ...
let hutMessagesUnsub = null; 
let hutMessagesBadgeUnsub = null; 

function showHutMessages() { 
  const qa = document.getElementById("question-area"); 
  mode = "hutMessages"; 
  const hutMessagesHTML = ` 
    <section class="bg-white p-6 rounded-2xl shadow-lg max-w-3xl mx-auto animate-fadeIn"> 
      <header class="mb-4 text-center"> 
        <h2 class="text-2xl font-extrabold text-green-600 mb-2">ğŸ¡ HÃ¼tten-Nachrichten</h2> 
        <p class="text-gray-600 text-sm">Hier findest du Nachrichten, die Besucher zu deinen HÃ¼tten geschrieben haben.</p> 
      </header> 
      <div id="hutMessagesList" class="divide-y divide-gray-200 text-sm"> 
        <div class="text-gray-400 p-4">â³ Lade Nachrichten...</div> 
      </div> 
      <footer class="mt-4 text-center"> 
        <div id="hutMessagesBadge" class="hidden text-red-600 font-semibold">ğŸ”” Neue Nachrichten!</div> 
      </footer> 
    </section> 
  `; 
  qa.innerHTML = hutMessagesHTML; 
  ladeHutMessagesLive(); 
  updateInfoBox(); 
  document.getElementById("navBottom").style.display = "none";
} 

async function initHutMessagesBadge() { 
  if (hutMessagesBadgeUnsub) { 
    hutMessagesBadgeUnsub(); 
    hutMessagesBadgeUnsub = null; 
  } 
  const huettenSnap = await db.collection("eierhuetten") 
    .where("userId", "==", currentUser.uid) 
    .get(); 
  if (huettenSnap.empty) { 
    const counter = document.getElementById("hutMessagesCount"); 
    if (counter) counter.classList.add("hidden"); 
    return; 
  } 
  const hutIds = huettenSnap.docs.map(d => d.id); 
  const batches = []; 
  for (let i = 0; i < hutIds.length; i += 10) { 
    const batchIds = hutIds.slice(i, i + 10); 
    batches.push( 
      db.collection("hutMessages") 
      .where("hutId", "in", batchIds) 
    ); 
  } 
  const counters = []; 
  hutMessagesBadgeUnsub = () => counters.forEach(unsub => unsub()); 
  batches.forEach(batchQuery => { 
    const unsub = batchQuery.onSnapshot(snap => { 
      let neuCount = 0; 
      snap.forEach(doc => { 
        if (doc.data().answered === false) neuCount++; 
      }); 
      const counter = document.getElementById("hutMessagesCount"); 
      if (counter) { 
        if (neuCount > 0) { 
          counter.textContent = neuCount; 
          counter.classList.remove("hidden"); 
        } else { 
          counter.classList.add("hidden"); 
        } 
      } 
    }); 
    counters.push(unsub); 
  }); 
} 

async function ladeHutMessagesLive() { 
  const list = document.getElementById("hutMessagesList"); 
  const counter = document.getElementById("hutMessagesCount"); 
  if (!currentUser || !currentUser.uid) { 
    if (list) list.innerHTML = `<div class="p-4 text-gray-500">Bitte anmelden, um Nachrichten zu sehen.</div>`; 
    if (counter) counter.classList.add("hidden"); 
    return; 
  } 
  if (hutMessagesUnsub) { 
    hutMessagesUnsub(); 
    hutMessagesUnsub = null; 
  } 
  const huettenSnap = await db.collection("eierhuetten") 
    .where("userId", "==", currentUser.uid) 
    .get(); 
  if (huettenSnap.empty) { 
    if (list) list.innerHTML = `<div class="p-4 text-gray-500">Keine eigenen HÃ¼tten gefunden.</div>`; 
    if (counter) counter.classList.add("hidden"); 
    return; 
  } 
  const hutIds = huettenSnap.docs.map(d => d.id); 
  const batches = []; 
  for (let i = 0; i < hutIds.length; i += 10) { 
    batches.push( 
      db.collection("hutMessages") 
      .where("hutId", "in", hutIds.slice(i, i + 10)) 
      .orderBy("createdAt", "desc") 
    ); 
  } 
  const unsubs = []; 
  hutMessagesUnsub = () => unsubs.forEach(u => u()); 
  list.innerHTML = "â³ Lade Nachrichten..."; 
  
  batches.forEach(query => { 
    const unsub = query.onSnapshot(snap => { 
      // Wir mÃ¼ssen alle Batches abfragen, um eine sortierte Gesamtliste zu erhalten. 
      // Der nachfolgende Code ist eine vereinfachte Darstellung und funktioniert nur, wenn alle Batches schnell geladen werden.
      const allMessages = []; 
      snap.forEach(doc => { 
        allMessages.push({ id: doc.id, ...doc.data() }); 
      }); 
      
      // Sortieren nach Datum (innerhalb dieses Batches)
      allMessages.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());
      
      // ... (Realistisch mÃ¼sste man hier alle Batches sammeln und dann global sortieren)
      // Der Einfachheit halber (da dies clientseitig ist), rendern wir hier nur
      // die Nachrichten des aktuellen Snapshots, in der Hoffnung, dass dies ausreicht.
      
      if (allMessages.length === 0) { 
        list.innerHTML = `<div class="p-4 text-gray-500">Keine Nachrichten vorhanden.</div>`; 
        if (counter) counter.classList.add("hidden"); 
        return; 
      } 
      
      let neuCount = 0; 
      list.innerHTML = ""; 
      allMessages.forEach(d => { 
        if (d.answered === false) neuCount++; 
        const datum = d.createdAt?.toDate?.().toLocaleString("de-DE") || "-"; 
        list.innerHTML += ` 
          <div class="p-4 border-b"> 
            <div class="text-xs text-gray-500">${datum}</div> 
            <div class="font-semibold">${d.hutName || "-"}</div> 
            <div class="mt-1">${d.message || ""}</div> 
            <div class="text-xs text-gray-400 mt-1">von ${d.senderName || "Gast"}</div> 
            <button class="text-red-500 text-sm hover:underline" onclick="deleteHutMessage('${d.id}')" >LÃ¶schen</button> 
          </div> 
        `; 
      }); 
      
      // Badge aktualisieren
      if (counter) { 
        counter.textContent = `${neuCount}/${allMessages.length}`; 
        counter.classList.remove("hidden"); 
      } 
      
    }); 
    unsubs.push(unsub); 
  }); 
} 

async function deleteHutMessage(id) { 
  if (!confirm("Willst du diese Nachricht wirklich lÃ¶schen?")) return; 
  try { 
    await db.collection("hutMessages").doc(id).delete(); 
    console.log("Nachricht gelÃ¶scht:", id); 
  } catch (err) { 
    console.error("Fehler beim LÃ¶schen:", err); 
    alert("âŒ Konnte Nachricht nicht lÃ¶schen"); 
  } 
} 
// ... (Ende Hut Messages Logic) ...
  </script>
</body>
</html>
