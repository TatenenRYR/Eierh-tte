<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EierhÃ¼tten-Radtour SMART</title>

  <!-- Styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body {
      font-family: sans-serif;
      background: white;
      color: black;
      transition: background 0.5s, color 0.5s;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }
    #map { height: 400px; margin-top: 1em; }
    #linkBox { margin-top: 1em; background: #f0f0f0; padding: 1em; border-radius: 0.5em; }
    body.dark #linkBox { background: #1e1e1e; color: white; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAu39z49KEJy9zso-etFIScmaFnWw8vhro",
      authDomain: "eierhuettentour.firebaseapp.com",
      projectId: "eierhuettentour",
      storageBucket: "eierhuettentour.firebasestorage.app",
      messagingSenderId: "348272135205",
      appId: "1:348272135205:web:f39a7d26d927fbf28dc3cc",
      measurementId: "G-16V6K5GXDT"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- Leaflet & Plugins -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // Feature 1: Nutzername persistent
    let userName = localStorage.getItem('userName');
    if (!userName) {
      userName = prompt("Bitte gib deinen Namen ein:");
      if (!userName) userName = "Gast";
      localStorage.setItem('userName', userName);
    }
    // Feature 8: Dark Mode je nach Uhrzeit
    const hour = new Date().getHours();
    if (hour >= 19 || hour < 6) {
      document.documentElement.classList.add("dark");
      document.body.classList.add("dark");
    }
  </script>
</head>
<body>

  <h1>ğŸ‘‹ Willkommen, <span id="username"></span>!</h1>
  <script>
    document.getElementById("username").textContent = userName;
  </script>

  <p>Smarte EierhÃ¼tten-Radtour mit Gruppen-Tracking und vielem mehr.</p>
  <ul>
    <li>âœ… Feature 1: Nutzername gespeichert</li>
    <li>âœ… Feature 2: Inaktive Teilnehmer ausblenden</li>
    <li>âœ… Feature 3: HÃ¼tten-Filter (Strom, Entfernung)</li>
    <li>âœ… Feature 4: Fahrrad-Routenoptimierung</li>
    <li>âœ… Feature 5: Tour-Link teilen</li>
    <li>âœ… Feature 6: Route speichern</li>
    <li>âœ… Feature 7: Sprachausgabe bei AnnÃ¤herung</li>
    <li>âœ… Feature 8: Auto Dark Mode</li>
    <li>âœ… Feature 9: Marker-Clustering</li>
    <li>âœ… Feature 10: Gruppen-Abstandswarnung</li>
  </ul>

  <!-- Filter UI -->
  <h3>ğŸ• HÃ¼tten-Filter</h3>
  <label><input type="checkbox" id="filterStrom" /> Nur mit Strom</label>
  <label><input type="number" id="filterDistanz" placeholder="Umkreis in km" min="1" max="100" style="width:80px" /></label>
  <button onclick="ladeUndFiltereHuetten()">ğŸ” Filtern</button>
  <ul id="huettenListe"></ul>

  <!-- Map & Controls -->
  <div id="map"></div>
  <button onclick="starteFahrradroutenplanung()">ğŸš´ Route planen (Fahrrad)</button>
  <button onclick="erstelleTourLink()">ğŸ”— Tour-Link generieren</button>
  <button onclick="speichereRoute()">ğŸ’¾ Route speichern</button>

  <div id="linkBox" style="display:none">
    <strong>Tour-Link:</strong>
    <a id="tourLink" href="#" target="_blank"></a>
  </div>

  <script>
    // Basis-Map und Cluster-Gruppe
    const map = L.map('map').setView([51, 10], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    let markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    // Routing & State
    let routingControl = null;
    let routenpunkte = [];
    let letzteSprachmeldung = 0;
    let eigeneId = userName + Math.floor(Math.random()*100000);
    let eigenePosition = null;
    let gruppenMitglieder = [];

    // Utility: Entfernung in km
    function entfernungKm(a, b) {
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI/180;
      const dLng = (b.lng - a.lng) * Math.PI/180;
      const la = a.lat * Math.PI/180, lb = b.lat * Math.PI/180;
      const h = Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
    }

    // Feature 2: Gruppen-Tracking mit InaktivitÃ¤tsfilter (10 Min)
    db.collection("group_positions").onSnapshot(snap => {
      // hier Anzeige oder Verarbeitung, wenn gewÃ¼nscht...
    });

    // Feature 3: HÃ¼tten laden & filtern
    function ladeUndFiltereHuetten() {
      markerCluster.clearLayers();
      routenpunkte = [];
      const nurStrom = document.getElementById("filterStrom").checked;
      const umkreisKm = parseFloat(document.getElementById("filterDistanz").value);
      const liste = document.getElementById("huettenListe");
      liste.innerHTML = '';

      navigator.geolocation.getCurrentPosition(pos => {
        const userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        db.collection("eierhuetten").get().then(snap => {
          snap.forEach(doc => {
            const h = doc.data();
            if (!h.location) return;
            if (nurStrom && !h.strom) return;
            if (umkreisKm) {
              const dist = entfernungKm(userLoc, { lat: h.location.latitude, lng: h.location.longitude });
              if (dist > umkreisKm) return;
            }
            // Liste & Marker
            const li = document.createElement("li");
            li.textContent = `${h.name||"Unbenannt"} (${h.strom?"Strom":"Kein Strom"})`;
            liste.appendChild(li);

            const pt = L.latLng(h.location.latitude, h.location.longitude);
            routenpunkte.push(pt);
            markerCluster.addLayer(L.marker(pt).bindPopup(h.name||"HÃ¼tte"));
          });
        });
      });
    }

    // Feature 4: Fahrrad-Routenplanung
    function starteFahrradroutenplanung() {
      if (!routenpunkte.length) { alert("Keine Punkte!"); return; }
      if (routingControl) map.removeControl(routingControl);
      routingControl = L.Routing.control({
        waypoints: routenpunkte,
        router: L.Routing.osrmv1({ profile: 'bike' }),
        lineOptions:{ styles:[{ weight:5, color:'green' }] },
        show: false
      }).addTo(map);
    }

    // Feature 5: Link generieren
    function erstelleTourLink() {
      if (!routenpunkte.length) { alert("Keine Route!"); return; }
      const coords = routenpunkte.map(p=>`${p.lat.toFixed(5)},${p.lng.toFixed(5)}`).join(";");
      const link = `${location.origin}${location.pathname}?tour=${encodeURIComponent(coords)}`;
      document.getElementById("tourLink").textContent = link;
      document.getElementById("tourLink").href = link;
      document.getElementById("linkBox").style.display = 'block';
    }

    // Feature 6: Route speichern
    function speichereRoute() {
      if (!routenpunkte.length) { alert("Keine Route!"); return; }
      const daten = {
        name: userName,
        erstellt: new Date(),
        punkte: routenpunkte.map(p=>({lat:p.lat,lng:p.lng}))
      };
      db.collection("touren").add(daten).then(r=>alert("Gespeichert ID: "+r.id));
    }

    // Feature 7: Sprachausgabe bei AnnÃ¤herung (<100m)
    navigator.geolocation.watchPosition(pos=>{
      eigenePosition = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setView([eigenePosition.lat, eigenePosition.lng], 13);
      const jetzt=Date.now();
      if (jetzt-letzteSprachmeldung<15000) return;
      for (let p of routenpunkte) {
        if (entfernungKm(eigenePosition,{lat:p.lat,lng:p.lng})<=0.1) {
          speechSynthesis.speak(new SpeechSynthesisUtterance("Du nÃ¤herst dich einer EierhÃ¼tte!"));
          letzteSprachmeldung=jetzt;
          break;
        }
      }
      // Feature 10: Gruppen-Abstandswarnung (>1km)
      db.collection("tracking").get().then(s=>{
        gruppenMitglieder=[];
        s.forEach(doc=>{
          const d=doc.data();
          if (Date.now()-d.zeit>60000) return;
          if (doc.id!==eigeneId) gruppenMitglieder.push(d);
        });
        let maxDist=0;
        gruppenMitglieder.forEach(m=>{
          const d=entfernungKm(eigenePosition,m.position);
          if (d>maxDist) maxDist=d;
        });
        if (maxDist>1) {
          speechSynthesis.speak(new SpeechSynthesisUtterance("Du bist weit entfernt von deiner Gruppe!"));
        }
        // eigenes Tracking-Update
        db.collection("tracking").doc(eigeneId).set({
          name:userName,
          position:eigenePosition,
          zeit:Date.now()
        });
      });
    });

    // Param-Auswertung: Link Ã¶ffnen
    const tourParam = new URLSearchParams(location.search).get("tour");
    if (tourParam) {
      routenpunkte = tourParam.split(";").map(s=>{
        const [lat,lng]=s.split(",").map(Number);
        const p=L.latLng(lat,lng);
        markerCluster.addLayer(L.marker(p).bindPopup("Ziel"));
        return p;
      });
      starteFahrradroutenplanung();
    } else {
      ladeUndFiltereHuetten();
    }
  </script>

</body>
</html>
